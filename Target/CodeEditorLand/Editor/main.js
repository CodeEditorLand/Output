import*as d from"path";import*as u from"original-fs";import*as N from"os";import{configurePortable as O}from"./bootstrap-node.js";import{bootstrapESM as k}from"./bootstrap-esm.js";import{fileURLToPath as T}from"url";import{app as o,protocol as R,crashReporter as I,Menu as j,contentTracing as U}from"electron";import V from"minimist";import{product as t}from"./bootstrap-meta.js";import{parse as F}from"./vs/base/common/jsonc.js";import{getUserDataPath as _}from"./vs/platform/environment/node/userDataPath.js";import*as m from"./vs/base/common/performance.js";import{resolveNLSConfiguration as P}from"./vs/base/node/nls.js";import{getUNCHost as M,addUNCHostToAllowlist as $}from"./vs/base/node/unc.js";import"./vs/nls.js";import"./vs/platform/environment/common/argv.js";const C=d.dirname(T(import.meta.url));m.mark("code/didStartMain");const x=O(t),c=Z(),y=W(c);c.sandbox&&!c["disable-chromium-sandbox"]&&!y["disable-chromium-sandbox"]?o.enableSandbox():o.commandLine.hasSwitch("no-sandbox")&&!o.commandLine.hasSwitch("disable-gpu-sandbox")?o.commandLine.appendSwitch("disable-gpu-sandbox"):(o.commandLine.appendSwitch("no-sandbox"),o.commandLine.appendSwitch("disable-gpu-sandbox"));const g=_(c,t.nameShort??"code-oss-dev");if(process.platform==="win32"){const e=M(g);e&&$(e)}o.setPath("userData",g);const D=X();j.setApplicationMenu(null),m.mark("code/willStartCrashReporter"),(c["crash-reporter-directory"]||y["enable-crash-reporter"]&&!c["disable-crash-reporter"])&&q(),m.mark("code/didStartCrashReporter"),x&&x.isPortable&&o.setAppLogsPath(d.join(g,"logs")),R.registerSchemesAsPrivileged([{scheme:"vscode-webview",privileges:{standard:!0,secure:!0,supportFetchAPI:!0,corsEnabled:!0,allowServiceWorkers:!0,codeCache:!0}},{scheme:"vscode-file",privileges:{secure:!0,standard:!0,supportFetchAPI:!0,corsEnabled:!0,codeCache:!0}}]),Q();let S;const w=E((o.getPreferredSystemLanguages()?.[0]??"en").toLowerCase()),h=ee(y);if(h&&(S=P({userLocale:h,osLocale:w,commit:t.commit,userDataPath:g,nlsMetadataPath:C})),process.platform==="win32"||process.platform==="linux"){const e=!h||h==="qps-ploc"?"en":h;o.commandLine.appendSwitch("lang",e)}o.once("ready",function(){if(c.trace){const e={categoryFilter:c["trace-category-filter"]||"*",traceOptions:c["trace-options"]||"record-until-full,enable-sampling"};U.startRecording(e).finally(()=>A())}else A()});async function A(){m.mark("code/mainAppReady");try{const[,e]=await Promise.all([Y(D),K()]);await H(D,e)}catch{}}async function H(e,r){process.env.VSCODE_NLS_CONFIG=JSON.stringify(r),process.env.VSCODE_CODE_CACHE_PATH=e||"",await k(),m.mark("code/willLoadMainBundle"),await import("./vs/code/electron-main/main.js"),m.mark("code/didLoadMainBundle")}function W(e){const r=["disable-hardware-acceleration","force-color-profile","disable-lcd-text","proxy-bypass-list"];process.platform==="linux"&&(r.push("force-renderer-accessibility"),r.push("password-store"));const s=["enable-proposed-api","log-level","use-inmemory-secretstorage"],f=z();Object.keys(f).forEach(i=>{const n=f[i];if(r.indexOf(i)!==-1){if(n===!0||n==="true")i==="disable-hardware-acceleration"?o.disableHardwareAcceleration():o.commandLine.appendSwitch(i);else if(typeof n=="string"&&n)if(i==="password-store"){let a=n;(n==="gnome"||n==="gnome-keyring")&&(a="gnome-libsecret"),o.commandLine.appendSwitch(i,a)}else o.commandLine.appendSwitch(i,n)}else if(s.indexOf(i)!==-1)switch(i){case"enable-proposed-api":Array.isArray(n)&&n.forEach(a=>a&&typeof a=="string"&&process.argv.push("--enable-proposed-api",a));break;case"log-level":if(typeof n=="string")process.argv.push("--log",n);else if(Array.isArray(n))for(const a of n)process.argv.push("--log",a);break;case"use-inmemory-secretstorage":n&&process.argv.push("--use-inmemory-secretstorage");break}});const p=`CalculateNativeWinOcclusion,${o.commandLine.getSwitchValue("disable-features")}`;o.commandLine.appendSwitch("disable-features",p);const l=`FontMatchingCTMigration,${o.commandLine.getSwitchValue("disable-blink-features")}`;o.commandLine.appendSwitch("disable-blink-features",l);const b=J(e);return b&&o.commandLine.appendSwitch("js-flags",b),f}function z(){const e=G();let r;try{r=F(u.readFileSync(e).toString())}catch(s){s&&s.code==="ENOENT"&&B(e)}return r||(r={}),r}function B(e){try{const r=d.dirname(e);u.existsSync(r)||u.mkdirSync(r);const s=["// This configuration file allows you to pass permanent command line arguments to VS Code.","// Only a subset of arguments is currently supported to reduce the likelihood of breaking","// the installation.","//","// PLEASE DO NOT CHANGE WITHOUT UNDERSTANDING THE IMPACT","//","// NOTE: Changing this file requires a restart of VS Code.","{","	// Use software rendering instead of hardware accelerated rendering.","	// This can help in cases where you see rendering issues in VS Code.",'	// "disable-hardware-acceleration": true',"}"];u.writeFileSync(e,s.join(`
`))}catch{}}function G(){const e=process.env.VSCODE_PORTABLE;if(e)return d.join(e,"argv.json");let r=t.dataFolderName;return process.env.VSCODE_DEV&&(r=`${r}-dev`),d.join(N.homedir(),r,"argv.json")}function q(){let e=c["crash-reporter-directory"],r="";if(e){if(e=d.normalize(e),d.isAbsolute(e)||o.exit(1),!u.existsSync(e))try{u.mkdirSync(e,{recursive:!0})}catch{o.exit(1)}o.setPath("crashDumps",e)}else{const l=t.appCenter;if(l){const b=process.platform==="win32",i=process.platform==="linux",n=process.platform==="darwin",a=y["crash-reporter-id"];if(a&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)){if(b)switch(process.arch){case"x64":r=l["win32-x64"];break;case"arm64":r=l["win32-arm64"];break}else if(n)if(t.darwinUniversalAssetId)r=l["darwin-universal"];else switch(process.arch){case"x64":r=l.darwin;break;case"arm64":r=l["darwin-arm64"];break}else i&&(r=l["linux-x64"]);r=r.concat("&uid=",a,"&iid=",a,"&sid=",a);const v=process.argv,L=v.indexOf("--");L===-1?v.push("--crash-reporter-id",a):v.splice(L,0,"--crash-reporter-id",a)}}}const s=(t.crashReporter?t.crashReporter.productName:void 0)||t.nameShort,f=(t.crashReporter?t.crashReporter.companyName:void 0)||"Microsoft",p=!!(!process.env.VSCODE_DEV&&r&&!e);I.start({companyName:f,productName:process.env.VSCODE_DEV?`${s} Dev`:s,submitURL:r,uploadToServer:p,compress:!0})}function J(e){const r=[];return e["js-flags"]&&r.push(e["js-flags"]),r.length>0?r.join(" "):null}function Z(){return V(process.argv,{string:["user-data-dir","locale","js-flags","crash-reporter-directory"],boolean:["disable-chromium-sandbox"],default:{sandbox:!0},alias:{"no-sandbox":"sandbox"}})}function Q(){const e=[];globalThis.macOpenFiles=e,o.on("open-file",function(f,p){e.push(p)});const r=[],s=function(f,p){f.preventDefault(),r.push(p)};o.on("will-finish-launching",function(){o.on("open-url",s)}),globalThis.getOpenUrls=function(){return o.removeListener("open-url",s),r}}function X(){if(process.argv.indexOf("--no-cached-data")>0||process.env.VSCODE_DEV)return;const e=t.commit;if(e)return d.join(g,"CachedData",e)}async function Y(e){if(typeof e=="string")try{return await u.promises.mkdir(e,{recursive:!0}),e}catch{}}function E(e){if(e.startsWith("zh")){const r=e.split("-")[1];return["hans","cn","sg","my"].includes(r)?"zh-cn":"zh-tw"}return e}async function K(){const e=S?await S:void 0;if(e)return e;let r=o.getLocale();return r?(r=E(r.toLowerCase()),P({userLocale:r,osLocale:w,commit:t.commit,userDataPath:g,nlsMetadataPath:C})):{userLocale:"en",osLocale:w,resolvedLanguage:"en",defaultMessagesFile:d.join(C,"nls.messages.json"),locale:"en",availableLanguages:{}}}function ee(e){const r=c.locale;return r?r.toLowerCase():typeof e?.locale=="string"?e.locale.toLowerCase():void 0}
