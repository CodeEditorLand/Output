import"../../dnd.js";import{$ as S,append as _,clearNode as ge,createStyleSheet as fe,getWindow as J,h as O,hasParentWithClass as $,isActiveElement as ve,isKeyboardEvent as F,addDisposableListener as Q,isEditableElement as Z}from"../../dom.js";import{asCssValueWithDefault as ee}from"../../cssValue.js";import{DomEmitter as N}from"../../event.js";import{StandardKeyboardEvent as G}from"../../keyboardEvent.js";import{ActionBar as me}from"../actionbar/actionbar.js";import"../contextview/contextview.js";import{FindInput as ye}from"../findinput/findInput.js";import{MessageType as te,unthemedInboxStyles as be}from"../inputbox/inputBox.js";import"../list/list.js";import{ElementsDragAndDropData as ie}from"../list/listView.js";import{isActionItem as De,isButton as Se,isMonacoCustomToggle as Fe,isMonacoEditor as Ie,isStickyScrollContainer as E,isStickyScrollElement as x,List as we,MouseController as Ce}from"../list/listWidget.js";import{Toggle as Ne,unthemedToggleStyles as Ee}from"../toggle/toggle.js";import{getVisibleState as xe,isFilterResult as ke}from"./indexTreeModel.js";import{TreeDragOverBubble as Me,TreeError as Le,TreeMouseEventTarget as k,TreeVisibility as M}from"./tree.js";import{Action as Re}from"../../../common/actions.js";import{distinct as oe,equals as K,range as Ae}from"../../../common/arrays.js";import{Delayer as Pe,disposableTimeout as _e,timeout as Oe}from"../../../common/async.js";import{Codicon as H}from"../../../common/codicons.js";import{ThemeIcon as ne}from"../../../common/themables.js";import{SetMap as He}from"../../../common/map.js";import{Emitter as f,Event as u,EventBufferer as Ve,Relay as L}from"../../../common/event.js";import{fuzzyScore as We,FuzzyScore as R}from"../../../common/filters.js";import{KeyCode as y}from"../../../common/keyCodes.js";import{Disposable as I,DisposableStore as v,dispose as U,toDisposable as q}from"../../../common/lifecycle.js";import{clamp as V}from"../../../common/numbers.js";import"../../../common/scrollable.js";import{isNumber as ze}from"../../../common/types.js";import"./media/tree.css";import{localize as b}from"../../../../nls.js";import"../hover/hoverDelegate.js";import{createInstantHoverDelegate as Be}from"../hover/hoverDelegateFactory.js";import{autorun as $e,constObservable as Ge}from"../../../common/observable.js";import{alert as se}from"../aria/aria.js";class Ke extends ie{constructor(e){super(e.elements.map(i=>i.element));this.data=e}set context(e){this.data.context=e}get context(){return this.data.context}}function Y(a){return a instanceof ie?new Ke(a):a}class Ue{constructor(t,e){this.modelProvider=t;this.dnd=e}autoExpandNode;autoExpandDisposable=I.None;disposables=new v;getDragURI(t){return this.dnd.getDragURI(t.element)}getDragLabel(t,e){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(t.map(i=>i.element),e)}onDragStart(t,e){this.dnd.onDragStart?.(Y(t),e)}onDragOver(t,e,i,o,n,s=!0){const r=this.dnd.onDragOver(Y(t),e&&e.element,i,o,n),l=this.autoExpandNode!==e;if(l&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=e),typeof e>"u")return r;if(l&&typeof r!="boolean"&&r.autoExpand&&(this.autoExpandDisposable=_e(()=>{const T=this.modelProvider(),m=T.getNodeLocation(e);T.isCollapsed(m)&&T.setCollapsed(m,!1),this.autoExpandNode=void 0},500,this.disposables)),typeof r=="boolean"||!r.accept||typeof r.bubble>"u"||r.feedback){if(!s){const T=typeof r=="boolean"?r:r.accept,m=typeof r=="boolean"?void 0:r.effect;return{accept:T,effect:m,feedback:[i]}}return r}if(r.bubble===Me.Up){const T=this.modelProvider(),m=T.getNodeLocation(e),c=T.getParentNodeLocation(m),p=T.getNode(c),D=c&&T.getListIndex(c);return this.onDragOver(t,p,D,o,n,!1)}const d=this.modelProvider(),h=d.getNodeLocation(e),g=d.getListIndex(h),w=d.getListRenderCount(h);return{...r,feedback:Ae(g,g+w)}}drop(t,e,i,o,n){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(Y(t),e&&e.element,i,o,n)}onDragEnd(t){this.dnd.onDragEnd?.(t)}dispose(){this.disposables.dispose(),this.dnd.dispose()}}function qe(a,t){return t&&{...t,identityProvider:t.identityProvider&&{getId(e){return t.identityProvider.getId(e.element)}},dnd:t.dnd&&new Ue(a,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent(e){return t.multipleSelectionController.isSelectionSingleChangeEvent({...e,element:e.element})},isSelectionRangeChangeEvent(e){return t.multipleSelectionController.isSelectionRangeChangeEvent({...e,element:e.element})}},accessibilityProvider:t.accessibilityProvider&&{...t.accessibilityProvider,getSetSize(e){const i=a(),o=i.getNodeLocation(e),n=i.getParentNodeLocation(o);return i.getNode(n).visibleChildrenCount},getPosInSet(e){return e.visibleChildIndex+1},isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel(e){return t.accessibilityProvider.getAriaLabel(e.element)},getWidgetAriaLabel(){return t.accessibilityProvider.getWidgetAriaLabel()},getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))},keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&{...t.keyboardNavigationLabelProvider,getKeyboardNavigationLabel(e){return t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)}}}}class Ye{constructor(t){this.delegate=t}getHeight(t){return this.delegate.getHeight(t.element)}getTemplateId(t){return this.delegate.getTemplateId(t.element)}hasDynamicHeight(t){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(t.element)}setDynamicHeight(t,e){this.delegate.setDynamicHeight?.(t.element,e)}}class A{focus;selection;expanded;scrollTop;static lift(t){return t instanceof A?t:new A(t)}static empty(t=0){return new A({focus:[],selection:[],expanded:Object.create(null),scrollTop:t})}constructor(t){if(this.focus=new Set(t.focus),this.selection=new Set(t.selection),t.expanded instanceof Array){this.expanded=Object.create(null);for(const e of t.expanded)this.expanded[e]=1}else this.expanded=t.expanded;this.expanded=t.expanded,this.scrollTop=t.scrollTop}toJSON(){return{focus:Array.from(this.focus),selection:Array.from(this.selection),expanded:this.expanded,scrollTop:this.scrollTop}}}var Xe=(i=>(i.None="none",i.OnHover="onHover",i.Always="always",i))(Xe||{});class je{constructor(t,e=[]){this._elements=e;this.onDidChange=u.forEach(t,i=>this._elements=i,this.disposables)}disposables=new v;onDidChange;get elements(){return this._elements}dispose(){this.disposables.dispose()}}class z{constructor(t,e,i,o,n,s={}){this.renderer=t;this.model=e;this.activeNodes=o;this.renderedIndentGuides=n;this.templateId=t.templateId,this.updateOptions(s),u.map(i,r=>r.node)(this.onDidChangeNodeTwistieState,this,this.disposables),t.onDidChangeTwistieState?.(this.onDidChangeTwistieState,this,this.disposables)}static DefaultIndent=8;templateId;renderedElements=new Map;renderedNodes=new Map;indent=z.DefaultIndent;hideTwistiesOfChildlessElements=!1;shouldRenderIndentGuides=!1;activeIndentNodes=new Set;indentGuidesDisposable=I.None;disposables=new v;updateOptions(t={}){if(typeof t.indent<"u"){const e=V(t.indent,0,40);if(e!==this.indent){this.indent=e;for(const[i,o]of this.renderedNodes)this.renderTreeElement(i,o)}}if(typeof t.renderIndentGuides<"u"){const e=t.renderIndentGuides!=="none";if(e!==this.shouldRenderIndentGuides){this.shouldRenderIndentGuides=e;for(const[i,o]of this.renderedNodes)this._renderIndentGuides(i,o);if(this.indentGuidesDisposable.dispose(),e){const i=new v;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,i),this.indentGuidesDisposable=i,this._onDidChangeActiveNodes(this.activeNodes.elements)}}}typeof t.hideTwistiesOfChildlessElements<"u"&&(this.hideTwistiesOfChildlessElements=t.hideTwistiesOfChildlessElements)}renderTemplate(t){const e=_(t,S(".monaco-tl-row")),i=_(e,S(".monaco-tl-indent")),o=_(e,S(".monaco-tl-twistie")),n=_(e,S(".monaco-tl-contents")),s=this.renderer.renderTemplate(n);return{container:t,indent:i,twistie:o,indentGuidesDisposable:I.None,templateData:s}}renderElement(t,e,i,o){this.renderedNodes.set(t,i),this.renderedElements.set(t.element,t),this.renderTreeElement(t,i),this.renderer.renderElement(t,e,i.templateData,o)}disposeElement(t,e,i,o){i.indentGuidesDisposable.dispose(),this.renderer.disposeElement?.(t,e,i.templateData,o),typeof o=="number"&&(this.renderedNodes.delete(t),this.renderedElements.delete(t.element))}disposeTemplate(t){this.renderer.disposeTemplate(t.templateData)}onDidChangeTwistieState(t){const e=this.renderedElements.get(t);e&&this.onDidChangeNodeTwistieState(e)}onDidChangeNodeTwistieState(t){const e=this.renderedNodes.get(t);e&&(this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderTreeElement(t,e))}renderTreeElement(t,e){const i=z.DefaultIndent+(t.depth-1)*this.indent;e.twistie.style.paddingLeft=`${i}px`,e.indent.style.width=`${i+this.indent-16}px`,t.collapsible?e.container.setAttribute("aria-expanded",String(!t.collapsed)):e.container.removeAttribute("aria-expanded"),e.twistie.classList.remove(...ne.asClassNameArray(H.treeItemExpanded));let o=!1;this.renderer.renderTwistie&&(o=this.renderer.renderTwistie(t.element,e.twistie)),t.collapsible&&(!this.hideTwistiesOfChildlessElements||t.visibleChildrenCount>0)?(o||e.twistie.classList.add(...ne.asClassNameArray(H.treeItemExpanded)),e.twistie.classList.add("collapsible"),e.twistie.classList.toggle("collapsed",t.collapsed)):e.twistie.classList.remove("collapsible","collapsed"),this._renderIndentGuides(t,e)}_renderIndentGuides(t,e){if(ge(e.indent),e.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new v;for(;;){const o=this.model.getNodeLocation(t),n=this.model.getParentNodeLocation(o);if(!n)break;const s=this.model.getNode(n),r=S(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(s)&&r.classList.add("active"),e.indent.childElementCount===0?e.indent.appendChild(r):e.indent.insertBefore(r,e.indent.firstElementChild),this.renderedIndentGuides.add(s,r),i.add(q(()=>this.renderedIndentGuides.delete(s,r))),t=s}e.indentGuidesDisposable=i}_onDidChangeActiveNodes(t){if(!this.shouldRenderIndentGuides)return;const e=new Set;t.forEach(i=>{const o=this.model.getNodeLocation(i);try{const n=this.model.getParentNodeLocation(o);i.collapsible&&i.children.length>0&&!i.collapsed?e.add(i):n&&e.add(this.model.getNode(n))}catch{}}),this.activeIndentNodes.forEach(i=>{e.has(i)||this.renderedIndentGuides.forEach(i,o=>o.classList.remove("active"))}),e.forEach(i=>{this.activeIndentNodes.has(i)||this.renderedIndentGuides.forEach(i,o=>o.classList.add("active"))}),this.activeIndentNodes=e}setModel(t){this.model=t}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),U(this.disposables)}}function Je(a,t){const e=t.toLowerCase().indexOf(a);let i;if(e>-1){i=[Number.MAX_SAFE_INTEGER,0];for(let o=a.length;o>0;o--)i.push(e+o-1)}return i}class Qe{constructor(t,e,i){this.tree=t;this.keyboardNavigationLabelProvider=e;this._filter=i;t.onWillRefilter(this.reset,this,this.disposables)}_totalCount=0;get totalCount(){return this._totalCount}_matchCount=0;get matchCount(){return this._matchCount}_pattern="";_lowercasePattern="";disposables=new v;set pattern(t){this._pattern=t,this._lowercasePattern=t.toLowerCase()}filter(t,e){let i=M.Visible;if(this._filter){const s=this._filter.filter(t,e);if(typeof s=="boolean"?i=s?M.Visible:M.Hidden:ke(s)?i=xe(s.visibility):i=s,i===M.Hidden)return!1}if(this._totalCount++,!this._pattern)return this._matchCount++,{data:R.Default,visibility:i};const o=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(t),n=Array.isArray(o)?o:[o];for(const s of n){const r=s&&s.toString();if(typeof r>"u")return{data:R.Default,visibility:i};let l;if(this.tree.findMatchType===1?l=Je(this._lowercasePattern,r.toLowerCase()):l=We(this._pattern,this._lowercasePattern,0,r,r.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0}),l)return this._matchCount++,n.length===1?{data:l,visibility:i}:{data:{label:r,score:l},visibility:i}}return this.tree.findMode===1?typeof this.tree.options.defaultFindVisibility=="number"?this.tree.options.defaultFindVisibility:this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility(t):M.Recurse:{data:R.Default,visibility:i}}reset(){this._totalCount=0,this._matchCount=0}dispose(){U(this.disposables)}}class Ze extends Ne{id;constructor(t,e,i){super({icon:t.icon,title:t.title,isChecked:t.isChecked,inputActiveOptionBorder:e.inputActiveOptionBorder,inputActiveOptionForeground:e.inputActiveOptionForeground,inputActiveOptionBackground:e.inputActiveOptionBackground,hoverDelegate:i}),this.id=t.id}}class et{stateMap;constructor(t){this.stateMap=new Map(t.map(e=>[e.id,{...e}]))}states(){return Array.from(this.stateMap.values())}get(t){const e=this.stateMap.get(t);if(e===void 0)throw new Error(`No state found for toggle id ${t}`);return e.isChecked}set(t,e){const i=this.stateMap.get(t);if(i===void 0)throw new Error(`No state found for toggle id ${t}`);return i.isChecked===e?!1:(i.isChecked=e,!0)}}const tt={inputBoxStyles:be,toggleStyles:Ee,listFilterWidgetBackground:void 0,listFilterWidgetNoMatchesOutline:void 0,listFilterWidgetOutline:void 0,listFilterWidgetShadow:void 0};var it=(e=>(e[e.Highlight=0]="Highlight",e[e.Filter=1]="Filter",e))(it||{}),ot=(e=>(e[e.Fuzzy=0]="Fuzzy",e[e.Contiguous=1]="Contiguous",e))(ot||{});class nt extends I{constructor(e,i,o,n,s=[],r){super();this.tree=i;e.appendChild(this.elements.root),this._register(q(()=>this.elements.root.remove()));const l=r?.styles??tt;l.listFilterWidgetBackground&&(this.elements.root.style.backgroundColor=l.listFilterWidgetBackground),l.listFilterWidgetShadow&&(this.elements.root.style.boxShadow=`0 0 8px 2px ${l.listFilterWidgetShadow}`);const d=this._register(Be());this.toggles=s.map(c=>this._register(new Ze(c,l.toggleStyles,d))),this.onDidToggleChange=u.any(...this.toggles.map(c=>u.map(c.onChange,()=>({id:c.id,isChecked:c.checked})))),this.findInput=this._register(new ye(this.elements.findInput,o,{label:b("type to search","Type to search"),placeholder:n,additionalToggles:this.toggles,showCommonFindToggles:!1,inputBoxStyles:l.inputBoxStyles,toggleStyles:l.toggleStyles,history:r?.history})),this.actionbar=this._register(new me(this.elements.actionbar));const h=this._register(new N(this.findInput.inputBox.inputElement,"keydown")),g=u.chain(h.event,c=>c.map(p=>new G(p)));this._register(g(c=>{if(c.equals(y.Enter)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.addToHistory(),this.tree.domFocus();return}if(c.equals(y.DownArrow)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.isAtLastInHistory()||this.findInput.inputBox.isNowhereInHistory()?(this.findInput.inputBox.addToHistory(),this.tree.domFocus()):this.findInput.inputBox.showNextValue();return}if(c.equals(y.UpArrow)){c.preventDefault(),c.stopPropagation(),this.findInput.inputBox.showPreviousValue();return}}));const w=this._register(new Re("close",b("close","Close"),"codicon codicon-close",!0,()=>this.dispose()));this.actionbar.push(w,{icon:!0,label:!1});const T=this._register(new N(this.elements.grab,"mousedown"));this._register(T.event(c=>{const p=new v,D=p.add(new N(J(c),"mousemove")),B=p.add(new N(J(c),"mouseup")),ae=this.right,de=c.pageX,ce=this.top,he=c.pageY;this.elements.grab.classList.add("grabbing");const ue=this.elements.root.style.transition;this.elements.root.style.transition="unset";const j=P=>{const Te=P.pageX-de;this.right=ae-Te;const pe=P.pageY-he;this.top=ce+pe,this.layout()};p.add(D.event(j)),p.add(B.event(P=>{j(P),this.elements.grab.classList.remove("grabbing"),this.elements.root.style.transition=ue,p.dispose()}))}));const m=u.chain(this._register(new N(this.elements.grab,"keydown")).event,c=>c.map(p=>new G(p)));this._register(m(c=>{let p,D;if(c.keyCode===y.LeftArrow?p=Number.POSITIVE_INFINITY:c.keyCode===y.RightArrow?p=0:c.keyCode===y.Space&&(p=this.right===0?Number.POSITIVE_INFINITY:0),c.keyCode===y.UpArrow?D=0:c.keyCode===y.DownArrow&&(D=Number.POSITIVE_INFINITY),p!==void 0&&(c.preventDefault(),c.stopPropagation(),this.right=p,this.layout()),D!==void 0){c.preventDefault(),c.stopPropagation(),this.top=D;const B=this.elements.root.style.transition;this.elements.root.style.transition="unset",this.layout(),setTimeout(()=>{this.elements.root.style.transition=B},0)}})),this.onDidChangeValue=this.findInput.onDidChange}elements=O(".monaco-tree-type-filter",[O(".monaco-tree-type-filter-grab.codicon.codicon-debug-gripper@grab",{tabIndex:0}),O(".monaco-tree-type-filter-input@findInput"),O(".monaco-tree-type-filter-actionbar@actionbar")]);get value(){return this.findInput.inputBox.value}set value(e){this.findInput.inputBox.value=e}findInput;actionbar;toggles=[];width=0;right=0;top=0;_onDidDisable=new f;onDidDisable=this._onDidDisable.event;onDidChangeValue;onDidToggleChange;setToggleState(e,i){const o=this.toggles.find(n=>n.id===e);o&&(o.checked=i)}setPlaceHolder(e){this.findInput.inputBox.setPlaceHolder(e)}getHistory(){return this.findInput.inputBox.getHistory()}focus(){this.findInput.focus()}select(){this.findInput.select(),this.findInput.inputBox.addToHistory(!0)}layout(e=this.width){this.width=e,this.right=V(this.right,0,Math.max(0,e-212)),this.elements.root.style.right=`${this.right}px`,this.top=V(this.top,0,24),this.elements.root.style.top=`${this.top}px`}showMessage(e){this.findInput.showMessage(e)}clearMessage(){this.findInput.clearMessage()}async dispose(){this._onDidDisable.fire(),this.elements.root.classList.add("disabled"),await Oe(300),super.dispose()}}var st=(e=>(e.Mode="mode",e.MatchType="matchType",e))(st||{});class rt{constructor(t,e,i,o={}){this.tree=t;this.filter=e;this.contextViewProvider=i;this.options=o;this.toggles=new et(o.toggles??[]),this._placeholder=o.placeholder??b("type to search","Type to search")}_history;_pattern="";get pattern(){return this._pattern}previousPattern="";toggles;_placeholder;get placeholder(){return this._placeholder}set placeholder(t){this._placeholder=t,this.widget?.setPlaceHolder(t)}widget;width=0;_onDidChangePattern=new f;onDidChangePattern=this._onDidChangePattern.event;_onDidChangeOpenState=new f;onDidChangeOpenState=this._onDidChangeOpenState.event;enabledDisposables=new v;disposables=new v;isOpened(){return!!this.widget}open(){if(this.widget){this.widget.focus(),this.widget.select();return}this.widget=new nt(this.tree.getHTMLElement(),this.tree,this.contextViewProvider,this.placeholder,this.toggles.states(),{...this.options,history:this._history}),this.enabledDisposables.add(this.widget),this.widget.onDidChangeValue(this.onDidChangeValue,this,this.enabledDisposables),this.widget.onDidDisable(this.close,this,this.enabledDisposables),this.widget.onDidToggleChange(this.onDidToggleChange,this,this.enabledDisposables),this.widget.layout(this.width),this.widget.focus(),this.widget.value=this.previousPattern,this.widget.select(),this._onDidChangeOpenState.fire(!0)}close(){this.widget&&(this._history=this.widget.getHistory(),this.widget=void 0,this.enabledDisposables.clear(),this.previousPattern=this.pattern,this.onDidChangeValue(""),this.tree.domFocus(),this._onDidChangeOpenState.fire(!1))}onDidChangeValue(t){this._pattern=t,this._onDidChangePattern.fire(t),this.filter.pattern=t,this.applyPattern(t)}onDidToggleChange(t){this.toggles.set(t.id,t.isChecked)}updateToggleState(t,e){this.toggles.set(t,e),this.widget?.setToggleState(t,e)}renderMessage(t){t?this.tree.options.showNotFoundMessage??!0?this.widget?.showMessage({type:te.WARNING,content:b("not found","No results found.")}):this.widget?.showMessage({type:te.WARNING}):this.widget?.clearMessage()}alertResults(t){t?se(b("foundResults","{0} results",t)):se(b("replFindNoResults","No results"))}layout(t){this.width=t,this.widget?.layout(t)}dispose(){this._history=void 0,this._onDidChangePattern.dispose(),this.enabledDisposables.dispose(),this.disposables.dispose()}}class lt extends rt{constructor(e,i,o,n={}){const s=n.defaultFindMode??0,r=n.defaultFindMatchType??0,l=[{id:"mode",icon:H.listFilter,title:b("filter","Filter"),isChecked:s===1},{id:"matchType",icon:H.searchFuzzy,title:b("fuzzySearch","Fuzzy Match"),isChecked:r===0}];super(e,i,o,{...n,toggles:l});this.filter=i;this.disposables.add(this.tree.onDidChangeModel(()=>{this.isOpened()&&(this.pattern.length!==0&&this.tree.refilter(),this.render())}))}get mode(){return this.toggles.get("mode")?1:0}set mode(e){if(e===this.mode)return;const i=e===1;this.updateToggleState("mode",i),this.placeholder=i?b("type to filter","Type to filter"):b("type to search","Type to search"),this.tree.refilter(),this.render(),this._onDidChangeMode.fire(e)}get matchType(){return this.toggles.get("matchType")?0:1}set matchType(e){e!==this.matchType&&(this.updateToggleState("matchType",e===0),this.tree.refilter(),this.render(),this._onDidChangeMatchType.fire(e))}_onDidChangeMode=new f;onDidChangeMode=this._onDidChangeMode.event;_onDidChangeMatchType=new f;onDidChangeMatchType=this._onDidChangeMatchType.event;updateOptions(e={}){e.defaultFindMode!==void 0&&(this.mode=e.defaultFindMode),e.defaultFindMatchType!==void 0&&(this.matchType=e.defaultFindMatchType)}applyPattern(e){this.tree.refilter(),e&&this.tree.focusNext(0,!0,void 0,o=>!R.isDefault(o.filterData));const i=this.tree.getFocus();if(i.length>0){const o=i[0];this.tree.getRelativeTop(o)===null&&this.tree.reveal(o,.5)}this.render()}shouldAllowFocus(e){return!this.isOpened()||!this.pattern||this.filter.totalCount>0&&this.filter.matchCount<=1?!0:!R.isDefault(e.filterData)}onDidToggleChange(e){e.id==="mode"?this.mode=e.isChecked?1:0:e.id==="matchType"&&(this.matchType=e.isChecked?0:1)}render(){const i=this.filter.matchCount===0&&this.filter.totalCount>0&&this.pattern.length>0;this.renderMessage(i),this.pattern.length&&this.alertResults(this.filter.matchCount)}}function at(a,t){return a.position===t.position&&re(a,t)}function re(a,t){return a.node.element===t.node.element&&a.startIndex===t.startIndex&&a.height===t.height&&a.endIndex===t.endIndex}class dt{constructor(t=[]){this.stickyNodes=t}get count(){return this.stickyNodes.length}equal(t){return K(this.stickyNodes,t.stickyNodes,at)}contains(t){return this.stickyNodes.some(e=>e.node.element===t.element)}lastNodePartiallyVisible(){if(this.count===0)return!1;const t=this.stickyNodes[this.count-1];if(this.count===1)return t.position!==0;const e=this.stickyNodes[this.count-2];return e.position+e.height!==t.position}animationStateChanged(t){if(!K(this.stickyNodes,t.stickyNodes,re)||this.count===0)return!1;const e=this.stickyNodes[this.count-1],i=t.stickyNodes[t.count-1];return e.position!==i.position}}class ct{constrainStickyScrollNodes(t,e,i){for(let o=0;o<t.length;o++){const n=t[o];if(n.position+n.height>i||o>=e)return t.slice(0,o)}return t}}class le extends I{constructor(e,i,o,n,s,r={}){super();this.tree=e;this.model=i;this.view=o;this.treeDelegate=s;const l=this.validateStickySettings(r);this.stickyScrollMaxItemCount=l.stickyScrollMaxItemCount,this.stickyScrollDelegate=r.stickyScrollDelegate??new ct,this._widget=this._register(new ht(o.getScrollableElement(),o,e,n,s,r.accessibilityProvider)),this.onDidChangeHasFocus=this._widget.onDidChangeHasFocus,this.onContextMenu=this._widget.onContextMenu,this._register(o.onDidScroll(()=>this.update())),this._register(o.onDidChangeContentHeight(()=>this.update())),this._register(e.onDidChangeCollapseState(()=>this.update())),this._register(i.onDidSpliceRenderedNodes(d=>{const h=this._widget.state;if(!h)return;if(d.deleteCount>0&&h.stickyNodes.some(T=>!this.model.has(this.model.getNodeLocation(T.node)))){this.update();return}h.stickyNodes.some(T=>{const m=this.model.getListIndex(this.model.getNodeLocation(T.node));return m>=d.start&&m<d.start+d.deleteCount&&h.contains(T.node)})&&this._widget.rerender()})),this.update()}onDidChangeHasFocus;onContextMenu;stickyScrollDelegate;stickyScrollMaxItemCount;maxWidgetViewRatio=.4;_widget;get height(){return this._widget.height}get count(){return this._widget.count}getNode(e){return this._widget.getNode(e)}getNodeAtHeight(e){let i;if(e===0?i=this.view.firstVisibleIndex:i=this.view.indexAt(e+this.view.scrollTop),!(i<0||i>=this.view.length))return this.view.element(i)}update(){const e=this.getNodeAtHeight(0);if(!e||this.tree.scrollTop===0){this._widget.setState(void 0);return}const i=this.findStickyState(e);this._widget.setState(i)}findStickyState(e){const i=[];let o=e,n=0,s=this.getNextStickyNode(o,void 0,n);for(;s&&(i.push(s),n+=s.height,!(i.length<=this.stickyScrollMaxItemCount&&(o=this.getNextVisibleNode(s),!o)));)s=this.getNextStickyNode(o,s.node,n);const r=this.constrainStickyNodes(i);return r.length?new dt(r):void 0}getNextVisibleNode(e){return this.getNodeAtHeight(e.position+e.height)}getNextStickyNode(e,i,o){const n=this.getAncestorUnderPrevious(e,i);if(n&&!(n===e&&(!this.nodeIsUncollapsedParent(e)||this.nodeTopAlignsWithStickyNodesBottom(e,o))))return this.createStickyScrollNode(n,o)}nodeTopAlignsWithStickyNodesBottom(e,i){const o=this.getNodeIndex(e),n=this.view.getElementTop(o),s=i;return this.view.scrollTop===n-s}createStickyScrollNode(e,i){const o=this.treeDelegate.getHeight(e),{startIndex:n,endIndex:s}=this.getNodeRange(e),r=this.calculateStickyNodePosition(s,i,o);return{node:e,position:r,height:o,startIndex:n,endIndex:s}}getAncestorUnderPrevious(e,i=void 0){let o=e,n=this.getParentNode(o);for(;n;){if(n===i)return o;o=n,n=this.getParentNode(o)}if(i===void 0)return o}calculateStickyNodePosition(e,i,o){let n=this.view.getRelativeTop(e);if(n===null&&this.view.firstVisibleIndex===e&&e+1<this.view.length){const h=this.treeDelegate.getHeight(this.view.element(e)),g=this.view.getRelativeTop(e+1);n=g?g-h/this.view.renderHeight:null}if(n===null)return i;const s=this.view.element(e),r=this.treeDelegate.getHeight(s),d=n*this.view.renderHeight+r;return i+o>d&&i<=d?d-o:i}constrainStickyNodes(e){if(e.length===0)return[];const i=this.view.renderHeight*this.maxWidgetViewRatio,o=e[e.length-1];if(e.length<=this.stickyScrollMaxItemCount&&o.position+o.height<=i)return e;const n=this.stickyScrollDelegate.constrainStickyScrollNodes(e,this.stickyScrollMaxItemCount,i);if(!n.length)return[];const s=n[n.length-1];if(n.length>this.stickyScrollMaxItemCount||s.position+s.height>i)throw new Error("stickyScrollDelegate violates constraints");return n}getParentNode(e){const i=this.model.getNodeLocation(e),o=this.model.getParentNodeLocation(i);return o?this.model.getNode(o):void 0}nodeIsUncollapsedParent(e){const i=this.model.getNodeLocation(e);return this.model.getListRenderCount(i)>1}getNodeIndex(e){const i=this.model.getNodeLocation(e);return this.model.getListIndex(i)}getNodeRange(e){const i=this.model.getNodeLocation(e),o=this.model.getListIndex(i);if(o<0)throw new Error("Node not found in tree");const n=this.model.getListRenderCount(i),s=o+n-1;return{startIndex:o,endIndex:s}}nodePositionTopBelowWidget(e){const i=[];let o=this.getParentNode(e);for(;o;)i.push(o),o=this.getParentNode(o);let n=0;for(let s=0;s<i.length&&s<this.stickyScrollMaxItemCount;s++)n+=this.treeDelegate.getHeight(i[s]);return n}getFocus(){return this._widget.getFocus()}domFocus(){this._widget.domFocus()}focusedLast(){return this._widget.focusedLast()}updateOptions(e={}){if(!e.stickyScrollMaxItemCount)return;const i=this.validateStickySettings(e);this.stickyScrollMaxItemCount!==i.stickyScrollMaxItemCount&&(this.stickyScrollMaxItemCount=i.stickyScrollMaxItemCount,this.update())}validateStickySettings(e){let i=7;return typeof e.stickyScrollMaxItemCount=="number"&&(i=Math.max(e.stickyScrollMaxItemCount,1)),{stickyScrollMaxItemCount:i}}setModel(e){this.model=e}}class ht{constructor(t,e,i,o,n,s){this.view=e;this.tree=i;this.treeRenderers=o;this.treeDelegate=n;this.accessibilityProvider=s;this._rootDomNode=S(".monaco-tree-sticky-container.empty"),t.appendChild(this._rootDomNode);const r=S(".monaco-tree-sticky-container-shadow");this._rootDomNode.appendChild(r),this.stickyScrollFocus=new ut(this._rootDomNode,e),this.onDidChangeHasFocus=this.stickyScrollFocus.onDidChangeHasFocus,this.onContextMenu=this.stickyScrollFocus.onContextMenu}_rootDomNode;_previousState;_previousElements=[];_previousStateDisposables=new v;get state(){return this._previousState}stickyScrollFocus;onDidChangeHasFocus;onContextMenu;get height(){if(!this._previousState)return 0;const t=this._previousState.stickyNodes[this._previousState.count-1];return t.position+t.height}get count(){return this._previousState?.count??0}getNode(t){return this._previousState?.stickyNodes.find(e=>e.node===t)}setState(t){const e=!!this._previousState&&this._previousState.count>0,i=!!t&&t.count>0;if(!e&&!i||e&&i&&this._previousState.equal(t))return;if(e!==i&&this.setVisible(i),!i){this._previousState=void 0,this._previousElements=[],this._previousStateDisposables.clear();return}const o=t.stickyNodes[t.count-1];this._previousState&&t.animationStateChanged(this._previousState)?this._previousElements[this._previousState.count-1].style.top=`${o.position}px`:this.renderState(t),this._previousState=t,this._rootDomNode.style.height=`${o.position+o.height}px`}renderState(t){this._previousStateDisposables.clear();const e=Array(t.count);for(let i=t.count-1;i>=0;i--){const o=t.stickyNodes[i],{element:n,disposable:s}=this.createElement(o,i,t.count);e[i]=n,this._rootDomNode.appendChild(n),this._previousStateDisposables.add(s)}this.stickyScrollFocus.updateElements(e,t),this._previousElements=e}rerender(){this._previousState&&this.renderState(this._previousState)}createElement(t,e,i){const o=t.startIndex,n=document.createElement("div");n.style.top=`${t.position}px`,this.tree.options.setRowHeight!==!1&&(n.style.height=`${t.height}px`),this.tree.options.setRowLineHeight!==!1&&(n.style.lineHeight=`${t.height}px`),n.classList.add("monaco-tree-sticky-row"),n.classList.add("monaco-list-row"),n.setAttribute("data-index",`${o}`),n.setAttribute("data-parity",o%2===0?"even":"odd"),n.setAttribute("id",this.view.getElementID(o));const s=this.setAccessibilityAttributes(n,t.node.element,e,i),r=this.treeDelegate.getTemplateId(t.node),l=this.treeRenderers.find(w=>w.templateId===r);if(!l)throw new Error(`No renderer found for template id ${r}`);let d=t.node;d===this.tree.getNode(this.tree.getNodeLocation(t.node))&&(d=new Proxy(t.node,{}));const h=l.renderTemplate(n);l.renderElement(d,t.startIndex,h,t.height);const g=q(()=>{s.dispose(),l.disposeElement(d,t.startIndex,h,t.height),l.disposeTemplate(h),n.remove()});return{element:n,disposable:g}}setAccessibilityAttributes(t,e,i,o){if(!this.accessibilityProvider)return I.None;this.accessibilityProvider.getSetSize&&t.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e,i,o))),this.accessibilityProvider.getPosInSet&&t.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e,i))),this.accessibilityProvider.getRole&&t.setAttribute("role",this.accessibilityProvider.getRole(e)??"treeitem");const n=this.accessibilityProvider.getAriaLabel(e),s=n&&typeof n!="string"?n:Ge(n),r=$e(d=>{const h=d.readObservable(s);h?t.setAttribute("aria-label",h):t.removeAttribute("aria-label")});typeof n=="string"||n&&t.setAttribute("aria-label",n.get());const l=this.accessibilityProvider.getAriaLevel&&this.accessibilityProvider.getAriaLevel(e);return typeof l=="number"&&t.setAttribute("aria-level",`${l}`),t.setAttribute("aria-selected",String(!1)),r}setVisible(t){this._rootDomNode.classList.toggle("empty",!t),t||this.stickyScrollFocus.updateElements([],void 0)}getFocus(){return this.stickyScrollFocus.getFocus()}domFocus(){this.stickyScrollFocus.domFocus()}focusedLast(){return this.stickyScrollFocus.focusedLast()}dispose(){this.stickyScrollFocus.dispose(),this._previousStateDisposables.dispose(),this._rootDomNode.remove()}}class ut extends I{constructor(e,i){super();this.container=e;this.view=i;this._register(Q(this.container,"focus",()=>this.onFocus())),this._register(Q(this.container,"blur",()=>this.onBlur())),this._register(this.view.onDidFocus(()=>this.toggleStickyScrollFocused(!1))),this._register(this.view.onKeyDown(o=>this.onKeyDown(o))),this._register(this.view.onMouseDown(o=>this.onMouseDown(o))),this._register(this.view.onContextMenu(o=>this.handleContextMenu(o)))}focusedIndex=-1;elements=[];state;_onDidChangeHasFocus=new f;onDidChangeHasFocus=this._onDidChangeHasFocus.event;_onContextMenu=new f;onContextMenu=this._onContextMenu.event;_domHasFocus=!1;get domHasFocus(){return this._domHasFocus}set domHasFocus(e){e!==this._domHasFocus&&(this._onDidChangeHasFocus.fire(e),this._domHasFocus=e)}handleContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){this.focusedLast()&&this.view.domFocus();return}if(!F(e.browserEvent)){if(!this.state)throw new Error("Context menu should not be triggered when state is undefined");const r=this.state.stickyNodes.findIndex(l=>l.node.element===e.element?.element);if(r===-1)throw new Error("Context menu should not be triggered when element is not in sticky scroll widget");this.container.focus(),this.setFocus(r);return}if(!this.state||this.focusedIndex<0)throw new Error("Context menu key should not be triggered when focus is not in sticky scroll widget");const n=this.state.stickyNodes[this.focusedIndex].node.element,s=this.elements[this.focusedIndex];this._onContextMenu.fire({element:n,anchor:s,browserEvent:e.browserEvent,isStickyScroll:!0})}onKeyDown(e){if(this.domHasFocus&&this.state){if(e.key==="ArrowUp")this.setFocusedElement(Math.max(0,this.focusedIndex-1)),e.preventDefault(),e.stopPropagation();else if(e.key==="ArrowDown"||e.key==="ArrowRight"){if(this.focusedIndex>=this.state.count-1){const i=this.state.stickyNodes[this.state.count-1].startIndex+1;this.view.domFocus(),this.view.setFocus([i]),this.scrollNodeUnderWidget(i,this.state)}else this.setFocusedElement(this.focusedIndex+1);e.preventDefault(),e.stopPropagation()}}}onMouseDown(e){const i=e.browserEvent.target;!E(i)&&!x(i)||(e.browserEvent.preventDefault(),e.browserEvent.stopPropagation())}updateElements(e,i){if(i&&i.count===0)throw new Error("Sticky scroll state must be undefined when there are no sticky nodes");if(i&&i.count!==e.length)throw new Error("Sticky scroll focus received illigel state");const o=this.focusedIndex;if(this.removeFocus(),this.elements=e,this.state=i,i){const n=V(o,0,i.count-1);this.setFocus(n)}else this.domHasFocus&&this.view.domFocus();this.container.tabIndex=i?0:-1}setFocusedElement(e){const i=this.state;if(!i)throw new Error("Cannot set focus when state is undefined");if(this.setFocus(e),!(e<i.count-1)&&i.lastNodePartiallyVisible()){const o=i.stickyNodes[e];this.scrollNodeUnderWidget(o.endIndex+1,i)}}scrollNodeUnderWidget(e,i){const o=i.stickyNodes[i.count-1],n=i.count>1?i.stickyNodes[i.count-2]:void 0,s=this.view.getElementTop(e),r=n?n.position+n.height+o.height:o.height;this.view.scrollTop=s-r}getFocus(){if(!(!this.state||this.focusedIndex===-1))return this.state.stickyNodes[this.focusedIndex].node.element}domFocus(){if(!this.state)throw new Error("Cannot focus when state is undefined");this.container.focus()}focusedLast(){return this.state?this.view.getHTMLElement().classList.contains("sticky-scroll-focused"):!1}removeFocus(){this.focusedIndex!==-1&&(this.toggleElementFocus(this.elements[this.focusedIndex],!1),this.focusedIndex=-1)}setFocus(e){if(0>e)throw new Error("addFocus() can not remove focus");if(!this.state&&e>=0)throw new Error("Cannot set focus index when state is undefined");if(this.state&&e>=this.state.count)throw new Error("Cannot set focus index to an index that does not exist");const i=this.focusedIndex;i>=0&&this.toggleElementFocus(this.elements[i],!1),e>=0&&this.toggleElementFocus(this.elements[e],!0),this.focusedIndex=e}toggleElementFocus(e,i){this.toggleElementActiveFocus(e,i&&this.domHasFocus),this.toggleElementPassiveFocus(e,i)}toggleCurrentElementActiveFocus(e){this.focusedIndex!==-1&&this.toggleElementActiveFocus(this.elements[this.focusedIndex],e)}toggleElementActiveFocus(e,i){e.classList.toggle("focused",i)}toggleElementPassiveFocus(e,i){e.classList.toggle("passive-focused",i)}toggleStickyScrollFocused(e){this.view.getHTMLElement().classList.toggle("sticky-scroll-focused",e)}onFocus(){if(!this.state||this.elements.length===0)throw new Error("Cannot focus when state is undefined or elements are empty");this.domHasFocus=!0,this.toggleStickyScrollFocused(!0),this.toggleCurrentElementActiveFocus(!0),this.focusedIndex===-1&&this.setFocus(0)}onBlur(){this.domHasFocus=!1,this.toggleCurrentElementActiveFocus(!1)}dispose(){this.toggleStickyScrollFocused(!1),this._onDidChangeHasFocus.fire(!1),super.dispose()}}function C(a){let t=k.Unknown;return $(a.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=k.Twistie:$(a.browserEvent.target,"monaco-tl-contents","monaco-tl-row")?t=k.Element:$(a.browserEvent.target,"monaco-tree-type-filter","monaco-list")&&(t=k.Filter),{browserEvent:a.browserEvent,element:a.element?a.element.element:null,target:t}}function Tt(a){const t=E(a.browserEvent.target);return{element:a.element?a.element.element:null,browserEvent:a.browserEvent,anchor:a.anchor,isStickyScroll:t}}function W(a,t){t(a),a.children.forEach(e=>W(e,t))}class X{constructor(t,e){this.getFirstViewElementWithTrait=t;this.identityProvider=e}nodes=[];elements;_onDidChange=new f;onDidChange=this._onDidChange.event;_nodeSet;get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}set(t,e){!e?.__forceEvent&&K(this.nodes,t)||this._set(t,!1,e)}_set(t,e,i){if(this.nodes=[...t],this.elements=void 0,this._nodeSet=void 0,!e){const o=this;this._onDidChange.fire({get elements(){return o.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map(t=>t.element)),[...this.elements]}getNodes(){return this.nodes}has(t){return this.nodeSet.has(t)}onDidModelSplice({insertedNodes:t,deletedNodes:e}){if(!this.identityProvider){const l=this.createNodeSet(),d=h=>l.delete(h);e.forEach(h=>W(h,d)),this.set([...l.values()]);return}const i=new Set,o=l=>i.add(this.identityProvider.getId(l.element).toString());e.forEach(l=>W(l,o));const n=new Map,s=l=>n.set(this.identityProvider.getId(l.element).toString(),l);t.forEach(l=>W(l,s));const r=[];for(const l of this.nodes){const d=this.identityProvider.getId(l.element).toString();if(!i.has(d))r.push(l);else{const g=n.get(d);g&&g.visible&&r.push(g)}}if(this.nodes.length>0&&r.length===0){const l=this.getFirstViewElementWithTrait();l&&r.push(l)}this._set(r,!0)}createNodeSet(){const t=new Set;for(const e of this.nodes)t.add(e);return t}}class pt extends Ce{constructor(e,i,o){super(e);this.tree=i;this.stickyScrollProvider=o}onViewPointer(e){if(Se(e.browserEvent.target)||Z(e.browserEvent.target)||Ie(e.browserEvent.target)||e.browserEvent.isHandledByList)return;const i=e.element;if(!i)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const o=e.browserEvent.target,n=o.classList.contains("monaco-tl-twistie")||o.classList.contains("monaco-icon-label")&&o.classList.contains("folder-icon")&&e.browserEvent.offsetX<16,s=x(e.browserEvent.target);let r=!1;if(s?r=!0:typeof this.tree.expandOnlyOnTwistieClick=="function"?r=this.tree.expandOnlyOnTwistieClick(i.element):r=!!this.tree.expandOnlyOnTwistieClick,s)this.handleStickyScrollMouseEvent(e,i);else{if(r&&!n&&e.browserEvent.detail!==2)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&e.browserEvent.detail===2)return super.onViewPointer(e)}if(i.collapsible&&(!s||n)){const l=this.tree.getNodeLocation(i),d=e.browserEvent.altKey;if(this.tree.setFocus([l]),this.tree.toggleCollapsed(l,d),n){e.browserEvent.isHandledByList=!0;return}}s||super.onViewPointer(e)}handleStickyScrollMouseEvent(e,i){if(Fe(e.browserEvent.target)||De(e.browserEvent.target))return;const o=this.stickyScrollProvider();if(!o)throw new Error("Sticky scroll controller not found");const n=this.list.indexOf(i),s=this.list.getElementTop(n),r=o.nodePositionTopBelowWidget(i);this.tree.scrollTop=s-r,this.list.domFocus(),this.list.setFocus([n]),this.list.setSelection([n])}onDoubleClick(e){e.browserEvent.target.classList.contains("monaco-tl-twistie")||!this.tree.expandOnDoubleClick||e.browserEvent.isHandledByList||super.onDoubleClick(e)}onMouseDown(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onMouseDown(e);return}}onContextMenu(e){const i=e.browserEvent.target;if(!E(i)&&!x(i)){super.onContextMenu(e);return}}}class gt extends we{constructor(e,i,o,n,s,r,l,d){super(e,i,o,n,d);this.focusTrait=s;this.selectionTrait=r;this.anchorTrait=l}createMouseController(e){return new pt(this,e.tree,e.stickyScrollProvider)}splice(e,i,o=[]){if(super.splice(e,i,o),o.length===0)return;const n=[],s=[];let r;o.forEach((l,d)=>{this.focusTrait.has(l)&&n.push(e+d),this.selectionTrait.has(l)&&s.push(e+d),this.anchorTrait.has(l)&&(r=e+d)}),n.length>0&&super.setFocus(oe([...super.getFocus(),...n])),s.length>0&&super.setSelection(oe([...super.getSelection(),...s])),typeof r=="number"&&super.setAnchor(r)}setFocus(e,i,o=!1){super.setFocus(e,i),o||this.focusTrait.set(e.map(n=>this.element(n)),i)}setSelection(e,i,o=!1){super.setSelection(e,i),o||this.selectionTrait.set(e.map(n=>this.element(n)),i)}setAnchor(e,i=!1){super.setAnchor(e),i||(typeof e>"u"?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}var ft=(e=>(e[e.Tree=0]="Tree",e[e.StickyScroll=1]="StickyScroll",e))(ft||{});class Li{constructor(t,e,i,o,n={}){this._user=t;this._options=n;n.keyboardNavigationLabelProvider&&(this.findFilter=new Qe(this,n.keyboardNavigationLabelProvider,n.filter),n={...n,filter:this.findFilter},this.disposables.add(this.findFilter)),this.model=this.createModel(t,n),this.treeDelegate=new Ye(i);const s=this.disposables.add(new je(this.onDidChangeActiveNodesRelay.event)),r=new He;this.renderers=o.map(l=>new z(l,this.model,this.onDidChangeCollapseStateRelay.event,s,r,n));for(const l of this.renderers)this.disposables.add(l);if(this.focus=new X(()=>this.view.getFocusedElements()[0],n.identityProvider),this.selection=new X(()=>this.view.getSelectedElements()[0],n.identityProvider),this.anchor=new X(()=>this.view.getAnchorElement(),n.identityProvider),this.view=new gt(t,e,this.treeDelegate,this.renderers,this.focus,this.selection,this.anchor,{...qe(()=>this.model,n),tree:this,stickyScrollProvider:()=>this.stickyScrollController}),this.setupModel(this.model),n.keyboardSupport!==!1){const l=u.chain(this.view.onKeyDown,d=>d.filter(h=>!Z(h.target)).map(h=>new G(h)));u.chain(l,d=>d.filter(h=>h.keyCode===y.LeftArrow))(this.onLeftArrow,this,this.disposables),u.chain(l,d=>d.filter(h=>h.keyCode===y.RightArrow))(this.onRightArrow,this,this.disposables),u.chain(l,d=>d.filter(h=>h.keyCode===y.Space))(this.onSpace,this,this.disposables)}if((n.findWidgetEnabled??!0)&&n.keyboardNavigationLabelProvider&&n.contextViewProvider){const l={styles:n.findWidgetStyles,defaultFindMode:n.defaultFindMode,defaultFindMatchType:n.defaultFindMatchType,showNotFoundMessage:n.showNotFoundMessage};this.findController=this.disposables.add(new lt(this,this.findFilter,n.contextViewProvider,l)),this.focusNavigationFilter=d=>this.findController.shouldAllowFocus(d),this.onDidChangeFindOpenState=this.findController.onDidChangeOpenState,this.onDidChangeFindMode=this.findController.onDidChangeMode,this.onDidChangeFindMatchType=this.findController.onDidChangeMatchType}else this.onDidChangeFindMode=u.None,this.onDidChangeFindMatchType=u.None;n.enableStickyScroll&&(this.stickyScrollController=new le(this,this.model,this.view,this.renderers,this.treeDelegate,n),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus),this.styleElement=fe(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}view;renderers;model;treeDelegate;focus;selection;anchor;eventBufferer=new Ve;findController;findFilter;onDidChangeFindOpenState=u.None;onDidChangeStickyScrollFocused=u.None;focusNavigationFilter;stickyScrollController;styleElement;disposables=new v;get onDidScroll(){return this.view.onDidScroll}get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseClick(){return u.map(this.view.onMouseClick,C)}get onMouseDblClick(){return u.filter(u.map(this.view.onMouseDblClick,C),t=>t.target!==k.Filter)}get onMouseOver(){return u.map(this.view.onMouseOver,C)}get onMouseOut(){return u.map(this.view.onMouseOut,C)}get onContextMenu(){return u.any(u.filter(u.map(this.view.onContextMenu,Tt),t=>!t.isStickyScroll),this.stickyScrollController?.onContextMenu??u.None)}get onTap(){return u.map(this.view.onTap,C)}get onPointer(){return u.map(this.view.onPointer,C)}get onKeyDown(){return this.view.onKeyDown}get onKeyUp(){return this.view.onKeyUp}get onKeyPress(){return this.view.onKeyPress}get onDidFocus(){return this.view.onDidFocus}get onDidBlur(){return this.view.onDidBlur}onDidSwapModel=this.disposables.add(new f);onDidChangeModelRelay=this.disposables.add(new L);onDidSpliceModelRelay=this.disposables.add(new L);onDidChangeCollapseStateRelay=this.disposables.add(new L);onDidChangeRenderNodeCountRelay=this.disposables.add(new L);onDidChangeActiveNodesRelay=this.disposables.add(new L);get onDidChangeModel(){return u.any(this.onDidChangeModelRelay.event,this.onDidSwapModel.event)}get onDidChangeCollapseState(){return this.onDidChangeCollapseStateRelay.event}get onDidChangeRenderNodeCount(){return this.onDidChangeRenderNodeCountRelay.event}_onWillRefilter=new f;onWillRefilter=this._onWillRefilter.event;get findMode(){return this.findController?.mode??0}set findMode(t){this.findController&&(this.findController.mode=t)}onDidChangeFindMode;get findMatchType(){return this.findController?.matchType??0}set findMatchType(t){this.findController&&(this.findController.matchType=t)}onDidChangeFindMatchType;get onDidChangeFindPattern(){return this.findController?this.findController.onDidChangePattern:u.None}get expandOnDoubleClick(){return typeof this._options.expandOnDoubleClick>"u"?!0:this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return typeof this._options.expandOnlyOnTwistieClick>"u"?!0:this._options.expandOnlyOnTwistieClick}_onDidUpdateOptions=new f;onDidUpdateOptions=this._onDidUpdateOptions.event;get onDidDispose(){return this.view.onDidDispose}updateOptions(t={}){this._options={...this._options,...t};for(const e of this.renderers)e.updateOptions(t);this.view.updateOptions(this._options),this.findController?.updateOptions(t),this.updateStickyScroll(t),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides==="always")}get options(){return this._options}updateStickyScroll(t){!this.stickyScrollController&&this._options.enableStickyScroll?(this.stickyScrollController=new le(this,this.model,this.view,this.renderers,this.treeDelegate,this._options),this.onDidChangeStickyScrollFocused=this.stickyScrollController.onDidChangeHasFocus):this.stickyScrollController&&!this._options.enableStickyScroll&&(this.onDidChangeStickyScrollFocused=u.None,this.stickyScrollController.dispose(),this.stickyScrollController=void 0),this.stickyScrollController?.updateOptions(t)}updateWidth(t){const e=this.model.getListIndex(t);e!==-1&&this.view.updateWidth(e)}getHTMLElement(){return this.view.getHTMLElement()}get contentHeight(){return this.view.contentHeight}get contentWidth(){return this.view.contentWidth}get onDidChangeContentHeight(){return this.view.onDidChangeContentHeight}get onDidChangeContentWidth(){return this.view.onDidChangeContentWidth}get scrollTop(){return this.view.scrollTop}set scrollTop(t){this.view.scrollTop=t}get scrollLeft(){return this.view.scrollLeft}set scrollLeft(t){this.view.scrollLeft=t}get scrollHeight(){return this.view.scrollHeight}get renderHeight(){return this.view.renderHeight}get firstVisibleElement(){let t=this.view.firstVisibleIndex;return this.stickyScrollController&&(t+=this.stickyScrollController.count),t<0||t>=this.view.length?void 0:this.view.element(t).element}get lastVisibleElement(){const t=this.view.lastVisibleIndex;return this.view.element(t).element}get ariaLabel(){return this.view.ariaLabel}set ariaLabel(t){this.view.ariaLabel=t}get selectionSize(){return this.selection.getNodes().length}domFocus(){this.stickyScrollController?.focusedLast()?this.stickyScrollController.domFocus():this.view.domFocus()}isDOMFocused(){return ve(this.getHTMLElement())}layout(t,e){this.view.layout(t,e),ze(e)&&this.findController?.layout(e)}style(t){const e=`.${this.view.domId}`,i=[];t.treeIndentGuidesStroke&&(i.push(`.monaco-list${e}:hover .monaco-tl-indent > .indent-guide, .monaco-list${e}.always .monaco-tl-indent > .indent-guide  { border-color: ${t.treeInactiveIndentGuidesStroke}; }`),i.push(`.monaco-list${e} .monaco-tl-indent > .indent-guide.active { border-color: ${t.treeIndentGuidesStroke}; }`));const o=t.treeStickyScrollBackground??t.listBackground;o&&(i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { background-color: ${o}; }`),i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-row { background-color: ${o}; }`)),t.treeStickyScrollBorder&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container { border-bottom: 1px solid ${t.treeStickyScrollBorder}; }`),t.treeStickyScrollShadow&&i.push(`.monaco-list${e} .monaco-scrollable-element .monaco-tree-sticky-container .monaco-tree-sticky-container-shadow { box-shadow: ${t.treeStickyScrollShadow} 0 6px 6px -6px inset; height: 3px; }`),t.listFocusForeground&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { color: ${t.listFocusForeground}; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { color: inherit; }`));const n=ee(t.listFocusAndSelectionOutline,ee(t.listSelectionOutline,t.listFocusOutline??""));n&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused.selected { outline: 1px solid ${n}; outline-offset: -1px;}`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused.selected { outline: inherit;}`)),t.listFocusOutline&&(i.push(`.monaco-list${e}.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container:focus .monaco-list-row.focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-list${e}:not(.sticky-scroll-focused) .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-scrollable-element .monaco-tree-sticky-container .monaco-list-row.passive-focused { outline: 1px solid ${t.listFocusOutline}; outline-offset: -1px; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused.sticky-scroll-focused .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`),i.push(`.monaco-workbench.context-menu-visible .monaco-list${e}.last-focused:not(.sticky-scroll-focused) .monaco-tree-sticky-container .monaco-list-rows .monaco-list-row.focused { outline: inherit; }`)),this.styleElement.textContent=i.join(`
`),this.view.style(t)}getParentElement(t){const e=this.model.getParentNodeLocation(t);return this.model.getNode(e).element}getFirstElementChild(t){return this.model.getFirstElementChild(t)}getNode(t){return this.model.getNode(t)}getNodeLocation(t){return this.model.getNodeLocation(t)}collapse(t,e=!1){return this.model.setCollapsed(t,!0,e)}expand(t,e=!1){return this.model.setCollapsed(t,!1,e)}toggleCollapsed(t,e=!1){return this.model.setCollapsed(t,void 0,e)}expandAll(){this.model.setCollapsed(this.model.rootRef,!1,!0)}collapseAll(){this.model.setCollapsed(this.model.rootRef,!0,!0)}isCollapsible(t){return this.model.isCollapsible(t)}setCollapsible(t,e){return this.model.setCollapsible(t,e)}isCollapsed(t){return this.model.isCollapsed(t)}expandTo(t){this.model.expandTo(t)}triggerTypeNavigation(){this.view.triggerTypeNavigation()}openFind(){this.findController?.open()}closeFind(){this.findController?.close()}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setAnchor(t){if(typeof t>"u")return this.view.setAnchor(void 0);this.eventBufferer.bufferEvents(()=>{const e=this.model.getNode(t);this.anchor.set([e]);const i=this.model.getListIndex(t);i>-1&&this.view.setAnchor(i,!0)})}getAnchor(){return this.anchor.get().at(0)}setSelection(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(n=>this.model.getNode(n));this.selection.set(i,e);const o=t.map(n=>this.model.getListIndex(n)).filter(n=>n>-1);this.view.setSelection(o,e,!0)})}getSelection(){return this.selection.get()}setFocus(t,e){this.eventBufferer.bufferEvents(()=>{const i=t.map(n=>this.model.getNode(n));this.focus.set(i,e);const o=t.map(n=>this.model.getListIndex(n)).filter(n=>n>-1);this.view.setFocus(o,e,!0)})}focusNext(t=1,e=!1,i,o=F(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusNext(t,e,i,o)}focusPrevious(t=1,e=!1,i,o=F(i)&&i.altKey?void 0:this.focusNavigationFilter){this.view.focusPrevious(t,e,i,o)}focusNextPage(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusNextPage(t,e)}focusPreviousPage(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){return this.view.focusPreviousPage(t,e,()=>this.stickyScrollController?.height??0)}focusLast(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusLast(t,e)}focusFirst(t,e=F(t)&&t.altKey?void 0:this.focusNavigationFilter){this.view.focusFirst(t,e)}getFocus(){return this.focus.get()}getStickyScrollFocus(){const t=this.stickyScrollController?.getFocus();return t!==void 0?[t]:[]}getFocusedPart(){return this.stickyScrollController?.focusedLast()?1:0}reveal(t,e){this.model.expandTo(t);const i=this.model.getListIndex(t);if(i!==-1)if(!this.stickyScrollController)this.view.reveal(i,e);else{const o=this.stickyScrollController.nodePositionTopBelowWidget(this.getNode(t));this.view.reveal(i,e,o)}}getRelativeTop(t){const e=this.model.getListIndex(t);if(e===-1)return null;const i=this.stickyScrollController?.getNode(this.getNode(t));return this.view.getRelativeTop(e,i?.position??this.stickyScrollController?.height)}getViewState(t=this.options.identityProvider){if(!t)throw new Le(this._user,"Can't get tree view state without an identity provider");const e=s=>t.getId(s).toString(),i=A.empty(this.scrollTop);for(const s of this.getFocus())i.focus.add(e(s));for(const s of this.getSelection())i.selection.add(e(s));const o=this.model.getNode(),n=[o];for(;n.length>0;){const s=n.shift();s!==o&&s.collapsible&&(i.expanded[e(s.element)]=s.collapsed?0:1),n.push(...s.children)}return i}onLeftArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i);if(!this.model.setCollapsed(o,!0)){const s=this.model.getParentNodeLocation(o);if(!s)return;const r=this.model.getListIndex(s);this.view.reveal(r),this.view.setFocus([r])}}onRightArrow(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i);if(!this.model.setCollapsed(o,!1)){if(!i.children.some(l=>l.visible))return;const[s]=this.view.getFocus(),r=s+1;this.view.reveal(r),this.view.setFocus([r])}}onSpace(t){t.preventDefault(),t.stopPropagation();const e=this.view.getFocusedElements();if(e.length===0)return;const i=e[0],o=this.model.getNodeLocation(i),n=t.browserEvent.altKey;this.model.setCollapsed(o,void 0,n)}createNewModel(t={}){return this.createModel(this._user,{...this._options,filter:this.findFilter,...t})}modelDisposables=new v;setupModel(t){this.modelDisposables.clear(),this.modelDisposables.add(t.onDidSpliceRenderedNodes(({start:n,deleteCount:s,elements:r})=>this.view.splice(n,s,r)));const e=u.forEach(t.onDidSpliceModel,n=>{this.eventBufferer.bufferEvents(()=>{this.focus.onDidModelSplice(n),this.selection.onDidModelSplice(n)})},this.modelDisposables);e(()=>null,null,this.modelDisposables);const i=this.modelDisposables.add(new f),o=this.modelDisposables.add(new Pe(0));this.modelDisposables.add(u.any(e,this.focus.onDidChange,this.selection.onDidChange)(()=>{o.trigger(()=>{const n=new Set;for(const s of this.focus.getNodes())n.add(s);for(const s of this.selection.getNodes())n.add(s);i.fire([...n.values()])})})),this.onDidChangeActiveNodesRelay.input=i.event,this.onDidChangeModelRelay.input=u.signal(t.onDidSpliceModel),this.onDidChangeCollapseStateRelay.input=t.onDidChangeCollapseState,this.onDidChangeRenderNodeCountRelay.input=t.onDidChangeRenderNodeCount,this.onDidSpliceModelRelay.input=t.onDidSpliceModel}setModel(t){const e=this.model;this.model=t,this.setupModel(t),this.renderers.forEach(i=>i.setModel(t)),this.stickyScrollController?.setModel(t),this.focus.set([]),this.selection.set([]),this.anchor.set([]),this.view.splice(0,e.getListRenderCount(e.rootRef)),t.refilter(),this.onDidSwapModel.fire()}getModel(){return this.model}navigate(t){return new vt(this.view,this.model,t)}dispose(){U(this.disposables),this.stickyScrollController?.dispose(),this.view.dispose(),this.modelDisposables.dispose()}}class vt{constructor(t,e,i){this.view=t;this.model=e;i?this.index=this.model.getListIndex(i):this.index=-1}index;current(){return this.index<0||this.index>=this.view.length?null:this.view.element(this.index).element}previous(){return this.index--,this.current()}next(){return this.index++,this.current()}first(){return this.index=0,this.current()}last(){return this.index=this.view.length-1,this.current()}}export{rt as AbstractFindController,Li as AbstractTree,ft as AbstractTreePart,A as AbstractTreeViewState,Ye as ComposedTreeDelegate,et as FindToggles,Xe as RenderIndentGuides,ot as TreeFindMatchType,it as TreeFindMode,z as TreeRenderer,Je as contiguousFuzzyScore};
