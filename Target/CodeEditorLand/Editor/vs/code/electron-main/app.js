var Ee=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Y=(L,P,i,t)=>{for(var n=t>1?void 0:t?xe(P,i):P,e=L.length-1,r;e>=0;e--)(r=L[e])&&(n=(t?r(P,i,n):r(n))||n);return t&&n&&Ee(P,i,n),n},y=(L,P)=>(i,t)=>P(i,t,L);import{app as R,BrowserWindow as Te,protocol as z,session as U,systemPreferences as j}from"electron";import{addUNCHostToAllowlist as Fe,disableUNCAccessRestrictions as ke}from"../../base/node/unc.js";import{validatedIpcMain as W}from"../../base/parts/ipc/electron-main/ipcMain.js";import{hostname as Ne,release as Ae}from"os";import{VSBuffer as J}from"../../base/common/buffer.js";import{toErrorMessage as He}from"../../base/common/errorMessage.js";import{isSigPipeError as De,onUnexpectedError as Z,setUnexpectedErrorHandler as _e}from"../../base/common/errors.js";import{Event as A}from"../../base/common/event.js";import{parse as qe}from"../../base/common/jsonc.js";import{getPathLabel as H}from"../../base/common/labels.js";import{Disposable as Be,DisposableStore as $e}from"../../base/common/lifecycle.js";import{Schemas as u,VSCODE_AUTHORITY as Q}from"../../base/common/network.js";import{join as Ve,posix as Ke}from"../../base/common/path.js";import{isLinux as Ge,isLinuxSnap as Ye,isMacintosh as x,isWindows as T,OS as D}from"../../base/common/platform.js";import{assertType as ze}from"../../base/common/types.js";import{URI as w}from"../../base/common/uri.js";import{generateUuid as je}from"../../base/common/uuid.js";import{registerContextMenuListener as Je}from"../../base/parts/contextmenu/electron-main/contextmenu.js";import{getDelayedChannel as X,ProxyChannel as f,StaticRouter as Ze}from"../../base/parts/ipc/common/ipc.js";import{Server as Qe}from"../../base/parts/ipc/electron-main/ipc.electron.js";import{Client as Xe}from"../../base/parts/ipc/electron-main/ipc.mp.js";import"../../base/parts/ipc/node/ipc.net.js";import{IProxyAuthService as ee,ProxyAuthService as er}from"../../platform/native/electron-main/auth.js";import{localize as I}from"../../nls.js";import{IBackupMainService as rr}from"../../platform/backup/electron-main/backup.js";import{BackupMainService as ir}from"../../platform/backup/electron-main/backupMainService.js";import{IConfigurationService as tr}from"../../platform/configuration/common/configuration.js";import{ElectronExtensionHostDebugBroadcastChannel as nr}from"../../platform/debug/electron-main/extensionHostDebugIpc.js";import{IDiagnosticsService as or}from"../../platform/diagnostics/common/diagnostics.js";import{DiagnosticsMainService as sr,IDiagnosticsMainService as re}from"../../platform/diagnostics/electron-main/diagnosticsMainService.js";import{DialogMainService as ar,IDialogMainService as ie}from"../../platform/dialogs/electron-main/dialogMainService.js";import{IEncryptionMainService as te}from"../../platform/encryption/common/encryptionService.js";import{EncryptionMainService as cr}from"../../platform/encryption/electron-main/encryptionMainService.js";import"../../platform/environment/common/argv.js";import{IEnvironmentMainService as lr}from"../../platform/environment/electron-main/environmentMainService.js";import{isLaunchedFromCli as dr}from"../../platform/environment/node/argvHelper.js";import{getResolvedShellEnv as vr}from"../../platform/shell/node/shellEnv.js";import{IExtensionHostStarter as ne,ipcExtensionHostStarterChannelName as pr}from"../../platform/extensions/common/extensionHostStarter.js";import{ExtensionHostStarter as mr}from"../../platform/extensions/electron-main/extensionHostStarter.js";import{IExternalTerminalMainService as F}from"../../platform/externalTerminal/electron-main/externalTerminal.js";import{LinuxExternalTerminalService as ur,MacExternalTerminalService as hr,WindowsExternalTerminalService as fr}from"../../platform/externalTerminal/node/externalTerminalService.js";import{LOCAL_FILE_SYSTEM_CHANNEL_NAME as oe}from"../../platform/files/common/diskFileSystemProviderClient.js";import{IFileService as Sr}from"../../platform/files/common/files.js";import{DiskFileSystemProviderChannel as gr}from"../../platform/files/electron-main/diskFileSystemProviderServer.js";import{DiskFileSystemProvider as wr}from"../../platform/files/node/diskFileSystemProvider.js";import{SyncDescriptor as v}from"../../platform/instantiation/common/descriptors.js";import{IInstantiationService as yr}from"../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Mr}from"../../platform/instantiation/common/serviceCollection.js";import{IProcessMainService as se,IIssueMainService as ae}from"../../platform/issue/common/issue.js";import{IssueMainService as Ir}from"../../platform/issue/electron-main/issueMainService.js";import{ProcessMainService as Cr}from"../../platform/issue/electron-main/processMainService.js";import{IKeyboardLayoutMainService as ce,KeyboardLayoutMainService as Pr}from"../../platform/keyboardLayout/electron-main/keyboardLayoutMainService.js";import{ILaunchMainService as le,LaunchMainService as Rr}from"../../platform/launch/electron-main/launchMainService.js";import{ILifecycleMainService as Ur,LifecycleMainPhase as _,ShutdownReason as br}from"../../platform/lifecycle/electron-main/lifecycleMainService.js";import{ILoggerService as Wr,ILogService as Or}from"../../platform/log/common/log.js";import{IMenubarMainService as de,MenubarMainService as Lr}from"../../platform/menubar/electron-main/menubarMainService.js";import{INativeHostMainService as q,NativeHostMainService as Er}from"../../platform/native/electron-main/nativeHostMainService.js";import{IProductService as xr}from"../../platform/product/common/productService.js";import{getRemoteAuthority as Tr}from"../../platform/remote/common/remoteHosts.js";import{SharedProcess as Fr}from"../../platform/sharedProcess/electron-main/sharedProcess.js";import{ISignService as kr}from"../../platform/sign/common/sign.js";import{IStateService as Nr}from"../../platform/state/node/state.js";import{StorageDatabaseChannel as Ar}from"../../platform/storage/electron-main/storageIpc.js";import{ApplicationStorageMainService as Hr,IApplicationStorageMainService as Dr,IStorageMainService as B,StorageMainService as _r}from"../../platform/storage/electron-main/storageMainService.js";import{resolveCommonProperties as qr}from"../../platform/telemetry/common/commonProperties.js";import{ITelemetryService as ve,TelemetryLevel as Br}from"../../platform/telemetry/common/telemetry.js";import{TelemetryAppenderClient as $r}from"../../platform/telemetry/common/telemetryIpc.js";import{TelemetryService as Vr}from"../../platform/telemetry/common/telemetryService.js";import{getPiiPathsFromEnvironment as Kr,getTelemetryLevel as Gr,isInternalTelemetry as Yr,NullTelemetryService as zr,supportsTelemetry as jr}from"../../platform/telemetry/common/telemetryUtils.js";import{IUpdateService as O}from"../../platform/update/common/update.js";import{UpdateChannel as Jr}from"../../platform/update/common/updateIpc.js";import{DarwinUpdateService as Zr}from"../../platform/update/electron-main/updateService.darwin.js";import{LinuxUpdateService as Qr}from"../../platform/update/electron-main/updateService.linux.js";import{SnapUpdateService as Xr}from"../../platform/update/electron-main/updateService.snap.js";import{Win32UpdateService as ei}from"../../platform/update/electron-main/updateService.win32.js";import{IURLService as $}from"../../platform/url/common/url.js";import{URLHandlerChannelClient as ri,URLHandlerRouter as ii}from"../../platform/url/common/urlIpc.js";import{NativeURLService as ti}from"../../platform/url/common/urlService.js";import{ElectronURLListener as ni}from"../../platform/url/electron-main/electronUrlListener.js";import{IWebviewManagerService as pe}from"../../platform/webview/common/webviewManagerService.js";import{WebviewMainService as oi}from"../../platform/webview/electron-main/webviewMainService.js";import{isFolderToOpen as si,isWorkspaceToOpen as ai}from"../../platform/window/common/window.js";import{IWindowsMainService as k,OpenContext as C}from"../../platform/windows/electron-main/windows.js";import"../../platform/window/electron-main/window.js";import{WindowsMainService as ci}from"../../platform/windows/electron-main/windowsMainService.js";import{ActiveWindowManager as li}from"../../platform/windows/node/windowTracker.js";import{hasWorkspaceFileExtension as N}from"../../platform/workspace/common/workspace.js";import{IWorkspacesService as me}from"../../platform/workspaces/common/workspaces.js";import{IWorkspacesHistoryMainService as di,WorkspacesHistoryMainService as vi}from"../../platform/workspaces/electron-main/workspacesHistoryMainService.js";import{WorkspacesMainService as pi}from"../../platform/workspaces/electron-main/workspacesMainService.js";import{IWorkspacesManagementMainService as mi,WorkspacesManagementMainService as ui}from"../../platform/workspaces/electron-main/workspacesManagementMainService.js";import{IPolicyService as hi}from"../../platform/policy/common/policy.js";import{PolicyChannel as fi}from"../../platform/policy/common/policyIpc.js";import{IUserDataProfilesMainService as V}from"../../platform/userDataProfile/electron-main/userDataProfile.js";import{IExtensionsProfileScannerService as Si}from"../../platform/extensionManagement/common/extensionsProfileScannerService.js";import{IExtensionsScannerService as gi}from"../../platform/extensionManagement/common/extensionsScannerService.js";import{ExtensionsScannerService as wi}from"../../platform/extensionManagement/node/extensionsScannerService.js";import{UserDataProfilesHandler as yi}from"../../platform/userDataProfile/electron-main/userDataProfilesHandler.js";import{ProfileStorageChangesListenerChannel as Mi}from"../../platform/userDataProfile/electron-main/userDataProfileStorageIpc.js";import{Promises as Ii,RunOnceScheduler as Ci,runWhenGlobalIdle as Pi}from"../../base/common/async.js";import{resolveMachineId as Ri,resolveSqmId as Ui,resolvedevDeviceId as bi}from"../../platform/telemetry/electron-main/telemetryUtils.js";import{ExtensionsProfileScannerService as Wi}from"../../platform/extensionManagement/node/extensionsProfileScannerService.js";import{LoggerChannel as Oi}from"../../platform/log/electron-main/logIpc.js";import{ILoggerMainService as Li}from"../../platform/log/electron-main/loggerService.js";import"../../platform/url/electron-main/url.js";import{IUtilityProcessWorkerMainService as ue,UtilityProcessWorkerMainService as Ei}from"../../platform/utilityProcess/electron-main/utilityProcessWorkerMainService.js";import{ipcUtilityProcessWorkerChannelName as xi}from"../../platform/utilityProcess/common/utilityProcessWorkerService.js";import{ILocalPtyService as he,LocalReconnectConstants as fe,TerminalIpcChannels as Ti,TerminalSettingId as Fi}from"../../platform/terminal/common/terminal.js";import{ElectronPtyHostStarter as ki}from"../../platform/terminal/electron-main/electronPtyHostStarter.js";import{PtyHostService as Ni}from"../../platform/terminal/node/ptyHostService.js";import{NODE_REMOTE_RESOURCE_CHANNEL_NAME as Ai,NODE_REMOTE_RESOURCE_IPC_METHOD_NAME as Hi,NodeRemoteResourceRouter as Di}from"../../platform/remote/common/electronRemoteResources.js";import{Lazy as _i}from"../../base/common/lazy.js";import{IAuxiliaryWindowsMainService as Se}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindows.js";import{AuxiliaryWindowsMainService as qi}from"../../platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.js";import{normalizeNFC as ge}from"../../base/common/normalization.js";import{ICSSDevelopmentService as Bi,CSSDevelopmentService as $i}from"../../platform/cssDev/node/cssDevService.js";import{ExtensionSignatureVerificationService as Vi,IExtensionSignatureVerificationService as we}from"../../platform/extensionManagement/node/extensionSignatureVerificationService.js";let b=class extends Be{constructor(i,t,n,e,r,s,a,d,p,S,o,c){super();this.mainProcessNodeIpcServer=i;this.userEnv=t;this.mainInstantiationService=n;this.logService=e;this.loggerService=r;this.environmentMainService=s;this.lifecycleMainService=a;this.configurationService=d;this.stateService=p;this.fileService=S;this.productService=o;this.userDataProfilesMainService=c;this.configureSession(),this.registerListeners()}static SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY={[u.file]:"security.promptForLocalFileProtocolHandling",[u.vscodeRemote]:"security.promptForRemoteFileProtocolHandling"};windowsMainService;auxiliaryWindowsMainService;nativeHostMainService;configureSession(){const i=o=>o?.startsWith(`${u.vscodeFileResource}://${Q}`),t=o=>o?.startsWith(`${u.vscodeWebview}://`),n=new Set(["clipboard-read","clipboard-sanitized-write"]),e=new Set(["media"]);U.defaultSession.setPermissionRequestHandler((o,c,l,m)=>t(m.requestingUrl)?l(n.has(c)):i(m.requestingUrl)?l(e.has(c)):l(!1)),U.defaultSession.setPermissionCheckHandler((o,c,l,m)=>t(m.requestingUrl)?n.has(c):i(m.requestingUrl)?e.has(c):!1);const r=new Set([u.file,u.vscodeFileResource,u.vscodeRemoteResource,u.vscodeManagedRemoteResource,"devtools"]),s=o=>{for(let c=o;c;c=c.parent)if(c.url.startsWith(`${u.vscodeWebview}://`))return!0;return!1},a=o=>o.resourceType==="xhr"||s(o.frame),d=o=>{const c=o.frame;if(!c||!this.windowsMainService)return!1;const l=Te.getAllWindows();for(const m of l)if(c.processId===m.webContents.mainFrame.processId)return!0;return!1},p=(o,c)=>{if(o.path!=="/index.html")return!0;const l=c.frame;if(!l||!this.windowsMainService)return!1;for(const m of this.windowsMainService.getWindows())if(m.win&&l.processId===m.win.webContents.mainFrame.processId)return!0;return!1};U.defaultSession.webRequest.onBeforeRequest((o,c)=>{const l=w.parse(o.url);return l.scheme===u.vscodeWebview&&!p(l,o)?(this.logService.error("Blocked vscode-webview request",o.url),c({cancel:!0})):l.scheme===u.vscodeFileResource&&!d(o)?(this.logService.error("Blocked vscode-file request",o.url),c({cancel:!0})):l.path.endsWith(".svg")&&!r.has(l.scheme)?c({cancel:!a(o)}):c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{const l=o.responseHeaders,m=l["content-type"]||l["Content-Type"];if(m&&Array.isArray(m)){const h=w.parse(o.url);if(h.path.endsWith(".svg")&&r.has(h.scheme))return l["Content-Type"]=["image/svg+xml"],c({cancel:!1,responseHeaders:l});if(!h.path.endsWith(u.vscodeRemoteResource)&&m.some(M=>M.toLowerCase().includes("image/svg")))return c({cancel:!a(o)})}return c({cancel:!1})}),U.defaultSession.webRequest.onHeadersReceived((o,c)=>{if(o.url.startsWith("https://vscode.download.prss.microsoft.com/")){const l=o.responseHeaders??Object.create(null);if(l["Access-Control-Allow-Origin"]===void 0)return l["Access-Control-Allow-Origin"]=["*"],c({cancel:!1,responseHeaders:l})}return c({cancel:!1})});const S=U.defaultSession;typeof S.setCodeCachePath=="function"&&this.environmentMainService.codeCachePath&&S.setCodeCachePath(Ve(this.environmentMainService.codeCachePath,"chrome")),T&&(this.configurationService.getValue("security.restrictUNCAccess")===!1?ke():Fe(this.configurationService.getValue("security.allowedUNCHosts")))}registerListeners(){_e(n=>this.onUnexpectedError(n)),process.on("uncaughtException",n=>{De(n)||Z(n)}),process.on("unhandledRejection",n=>Z(n)),A.once(this.lifecycleMainService.onWillShutdown)(()=>this.dispose()),Je(),R.on("accessibility-support-changed",(n,e)=>{this.windowsMainService?.sendToAll("vscode:accessibilitySupportChanged",e)}),R.on("activate",async(n,e)=>{this.logService.trace("app#activate"),e||await this.windowsMainService?.openEmptyWindow({context:C.DOCK})}),R.on("web-contents-created",(n,e)=>{e?.opener?.url.startsWith(`${u.vscodeFileResource}://${Q}/`)&&(this.logService.trace('[aux window]  app.on("web-contents-created"): Registering auxiliary window'),this.auxiliaryWindowsMainService?.registerWindow(e)),e.on("will-navigate",r=>{this.logService.error("webContents#will-navigate: Prevented webcontent navigation"),r.preventDefault()}),e.setWindowOpenHandler(r=>r.url==="about:blank"?(this.logService.trace("[aux window] webContents#setWindowOpenHandler: Allowing auxiliary window to open on about:blank"),{action:"allow",overrideBrowserWindowOptions:this.auxiliaryWindowsMainService?.createWindow(r)}):(this.logService.trace(`webContents#setWindowOpenHandler: Prevented opening window with URL ${r.url}}`),this.nativeHostMainService?.openExternal(void 0,r.url),{action:"deny"}))});let i=[],t;R.on("open-file",(n,e)=>{e=ge(e),this.logService.trace("app#open-file: ",e),n.preventDefault(),i.push(N(e)?{workspaceUri:w.file(e)}:{fileUri:w.file(e)}),t!==void 0&&(clearTimeout(t),t=void 0),t=setTimeout(async()=>{await this.windowsMainService?.open({context:C.DOCK,cli:this.environmentMainService.args,urisToOpen:i,gotoLineMode:!1,preferNewWindow:!0}),i=[],t=void 0},100)}),R.on("new-window-for-tab",async()=>{await this.windowsMainService?.openEmptyWindow({context:C.DESKTOP})}),W.handle("vscode:fetchShellEnv",n=>{const e=this.windowsMainService?.getWindowByWebContents(n.sender);let r,s;return e?.config?(r=e.config,s={...process.env,...e.config.userEnv}):(r=this.environmentMainService.args,s=process.env),this.resolveShellEnvironment(r,s,!1)}),W.on("vscode:toggleDevTools",n=>n.sender.toggleDevTools()),W.on("vscode:openDevTools",n=>n.sender.openDevTools()),W.on("vscode:reloadWindow",n=>n.sender.reload()),W.handle("vscode:notifyZoomLevel",async(n,e)=>{const r=this.windowsMainService?.getWindowByWebContents(n.sender);r&&r.notifyZoomLevel(e)})}onUnexpectedError(i){if(i){const t={message:`[uncaught exception in main]: ${i.message}`,stack:i.stack};this.windowsMainService?.sendToFocused("vscode:reportError",JSON.stringify(t))}this.logService.error(`[uncaught exception in main]: ${i}`),i.stack&&this.logService.error(i.stack)}async startup(){this.logService.debug("Starting VS Code"),this.logService.debug(`from: ${this.environmentMainService.appRoot}`),this.logService.debug("args:",this.environmentMainService.args);const i=this.productService.win32AppUserModelId;T&&i&&R.setAppUserModelId(i);try{x&&this.configurationService.getValue("window.nativeTabs")===!0&&!j.getUserDefault("NSUseImprovedLayoutPass","boolean")&&j.setUserDefault("NSUseImprovedLayoutPass","boolean",!0)}catch(o){this.logService.error(o)}const t=new Qe;A.once(this.lifecycleMainService.onWillShutdown)(o=>{o.reason===br.KILL&&t.dispose()}),this.logService.trace("Resolving machine identifier...");const[n,e,r]=await Promise.all([Ri(this.stateService,this.logService),Ui(this.stateService,this.logService),bi(this.stateService,this.logService)]);this.logService.trace(`Resolved machine identifier: ${n}`);const{sharedProcessReady:s,sharedProcessClient:a}=this.setupSharedProcess(n,e,r),d=await this.initServices(n,e,r,s);d.invokeFunction(o=>o.get(ee)),this._register(d.createInstance(yi)),d.invokeFunction(o=>this.initChannels(o,t,a));const p=await d.invokeFunction(o=>this.setupProtocolUrlHandlers(o,t));this.setupManagedRemoteResourceUrlHandler(t),this.lifecycleMainService.phase=_.Ready,await d.invokeFunction(o=>this.openFirstWindow(o,p)),this.lifecycleMainService.phase=_.AfterWindowOpen,this.afterWindowOpen(),this._register(new Ci(()=>{this._register(Pi(()=>this.lifecycleMainService.phase=_.Eventually,2500))},2500)).schedule()}async setupProtocolUrlHandlers(i,t){const n=this.windowsMainService=i.get(k),e=i.get($),r=this.nativeHostMainService=i.get(q),s=i.get(ie),a=this;e.registerHandler({async handleURL(l,m){return a.handleProtocolUrl(n,s,e,l,m)}});const d=this._register(new li({onDidOpenMainWindow:r.onDidOpenMainWindow,onDidFocusMainWindow:r.onDidFocusMainWindow,getActiveWindowId:()=>r.getActiveWindowId(-1)})),p=new Ze(l=>d.getActiveClientId().then(m=>l===m)),S=new ii(p,this.logService),o=t.getChannel("urlHandler",S);e.registerHandler(new ri(o));const c=await this.resolveInitialProtocolUrls(n,s);return this._register(new ni(c?.urls,e,n,this.environmentMainService,this.productService,this.logService)),c}setupManagedRemoteResourceUrlHandler(i){const t=()=>({statusCode:404,data:"Not found"}),n=new _i(()=>i.getChannel(Ai,new Di));z.registerBufferProtocol(u.vscodeManagedRemoteResource,(e,r)=>{const s=w.parse(e.url);if(!s.authority.startsWith("window:"))return r(t());n.value.call(Hi,[s]).then(a=>r({...a,data:Buffer.from(a.body,"base64")}),a=>{this.logService.warn("error dispatching remote resource call",a),r({statusCode:500,data:String(a)})})})}async resolveInitialProtocolUrls(i,t){const n=this.environmentMainService.args["open-url"]?this.environmentMainService.args._urls||[]:[];n.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from command line:",n);const e=global.getOpenUrls()||[];if(e.length>0&&this.logService.trace("app#resolveInitialProtocolUrls() protocol urls from macOS 'open-url' event:",e),n.length+e.length===0)return;const r=[...n,...e].map(d=>{try{return{uri:w.parse(d),originalUrl:d}}catch{this.logService.trace("app#resolveInitialProtocolUrls() protocol url failed to parse:",d);return}}),s=[],a=[];for(const d of r){if(!d)continue;const p=this.getWindowOpenableFromProtocolUrl(d.uri);if(p)if(await this.shouldBlockOpenable(p,i,t)){this.logService.trace("app#resolveInitialProtocolUrls() protocol url was blocked:",d.uri.toString(!0));continue}else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be handled as window to open:",d.uri.toString(!0),p),s.push(p);else this.logService.trace("app#resolveInitialProtocolUrls() protocol url will be passed to active window for handling:",d.uri.toString(!0)),a.push(d)}return{urls:a,openables:s}}async shouldBlockOpenable(i,t,n){let e,r;if(ai(i)?(e=i.workspaceUri,r=I("confirmOpenMessageWorkspace","An external application wants to open '{0}' in {1}. Do you want to open this workspace file?",e.scheme===u.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):si(i)?(e=i.folderUri,r=I("confirmOpenMessageFolder","An external application wants to open '{0}' in {1}. Do you want to open this folder?",e.scheme===u.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)):(e=i.fileUri,r=I("confirmOpenMessageFileOrFolder","An external application wants to open '{0}' in {1}. Do you want to open this file or folder?",e.scheme===u.file?H(e,{os:D,tildify:this.environmentMainService}):e.toString(!0),this.productService.nameShort)),e.scheme!==u.file&&e.scheme!==u.vscodeRemote||this.configurationService.getValue(b.SECURITY_PROTOCOL_HANDLING_CONFIRMATION_SETTING_KEY[e.scheme])===!1)return!1;const{response:a,checkboxChecked:d}=await n.showMessageBox({type:"warning",buttons:[I({key:"open",comment:["&& denotes a mnemonic"]},"&&Yes"),I({key:"cancel",comment:["&& denotes a mnemonic"]},"&&No")],message:r,detail:I("confirmOpenDetail","If you did not initiate this request, it may represent an attempted attack on your system. Unless you took an explicit action to initiate this request, you should press 'No'"),checkboxLabel:e.scheme===u.file?I("doNotAskAgainLocal","Allow opening local paths without asking"):I("doNotAskAgainRemote","Allow opening remote paths without asking"),cancelId:1});if(a!==0)return!0;if(d){const p={channel:"vscode:disablePromptForProtocolHandling",args:e.scheme===u.file?"local":"remote"};t.sendToFocused(p.channel,p.args),t.sendToOpeningWindow(p.channel,p.args)}return!1}getWindowOpenableFromProtocolUrl(i){if(i.path){if(i.authority===u.file){const t=w.file(i.fsPath);return N(t)?{workspaceUri:t}:{fileUri:t}}else if(i.authority===u.vscodeRemote){const t=i.path.indexOf(Ke.sep,1);let n,e;t!==-1?(n=i.path.substring(1,t),e=i.path.substring(t)):(n=i.path.substring(1),e="/");let r=i.query;const s=new URLSearchParams(i.query);s.get("windowId")==="_blank"&&(s.delete("windowId"),r=s.toString());const a=w.from({scheme:u.vscodeRemote,authority:n,path:e,query:r,fragment:i.fragment});return N(e)?{workspaceUri:a}:/:[\d]+$/.test(e)?{fileUri:a}:{folderUri:a}}}}async handleProtocolUrl(i,t,n,e,r){this.logService.trace("app#handleProtocolUrl():",e.toString(!0),r),e.scheme===this.productService.urlProtocol&&e.path==="workspace"&&(e=e.with({authority:"file",path:w.parse(e.query).path,query:""}));let s=!1;const a=new URLSearchParams(e.query);a.get("windowId")==="_blank"?(this.logService.trace("app#handleProtocolUrl() found 'windowId=_blank' as parameter, setting shouldOpenInNewWindow=true:",e.toString(!0)),a.delete("windowId"),e=e.with({query:a.toString()}),s=!0):x&&i.getWindowCount()===0&&(this.logService.trace("app#handleProtocolUrl() running on macOS with no window open, setting shouldOpenInNewWindow=true:",e.toString(!0)),s=!0);const d=a.get("continueOn");d!==null&&(this.logService.trace("app#handleProtocolUrl() found 'continueOn' as parameter:",e.toString(!0)),a.delete("continueOn"),e=e.with({query:a.toString()}),this.environmentMainService.continueOn=d??void 0);const p=this.getWindowOpenableFromProtocolUrl(e);return p?await this.shouldBlockOpenable(p,i,t)?(this.logService.trace("app#handleProtocolUrl() protocol url was blocked:",e.toString(!0)),!0):(this.logService.trace("app#handleProtocolUrl() opening protocol url as window:",p,e.toString(!0)),(await i.open({context:C.LINK,cli:{...this.environmentMainService.args},urisToOpen:[p],forceNewWindow:s,gotoLineMode:!0})).at(0)?.focus(),!0):s?(this.logService.trace("app#handleProtocolUrl() opening empty window and passing in protocol url:",e.toString(!0)),await(await i.open({context:C.LINK,cli:{...this.environmentMainService.args},forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,remoteAuthority:Tr(e)})).at(0)?.ready(),n.open(e,r)):(this.logService.trace("app#handleProtocolUrl(): not handled",e.toString(!0),r),!1)}setupSharedProcess(i,t,n){const e=this._register(this.mainInstantiationService.createInstance(Fr,i,t,n));this._register(e.onDidCrash(()=>this.windowsMainService?.sendToFocused("vscode:reportSharedProcessCrash")));const r=(async()=>{this.logService.trace("Main->SharedProcess#connect");const a=await e.connect();return this.logService.trace("Main->SharedProcess#connect: connection established"),new Xe(a,"main")})();return{sharedProcessReady:(async()=>(await e.whenReady(),r))(),sharedProcessClient:r}}async initServices(i,t,n,e){const r=new Mr;switch(process.platform){case"win32":r.set(O,new v(ei));break;case"linux":Ye?r.set(O,new v(Xr,[process.env.SNAP,process.env.SNAP_REVISION])):r.set(O,new v(Qr));break;case"darwin":r.set(O,new v(Zr));break}r.set(k,new v(ci,[i,t,n,this.userEnv],!1)),r.set(Se,new v(qi,void 0,!1));const s=new ar(this.logService,this.productService);r.set(ie,s),r.set(le,new v(Rr,void 0,!1)),r.set(re,new v(sr,void 0,!1)),r.set(or,f.toService(X(e.then(o=>o.getChannel("diagnostics"))))),r.set(ae,new v(Ir,[this.userEnv])),r.set(se,new v(Cr,[this.userEnv])),r.set(te,new v(cr)),r.set(ce,new v(Pr)),r.set(q,new v(Er,void 0,!1)),r.set(pe,new v(oi)),r.set(de,new v(Lr)),r.set(ne,new v(mr)),r.set(B,new v(_r)),r.set(Dr,new v(Hr));const a=new ki({graceTime:fe.GraceTime,shortGraceTime:fe.ShortGraceTime,scrollback:this.configurationService.getValue(Fi.PersistentSessionScrollback)??100},this.configurationService,this.environmentMainService,this.lifecycleMainService,this.logService),d=new Ni(a,this.configurationService,this.logService,this.loggerService);r.set(he,d),T?r.set(F,new v(fr)):x?r.set(F,new v(hr)):Ge&&r.set(F,new v(ur));const p=new ir(this.environmentMainService,this.configurationService,this.logService,this.stateService);r.set(rr,p);const S=new ui(this.environmentMainService,this.logService,this.userDataProfilesMainService,p,s);if(r.set(mi,S),r.set(me,new v(pi,void 0,!1)),r.set(di,new v(vi,void 0,!1)),r.set($,new v(ti,void 0,!1)),jr(this.productService,this.environmentMainService)){const o=Yr(this.productService,this.configurationService),c=X(e.then(E=>E.getChannel("telemetryAppender"))),l=new $r(c),m=qr(Ae(),Ne(),process.arch,this.productService.commit,this.productService.version,i,t,n,o),h=Kr(this.environmentMainService),M={appenders:[l],commonProperties:m,piiPaths:h,sendErrorTelemetry:!0};r.set(ve,new v(Vr,[M],!1))}else r.set(ve,zr);return r.set(Si,new v(Wi,void 0,!0)),r.set(gi,new v(wi,void 0,!0)),r.set(ue,new v(Ei,void 0,!0)),r.set(ee,new v(er)),r.set(Bi,new v($i,void 0,!0)),this.productService.quality!=="stable"&&r.set(we,new v(Vi,void 0,!0)),await Ii.settled([p.initialize(),S.initialize()]),this.mainInstantiationService.createChild(r)}initChannels(i,t,n){const e=this._register(new $e),r=f.fromService(i.get(le),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("launch",r);const s=f.fromService(i.get(re),e,{disableMarshalling:!0});this.mainProcessNodeIpcServer.registerChannel("diagnostics",s);const a=e.add(new fi(i.get(hi)));t.registerChannel("policy",a),n.then(g=>g.registerChannel("policy",a));const d=this.fileService.getProvider(u.file);ze(d instanceof wr);const p=e.add(new gr(d,this.logService,this.environmentMainService));t.registerChannel(oe,p),n.then(g=>g.registerChannel(oe,p));const S=f.fromService(i.get(V),e);if(t.registerChannel("userDataProfiles",S),n.then(g=>g.registerChannel("userDataProfiles",S)),this.productService.quality!=="stable"){const g=i.get(we);n.then(Le=>Le.registerChannel("signatureVerificationService",f.fromService(g,e)))}const o=new Jr(i.get(O));t.registerChannel("update",o);const c=f.fromService(i.get(ae),e);t.registerChannel("issue",c);const l=f.fromService(i.get(se),e);t.registerChannel("process",l);const m=f.fromService(i.get(te),e);t.registerChannel("encryption",m);const h=f.fromService(i.get(kr),e);t.registerChannel("sign",h);const M=f.fromService(i.get(ce),e);t.registerChannel("keyboardLayout",M),this.nativeHostMainService=i.get(q);const E=f.fromService(this.nativeHostMainService,e);t.registerChannel("nativeHost",E),n.then(g=>g.registerChannel("nativeHost",E));const ye=f.fromService(i.get(me),e);t.registerChannel("workspaces",ye);const Me=f.fromService(i.get(de),e);t.registerChannel("menubar",Me);const Ie=f.fromService(i.get($),e);t.registerChannel("url",Ie);const Ce=f.fromService(i.get(pe),e);t.registerChannel("webview",Ce);const K=e.add(new Ar(this.logService,i.get(B)));t.registerChannel("storage",K),n.then(g=>g.registerChannel("storage",K));const Pe=e.add(new Mi(i.get(B),i.get(V),this.logService));n.then(g=>g.registerChannel("profileStorageListener",Pe));const Re=f.fromService(i.get(he),e);t.registerChannel(Ti.LocalPty,Re);const Ue=f.fromService(i.get(F),e);t.registerChannel("externalTerminal",Ue);const G=new Oi(i.get(Li));t.registerChannel("logger",G),n.then(g=>g.registerChannel("logger",G));const be=new nr(i.get(k));t.registerChannel("extensionhostdebugservice",be);const We=f.fromService(i.get(ne),e);t.registerChannel(pr,We);const Oe=f.fromService(i.get(ue),e);t.registerChannel(xi,Oe)}async openFirstWindow(i,t){const n=this.windowsMainService=i.get(k);this.auxiliaryWindowsMainService=i.get(Se);const e=dr(process.env)?C.CLI:C.DESKTOP,r=this.environmentMainService.args;if(t){if(t.openables.length>0)return n.open({context:e,cli:r,urisToOpen:t.openables,gotoLineMode:!0,initialStartup:!0});if(t.urls.length>0)for(const h of t.urls){const M=new URLSearchParams(h.uri.query);if(M.get("windowId")==="_blank")return M.delete("windowId"),h.originalUrl=h.uri.toString(!0),h.uri=h.uri.with({query:M.toString()}),n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,gotoLineMode:!0,initialStartup:!0})}}const s=global.macOpenFiles,a=r._.length,d=!!r["folder-uri"],p=!!r["file-uri"],S=r["skip-add-to-recently-opened"]===!0,o=r.wait&&r.waitMarkerFilePath?w.file(r.waitMarkerFilePath):void 0,c=r.remote||void 0,l=r.profile,m=r["profile-temp"];if(!a&&!d&&!p){if(r["new-window"]||l||m)return n.open({context:e,cli:r,forceNewWindow:!0,forceEmpty:!0,noRecentEntry:S,waitMarkerFileURI:o,initialStartup:!0,remoteAuthority:c,forceProfile:l,forceTempProfile:m});if(s.length)return n.open({context:C.DOCK,cli:r,urisToOpen:s.map(h=>(h=ge(h),N(h)?{workspaceUri:w.file(h)}:{fileUri:w.file(h)})),noRecentEntry:S,waitMarkerFileURI:o,initialStartup:!0})}return n.open({context:e,cli:r,forceNewWindow:r["new-window"],diffMode:r.diff,mergeMode:r.merge,noRecentEntry:S,waitMarkerFileURI:o,gotoLineMode:r.goto,initialStartup:!0,remoteAuthority:c,forceProfile:l,forceTempProfile:m})}afterWindowOpen(){this.installMutex(),z.registerHttpProtocol(u.vscodeRemoteResource,(i,t)=>{t({url:i.url.replace(/^vscode-remote-resource:/,"http:"),method:i.method})}),this.resolveShellEnvironment(this.environmentMainService.args,process.env,!0),this.updateCrashReporterEnablement(),x&&R.runningUnderARM64Translation&&this.windowsMainService?.sendToFocused("vscode:showTranslatedBuildWarning")}async installMutex(){const i=this.productService.win32MutexName;if(T&&i)try{const t=await import("@vscode/windows-mutex"),n=new t.Mutex(i);A.once(this.lifecycleMainService.onWillShutdown)(()=>n.release())}catch(t){this.logService.error(t)}}async resolveShellEnvironment(i,t,n){try{return await vr(this.configurationService,this.logService,i,t)}catch(e){const r=He(e);n?this.windowsMainService?.sendToFocused("vscode:showResolveShellEnvError",r):this.logService.error(r)}return{}}async updateCrashReporterEnablement(){try{const t=(await this.fileService.readFile(this.environmentMainService.argvResource)).value.toString(),n=qe(t),r=Gr(this.configurationService)>=Br.CRASH;if(n["enable-crash-reporter"]===void 0){const s=["","	// Allows to disable crash reporting.","	// Should restart the app if the value is changed.",`	"enable-crash-reporter": ${r},`,"","	// Unique id used for correlating crash reports sent from this instance.","	// Do not edit this value.",`	"crash-reporter-id": "${je()}"`,"}"],a=t.substring(0,t.length-2).concat(`,
`,s.join(`
`));await this.fileService.writeFile(this.environmentMainService.argvResource,J.fromString(a))}else{const s=t.replace(/"enable-crash-reporter": .*,/,`"enable-crash-reporter": ${r},`);s!==t&&await this.fileService.writeFile(this.environmentMainService.argvResource,J.fromString(s))}}catch(i){this.logService.error(i),this.windowsMainService?.sendToFocused("vscode:showArgvParseWarning")}}};b=Y([y(2,yr),y(3,Or),y(4,Wr),y(5,lr),y(6,Ur),y(7,tr),y(8,Nr),y(9,Sr),y(10,xr),y(11,V)],b);export{b as CodeApplication};
