var G=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var k=(m,c,e,t)=>{for(var i=t>1?void 0:t?ee(c,e):c,n=m.length-1,l;n>=0;n--)(l=m[n])&&(i=(t?l(c,e,i):l(i))||i);return t&&i&&G(c,e,i),i},N=(m,c)=>(e,t)=>c(e,t,m);import"./textAreaEditContext.css";import*as te from"../../../../../nls.js";import*as A from"../../../../../base/browser/browser.js";import{createFastDomNode as D}from"../../../../../base/browser/fastDomNode.js";import"../../../../../base/browser/keyboardEvent.js";import*as L from"../../../../../base/common/platform.js";import*as ie from"../../../../../base/common/strings.js";import{applyFontInfo as z}from"../../../config/domFontInfo.js";import"../../../view/viewController.js";import{PartFingerprint as oe,PartFingerprints as ne}from"../../../view/viewPart.js";import{LineNumbersOverlay as re}from"../../../viewParts/lineNumbers/lineNumbers.js";import{Margin as se}from"../../../viewParts/margin/margin.js";import{RenderLineNumbersType as ae,EditorOption as s,EditorOptions as le}from"../../../../common/config/editorOptions.js";import"../../../../common/config/fontInfo.js";import{Position as R}from"../../../../common/core/position.js";import{Range as O}from"../../../../common/core/range.js";import{Selection as B}from"../../../../common/core/selection.js";import{ScrollType as he}from"../../../../common/editorCommon.js";import{EndOfLinePreference as $}from"../../../../common/model.js";import"../../../view/renderingContext.js";import"../../../../common/viewModel/viewContext.js";import*as ce from"../../../../common/viewEvents.js";import{AccessibilitySupport as P}from"../../../../../platform/accessibility/common/accessibility.js";import"../../../editorBrowser.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME as W}from"../../../../../base/browser/ui/mouseCursor/mouseCursor.js";import{TokenizationRegistry as de}from"../../../../common/languages.js";import{ColorId as ue}from"../../../../common/encodedTokenAttributes.js";import{Color as pe}from"../../../../../base/common/color.js";import{IME as K}from"../../../../../base/common/ime.js";import{IKeybindingService as fe}from"../../../../../platform/keybinding/common/keybinding.js";import{IInstantiationService as me}from"../../../../../platform/instantiation/common/instantiation.js";import{AbstractEditContext as ge}from"../editContext.js";import{TextAreaInput as be,TextAreaWrapper as _e}from"./textAreaEditContextInput.js";import{ariaLabelForScreenReaderContent as U,newlinecount as q,PagedScreenReaderStrategy as xe}from"../screenReaderUtils.js";import{getDataToCopy as ve}from"../clipboardUtils.js";import{_debugComposition as Z,TextAreaState as C}from"./textAreaEditContextState.js";import{getMapForWordSeparators as Y,WordCharacterClass as V}from"../../../../common/core/wordCharacterClassifier.js";class Ae{constructor(c,e,t,i,n){this._context=c;this.modelLineNumber=e;this.distanceToModelLineStart=t;this.widthOfHiddenLineTextBefore=i;this.distanceToModelLineEnd=n}_visibleTextAreaBrand=void 0;startPosition=null;endPosition=null;visibleTextareaStart=null;visibleTextareaEnd=null;_previousPresentation=null;prepareRender(c){const e=new R(this.modelLineNumber,this.distanceToModelLineStart+1),t=new R(this.modelLineNumber,this._context.viewModel.model.getLineMaxColumn(this.modelLineNumber)-this.distanceToModelLineEnd);this.startPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(e),this.endPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(t),this.startPosition.lineNumber===this.endPosition.lineNumber?(this.visibleTextareaStart=c.visibleRangeForPosition(this.startPosition),this.visibleTextareaEnd=c.visibleRangeForPosition(this.endPosition)):(this.visibleTextareaStart=null,this.visibleTextareaEnd=null)}definePresentation(c){return this._previousPresentation||(c?this._previousPresentation=c:this._previousPresentation={foreground:ue.DefaultForeground,italic:!1,bold:!1,underline:!1,strikethrough:!1}),this._previousPresentation}}const H=A.isFirefox;let M=class extends ge{constructor(e,t,i,n,l,f){super(e);this._keybindingService=l;this._instantiationService=f;this._viewController=i,this._visibleRangeProvider=n,this._scrollLeft=0,this._scrollTop=0;const h=this._context.configuration.options,g=h.get(s.layoutInfo);this._setAccessibilityOptions(h),this._contentLeft=g.contentLeft,this._contentWidth=g.contentWidth,this._contentHeight=g.height,this._fontInfo=h.get(s.fontInfo),this._lineHeight=h.get(s.lineHeight),this._emptySelectionClipboard=h.get(s.emptySelectionClipboard),this._copyWithSyntaxHighlighting=h.get(s.copyWithSyntaxHighlighting),this._visibleTextArea=null,this._selections=[new B(1,1,1,1)],this._modelSelections=[new B(1,1,1,1)],this._lastRenderPosition=null,this.textArea=D(document.createElement("textarea")),ne.write(this.textArea,oe.TextArea),this.textArea.setClassName(`inputarea ${W}`),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:x}=this._context.viewModel.model.getOptions();this.textArea.domNode.style.tabSize=`${x*this._fontInfo.spaceWidth}px`,this.textArea.setAttribute("autocorrect","off"),this.textArea.setAttribute("autocapitalize","off"),this.textArea.setAttribute("autocomplete","off"),this.textArea.setAttribute("spellcheck","false"),this.textArea.setAttribute("aria-label",U(h,this._keybindingService)),this.textArea.setAttribute("aria-required",h.get(s.ariaRequired)?"true":"false"),this.textArea.setAttribute("tabindex",String(h.get(s.tabIndex))),this.textArea.setAttribute("role","textbox"),this.textArea.setAttribute("aria-roledescription",te.localize("editor","editor")),this.textArea.setAttribute("aria-multiline","true"),this.textArea.setAttribute("aria-autocomplete",h.get(s.readOnly)?"none":"both"),this._ensureReadOnlyAttribute(),this.textAreaCover=D(document.createElement("div")),this.textAreaCover.setPosition("absolute"),t.appendChild(this.textArea),t.appendChild(this.textAreaCover);const p={getLineCount:()=>this._context.viewModel.getLineCount(),getLineMaxColumn:o=>this._context.viewModel.getLineMaxColumn(o),getValueInRange:(o,r)=>this._context.viewModel.getValueInRange(o,r),getValueLengthInRange:(o,r)=>this._context.viewModel.getValueLengthInRange(o,r),modifyPosition:(o,r)=>this._context.viewModel.modifyPosition(o,r)},b={getDataToCopy:()=>ve(this._context.viewModel,this._modelSelections,this._emptySelectionClipboard,this._copyWithSyntaxHighlighting),getScreenReaderContent:()=>{if(this._accessibilitySupport===P.Disabled){const r=this._selections[0];if(L.isMacintosh&&r.isEmpty()){const a=r.getStartPosition();let d=this._getWordBeforePosition(a);if(d.length===0&&(d=this._getCharacterBeforePosition(a)),d.length>0)return new C(d,d.length,d.length,O.fromPositions(a),0)}if(L.isMacintosh&&!r.isEmpty()&&p.getValueLengthInRange(r,$.TextDefined)<500){const a=p.getValueInRange(r,$.TextDefined);return new C(a,0,a.length,r,0)}if(A.isSafari&&!r.isEmpty()){const a="vscode-placeholder";return new C(a,0,a.length,null,void 0)}return C.EMPTY}if(A.isAndroid){const r=this._selections[0];if(r.isEmpty()){const u=r.getStartPosition(),[a,d]=this._getAndroidWordAtPosition(u);if(a.length>0)return new C(a,d,d,O.fromPositions(u),0)}return C.EMPTY}const o=xe.fromEditorSelection(p,this._selections[0],this._accessibilityPageSize,this._accessibilitySupport===P.Unknown);return C.fromScreenReaderContentState(o)},deduceModelPosition:(o,r,u)=>this._context.viewModel.deduceModelPositionRelativeToViewPosition(o,r,u)},y=this._register(new _e(this.textArea.domNode));this._textAreaInput=this._register(this._instantiationService.createInstance(be,b,y,L.OS,{isAndroid:A.isAndroid,isChrome:A.isChrome,isFirefox:A.isFirefox,isSafari:A.isSafari})),this._register(this._textAreaInput.onKeyDown(o=>{this._viewController.emitKeyDown(o)})),this._register(this._textAreaInput.onKeyUp(o=>{this._viewController.emitKeyUp(o)})),this._register(this._textAreaInput.onPaste(o=>{let r=!1,u=null,a=null;o.metadata&&(r=this._emptySelectionClipboard&&!!o.metadata.isFromEmptySelection,u=typeof o.metadata.multicursorText<"u"?o.metadata.multicursorText:null,a=o.metadata.mode),this._viewController.paste(o.text,r,u,a)})),this._register(this._textAreaInput.onCut(()=>{this._viewController.cut()})),this._register(this._textAreaInput.onType(o=>{o.replacePrevCharCnt||o.replaceNextCharCnt||o.positionDelta?this._viewController.compositionType(o.text,o.replacePrevCharCnt,o.replaceNextCharCnt,o.positionDelta):this._viewController.type(o.text)})),this._register(this._textAreaInput.onSelectionChangeRequest(o=>{this._viewController.setSelection(o)})),this._register(this._textAreaInput.onCompositionStart(o=>{const r=this.textArea.domNode,u=this._modelSelections[0],{distanceToModelLineStart:a,widthOfHiddenTextBefore:d}=(()=>{const S=r.value.substring(0,Math.min(r.selectionStart,r.selectionEnd)),w=S.lastIndexOf(`
`),_=S.substring(w+1),T=_.lastIndexOf("	"),E=_.length-T-1,v=u.getStartPosition(),I=Math.min(v.column-1,E),F=v.column-1-I,j=_.substring(0,_.length-I),{tabSize:J}=this._context.viewModel.model.getOptions(),Q=Ce(this.textArea.domNode.ownerDocument,j,this._fontInfo,J);return{distanceToModelLineStart:F,widthOfHiddenTextBefore:Q}})(),{distanceToModelLineEnd:X}=(()=>{const S=r.value.substring(Math.max(r.selectionStart,r.selectionEnd)),w=S.indexOf(`
`),_=w===-1?S:S.substring(0,w),T=_.indexOf("	"),E=T===-1?_.length:_.length-T-1,v=u.getEndPosition(),I=Math.min(this._context.viewModel.model.getLineMaxColumn(v.lineNumber)-v.column,E);return{distanceToModelLineEnd:this._context.viewModel.model.getLineMaxColumn(v.lineNumber)-v.column-I}})();this._context.viewModel.revealRange("keyboard",!0,O.fromPositions(this._selections[0].getStartPosition()),ce.VerticalRevealType.Simple,he.Immediate),this._visibleTextArea=new Ae(this._context,u.startLineNumber,a,d,X),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render(),this.textArea.setClassName(`inputarea ${W} ime-input`),this._viewController.compositionStart(),this._context.viewModel.onCompositionStart()})),this._register(this._textAreaInput.onCompositionUpdate(o=>{this._visibleTextArea&&(this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render())})),this._register(this._textAreaInput.onCompositionEnd(()=>{this._visibleTextArea=null,this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._render(),this.textArea.setClassName(`inputarea ${W}`),this._viewController.compositionEnd(),this._context.viewModel.onCompositionEnd()})),this._register(this._textAreaInput.onFocus(()=>{this._context.viewModel.setHasFocus(!0)})),this._register(this._textAreaInput.onBlur(()=>{this._context.viewModel.setHasFocus(!1)})),this._register(K.onDidChange(()=>{this._ensureReadOnlyAttribute()}))}_viewController;_visibleRangeProvider;_scrollLeft;_scrollTop;_accessibilitySupport;_accessibilityPageSize;_textAreaWrapping;_textAreaWidth;_contentLeft;_contentWidth;_contentHeight;_fontInfo;_lineHeight;_emptySelectionClipboard;_copyWithSyntaxHighlighting;_visibleTextArea;_selections;_modelSelections;_lastRenderPosition;textArea;textAreaCover;_textAreaInput;get domNode(){return this.textArea}writeScreenReaderContent(e){this._textAreaInput.writeNativeTextAreaContent(e)}dispose(){super.dispose(),this.textArea.domNode.remove(),this.textAreaCover.domNode.remove()}_getAndroidWordAtPosition(e){const t='`~!@#$%^&*()-=+[{]}\\|;:",.<>/?',i=this._context.viewModel.getLineContent(e.lineNumber),n=Y(t,[]);let l=!0,f=e.column,h=!0,g=e.column,x=0;for(;x<50&&(l||h);){if(l&&f<=1&&(l=!1),l){const p=i.charCodeAt(f-2);n.get(p)!==V.Regular?l=!1:f--}if(h&&g>i.length&&(h=!1),h){const p=i.charCodeAt(g-1);n.get(p)!==V.Regular?h=!1:g++}x++}return[i.substring(f-1,g-1),e.column-f]}_getWordBeforePosition(e){const t=this._context.viewModel.getLineContent(e.lineNumber),i=Y(this._context.configuration.options.get(s.wordSeparators),[]);let n=e.column,l=0;for(;n>1;){const f=t.charCodeAt(n-2);if(i.get(f)!==V.Regular||l>50)return t.substring(n-1,e.column-1);l++,n--}return t.substring(0,e.column-1)}_getCharacterBeforePosition(e){if(e.column>1){const i=this._context.viewModel.getLineContent(e.lineNumber).charAt(e.column-2);if(!ie.isHighSurrogate(i.charCodeAt(0)))return i}return""}_setAccessibilityOptions(e){this._accessibilitySupport=e.get(s.accessibilitySupport);const t=e.get(s.accessibilityPageSize);this._accessibilitySupport===P.Enabled&&t===le.accessibilityPageSize.defaultValue?this._accessibilityPageSize=500:this._accessibilityPageSize=t;const n=e.get(s.layoutInfo).wrappingColumn;if(n!==-1&&this._accessibilitySupport!==P.Disabled){const l=e.get(s.fontInfo);this._textAreaWrapping=!0,this._textAreaWidth=Math.round(n*l.typicalHalfwidthCharacterWidth)}else this._textAreaWrapping=!1,this._textAreaWidth=H?0:1}onConfigurationChanged(e){const t=this._context.configuration.options,i=t.get(s.layoutInfo);this._setAccessibilityOptions(t),this._contentLeft=i.contentLeft,this._contentWidth=i.contentWidth,this._contentHeight=i.height,this._fontInfo=t.get(s.fontInfo),this._lineHeight=t.get(s.lineHeight),this._emptySelectionClipboard=t.get(s.emptySelectionClipboard),this._copyWithSyntaxHighlighting=t.get(s.copyWithSyntaxHighlighting),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:n}=this._context.viewModel.model.getOptions();return this.textArea.domNode.style.tabSize=`${n*this._fontInfo.spaceWidth}px`,this.textArea.setAttribute("aria-label",U(t,this._keybindingService)),this.textArea.setAttribute("aria-required",t.get(s.ariaRequired)?"true":"false"),this.textArea.setAttribute("tabindex",String(t.get(s.tabIndex))),(e.hasChanged(s.domReadOnly)||e.hasChanged(s.readOnly))&&this._ensureReadOnlyAttribute(),e.hasChanged(s.accessibilitySupport)&&this._textAreaInput.writeNativeTextAreaContent("strategy changed"),!0}onCursorStateChanged(e){return this._selections=e.selections.slice(0),this._modelSelections=e.modelSelections.slice(0),this._textAreaInput.writeNativeTextAreaContent("selection changed"),!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return this._scrollLeft=e.scrollLeft,this._scrollTop=e.scrollTop,!0}onZonesChanged(e){return!0}isFocused(){return this._textAreaInput.isFocused()}focus(){this._textAreaInput.focusTextArea()}refreshFocusState(){this._textAreaInput.refreshFocusState()}getLastRenderData(){return this._lastRenderPosition}setAriaOptions(e){e.activeDescendant?(this.textArea.setAttribute("aria-haspopup","true"),this.textArea.setAttribute("aria-autocomplete","list"),this.textArea.setAttribute("aria-activedescendant",e.activeDescendant)):(this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),this.textArea.removeAttribute("aria-activedescendant")),e.role&&this.textArea.setAttribute("role",e.role)}_ensureReadOnlyAttribute(){const e=this._context.configuration.options;!K.enabled||e.get(s.domReadOnly)&&e.get(s.readOnly)?this.textArea.setAttribute("readonly","true"):this.textArea.removeAttribute("readonly")}_primaryCursorPosition=new R(1,1);_primaryCursorVisibleRange=null;prepareRender(e){this._primaryCursorPosition=new R(this._selections[0].positionLineNumber,this._selections[0].positionColumn),this._primaryCursorVisibleRange=e.visibleRangeForPosition(this._primaryCursorPosition),this._visibleTextArea?.prepareRender(e)}render(e){this._textAreaInput.writeNativeTextAreaContent("render"),this._render()}_render(){if(this._visibleTextArea){const i=this._visibleTextArea.visibleTextareaStart,n=this._visibleTextArea.visibleTextareaEnd,l=this._visibleTextArea.startPosition,f=this._visibleTextArea.endPosition;if(l&&f&&i&&n&&n.left>=this._scrollLeft&&i.left<=this._scrollLeft+this._contentWidth){const h=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primaryCursorPosition.lineNumber)-this._scrollTop,g=q(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));let x=this._visibleTextArea.widthOfHiddenLineTextBefore,p=this._contentLeft+i.left-this._scrollLeft,b=n.left-i.left+1;if(p<this._contentLeft){const d=this._contentLeft-p;p+=d,x+=d,b-=d}b>this._contentWidth&&(b=this._contentWidth);const y=this._context.viewModel.getViewLineData(l.lineNumber),o=y.tokens.findTokenIndexAtOffset(l.column-1),r=y.tokens.findTokenIndexAtOffset(f.column-1),u=o===r,a=this._visibleTextArea.definePresentation(u?y.tokens.getPresentation(o):null);this.textArea.domNode.scrollTop=g*this._lineHeight,this.textArea.domNode.scrollLeft=x,this._doRender({lastRenderPosition:null,top:h,left:p,width:b,height:this._lineHeight,useCover:!1,color:(de.getColorMap()||[])[a.foreground],italic:a.italic,bold:a.bold,underline:a.underline,strikethrough:a.strikethrough})}return}if(!this._primaryCursorVisibleRange){this._renderAtTopLeft();return}const e=this._contentLeft+this._primaryCursorVisibleRange.left-this._scrollLeft;if(e<this._contentLeft||e>this._contentLeft+this._contentWidth){this._renderAtTopLeft();return}const t=this._context.viewLayout.getVerticalOffsetForLineNumber(this._selections[0].positionLineNumber)-this._scrollTop;if(t<0||t>this._contentHeight){this._renderAtTopLeft();return}if(L.isMacintosh||this._accessibilitySupport===P.Enabled){this._doRender({lastRenderPosition:this._primaryCursorPosition,top:t,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:this._lineHeight,useCover:!1}),this.textArea.domNode.scrollLeft=this._primaryCursorVisibleRange.left;const i=this._textAreaInput.textAreaState.newlineCountBeforeSelection??q(this.textArea.domNode.value.substring(0,this.textArea.domNode.selectionStart));this.textArea.domNode.scrollTop=i*this._lineHeight;return}this._doRender({lastRenderPosition:this._primaryCursorPosition,top:t,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:H?0:1,useCover:!1})}_renderAtTopLeft(){this._doRender({lastRenderPosition:null,top:0,left:0,width:this._textAreaWidth,height:H?0:1,useCover:!0})}_doRender(e){this._lastRenderPosition=e.lastRenderPosition;const t=this.textArea,i=this.textAreaCover;z(t,this._fontInfo),t.setTop(e.top),t.setLeft(e.left),t.setWidth(e.width),t.setHeight(e.height),t.setColor(e.color?pe.Format.CSS.formatHex(e.color):""),t.setFontStyle(e.italic?"italic":""),e.bold&&t.setFontWeight("bold"),t.setTextDecoration(`${e.underline?" underline":""}${e.strikethrough?" line-through":""}`),i.setTop(e.useCover?e.top:0),i.setLeft(e.useCover?e.left:0),i.setWidth(e.useCover?e.width:0),i.setHeight(e.useCover?e.height:0);const n=this._context.configuration.options;n.get(s.glyphMargin)?i.setClassName("monaco-editor-background textAreaCover "+se.OUTER_CLASS_NAME):n.get(s.lineNumbers).renderType!==ae.Off?i.setClassName("monaco-editor-background textAreaCover "+re.CLASS_NAME):i.setClassName("monaco-editor-background textAreaCover")}};M=k([N(4,fe),N(5,me)],M);function Ce(m,c,e,t){if(c.length===0)return 0;const i=m.createElement("div");i.style.position="absolute",i.style.top="-50000px",i.style.width="50000px";const n=m.createElement("span");z(n,e),n.style.whiteSpace="pre",n.style.tabSize=`${t*e.spaceWidth}px`,n.append(c),i.appendChild(n),m.body.appendChild(i);const l=n.offsetWidth;return i.remove(),l}export{M as TextAreaEditContext};
