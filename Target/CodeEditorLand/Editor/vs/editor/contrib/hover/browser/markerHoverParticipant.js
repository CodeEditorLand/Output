var N=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var H=(v,e,o,n)=>{for(var r=n>1?void 0:n?R(e,o):e,i=v.length-1,a;i>=0;i--)(a=v[i])&&(r=(n?a(e,o,r):a(r))||r);return n&&r&&N(e,o,r),r},h=(v,e)=>(o,n)=>e(o,n,v);import*as s from"../../../../base/browser/dom.js";import{isNonEmptyArray as O}from"../../../../base/common/arrays.js";import{createCancelablePromise as $,disposableTimeout as q}from"../../../../base/common/async.js";import{onUnexpectedError as x}from"../../../../base/common/errors.js";import{Disposable as Q,DisposableStore as S,toDisposable as E}from"../../../../base/common/lifecycle.js";import{basename as z}from"../../../../base/common/resources.js";import"../../../browser/editorBrowser.js";import{EditorOption as B}from"../../../common/config/editorOptions.js";import{Range as P}from"../../../common/core/range.js";import{CodeActionTriggerType as K}from"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeaturesService as U}from"../../../common/services/languageFeatures.js";import{IMarkerDecorationsService as V}from"../../../common/services/markerDecorations.js";import{ApplyCodeActionReason as G,getCodeActions as W,quickFixCommandId as j}from"../../codeAction/browser/codeAction.js";import{CodeActionController as _}from"../../codeAction/browser/codeActionController.js";import{CodeActionKind as J,CodeActionTriggerSource as X}from"../../codeAction/common/types.js";import{MarkerController as Y,NextMarkerAction as Z}from"../../gotoError/browser/gotoError.js";import{HoverAnchorType as w,RenderedHoverParts as D}from"./hoverTypes.js";import*as k from"../../../../nls.js";import"../../../../platform/editor/common/editor.js";import{IMarkerData as T,MarkerSeverity as A}from"../../../../platform/markers/common/markers.js";import{IOpenerService as ee}from"../../../../platform/opener/common/opener.js";import{Progress as re}from"../../../../platform/progress/common/progress.js";const c=s.$;class oe{constructor(e,o,n){this.owner=e;this.range=o;this.marker=n}isValidForHoverAnchor(e){return e.type===w.Range&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}const F={type:K.Invoke,filter:{include:J.QuickFix},triggerAction:X.QuickFixHover};let I=class{constructor(e,o,n,r){this._editor=e;this._markerDecorationsService=o;this._openerService=n;this._languageFeaturesService=r}hoverOrdinal=1;recentMarkerCodeActionsInfo=void 0;computeSync(e,o){if(!this._editor.hasModel()||e.type!==w.Range&&!e.supportsMarkerHover)return[];const n=this._editor.getModel(),r=e.range.startLineNumber,i=n.getLineMaxColumn(r),a=[];for(const t of o){const f=t.range.startLineNumber===r?t.range.startColumn:1,p=t.range.endLineNumber===r?t.range.endColumn:i,m=this._markerDecorationsService.getMarker(n.uri,t);if(!m)continue;const d=new P(e.range.startLineNumber,f,e.range.startLineNumber,p);a.push(new oe(this,d,m))}return a}renderHoverParts(e,o){if(!o.length)return new D([]);const n=new S,r=[];o.forEach(a=>{const t=this._renderMarkerHover(a);e.fragment.appendChild(t.hoverElement),r.push(t)});const i=o.length===1?o[0]:o.sort((a,t)=>A.compare(a.marker.severity,t.marker.severity))[0];return this.renderMarkerStatusbar(e,i,n),new D(r)}getAccessibleContent(e){return e.marker.message}_renderMarkerHover(e){const o=new S,n=c("div.hover-row"),r=s.append(n,c("div.marker.hover-contents")),{source:i,message:a,code:t,relatedInformation:f}=e.marker;this._editor.applyFontInfo(r);const p=s.append(r,c("span"));if(p.style.whiteSpace="pre-wrap",p.innerText=a,i||t)if(t&&typeof t!="string"){const d=c("span");if(i){const u=s.append(d,c("span"));u.innerText=i}const l=s.append(d,c("a.code-link"));l.setAttribute("href",t.target.toString(!0)),o.add(s.addDisposableListener(l,"click",u=>{this._openerService.open(t.target,{allowCommands:!0}),u.preventDefault(),u.stopPropagation()}));const C=s.append(l,c("span"));C.innerText=t.value;const g=s.append(r,d);g.style.opacity="0.6",g.style.paddingLeft="6px"}else{const d=s.append(r,c("span"));d.style.opacity="0.6",d.style.paddingLeft="6px",d.innerText=i&&t?`${i}(${t})`:i||`(${t})`}if(O(f))for(const{message:d,resource:l,startLineNumber:C,startColumn:g}of f){const u=s.append(r,c("div"));u.style.marginTop="8px";const b=s.append(u,c("a"));b.innerText=`${z(l)}(${C}, ${g}): `,b.style.cursor="pointer",o.add(s.addDisposableListener(b,"click",y=>{if(y.stopPropagation(),y.preventDefault(),this._openerService){const L={selection:{startLineNumber:C,startColumn:g}};this._openerService.open(l,{fromUserGesture:!0,editorOptions:L}).catch(x)}}));const M=s.append(u,c("span"));M.innerText=d,this._editor.applyFontInfo(M)}return{hoverPart:e,hoverElement:n,dispose:()=>o.dispose()}}renderMarkerStatusbar(e,o,n){if(o.marker.severity===A.Error||o.marker.severity===A.Warning||o.marker.severity===A.Info){const r=Y.get(this._editor);r&&e.statusBar.addAction({label:k.localize("view problem","View Problem"),commandId:Z.ID,run:()=>{e.hide(),r.showAtMarker(o.marker),this._editor.focus()}})}if(!this._editor.getOption(B.readOnly)){const r=e.statusBar.append(c("div"));this.recentMarkerCodeActionsInfo&&(T.makeKey(this.recentMarkerCodeActionsInfo.marker)===T.makeKey(o.marker)?this.recentMarkerCodeActionsInfo.hasCodeActions||(r.textContent=k.localize("noQuickFixes","No quick fixes available")):this.recentMarkerCodeActionsInfo=void 0);const i=this.recentMarkerCodeActionsInfo&&!this.recentMarkerCodeActionsInfo.hasCodeActions?Q.None:q(()=>r.textContent=k.localize("checkingForQuickFixes","Checking for quick fixes..."),200,n);r.textContent||(r.textContent="\xA0");const a=this.getCodeActions(o.marker);n.add(E(()=>a.cancel())),a.then(t=>{if(i.dispose(),this.recentMarkerCodeActionsInfo={marker:o.marker,hasCodeActions:t.validActions.length>0},!this.recentMarkerCodeActionsInfo.hasCodeActions){t.dispose(),r.textContent=k.localize("noQuickFixes","No quick fixes available");return}r.style.display="none";let f=!1;n.add(E(()=>{f||t.dispose()})),e.statusBar.addAction({label:k.localize("quick fixes","Quick Fix..."),commandId:j,run:m=>{f=!0;const d=_.get(this._editor),l=s.getDomNodePagePosition(m);e.hide(),d?.showCodeActions(F,t,{x:l.left,y:l.top,width:l.width,height:l.height})}});const p=t.validActions.find(m=>m.action.isAI);p&&e.statusBar.addAction({label:p.action.title,commandId:p.action.command?.id??"",run:()=>{_.get(this._editor)?.applyCodeAction(p,!1,!1,G.FromProblemsHover)}})},x)}}getCodeActions(e){return $(o=>W(this._languageFeaturesService.codeActionProvider,this._editor.getModel(),new P(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn),F,re.None,o))}};I=H([h(1,V),h(2,ee),h(3,U)],I);export{oe as MarkerHover,I as MarkerHoverParticipant};
