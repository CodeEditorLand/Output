var T=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var C=(p,g,e,i)=>{for(var n=i>1?void 0:i?V(g,e):g,r=p.length-1,u;r>=0;r--)(u=p[r])&&(n=(i?u(g,e,n):u(n))||n);return i&&n&&T(g,e,n),n},a=(p,g)=>(e,i)=>g(e,i,p);import{createStyleSheetFromObservable as R}from"../../../../../base/browser/domObservable.js";import{alert as W}from"../../../../../base/browser/ui/aria/aria.js";import{timeout as K}from"../../../../../base/common/async.js";import{cancelOnDispose as x}from"../../../../../base/common/cancellation.js";import{createHotClass as F,readHotReloadableExport as P}from"../../../../../base/common/hotReloadHelpers.js";import{Disposable as H,toDisposable as L}from"../../../../../base/common/lifecycle.js";import{autorun as G,constObservable as M,derived as c,derivedDisposable as f,derivedObservableWithCache as O,mapObservableArrayCached as k,observableFromEvent as h,observableSignal as U,runOnChange as E,runOnChangeWithStore as z,transaction as y,waitForState as N}from"../../../../../base/common/observable.js";import{isUndefined as B}from"../../../../../base/common/types.js";import{localize as j}from"../../../../../nls.js";import{IAccessibilityService as Z}from"../../../../../platform/accessibility/common/accessibility.js";import{AccessibilitySignal as $,IAccessibilitySignalService as q}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{ICommandService as J}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as Q}from"../../../../../platform/configuration/common/configuration.js";import{IContextKeyService as X}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as Y}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as ee}from"../../../../../platform/keybinding/common/keybinding.js";import{hotClassGetOriginalInstance as ie}from"../../../../../platform/observable/common/wrapInHotClass.js";import{CoreEditingCommands as I}from"../../../../browser/coreCommands.js";import"../../../../browser/editorBrowser.js";import{observableCodeEditor as te}from"../../../../browser/observableCodeEditor.js";import{EditorOption as d}from"../../../../common/config/editorOptions.js";import{Position as A}from"../../../../common/core/position.js";import"../../../../common/core/range.js";import{CursorChangeReason as ne}from"../../../../common/cursorEvents.js";import{ILanguageFeatureDebounceService as oe}from"../../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService as re}from"../../../../common/services/languageFeatures.js";import{InlineCompletionsHintsWidget as se,InlineSuggestionHintsContentWidget as ae}from"../hintsWidget/inlineCompletionsHintsWidget.js";import{InlineCompletionsModel as de}from"../model/inlineCompletionsModel.js";import{SuggestWidgetAdaptor as le}from"../model/suggestWidgetAdaptor.js";import{convertItemsToStableObservables as ce,ObservableContextKeyService as ge}from"../utils.js";import{GhostTextView as he}from"../view/ghostText/ghostTextView.js";import{InlineEditsViewAndDiffProducer as me}from"../view/inlineEdits/inlineEditsView.js";import{inlineSuggestCommitId as pe}from"./commandIds.js";import{InlineCompletionContextKeys as b}from"./inlineCompletionContextKeys.js";let m=class extends H{constructor(e,i,n,r,u,ue,be,_e,ve,Se){super();this.editor=e;this._instantiationService=i;this._contextKeyService=n;this._configurationService=r;this._commandService=u;this._debounceService=ue;this._languageFeaturesService=be;this._accessibilitySignalService=_e;this._keybindingService=ve;this._accessibilityService=Se;this._register(new b(this._contextKeyService,this.model)),this._register(E(this._editorObs.onDidType,(t,o)=>{this._enabled.get()&&this.model.get()?.trigger()})),this._register(this._commandService.onDidExecuteCommand(t=>{new Set([I.Tab.id,I.DeleteLeft.id,I.DeleteRight.id,pe,"acceptSelectedSuggestion"]).has(t.commandId)&&e.hasTextFocus()&&this._enabled.get()&&this._editorObs.forceUpdate(l=>{this.model.get()?.trigger(l)})})),this._register(E(this._editorObs.selections,(t,o,l)=>{if(l.some(s=>s.reason===ne.Explicit||s.source==="api")){if(!this._hideInlineEditOnSelectionChange.get()&&this.model.get()?.state.get()?.kind==="inlineEdit")return;const s=this.model.get();if(!s)return;s.inlineCompletionState.get()?.primaryGhostText?this.model.get()?.stop():s.state.get()?.inlineCompletion&&this.model.get()?.collapseInlineEdit()}})),this._register(this.editor.onDidBlurEditorWidget(()=>{this._contextKeyService.getContextKeyValue("accessibleViewIsShown")||this._configurationService.getValue("editor.inlineSuggest.keepOnBlur")||e.getOption(d.inlineSuggest).keepOnBlur||ae.dropDownVisible||y(t=>{this.model.get()?.stop(t)})})),this._register(G(t=>{const o=this.model.read(t)?.inlineCompletionState.read(t);o?.suggestItem?o.primaryGhostText.lineCount>=2&&this._suggestWidgetAdaptor.forceRenderingAbove():this._suggestWidgetAdaptor.stopForceRenderingAbove()})),this._register(L(()=>{this._suggestWidgetAdaptor.stopForceRenderingAbove()}));const w=O(this,(t,o)=>{const s=this.model.read(t)?.inlineCompletionState.read(t);return this._suggestWidgetSelectedItem.get()?o:s?.inlineCompletion?.semanticId});this._register(z(c(t=>(this._playAccessibilitySignal.read(t),w.read(t),{})),async(t,o,l,s)=>{const v=this.model.get(),S=v?.inlineCompletionState.get();if(!S||!v)return;const D=v.textModel.getLineContent(S.primaryGhostText.lineNumber);await K(50,x(s)),await N(this._suggestWidgetSelectedItem,B,()=>!1,x(s)),await this._accessibilitySignalService.playSignal($.inlineSuggestion),this.editor.getOption(d.screenReaderAnnounceInlineSuggestion)&&this._provideScreenReaderUpdate(S.primaryGhostText.renderForScreenReader(D))})),this._register(new se(this.editor,this.model,this._instantiationService)),this._register(R(c(t=>{const o=this._fontFamily.read(t);return o===""||o==="default"?"":`
.monaco-editor .ghost-text-decoration,
.monaco-editor .ghost-text-decoration-preview,
.monaco-editor .ghost-text {
	font-family: ${o};
}`}))),this._register(this._configurationService.onDidChangeConfiguration(t=>{t.affectsConfiguration("accessibility.verbosity.inlineCompletions")&&this.editor.updateOptions({inlineCompletionsAccessibilityVerbose:this._configurationService.getValue("accessibility.verbosity.inlineCompletions")})})),this.editor.updateOptions({inlineCompletionsAccessibilityVerbose:this._configurationService.getValue("accessibility.verbosity.inlineCompletions")});const _=new ge(this._contextKeyService);this._register(_.bind(b.cursorInIndentation,this._cursorIsInIndentation)),this._register(_.bind(b.hasSelection,t=>!this._editorObs.cursorSelection.read(t)?.isEmpty())),this._register(_.bind(b.cursorAtInlineEdit,this.model.map((t,o)=>{const l=t?.state?.read(o);return l?.kind==="inlineEdit"&&l.cursorAtInlineEdit})))}static hot=F(m);static ID="editor.contrib.inlineCompletionsController";static get(e){return ie(e.getContribution(m.ID))}_editorObs=te(this.editor);_positions=c(this,e=>this._editorObs.selections.read(e)?.map(i=>i.getEndPosition())??[new A(1,1)]);_suggestWidgetAdaptor=this._register(new le(this.editor,()=>(this._editorObs.forceUpdate(),this.model.get()?.selectedInlineCompletion.get()?.toSingleTextEdit(void 0)),e=>this._editorObs.forceUpdate(i=>{this.model.get()?.handleSuggestAccepted(e)})));_suggestWidgetSelectedItem=h(this,e=>this._suggestWidgetAdaptor.onDidSelectedItemChange(()=>{this._editorObs.forceUpdate(i=>e(void 0))}),()=>this._suggestWidgetAdaptor.selectedItem);_enabledInConfig=h(this,this.editor.onDidChangeConfiguration,()=>this.editor.getOption(d.inlineSuggest).enabled);_isScreenReaderEnabled=h(this,this._accessibilityService.onDidChangeScreenReaderOptimized,()=>this._accessibilityService.isScreenReaderOptimized());_editorDictationInProgress=h(this,this._contextKeyService.onDidChangeContext,()=>this._contextKeyService.getContext(this.editor.getDomNode()).getValue("editorDictation.inProgress")===!0);_enabled=c(this,e=>this._enabledInConfig.read(e)&&(!this._isScreenReaderEnabled.read(e)||!this._editorDictationInProgress.read(e)));_debounceValue=this._debounceService.for(this._languageFeaturesService.inlineCompletionsProvider,"InlineCompletionsDebounce",{min:50,max:50});_cursorIsInIndentation=c(this,e=>{const i=this._editorObs.cursorPosition.read(e);if(i===null)return!1;const n=this._editorObs.model.read(e);if(!n)return!1;this._editorObs.versionId.read(e);const r=n.getLineIndentColumn(i.lineNumber);return i.column<=r});_shouldHideInlineEdit=c(this,e=>this._cursorIsInIndentation.read(e));model=f(this,e=>{if(this._editorObs.isReadonly.read(e))return;const i=this._editorObs.model.read(e);return i?this._instantiationService.createInstance(de,i,this._suggestWidgetSelectedItem,this._editorObs.versionId,this._positions,this._debounceValue,h(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(d.suggest).preview),h(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(d.suggest).previewMode),h(this.editor.onDidChangeConfiguration,()=>this.editor.getOption(d.inlineSuggest).mode),this._enabled,this._shouldHideInlineEdit):void 0}).recomputeInitiallyAndOnChange(this._store);_ghostTexts=c(this,e=>this.model.read(e)?.ghostTexts.read(e)??[]);_stablizedGhostTexts=ce(this._ghostTexts,this._store);_ghostTextWidgets=k(this,this._stablizedGhostTexts,(e,i)=>f(n=>this._instantiationService.createInstance(P(he,n),this.editor,{ghostText:e,minReservedLineCount:M(0),targetTextModel:this.model.map(r=>r?.textModel)})).recomputeInitiallyAndOnChange(i)).recomputeInitiallyAndOnChange(this._store);_inlineEdit=c(this,e=>{const i=this.model.read(e)?.state.read(e);if(i?.kind==="inlineEdit")return i.inlineEdit});_everHadInlineEdit=O(this,(e,i)=>i||!!this._inlineEdit.read(e));_inlineEditWidget=f(e=>{if(this._everHadInlineEdit.read(e))return this._instantiationService.createInstance(me.hot.read(e),this.editor,this._inlineEdit)}).recomputeInitiallyAndOnChange(this._store);_playAccessibilitySignal=U(this);_fontFamily=this._editorObs.getOption(d.inlineSuggest).map(e=>e.fontFamily);_hideInlineEditOnSelectionChange=this._editorObs.getOption(d.inlineSuggest).map(e=>!0);playAccessibilitySignal(e){this._playAccessibilitySignal.trigger(e)}_provideScreenReaderUpdate(e){const i=this._contextKeyService.getContextKeyValue("accessibleViewIsShown"),n=this._keybindingService.lookupKeybinding("editor.action.accessibleView");let r;!i&&n&&this.editor.getOption(d.inlineCompletionsAccessibilityVerbose)&&(r=j("showAccessibleViewHint","Inspect this in the accessible view ({0})",n.getAriaLabel())),W(r?e+", "+r:e)}shouldShowHoverAt(e){const i=this.model.get()?.primaryGhostText.get();return i?i.parts.some(n=>e.containsPosition(new A(i.lineNumber,n.column))):!1}shouldShowHoverAtViewZone(e){return this._ghostTextWidgets.get()[0]?.get().ownsViewZone(e)??!1}hide(){y(e=>{this.model.get()?.stop(e)})}jump(){const e=this.model.get(),i=e?.inlineEditState.get();i&&y(n=>{e.dontRefetchSignal.trigger(n),this.editor.setPosition(i.inlineEdit.range.getStartPosition(),"inlineCompletions.jump"),this.editor.revealLine(i.inlineEdit.range.startLineNumber),this.editor.focus()})}};m=C([a(1,Y),a(2,X),a(3,Q),a(4,J),a(5,oe),a(6,re),a(7,q),a(8,ee),a(9,Z)],m);export{m as InlineCompletionsController};
