var $=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var W=(g,p,e,t)=>{for(var i=t>1?void 0:t?j(p,e):p,n=g.length-1,o;n>=0;n--)(o=g[n])&&(i=(t?o(p,e,i):o(i))||i);return t&&i&&$(p,e,i),i},b=(g,p)=>(e,t)=>p(e,t,g);import{mapFindFirst as z}from"../../../../../base/common/arraysFind.js";import{itemsEquals as V}from"../../../../../base/common/equals.js";import{BugIndicatingError as w,onUnexpectedError as J,onUnexpectedExternalError as Q}from"../../../../../base/common/errors.js";import{Disposable as X}from"../../../../../base/common/lifecycle.js";import{autorun as Y,derived as x,derivedHandleChanges as Z,derivedOpts as v,observableSignal as k,observableValue as R,recomputeInitiallyAndOnChange as ee,subtransaction as G,transaction as te}from"../../../../../base/common/observable.js";import{commonPrefixLength as ie}from"../../../../../base/common/strings.js";import{isDefined as A}from"../../../../../base/common/types.js";import{ICommandService as ne}from"../../../../../platform/commands/common/commands.js";import{IInstantiationService as oe}from"../../../../../platform/instantiation/common/instantiation.js";import"../../../../browser/editorBrowser.js";import{EditOperation as M}from"../../../../common/core/editOperation.js";import{LineRange as L}from"../../../../common/core/lineRange.js";import{Position as q}from"../../../../common/core/position.js";import{Range as E}from"../../../../common/core/range.js";import{Selection as K}from"../../../../common/core/selection.js";import{SingleTextEdit as N}from"../../../../common/core/textEdit.js";import{TextLength as se}from"../../../../common/core/textLength.js";import{ScrollType as re}from"../../../../common/editorCommon.js";import{InlineCompletionTriggerKind as S,PartialAcceptTriggerKind as U}from"../../../../common/languages.js";import{ILanguageConfigurationService as le}from"../../../../common/languages/languageConfigurationRegistry.js";import{EndOfLinePreference as de}from"../../../../common/model.js";import{TextModelText as ae}from"../../../../common/model/textModelText.js";import"../../../../common/services/languageFeatureDebounce.js";import"../../../../common/textModelEvents.js";import{SnippetController2 as ce}from"../../../snippet/browser/snippetController2.js";import{addPositions as pe,getEndPositionsAfterApplying as D,substringPos as me,subtractPositions as F}from"../utils.js";import{computeGhostText as H}from"./computeGhostText.js";import{GhostText as ue,ghostTextOrReplacementEquals as ge,ghostTextsOrReplacementsEqual as B}from"./ghostText.js";import{InlineCompletionsSource as fe}from"./inlineCompletionsSource.js";import{InlineEdit as he}from"./inlineEdit.js";import"./provideInlineCompletions.js";import{singleTextEditAugments as Ie,singleTextRemoveCommonPrefix as T}from"./singleTextEditHelpers.js";import"./suggestWidgetAdaptor.js";let P=class extends X{constructor(e,t,i,n,o,s,l,r,a,d,c,m,f){super();this.textModel=e;this.selectedSuggestItem=t;this._textModelVersionId=i;this._positions=n;this._debounceValue=o;this._suggestPreviewEnabled=s;this._suggestPreviewMode=l;this._inlineSuggestMode=r;this._enabled=a;this._shouldHideInlineEdit=d;this._instantiationService=c;this._commandService=m;this._languageConfigurationService=f;this._register(ee(this._fetchInlineCompletionsPromise));let u;this._register(Y(h=>{const I=this.inlineCompletionState.read(h)?.inlineCompletion;if(I?.semanticId!==u?.semanticId&&(u=I,I)){const y=I.inlineCompletion,C=y.source;C.provider.handleItemDidShow?.(C.inlineCompletions,y.sourceInlineCompletion,y.insertText)}}))}_source=this._register(this._instantiationService.createInstance(fe,this.textModel,this._textModelVersionId,this._debounceValue));_isActive=R(this,!1);_forceUpdateExplicitlySignal=k(this);_selectedInlineCompletionId=R(this,void 0);_primaryPosition=x(this,e=>this._positions.read(e)[0]??new q(1,1));_isAcceptingPartially=!1;get isAcceptingPartially(){return this._isAcceptingPartially}_preserveCurrentCompletionReasons=new Set([1,0,2]);_getReason(e){return e?.isUndoing?0:e?.isRedoing?1:this.isAcceptingPartially?2:3}dontRefetchSignal=k(this);_fetchInlineCompletionsPromise=Z({owner:this,createEmptyChangeSummary:()=>({dontRefetch:!1,preserveCurrentCompletion:!1,inlineCompletionTriggerKind:S.Automatic}),handleChange:(e,t)=>(e.didChange(this._textModelVersionId)&&this._preserveCurrentCompletionReasons.has(this._getReason(e.change))?t.preserveCurrentCompletion=!0:e.didChange(this._forceUpdateExplicitlySignal)?t.inlineCompletionTriggerKind=S.Explicit:e.didChange(this.dontRefetchSignal)&&(t.dontRefetch=!0),!0)},(e,t)=>{if(this.dontRefetchSignal.read(e),this._forceUpdateExplicitlySignal.read(e),!(this._enabled.read(e)&&this.selectedSuggestItem.read(e)||this._isActive.read(e))){this._source.cancelUpdate();return}this._textModelVersionId.read(e);const n=this._source.suggestWidgetInlineCompletions.get(),o=this.selectedSuggestItem.read(e);if(n&&!o){const d=this._source.inlineCompletions.get();te(c=>{(!d||n.request.versionId>d.request.versionId)&&this._source.inlineCompletions.set(n.clone(),c),this._source.clearSuggestWidgetInlineCompletions(c)})}const s=this._primaryPosition.get();if(t.dontRefetch)return Promise.resolve(!0);const l={triggerKind:t.inlineCompletionTriggerKind,selectedSuggestionInfo:o?.toSelectedSuggestionInfo()},r=this.selectedInlineCompletion.get(),a=t.preserveCurrentCompletion||r?.forwardStable?r:void 0;return this._source.fetch(s,l,a)});async trigger(e){this._isActive.set(!0,e),await this._fetchInlineCompletionsPromise.get()}async triggerExplicitly(e){G(e,t=>{this._isActive.set(!0,t),this._forceUpdateExplicitlySignal.trigger(t)}),await this._fetchInlineCompletionsPromise.get()}stop(e){G(e,t=>{this._isActive.set(!1,t),this._source.clear(t)})}_collapsedInlineEditId=R(this,void 0);collapseInlineEdit(){const e=this.inlineEditState.get()?.inlineCompletion;e&&this._collapsedInlineEditId.set(e.semanticId,void 0)}_inlineCompletionItems=v({owner:this},e=>{const t=this._source.inlineCompletions.read(e);if(!t)return;const i=this._primaryPosition.read(e);let n;const o=[];for(const s of t.inlineCompletions)s.inlineCompletion.sourceInlineCompletion.isInlineEdit?o.length===0&&s.inlineCompletion.sourceInlineCompletion.isInlineEdit&&(n=s):s.isVisible(this.textModel,i,e)&&o.push(s);return{items:o,inlineEditCompletion:n}});_filteredInlineCompletionItems=v({owner:this,equalsFn:V()},e=>this._inlineCompletionItems.read(e)?.items??[]);selectedInlineCompletionIndex=x(this,e=>{const t=this._selectedInlineCompletionId.read(e),i=this._filteredInlineCompletionItems.read(e),n=this._selectedInlineCompletionId===void 0?-1:i.findIndex(o=>o.semanticId===t);return n===-1?(this._selectedInlineCompletionId.set(void 0,void 0),0):n});selectedInlineCompletion=x(this,e=>{const t=this._filteredInlineCompletionItems.read(e),i=this.selectedInlineCompletionIndex.read(e);return t[i]});activeCommands=v({owner:this,equalsFn:V()},e=>this.selectedInlineCompletion.read(e)?.inlineCompletion.source.inlineCompletions.commands??[]);lastTriggerKind=this._source.inlineCompletions.map(this,e=>e?.request.context.triggerKind);inlineCompletionsCount=x(this,e=>{if(this.lastTriggerKind.read(e)===S.Explicit)return this._filteredInlineCompletionItems.read(e).length});state=v({owner:this,equalsFn:(e,t)=>!e||!t?e===t:e.kind==="ghostText"&&t.kind==="ghostText"?B(e.ghostTexts,t.ghostTexts)&&e.inlineCompletion===t.inlineCompletion&&e.suggestItem===t.suggestItem:e.kind==="inlineEdit"&&t.kind==="inlineEdit"?e.inlineEdit.equals(t.inlineEdit)&&e.cursorAtInlineEdit===t.cursorAtInlineEdit:!1},e=>{const t=this.textModel,i=this._inlineCompletionItems.read(e);if(i?.inlineEditCompletion){let o=i.inlineEditCompletion.toSingleTextEdit(e);if(o=T(o,t),o.isEffectiveDeletion(new ae(t)))return;const s=this._primaryPosition.read(e),l=L.fromRangeInclusive(o.range).contains(s.lineNumber);if(i.inlineEditCompletion.request.context.triggerKind===S.Automatic&&this._shouldHideInlineEdit.read(e)&&!l)return;const a=L.fromRange(o.range).distanceToLine(this._primaryPosition.read(e).lineNumber)>1&&this._collapsedInlineEditId.read(e)===i.inlineEditCompletion.semanticId;return{kind:"inlineEdit",inlineEdit:new he(o,a),inlineCompletion:i.inlineEditCompletion,edits:[o],cursorAtInlineEdit:l}}const n=this.selectedSuggestItem.read(e);if(n){const o=T(n.toSingleTextEdit(),t),s=this._computeAugmentation(o,e);if(!this._suggestPreviewEnabled.read(e)&&!s)return;const r=s?.edit??o,a=s?s.edit.text.length-o.text.length:0,d=this._suggestPreviewMode.read(e),c=this._positions.read(e),m=[r,...O(this.textModel,c,r)],f=m.map((h,_)=>H(h,t,d,c[_],a)).filter(A),u=f[0]??new ue(r.range.endLineNumber,[]);return{kind:"ghostText",edits:m,primaryGhostText:u,ghostTexts:f,inlineCompletion:s?.completion,suggestItem:n}}else{if(!this._isActive.read(e))return;const o=this.selectedInlineCompletion.read(e);if(!o)return;const s=o.toSingleTextEdit(e),l=this._inlineSuggestMode.read(e),r=this._positions.read(e),a=[s,...O(this.textModel,r,s)],d=a.map((c,m)=>H(c,t,l,r[m],0)).filter(A);return d[0]?{kind:"ghostText",edits:a,primaryGhostText:d[0],ghostTexts:d,inlineCompletion:o,suggestItem:void 0}:void 0}});status=x(this,e=>{if(this._source.loading.read(e))return"loading";const t=this.state.read(e);return t?.kind==="ghostText"?"ghostText":t?.kind==="inlineEdit"?"inlineEdit":"noSuggestion"});inlineCompletionState=x(e=>{const t=this.state.read(e);if(!(!t||t.kind!=="ghostText"))return t});inlineEditState=x(e=>{const t=this.state.read(e);if(!(!t||t.kind!=="inlineEdit"))return t});_computeAugmentation(e,t){const i=this.textModel,n=this._source.suggestWidgetInlineCompletions.read(t),o=n?n.inlineCompletions:[this.selectedInlineCompletion.read(t)].filter(A);return z(o,l=>{let r=l.toSingleTextEdit(t);return r=T(r,i,E.fromPositions(r.range.getStartPosition(),e.range.getEndPosition())),Ie(r,e)?{completion:l,edit:r}:void 0})}ghostTexts=v({owner:this,equalsFn:B},e=>{const t=this.inlineCompletionState.read(e);if(t)return t.ghostTexts});primaryGhostText=v({owner:this,equalsFn:ge},e=>{const t=this.inlineCompletionState.read(e);if(t)return t?.primaryGhostText});async _deltaSelectedInlineCompletionIndex(e){await this.triggerExplicitly();const t=this._filteredInlineCompletionItems.get()||[];if(t.length>0){const i=(this.selectedInlineCompletionIndex.get()+e+t.length)%t.length;this._selectedInlineCompletionId.set(t[i].semanticId,void 0)}else this._selectedInlineCompletionId.set(void 0,void 0)}async next(){await this._deltaSelectedInlineCompletionIndex(1)}async previous(){await this._deltaSelectedInlineCompletionIndex(-1)}async accept(e){if(e.getModel()!==this.textModel)throw new w;let t;const i=this.state.get();if(i?.kind==="ghostText"){if(!i||i.primaryGhostText.isEmpty()||!i.inlineCompletion)return;t=i.inlineCompletion.toInlineCompletion(void 0)}else if(i?.kind==="inlineEdit")t=i.inlineCompletion.toInlineCompletion(void 0);else return;if(t.command&&t.source.addRef(),e.pushUndoStop(),t.snippetInfo)e.executeEdits("inlineSuggestion.accept",[M.replace(t.range,""),...t.additionalTextEdits]),e.setPosition(t.snippetInfo.range.getStartPosition(),"inlineCompletionAccept"),ce.get(e)?.insert(t.snippetInfo.snippet,{undoStopBefore:!1});else{const n=i.edits,o=D(n).map(s=>K.fromPositions(s));e.executeEdits("inlineSuggestion.accept",[...n.map(s=>M.replace(s.range,s.text)),...t.additionalTextEdits]),e.setSelections(o,"inlineCompletionAccept")}this.stop(),t.command&&(await this._commandService.executeCommand(t.command.id,...t.command.arguments||[]).then(void 0,Q),t.source.removeRef())}async acceptNextWord(e){await this._acceptNext(e,(t,i)=>{const n=this.textModel.getLanguageIdAtPosition(t.lineNumber,t.column),o=this._languageConfigurationService.getLanguageConfiguration(n),s=new RegExp(o.wordDefinition.source,o.wordDefinition.flags.replace("g","")),l=i.match(s);let r=0;l&&l.index!==void 0?l.index===0?r=l[0].length:r=l.index:r=i.length;const d=/\s+/g.exec(i);return d&&d.index!==void 0&&d.index+d[0].length<r&&(r=d.index+d[0].length),r},U.Word)}async acceptNextLine(e){await this._acceptNext(e,(t,i)=>{const n=i.match(/\n/);return n&&n.index!==void 0?n.index+1:i.length},U.Line)}async _acceptNext(e,t,i){if(e.getModel()!==this.textModel)throw new w;const n=this.inlineCompletionState.get();if(!n||n.primaryGhostText.isEmpty()||!n.inlineCompletion)return;const o=n.primaryGhostText,s=n.inlineCompletion.toInlineCompletion(void 0);if(s.snippetInfo||s.filterText!==s.insertText){await this.accept(e);return}const l=o.parts[0],r=new q(o.lineNumber,l.column),a=l.text,d=t(r,a);if(d===a.length&&o.parts.length===1){this.accept(e);return}const c=a.substring(0,d),m=this._positions.get(),f=m[0];s.source.addRef();try{this._isAcceptingPartially=!0;try{e.pushUndoStop();const u=E.fromPositions(f,r),h=e.getModel().getValueInRange(u)+c,_=new N(u,h),I=[_,...O(this.textModel,m,_)],y=D(I).map(C=>K.fromPositions(C));e.executeEdits("inlineSuggestion.accept",I.map(C=>M.replace(C.range,C.text))),e.setSelections(y,"inlineCompletionPartialAccept"),e.revealPositionInCenterIfOutsideViewport(e.getPosition(),re.Immediate)}finally{this._isAcceptingPartially=!1}if(s.source.provider.handlePartialAccept){const u=E.fromPositions(s.range.getStartPosition(),se.ofText(c).addToPosition(r)),h=e.getModel().getValueInRange(u,de.LF);s.source.provider.handlePartialAccept(s.source.inlineCompletions,s.sourceInlineCompletion,h.length,{kind:i})}}finally{s.source.removeRef()}}handleSuggestAccepted(e){const t=T(e.toSingleTextEdit(),this.textModel),i=this._computeAugmentation(t,void 0);if(!i)return;const n=i.completion.inlineCompletion;n.source.provider.handlePartialAccept?.(n.source.inlineCompletions,n.sourceInlineCompletion,t.text.length,{kind:U.Suggest})}extractReproSample(){const e=this.textModel.getValue(),t=this.state.get()?.inlineCompletion?.toInlineCompletion(void 0);return{documentValue:e,inlineCompletion:t?.sourceInlineCompletion}}};P=W([b(10,oe),b(11,ne),b(12,le)],P);var Ce=(i=>(i[i.Undo=0]="Undo",i[i.Redo=1]="Redo",i[i.AcceptWord=2]="AcceptWord",i[i.Other=3]="Other",i))(Ce||{});function O(g,p,e){if(p.length===1)return[];const t=p[0],i=p.slice(1),n=e.range.getStartPosition(),o=e.range.getEndPosition(),s=g.getValueInRange(E.fromPositions(t,o)),l=F(t,n);if(l.lineNumber<1)return J(new w(`positionWithinTextEdit line number should be bigger than 0.
			Invalid subtraction between ${t.toString()} and ${n.toString()}`)),[];const r=me(e.text,l);return i.map(a=>{const d=pe(F(a,n),o),c=g.getValueInRange(E.fromPositions(a,d)),m=ie(s,c),f=E.fromPositions(a,a.delta(0,m));return new N(f,r)})}export{P as InlineCompletionsModel,Ce as VersionIdChangeReason,O as getSecondaryEdits};
