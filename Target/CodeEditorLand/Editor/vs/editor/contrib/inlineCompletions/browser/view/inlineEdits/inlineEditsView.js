var B=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var T=(l,r,e,i)=>{for(var n=i>1?void 0:i?U(r,e):r,a=l.length-1,t;a>=0;a--)(t=l[a])&&(n=(i?t(r,e,n):t(n))||n);return i&&n&&B(r,e,n),n},_=(l,r)=>(e,i)=>r(e,i,l);import{h as m,svgElem as S}from"../../../../../../base/browser/dom.js";import{renderIcon as V}from"../../../../../../base/browser/ui/iconLabel/iconLabels.js";import{numberComparator as H}from"../../../../../../base/common/arrays.js";import{findFirstMin as X}from"../../../../../../base/common/arraysFind.js";import{Codicon as G}from"../../../../../../base/common/codicons.js";import{createHotClass as z}from"../../../../../../base/common/hotReloadHelpers.js";import{Disposable as C}from"../../../../../../base/common/lifecycle.js";import{autorun as x,constObservable as R,derived as h,derivedDisposable as M,derivedWithCancellationToken as q,observableFromEvent as j,ObservablePromise as Q}from"../../../../../../base/common/observable.js";import{getIndentationLength as J,splitLines as K}from"../../../../../../base/common/strings.js";import{MenuWorkbenchToolBar as Y}from"../../../../../../platform/actions/browser/toolbar.js";import{MenuId as Z,MenuItemAction as ee}from"../../../../../../platform/actions/common/actions.js";import{IInstantiationService as O}from"../../../../../../platform/instantiation/common/instantiation.js";import"../../../../../browser/editorBrowser.js";import{observableCodeEditor as y}from"../../../../../browser/observableCodeEditor.js";import{EmbeddedCodeEditorWidget as ie}from"../../../../../browser/widget/codeEditor/embeddedCodeEditorWidget.js";import{IDiffProviderFactoryService as te}from"../../../../../browser/widget/diffEditor/diffProviderFactoryService.js";import{diffAddDecoration as oe,diffAddDecorationEmpty as ne,diffDeleteDecorationEmpty as re,diffWholeLineAddDecoration as se,diffWholeLineDeleteDecoration as ae}from"../../../../../browser/widget/diffEditor/registrations.contribution.js";import{appendRemoveOnDispose as de}from"../../../../../browser/widget/diffEditor/utils.js";import{EditorOption as le}from"../../../../../common/config/editorOptions.js";import{SingleLineEdit as ce}from"../../../../../common/core/lineEdit.js";import{LineRange as pe}from"../../../../../common/core/lineRange.js";import{OffsetRange as P}from"../../../../../common/core/offsetRange.js";import{Position as he}from"../../../../../common/core/position.js";import{Range as I}from"../../../../../common/core/range.js";import{SingleTextEdit as D,StringText as fe,TextEdit as W}from"../../../../../common/core/textEdit.js";import{TextLength as N}from"../../../../../common/core/textLength.js";import{lineRangeMappingFromRangeMappings as me,RangeMapping as ge}from"../../../../../common/diff/rangeMapping.js";import"../../../../../common/model.js";import{TextModel as $}from"../../../../../common/model/textModel.js";import{TextModelText as ue}from"../../../../../common/model/textModelText.js";import{IModelService as ve}from"../../../../../common/services/model.js";import"../../model/inlineEdit.js";import"./inlineEditsView.css";import{applyEditToModifiedRangeMappings as _e,maxLeftInRange as k,Point as g,StatusBarViewItem as ye,UniqueUriGenerator as be}from"./utils.js";let u=class extends C{constructor(e,i,n,a,t){super();this._editor=e;this._edit=i;this._instantiationService=n;this._diffProviderFactoryService=a;this._modelService=t;this._register(new b(this._editor,this._inlineEdit,this._instantiationService))}static hot=z(u);_modelUriGenerator=new be("inline-edits");_originalModel=M(()=>this._modelService.createModel("",null,this._modelUriGenerator.getUniqueUri())).keepObserved(this._store);_modifiedModel=M(()=>this._modelService.createModel("",null,this._modelUriGenerator.getUniqueUri())).keepObserved(this._store);_inlineEditPromise=q(this,(e,i)=>{const n=this._edit.read(e);if(!n)return;const a=new ue(this._editor.getModel()),t=n.edit.extendToFullLine(a);this._originalModel.get().setValue(this._editor.getModel().getValueInRange(t.range)),this._modifiedModel.get().setValue(t.text);const o=this._diffProviderFactoryService.createDiffProvider({diffAlgorithm:"advanced"});return Q.fromFn(async()=>{const s=await o.computeDiff(this._originalModel.get(),this._modifiedModel.get(),{computeMoves:!1,ignoreTrimWhitespace:!1,maxComputationTimeMs:1e3},i);if(s.identical)return;const p=t.range.getStartPosition(),c=s.changes.flatMap(f=>f.innerChanges);function d(f,v){const w=N.fromPosition(v.getStartPosition());return N.ofRange(v).createRange(w.addToPosition(f))}const E=c.map(f=>new D(d(p,f.originalRange),this._modifiedModel.get().getValueInRange(f.modifiedRange))),L=new W(E);return new we(a,L,n.isCollapsed)})});_inlineEdit=this._inlineEditPromise.map((e,i)=>e?.promiseResult?.read(i)?.data)};u=T([_(2,O),_(3,te),_(4,ve)],u);class we{constructor(r,e,i){this.originalText=r;this.edit=e;this.isCollapsed=i}lineEdit=ce.fromSingleTextEdit(this.edit.toSingle(this.originalText),this.originalText);originalLineRange=this.lineEdit.lineRange;modifiedLineRange=this.lineEdit.toLineEdit().getNewLineRanges()[0]}let b=class extends C{constructor(e,i,n){super();this._editor=e;this._edit=i;this._instantiationService=n;this._register(de(this._editor.getDomNode(),this._elements.root)),this._register(y(e).createOverlayWidget({domNode:this._elements.root,position:R(null),allowEditorOverflow:!1,minContentWidthInPx:h(t=>{const o=this._previewEditorLeft.read(t)?.left;if(o===void 0)return 0;const s=this._previewEditorWidth.read(t);return o+s})})),this._register(y(e).createOverlayWidget({domNode:this._indicator.root,position:R(null),allowEditorOverflow:!1,minContentWidthInPx:R(0)})),this._previewEditor.setModel(this._previewTextModel),this._register(this._previewEditorObs.setDecorations(this._decorations.map(t=>t?.modifiedDecorations??[]))),this._register(y(e).setDecorations(this._decorations.map(t=>t?.originalDecorations??[]))),this._register(x(t=>{const o=this._previewEditorLayoutInfo.read(t);if(!o){this._indicator.root.style.visibility="hidden";return}this._indicator.root.style.visibility="";const s=this._editorObs.layoutInfo.read(t),p=new P(0,s.height-30),c=o.edit1;this._indicator.root.classList.toggle("top",c.y<p.start),this._indicator.root.classList.toggle("bottom",c.y>p.endExclusive);const d=!this._diffViewInformation.read(t);this._indicator.root.classList.toggle("visible",d),this._indicator.root.classList.toggle("contained",p.contains(c.y)),this._indicator.root.style.top=`${p.clip(c.y)}px`,this._indicator.root.style.right=`${s.minimap.minimapWidth+s.verticalScrollbarWidth}px`})),this._register(x(t=>{const o=this._previewEditorLayoutInfo.read(t);if(!o){this._elements.path.style.visibility="hidden";return}this._elements.path.style.visibility="";const s=o.edit1,p=o.editHeight,c=this._previewEditorWidth.read(t)+10,d=new Te;d.moveTo(o.code1.deltaX(-5)),d.lineTo(o.code1),d.lineTo(o.edit1),d.lineTo(o.edit1.deltaX(c)),d.lineTo(o.edit2.deltaX(c)),d.lineTo(o.edit2),d.curveTo2(o.edit2.deltaX(-20),o.code2.deltaX(20),o.code2.deltaX(0)),d.lineTo(o.code2.deltaX(-5)),this._elements.path.setAttribute("d",d.build()),this._elements.path.style.fill="none",this._elements.path.style.stroke="var(--vscode-activityBarBadge-background)",this._elements.path.style.strokeWidth="1px",this._elements.editorContainer.style.top=`${s.y}px`,this._elements.editorContainer.style.left=`${s.x}px`,this._previewEditor.layout({height:p,width:c})}));const a=j(this,this._toolbar.onDidChangeDropdownVisibility,t=>t??!1);this._register(x(t=>{this._elements.root.classList.toggle("toolbarDropdownVisible",a.read(t))}))}_editorObs=y(this._editor);_elements=m("div.inline-edits-view",{style:{position:"absolute",overflow:"visible",top:"0px",left:"0px"}},[m("div.editorContainer@editorContainer",{style:{position:"absolute"}},[m("div.preview@editor",{style:{}}),m("div.toolbar@toolbar",{style:{}})]),S("svg",{style:{overflow:"visible",pointerEvents:"none",position:"absolute"}},[S("path@path",{d:""})])]);_indicator=m("div.inline-edits-view-indicator",{style:{position:"absolute",overflow:"visible"}},[m("div.icon",{},[V(G.arrowLeft)]),m("div.label",{},[" inline edit"])]);_diffViewInformation=h(this,e=>{const i=this._edit.read(e);if(!(!i||i.isCollapsed))return!0});_uiState=h(this,e=>{const i=this._edit.read(e);if(!i)return;let n=i.edit.apply(i.originalText);const a=Le(n,i.modifiedLineRange);n=a.applyToString(n);let t=ge.fromEdit(i.edit);t=_e(t,a);const o=me(t,i.originalText,new fe(n)),s=i.originalText.lineRange.intersect(pe.ofLength(i.originalLineRange.startLineNumber-1,i.lineEdit.newLines.length+2));return{diff:o,edit:i,newText:n,newTextLineCount:i.modifiedLineRange.length,originalDisplayRange:s}});_decorations=h(this,e=>{this._updatePreviewEditor.read(e);const i=this._uiState.read(e);if(!i)return;const n=i.diff,a=[],t=[];if(i.edit.originalLineRange.length!==0){for(const o of n)if(o.modified.isEmpty||o.original.isEmpty)o.original.isEmpty||a.push({range:o.original.toInclusiveRange(),options:ae}),o.modified.isEmpty||t.push({range:o.modified.toInclusiveRange(),options:se});else for(const s of o.innerChanges||[])o.original.contains(s.originalRange.startLineNumber)&&a.push({range:s.originalRange,options:s.originalRange.isEmpty()?re:{className:"char-delete",description:"char-delete",shouldFillLineOnLineBreak:!1}}),o.modified.contains(s.modifiedRange.startLineNumber)&&t.push({range:s.modifiedRange,options:s.modifiedRange.isEmpty()?ne:oe});return{originalDecorations:a,modifiedDecorations:t}}});_toolbar=this._register(this._instantiationService.createInstance(Y,this._elements.toolbar,Z.InlineEditsActions,{menuOptions:{renderShortTitle:!0},toolbarOptions:{primaryGroup:e=>e.startsWith("primary")},actionViewItemProvider:(e,i)=>{if(e instanceof ee)return this._instantiationService.createInstance(ye,e,void 0)}}));_previewTextModel=this._register(this._instantiationService.createInstance($,"",this._editor.getModel().getLanguageId(),{...$.DEFAULT_CREATION_OPTIONS,bracketPairColorizationOptions:{enabled:!0,independentColorPoolPerBracketType:!1}},null));_previewEditor=this._register(this._instantiationService.createInstance(ie,this._elements.editor,{glyphMargin:!1,lineNumbers:"off",minimap:{enabled:!1},guides:{indentation:!1,bracketPairs:!1,bracketPairsHorizontal:!1,highlightActiveIndentation:!1},folding:!1,selectOnLineNumbers:!1,selectionHighlight:!1,columnSelection:!1,overviewRulerBorder:!1,overviewRulerLanes:0,lineDecorationsWidth:0,lineNumbersMinChars:0,bracketPairColorization:{enabled:!0,independentColorPoolPerBracketType:!1},scrollBeyondLastLine:!1,scrollbar:{vertical:"hidden",horizontal:"hidden"},readOnly:!0,wordWrap:"off"},{contributions:[]},this._editor));_previewEditorObs=y(this._previewEditor);_rootVisibility=h(this,e=>this._diffViewInformation.read(e)?"block":"none");_updateRootVisibility=h(e=>{this._elements.root.style.display=this._rootVisibility.read(e)});_updatePreviewEditor=h(e=>{this._updateRootVisibility.read(e);const i=this._uiState.read(e);if(!i)return;this._previewTextModel.setValue(i.newText);const n=i.edit.originalLineRange;this._previewEditor.setHiddenAreas([new I(1,1,n.startLineNumber-1,1),new I(n.startLineNumber+i.newTextLineCount,1,this._previewTextModel.getLineCount()+1,1)],void 0,!0)}).recomputeInitiallyAndOnChange(this._store);_previewEditorWidth=h(this,e=>{const i=this._edit.read(e);return i?(this._updatePreviewEditor.read(e),k(this._previewEditorObs,i.modifiedLineRange,e)):0});_previewEditorLeft=h(this,e=>{const i=this._uiState.read(e);if(!i)return null;const n=k(this._editorObs,i.originalDisplayRange,e);return{left:this._editorObs.layoutInfoContentLeft.read(e)+n}});_previewEditorLayoutInfo=h(this,e=>{const i=this._edit.read(e);if(!i)return null;const n=i.originalLineRange,a=this._editorObs.scrollLeft.read(e),t=this._previewEditorLeft.read(e).left+20-a,o=this._editor.getTopForLineNumber(n.startLineNumber)-this._editorObs.scrollTop.read(e),s=this._editor.getTopForLineNumber(n.endLineNumberExclusive)-this._editorObs.scrollTop.read(e),p=this._editorObs.layoutInfoContentLeft.read(e),c=new g(t,o),d=new g(p,o),E=new g(t,s),L=new g(0,s),f=s-o,v=60,w=this._editor.getOption(le.lineHeight)*i.modifiedLineRange.length,A=new g(t+v,o),F=new g(t+v,o+w);return{code1:c,codeStart1:d,code2:E,codeStart2:L,codeHeight:f,edit1:A,edit2:F,editHeight:w}})};b=T([_(2,O)],b);function Ee(l,r){return new I(r.lineNumber,r.column+l.start,r.lineNumber,r.column+l.endExclusive)}function Le(l,r){const e=K(l),i=[],n=X(r.mapToLineArray(a=>J(e[a-1])),H);return r.forEach(a=>{i.push(new D(Ee(new P(0,n),new he(a,1)),""))}),new W(i)}class Te{_data="";moveTo(r){return this._data+=`M ${r.x} ${r.y} `,this}lineTo(r){return this._data+=`L ${r.x} ${r.y} `,this}curveTo(r,e){return this._data+=`Q ${r.x} ${r.y} ${e.x} ${e.y} `,this}curveTo2(r,e,i){return this._data+=`C ${r.x} ${r.y} ${e.x} ${e.y} ${i.x} ${i.y} `,this}build(){return this._data}}export{we as InlineEditWithChanges,b as InlineEditsView,u as InlineEditsViewAndDiffProducer};
