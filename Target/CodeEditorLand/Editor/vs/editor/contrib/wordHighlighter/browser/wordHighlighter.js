var O=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var I=(u,e,i,t)=>{for(var o=t>1?void 0:t?V(e,i):e,r=u.length-1,n;r>=0;r--)(n=u[r])&&(o=(t?n(e,i,o):n(o))||o);return t&&o&&O(e,i,o),o},h=(u,e)=>(i,t)=>e(i,t,u);import*as D from"../../../../nls.js";import{alert as M}from"../../../../base/browser/ui/aria/aria.js";import{createCancelablePromise as K,Delayer as B,first as y}from"../../../../base/common/async.js";import{CancellationToken as $}from"../../../../base/common/cancellation.js";import{onUnexpectedError as S,onUnexpectedExternalError as H}from"../../../../base/common/errors.js";import{KeyCode as x,KeyMod as z}from"../../../../base/common/keyCodes.js";import{Disposable as G,DisposableStore as j}from"../../../../base/common/lifecycle.js";import{ResourceMap as p}from"../../../../base/common/map.js";import{matchesScheme as Q,Schemas as g}from"../../../../base/common/network.js";import{isEqual as k}from"../../../../base/common/resources.js";import"../../../../base/common/uri.js";import{IConfigurationService as E}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as J,RawContextKey as W}from"../../../../platform/contextkey/common/contextkey.js";import"../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as C}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILogService as P}from"../../../../platform/log/common/log.js";import{isDiffEditor as X}from"../../../browser/editorBrowser.js";import{EditorAction as T,EditorContributionInstantiation as Y,registerEditorAction as w,registerEditorContribution as Z,registerModelAndPositionCommand as ee}from"../../../browser/editorExtensions.js";import{ICodeEditorService as q}from"../../../browser/services/codeEditorService.js";import{EditorOption as v}from"../../../common/config/editorOptions.js";import"../../../common/core/position.js";import{Range as _}from"../../../common/core/range.js";import"../../../common/core/selection.js";import"../../../common/core/wordHelper.js";import{CursorChangeReason as te}from"../../../common/cursorEvents.js";import"../../../common/editorCommon.js";import{EditorContextKeys as b}from"../../../common/editorContextKeys.js";import{registerEditorFeature as oe}from"../../../common/editorFeatures.js";import"../../../common/languageFeatureRegistry.js";import"../../../common/languages.js";import{score as ie}from"../../../common/languageSelector.js";import{shouldSynchronizeModel as re}from"../../../common/model.js";import{ILanguageFeaturesService as A}from"../../../common/services/languageFeatures.js";import{ITextModelService as N}from"../../../common/services/resolverService.js";import{getHighlightDecorationOptions as ne}from"./highlightDecorations.js";import{TextualMultiDocumentHighlightFeature as se}from"./textualHighlightProvider.js";const R=new W("hasWordHighlights",!1);function L(u,e,i,t){const o=u.ordered(e);return y(o.map(r=>()=>Promise.resolve(r.provideDocumentHighlights(e,i,t)).then(void 0,H)),r=>r!=null).then(r=>{if(r){const n=new p;return n.set(e.uri,r),n}return new p})}function le(u,e,i,t,o){const r=u.ordered(e);return y(r.map(n=>()=>{const c=o.filter(d=>re(d)).filter(d=>ie(n.selector,d.uri,d.getLanguageId(),!0,void 0,void 0)>0);return Promise.resolve(n.provideMultiDocumentHighlights(e,i,c,t)).then(void 0,H)}),n=>n!=null)}class U{constructor(e,i,t){this._model=e;this._selection=i;this._wordSeparators=t;this._wordRange=this._getCurrentWordRange(e,i),this._result=null}_wordRange;_result;get result(){return this._result||(this._result=K(e=>this._compute(this._model,this._selection,this._wordSeparators,e))),this._result}_getCurrentWordRange(e,i){const t=e.getWordAtPosition(i.getPosition());return t?new _(i.startLineNumber,t.startColumn,i.startLineNumber,t.endColumn):null}isValid(e,i,t){const o=i.startLineNumber,r=i.startColumn,n=i.endColumn,c=this._getCurrentWordRange(e,i);let d=!!(this._wordRange&&this._wordRange.equalsRange(c));for(let l=0,m=t.length;!d&&l<m;l++){const f=t.getRange(l);f&&f.startLineNumber===o&&f.startColumn<=r&&f.endColumn>=n&&(d=!0)}return d}cancel(){this.result.cancel()}}class ce extends U{_providers;constructor(e,i,t,o){super(e,i,t),this._providers=o}_compute(e,i,t,o){return L(this._providers,e,i.getPosition(),o).then(r=>r||new p)}}class de extends U{_providers;_otherModels;constructor(e,i,t,o,r){super(e,i,t),this._providers=o,this._otherModels=r}_compute(e,i,t,o){return le(this._providers,e,i.getPosition(),o,this._otherModels).then(r=>r||new p)}}function ue(u,e,i,t){return new ce(e,i,t,u)}function ae(u,e,i,t,o){return new de(e,i,t,u,o)}ee("_executeDocumentHighlights",async(u,e,i)=>{const t=u.get(A);return(await L(t.documentHighlightProvider,e,i,$.None))?.get(e.uri)});let s=class{editor;providers;multiDocumentProviders;model;decorations;toUnhook=new j;textModelService;codeEditorService;configurationService;logService;occurrencesHighlightEnablement;occurrencesHighlightDelay;workerRequestTokenId=0;workerRequest;workerRequestCompleted=!1;workerRequestValue=new p;lastCursorPositionChangeTime=0;renderDecorationsTimer=-1;_hasWordHighlights;_ignorePositionChangeEvent;runDelayer=this.toUnhook.add(new B(50));static storedDecorationIDs=new p;static query=null;constructor(e,i,t,o,r,n,c,d){this.editor=e,this.providers=i,this.multiDocumentProviders=t,this.codeEditorService=n,this.textModelService=r,this.configurationService=c,this.logService=d,this._hasWordHighlights=R.bindTo(o),this._ignorePositionChangeEvent=!1,this.occurrencesHighlightEnablement=this.editor.getOption(v.occurrencesHighlight),this.occurrencesHighlightDelay=this.configurationService.getValue("editor.occurrencesHighlightDelay"),this.model=this.editor.getModel(),this.toUnhook.add(e.onDidChangeCursorPosition(l=>{this._ignorePositionChangeEvent||this.occurrencesHighlightEnablement!=="off"&&this.runDelayer.trigger(()=>{this._onPositionChanged(l)})})),this.toUnhook.add(e.onDidFocusEditorText(l=>{this.occurrencesHighlightEnablement!=="off"&&(this.workerRequest||this.runDelayer.trigger(()=>{this._run()}))})),this.toUnhook.add(e.onDidChangeModelContent(l=>{Q(this.model.uri,"output")||this._stopAll()})),this.toUnhook.add(e.onDidChangeModel(l=>{!l.newModelUrl&&l.oldModelUrl?this._stopSingular():s.query&&this._run()})),this.toUnhook.add(e.onDidChangeConfiguration(l=>{const m=this.editor.getOption(v.occurrencesHighlight);if(this.occurrencesHighlightEnablement!==m)switch(this.occurrencesHighlightEnablement=m,m){case"off":this._stopAll();break;case"singleFile":this._stopAll(s.query?.modelInfo?.modelURI);break;case"multiFile":s.query&&this._run(!0);break;default:break}})),this.toUnhook.add(this.configurationService.onDidChangeConfiguration(l=>{if(l.affectsConfiguration("editor.occurrencesHighlightDelay")){const m=c.getValue("editor.occurrencesHighlightDelay");this.occurrencesHighlightDelay!==m&&(this.occurrencesHighlightDelay=m)}})),this.toUnhook.add(e.onDidBlurEditorWidget(()=>{const l=this.codeEditorService.getFocusedCodeEditor();l?l.getModel()?.uri.scheme===g.vscodeNotebookCell&&this.editor.getModel()?.uri.scheme!==g.vscodeNotebookCell&&this._stopAll():this._stopAll()})),this.decorations=this.editor.createDecorationsCollection(),this.workerRequestTokenId=0,this.workerRequest=null,this.workerRequestCompleted=!1,this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1,s.query&&this._run()}hasDecorations(){return this.decorations.length>0}restore(){this.occurrencesHighlightEnablement!=="off"&&(this.runDelayer.cancel(),this._run())}trigger(){this.runDelayer.cancel(),this._run(!1,!0)}stop(){this.occurrencesHighlightEnablement!=="off"&&this._stopAll()}_getSortedHighlights(){return this.decorations.getRanges().sort(_.compareRangesUsingStarts)}moveNext(){const e=this._getSortedHighlights(),t=(e.findIndex(r=>r.containsPosition(this.editor.getPosition()))+1)%e.length,o=e[t];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(o.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(o);const r=this._getWord();if(r){const n=this.editor.getModel().getLineContent(o.startLineNumber);M(`${n}, ${t+1} of ${e.length} for '${r.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}moveBack(){const e=this._getSortedHighlights(),t=(e.findIndex(r=>r.containsPosition(this.editor.getPosition()))-1+e.length)%e.length,o=e[t];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(o.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(o);const r=this._getWord();if(r){const n=this.editor.getModel().getLineContent(o.startLineNumber);M(`${n}, ${t+1} of ${e.length} for '${r.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}_removeSingleDecorations(){if(!this.editor.hasModel())return;const e=s.storedDecorationIDs.get(this.editor.getModel().uri);e&&(this.editor.removeDecorations(e),s.storedDecorationIDs.delete(this.editor.getModel().uri),this.decorations.length>0&&(this.decorations.clear(),this._hasWordHighlights.set(!1)))}_removeAllDecorations(e){const i=this.codeEditorService.listCodeEditors(),t=[];for(const o of i){if(!o.hasModel()||k(o.getModel().uri,e))continue;const r=s.storedDecorationIDs.get(o.getModel().uri);if(!r)continue;o.removeDecorations(r),t.push(o.getModel().uri);const n=a.get(o);n?.wordHighlighter&&n.wordHighlighter.decorations.length>0&&(n.wordHighlighter.decorations.clear(),n.wordHighlighter.workerRequest=null,n.wordHighlighter._hasWordHighlights.set(!1))}for(const o of t)s.storedDecorationIDs.delete(o)}_stopSingular(){this._removeSingleDecorations(),this.editor.hasTextFocus()&&(this.editor.getModel()?.uri.scheme!==g.vscodeNotebookCell&&s.query?.modelInfo?.modelURI.scheme!==g.vscodeNotebookCell?(s.query=null,this._run()):s.query?.modelInfo&&(s.query.modelInfo=null)),this.renderDecorationsTimer!==-1&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),this.workerRequest!==null&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_stopAll(e){this._removeAllDecorations(e),this.renderDecorationsTimer!==-1&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),this.workerRequest!==null&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_onPositionChanged(e){if(this.occurrencesHighlightEnablement==="off"){this._stopAll();return}if(e.reason!==te.Explicit&&this.editor.getModel()?.uri.scheme!==g.vscodeNotebookCell){this._stopAll();return}this._run()}_getWord(){const e=this.editor.getSelection(),i=e.startLineNumber,t=e.startColumn;return this.model.isDisposed()?null:this.model.getWordAtPosition({lineNumber:i,column:t})}getOtherModelsToHighlight(e){if(!e)return[];if(e.uri.scheme===g.vscodeNotebookCell){const r=[],n=this.codeEditorService.listCodeEditors();for(const c of n){const d=c.getModel();d&&d!==e&&d.uri.scheme===g.vscodeNotebookCell&&r.push(d)}return r}const t=[],o=this.codeEditorService.listCodeEditors();for(const r of o){if(!X(r))continue;const n=r.getModel();n&&e===n.modified&&t.push(n.modified)}if(t.length)return t;if(this.occurrencesHighlightEnablement==="singleFile")return[];for(const r of o){const n=r.getModel();n&&n!==e&&t.push(n)}return t}async _run(e,i){if(this.editor.hasTextFocus()){const o=this.editor.getSelection();if(!o||o.startLineNumber!==o.endLineNumber){s.query=null,this._stopAll();return}const r=o.startColumn,n=o.endColumn,c=this._getWord();if(!c||c.startColumn>r||c.endColumn<n){s.query=null,this._stopAll();return}s.query={modelInfo:{modelURI:this.model.uri,selection:o}}}else if(!s.query){this._stopAll();return}if(this.lastCursorPositionChangeTime=new Date().getTime(),k(this.editor.getModel().uri,s.query.modelInfo?.modelURI)){if(!e){const c=this.decorations.getRanges();for(const d of c)if(d.containsPosition(this.editor.getPosition()))return}this._stopAll(e?this.model.uri:void 0);const o=++this.workerRequestTokenId;this.workerRequestCompleted=!1;const r=this.getOtherModelsToHighlight(this.editor.getModel());if(!s.query||!s.query.modelInfo)return;const n=await this.textModelService.createModelReference(s.query.modelInfo.modelURI);try{this.workerRequest=this.computeWithModel(n.object.textEditorModel,s.query.modelInfo.selection,r),this.workerRequest?.result.then(c=>{o===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=c||[],this._beginRenderDecorations())},S)}catch(c){this.logService.error("Unexpected error during occurrence request. Log: ",c)}finally{n.dispose()}}else if(this.model.uri.scheme===g.vscodeNotebookCell){const o=++this.workerRequestTokenId;if(this.workerRequestCompleted=!1,!s.query||!s.query.modelInfo)return;const r=await this.textModelService.createModelReference(s.query.modelInfo.modelURI);try{this.workerRequest=this.computeWithModel(r.object.textEditorModel,s.query.modelInfo.selection,[this.model]),this.workerRequest?.result.then(n=>{o===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=n||[],this._beginRenderDecorations(i))},S)}catch(n){this.logService.error("Unexpected error during occurrence request. Log: ",n)}finally{r.dispose()}}}computeWithModel(e,i,t){return t.length?ae(this.multiDocumentProviders,e,i,this.editor.getOption(v.wordSeparators),t):ue(this.providers,e,i,this.editor.getOption(v.wordSeparators))}_beginRenderDecorations(e){const i=new Date().getTime(),t=this.lastCursorPositionChangeTime+(e?0:this.occurrencesHighlightDelay);i>=t?(this.renderDecorationsTimer=-1,this.renderDecorations()):this.renderDecorationsTimer=setTimeout(()=>{this.renderDecorations()},t-i)}renderDecorations(){this.renderDecorationsTimer=-1;const e=this.codeEditorService.listCodeEditors();for(const i of e){const t=a.get(i);if(!t)continue;const o=[],r=i.getModel()?.uri;if(r&&this.workerRequestValue.has(r)){const n=s.storedDecorationIDs.get(r),c=this.workerRequestValue.get(r);if(c)for(const l of c)l.range&&o.push({range:l.range,options:ne(l.kind)});let d=[];i.changeDecorations(l=>{d=l.deltaDecorations(n??[],o)}),s.storedDecorationIDs=s.storedDecorationIDs.set(r,d),o.length>0&&(t.wordHighlighter?.decorations.set(o),t.wordHighlighter?._hasWordHighlights.set(!0))}}this.workerRequest=null}dispose(){this._stopSingular(),this.toUnhook.dispose()}};s=I([h(4,N),h(5,q),h(6,E),h(7,P)],s);let a=class extends G{static ID="editor.contrib.wordHighlighter";static get(e){return e.getContribution(a.ID)}_wordHighlighter;constructor(e,i,t,o,r,n,c){super(),this._wordHighlighter=null;const d=()=>{e.hasModel()&&!e.getModel().isTooLargeForTokenization()&&(this._wordHighlighter=new s(e,t.documentHighlightProvider,t.multiDocumentHighlightProvider,i,r,o,n,c))};this._register(e.onDidChangeModel(l=>{this._wordHighlighter&&(!l.newModelUrl&&l.oldModelUrl?.scheme!==g.vscodeNotebookCell&&this.wordHighlighter?.stop(),this._wordHighlighter.dispose(),this._wordHighlighter=null),d()})),d()}get wordHighlighter(){return this._wordHighlighter}saveViewState(){return!!(this._wordHighlighter&&this._wordHighlighter.hasDecorations())}moveNext(){this._wordHighlighter?.moveNext()}moveBack(){this._wordHighlighter?.moveBack()}restoreViewState(e){this._wordHighlighter&&e&&this._wordHighlighter.restore()}stopHighlighting(){this._wordHighlighter?.stop()}dispose(){this._wordHighlighter&&(this._wordHighlighter.dispose(),this._wordHighlighter=null),super.dispose()}};a=I([h(1,J),h(2,A),h(3,q),h(4,N),h(5,E),h(6,P)],a);class F extends T{_isNext;constructor(e,i){super(i),this._isNext=e}run(e,i){const t=a.get(i);t&&(this._isNext?t.moveNext():t.moveBack())}}class he extends F{constructor(){super(!0,{id:"editor.action.wordHighlight.next",label:D.localize("wordHighlight.next.label","Go to Next Symbol Highlight"),alias:"Go to Next Symbol Highlight",precondition:R,kbOpts:{kbExpr:b.editorTextFocus,primary:x.F7,weight:C.EditorContrib}})}}class ge extends F{constructor(){super(!1,{id:"editor.action.wordHighlight.prev",label:D.localize("wordHighlight.previous.label","Go to Previous Symbol Highlight"),alias:"Go to Previous Symbol Highlight",precondition:R,kbOpts:{kbExpr:b.editorTextFocus,primary:z.Shift|x.F7,weight:C.EditorContrib}})}}class me extends T{constructor(){super({id:"editor.action.wordHighlight.trigger",label:D.localize("wordHighlight.trigger.label","Trigger Symbol Highlight"),alias:"Trigger Symbol Highlight",precondition:void 0,kbOpts:{kbExpr:b.editorTextFocus,primary:0,weight:C.EditorContrib}})}run(e,i,t){const o=a.get(i);o&&o.restoreViewState(!0)}}Z(a.ID,a,Y.Eager),w(he),w(ge),w(me),oe(se);export{a as WordHighlighterContribution,le as getOccurrencesAcrossMultipleModels,L as getOccurrencesAtPosition};
