var j=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var H=(l,e,t,r)=>{for(var i=r>1?void 0:r?F(e,t):e,s=l.length-1,n;s>=0;s--)(n=l[s])&&(i=(r?n(e,t,i):n(i))||i);return r&&i&&j(e,t,i),i},g=(l,e)=>(t,r)=>e(t,r,l);import{createReadStream as M,promises as _}from"fs";import*as G from"path";import"http";import*as D from"url";import*as I from"cookie";import*as J from"crypto";import{isEqualOrParent as Q}from"../../base/common/extpath.js";import{getMediaMime as K}from"../../base/common/mime.js";import{isLinux as X}from"../../base/common/platform.js";import{ILogService as z}from"../../platform/log/common/log.js";import{IServerEnvironmentService as q}from"./serverEnvironmentService.js";import{extname as Y,dirname as V,join as A,normalize as Z}from"../../base/common/path.js";import{FileAccess as R,connectionTokenCookieName as B,connectionTokenQueryName as L,Schemas as ee,builtinExtensionsPath as te}from"../../base/common/network.js";import{generateUuid as re}from"../../base/common/uuid.js";import{IProductService as ie}from"../../platform/product/common/productService.js";import{ServerConnectionTokenType as se}from"./serverConnectionToken.js";import{asTextOrError as ne,IRequestService as oe}from"../../platform/request/common/request.js";import"../../base/parts/request/common/request.js";import{CancellationToken as ae}from"../../base/common/cancellation.js";import{URI as O}from"../../base/common/uri.js";import{streamToBuffer as ce}from"../../base/common/buffer.js";import"../../base/common/product.js";import{isString as W}from"../../base/common/types.js";import{CharCode as $}from"../../base/common/charCode.js";import"../../platform/extensions/common/extensions.js";import{ICSSDevelopmentService as le}from"../../platform/cssDev/node/cssDevService.js";const ue={".html":"text/html",".js":"text/javascript",".json":"application/json",".css":"text/css",".svg":"image/svg+xml"};async function m(l,e,t,r){e.writeHead(t,{"Content-Type":"text/plain"}),e.end(r)}var he=(r=>(r[r.NO_CACHING=0]="NO_CACHING",r[r.ETAG=1]="ETAG",r[r.NO_EXPIRY=2]="NO_EXPIRY",r))(he||{});async function pe(l,e,t,r,i,s){try{const n=await _.stat(l);if(e===1){const a=`W/"${[n.ino,n.size,n.mtime.getTime()].join("-")}"`;if(r.headers["if-none-match"]===a)return i.writeHead(304),void i.end();s.Etag=a}else e===2?s["Cache-Control"]="public, max-age=31536000":e===0&&(s["Cache-Control"]="no-store");s["Content-Type"]=ue[Y(l)]||K(l)||"text/plain",i.writeHead(200,s),M(l).pipe(i)}catch(n){return n.code!=="ENOENT"&&t.error(n),i.writeHead(404,{"Content-Type":"text/plain"}),void i.end("Not found")}}const N=V(R.asFileUri("").fsPath);let x=class{constructor(e,t,r,i,s,n,a,h){this._connectionToken=e;this._basePath=t;this.serverRootPath=r;this._environmentService=i;this._logService=s;this._requestService=n;this._productService=a;this._cssDevService=h;this._webExtensionResourceUrlTemplate=this._productService.extensionsGallery?.resourceUrlTemplate?O.parse(this._productService.extensionsGallery.resourceUrlTemplate):void 0,this._staticRoute=`${r}/static`,this._callbackRoute=`${r}/callback`,this._webExtensionRoute=`${r}/web-extension-resource`}_webExtensionResourceUrlTemplate;_staticRoute;_callbackRoute;_webExtensionRoute;async handle(e,t,r){try{const i=r.pathname;return i.startsWith(this._staticRoute)&&i.charCodeAt(this._staticRoute.length)===$.Slash?this._handleStatic(e,t,r):i===this._basePath?this._handleRoot(e,t,r):i===this._callbackRoute?this._handleCallback(t):i.startsWith(this._webExtensionRoute)&&i.charCodeAt(this._webExtensionRoute.length)===$.Slash?this._handleWebExtensionResource(e,t,r):m(e,t,404,"Not found.")}catch(i){return this._logService.error(i),m(e,t,500,"Internal Server Error.")}}async _handleStatic(e,t,r){const i=Object.create(null),n=decodeURIComponent(r.pathname).substring(this._staticRoute.length+1),a=A(N,n);return Q(a,N,!X)?pe(a,this._environmentService.isBuilt?2:1,this._logService,e,t,i):m(e,t,400,"Bad request.")}_getResourceURLTemplateAuthority(e){const t=e.authority.indexOf(".");return t!==-1?e.authority.substring(t+1):void 0}async _handleWebExtensionResource(e,t,r){if(!this._webExtensionResourceUrlTemplate)return m(e,t,500,"No extension gallery service configured.");const i=decodeURIComponent(r.pathname),s=Z(i.substring(this._webExtensionRoute.length+1)),n=O.parse(s).with({scheme:this._webExtensionResourceUrlTemplate.scheme,authority:s.substring(0,s.indexOf("/")),path:s.substring(s.indexOf("/")+1)});if(this._getResourceURLTemplateAuthority(this._webExtensionResourceUrlTemplate)!==this._getResourceURLTemplateAuthority(n))return m(e,t,403,"Request Forbidden");const a={},h=c=>{const u=e.headers[c];u&&(W(u)||u[0])?a[c]=W(u)?u:u[0]:c!==c.toLowerCase()&&h(c.toLowerCase())};h("X-Client-Name"),h("X-Client-Version"),h("X-Machine-Id"),h("X-Client-Commit");const d=await this._requestService.request({type:"GET",url:n.toString(!0),headers:a},ae.None),v=d.res.statusCode||500;if(v!==200){let c=null;try{c=await ne(d)}catch{}return m(e,t,v,c||`Request failed with status ${v}`)}const b=Object.create(null),f=c=>{const u=d.res.headers[c];u?b[c]=u:c!==c.toLowerCase()&&f(c.toLowerCase())};f("Cache-Control"),f("Content-Type"),t.writeHead(200,b);const y=await ce(d.stream);return void t.end(y.buffer)}async _handleRoot(e,t,r){const i=r.query[L];if(typeof i=="string"){const o=Object.create(null);o["Set-Cookie"]=I.serialize(B,i,{sameSite:"lax",maxAge:60*60*24*7});const p=Object.create(null);for(const k in r.query)k!==L&&(p[k]=r.query[k]);const S=D.format({pathname:r.pathname,query:p});return o.Location=S,t.writeHead(302,o),void t.end()}const s=o=>{const p=e.headers[o];return Array.isArray(p)?p[0]:p},n=!this._environmentService.isBuilt&&this._environmentService.args["use-test-resolver"],a=n?"test+test":s("x-original-host")||s("x-forwarded-host")||e.headers.host;if(!a)return m(e,t,400,"Bad request.");function h(o){return JSON.stringify(o).replace(/"/g,"&quot;")}let d;this._environmentService.args["enable-smoke-test-driver"]&&(d=!1);const v=o=>o&&O.file(G.resolve(o)).with({scheme:ee.vscodeRemote,authority:a}),b=R.asFileUri(`vs/code/browser/workbench/workbench${this._environmentService.isBuilt?"":"-dev"}.html`).fsPath,f=!this._environmentService.isBuilt&&this._environmentService.args["github-auth"]?{id:re(),providerId:"github",accessToken:this._environmentService.args["github-auth"],scopes:[["user:email"],["repo"]]}:void 0,y={embedderIdentifier:"server-distro",extensionsGallery:this._webExtensionResourceUrlTemplate&&this._productService.extensionsGallery?{...this._productService.extensionsGallery,resourceUrlTemplate:this._webExtensionResourceUrlTemplate.with({scheme:"http",authority:a,path:`${this._webExtensionRoute}/${this._webExtensionResourceUrlTemplate.authority}${this._webExtensionResourceUrlTemplate.path}`}).toString(!0)}:void 0};if(!this._environmentService.isBuilt)try{const o=JSON.parse((await _.readFile(A(N,"product.overrides.json"))).toString());Object.assign(y,o)}catch{}const c={remoteAuthority:a,serverBasePath:this._basePath,_wrapWebWorkerExtHostInIframe:d,developmentOptions:{enableSmokeTestDriver:this._environmentService.args["enable-smoke-test-driver"]?!0:void 0,logLevel:this._logService.getLevel()},settingsSyncOptions:!this._environmentService.isBuilt&&this._environmentService.args["enable-sync"]?{enabled:!0}:void 0,enableWorkspaceTrust:!this._environmentService.args["disable-workspace-trust"],folderUri:v(this._environmentService.args["default-folder"]),workspaceUri:v(this._environmentService.args["default-workspace"]),productConfiguration:y,callbackRoute:this._callbackRoute},P=I.parse(e.headers.cookie||"")["vscode.nls.locale"]||e.headers["accept-language"]?.split(",")[0]?.toLowerCase()||"en";let w,C;!P.startsWith("en")&&this._productService.nlsCoreBaseUrl?(w=this._productService.nlsCoreBaseUrl,C=`${w}${this._productService.commit}/${this._productService.version}/${P}/nls.messages.js`):C="";const E={WORKBENCH_WEB_CONFIGURATION:h(c),WORKBENCH_AUTH_SESSION:f?h(f):"",WORKBENCH_WEB_BASE_URL:this._staticRoute,WORKBENCH_NLS_URL:C,WORKBENCH_NLS_FALLBACK_URL:`${this._staticRoute}/out/nls.messages.js`};if(this._cssDevService.isEnabled){const o=await this._cssDevService.getCssModules();E.WORKBENCH_DEV_CSS_MODULES=JSON.stringify(o)}if(n){const o=[];for(const p of["vscode-test-resolver","github-authentication"]){const S=JSON.parse((await _.readFile(R.asFileUri(`${te}/${p}/package.json`).fsPath)).toString());o.push({extensionPath:p,packageJSON:S})}E.WORKBENCH_BUILTIN_EXTENSIONS=h(o)}let T;try{T=(await _.readFile(b)).toString().replace(/\{\{([^}]+)\}\}/g,(p,S)=>E[S]??"undefined")}catch{return t.writeHead(404,{"Content-Type":"text/plain"}),void t.end("Not found")}const U={"Content-Type":"text/html","Content-Security-Policy":["default-src 'self';","img-src 'self' https: data: blob:;","media-src 'self';",`script-src 'self' 'unsafe-eval' ${w??""} blob: 'nonce-1nline-m4p' ${this._getScriptCspHashes(T).join(" ")} 'sha256-2Q+j4hfT09+1+imS46J2YlkCtHWQt0/BE79PXjJ0ZJ8=' 'sha256-/r7rqQ+yrxt57sxLuQ6AMYcy/lUpvAIzHjIJt/OeLWU=' ${n?"":`http://${a}`};`,"child-src 'self';","frame-src 'self' https://*.vscode-cdn.net data:;","worker-src 'self' data: blob:;","style-src 'self' 'unsafe-inline';","connect-src 'self' ws: wss: https:;","font-src 'self' blob:;","manifest-src 'self';"].join(" ")};return this._connectionToken.type!==se.None&&(U["Set-Cookie"]=I.serialize(B,this._connectionToken.value,{sameSite:"lax",maxAge:60*60*24*7})),t.writeHead(200,U),void t.end(T)}_getScriptCspHashes(e){const t=/<script>([\s\S]+?)<\/script>/img,r=[];let i;for(;i=t.exec(e);){const s=J.createHash("sha256"),n=i[1].replace(/\r\n/g,`
`),a=s.update(Buffer.from(n)).digest().toString("base64");r.push(`'sha256-${a}'`)}return r}async _handleCallback(e){const t=R.asFileUri("vs/code/browser/workbench/callback.html").fsPath,r=(await _.readFile(t)).toString(),i=["default-src 'self';","img-src 'self' https: data: blob:;","media-src 'none';",`script-src 'self' ${this._getScriptCspHashes(r).join(" ")};`,"style-src 'self' 'unsafe-inline';","font-src 'self' blob:;"].join(" ");return e.writeHead(200,{"Content-Type":"text/html","Content-Security-Policy":i}),void e.end(r)}};x=H([g(3,q),g(4,z),g(5,oe),g(6,ie),g(7,le)],x);export{he as CacheControl,x as WebClientServer,m as serveError,pe as serveFile};
