var _e=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var w=(p,n,e,i)=>{for(var t=i>1?void 0:i?Ee(n,e):n,r=p.length-1,o;r>=0;r--)(o=p[r])&&(t=(i?o(n,e,t):o(t))||t);return i&&t&&_e(n,e,t),t},l=(p,n)=>(e,i)=>n(e,i,p);import{DataTransfers as B}from"../../../../base/browser/dnd.js";import*as g from"../../../../base/browser/dom.js";import*as Me from"../../../../base/browser/cssValue.js";import{renderMarkdownAsPlaintext as Ve}from"../../../../base/browser/markdownRenderer.js";import{ActionBar as ke}from"../../../../base/browser/ui/actionbar/actionbar.js";import{ActionViewItem as Re}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/list/listView.js";import{TreeDragOverBubble as Le}from"../../../../base/browser/ui/tree/tree.js";import{CollapseAllAction as Pe}from"../../../../base/browser/ui/tree/treeDefaults.js";import{ActionRunner as He,Separator as te}from"../../../../base/common/actions.js";import{timeout as Ke}from"../../../../base/common/async.js";import{CancellationToken as ie,CancellationTokenSource as Fe}from"../../../../base/common/cancellation.js";import{Codicon as re}from"../../../../base/common/codicons.js";import{isCancellationError as Ne}from"../../../../base/common/errors.js";import{Emitter as T,Event as Oe}from"../../../../base/common/event.js";import{createMatches as ne}from"../../../../base/common/filters.js";import{isMarkdownString as oe,MarkdownString as ze}from"../../../../base/common/htmlContent.js";import{Disposable as $,DisposableStore as se,MutableDisposable as Ue,toDisposable as Be}from"../../../../base/common/lifecycle.js";import{Mimes as W}from"../../../../base/common/mime.js";import{Schemas as ae}from"../../../../base/common/network.js";import{basename as le,dirname as $e}from"../../../../base/common/resources.js";import{isFalsyOrWhitespace as We}from"../../../../base/common/strings.js";import{isString as G}from"../../../../base/common/types.js";import{URI as C}from"../../../../base/common/uri.js";import{generateUuid as Ge}from"../../../../base/common/uuid.js";import"./media/views.css";import{VSDataTransfer as Je}from"../../../../base/common/dataTransfer.js";import{localize as x}from"../../../../nls.js";import{createActionViewItem as je,createAndFillInContextMenuActions as qe}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{Action2 as de,IMenuService as Xe,MenuId as M,MenuRegistry as Qe,registerAction2 as ce}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry as Ye,ICommandService as he}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as V}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as k,IContextKeyService as R,RawContextKey as L}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as J}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as P}from"../../../../platform/files/common/files.js";import{IInstantiationService as A}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as j}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as me}from"../../../../platform/label/common/label.js";import{WorkbenchAsyncDataTree as Ze}from"../../../../platform/list/browser/listService.js";import{ILogService as q}from"../../../../platform/log/common/log.js";import{INotificationService as X}from"../../../../platform/notification/common/notification.js";import{IOpenerService as Q}from"../../../../platform/opener/common/opener.js";import{IProgressService as pe}from"../../../../platform/progress/common/progress.js";import{Registry as et}from"../../../../platform/registry/common/platform.js";import{ITelemetryService as ue}from"../../../../platform/telemetry/common/telemetry.js";import{ColorScheme as fe}from"../../../../platform/theme/common/theme.js";import{FileThemeIcon as ge,FolderThemeIcon as Y,IThemeService as H}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as tt}from"../../../../base/common/themables.js";import{fillEditorsDragData as it}from"../../dnd.js";import{ResourceLabels as rt}from"../../labels.js";import{API_OPEN_DIFF_EDITOR_COMMAND_ID as nt,API_OPEN_EDITOR_COMMAND_ID as ot}from"../editor/editorCommands.js";import{getLocationBasedViewColors as Ie,ViewPane as st}from"./viewPane.js";import"./viewsViewlet.js";import{Extensions as at,IViewDescriptorService as Z,ResolvableTreeItem as ve,TreeItemCollapsibleState as b}from"../../../common/views.js";import{IActivityService as Te,NumberBadge as lt}from"../../../services/activity/common/activity.js";import{IExtensionService as dt}from"../../../services/extensions/common/extensions.js";import{IHoverService as K,WorkbenchHoverDelegate as ct}from"../../../../platform/hover/browser/hover.js";import{CodeDataTransfers as ht,LocalSelectionTransfer as mt}from"../../../../platform/dnd/browser/dnd.js";import{toExternalVSDataTransfer as ye}from"../../../../editor/browser/dnd.js";import{CheckboxStateHandler as pt,TreeItemCheckbox as be}from"./checkbox.js";import{setTimeout0 as ut}from"../../../../base/common/platform.js";import"../../../../base/browser/ui/aria/aria.js";import{TelemetryTrustedValue as ft}from"../../../../platform/telemetry/common/telemetryUtils.js";import{ITreeViewsDnDService as gt}from"../../../../editor/common/services/treeViewsDndService.js";import{DraggedTreeItemsIdentifier as F}from"../../../../editor/common/services/treeViewsDnd.js";import{MarkdownRenderer as It}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{parseLinkedText as vt}from"../../../../base/common/linkedText.js";import{Button as Tt}from"../../../../base/browser/ui/button/button.js";import{defaultButtonStyles as yt}from"../../../../platform/theme/browser/defaultStyles.js";import{IAccessibleViewInformationService as bt}from"../../../services/accessibility/common/accessibleViewInformationService.js";import"../../../../editor/common/languages.js";let N=class extends st{treeView;_container;_actionRunner;constructor(n,e,i,t,r,o,a,d,c,h,s,m,u){super({...n,titleMenuId:M.ViewTitle,donotForwardArgs:!1},e,i,t,r,o,a,d,c,h,m,u);const{treeView:f}=et.as(at.ViewsRegistry).getView(n.id);this.treeView=f,this._register(this.treeView.onDidChangeActions(()=>this.updateActions(),this)),this._register(this.treeView.onDidChangeTitle(v=>this.updateTitle(v))),this._register(this.treeView.onDidChangeDescription(v=>this.updateTitleDescription(v))),this._register(Be(()=>{this._container&&this.treeView.container&&this._container===this.treeView.container&&this.treeView.setVisibility(!1)})),this._register(this.onDidChangeBodyVisibility(()=>this.updateTreeVisibility())),this._register(this.treeView.onDidChangeWelcomeState(()=>this._onDidChangeViewWelcomeState.fire())),n.title!==this.treeView.title&&this.updateTitle(this.treeView.title),n.titleDescription!==this.treeView.description&&this.updateTitleDescription(this.treeView.description),this._actionRunner=new xe(s,()=>this.treeView.getSelection()),this.updateTreeVisibility()}focus(){super.focus(),this.treeView.focus()}renderBody(n){this._container=n,super.renderBody(n),this.renderTreeView(n)}shouldShowWelcome(){return(this.treeView.dataProvider===void 0||!!this.treeView.dataProvider.isTreeEmpty)&&(this.treeView.message===void 0||this.treeView.message==="")}layoutBody(n,e){super.layoutBody(n,e),this.layoutTreeView(n,e)}getOptimalWidth(){return this.treeView.getOptimalWidth()}renderTreeView(n){this.treeView.show(n)}layoutTreeView(n,e){this.treeView.layout(n,e)}updateTreeVisibility(){this.treeView.setVisibility(this.isBodyVisible())}getActionRunner(){return this._actionRunner}getActionsContext(){return{$treeViewId:this.id,$focusedTreeItem:!0,$selectedTreeItems:!0}}};N=w([l(1,j),l(2,J),l(3,V),l(4,R),l(5,Z),l(6,A),l(7,Q),l(8,H),l(9,ue),l(10,X),l(11,K),l(12,bt)],N);class ee{label={label:"root"};handle="0";parentHandle=void 0;collapsibleState=b.Expanded;children=void 0}function Se(p){const n=Ye.getCommand(p);if(n){const e=Qe.getCommand(n.id);return e&&e.precondition}}function Ce(p,n){const e=p.originalId?p.originalId:p.id,i=Se(e);return i?n.contextMatchesRules(i):!0}function we(p){return!!p&&typeof p!="string"&&"element"in p&&"disposables"in p}const St=x("no-dataprovider","There is no data provider registered that can provide view data."),Ct=new L("customTreeView",!1);class wt extends Ze{}let D=class extends ${constructor(e,i,t,r,o,a,d,c,h,s,m,u,f,v,z,I){super();this.id=e;this._title=i;this.themeService=t;this.instantiationService=r;this.commandService=o;this.configurationService=a;this.progressService=d;this.contextMenuService=c;this.keybindingService=h;this.notificationService=s;this.viewDescriptorService=m;this.hoverService=u;this.contextKeyService=f;this.activityService=v;this.logService=z;this.openerService=I;this.root=new ee,this.lastActive=this.root}isVisible=!1;_hasIconForParentNode=!1;_hasIconForLeafNode=!1;collapseAllContextKey;collapseAllContext;collapseAllToggleContextKey;collapseAllToggleContext;refreshContextKey;refreshContext;focused=!1;domNode;treeContainer;_messageValue;_canSelectMany=!1;_manuallyManageCheckboxes=!1;messageElement;tree;treeLabels;treeViewDnd;_container;root;markdownRenderer;elementsToRefresh=[];lastSelection=[];lastActive;_onDidExpandItem=this._register(new T);onDidExpandItem=this._onDidExpandItem.event;_onDidCollapseItem=this._register(new T);onDidCollapseItem=this._onDidCollapseItem.event;_onDidChangeSelectionAndFocus=this._register(new T);onDidChangeSelectionAndFocus=this._onDidChangeSelectionAndFocus.event;_onDidChangeVisibility=this._register(new T);onDidChangeVisibility=this._onDidChangeVisibility.event;_onDidChangeActions=this._register(new T);onDidChangeActions=this._onDidChangeActions.event;_onDidChangeWelcomeState=this._register(new T);onDidChangeWelcomeState=this._onDidChangeWelcomeState.event;_onDidChangeTitle=this._register(new T);onDidChangeTitle=this._onDidChangeTitle.event;_onDidChangeDescription=this._register(new T);onDidChangeDescription=this._onDidChangeDescription.event;_onDidChangeCheckboxState=this._register(new T);onDidChangeCheckboxState=this._onDidChangeCheckboxState.event;_onDidCompleteRefresh=this._register(new T);_isInitialized=!1;initialize(){this._isInitialized||(this._isInitialized=!0,this.contextKeyService.bufferChangeEvents(()=>{this.initializeShowCollapseAllAction(),this.initializeCollapseAllToggle(),this.initializeShowRefreshAction()}),this.treeViewDnd=this.instantiationService.createInstance(E,this.id),this._dragAndDropController&&(this.treeViewDnd.controller=this._dragAndDropController),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("explorer.decorations")&&this.doRefresh([this.root])})),this._register(this.viewDescriptorService.onDidChangeLocation(({views:e,from:i,to:t})=>{e.some(r=>r.id===this.id)&&this.tree?.updateOptions({overrideStyles:Ie(this.viewLocation).listOverrideStyles})})),this.registerActions(),this.create())}get viewContainer(){return this.viewDescriptorService.getViewContainerByViewId(this.id)}get viewLocation(){return this.viewDescriptorService.getViewLocationById(this.id)}_dragAndDropController;get dragAndDropController(){return this._dragAndDropController}set dragAndDropController(e){this._dragAndDropController=e,this.treeViewDnd&&(this.treeViewDnd.controller=e)}_dataProvider;get dataProvider(){return this._dataProvider}set dataProvider(e){if(e){this.visible&&this.activate();const i=this;this._dataProvider=new class{_isEmpty=!0;_onDidChangeEmpty=new T;onDidChangeEmpty=this._onDidChangeEmpty.event;get isTreeEmpty(){return this._isEmpty}async getChildren(t){let r;const o=[];if(t&&t.children?r=t.children:(t=t??i.root,t.children=await(t instanceof ee?e.getChildren():e.getChildren(t)),r=t.children??[],r.forEach(a=>{a.parent=t,!i.manuallyManageCheckboxes&&t?.checkbox?.isChecked===!0&&a.checkbox?.isChecked===!1&&(a.checkbox.isChecked=!0,o.push(a))})),t instanceof ee){const a=this._isEmpty;this._isEmpty=r.length===0,a!==this._isEmpty&&this._onDidChangeEmpty.fire()}return o.length>0&&i._onDidChangeCheckboxState.fire(o),r}},this._dataProvider.onDidChangeEmpty&&this._register(this._dataProvider.onDidChangeEmpty(()=>{this.updateCollapseAllToggle(),this._onDidChangeWelcomeState.fire()})),this.updateMessage(),this.refresh()}else this._dataProvider=void 0,this.treeDisposables.clear(),this.activated=!1,this.updateMessage();this._onDidChangeWelcomeState.fire()}_message;get message(){return this._message}set message(e){this._message=e,this.updateMessage(),this._onDidChangeWelcomeState.fire()}get title(){return this._title}set title(e){this._title=e,this._onDidChangeTitle.fire(this._title)}_description;get description(){return this._description}set description(e){this._description=e,this._onDidChangeDescription.fire(this._description)}_badge;_activity=this._register(new Ue);get badge(){return this._badge}set badge(e){if(!(this._badge?.value===e?.value&&this._badge?.tooltip===e?.tooltip))if(this._badge=e,e){const i={badge:new lt(e.value,()=>e.tooltip),priority:50};this._activity.value=this.activityService.showViewActivity(this.id,i)}else this._activity.clear()}get canSelectMany(){return this._canSelectMany}set canSelectMany(e){const i=this._canSelectMany;this._canSelectMany=e,this._canSelectMany!==i&&this.tree?.updateOptions({multipleSelectionSupport:this.canSelectMany})}get manuallyManageCheckboxes(){return this._manuallyManageCheckboxes}set manuallyManageCheckboxes(e){this._manuallyManageCheckboxes=e}get hasIconForParentNode(){return this._hasIconForParentNode}get hasIconForLeafNode(){return this._hasIconForLeafNode}get visible(){return this.isVisible}initializeShowCollapseAllAction(e=!1){return this.collapseAllContext||(this.collapseAllContextKey=new L(`treeView.${this.id}.enableCollapseAll`,e,x("treeView.enableCollapseAll","Whether the the tree view with id {0} enables collapse all.",this.id)),this.collapseAllContext=this.collapseAllContextKey.bindTo(this.contextKeyService)),!0}get showCollapseAllAction(){return this.initializeShowCollapseAllAction(),!!this.collapseAllContext?.get()}set showCollapseAllAction(e){this.initializeShowCollapseAllAction(e),this.collapseAllContext?.set(e)}initializeShowRefreshAction(e=!1){this.refreshContext||(this.refreshContextKey=new L(`treeView.${this.id}.enableRefresh`,e,x("treeView.enableRefresh","Whether the tree view with id {0} enables refresh.",this.id)),this.refreshContext=this.refreshContextKey.bindTo(this.contextKeyService))}get showRefreshAction(){return this.initializeShowRefreshAction(),!!this.refreshContext?.get()}set showRefreshAction(e){this.initializeShowRefreshAction(e),this.refreshContext?.set(e)}registerActions(){const e=this;this._register(ce(class extends de{constructor(){super({id:`workbench.actions.treeView.${e.id}.refresh`,title:x("refresh","Refresh"),menu:{id:M.ViewTitle,when:k.and(k.equals("view",e.id),e.refreshContextKey),group:"navigation",order:Number.MAX_SAFE_INTEGER-1},icon:re.refresh})}async run(){return e.refresh()}})),this._register(ce(class extends de{constructor(){super({id:`workbench.actions.treeView.${e.id}.collapseAll`,title:x("collapseAll","Collapse All"),menu:{id:M.ViewTitle,when:k.and(k.equals("view",e.id),e.collapseAllContextKey),group:"navigation",order:Number.MAX_SAFE_INTEGER},precondition:e.collapseAllToggleContextKey,icon:re.collapseAll})}async run(){if(e.tree)return new Pe(e.tree,!0).run()}}))}setVisibility(e){this.initialize(),e=!!e,this.isVisible!==e&&(this.isVisible=e,this.tree&&(this.isVisible?g.show(this.tree.getHTMLElement()):g.hide(this.tree.getHTMLElement()),this.isVisible&&this.elementsToRefresh.length&&this.dataProvider&&(this.doRefresh(this.elementsToRefresh),this.elementsToRefresh=[])),ut(()=>{this.dataProvider&&this._onDidChangeVisibility.fire(this.isVisible)}),this.visible&&this.activate())}activated=!1;focus(e=!0,i){if(this.tree&&this.root.children&&this.root.children.length>0){const t=i??this.tree.getSelection()[0];t&&e&&this.tree.reveal(t,.5),this.tree.domFocus()}else this.tree&&this.treeContainer&&!this.treeContainer.classList.contains("hide")?this.tree.domFocus():this.domNode.focus()}show(e){this._container=e,g.append(e,this.domNode)}create(){this.domNode=g.$(".tree-explorer-viewlet-tree-view"),this.messageElement=g.append(this.domNode,g.$(".message")),this.updateMessage(),this.treeContainer=g.append(this.domNode,g.$(".customview-tree")),this.treeContainer.classList.add("file-icon-themable-tree","show-file-icons");const e=this._register(g.trackFocus(this.domNode));this._register(e.onDidFocus(()=>this.focused=!0)),this._register(e.onDidBlur(()=>this.focused=!1))}treeDisposables=this._register(new se);createTree(){this.treeDisposables.clear();const e=je.bind(void 0,this.instantiationService),i=this.treeDisposables.add(this.instantiationService.createInstance(_,this.id));this.treeLabels=this.treeDisposables.add(this.instantiationService.createInstance(rt,this));const t=this.instantiationService.createInstance(At,this,s=>this.progressService.withProgress({location:this.id},()=>s)),r=new _t(this.themeService),o=this.treeDisposables.add(new pt),a=this.instantiationService.createInstance(S,this.id,i,this.treeLabels,e,r,o,()=>this.manuallyManageCheckboxes);this.treeDisposables.add(a.onDidChangeCheckboxState(s=>this._onDidChangeCheckboxState.fire(s)));const d=this._title;this.tree=this.treeDisposables.add(this.instantiationService.createInstance(wt,this.id,this.treeContainer,new Dt,[a],t,{identityProvider:new xt,accessibilityProvider:{getAriaLabel(s){if(s.accessibilityInformation)return s.accessibilityInformation.label;if(G(s.tooltip))return s.tooltip;{if(s.resourceUri&&!s.label)return null;let m="";return s.label&&(m+=s.label.label+" "),s.description&&(m+=s.description),m}},getRole(s){return s.accessibilityInformation?.role??"treeitem"},getWidgetAriaLabel(){return d}},keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:s=>s.label?s.label.label:s.resourceUri?le(C.revive(s.resourceUri)):void 0},expandOnlyOnTwistieClick:s=>!!s.command||!!s.checkbox||this.configurationService.getValue("workbench.tree.expandMode")==="doubleClick",collapseByDefault:s=>s.collapsibleState!==b.Expanded,multipleSelectionSupport:this.canSelectMany,dnd:this.treeViewDnd,overrideStyles:Ie(this.viewLocation).listOverrideStyles})),this.treeDisposables.add(a.onDidChangeMenuContext(s=>s.forEach(m=>this.tree?.rerender(m)))),this.treeDisposables.add(this.tree),i.setContextKeyService(this.tree.contextKeyService),r.tree=this.tree;const c=new xe(this.notificationService,()=>this.tree.getSelection());a.actionRunner=c,this.tree.contextKeyService.createKey(this.id,!0),Ct.bindTo(this.tree.contextKeyService).set(!0),this.treeDisposables.add(this.tree.onContextMenu(s=>this.onContextMenu(i,s,c))),this.treeDisposables.add(this.tree.onDidChangeSelection(s=>{this.lastSelection=s.elements,this.lastActive=this.tree?.getFocus()[0]??this.lastActive,this._onDidChangeSelectionAndFocus.fire({selection:this.lastSelection,focus:this.lastActive})})),this.treeDisposables.add(this.tree.onDidChangeFocus(s=>{s.elements.length&&s.elements[0]!==this.lastActive&&(this.lastActive=s.elements[0],this.lastSelection=this.tree?.getSelection()??this.lastSelection,this._onDidChangeSelectionAndFocus.fire({selection:this.lastSelection,focus:this.lastActive}))})),this.treeDisposables.add(this.tree.onDidChangeCollapseState(s=>{if(!s.node.element)return;const m=Array.isArray(s.node.element.element)?s.node.element.element[0]:s.node.element.element;s.node.collapsed?this._onDidCollapseItem.fire(m):this._onDidExpandItem.fire(m)})),this.tree.setInput(this.root).then(()=>this.updateContentAreas()),this.treeDisposables.add(this.tree.onDidOpen(async s=>{if(!s.browserEvent||s.browserEvent.target&&s.browserEvent.target.classList.contains(be.checkboxClass))return;const m=this.tree.getSelection(),u=await this.resolveCommand(m.length===1?m[0]:void 0);if(u&&Ce(u,this.contextKeyService)){let f=u.arguments||[];(u.id===ot||u.id===nt)&&(f=[...f,s]);try{await this.commandService.executeCommand(u.id,...f)}catch(v){this.notificationService.error(v)}}})),this.treeDisposables.add(i.onDidChange(s=>{this.tree?.hasNode(s)&&this.tree?.rerender(s)}))}async resolveCommand(e){let i=e?.command;return e&&!i&&e instanceof ve&&e.hasResolve&&(await e.resolve(ie.None),i=e.command),i}onContextMenu(e,i,t){this.hoverService.hideHover();const r=i.element;if(r===null)return;const o=i.browserEvent;o.preventDefault(),o.stopPropagation(),this.tree.setFocus([r]);let a=this.canSelectMany?this.getSelection():[];a.find(c=>c.handle===r.handle)||(a=[r]);const d=e.getResourceContextActions(a);d.length&&this.contextMenuService.showContextMenu({getAnchor:()=>i.anchor,getActions:()=>d,getActionViewItem:c=>{const h=this.keybindingService.lookupKeybinding(c.id);if(h)return new Re(c,c,{label:!0,keybinding:h.getLabel()})},onHide:c=>{c&&this.tree.domFocus()},getActionsContext:()=>({$treeViewId:this.id,$treeItemHandle:r.handle}),actionRunner:t})}updateMessage(){this._message?this.showMessage(this._message):this.dataProvider?this.hideMessage():this.showMessage(St),this.updateContentAreas()}processMessage(e,i){const t=e.value.split(`
`),r=[];let o=!1;for(const d of t){const c=vt(d);if(c.nodes.length===1&&typeof c.nodes[0]!="string"){const h=c.nodes[0],s=document.createElement("div");s.classList.add("button-container");const m=new Tt(s,{title:h.title,secondary:o,supportIcons:!0,...yt});m.label=h.label,m.onDidClick(f=>{this.openerService.open(h.href,{allowCommands:!0})},null,i);const u=C.parse(h.href);if(u.scheme===ae.command){const f=Se(u.path);f&&(m.enabled=this.contextKeyService.contextMatchesRules(f),i.add(this.contextKeyService.onDidChangeContext(v=>{v.affectsSome(new Set(f.keys()))&&(m.enabled=this.contextKeyService.contextMatchesRules(f))})))}i.add(m),o=!0,r.push(s)}else{o=!1;const h=this.markdownRenderer.render(new ze(d,{isTrusted:e.isTrusted,supportThemeIcons:e.supportThemeIcons,supportHtml:e.supportHtml}));r.push(h.element),i.add(h)}}const a=document.createElement("div");a.classList.add("rendered-message");for(const d of r)g.isHTMLElement(d)?a.appendChild(d):a.appendChild(d.element);return a}showMessage(e){if(we(this._messageValue)&&this._messageValue.disposables.dispose(),oe(e)&&!this.markdownRenderer&&(this.markdownRenderer=this.instantiationService.createInstance(It,{})),oe(e)){const i=new se,t=this.processMessage(e,i);this._messageValue={element:t,disposables:i}}else this._messageValue=e;this.messageElement&&(this.messageElement.classList.remove("hide"),this.resetMessageElement(),typeof this._messageValue=="string"&&!We(this._messageValue)?this.messageElement.textContent=this._messageValue:we(this._messageValue)&&this.messageElement.appendChild(this._messageValue.element),this.layout(this._height,this._width))}hideMessage(){this.resetMessageElement(),this.messageElement?.classList.add("hide"),this.layout(this._height,this._width)}resetMessageElement(){this.messageElement&&g.clearNode(this.messageElement)}_height=0;_width=0;layout(e,i){if(e&&i&&this.messageElement&&this.treeContainer){this._height=e,this._width=i;const t=e-g.getTotalHeight(this.messageElement);this.treeContainer.style.height=t+"px",this.tree?.layout(t,i)}}getOptimalWidth(){if(this.tree){const e=this.tree.getHTMLElement(),i=[].slice.call(e.querySelectorAll(".outline-item-label > a"));return g.getLargestChildWidth(e,i)}return 0}updateCheckboxes(e){return De(e)}async refresh(e,i){if(this.dataProvider&&this.tree){this.refreshing&&await Oe.toPromise(this._onDidCompleteRefresh.event),e||(e=[this.root],this.elementsToRefresh=[]);for(const t of e)t.children=void 0;if(this.isVisible){const t=this.updateCheckboxes(i??[]);return this.doRefresh(e.concat(t))}else if(this.elementsToRefresh.length){const t=new Set;this.elementsToRefresh.forEach(r=>t.add(r.handle));for(const r of e)t.has(r.handle)||this.elementsToRefresh.push(r)}else this.elementsToRefresh.push(...e)}}async expand(e){const i=this.tree;if(i)try{e=Array.isArray(e)?e:[e];for(const t of e)await i.expand(t,!1)}catch{}}isCollapsed(e){return!!this.tree?.isCollapsed(e)}setSelection(e){this.tree?.setSelection(e)}getSelection(){return this.tree?.getSelection()??[]}setFocus(e){this.tree&&(e?(this.focus(!0,e),this.tree.setFocus([e])):this.tree.getFocus().length===0&&this.tree.setFocus([]))}async reveal(e){if(this.tree)return this.tree.reveal(e)}refreshing=!1;async doRefresh(e){const i=this.tree;if(i&&this.visible){this.refreshing=!0;const t=i.getSelection();try{await Promise.all(e.map(o=>i.updateChildren(o,!0,!0)))}catch(o){this.logService.error(o)}const r=i.getSelection();(t.length!==r.length||t.some((o,a)=>o.handle!==r[a].handle))&&(this.lastSelection=r,this._onDidChangeSelectionAndFocus.fire({selection:this.lastSelection,focus:this.lastActive})),this.refreshing=!1,this._onDidCompleteRefresh.fire(),this.updateContentAreas(),this.focused&&this.focus(!1),this.updateCollapseAllToggle()}}initializeCollapseAllToggle(){this.collapseAllToggleContext||(this.collapseAllToggleContextKey=new L(`treeView.${this.id}.toggleCollapseAll`,!1,x("treeView.toggleCollapseAll","Whether collapse all is toggled for the tree view with id {0}.",this.id)),this.collapseAllToggleContext=this.collapseAllToggleContextKey.bindTo(this.contextKeyService))}updateCollapseAllToggle(){this.showCollapseAllAction&&(this.initializeCollapseAllToggle(),this.collapseAllToggleContext?.set(!!this.root.children&&this.root.children.length>0&&this.root.children.some(e=>e.collapsibleState!==b.None)))}updateContentAreas(){const e=!this.root.children||this.root.children.length===0;this._messageValue&&e&&!this.refreshing&&this.treeContainer?(this.dragAndDropController||this.treeContainer.classList.add("hide"),this.domNode.setAttribute("tabindex","0")):this.treeContainer&&(this.treeContainer.classList.remove("hide"),this.domNode===g.getActiveElement()&&this.focus(),this.domNode.removeAttribute("tabindex"))}get container(){return this._container}};D=w([l(2,H),l(3,A),l(4,he),l(5,V),l(6,pe),l(7,J),l(8,j),l(9,X),l(10,Z),l(11,K),l(12,R),l(13,Te),l(14,q),l(15,Q)],D);class xt{getId(n){return n.handle}}class Dt{getHeight(n){return S.ITEM_HEIGHT}getTemplateId(n){return S.TREE_TEMPLATE_ID}}class At{constructor(n,e){this.treeView=n;this.withProgress=e}hasChildren(n){return!!this.treeView.dataProvider&&n.collapsibleState!==b.None}async getChildren(n){let e=[];if(this.treeView.dataProvider)try{e=await this.withProgress(this.treeView.dataProvider.getChildren(n))??[]}catch(i){if(!i.message.startsWith("Bad progress location:"))throw i}return e}}let S=class extends ${constructor(e,i,t,r,o,a,d,c,h,s,m,u,f){super();this.treeViewId=e;this.menus=i;this.labels=t;this.actionViewItemProvider=r;this.aligner=o;this.checkboxStateHandler=a;this.manuallyManageCheckboxes=d;this.themeService=c;this.configurationService=h;this.labelService=s;this.contextKeyService=m;this.hoverService=u;this._hoverDelegate=this._register(f.createInstance(ct,"mouse",!1,{})),this._register(this.themeService.onDidFileIconThemeChange(()=>this.rerender())),this._register(this.themeService.onDidColorThemeChange(()=>this.rerender())),this._register(a.onDidChangeCheckboxState(v=>{this.updateCheckboxes(v)})),this._register(this.contextKeyService.onDidChangeContext(v=>this.onDidChangeContext(v)))}static ITEM_HEIGHT=22;static TREE_TEMPLATE_ID="treeExplorer";_onDidChangeCheckboxState=this._register(new T);onDidChangeCheckboxState=this._onDidChangeCheckboxState.event;_onDidChangeMenuContext=this._register(new T);onDidChangeMenuContext=this._onDidChangeMenuContext.event;_actionRunner;_hoverDelegate;_hasCheckbox=!1;_renderedElements=new Map;get templateId(){return S.TREE_TEMPLATE_ID}set actionRunner(e){this._actionRunner=e}renderTemplate(e){e.classList.add("custom-view-tree-node-item");const i=g.append(e,g.$("")),t=this.labels.create(e,{supportHighlights:!0,hoverDelegate:this._hoverDelegate}),r=g.prepend(t.element,g.$(".custom-view-tree-node-item-icon")),o=g.append(t.element,g.$(".actions")),a=new ke(o,{actionViewItemProvider:this.actionViewItemProvider});return{resourceLabel:t,icon:r,checkboxContainer:i,actionBar:a,container:e}}getHover(e,i,t){return!(t instanceof ve)||!t.hasResolve?i&&!t.tooltip?void 0:t.tooltip===void 0?e:G(t.tooltip)?t.tooltip!==""?t.tooltip:void 0:{markdown:t.tooltip,markdownNotSupportedFallback:i?void 0:Ve(t.tooltip)}:{markdown:typeof t.tooltip=="string"?t.tooltip:r=>new Promise(o=>{t.resolve(r).then(()=>o(t.tooltip))}),markdownNotSupportedFallback:i?void 0:e??""}}renderElement(e,i,t){const r=e.element,o=r.resourceUri?C.revive(r.resourceUri):null,a=r.label?r.label:o?{label:le(o)}:void 0,d=G(r.description)?r.description:o&&r.description===!0?this.labelService.getUriLabel($e(o),{relative:!0}):void 0,c=a?a.label:void 0,h=a&&a.highlights&&c?a.highlights.map(([I,y])=>{if(I<0&&(I=c.length+I),y<0&&(y=c.length+y),I>=c.length||y>c.length)return{start:0,end:0};if(I>y){const U=I;I=y,y=U}return{start:I,end:y}}):void 0,s=this.themeService.getColorTheme().type===fe.LIGHT?r.icon:r.iconDark,m=s?C.revive(s):void 0,u=this.getHover(c,o,r);t.actionBar.clear(),t.icon.style.color="";let f=!0;if(r.command&&(f=Ce(r.command,this.contextKeyService)),this.renderCheckbox(r,t),o){const I=this.configurationService.getValue("explorer.decorations"),y=o||C.parse("missing:_icon_resource");t.resourceLabel.setResource({name:c,description:d,resource:y},{fileKind:this.getFileKind(r),title:u,hideIcon:this.shouldHideResourceLabelIcon(m,r.themeIcon),fileDecorations:I,extraClasses:["custom-view-tree-node-item-resourceLabel"],matches:h||ne(e.filterData),strikethrough:a?.strikethrough,disabledCommand:!f,labelEscapeNewLines:!0,forceLabel:!!r.label})}else t.resourceLabel.setResource({name:c,description:d},{title:u,hideIcon:!0,extraClasses:["custom-view-tree-node-item-resourceLabel"],matches:h||ne(e.filterData),strikethrough:a?.strikethrough,disabledCommand:!f,labelEscapeNewLines:!0});if(m)t.icon.className="custom-view-tree-node-item-icon",t.icon.style.backgroundImage=Me.asCSSUrl(m);else{let I;this.shouldShowThemeIcon(!!o,r.themeIcon)&&(I=tt.asClassName(r.themeIcon),r.themeIcon.color&&(t.icon.style.color=this.themeService.getColorTheme().getColor(r.themeIcon.color.id)?.toString()??"")),t.icon.className=I?`custom-view-tree-node-item-icon ${I}`:"",t.icon.style.backgroundImage=""}f||(t.icon.className=t.icon.className+" disabled",t.container.parentElement&&(t.container.parentElement.className=t.container.parentElement.className+" disabled")),t.actionBar.context={$treeViewId:this.treeViewId,$treeItemHandle:r.handle};const v=this.menus.getResourceActions([r]);t.actionBar.push(v,{icon:!0,label:!1}),this._actionRunner&&(t.actionBar.actionRunner=this._actionRunner),this.setAlignment(t.container,r);const z=this._renderedElements.get(e.element.handle)??[];this._renderedElements.set(e.element.handle,[...z,{original:e,rendered:t}])}rerender(){const e=new Set(this._renderedElements.keys());for(const i of e){const t=this._renderedElements.get(i)??[];for(const r of t)this.disposeElement(r.original,0,r.rendered),this.renderElement(r.original,0,r.rendered)}}renderCheckbox(e,i){if(e.checkbox){if(this._hasCheckbox||(this._hasCheckbox=!0,this.rerender()),!i.checkbox){const t=new be(i.checkboxContainer,this.checkboxStateHandler,this._hoverDelegate,this.hoverService);i.checkbox=t}i.checkbox.render(e)}else i.checkbox&&(i.checkbox.dispose(),i.checkbox=void 0)}setAlignment(e,i){e.parentElement.classList.toggle("align-icon-with-twisty",!this._hasCheckbox&&this.aligner.alignIconWithTwisty(i))}shouldHideResourceLabelIcon(e,i){return!!e||!!i&&!this.isFileKindThemeIcon(i)}shouldShowThemeIcon(e,i){return i?!(e&&this.isFileKindThemeIcon(i)):!1}isFolderThemeIcon(e){return e?.id===Y.id}isFileKindThemeIcon(e){return e?e.id===ge.id||this.isFolderThemeIcon(e):!1}getFileKind(e){if(e.themeIcon)switch(e.themeIcon.id){case ge.id:return P.FILE;case Y.id:return P.FOLDER}return e.collapsibleState===b.Collapsed||e.collapsibleState===b.Expanded?P.FOLDER:P.FILE}onDidChangeContext(e){const i=[];for(const[t,r]of this._renderedElements)for(const o of r)(e.affectsSome(this.menus.getElementOverlayContexts(o.original.element))||e.affectsSome(this.menus.getEntireMenuContexts()))&&i.push(o.original.element);i.length&&this._onDidChangeMenuContext.fire(i)}updateCheckboxes(e){let i=[];this.manuallyManageCheckboxes()||(i=De(e)),i.forEach(t=>{const r=this._renderedElements.get(t.handle);r&&r.forEach(o=>o.rendered.checkbox?.render(t))}),this._onDidChangeCheckboxState.fire(i)}disposeElement(e,i,t){const r=this._renderedElements.get(e.element.handle)??[],o=r.findIndex(a=>t===a.rendered);r.length===1?this._renderedElements.delete(e.element.handle):r.length>0&&r.splice(o,1),t.checkbox?.dispose(),t.checkbox=void 0}disposeTemplate(e){e.resourceLabel.dispose(),e.actionBar.dispose()}};S=w([l(7,H),l(8,V),l(9,me),l(10,R),l(11,K),l(12,A)],S);class _t extends ${constructor(e){super();this.themeService=e}_tree;set tree(e){this._tree=e}alignIconWithTwisty(e){if(e.collapsibleState!==b.None||!this.hasIcon(e))return!1;if(this._tree){const i=this._tree.getParentElement(e)||this._tree.getInput();return this.hasIcon(i)?!!i.children&&i.children.some(t=>t.collapsibleState!==b.None&&!this.hasIcon(t)):!!i.children&&i.children.every(t=>t.collapsibleState===b.None||!this.hasIcon(t))}else return!1}hasIcon(e){if(this.themeService.getColorTheme().type===fe.LIGHT?e.icon:e.iconDark)return!0;if(e.resourceUri||e.themeIcon){const t=this.themeService.getFileIconTheme();return(e.themeIcon?e.themeIcon.id===Y.id:e.collapsibleState!==b.None)?t.hasFileIcons&&t.hasFolderIcons:t.hasFileIcons}return!1}}class xe extends He{constructor(e,i){super();this.getSelectedResources=i;this._register(this.onDidRun(t=>{t.error&&!Ne(t.error)&&e.error(x("command-error","Error running command {1}: {0}. This is likely caused by the extension that contributes {1}.",t.error.message,t.action.id))}))}async runAction(e,i){const t=this.getSelectedResources();let r,o=!1;t.length>1&&(r=t.map(a=>((a.handle===i.$treeItemHandle||i.$selectedTreeItems)&&(o=!0),{$treeViewId:i.$treeViewId,$treeItemHandle:a.handle}))),!o&&r&&(r=void 0),await e.run(i,r)}}let _=class{constructor(n,e){this.id=n;this.menuService=e}contextKeyService;_onDidChange=new T;onDidChange=this._onDidChange.event;getResourceActions(n){return this.getActions(this.getMenuId(),n).primary}getResourceContextActions(n){return this.getActions(this.getMenuId(),n).secondary}setContextKeyService(n){this.contextKeyService=n}filterNonUniversalActions(n,e){const i=new Set(e.map(t=>t.id));for(const t of n){const r=t.keys();for(const o of r)i.has(o)||t.delete(o)}}buildMenu(n){const e=[];for(const i of n)i.size>0&&(e.length&&e.push(new te),e.push(...i.values()));return e}createGroups(n){const e=[];let i=new Map;for(const t of n)t instanceof te?(e.push(i),i=new Map):i.set(t.id,t);return e.push(i),e}getElementOverlayContexts(n){return new Map([["view",this.id],["viewItem",n.contextValue]])}getEntireMenuContexts(){return this.menuService.getMenuContexts(this.getMenuId())}getMenuId(){return M.ViewItemContext}getActions(n,e){if(!this.contextKeyService)return{primary:[],secondary:[]};let i=[],t=[];for(let r=0;r<e.length;r++){const o=e[r],a=this.contextKeyService.createOverlay(this.getElementOverlayContexts(o)),d=this.menuService.getMenuActions(n,a,{shouldForwardArgs:!0}),s={primary:[],secondary:[]};qe(d,s,"inline"),r===0?(i=this.createGroups(s.primary),t=this.createGroups(s.secondary)):(this.filterNonUniversalActions(i,s.primary),this.filterNonUniversalActions(t,s.secondary))}return{primary:this.buildMenu(i),secondary:this.buildMenu(t)}}dispose(){this.contextKeyService=void 0}};_=w([l(1,Xe)],_);let O=class extends D{constructor(e,i,t,r,o,a,d,c,h,s,m,u,f,v,z,I,y,U,Ae){super(e,i,r,o,a,d,c,h,s,m,u,v,f,I,U,Ae);this.extensionId=t;this.extensionService=z;this.telemetryService=y}activate(){this.activated||(this.telemetryService.publicLog2("Extension:ViewActivate",{extensionId:new ft(this.extensionId),id:this.id}),this.createTree(),this.progressService.withProgress({location:this.id},()=>this.extensionService.activateByEvent(`onView:${this.id}`)).then(()=>Ke(2e3)).then(()=>{this.updateMessage()}),this.activated=!0)}};O=w([l(3,H),l(4,A),l(5,he),l(6,V),l(7,pe),l(8,J),l(9,j),l(10,X),l(11,Z),l(12,R),l(13,K),l(14,dt),l(15,Te),l(16,ue),l(17,q),l(18,Q)],O);class kr extends D{activate(){this.activated||(this.createTree(),this.activated=!0)}}let E=class{constructor(n,e,i,t,r){this.treeId=n;this.labelService=e;this.instantiationService=i;this.treeViewsDragAndDropService=t;this.logService=r;this.treeMimeType=`application/vnd.code.tree.${n.toLowerCase()}`}treeMimeType;treeItemsTransfer=mt.getInstance();dragCancellationToken;dndController;set controller(n){this.dndController=n}handleDragAndLog(n,e,i,t){return n.handleDrag(e,i,t).then(r=>{if(r){const o=[];for(const a of r)a[0]!==this.treeMimeType&&n.dragMimeTypes.findIndex(d=>d===a[0])<0&&o.push(a[0]);o.length&&this.logService.warn(`Drag and drop controller for tree ${this.treeId} adds the following data transfer types but does not declare them in dragMimeTypes: ${o.join(", ")}`)}return r})}addExtensionProvidedTransferTypes(n,e){if(!n.dataTransfer||!this.dndController)return;const i=Ge();this.dragCancellationToken=new Fe,this.treeViewsDragAndDropService.addDragOperationTransfer(i,this.handleDragAndLog(this.dndController,e,i,this.dragCancellationToken.token)),this.treeItemsTransfer.setData([new F(i)],F.prototype),n.dataTransfer.clearData(W.text),this.dndController.dragMimeTypes.find(t=>t===W.uriList)&&n.dataTransfer?.setData(B.RESOURCES,""),this.dndController.dragMimeTypes.forEach(t=>{n.dataTransfer?.setData(t,"")})}addResourceInfoToTransfer(n,e){if(e.length&&n.dataTransfer){this.instantiationService.invokeFunction(t=>it(t,e,n));const i=e.filter(t=>t.scheme===ae.file).map(t=>t.fsPath);i.length&&n.dataTransfer.setData(ht.FILES,JSON.stringify(i))}}onDragStart(n,e){if(e.dataTransfer){const i=n.getData(),t=[],r={id:this.treeId,itemHandles:[]};i.forEach(o=>{r.itemHandles.push(o.handle),o.resourceUri&&t.push(C.revive(o.resourceUri))}),this.addResourceInfoToTransfer(e,t),this.addExtensionProvidedTransferTypes(e,r.itemHandles),e.dataTransfer.setData(this.treeMimeType,JSON.stringify(r))}}debugLog(n){n.size?this.logService.debug(`TreeView dragged mime types: ${Array.from(n).join(", ")}`):this.logService.debug("TreeView dragged with no supported mime types.")}onDragOver(n,e,i,t,r){const o=ye(r.dataTransfer),a=new Set(Array.from(o,h=>h[0]));if(r.dataTransfer){for(const h of r.dataTransfer.items)if(h.kind==="file"||h.type===B.RESOURCES.toLowerCase()){a.add(W.uriList);break}}this.debugLog(a);const d=this.dndController;return!d||!r.dataTransfer||d.dropMimeTypes.length===0?!1:Array.from(a).some((h,s)=>h===this.treeMimeType?!0:d.dropMimeTypes.indexOf(h)>=0)?{accept:!0,bubble:Le.Down,autoExpand:!0}:!1}getDragURI(n){return this.dndController?n.resourceUri?C.revive(n.resourceUri).toString():n.handle:null}getDragLabel(n){if(!this.dndController)return;if(n.length>1)return String(n.length);const e=n[0];return e.label?e.label.label:e.resourceUri?this.labelService.getUriLabel(C.revive(e.resourceUri)):void 0}async drop(n,e,i,t,r){const o=this.dndController;if(!r.dataTransfer||!o)return;let a,d;this.treeItemsTransfer.hasData(F.prototype)&&(d=this.treeItemsTransfer.getData(F.prototype)[0].identifier);const c=ye(r.dataTransfer,!0),h=new Je;for(const[m,u]of c)if((m===this.treeMimeType||o.dropMimeTypes.includes(m)||u.asFile()&&o.dropMimeTypes.includes(B.FILES.toLowerCase()))&&(h.append(m,u),m===this.treeMimeType))try{a=JSON.parse(await u.asString())}catch{}const s=await this.treeViewsDragAndDropService.removeDragOperationTransfer(d);if(s)for(const[m,u]of s)h.append(m,u);return o.handleDrop(h,e,ie.None,d,a?.id,a?.itemHandles)}onDragEnd(n){n.dataTransfer?.dropEffect==="none"&&this.dragCancellationToken?.cancel()}dispose(){}};E=w([l(1,me),l(2,A),l(3,gt),l(4,q)],E);function De(p){const n=[];for(const e of p)if(e.checkbox!==void 0){const i=o=>{for(const a of o.children??[])a.checkbox!==void 0&&o.checkbox!==void 0&&a.checkbox.isChecked!==o.checkbox.isChecked&&(a.checkbox.isChecked=o.checkbox.isChecked,n.push(a),i(a))};i(e);const t=new Set,r=o=>{if(o.parent&&o.parent.checkbox!==void 0&&o.parent.children){if(t.has(o.parent))return;t.add(o.parent);let a=!1,d=!1;for(const c of o.parent.children){if(a&&d)break;c.checkbox!==void 0&&(c.checkbox.isChecked?d=!0:a=!0)}d&&!a&&o.parent.checkbox.isChecked!==!0?(o.parent.checkbox.isChecked=!0,n.push(o.parent),r(o.parent)):a&&o.parent.checkbox.isChecked!==!1&&(o.parent.checkbox.isChecked=!1,n.push(o.parent),r(o.parent))}};r(e)}return p.concat(n)}export{O as CustomTreeView,E as CustomTreeViewDragAndDrop,Ct as RawCustomTreeViewContextKey,kr as TreeView,N as TreeViewPane};
