import{CancellationToken as ee}from"../../../../../base/common/cancellation.js";import{Codicon as P}from"../../../../../base/common/codicons.js";import{KeyCode as te,KeyMod as ie}from"../../../../../base/common/keyCodes.js";import{Schemas as x}from"../../../../../base/common/network.js";import{isElectron as oe}from"../../../../../base/common/platform.js";import{compare as ne}from"../../../../../base/common/strings.js";import{ThemeIcon as m}from"../../../../../base/common/themables.js";import{URI as H}from"../../../../../base/common/uri.js";import"../../../../../editor/browser/editorExtensions.js";import"../../../../../editor/common/core/range.js";import{EditorType as K}from"../../../../../editor/common/editorCommon.js";import"../../../../../editor/common/languages.js";import{AbstractGotoSymbolQuickAccessProvider as re}from"../../../../../editor/contrib/quickAccess/browser/gotoSymbolQuickAccess.js";import{localize as g,localize2 as R}from"../../../../../nls.js";import{Action2 as V,MenuId as A,registerAction2 as F}from"../../../../../platform/actions/common/actions.js";import{IClipboardService as ae}from"../../../../../platform/clipboard/common/clipboardService.js";import{ICommandService as ce}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as se}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as h,IContextKeyService as le}from"../../../../../platform/contextkey/common/contextkey.js";import{KeybindingWeight as ue}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{ILabelService as me}from"../../../../../platform/label/common/label.js";import"../../../../../platform/quickinput/common/quickAccess.js";import{IQuickInputService as de}from"../../../../../platform/quickinput/common/quickInput.js";import{ActiveEditorContext as j}from"../../../../common/contextkeys.js";import{IEditorService as _}from"../../../../services/editor/common/editorService.js";import{IHostService as Ie}from"../../../../services/host/browser/host.js";import{VIEW_ID as ke}from"../../../../services/search/common/search.js";import{IViewsService as D}from"../../../../services/views/common/viewsService.js";import{AnythingQuickAccessProvider as fe}from"../../../search/browser/anythingQuickAccess.js";import"../../../search/browser/searchView.js";import{SymbolsQuickAccessProvider as M}from"../../../search/browser/symbolsQuickAccess.js";import{SearchContext as he}from"../../../search/common/constants.js";import{ChatAgentLocation as d,IChatAgentService as pe}from"../../common/chatAgents.js";import{CONTEXT_CHAT_LOCATION as y,CONTEXT_IN_CHAT_INPUT as ge}from"../../common/chatContextKeys.js";import{IChatEditingService as be}from"../../common/chatEditingService.js";import"../../common/chatModel.js";import{ChatRequestAgentPart as $}from"../../common/chatParserTypes.js";import{IChatVariablesService as W}from"../../common/chatVariables.js";import{ILanguageModelToolsService as Ce}from"../../common/languageModelToolsService.js";import{IChatWidgetService as Se,IQuickChatService as ve,showChatView as X}from"../chat.js";import{imageToHash as B,isImage as Pe}from"../chatPasteProviders.js";import{isQuickChat as ye}from"../chatWidget.js";import{convertBufferToScreenshotVariable as Qe,ScreenshotVariableId as xe}from"../contrib/screenshot.js";import{CHAT_CATEGORY as q}from"./chatActions.js";function Dt(){F(T),F(O),F(L)}function Ee(r){return typeof r=="object"&&typeof r.symbolName=="string"&&!!r.uri&&!!r.range}function we(r){return typeof r=="object"&&typeof r.symbol=="object"&&!!r.symbol}function Te(r){return typeof r=="object"&&typeof r.resource=="object"&&H.isUri(r.resource)}function z(r){return typeof r=="object"&&r.id==="open-editors"}function Ae(r){return typeof r=="object"&&r.kind==="search-results"}function Ne(r){return typeof r=="object"&&r.kind==="screenshot"}class O extends V{static ID="workbench.action.chat.attachFile";constructor(){super({id:O.ID,title:R("workbench.action.chat.attachFile.label","Add File to Chat"),category:q,f1:!1,precondition:j.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:A.ChatCommandCenter,group:"a_chat",order:10}})}async run(t,...Q){const I=t.get(W),l=t.get(_),u=l.activeEditor?.resource;l.activeTextEditorControl?.getEditorType()===K.ICodeEditor&&u&&[x.file,x.vscodeRemote,x.untitled].includes(u.scheme)&&((await X(t.get(D)))?.focusInput(),I.attachContext("file",u,d.Panel))}}class L extends V{static ID="workbench.action.chat.attachSelection";constructor(){super({id:L.ID,title:R("workbench.action.chat.attachSelection.label","Add Selection to Chat"),category:q,f1:!1,precondition:j.isEqualTo("workbench.editors.files.textFileEditor"),menu:{id:A.ChatCommandCenter,group:"a_chat",order:11}})}async run(t,...Q){const I=t.get(W),l=t.get(_),u=l.activeTextEditorControl,p=l.activeEditor?.resource;if(l.activeTextEditorControl?.getEditorType()===K.ICodeEditor&&p&&[x.file,x.vscodeRemote,x.untitled].includes(p.scheme)){const s=u?.getSelection();s&&((await X(t.get(D)))?.focusInput(),I.attachContext("file",{uri:p,range:s},d.Panel))}}}class T extends V{static ID="workbench.action.chat.attachContext";static _cdt=h.or(h.and(y.isEqualTo(d.Panel)),h.and(y.isEqualTo(d.Editor)),h.and(y.isEqualTo(d.Notebook)),h.and(y.isEqualTo(d.Terminal)));constructor(){super({id:T.ID,title:R("workbench.action.chat.attachContext.label","Attach Context"),icon:P.attach,category:q,precondition:h.or(T._cdt,h.and(y.isEqualTo(d.EditingSession))),keybinding:{when:ge,primary:ie.CtrlCmd|te.Slash,weight:ue.EditorContrib},menu:[{when:h.or(h.and(y.isEqualTo(d.EditingSession)),h.and(h.or(y.isEqualTo(d.Panel),y.isEqualTo(d.EditingSession)),T._cdt)),id:A.ChatInput,group:"navigation",order:2},{when:h.and(y.isEqualTo(d.Panel).negate(),T._cdt),id:A.ChatExecute,group:"navigation",order:1}]})}_getFileContextId(t){return"resource"in t?t.resource.toString():t.uri.toString()+(t.range.startLineNumber!==t.range.endLineNumber?`:${t.range.startLineNumber}-${t.range.endLineNumber}`:`:${t.range.startLineNumber}`)}async _attachContext(t,Q,I,l,u,p,s,E,...w){const a=[];for(const e of w)if(we(e)&&e.symbol)a.push({id:this._getFileContextId(e.symbol.location),value:e.symbol.location,fullName:e.label,name:e.symbol.name,isDynamic:!0});else if(Te(e)&&e.resource)/\.(png|jpg|jpeg|bmp|gif|tiff)$/i.test(e.resource.path)?a.push({id:e.resource.toString(),name:e.label,fullName:e.label,value:e.resource,isDynamic:!0,isImage:!0}):s?s.addFileToWorkingSet(e.resource):a.push({id:this._getFileContextId({resource:e.resource}),value:e.resource,name:e.label,isFile:!0,isDynamic:!0});else if(Ee(e)&&e.uri&&e.range)a.push({range:void 0,id:this._getFileContextId({uri:e.uri,range:e.range.decoration}),value:{uri:e.uri,range:e.range.decoration},fullName:e.label,name:e.symbolName,isDynamic:!0});else if(z(e))for(const i of l.editors)i.resource&&(s?s.addFileToWorkingSet(i.resource):a.push({id:this._getFileContextId({resource:i.resource}),value:i.resource,name:u.getUriBasenameLabel(i.resource),isFile:!0,isDynamic:!0}));else if(Ae(e)){const i=p.getViewWithId(ke);for(const c of i.model.searchResult.matches())s?s.addFileToWorkingSet(c.resource):a.push({id:this._getFileContextId({resource:c.resource}),value:c.resource,name:u.getUriBasenameLabel(c.resource),isFile:!0,isDynamic:!0})}else if(Ne(e)){const i=await E.getScreenshot();i&&a.push(Qe(i))}else{const i=e;if(i.kind==="command"){const c=await Q.executeCommand(i.command.id,...i.command.arguments??[]);if(!c)continue;a.push({...i,isDynamic:i.isDynamic,value:i.value,name:`${typeof i.value=="string"&&i.value.startsWith("#")?i.value.slice(1):""}${c}`,fullName:c})}else if(i.kind==="tool")a.push({id:i.id,name:i.label,fullName:i.label,value:void 0,icon:i.icon,isTool:!0});else if(i.kind==="image"){const c=await I.readImage();a.push({id:await B(c),name:g("pastedImage","Pasted Image"),fullName:g("pastedImage","Pasted Image"),value:c,isDynamic:!0,isImage:!0})}else i.kind==="variable"&&a.push({range:void 0,id:e.id??"",value:void 0,fullName:e.label,name:i.variable.name,icon:i.variable.icon})}t.attachmentModel.addContext(...a)}async run(t,...Q){const I=t.get(de),l=t.get(pe),u=t.get(W),p=t.get(ce),s=t.get(Se),E=t.get(Ce),w=t.get(ve),a=t.get(ae),e=t.get(se),i=t.get(_),c=t.get(me),N=t.get(le),n=t.get(D),S=t.get(Ie),b=Q[0],v=b?.widget??s.lastFocusedWidget;if(!v)return;const Y=v.location===d.EditingSession?t.get(be):void 0,U=v.parsedInput.parts.find(o=>o instanceof $),J=U?U.agent.metadata.supportsSlowVariables:!0,C=[];if(!b||!b.showFilesOnly){for(const o of u.getVariables(v.location))o.fullName&&(!o.isSlow||J)&&C.push({kind:"variable",variable:o,label:o.fullName,id:o.id,iconClass:o.icon?m.asClassName(o.icon):void 0});if(e.getValue("chat.experimental.imageAttachments")){const o=await a.readImage();Pe(o)&&C.push({kind:"image",id:await B(o),label:g("imageFromClipboard","Image from Clipboard"),iconClass:m.asClassName(P.fileMedia)})}if(v.viewModel?.sessionId){const o=v.parsedInput.parts.find(k=>k instanceof $);if(o){const k=await l.getAgentCompletionItems(o.agent.id,"",ee.None);for(const f of k)f.fullName&&f.command&&C.push({kind:"command",label:f.fullName,id:f.id,command:f.command,icon:f.icon,iconClass:f.icon?m.asClassName(f.icon):void 0,value:f.value,isDynamic:!0,name:f.name})}}for(const o of E.getTools())if(o.canBeReferencedInPrompt){const k={kind:"tool",label:o.displayName??"",id:o.id,icon:m.isThemeIcon(o.icon)?o.icon:void 0};m.isThemeIcon(o.icon)?k.iconClass=m.asClassName(o.icon):o.icon&&(k.iconPath=o.icon),C.push(k)}C.push({kind:"quickaccess",label:g("chatContext.symbol","Symbol..."),iconClass:m.asClassName(P.symbolField),prefix:M.PREFIX,id:"symbol"}),e.getValue("chat.experimental.imageAttachments")&&C.push({kind:"screenshot",id:xe,icon:m.fromId(P.deviceCamera.id),iconClass:m.asClassName(P.deviceCamera),label:oe?g("chatContext.attachScreenshot.labelElectron.Window","Screenshot Window"):g("chatContext.attachScreenshot.labelWeb","Screenshot")}),v.location===d.Notebook&&C.push({kind:"command",id:"chatContext.notebook.kernelVariable",isDynamic:!0,icon:m.fromId(P.serverEnvironment.id),iconClass:m.asClassName(P.serverEnvironment),value:"kernelVariable",label:g("chatContext.notebook.kernelVariable","Kernel Variable..."),command:{id:"notebook.chat.selectAndInsertKernelVariable",title:g("chatContext.notebook.selectkernelVariable","Select and Insert Kernel Variable"),arguments:[{widget:v,range:void 0}]}})}else b.showFilesOnly&&(i.count>0&&C.push({kind:"open-editors",id:"open-editors",label:g("chatContext.editors","Open Editors"),iconClass:m.asClassName(P.files)}),he.HasSearchResults.getValue(N)&&C.push({kind:"search-results",id:"search-results",label:g("chatContext.searchResults","Search Results"),iconClass:m.asClassName(P.search)}));function G(o){if(!o)return"";const k=o.match(/\$\([^\)]+\)\s*(.+)/);return k?k[1]:o}this._show(I,p,v,w,C.sort(function(o,k){const f=G(o.label).toUpperCase(),Z=G(k.label).toUpperCase();return ne(f,Z)}),a,i,c,n,Y,S,"",b?.placeholder)}_show(t,Q,I,l,u,p,s,E,w,a,e,i="",c){const N={handleAccept:n=>{if("prefix"in n)this._show(t,Q,I,l,u,p,s,E,w,a,e,n.prefix,c);else{if(!p)return;this._attachContext(I,Q,p,s,E,w,a,e,n),ye(I)&&l.open()}},additionPicks:u,filter:n=>{const S=I.attachmentModel.getAttachmentIDs();if(a)for(const b of a.currentEditingSessionObs.get()?.workingSet.keys()??[])S.add(this._getFileContextId({resource:b}));if(z(n)){for(const b of s.editors)if(b.resource&&!S.has(this._getFileContextId({resource:b.resource})))return!0;return!1}return"kind"in n&&n.kind==="image"?!S.has(n.id):"symbol"in n&&n.symbol?!S.has(this._getFileContextId(n.symbol.location)):n&&typeof n=="object"&&"resource"in n&&H.isUri(n.resource)?[x.file,x.vscodeRemote].includes(n.resource.scheme)&&!S.has(this._getFileContextId({resource:n.resource})):n&&typeof n=="object"&&"uri"in n&&n.uri&&n.range?!S.has(this._getFileContextId({uri:n.uri,range:n.range.decoration})):!("command"in n)&&n.id?!S.has(n.id):!0}};t.quickAccess.show(i,{enabledProviderPrefixes:[fe.PREFIX,M.PREFIX,re.PREFIX],placeholder:c??g("chatContext.attach.placeholder","Search attachments"),providerOptions:N})}}export{T as AttachContextAction,Dt as registerChatContextActions};
