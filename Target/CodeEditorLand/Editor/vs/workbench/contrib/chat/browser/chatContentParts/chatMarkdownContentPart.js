var q=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var b=(m,n,e,o)=>{for(var t=o>1?void 0:o?W(n,e):n,i=m.length-1,s;i>=0;i--)(s=m[i])&&(t=(o?s(n,e,t):s(t))||t);return o&&t&&q(n,e,t),t},a=(m,n)=>(e,o)=>n(e,o,m);import*as C from"../../../../../base/browser/dom.js";import{Codicon as z}from"../../../../../base/common/codicons.js";import{Emitter as G}from"../../../../../base/common/event.js";import"../../../../../base/common/htmlContent.js";import{Disposable as D}from"../../../../../base/common/lifecycle.js";import{equalsIgnoreCase as J}from"../../../../../base/common/strings.js";import{ThemeIcon as j}from"../../../../../base/common/themables.js";import"../../../../../base/common/uri.js";import"../../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{Range as Q}from"../../../../../editor/common/core/range.js";import{ILanguageService as X}from"../../../../../editor/common/languages/language.js";import{getIconClasses as Y}from"../../../../../editor/common/services/getIconClasses.js";import{IModelService as Z}from"../../../../../editor/common/services/model.js";import{ITextModelService as ee}from"../../../../../editor/common/services/resolverService.js";import{MenuId as oe}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as te}from"../../../../../platform/contextkey/common/contextkey.js";import{FileKind as E}from"../../../../../platform/files/common/files.js";import{IInstantiationService as H}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as re}from"../../../../../platform/label/common/label.js";import{IEditorService as ie}from"../../../../services/editor/common/editorService.js";import"../../common/annotations.js";import"../../common/chatModel.js";import{isRequestVM as ne,isResponseVM as f}from"../../common/chatViewModel.js";import"../../common/codeBlockModelCollection.js";import"../chat.js";import"../chatListRenderer.js";import{ChatMarkdownDecorationsRenderer as se}from"../chatMarkdownDecorationsRenderer.js";import"../chatOptions.js";import{CodeBlockPart as T,localFileLanguageId as le,parseLocalFileData as de}from"../codeBlockPart.js";import"../media/chatCodeBlockPill.css";import{ResourcePool as ae}from"./chatCollections.js";import"./chatContentParts.js";const O=C.$;let u=class extends D{constructor(e,o,t,i=!1,s=0,p,v,ce,S,F,pe,K){super();this.markdown=e;this.editorPool=t;this.codeBlockModelCollection=ce;this.rendererOptions=S;this.textModelService=pe;this.instantiationService=K;const l=o.element,V=K.createInstance(se),R=[];let $=s;const x=this._register(p.render(e,{fillInIncompleteTokens:i,codeBlockRendererSync:(I,y,P)=>{const w=!f(o.element)||o.element.isComplete||!P||P?.endsWith("```"),g=$++;let B,U,_,L;if(J(I,le))try{const r=de(y);U=r.range&&Q.lift(r.range),B=this.textModelService.createModelReference(r.uri).then(d=>d.object)}catch{return O("div")}else{const r=f(l)||ne(l)?l.sessionId:"",d=this.codeBlockModelCollection.getOrCreate(r,l,g);_=d.vulns,L=d.codemapperUri,B=d.model}const A=f(l)&&l.errorDetails?.responseIsFiltered,c={languageId:I,textModel:B,codeBlockIndex:g,element:l,range:U,hideToolbar:A,parentContextKeyService:F,vulns:_,codemapperUri:L};if(S.renderCodeBlockPills){const r=this.renderCodeBlockPill(c.codemapperUri,w);f(c.element)&&this.codeBlockModelCollection.update(c.element.sessionId,c.element,c.codeBlockIndex,{text:y,languageId:c.languageId}).then(N=>{this.codeblocks[c.codeBlockIndex].codemapperUri=N.codemapperUri,this._onDidChangeHeight.fire()}),this.allRefs.push(r);const d=this.id,M=new class{ownerMarkdownPartId=d;codeBlockIndex=g;element=l;isStreaming=!w;codemapperUri=void 0;get uri(){}focus(){return r.object.element.focus()}getContent(){return""}};return this.codeblocks.push(M),R.push(r),r.object.element}else{const r=this.renderCodeBlock(c,y,v,S.editableCodeBlock);this.allRefs.push(r),this._register(r.object.onDidChangeContentHeight(()=>this._onDidChangeHeight.fire()));const d=this.id,M=new class{ownerMarkdownPartId=d;codeBlockIndex=g;element=l;isStreaming=!S.renderCodeBlockPills;codemapperUri=void 0;get uri(){return r.object.uri}focus(){r.object.focus()}getContent(){return r.object.editor.getValue()}};return this.codeblocks.push(M),R.push(r),r.object.element}},asyncRenderCallback:()=>this._onDidChangeHeight.fire()}));this._register(V.walkTreeAndAnnotateReferenceLinks(x.element)),R.reverse().forEach(I=>this._register(I)),this.domNode=x.element}static idPool=0;id=String(++u.idPool);domNode;allRefs=[];_onDidChangeHeight=this._register(new G);onDidChangeHeight=this._onDidChangeHeight.event;codeblocks=[];renderCodeBlockPill(e,o){const t=this.instantiationService.createInstance(h);return e&&t.render(e,!o),{object:t,isStale:()=>!1,dispose:()=>t.dispose()}}renderCodeBlock(e,o,t,i){const s=this.editorPool.get(),p=s.object;return f(e.element)&&this.codeBlockModelCollection.update(e.element.sessionId,e.element,e.codeBlockIndex,{text:o,languageId:e.languageId}).then(v=>{this.codeblocks[e.codeBlockIndex].codemapperUri=v.codemapperUri,this._onDidChangeHeight.fire()}),p.render(e,t,i),s}hasSameContent(e){return e.kind==="markdownContent"&&!!(e.content.value===this.markdown.value||this.rendererOptions.renderCodeBlockPills&&this.codeblocks.at(-1)?.isStreaming&&this.codeblocks.at(-1)?.codemapperUri!==void 0&&e.content.value.lastIndexOf("```")===this.markdown.value.lastIndexOf("```"))}layout(e){this.allRefs.forEach((o,t)=>{if(o.object instanceof T)o.object.layout(e);else if(o.object instanceof h){const i=this.codeblocks[t];i.codemapperUri&&o.object.uri?.toString()!==i.codemapperUri.toString()&&o.object.render(i.codemapperUri,i.isStreaming)}})}addDisposable(e){this._register(e)}};u=b([a(9,te),a(10,ee),a(11,H)],u);let k=class extends D{_pool;inUse(){return this._pool.inUse}constructor(n,e,o,t){super(),this._pool=this._register(new ae(()=>t.createInstance(T,n,oe.ChatCodeBlock,e,o)))}get(){const n=this._pool.get();let e=!1;return{object:n,isStale:()=>e,dispose:()=>{n.reset(),e=!0,this._pool.release(n)}}}};k=b([a(3,H)],k);let h=class extends D{constructor(e,o,t,i){super();this.labelService=e;this.editorService=o;this.modelService=t;this.languageService=i;this.element=O(".chat-codeblock-pill-widget"),this.element.classList.add("show-file-icons"),this._register(C.addDisposableListener(this.element,"click",()=>{this.uri&&this.editorService.openEditor({resource:this.uri})}))}element;_uri;get uri(){return this._uri}isStreaming;render(e,o){if(this.uri?.toString()===e.toString()&&this.isStreaming===o)return;this._uri=e,this.isStreaming=o;const t=this.labelService.getUriBasenameLabel(e);let i=[];if(o){const p=j.modify(z.loading,"spin");i=j.asClassNameArray(p)}else{const p=e.path.endsWith("/")?E.FOLDER:E.FILE;i=Y(this.modelService,this.languageService,e,p)}const s=C.$("span.icon");s.classList.add(...i),this.element.replaceChildren(s,C.$("span.icon-label",{},t))}};h=b([a(0,re),a(1,ie),a(2,Z),a(3,X)],h);export{u as ChatMarkdownContentPart,k as EditorPool};
