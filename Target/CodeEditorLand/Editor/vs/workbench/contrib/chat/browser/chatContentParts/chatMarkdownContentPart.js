var Q=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var y=(m,l,e,o)=>{for(var r=o>1?void 0:o?X(l,e):l,i=m.length-1,n;i>=0;i--)(n=m[i])&&(r=(o?n(l,e,r):n(r))||r);return o&&r&&Q(l,e,r),r},d=(m,l)=>(e,o)=>l(e,o,m);import*as R from"../../../../../base/browser/dom.js";import{Codicon as Y}from"../../../../../base/common/codicons.js";import{Emitter as Z}from"../../../../../base/common/event.js";import{Disposable as P}from"../../../../../base/common/lifecycle.js";import{basename as ee}from"../../../../../base/common/resources.js";import{equalsIgnoreCase as oe}from"../../../../../base/common/strings.js";import{ThemeIcon as T}from"../../../../../base/common/themables.js";import"../../../../../base/common/uri.js";import{isCodeEditor as te}from"../../../../../editor/browser/editorBrowser.js";import"../../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{Range as re}from"../../../../../editor/common/core/range.js";import{ILanguageService as ie}from"../../../../../editor/common/languages/language.js";import{getIconClasses as ne}from"../../../../../editor/common/services/getIconClasses.js";import{IModelService as se}from"../../../../../editor/common/services/model.js";import{ITextModelService as le}from"../../../../../editor/common/services/resolverService.js";import{localize as de}from"../../../../../nls.js";import{MenuId as ae}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as ce}from"../../../../../platform/contextkey/common/contextkey.js";import{EditorActivation as pe}from"../../../../../platform/editor/common/editor.js";import{FileKind as H}from"../../../../../platform/files/common/files.js";import{IInstantiationService as q}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as me}from"../../../../../platform/label/common/label.js";import{IEditorService as he}from"../../../../services/editor/common/editorService.js";import"../../common/annotations.js";import{IChatEditingService as ue}from"../../common/chatEditingService.js";import"../../common/chatModel.js";import{IChatService as Ie}from"../../common/chatService.js";import{isRequestVM as O,isResponseVM as u}from"../../common/chatViewModel.js";import"../../common/codeBlockModelCollection.js";import"../chat.js";import"../chatListRenderer.js";import{ChatMarkdownDecorationsRenderer as fe}from"../chatMarkdownDecorationsRenderer.js";import"../chatOptions.js";import{CodeBlockPart as A,localFileLanguageId as ge,parseLocalFileData as Ce}from"../codeBlockPart.js";import"../media/chatCodeBlockPill.css";import{ResourcePool as be}from"./chatCollections.js";import"./chatContentParts.js";const F=R.$;let f=class extends P{constructor(e,o,r,i=!1,n=0,c,b,V,v,g,M,C){super();this.markdown=e;this.editorPool=r;this.codeBlockModelCollection=V;this.rendererOptions=v;this.textModelService=M;this.instantiationService=C;const t=o.element,D=[];let K=n;const U=this._register(c.render(e.content,{fillInIncompleteTokens:i,codeBlockRendererSync:(k,x,w)=>{const N=!u(o.element)||o.element.isComplete||!w||w?.endsWith("```"),S=K++;let E,_,L,j;if(oe(k,ge))try{const s=Ce(x);_=s.range&&re.lift(s.range),E=this.textModelService.createModelReference(s.uri).then(a=>a.object)}catch{return F("div")}else{const s=u(t)||O(t)?t.sessionId:"",a=this.codeBlockModelCollection.getOrCreate(s,t,S);L=a.vulns,j=a.codemapperUri,E=a.model}const W=u(t)&&t.errorDetails?.responseIsFiltered,p={languageId:k,textModel:E,codeBlockIndex:S,element:t,range:_,hideToolbar:W,parentContextKeyService:g,vulns:L,codemapperUri:j};if(!v.renderCodeBlockPills||t.isCompleteAddedRequest){const s=this.renderCodeBlock(p,x,b,v.editableCodeBlock);this.allRefs.push(s),this._register(s.object.onDidChangeContentHeight(()=>this._onDidChangeHeight.fire()));const a=this.id,h=new class{ownerMarkdownPartId=a;codeBlockIndex=S;element=t;isStreaming=!v.renderCodeBlockPills;codemapperUri=void 0;get uri(){return s.object.uri}focus(){s.object.focus()}getContent(){return s.object.editor.getValue()}};return this.codeblocks.push(h),D.push(s),s.object.element}else{const s=O(t)?t.id:t.requestId,a=u(t)?!t.isComplete:!N,h=this.renderCodeBlockPill(t.sessionId,s,p.codemapperUri,!a);u(p.element)&&this.codeBlockModelCollection.update(p.element.sessionId,p.element,p.codeBlockIndex,{text:x,languageId:p.languageId}).then(J=>{this.codeblocks[p.codeBlockIndex].codemapperUri=J.codemapperUri,this._onDidChangeHeight.fire()}),this.allRefs.push(h);const z=this.id,G=new class{ownerMarkdownPartId=z;codeBlockIndex=S;element=t;isStreaming=a;codemapperUri=void 0;get uri(){}focus(){return h.object.element.focus()}getContent(){return""}};return this.codeblocks.push(G),D.push(h),h.object.element}},asyncRenderCallback:()=>this._onDidChangeHeight.fire()})),$=C.createInstance(fe);this._register($.walkTreeAndAnnotateReferenceLinks(e,U.element)),D.reverse().forEach(k=>this._register(k)),this.domNode=U.element}static idPool=0;id=String(++f.idPool);domNode;allRefs=[];_onDidChangeHeight=this._register(new Z);onDidChangeHeight=this._onDidChangeHeight.event;codeblocks=[];renderCodeBlockPill(e,o,r,i){const n=this.instantiationService.createInstance(I,e,o);return r&&n.render(r,!i),{object:n,isStale:()=>!1,dispose:()=>n.dispose()}}renderCodeBlock(e,o,r,i){const n=this.editorPool.get(),c=n.object;return u(e.element)&&this.codeBlockModelCollection.update(e.element.sessionId,e.element,e.codeBlockIndex,{text:o,languageId:e.languageId}).then(b=>{this.codeblocks[e.codeBlockIndex].codemapperUri=b.codemapperUri,this._onDidChangeHeight.fire()}),c.render(e,r,i),n}hasSameContent(e){return e.kind==="markdownContent"&&!!(e.content.value===this.markdown.content.value||this.rendererOptions.renderCodeBlockPills&&this.codeblocks.at(-1)?.isStreaming&&this.codeblocks.at(-1)?.codemapperUri!==void 0&&e.content.value.lastIndexOf("```")===this.markdown.content.value.lastIndexOf("```"))}layout(e){this.allRefs.forEach((o,r)=>{if(o.object instanceof A)o.object.layout(e);else if(o.object instanceof I){const i=this.codeblocks[r];i.codemapperUri&&o.object.uri?.toString()!==i.codemapperUri.toString()&&o.object.render(i.codemapperUri,i.isStreaming)}})}addDisposable(e){this._register(e)}};f=y([d(9,ce),d(10,le),d(11,q)],f);let B=class extends P{_pool;inUse(){return this._pool.inUse}constructor(l,e,o,r){super(),this._pool=this._register(new be(()=>r.createInstance(A,l,ae.ChatCodeBlock,e,o)))}get(){const l=this._pool.get();let e=!1;return{object:l,isStale:()=>e,dispose:()=>{l.reset(),e=!0,this._pool.release(l)}}}};B=y([d(3,q)],B);let I=class extends P{constructor(e,o,r,i,n,c,b,V){super();this.sessionId=e;this.requestId=o;this.labelService=r;this.editorService=i;this.modelService=n;this.chatService=c;this.languageService=b;this.chatEditingService=V;this.element=F(".chat-codeblock-pill-widget"),this.element.classList.add("show-file-icons"),this._register(R.addDisposableListener(this.element,"click",async()=>{if(this.uri){const g=this.chatService.getSession(this.sessionId)?.getRequests();if(!g)return;const M=g?.find((C,t)=>t>0&&g[t-1]?.id===this.requestId)?.id;if(M){const C=this.chatEditingService.getSnapshotUri(M,this.uri);if(C){const t=await this.editorService.openEditor({resource:C,label:de("chatEditing.snapshot","{0} (Working Set History)",ee(this.uri)),options:{transient:!0,activation:pe.ACTIVATE}});te(t)&&t.updateOptions({readOnly:!0})}}else this.editorService.openEditor({resource:this.uri})}}))}element;_uri;get uri(){return this._uri}isStreaming;render(e,o){if(this.uri?.toString()===e.toString()&&this.isStreaming===o)return;this._uri=e,this.isStreaming=o;const r=this.labelService.getUriBasenameLabel(e);let i=[];if(o){const c=T.modify(Y.loading,"spin");i=T.asClassNameArray(c)}else{const c=e.path.endsWith("/")?H.FOLDER:H.FILE;i=ne(this.modelService,this.languageService,e,c)}const n=R.$("span.icon");n.classList.add(...i),this.element.replaceChildren(n,R.$("span.icon-label",{},r))}};I=y([d(2,me),d(3,he),d(4,se),d(5,Ie),d(6,ie),d(7,ue)],I);export{f as ChatMarkdownContentPart,B as EditorPool};
