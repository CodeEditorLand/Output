var z=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var x=(m,e,n,i)=>{for(var o=i>1?void 0:i?Y(e,n):e,t=m.length-1,s;t>=0;t--)(s=m[t])&&(o=(i?s(e,n,o):s(o))||o);return i&&o&&z(e,n,o),o},d=(m,e)=>(n,i)=>e(n,i,m);import*as K from"../../../../../base/browser/dom.js";import{Button as J}from"../../../../../base/browser/ui/button/button.js";import"../../../../../base/browser/ui/list/list.js";import"../../../../../base/common/actions.js";import{coalesce as W}from"../../../../../base/common/arrays.js";import{Codicon as v}from"../../../../../base/common/codicons.js";import{Emitter as Q}from"../../../../../base/common/event.js";import{Disposable as D,DisposableStore as X}from"../../../../../base/common/lifecycle.js";import{matchesSomeScheme as Z,Schemas as M}from"../../../../../base/common/network.js";import{basename as H}from"../../../../../base/common/path.js";import{basenameOrAuthority as P,isEqualAuthority as V}from"../../../../../base/common/resources.js";import{ThemeIcon as R}from"../../../../../base/common/themables.js";import{URI as S}from"../../../../../base/common/uri.js";import{localize as g,localize2 as ee}from"../../../../../nls.js";import{createAndFillInContextMenuActions as te}from"../../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as ie}from"../../../../../platform/actions/browser/toolbar.js";import{Action2 as ne,IMenuService as re,MenuId as B,registerAction2 as oe}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as O}from"../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as se}from"../../../../../platform/contextview/browser/contextView.js";import{FileKind as ae}from"../../../../../platform/files/common/files.js";import{IInstantiationService as w}from"../../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as le}from"../../../../../platform/instantiation/common/serviceCollection.js";import{ILabelService as ce}from"../../../../../platform/label/common/label.js";import{WorkbenchList as de}from"../../../../../platform/list/browser/listService.js";import{IOpenerService as ue}from"../../../../../platform/opener/common/opener.js";import{IProductService as me}from"../../../../../platform/product/common/productService.js";import{IThemeService as $}from"../../../../../platform/theme/common/themeService.js";import{fillEditorsDragData as he}from"../../../../browser/dnd.js";import{ResourceLabels as pe}from"../../../../browser/labels.js";import{ColorScheme as fe}from"../../../../browser/web.api.js";import{ResourceContextKey as ge}from"../../../../common/contextkeys.js";import{SETTINGS_AUTHORITY as be}from"../../../../services/preferences/common/preferences.js";import{createFileIconThemableTreeContainerScope as Ie}from"../../../files/browser/views/explorerView.js";import{ExplorerFolderContext as ve}from"../../../files/common/files.js";import{chatEditingWidgetFileStateContextKey as Ce,WorkingSetEntryState as k}from"../../common/chatEditingService.js";import{ChatResponseReferencePartStatusKind as j}from"../../common/chatService.js";import{IChatVariablesService as q}from"../../common/chatVariables.js";import"../../common/chatViewModel.js";import{IChatWidgetService as Se}from"../chat.js";import{ResourcePool as ye}from"./chatCollections.js";import"./chatContentParts.js";const y=K.$;let T=class extends D{constructor(n,i,o,t,s,c,r,l){super();this.data=n;this.instantiationService=r;this.contextMenuService=l;const h=i??(n.length>1?g("usedReferencesPlural","Used {0} references",n.length):g("usedReferencesSingular","Used {0} reference",1)),b=y(".chat-used-context-icon"),A=a=>a.usedReferencesExpanded?v.chevronDown:v.chevronRight;b.classList.add(...R.asClassNameArray(A(o)));const _=y(".chat-used-context-label",void 0),C=this._register(new J(_,{buttonBackground:void 0,buttonBorder:void 0,buttonForeground:void 0,buttonHoverBackground:void 0,buttonSecondaryBackground:void 0,buttonSecondaryForeground:void 0,buttonSecondaryHoverBackground:void 0,buttonSeparator:void 0}));this.domNode=y(".chat-used-context",void 0,_),C.label=h,C.element.prepend(b),this.updateAriaLabel(C.element,h,o.usedReferencesExpanded),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._register(C.onDidClick(()=>{b.classList.remove(...R.asClassNameArray(A(o))),o.usedReferencesExpanded=!o.usedReferencesExpanded,b.classList.add(...R.asClassNameArray(A(o))),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._onDidChangeHeight.fire(),this.updateAriaLabel(C.element,h,o.usedReferencesExpanded)}));const p=this._register(t.get()).object;this.domNode.appendChild(p.getHTMLElement().parentElement),this._register(p.onDidOpen(a=>{if(a.element&&"reference"in a.element&&typeof a.element.reference=="object"){const u="variableName"in a.element.reference?a.element.reference.value:a.element.reference,I=S.isUri(u)?u:u?.uri;I&&s.open(I,{fromUserGesture:!0,editorOptions:{...a.editorOptions,selection:u&&"range"in u?u.range:void 0}})}})),this._register(p.onContextMenu(a=>{K.EventHelper.stop(a.browserEvent,!0);const u=a.element&&L(a.element);u&&this.contextMenuService.showContextMenu({getAnchor:()=>a.anchor,getActions:()=>{const I=c.getMenuActions(B.ChatAttachmentsContext,p.contextKeyService,{shouldForwardArgs:!0,arg:u}),F=[];return te(I,F),F}})}));const N=this._register(this.instantiationService.createInstance(ge));this._register(p.onDidChangeFocus(a=>{N.reset();const u=a.elements.length?a.elements[0]:void 0,I=u&&L(u);N.set(I??null)}));const U=Math.min(n.length,6)*22;p.layout(U),p.getHTMLElement().style.height=`${U}px`,p.splice(0,p.length,n)}domNode;_onDidChangeHeight=this._register(new Q);onDidChangeHeight=this._onDidChangeHeight.event;hasSameContent(n,i,o){return n.kind==="references"&&n.references.length===this.data.length||n.kind==="codeCitations"&&n.citations.length===this.data.length}updateAriaLabel(n,i,o){n.ariaLabel=o?g("usedReferencesExpanded","{0}, expanded",i):g("usedReferencesCollapsed","{0}, collapsed",i)}addDisposable(n){this._register(n)}};T=x([d(4,ue),d(5,re),d(6,w),d(7,se)],T);let E=class extends D{constructor(n,i,o,t,s){super();this._onDidChangeVisibility=n;this.menuId=i;this.instantiationService=o;this.themeService=t;this.labelService=s;this._pool=this._register(new ye(()=>this.listFactory()))}_pool;get inUse(){return this._pool.inUse}listFactory(){const n=this._register(this.instantiationService.createInstance(pe,{onDidChangeVisibility:this._onDidChangeVisibility})),i=y(".chat-used-context-list");return this._register(Ie(i,this.themeService)),this.instantiationService.createInstance(de,"ChatListRenderer",i,new Le,[this.instantiationService.createInstance(f,n,this.menuId)],{alwaysConsumeMouseWheel:!1,accessibilityProvider:{getAriaLabel:t=>{if(t.kind==="warning")return t.content.value;const s=t.reference;return typeof s=="string"?s:"variableName"in s?s.variableName:S.isUri(s)?H(s.path):H(s.uri.path)},getWidgetAriaLabel:()=>g("chatCollapsibleList","Collapsible Chat List")},dnd:{getDragURI:t=>L(t)?.toString()??null,getDragLabel:(t,s)=>{const c=W(t.map(L));if(c.length)return c.length===1?this.labelService.getUriLabel(c[0],{relative:!0}):`${c.length}`},dispose:()=>{},onDragOver:()=>!1,drop:()=>{},onDragStart:(t,s)=>{try{const c=t.getData(),r=W(c.map(L));this.instantiationService.invokeFunction(l=>he(l,r,s))}catch{}}}})}get(){const n=this._pool.get();let i=!1;return{object:n,isStale:()=>i,dispose:()=>{i=!0,this._pool.release(n)}}}};E=x([d(2,w),d(3,$),d(4,ce)],E);class Le{getHeight(e){return 22}getTemplateId(e){return f.TEMPLATE_ID}}let f=class{constructor(e,n,i,o,t,s,c){this.labels=e;this.menuId=n;this.themeService=i;this.chatVariablesService=o;this.productService=t;this.instantiationService=s;this.contextKeyService=c}static TEMPLATE_ID="chatCollapsibleListRenderer";templateId=f.TEMPLATE_ID;renderTemplate(e){const n=new X,i=n.add(this.labels.create(e,{supportHighlights:!0,supportIcons:!0}));let o,t,s;if(this.menuId){t=y(".chat-collapsible-list-action-bar"),s=n.add(this.contextKeyService.createScoped(t));const c=n.add(this.instantiationService.createChild(new le([O,s])));o=n.add(c.createInstance(ie,t,this.menuId,{menuOptions:{shouldForwardArgs:!0,arg:void 0}})),i.element.appendChild(t)}return{templateDisposables:n,label:i,toolbar:o,actionBarContainer:t,contextKeyService:s}}getReferenceIcon(e){return R.isThemeIcon(e.iconPath)?e.iconPath:this.themeService.getColorTheme().type===fe.DARK&&e.iconPath?.dark?e.iconPath?.dark:e.iconPath?.light}renderElement(e,n,i,o){if(e.kind==="warning"){i.label.setResource({name:e.content.value},{icon:v.warning});return}const t=e.reference,s=this.getReferenceIcon(e);i.label.element.style.display="flex";let c;if(typeof t=="object"&&"variableName"in t)if(t.value){const r=S.isUri(t.value)?t.value:t.value.uri;i.label.setResource({resource:r,name:P(r),description:`#${t.variableName}`,range:"range"in t.value?t.value.range:void 0},{icon:s,title:e.options?.status?.description??e.title})}else if(t.variableName.startsWith("kernelVariable")){const l=`${t.variableName.split(":")[1]}`;i.label.setLabel("Kernel variable",l,{title:e.options?.status?.description})}else{const r=this.chatVariablesService.getVariable(t.variableName),l=r?.icon?`$(${r.icon.id}) `:"",h=`#${t.variableName}`,b=`${l}${r?.fullName??h}`;i.label.setLabel(b,h,{title:e.options?.status?.description??r?.description})}else if(typeof t=="string")i.label.setLabel(t,void 0,{iconPath:S.isUri(s)?s:void 0,title:e.options?.status?.description??e.title});else{const r="uri"in t?t.uri:t;if(c=r,r.scheme==="https"&&V(r.authority,"github.com")&&r.path.includes("/tree/")){const l=r.path.split("/").slice(1,3).join("/"),h=r.path.split("/").slice(5).join("/");i.label.setResource({resource:r,name:l,description:h},{icon:v.github,title:e.title})}else if(r.scheme===this.productService.urlProtocol&&V(r.authority,be)){const l=r.path.substring(1);i.label.setResource({resource:r,name:l},{icon:v.settingsGear,title:g("setting.hover","Open setting '{0}'",l)})}else Z(r,M.mailto,M.http,M.https)?i.label.setResource({resource:r,name:r.toString()},{icon:s??v.globe,title:e.options?.status?.description??e.title??r.toString()}):e.state===k.Transient?i.label.setResource({resource:r,name:P(r),description:g("chat.openEditor","Open Editor"),range:"range"in t?t.range:void 0},{icon:s,title:e.options?.status?.description??e.title}):i.label.setFile(r,{fileKind:ae.FILE,fileDecorations:void 0,range:"range"in t?t.range:void 0,title:e.options?.status?.description??e.title})}for(const r of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const l=i.label.element.querySelector(r);l&&(e.options?.status?.kind===j.Omitted||e.options?.status?.kind===j.Partial?l.classList.add("warning"):l.classList.remove("warning"))}e.state!==void 0&&(i.actionBarContainer&&(e.state===k.Modified&&!i.actionBarContainer.classList.contains("modified")?(i.actionBarContainer.classList.add("modified"),i.label.element.querySelector(".monaco-icon-name-container")?.classList.add("modified")):e.state!==k.Modified&&(i.actionBarContainer.classList.remove("modified"),i.label.element.querySelector(".monaco-icon-name-container")?.classList.remove("modified"))),i.toolbar&&(i.toolbar.context=c),i.contextKeyService&&e.state!==void 0&&Ce.bindTo(i.contextKeyService).set(e.state))}disposeTemplate(e){e.templateDisposables.dispose()}};f=x([d(2,$),d(3,q),d(4,me),d(5,w),d(6,O)],f);function L(m){if(m.kind==="warning")return null;const{reference:e}=m;return typeof e=="string"||"variableName"in e?null:S.isUri(e)?e:e.uri}oe(class G extends ne{static id="workbench.action.chat.addToChatAction";constructor(){super({id:G.id,title:{...ee("addToChat","Add File to Chat")},f1:!1,menu:[{id:B.ChatAttachmentsContext,group:"chat",order:1,when:ve.negate()}]})}async run(e,n){const i=e.get(Se),o=e.get(q);if(!n)return;const t=i.lastFocusedWidget;t&&o.attachContext("file",n,t.location)}});export{T as ChatCollapsibleListContentPart,E as CollapsibleListPool};
