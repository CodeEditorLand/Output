{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/Land/Dependency/Editor/Source/vs/workbench/contrib/chat/browser/chatDragAndDrop.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DataTransfers } from '../../../../base/browser/dnd.js';\nimport { $, DragAndDropObserver } from '../../../../base/browser/dom.js';\nimport { renderLabelWithIcons } from '../../../../base/browser/ui/iconLabel/iconLabels.js';\nimport { coalesce } from '../../../../base/common/arrays.js';\nimport { Codicon } from '../../../../base/common/codicons.js';\nimport { basename } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { localize } from '../../../../nls.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { containsDragType, extractEditorsDropData, IDraggedResourceEditorInput } from '../../../../platform/dnd/browser/dnd.js';\nimport { IThemeService, Themable } from '../../../../platform/theme/common/themeService.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\nimport { IChatRequestVariableEntry } from '../common/chatModel.js';\nimport { ChatInputPart } from './chatInputPart.js';\nimport { IChatWidgetStyles } from './chatWidget.js';\n\nenum ChatDragAndDropType {\n\tFILE,\n\tIMAGE\n}\n\nexport class ChatDragAndDrop extends Themable {\n\n\tprivate readonly overlay: HTMLElement;\n\tprivate overlayText?: HTMLElement;\n\tprivate overlayTextBackground: string = '';\n\n\tconstructor(\n\t\tprivate readonly contianer: HTMLElement,\n\t\tprivate readonly inputPart: ChatInputPart,\n\t\tprivate readonly styles: IChatWidgetStyles,\n\t\t@IThemeService themeService: IThemeService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService\n\t) {\n\t\tsuper(themeService);\n\n\t\t// If the mouse enters and leaves the overlay quickly,\n\t\t// the overlay may stick around due to too many drag enter events\n\t\t// Make sure the mouse enters only once\n\t\tlet mouseInside = false;\n\t\tthis._register(new DragAndDropObserver(this.contianer, {\n\t\t\tonDragEnter: (e) => {\n\t\t\t\tif (!mouseInside) {\n\t\t\t\t\tmouseInside = true;\n\t\t\t\t\tthis.onDragEnter(e);\n\t\t\t\t}\n\t\t\t},\n\t\t\tonDragOver: (e) => {\n\t\t\t\te.stopPropagation();\n\t\t\t},\n\t\t\tonDragLeave: (e) => {\n\t\t\t\tthis.onDragLeave(e);\n\t\t\t\tmouseInside = false;\n\t\t\t},\n\t\t\tonDrop: (e) => {\n\t\t\t\tthis.onDrop(e);\n\t\t\t\tmouseInside = false;\n\t\t\t},\n\t\t}));\n\n\t\tthis.overlay = document.createElement('div');\n\t\tthis.overlay.classList.add('chat-dnd-overlay');\n\t\tthis.contianer.appendChild(this.overlay);\n\n\t\tthis.updateStyles();\n\t}\n\n\tprivate onDragEnter(e: DragEvent): void {\n\t\tconst estimatedDropType = this.guessDropType(e);\n\t\tif (estimatedDropType !== undefined) {\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t\tthis.updateDropFeedback(e, estimatedDropType);\n\t}\n\n\tprivate onDragLeave(e: DragEvent): void {\n\t\tthis.updateDropFeedback(e, undefined);\n\t}\n\n\tprivate onDrop(e: DragEvent): void {\n\t\tthis.updateDropFeedback(e, undefined);\n\n\t\tconst contexts = this.getAttachContext(e);\n\t\tif (contexts.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\te.stopPropagation();\n\t\te.preventDefault();\n\n\t\t// Make sure to attach only new contexts\n\t\tconst currentContextIds = this.inputPart.attachmentModel.getAttachmentIDs();\n\t\tconst filteredContext = [];\n\t\tfor (const context of contexts) {\n\t\t\tif (!currentContextIds.has(context.id)) {\n\t\t\t\tcurrentContextIds.add(context.id);\n\t\t\t\tfilteredContext.push(context);\n\t\t\t}\n\t\t}\n\n\t\tthis.inputPart.attachmentModel.addContext(...filteredContext);\n\t}\n\n\tprivate updateDropFeedback(e: DragEvent, dropType: ChatDragAndDropType | undefined): void {\n\t\tconst showOverlay = dropType !== undefined;\n\t\tif (e.dataTransfer) {\n\t\t\te.dataTransfer.dropEffect = showOverlay ? 'copy' : 'none';\n\t\t}\n\n\t\tthis.setOverlay(dropType);\n\t}\n\n\tprivate isImageDnd(e: DragEvent): boolean {\n\t\t// Image detection should not have false positives, only false negatives are allowed\n\t\tif (containsDragType(e, 'image')) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (containsDragType(e, DataTransfers.FILES)) {\n\t\t\tconst files = e.dataTransfer?.files;\n\t\t\tif (files && files.length > 0) {\n\t\t\t\tconst file = files[0];\n\t\t\t\treturn file.type.startsWith('image/');\n\t\t\t}\n\n\t\t\tconst items = e.dataTransfer?.items;\n\t\t\tif (items && items.length > 0) {\n\t\t\t\tconst item = items[0];\n\t\t\t\treturn item.type.startsWith('image/');\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tprivate guessDropType(e: DragEvent): ChatDragAndDropType | undefined {\n\t\t// This is an esstimation based on the datatransfer types/items\n\t\tif (this.isImageDnd(e)) {\n\t\t\tconst imageDndSupported = this.configurationService.getValue<boolean>('chat.experimental.imageAttachments');\n\t\t\treturn imageDndSupported ? ChatDragAndDropType.IMAGE : undefined;\n\t\t} else if (containsDragType(e, DataTransfers.FILES, DataTransfers.INTERNAL_URI_LIST)) {\n\t\t\treturn ChatDragAndDropType.FILE;\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate isDragEventSupported(e: DragEvent): boolean {\n\t\t// if guessed drop type is undefined, it means the drop is not supported\n\t\tconst dropType = this.guessDropType(e);\n\t\treturn dropType !== undefined;\n\t}\n\n\tprivate getDropTypeName(type: ChatDragAndDropType): string {\n\t\tswitch (type) {\n\t\t\tcase ChatDragAndDropType.FILE: return localize('file', 'File');\n\t\t\tcase ChatDragAndDropType.IMAGE: return localize('image', 'Image');\n\t\t}\n\t}\n\n\tprivate getAttachContext(e: DragEvent): IChatRequestVariableEntry[] {\n\t\tif (!this.isDragEventSupported(e)) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst data = extractEditorsDropData(e);\n\t\treturn coalesce(data.map(editorInput => {\n\t\t\treturn this.resolveAttachContext(editorInput);\n\t\t}));\n\t}\n\n\tprivate resolveAttachContext(editorInput: IDraggedResourceEditorInput): IChatRequestVariableEntry | undefined {\n\t\t// Image\n\t\tconst imageContext = getImageAttachContext(editorInput);\n\t\tif (imageContext) {\n\t\t\tconst isImageDndSupported = this.configurationService.getValue<boolean>('chat.experimental.imageAttachments');\n\t\t\treturn isImageDndSupported ? imageContext : undefined;\n\t\t}\n\n\t\t// File\n\t\treturn getEditorAttachContext(editorInput);\n\t}\n\n\tprivate setOverlay(type: ChatDragAndDropType | undefined): void {\n\t\t// Remove any previous overlay text\n\t\tthis.overlayText?.remove();\n\t\tthis.overlayText = undefined;\n\n\t\tif (type !== undefined) {\n\t\t\t// Render the overlay text\n\t\t\tconst typeName = this.getDropTypeName(type);\n\n\t\t\tconst iconAndtextElements = renderLabelWithIcons(`$(${Codicon.attach.id}) ${localize('attach as context', 'Attach {0} as Context', typeName)}`);\n\t\t\tconst htmlElements = iconAndtextElements.map(element => {\n\t\t\t\tif (typeof element === 'string') {\n\t\t\t\t\treturn $('span.overlay-text', undefined, element);\n\t\t\t\t}\n\t\t\t\treturn element;\n\t\t\t});\n\n\t\t\tthis.overlayText = $('span.attach-context-overlay-text', undefined, ...htmlElements);\n\t\t\tthis.overlayText.style.backgroundColor = this.overlayTextBackground;\n\t\t\tthis.overlay.appendChild(this.overlayText);\n\t\t}\n\n\t\tthis.overlay.classList.toggle('visible', type !== undefined);\n\t}\n\n\toverride updateStyles(): void {\n\t\tthis.overlay.style.backgroundColor = this.getColor(this.styles.overlayBackground) || '';\n\t\tthis.overlay.style.color = this.getColor(this.styles.listForeground) || '';\n\t\tthis.overlayTextBackground = this.getColor(this.styles.listBackground) || '';\n\t}\n}\n\nfunction getEditorAttachContext(editor: EditorInput | IDraggedResourceEditorInput): IChatRequestVariableEntry | undefined {\n\tif (!editor.resource) {\n\t\treturn undefined;\n\t}\n\n\treturn getFileAttachContext(editor.resource);\n}\n\nfunction getFileAttachContext(resource: URI): IChatRequestVariableEntry | undefined {\n\treturn {\n\t\tvalue: resource,\n\t\tid: resource.toString(),\n\t\tname: basename(resource),\n\t\tisFile: true,\n\t\tisDynamic: true\n\t};\n}\n\nfunction getImageAttachContext(editor: EditorInput | IDraggedResourceEditorInput): IChatRequestVariableEntry | undefined {\n\tif (!editor.resource) {\n\t\treturn undefined;\n\t}\n\n\tif (/\\.(png|jpg|jpeg|bmp|gif|tiff)$/i.test(editor.resource.path)) {\n\t\tconst fileName = basename(editor.resource);\n\t\treturn {\n\t\t\tid: editor.resource.toString(),\n\t\t\tname: fileName,\n\t\t\tfullName: editor.resource.path,\n\t\t\tvalue: editor.resource,\n\t\t\ticon: Codicon.fileMedia,\n\t\t\tisDynamic: true,\n\t\t\tisImage: true,\n\t\t\tisFile: false\n\t\t};\n\t}\n\n\treturn undefined;\n}\n"],
  "mappings": "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",
  "names": ["ChatDragAndDropType"]
}
