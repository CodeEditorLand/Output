{
  "version": 3,
  "sources": ["../../../../../../../../../../Dependency/Land/Dependency/Editor/Source/vs/workbench/contrib/chat/browser/chatEditingService.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Sequencer } from '../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { BugIndicatingError } from '../../../../base/common/errors.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, IReference } from '../../../../base/common/lifecycle.js';\nimport { ResourceSet } from '../../../../base/common/map.js';\nimport { derived, IObservable, ITransaction, observableValue, ValueWithChangeEventFromObservable } from '../../../../base/common/observable.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { isCodeEditor, isDiffEditor } from '../../../../editor/browser/editorBrowser.js';\nimport { IBulkEditService } from '../../../../editor/browser/services/bulkEditService.js';\nimport { TextEdit } from '../../../../editor/common/languages.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { ITextModel } from '../../../../editor/common/model.js';\nimport { createTextBufferFactoryFromSnapshot } from '../../../../editor/common/model/textModel.js';\nimport { IModelService } from '../../../../editor/common/services/model.js';\nimport { IResolvedTextEditorModel, ITextModelContentProvider, ITextModelService } from '../../../../editor/common/services/resolverService.js';\nimport { localize, localize2 } from '../../../../nls.js';\nimport { IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { EditorActivation } from '../../../../platform/editor/common/editor.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { bindContextKey } from '../../../../platform/observable/common/platformObservableUtils.js';\nimport { IProgressService, ProgressLocation } from '../../../../platform/progress/common/progress.js';\nimport { DiffEditorInput } from '../../../common/editor/diffEditorInput.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\nimport { IEditorGroup, IEditorGroupsService } from '../../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { MultiDiffEditor } from '../../multiDiffEditor/browser/multiDiffEditor.js';\nimport { MultiDiffEditorInput } from '../../multiDiffEditor/browser/multiDiffEditorInput.js';\nimport { IMultiDiffSourceResolver, IMultiDiffSourceResolverService, IResolvedMultiDiffSource, MultiDiffEditorItem } from '../../multiDiffEditor/browser/multiDiffSourceResolverService.js';\nimport { ICodeMapperResponse, ICodeMapperService } from '../common/chatCodeMapperService.js';\nimport { applyingChatEditsContextKey, CHAT_EDITING_MULTI_DIFF_SOURCE_RESOLVER_SCHEME, chatEditingResourceContextKey, ChatEditingSessionState, decidedChatEditingResourceContextKey, IChatEditingService, IChatEditingSession, IChatEditingSessionStream, IModifiedFileEntry, inChatEditingSessionContextKey, WorkingSetEntryState } from '../common/chatEditingService.js';\nimport { IChatResponseModel } from '../common/chatModel.js';\nimport { IChatService } from '../common/chatService.js';\nimport { IChatWidgetService } from './chat.js';\n\nexport class ChatEditingService extends Disposable implements IChatEditingService {\n\n\t_serviceBrand: undefined;\n\n\tprivate readonly _currentSessionObs = observableValue<ChatEditingSession | null>(this, null);\n\tprivate readonly _currentSessionDisposables = this._register(new DisposableStore());\n\n\tprivate readonly _currentAutoApplyOperationObs = observableValue<CancellationTokenSource | null>(this, null);\n\tget currentAutoApplyOperation(): CancellationTokenSource | null {\n\t\treturn this._currentAutoApplyOperationObs.get();\n\t}\n\n\tget currentEditingSession(): IChatEditingSession | null {\n\t\treturn this._currentSessionObs.get();\n\t}\n\n\tprivate readonly _onDidCreateEditingSession = this._register(new Emitter<IChatEditingSession>());\n\tget onDidCreateEditingSession() {\n\t\treturn this._onDidCreateEditingSession.event;\n\t}\n\n\tprivate readonly _onDidChangeEditingSession = this._register(new Emitter<void>());\n\tpublic readonly onDidChangeEditingSession = this._onDidChangeEditingSession.event;\n\n\tconstructor(\n\t\t@IEditorGroupsService private readonly _editorGroupsService: IEditorGroupsService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IMultiDiffSourceResolverService multiDiffSourceResolverService: IMultiDiffSourceResolverService,\n\t\t@ITextModelService textModelService: ITextModelService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IProgressService private readonly _progressService: IProgressService,\n\t\t@ICodeMapperService private readonly _codeMapperService: ICodeMapperService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t) {\n\t\tsuper();\n\t\tthis._register(multiDiffSourceResolverService.registerResolver(_instantiationService.createInstance(ChatEditingMultiDiffSourceResolver, this._currentSessionObs)));\n\t\ttextModelService.registerTextModelContentProvider(ChatEditingTextModelContentProvider.scheme, _instantiationService.createInstance(ChatEditingTextModelContentProvider, this._currentSessionObs));\n\t\tthis._register(bindContextKey(decidedChatEditingResourceContextKey, contextKeyService, (reader) => {\n\t\t\tconst currentSession = this._currentSessionObs.read(reader);\n\t\t\tif (!currentSession) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst entries = currentSession.entries.read(reader);\n\t\t\tconst decidedEntries = entries.filter(entry => entry.state.read(reader) !== WorkingSetEntryState.Modified);\n\t\t\treturn decidedEntries.map(entry => entry.entryId);\n\t\t}));\n\t\tthis._register(bindContextKey(inChatEditingSessionContextKey, contextKeyService, (reader) => {\n\t\t\treturn this._currentSessionObs.read(reader) !== null;\n\t\t}));\n\t\tthis._register(bindContextKey(applyingChatEditsContextKey, contextKeyService, (reader) => {\n\t\t\treturn this._currentAutoApplyOperationObs.read(reader) !== null;\n\t\t}));\n\t\tthis._register(this._chatService.onDidDisposeSession((e) => {\n\t\t\tif (e.reason === 'cleared' && this._currentSessionObs.get()?.chatSessionId === e.sessionId) {\n\t\t\t\tvoid this._currentSessionObs.get()?.stop();\n\t\t\t}\n\t\t}));\n\t}\n\n\tgetEditingSession(resource: URI): IChatEditingSession | null {\n\t\tconst session = this.currentEditingSession;\n\t\tif (!session) {\n\t\t\treturn null;\n\t\t}\n\t\tconst entries = session.entries.get();\n\t\tfor (const entry of entries) {\n\t\t\tif (entry.modifiedURI.toString() === resource.toString()) {\n\t\t\t\treturn session;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync addFileToWorkingSet(resource: URI): Promise<void> {\n\t\tconst session = this._currentSessionObs.get();\n\t\tif (session) {\n\t\t\tsession.addFileToWorkingSet(resource);\n\t\t}\n\t}\n\n\toverride dispose(): void {\n\t\tthis._currentSessionObs.get()?.dispose();\n\t\tsuper.dispose();\n\t}\n\n\tasync startOrContinueEditingSession(chatSessionId: string, options?: { silent: boolean }): Promise<IChatEditingSession> {\n\t\tconst session = this._currentSessionObs.get();\n\t\tif (session) {\n\t\t\tif (session.chatSessionId !== chatSessionId) {\n\t\t\t\tthrow new BugIndicatingError('Cannot start new session while another session is active');\n\t\t\t}\n\t\t}\n\t\treturn this._createEditingSession(chatSessionId, options);\n\t}\n\n\tprivate async _createEditingSession(chatSessionId: string, options?: { silent: boolean }): Promise<IChatEditingSession> {\n\t\tif (this._currentSessionObs.get()) {\n\t\t\tthrow new BugIndicatingError('Cannot have more than one active editing session');\n\t\t}\n\n\t\tthis._currentSessionDisposables.clear();\n\n\t\t// listen for completed responses, run the code mapper and apply the edits to this edit session\n\t\tthis._currentSessionDisposables.add(this.installAutoApplyObserver(chatSessionId));\n\n\t\tconst input = MultiDiffEditorInput.fromResourceMultiDiffEditorInput({\n\t\t\tmultiDiffSource: ChatEditingMultiDiffSourceResolver.getMultiDiffSourceUri(),\n\t\t\tlabel: localize('multiDiffEditorInput.name', \"Suggested Edits\")\n\t\t}, this._instantiationService);\n\n\t\tconst editorPane = options?.silent ? undefined : await this._editorGroupsService.activeGroup.openEditor(input, { pinned: true, activation: EditorActivation.ACTIVATE }) as MultiDiffEditor | undefined;\n\n\t\tconst session = this._instantiationService.createInstance(ChatEditingSession, chatSessionId, editorPane);\n\t\tthis._currentSessionDisposables.add(session.onDidDispose(() => {\n\t\t\tthis._currentSessionDisposables.clear();\n\t\t\tthis._currentSessionObs.set(null, undefined);\n\t\t\tthis._onDidChangeEditingSession.fire();\n\t\t}));\n\t\tthis._currentSessionDisposables.add(session.onDidChange(() => {\n\t\t\tthis._onDidChangeEditingSession.fire();\n\t\t}));\n\n\t\tthis._currentSessionObs.set(session, undefined);\n\t\tthis._onDidCreateEditingSession.fire(session);\n\t\tthis._onDidChangeEditingSession.fire();\n\t\treturn session;\n\t}\n\n\tpublic triggerEditComputation(responseModel: IChatResponseModel): Promise<void> {\n\t\treturn this._continueEditingSession(async (builder, token) => {\n\t\t\tconst codeMapperResponse: ICodeMapperResponse = {\n\t\t\t\ttextEdit: (resource, edits) => builder.textEdits(resource, edits, responseModel),\n\t\t\t};\n\t\t\tawait this._codeMapperService.mapCodeFromResponse(responseModel, codeMapperResponse, token);\n\t\t}, { silent: true });\n\t}\n\n\tprivate installAutoApplyObserver(sessionId: string): IDisposable {\n\n\t\tconst chatModel = this._chatService.getSession(sessionId);\n\t\tif (!chatModel) {\n\t\t\tthrow new Error(`Edit session was created for a non-existing chat session: ${sessionId}`);\n\t\t}\n\n\t\tconst observerDisposables = new DisposableStore();\n\n\t\tconst onResponseComplete = (responseModel: IChatResponseModel) => {\n\t\t\tif (responseModel.result?.metadata?.autoApplyEdits) {\n\t\t\t\tthis.triggerEditComputation(responseModel);\n\t\t\t}\n\t\t};\n\n\t\tconst openCodeBlockUris = (responseModel: IChatResponseModel) => {\n\t\t\tfor (const part of responseModel.response.value) {\n\t\t\t\tif (part.kind === 'codeblockUri') {\n\t\t\t\t\tthis._editorService.openEditor({ resource: part.uri, options: { inactive: true, preserveFocus: true, pinned: true } });\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tobserverDisposables.add(chatModel.onDidChange(e => {\n\t\t\tif (e.kind === 'addRequest') {\n\t\t\t\tconst responseModel = e.request.response;\n\t\t\t\tif (responseModel) {\n\t\t\t\t\tif (responseModel.isComplete) {\n\t\t\t\t\t\topenCodeBlockUris(responseModel);\n\t\t\t\t\t\tonResponseComplete(responseModel);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst disposable = responseModel.onDidChange(() => {\n\t\t\t\t\t\t\topenCodeBlockUris(responseModel);\n\t\t\t\t\t\t\tif (responseModel.isComplete) {\n\t\t\t\t\t\t\t\tonResponseComplete(responseModel);\n\t\t\t\t\t\t\t\tdisposable.dispose();\n\t\t\t\t\t\t\t} else if (responseModel.isCanceled || responseModel.isStale) {\n\t\t\t\t\t\t\t\tdisposable.dispose();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t\tobserverDisposables.add(chatModel.onDidDispose(() => observerDisposables.dispose()));\n\t\treturn observerDisposables;\n\t}\n\n\tprivate async _continueEditingSession(builder: (stream: IChatEditingSessionStream, token: CancellationToken) => Promise<void>, options?: { silent?: boolean }): Promise<void> {\n\t\tconst session = this._currentSessionObs.get();\n\t\tif (!session) {\n\t\t\tthrow new BugIndicatingError('Cannot continue missing session');\n\t\t}\n\n\t\tif (session.state.get() === ChatEditingSessionState.StreamingEdits) {\n\t\t\tthrow new BugIndicatingError('Cannot continue session that is still streaming');\n\t\t}\n\n\t\tlet editorPane: MultiDiffEditor | undefined;\n\t\tif (!options?.silent && session.isVisible) {\n\t\t\tconst groupedEditors = this._findGroupedEditors();\n\t\t\tif (groupedEditors.length !== 1) {\n\t\t\t\tthrow new Error(`Unexpected number of editors: ${groupedEditors.length}`);\n\t\t\t}\n\t\t\tconst [group, editor] = groupedEditors[0];\n\n\t\t\teditorPane = await group.openEditor(editor, { pinned: true, activation: EditorActivation.ACTIVATE }) as MultiDiffEditor | undefined;\n\t\t}\n\n\t\tconst stream: IChatEditingSessionStream = {\n\t\t\ttextEdits: (resource: URI, textEdits: TextEdit[], responseModel: IChatResponseModel) => {\n\t\t\t\tsession.acceptTextEdits(resource, textEdits, responseModel);\n\t\t\t}\n\t\t};\n\t\tsession.acceptStreamingEditsStart();\n\t\tconst cancellationTokenSource = new CancellationTokenSource();\n\t\tthis._currentAutoApplyOperationObs.set(cancellationTokenSource, undefined);\n\t\ttry {\n\t\t\tif (editorPane) {\n\t\t\t\tawait editorPane?.showWhile(builder(stream, cancellationTokenSource.token));\n\t\t\t} else {\n\t\t\t\tawait this._progressService.withProgress({\n\t\t\t\t\tlocation: ProgressLocation.Window,\n\t\t\t\t\ttitle: localize2('chatEditing.startingSession', 'Generating edits...').value,\n\t\t\t\t}, async () => {\n\t\t\t\t\tawait builder(stream, cancellationTokenSource.token);\n\t\t\t\t},\n\t\t\t\t\t() => cancellationTokenSource.cancel()\n\t\t\t\t);\n\t\t\t}\n\t\t} finally {\n\t\t\tcancellationTokenSource.dispose();\n\t\t\tthis._currentAutoApplyOperationObs.set(null, undefined);\n\t\t\tsession.resolve();\n\t\t}\n\t}\n\n\tprivate _findGroupedEditors() {\n\t\tconst editors: [IEditorGroup, EditorInput][] = [];\n\t\tfor (const group of this._editorGroupsService.groups) {\n\t\t\tfor (const editor of group.editors) {\n\t\t\t\tif (editor.resource?.scheme === ChatEditingMultiDiffSourceResolver.scheme) {\n\t\t\t\t\teditors.push([group, editor]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn editors;\n\t}\n}\n\nclass ChatEditingMultiDiffSourceResolver implements IMultiDiffSourceResolver {\n\tpublic static readonly scheme = CHAT_EDITING_MULTI_DIFF_SOURCE_RESOLVER_SCHEME;\n\n\tpublic static getMultiDiffSourceUri(): URI {\n\t\treturn URI.from({\n\t\t\tscheme: ChatEditingMultiDiffSourceResolver.scheme,\n\t\t\tpath: '',\n\t\t});\n\t}\n\n\tconstructor(\n\t\tprivate readonly _currentSession: IObservable<ChatEditingSession | null>,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) { }\n\n\tcanHandleUri(uri: URI): boolean {\n\t\treturn uri.scheme === ChatEditingMultiDiffSourceResolver.scheme;\n\t}\n\n\tasync resolveDiffSource(uri: URI): Promise<IResolvedMultiDiffSource> {\n\t\treturn this._instantiationService.createInstance(ChatEditingMultiDiffSource, this._currentSession);\n\t}\n}\n\nclass ChatEditingMultiDiffSource implements IResolvedMultiDiffSource {\n\tprivate readonly _resources = derived<readonly MultiDiffEditorItem[]>(this, (reader) => {\n\t\tconst currentSession = this._currentSession.read(reader);\n\t\tif (!currentSession) {\n\t\t\treturn [];\n\t\t}\n\t\tconst entries = currentSession.entries.read(reader);\n\t\treturn entries.map((entry) => {\n\t\t\treturn new MultiDiffEditorItem(\n\t\t\t\tentry.originalURI,\n\t\t\t\tentry.modifiedURI,\n\t\t\t\tundefined,\n\t\t\t\t{\n\t\t\t\t\t[chatEditingResourceContextKey.key]: entry.entryId,\n\t\t\t\t\t// [inChatEditingSessionContextKey.key]: true\n\t\t\t\t},\n\t\t\t);\n\t\t});\n\t});\n\treadonly resources = new ValueWithChangeEventFromObservable(this._resources);\n\n\treadonly contextKeys = {\n\t\t[inChatEditingSessionContextKey.key]: true\n\t};\n\n\tconstructor(\n\t\tprivate readonly _currentSession: IObservable<ChatEditingSession | null>\n\t) { }\n}\n\ntype ChatEditingTextModelContentQueryData = { kind: 'empty' } | { kind: 'doc'; documentId: string };\n\nclass ChatEditingTextModelContentProvider implements ITextModelContentProvider {\n\tpublic static readonly scheme = 'chat-editing-text-model';\n\n\tpublic static getEmptyFileURI(): URI {\n\t\treturn URI.from({\n\t\t\tscheme: ChatEditingTextModelContentProvider.scheme,\n\t\t\tquery: JSON.stringify({ kind: 'empty' }),\n\t\t});\n\t}\n\n\tpublic static getFileURI(documentId: string, path: string): URI {\n\t\treturn URI.from({\n\t\t\tscheme: ChatEditingTextModelContentProvider.scheme,\n\t\t\tpath,\n\t\t\tquery: JSON.stringify({ kind: 'doc', documentId }),\n\t\t});\n\t}\n\n\tconstructor(\n\t\tprivate readonly _currentSessionObs: IObservable<ChatEditingSession | null>,\n\t\t@IModelService private readonly _modelService: IModelService,\n\t) { }\n\n\tasync provideTextContent(resource: URI): Promise<ITextModel | null> {\n\t\tconst existing = this._modelService.getModel(resource);\n\t\tif (existing && !existing.isDisposed()) {\n\t\t\treturn existing;\n\t\t}\n\n\t\tconst data: ChatEditingTextModelContentQueryData = JSON.parse(resource.query);\n\t\tif (data.kind === 'empty') {\n\t\t\treturn this._modelService.createModel('', null, resource, false);\n\t\t}\n\n\t\tconst session = this._currentSessionObs.get();\n\t\tif (!session) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn session.getVirtualModel(data.documentId);\n\t}\n}\n\nclass ChatEditingSession extends Disposable implements IChatEditingSession {\n\tprivate readonly _state = observableValue<ChatEditingSessionState>(this, ChatEditingSessionState.Initial);\n\tprivate readonly _entriesObs = observableValue<readonly ModifiedFileEntry[]>(this, []);\n\tpublic get entries(): IObservable<readonly ModifiedFileEntry[]> {\n\t\tthis._assertNotDisposed();\n\t\treturn this._entriesObs;\n\t}\n\tprivate readonly _sequencer = new Sequencer();\n\n\tprivate _entries: ModifiedFileEntry[] = [];\n\n\tprivate _workingSetObs = observableValue<readonly URI[]>(this, []);\n\tprivate _workingSet = new ResourceSet();\n\tget workingSet() {\n\t\tthis._assertNotDisposed();\n\t\treturn this._workingSetObs;\n\t}\n\n\tget state(): IObservable<ChatEditingSessionState> {\n\t\tthis._assertNotDisposed();\n\t\treturn this._state;\n\t}\n\n\tprivate readonly _onDidChange = new Emitter<void>();\n\tget onDidChange() {\n\t\tthis._assertNotDisposed();\n\t\treturn this._onDidChange.event;\n\t}\n\n\tprivate readonly _onDidDispose = new Emitter<void>();\n\tget onDidDispose() {\n\t\tthis._assertNotDisposed();\n\t\treturn this._onDidDispose.event;\n\t}\n\n\tget isVisible(): boolean {\n\t\tthis._assertNotDisposed();\n\t\treturn Boolean(this.editorPane && this.editorPane.isVisible());\n\t}\n\n\tconstructor(\n\t\tpublic readonly chatSessionId: string,\n\t\tprivate editorPane: MultiDiffEditor | undefined,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@ITextModelService private readonly _textModelService: ITextModelService,\n\t\t@IBulkEditService public readonly _bulkEditService: IBulkEditService,\n\t\t@IEditorGroupsService private readonly _editorGroupsService: IEditorGroupsService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IChatWidgetService chatWidgetService: IChatWidgetService,\n\t) {\n\t\tsuper();\n\n\t\t// Add the currently active editor to the working set\n\t\tconst widget = chatWidgetService.getWidgetBySessionId(chatSessionId);\n\n\t\tlet activeEditorControl = this._editorService.activeTextEditorControl;\n\t\tif (activeEditorControl) {\n\t\t\tif (isDiffEditor(activeEditorControl)) {\n\t\t\t\tactiveEditorControl = activeEditorControl.getOriginalEditor().hasTextFocus() ? activeEditorControl.getOriginalEditor() : activeEditorControl.getModifiedEditor();\n\t\t\t}\n\t\t\tif (isCodeEditor(activeEditorControl) && activeEditorControl.hasModel()) {\n\t\t\t\tconst uri = activeEditorControl.getModel().uri;\n\t\t\t\tthis._workingSet.add(uri);\n\t\t\t\twidget?.attachmentModel.addFile(uri);\n\t\t\t\tthis._workingSetObs.set([...this._workingSet.values()], undefined);\n\t\t\t}\n\t\t}\n\t}\n\n\tremove(...uris: URI[]): void {\n\t\tthis._assertNotDisposed();\n\n\t\tlet didRemoveUris = false;\n\t\tfor (const uri of uris) {\n\t\t\tdidRemoveUris = didRemoveUris || this._workingSet.delete(uri);\n\t\t}\n\n\t\tif (!didRemoveUris) {\n\t\t\treturn; // noop\n\t\t}\n\n\t\tthis._workingSetObs.set([...this._workingSet.values()], undefined);\n\t\tthis._onDidChange.fire();\n\t}\n\n\tprivate _assertNotDisposed(): void {\n\t\tif (this._state.get() === ChatEditingSessionState.Disposed) {\n\t\t\tthrow new BugIndicatingError(`Cannot access a disposed editing session`);\n\t\t}\n\t}\n\n\tasync accept(...uris: URI[]): Promise<void> {\n\t\tthis._assertNotDisposed();\n\n\t\tif (uris.length === 0) {\n\t\t\tawait Promise.all(this._entries.map(entry => entry.accept(undefined)));\n\t\t}\n\n\t\tfor (const uri of uris) {\n\t\t\tconst entry = this._entries.find(e => e.modifiedURI.toString() === uri.toString());\n\t\t\tif (entry) {\n\t\t\t\tawait entry.accept(undefined);\n\t\t\t}\n\t\t}\n\n\t\tthis._onDidChange.fire();\n\t}\n\n\tasync reject(...uris: URI[]): Promise<void> {\n\t\tthis._assertNotDisposed();\n\n\t\tif (uris.length === 0) {\n\t\t\tawait Promise.all(this._entries.map(entry => entry.reject(undefined)));\n\t\t}\n\n\t\tfor (const uri of uris) {\n\t\t\tconst entry = this._entries.find(e => e.modifiedURI.toString() === uri.toString());\n\t\t\tif (entry) {\n\t\t\t\tawait entry.reject(undefined);\n\t\t\t}\n\t\t}\n\n\t\tthis._onDidChange.fire();\n\t}\n\n\tasync show(): Promise<void> {\n\t\tthis._assertNotDisposed();\n\n\t\tif (this.editorPane?.isVisible()) {\n\t\t\treturn;\n\t\t} else if (this.editorPane?.input) {\n\t\t\tawait this._editorGroupsService.activeGroup.openEditor(this.editorPane.input, { pinned: true, activation: EditorActivation.ACTIVATE });\n\t\t\treturn;\n\t\t}\n\n\t\tconst input = MultiDiffEditorInput.fromResourceMultiDiffEditorInput({\n\t\t\tmultiDiffSource: ChatEditingMultiDiffSourceResolver.getMultiDiffSourceUri(),\n\t\t\tlabel: localize('multiDiffEditorInput.name', \"Suggested Edits\")\n\t\t}, this._instantiationService);\n\n\t\tconst editorPane = await this._editorGroupsService.activeGroup.openEditor(input, { pinned: true, activation: EditorActivation.ACTIVATE }) as MultiDiffEditor | undefined;\n\t\tthis.editorPane = editorPane;\n\t}\n\n\tasync stop(): Promise<void> {\n\t\tthis._assertNotDisposed();\n\n\t\t// Close out all open files\n\t\tawait Promise.allSettled(this._editorGroupsService.groups.map(async (g) => {\n\t\t\treturn Promise.allSettled(g.editors.map(async (e) => {\n\t\t\t\tif (e instanceof MultiDiffEditorInput || e instanceof DiffEditorInput && (e.original.resource?.scheme === ModifiedFileEntry.scheme || e.original.resource?.scheme === ChatEditingTextModelContentProvider.scheme)) {\n\t\t\t\t\tawait g.closeEditor(e);\n\t\t\t\t}\n\t\t\t}));\n\t\t}));\n\n\t\tif (this._state.get() !== ChatEditingSessionState.Disposed) {\n\t\t\t// session got disposed while we were closing editors\n\t\t\tthis.dispose();\n\t\t}\n\n\t}\n\n\toverride dispose() {\n\t\tthis._assertNotDisposed();\n\n\t\tsuper.dispose();\n\t\tthis._state.set(ChatEditingSessionState.Disposed, undefined);\n\t\tthis._onDidDispose.fire();\n\t}\n\n\tgetVirtualModel(documentId: string): ITextModel | null {\n\t\tthis._assertNotDisposed();\n\n\t\tconst entry = this._entries.find(e => e.entryId === documentId);\n\t\treturn entry?.docSnapshot ?? null;\n\t}\n\n\tacceptStreamingEditsStart(): void {\n\t\tif (this._state.get() === ChatEditingSessionState.Disposed) {\n\t\t\t// we don't throw in this case because there could be a builder still connected to a disposed session\n\t\t\treturn;\n\t\t}\n\n\t\t// ensure that the edits are processed sequentially\n\t\tthis._sequencer.queue(() => this._acceptStreamingEditsStart());\n\t}\n\n\tacceptTextEdits(resource: URI, textEdits: TextEdit[], responseModel: IChatResponseModel): void {\n\t\tif (this._state.get() === ChatEditingSessionState.Disposed) {\n\t\t\t// we don't throw in this case because there could be a builder still connected to a disposed session\n\t\t\treturn;\n\t\t}\n\n\t\t// ensure that the edits are processed sequentially\n\t\tthis._sequencer.queue(() => this._acceptTextEdits(resource, textEdits, responseModel));\n\t}\n\n\tresolve(): void {\n\t\tif (this._state.get() === ChatEditingSessionState.Disposed) {\n\t\t\t// we don't throw in this case because there could be a builder still connected to a disposed session\n\t\t\treturn;\n\t\t}\n\n\t\t// ensure that the edits are processed sequentially\n\t\tthis._sequencer.queue(() => this._resolve());\n\t}\n\n\taddFileToWorkingSet(resource: URI) {\n\t\tif (!this._workingSet.has(resource)) {\n\t\t\tthis._workingSet.add(resource);\n\t\t\tthis._workingSetObs.set([...this._workingSet.values()], undefined);\n\t\t\tthis._onDidChange.fire();\n\t\t}\n\t}\n\n\tprivate async _acceptStreamingEditsStart(): Promise<void> {\n\t\tthis._state.set(ChatEditingSessionState.StreamingEdits, undefined);\n\t\tthis._onDidChange.fire();\n\t}\n\n\tprivate async _acceptTextEdits(resource: URI, textEdits: TextEdit[], responseModel: IChatResponseModel): Promise<void> {\n\t\tconst entry = await this._getOrCreateModifiedFileEntry(resource, responseModel);\n\t\tentry.applyEdits(textEdits);\n\t\tawait this._editorService.openEditor({ resource: entry.modifiedURI, options: { inactive: true } });\n\t}\n\n\tprivate async _resolve(): Promise<void> {\n\t\tthis._state.set(ChatEditingSessionState.Idle, undefined);\n\t\tthis._onDidChange.fire();\n\t}\n\n\tprivate async _getOrCreateModifiedFileEntry(resource: URI, responseModel: IChatResponseModel): Promise<ModifiedFileEntry> {\n\t\tconst existingEntry = this._entries.find(e => e.resource.toString() === resource.toString());\n\t\tif (existingEntry) {\n\t\t\treturn existingEntry;\n\t\t}\n\n\t\tconst entry = await this._createModifiedFileEntry(resource, responseModel);\n\t\tthis._register(entry);\n\t\tthis._entries = [...this._entries, entry];\n\t\tthis._entriesObs.set(this._entries, undefined);\n\t\tthis._onDidChange.fire();\n\n\t\treturn entry;\n\t}\n\n\tprivate async _createModifiedFileEntry(resource: URI, responseModel: IChatResponseModel, mustExist = false): Promise<ModifiedFileEntry> {\n\t\ttry {\n\t\t\tconst ref = await this._textModelService.createModelReference(resource);\n\t\t\treturn this._instantiationService.createInstance(ModifiedFileEntry, resource, ref, { collapse: (transaction: ITransaction | undefined) => this._collapse(resource, transaction) }, responseModel);\n\t\t} catch (err) {\n\t\t\tif (mustExist) {\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\t// this file does not exist yet, create it and try again\n\t\t\tawait this._bulkEditService.apply({ edits: [{ newResource: resource }] });\n\t\t\treturn this._createModifiedFileEntry(resource, responseModel, true);\n\t\t}\n\t}\n\n\tprivate _collapse(resource: URI, transaction: ITransaction | undefined) {\n\t\tconst multiDiffItem = this.editorPane?.findDocumentDiffItem(resource);\n\t\tif (multiDiffItem) {\n\t\t\tthis.editorPane?.viewModel?.items.get().find((documentDiffItem) => String(documentDiffItem.originalUri) === String(multiDiffItem.originalUri) && String(documentDiffItem.modifiedUri) === String(multiDiffItem.modifiedUri))?.collapsed.set(true, transaction);\n\t\t}\n\t}\n}\n\nclass ModifiedFileEntry extends Disposable implements IModifiedFileEntry {\n\n\tpublic static readonly scheme = 'modified-file-entry';\n\tstatic lastEntryId = 0;\n\tpublic readonly entryId = `${ModifiedFileEntry.scheme}::${++ModifiedFileEntry.lastEntryId}`;\n\n\tpublic readonly docSnapshot: ITextModel;\n\tprivate readonly doc: ITextModel;\n\n\tget originalURI(): URI {\n\t\treturn this.docSnapshot.uri;\n\t}\n\n\tget originalModel(): ITextModel {\n\t\treturn this.docSnapshot;\n\t}\n\n\tget modifiedURI(): URI {\n\t\treturn this.doc.uri;\n\t}\n\n\tprivate readonly _stateObs = observableValue<WorkingSetEntryState>(this, WorkingSetEntryState.Modified);\n\tpublic get state(): IObservable<WorkingSetEntryState> {\n\t\treturn this._stateObs;\n\t}\n\n\tconstructor(\n\t\tpublic readonly resource: URI,\n\t\tresourceRef: IReference<IResolvedTextEditorModel>,\n\t\tprivate readonly _multiDiffEntryDelegate: { collapse: (transaction: ITransaction | undefined) => void },\n\t\tprivate readonly _responseModel: IChatResponseModel,\n\t\t@IModelService modelService: IModelService,\n\t\t@ITextModelService textModelService: ITextModelService,\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IBulkEditService public readonly bulkEditService: IBulkEditService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t) {\n\t\tsuper();\n\t\tthis.doc = resourceRef.object.textEditorModel;\n\t\tconst docSnapshot = this.docSnapshot = this._register(\n\t\t\tmodelService.createModel(\n\t\t\t\tcreateTextBufferFactoryFromSnapshot(this.doc.createSnapshot()),\n\t\t\t\tlanguageService.createById(this.doc.getLanguageId()),\n\t\t\t\tChatEditingTextModelContentProvider.getFileURI(this.entryId, resource.path),\n\t\t\t\tfalse\n\t\t\t)\n\t\t);\n\n\t\t// Create a reference to this model to avoid it being disposed from under our nose\n\t\t(async () => {\n\t\t\t// TODO: dispose manually if the outer object was disposed in the meantime\n\t\t\tthis._register(await textModelService.createModelReference(docSnapshot.uri));\n\t\t})();\n\n\t\tthis._register(resourceRef);\n\t}\n\n\tapplyEdits(textEdits: TextEdit[]): void {\n\t\tthis.doc.applyEdits(textEdits);\n\t\tthis._stateObs.set(WorkingSetEntryState.Modified, undefined);\n\t}\n\n\tasync accept(transaction: ITransaction | undefined): Promise<void> {\n\t\tif (this._stateObs.get() !== WorkingSetEntryState.Modified) {\n\t\t\t// already accepted or rejected\n\t\t\treturn;\n\t\t}\n\t\tthis.docSnapshot.setValue(this.doc.createSnapshot());\n\t\tthis._stateObs.set(WorkingSetEntryState.Accepted, transaction);\n\t\tawait this.collapse(transaction);\n\t\tthis._notifyAction('accepted');\n\t}\n\n\tasync reject(transaction: ITransaction | undefined): Promise<void> {\n\t\tif (this._stateObs.get() !== WorkingSetEntryState.Modified) {\n\t\t\t// already accepted or rejected\n\t\t\treturn;\n\t\t}\n\t\tthis.doc.setValue(this.docSnapshot.createSnapshot());\n\t\tthis._stateObs.set(WorkingSetEntryState.Rejected, transaction);\n\t\tawait this.collapse(transaction);\n\t\tthis._notifyAction('rejected');\n\t}\n\n\tasync collapse(transaction: ITransaction | undefined): Promise<void> {\n\t\tthis._multiDiffEntryDelegate.collapse(transaction);\n\t}\n\n\tprivate _notifyAction(outcome: 'accepted' | 'rejected') {\n\t\tthis._chatService.notifyUserAction({\n\t\t\taction: { kind: 'chatEditingSessionAction', uri: this.resource, hasRemainingEdits: false, outcome },\n\t\t\tagentId: this._responseModel.agent?.id,\n\t\t\tcommand: this._responseModel.slashCommand?.name,\n\t\t\tsessionId: this._responseModel.session.sessionId,\n\t\t\trequestId: this._responseModel.requestId,\n\t\t\tresult: this._responseModel.result\n\t\t});\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
