var lt=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var H=(I,E,t,o)=>{for(var e=o>1?void 0:o?ct(E,t):E,i=I.length-1,a;i>=0;i--)(a=I[i])&&(e=(o?a(E,t,e):a(e))||e);return o&&e&&lt(E,t,e),e},p=(I,E)=>(t,o)=>E(t,o,I);import*as n from"../../../../base/browser/dom.js";import{addDisposableListener as ut}from"../../../../base/browser/dom.js";import{DEFAULT_FONT_FAMILY as pt}from"../../../../base/browser/fonts.js";import"../../../../base/browser/history.js";import{StandardKeyboardEvent as W}from"../../../../base/browser/keyboardEvent.js";import*as gt from"../../../../base/browser/ui/aria/aria.js";import{Button as O}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/hover/hoverDelegate.js";import{createInstantHoverDelegate as $}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as mt}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{ProgressBar as ft}from"../../../../base/browser/ui/progressbar/progressbar.js";import"../../../../base/common/actions.js";import{Promises as vt}from"../../../../base/common/async.js";import{Codicon as N}from"../../../../base/common/codicons.js";import{Emitter as M,Event as Ct}from"../../../../base/common/event.js";import{HistoryNavigator2 as z}from"../../../../base/common/history.js";import{KeyCode as A}from"../../../../base/common/keyCodes.js";import{Disposable as bt,DisposableStore as P,MutableDisposable as j}from"../../../../base/common/lifecycle.js";import{ResourceSet as yt}from"../../../../base/common/map.js";import{basename as It,dirname as St}from"../../../../base/common/path.js";import{isMacintosh as Et}from"../../../../base/common/platform.js";import{URI as L}from"../../../../base/common/uri.js";import"../../../../editor/browser/config/editorConfiguration.js";import{EditorExtensionsRegistry as _t}from"../../../../editor/browser/editorExtensions.js";import{CodeEditorWidget as Mt}from"../../../../editor/browser/widget/codeEditor/codeEditorWidget.js";import{EditorOptions as Lt}from"../../../../editor/common/config/editorOptions.js";import"../../../../editor/common/core/dimension.js";import"../../../../editor/common/core/position.js";import{Range as xt}from"../../../../editor/common/core/range.js";import"../../../../editor/common/model.js";import{IModelService as Dt}from"../../../../editor/common/services/model.js";import{CopyPasteController as At}from"../../../../editor/contrib/dropOrPasteInto/browser/copyPasteController.js";import{ContentHoverController as wt}from"../../../../editor/contrib/hover/browser/contentHoverController.js";import{GlyphHoverController as Tt}from"../../../../editor/contrib/hover/browser/glyphHoverController.js";import{SuggestController as Ht}from"../../../../editor/contrib/suggest/browser/suggestController.js";import{localize as b}from"../../../../nls.js";import{IAccessibilityService as V}from"../../../../platform/accessibility/common/accessibility.js";import{DropdownWithPrimaryActionViewItem as Pt}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createAndFillInActionBarActions as Ft,MenuEntryActionViewItem as Wt}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{HiddenItemStrategy as X,MenuWorkbenchToolBar as k}from"../../../../platform/actions/browser/toolbar.js";import{IMenuService as Ot,MenuId as B,MenuItemAction as U}from"../../../../platform/actions/common/actions.js";import{ICommandService as Nt}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Vt}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as F}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as G}from"../../../../platform/contextview/browser/contextView.js";import{FileKind as kt,IFileService as Bt}from"../../../../platform/files/common/files.js";import{registerAndCreateHistoryNavigationContext as Ut}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";import{IHoverService as Rt}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Kt}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as qt}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as R}from"../../../../platform/keybinding/common/keybinding.js";import"../../../../platform/list/browser/listService.js";import{ILogService as $t}from"../../../../platform/log/common/log.js";import{INotificationService as Y}from"../../../../platform/notification/common/notification.js";import{IOpenerService as zt}from"../../../../platform/opener/common/opener.js";import{IThemeService as J}from"../../../../platform/theme/common/themeService.js";import{ResourceLabels as jt}from"../../../browser/labels.js";import{IEditorService as Xt}from"../../../services/editor/common/editorService.js";import{AccessibilityVerbositySettingId as Q}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as Gt}from"../../accessibility/common/accessibilityCommands.js";import{getSimpleCodeEditorWidgetOptions as Yt,getSimpleEditorOptions as Jt,setupSimpleEditorSelectionStyling as Qt}from"../../codeEditor/browser/simpleEditorOptions.js";import{ChatAgentLocation as K,IChatAgentService as Zt}from"../common/chatAgents.js";import{CONTEXT_CHAT_HAS_FILE_ATTACHMENTS as te,CONTEXT_CHAT_INPUT_CURSOR_AT_TOP as ee,CONTEXT_CHAT_INPUT_HAS_FOCUS as ie,CONTEXT_CHAT_INPUT_HAS_TEXT as oe,CONTEXT_IN_CHAT_INPUT as ne}from"../common/chatContextKeys.js";import{ChatEditingSessionState as q,WorkingSetEntryState as Z}from"../common/chatEditingService.js";import"../common/chatModel.js";import"../common/chatService.js";import"../common/chatViewModel.js";import{IChatWidgetHistoryService as se}from"../common/chatWidgetHistoryService.js";import{ILanguageModelsService as tt}from"../common/languageModels.js";import{CancelAction as re,ChatModelPickerActionId as ae,ChatSubmitSecondaryAgentAction as de,SubmitAction as he}from"./actions/chatExecuteActions.js";import{ImplicitContextAttachmentWidget as le}from"./attachments/implicitContextAttachment.js";import"./chat.js";import{ChatAttachmentModel as ce}from"./chatAttachmentModel.js";import"./chatContentParts/chatCollections.js";import{CollapsibleListPool as ue}from"./chatContentParts/chatReferencesContentPart.js";import{ChatEditingAcceptAllAction as et,ChatEditingDiscardAllAction as it,ChatEditingShowChangesAction as ot}from"./chatEditingActions.js";import{ChatEditingSaveAllAction as nt}from"./chatEditorSaving.js";import{ChatFollowups as pe}from"./chatFollowups.js";import"./chatWidget.js";import{ChatImplicitContext as ge}from"./contrib/chatImplicitContext.js";const x=n.$,st=250;let D=class extends bt{constructor(t,o,e,i,a,h,g,r,l,S,f,v,c,s,d,m,y){super();this.location=t;this.options=o;this.historyService=i;this.modelService=a;this.instantiationService=h;this.contextKeyService=g;this.configurationService=r;this.keybindingService=l;this.accessibilityService=S;this.languageModelsService=f;this.logService=v;this.hoverService=c;this.fileService=s;this.commandService=d;this.editorService=m;this.openerService=y;this._attachmentModel=this._register(new ce),this.getInputState=()=>{const u=[];for(const[C,_]of this._chatEditingSession?.workingSet.entries()??[])u.push({uri:C,state:_});return{...e(),chatContextAttachments:this._attachmentModel.attachments,chatWorkingSet:u}},this.inputEditorMaxHeight=this.options.renderStyle==="compact"?st/3:st,this.inputEditorHasText=oe.bindTo(g),this.chatCursorAtTop=ee.bindTo(g),this.inputEditorHasFocus=ie.bindTo(g),this.history=this.loadHistory(),this._register(this.historyService.onDidClearHistory(()=>this.history=new z([{text:""}],50,rt))),this._register(this.configurationService.onDidChangeConfiguration(u=>{u.affectsConfiguration(Q.Chat)&&this.inputEditor.updateOptions({ariaLabel:this._getAriaLabel()})})),this._chatEditsListPool=this._register(this.instantiationService.createInstance(ue,this._onDidChangeVisibility.event,B.ChatEditingSessionWidgetToolbar)),this._hasFileAttachmentContextKey=te.bindTo(g)}static INPUT_SCHEME="chatSessionInput";static _counter=0;_onDidLoadInputState=this._register(new M);onDidLoadInputState=this._onDidLoadInputState.event;_onDidChangeHeight=this._register(new M);onDidChangeHeight=this._onDidChangeHeight.event;_onDidFocus=this._register(new M);onDidFocus=this._onDidFocus.event;_onDidBlur=this._register(new M);onDidBlur=this._onDidBlur.event;_onDidChangeContext=this._register(new M);onDidChangeContext=this._onDidChangeContext.event;_onDidAcceptFollowup=this._register(new M);onDidAcceptFollowup=this._onDidAcceptFollowup.event;_attachmentModel;get attachmentModel(){return this._attachmentModel}getAttachedAndImplicitContext(){const t=[...this.attachmentModel.attachments];return this.implicitContext.enabled&&this.implicitContext.value&&t.push(this.implicitContext.toBaseEntry()),t}_indexOfLastAttachedContextDeletedWithKeyboard=-1;_implicitContext=this._register(new ge);get implicitContext(){return this._implicitContext}_hasFileAttachmentContextKey;_onDidChangeVisibility=this._register(new M);_contextResourceLabels=this.instantiationService.createInstance(jt,{onDidChangeVisibility:this._onDidChangeVisibility.event});inputEditorMaxHeight;inputEditorHeight=0;container;inputSideToolbarContainer;followupsContainer;followupsDisposables=this._register(new P);attachedContextContainer;attachedContextDisposables=this._register(new j);chatEditingSessionWidgetContainer;_inputPartHeight=0;get inputPartHeight(){return this._inputPartHeight}_followupsHeight=0;get followupsHeight(){return this._followupsHeight}_inputEditor;_inputEditorElement;executeToolbar;inputActionsToolbar;get inputEditor(){return this._inputEditor}history;historyNavigationBackwardsEnablement;historyNavigationForewardsEnablement;inputModel;inputEditorHasText;chatCursorAtTop;inputEditorHasFocus;_waitForPersistedLanguageModel=this._register(new j);_onDidChangeCurrentLanguageModel=new M;_currentLanguageModel;get currentLanguageModel(){return this._currentLanguageModel}cachedDimensions;cachedExecuteToolbarWidth;cachedInputToolbarWidth;inputUri=L.parse(`${D.INPUT_SCHEME}:input-${D._counter++}`);_chatEditsActionsDisposables=this._register(new P);_chatEditsDisposables=this._register(new P);_chatEditingSession;_chatEditsProgress;_chatEditsListPool;_chatEditList;get selectedElements(){const t=[],e=this._chatEditList?.object?.getSelectedElements()??[];for(const i of e)i.kind==="reference"&&L.isUri(i.reference)&&t.push(i.reference);return t}getInputState;setCurrentLanguageModelToDefault(){const t=this.languageModelsService.getLanguageModelIds().find(e=>this.languageModelsService.lookupLanguageModel(e)?.isDefault),o=this.languageModelsService.getLanguageModelIds().find(e=>{const i=this.languageModelsService.lookupLanguageModel(e);return i?.isUserSelectable&&!i.isDefault});this._currentLanguageModel=o?t:void 0}setCurrentLanguageModelByUser(t){this._currentLanguageModel=t,this._waitForPersistedLanguageModel.clear(),this.cachedDimensions&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)}loadHistory(){const t=this.historyService.getHistory(this.location);return t.length===0&&t.push({text:""}),new z(t,50,rt)}_getAriaLabel(){if(this.configurationService.getValue(Q.Chat)){const o=this.keybindingService.lookupKeybinding(Gt.OpenAccessibilityHelp)?.getLabel();return o?b("actions.chat.accessibiltyHelp","Chat Input,  Type to ask questions or type / for topics, press enter to send out the request. Use {0} for Chat Accessibility Help.",o):b("chatInput.accessibilityHelpNoKb","Chat Input,  Type code here and press Enter to run. Use the Chat Accessibility Help command for more information.")}return b("chatInput","Chat Input")}initForNewChatModel(t){this.history=this.loadHistory(),this.history.add({text:t.inputValue??this.history.current().text,state:t.inputState??this.getInputState()});const o=t.inputState?.chatContextAttachments??[];this._attachmentModel.clearAndSetContext(...o),t.inputValue&&this.setValue(t.inputValue,!1),t.selectedLanguageModelId&&(this.languageModelsService.lookupLanguageModel(t.selectedLanguageModelId)?(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)):this._waitForPersistedLanguageModel.value=this.languageModelsService.onDidChangeLanguageModels(i=>{const a=i.added?.find(h=>h.identifier===t.selectedLanguageModelId);a&&(this._waitForPersistedLanguageModel.clear(),a.metadata.isUserSelectable&&(this._currentLanguageModel=t.selectedLanguageModelId,this._onDidChangeCurrentLanguageModel.fire(this._currentLanguageModel)))}))}logInputHistory(){const t=[...this.history].map(o=>JSON.stringify(o)).join(`
`);this.logService.info(`[${this.location}] Chat input history:`,t)}setVisible(t){this._onDidChangeVisibility.fire(t)}get element(){return this.container}showPreviousValue(){const t=this.getInputState();this.history.isAtEnd()?this.saveCurrentValue(t):this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!0)}showNextValue(){const t=this.getInputState();this.history.isAtEnd()||(this.history.has({text:this._inputEditor.getValue(),state:t})||(this.saveCurrentValue(t),this.history.resetCursor()),this.navigateHistory(!1))}navigateHistory(t){const o=t?this.history.previous():this.history.next(),e=o.state?.chatContextAttachments??[];this._chatEditingSession?.workingSet.clear();for(const a of o.state?.chatWorkingSet??[])this._chatEditingSession?.workingSet.set(a.uri,a.state);this._attachmentModel.clearAndSetContext(...e),gt.status(o.text),this.setValue(o.text,!0),this._onDidLoadInputState.fire(o.state);const i=this._inputEditor.getModel();if(i)if(t){const a=this._inputEditor._getViewModel()?.getLineLength(1)??1,h=i.getLineLength(1);a===h?this._inputEditor.setPosition({lineNumber:1,column:a+1}):this._inputEditor.setPosition({lineNumber:1,column:a})}else this._inputEditor.setPosition(at(i))}setValue(t,o){this.inputEditor.setValue(t),this.inputEditor.setPosition({lineNumber:1,column:t.length+1}),o||this.saveCurrentValue(this.getInputState())}saveCurrentValue(t){const o={text:this._inputEditor.getValue(),state:t};this.history.replaceLast(o)}focus(){this._inputEditor.focus()}hasFocus(){return this._inputEditor.hasWidgetFocus()}async acceptInput(t){if(t){const e={text:this._inputEditor.getValue(),state:this.getInputState()};this.history.replaceLast(e),this.history.add({text:""})}this.attachmentModel.clear(),this._onDidLoadInputState.fire({}),this.accessibilityService.isScreenReaderOptimized()&&Et?this._acceptInputForVoiceover():(this._inputEditor.focus(),this._inputEditor.setValue(""))}_acceptInputForVoiceover(){const t=this._inputEditor.getDomNode();t&&(t.remove(),this._inputEditor.setValue(""),this._inputEditorElement.appendChild(t),this._inputEditor.focus())}_handleAttachedContextChange(){this._hasFileAttachmentContextKey.set(!!this._attachmentModel.attachments.find(t=>t.isFile)),this.renderAttachedContext()}render(t,o,e){let i;this.options.renderStyle==="compact"?i=n.h(".interactive-input-part",[n.h(".interactive-input-and-edit-session",[n.h(".chat-editing-session@chatEditingSessionWidgetContainer"),n.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[n.h(".chat-input-container@inputContainer",[n.h(".chat-editor-container@editorContainer"),n.h(".chat-input-toolbars@inputToolbars")])]),n.h(".chat-attached-context@attachedContextContainer"),n.h(".interactive-input-followups@followupsContainer")])]):i=n.h(".interactive-input-part",[n.h(".interactive-input-followups@followupsContainer"),n.h(".chat-editing-session@chatEditingSessionWidgetContainer"),n.h(".interactive-input-and-side-toolbar@inputAndSideToolbar",[n.h(".chat-input-container@inputContainer",[n.h(".chat-editor-container@editorContainer"),n.h(".chat-attached-context@attachedContextContainer"),n.h(".chat-input-toolbars@inputToolbars")])])]),this.container=i.root,t.append(this.container),this.container.classList.toggle("compact",this.options.renderStyle==="compact"),this.followupsContainer=i.followupsContainer;const a=i.inputAndSideToolbar,h=i.inputContainer,g=i.editorContainer;this.attachedContextContainer=i.attachedContextContainer;const r=i.inputToolbars;this.chatEditingSessionWidgetContainer=i.chatEditingSessionWidgetContainer,this.renderAttachedContext(),this._register(this._implicitContext.onDidChangeValue(()=>this._handleAttachedContextChange())),this._register(this._attachmentModel.onDidChangeContext(()=>this._handleAttachedContextChange())),this.renderChatEditingSessionState(null,e);const l=this._register(this.contextKeyService.createScoped(h));ne.bindTo(l).set(!0);const S=this._register(this.instantiationService.createChild(new qt([F,l]))),{historyNavigationBackwardsEnablement:f,historyNavigationForwardsEnablement:v}=this._register(Ut(l,this));this.historyNavigationBackwardsEnablement=f,this.historyNavigationForewardsEnablement=v;const c=Jt(this.configurationService);c.overflowWidgetsDomNode=this.options.editorOverflowWidgetsDomNode,c.pasteAs=Lt.pasteAs.defaultValue,c.readOnly=!1,c.ariaLabel=this._getAriaLabel(),c.fontFamily=pt,c.fontSize=13,c.lineHeight=20,c.padding=this.options.renderStyle==="compact"?{top:2,bottom:2}:{top:8,bottom:8},c.cursorWidth=1,c.wrappingStrategy="advanced",c.bracketPairColorization={enabled:!1},c.suggest={showIcons:!1,showSnippets:!1,showWords:!0,showStatusBar:!1,insertMode:"replace"},c.scrollbar={...c.scrollbar??{},vertical:"hidden"},c.stickyScroll={enabled:!1},this._inputEditorElement=n.append(g,x(dt));const s=Yt();s.contributions?.push(..._t.getSomeEditorContributions([wt.ID,Tt.ID,At.ID])),this._inputEditor=this._register(S.createInstance(Mt,this._inputEditorElement,c,s)),Ht.get(this._inputEditor)?.forceRenderingAbove(),this._register(this._inputEditor.onDidChangeModelContent(()=>{const u=Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight);u!==this.inputEditorHeight&&(this.inputEditorHeight=u,this._onDidChangeHeight.fire());const C=this._inputEditor.getModel(),_=!!C&&C.getValue().trim().length>0;this.inputEditorHasText.set(_)})),this._register(this._inputEditor.onDidFocusEditorText(()=>{this.inputEditorHasFocus.set(!0),this._onDidFocus.fire(),h.classList.toggle("focused",!0)})),this._register(this._inputEditor.onDidBlurEditorText(()=>{this.inputEditorHasFocus.set(!1),h.classList.toggle("focused",!1),this._onDidBlur.fire()}));const d=this._register($());if(this._register(n.addStandardDisposableListener(r,n.EventType.CLICK,u=>this.inputEditor.focus())),this.inputActionsToolbar=this._register(this.instantiationService.createInstance(k,r,B.ChatInput,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hiddenItemStrategy:X.Ignore,hoverDelegate:d})),this.inputActionsToolbar.context={widget:e},this._register(this.inputActionsToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedInputToolbarWidth=="number"&&this.cachedInputToolbarWidth!==this.inputActionsToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.executeToolbar=this._register(this.instantiationService.createInstance(k,r,this.options.menus.executeToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:d,hiddenItemStrategy:X.Ignore,actionViewItemProvider:(u,C)=>{if(this.location===K.Panel&&(u.id===he.ID||u.id===re.ID)&&u instanceof U){const _=this.instantiationService.createInstance(U,{id:"chat.moreExecuteActions",title:b("notebook.moreExecuteActionsLabel","More..."),icon:N.chevronDown},void 0,void 0,void 0,void 0);return this.instantiationService.createInstance(w,u,_,C)}if(u.id===ae&&u instanceof U&&(this._currentLanguageModel||this.setCurrentLanguageModelToDefault(),this._currentLanguageModel)){const _={onDidChangeModel:this._onDidChangeCurrentLanguageModel.event,setModel:ht=>{this.setCurrentLanguageModelByUser(ht)}};return this.instantiationService.createInstance(T,u,this._currentLanguageModel,_,{hoverDelegate:C.hoverDelegate,keybinding:C.keybinding??void 0})}}})),this.executeToolbar.context={widget:e},this._register(this.executeToolbar.onDidChangeMenuItems(()=>{this.cachedDimensions&&typeof this.cachedExecuteToolbarWidth=="number"&&this.cachedExecuteToolbarWidth!==this.executeToolbar.getItemsWidth()&&this.layout(this.cachedDimensions.height,this.cachedDimensions.width)})),this.options.menus.inputSideToolbar){const u=this._register(this.instantiationService.createInstance(k,a,this.options.menus.inputSideToolbar,{telemetrySource:this.options.menus.telemetrySource,menuOptions:{shouldForwardArgs:!0},hoverDelegate:d}));this.inputSideToolbarContainer=u.getElement(),u.getElement().classList.add("chat-side-toolbar"),u.context={widget:e}}let m=this.modelService.getModel(this.inputUri);if(m||(m=this.modelService.createModel("",null,this.inputUri,!0),this._register(m)),this.inputModel=m,this.inputModel.updateOptions({bracketColorizationOptions:{enabled:!1,independentColorPoolPerBracketType:!1}}),this._inputEditor.setModel(this.inputModel),o){this.inputModel.setValue(o);const u=this.inputModel.getLineCount();this._inputEditor.setPosition({lineNumber:u,column:this.inputModel.getLineMaxColumn(u)})}const y=()=>{const u=this._inputEditor.getModel();if(!u)return;const C=this._inputEditor.getPosition();if(!C)return;const _=C.lineNumber===1&&C.column-1<=(this._inputEditor._getViewModel()?.getLineLength(1)??0);this.chatCursorAtTop.set(_),this.historyNavigationBackwardsEnablement.set(_),this.historyNavigationForewardsEnablement.set(C.equals(at(u)))};this._register(this._inputEditor.onDidChangeCursorPosition(u=>y())),y()}async renderAttachedContext(t=!1){const o=this.attachedContextContainer;this.attachedContextDisposables.clear();const e=new P;this.attachedContextDisposables.value=e;const i=o.offsetHeight;n.clearNode(o);const a=e.add($());if(n.setVisibility(!!this.attachmentModel.size||!!this.implicitContext.value,this.attachedContextContainer),this.attachmentModel.size||(this._indexOfLastAttachedContextDeletedWithKeyboard=-1),this.implicitContext.value&&this.location===K.Panel){const g=e.add(this.instantiationService.createInstance(le,this.implicitContext,this._contextResourceLabels));o.appendChild(g.domNode)}const h=[];for(const[g,r]of this.attachmentModel.attachments.entries()){if(r.isFile&&this.location===K.EditingSession)return;const l=n.append(o,x(".chat-attached-context-attachment.show-file-icons")),S=this._contextResourceLabels.create(l,{supportIcons:!0,hoverDelegate:a,hoverTargetOverrride:l});let f;const v=L.isUri(r.value)?r.value:r.value&&typeof r.value=="object"&&"uri"in r.value&&L.isUri(r.value.uri)?r.value.uri:void 0,c=r.value&&typeof r.value=="object"&&"range"in r.value&&xt.isIRange(r.value.range)?r.value.range:void 0;if(v&&r.isFile){const s=It(v.path),d=St(v.path),m=`${s} ${d}`;f=c?b("chat.fileAttachmentWithRange","Attached file, {0}, line {1} to line {2}",m,c.startLineNumber,c.endLineNumber):b("chat.fileAttachment","Attached file, {0}",m),S.setFile(v,{fileKind:kt.FILE,hidePath:!0,range:c}),this.attachButtonAndDisposables(l,g,r,a)}else if(r.isImage){f=b("chat.imageAttachment","Attached image, {0}",r.name);const s=n.$("div.chat-attached-context-hover");s.setAttribute("aria-label",f);const d=n.$("div.chat-attached-context-pill",{},n.$("span.codicon.codicon-file-media")),m=n.$("span.chat-attached-context-custom-text",{},r.name);l.appendChild(d),l.appendChild(m),h.push(vt.withAsyncBody(async y=>{let u;try{if(this.attachButtonAndDisposables(l,g,r,a),r.value instanceof L){const C=await this.fileService.readFile(r.value);if(e.isDisposed)return;u=C.value.buffer}else u=r.value;this.createImageElements(u,l,s)}catch{}l.style.position="relative",e.add(this.hoverService.setupManagedHover(a,l,s,{trapFocus:!1})),y()}))}else{const s=r.fullName??r.name,d=r.icon?.id?`$(${r.icon.id}) ${s}`:s;S.setLabel(d,void 0),f=b("chat.attachment","Attached context, {0}",r.name),this.attachButtonAndDisposables(l,g,r,a)}if(await Promise.all(h),e.isDisposed)return;v&&(l.style.cursor="pointer",e.add(n.addDisposableListener(l,n.EventType.CLICK,s=>{n.EventHelper.stop(s,!0);const d={fromUserGesture:!0};if(c){const m={selection:c};d.editorOptions=m}this.openerService.open(v,d)})),e.add(n.addDisposableListener(l,n.EventType.KEY_DOWN,s=>{const d=new W(s);if(d.equals(A.Enter)||d.equals(A.Space)){n.EventHelper.stop(s,!0);const m={fromUserGesture:!0};if(c){const y={selection:c};m.editorOptions=y}this.openerService.open(v,m)}}))),l.tabIndex=0,l.ariaLabel=f}i!==o.offsetHeight&&!t&&this._onDidChangeHeight.fire()}attachButtonAndDisposables(t,o,e,i){const a=this.attachedContextDisposables.value;if(!a)return;const h=new O(t,{supportIcons:!0,hoverDelegate:i,title:b("chat.attachment.clearButton","Remove from context")});o===Math.min(this._indexOfLastAttachedContextDeletedWithKeyboard,this.attachmentModel.size-1)&&h.focus(),a.add(h),h.icon=N.close;const g=Ct.once(h.onDidClick)(r=>{if(this._attachmentModel.delete(e.id),n.isKeyboardEvent(r)){const l=new W(r);(l.equals(A.Enter)||l.equals(A.Space))&&(this._indexOfLastAttachedContextDeletedWithKeyboard=o)}this._attachmentModel.size===0&&this.focus(),this._onDidChangeHeight.fire(),this._onDidChangeContext.fire({removed:[e]})});a.add(g)}createImageElements(t,o,e){const i=new Blob([t],{type:"image/png"}),a=URL.createObjectURL(i),h=n.$("img.chat-attached-context-pill-image",{src:a,alt:""}),g=n.$("div.chat-attached-context-pill",{},h),r=o.querySelector(".chat-attached-context-pill");r&&r.replaceWith(g);const l=n.$("img.chat-attached-context-image",{src:a,alt:""});e.appendChild(l),l.onload=()=>{URL.revokeObjectURL(a)}}async renderChatEditingSessionState(t,o){if(n.setVisibility(!!t,this.chatEditingSessionWidgetContainer),!t){n.clearNode(this.chatEditingSessionWidgetContainer),this._chatEditsDisposables.clear(),this._chatEditList=void 0,this._chatEditsProgress?.dispose(),this._chatEditingSession=void 0;return}this._chatEditingSession=t;const e=t.state.get();this._chatEditList&&!o?.viewModel?.requestInProgress&&(e===q.Idle||e===q.Initial)&&this._chatEditsProgress?.stop();const i=this.chatEditingSessionWidgetContainer.querySelector(".chat-editing-session-container.show-file-icons")??n.append(this.chatEditingSessionWidgetContainer,x(".chat-editing-session-container.show-file-icons")),a=new yt,h=t?.entries.get().map(s=>(a.add(s.modifiedURI),{reference:s.modifiedURI,state:s.state.get(),kind:"reference"}))??[];for(const s of this.attachmentModel.attachments)s.isFile&&L.isUri(s.value)&&!a.has(s.value)&&(h.unshift({reference:s.value,state:Z.Attached,kind:"reference"}),a.add(s.value));for(const[s,d]of t.workingSet.entries())a.has(s)||h.unshift({reference:s,state:d,kind:"reference"});h.sort((s,d)=>s.kind==="reference"&&d.kind==="reference"?s.state===d.state||s.state===void 0||d.state===void 0?s.reference.toString().localeCompare(d.reference.toString()):s.state-d.state:0);const g=i.querySelector(".chat-editing-session-overview")??n.append(i,x(".chat-editing-session-overview"));if(h.length!==this._chatEditList?.object.length){const s=g.querySelector("span")??n.append(g,x("span"));s.textContent=b("chatEditingSession.workingSet","Working Set"),h.length===1?s.textContent+=" "+b("chatEditingSession.oneFile","(1 file)"):h.length>1&&(s.textContent+=" "+b("chatEditingSession.manyFiles","({0} files)",h.length))}this._chatEditsActionsDisposables.clear();{const s=g.querySelector(".chat-editing-session-actions")??n.append(g,x(".chat-editing-session-actions"));if(n.clearNode(s),t.entries.get().find(d=>d.state.get()===Z.Modified)){const d=[];d.push({command:et.ID,label:et.LABEL,isSecondary:!1},{command:nt.ID,label:nt.LABEL,isSecondary:!0},{command:it.ID,label:it.LABEL,isSecondary:!0},{command:ot.ID,label:ot.LABEL,icon:N.diffMultiple,isSecondary:!0});for(const m of d){const y=this._chatEditsActionsDisposables.add(new O(s,{supportIcons:!0,secondary:m.isSecondary}));m.icon?y.icon=m.icon:y.label=m.label,y.setTitle(m.label),this._chatEditsActionsDisposables.add(y.onDidClick(()=>{this.commandService.executeCommand(m.command)})),n.append(s,y.element)}}}if(!t)return;if((e===q.StreamingEdits||o?.viewModel?.requestInProgress)&&(this._chatEditsProgress??=new ft(i),this._chatEditsProgress?.infinite().show(500)),!this._chatEditList){this._chatEditList=this._chatEditsListPool.get();const s=this._chatEditList.object;this._chatEditsDisposables.add(this._chatEditList),this._chatEditsDisposables.add(s.onDidFocus(()=>{this._onDidFocus.fire()})),this._chatEditsDisposables.add(s.onDidOpen(d=>{if(d.element?.kind==="reference"&&L.isUri(d.element.reference)){const m=d.element.reference;this.editorService.openEditor({resource:m,options:{preserveFocus:!0}})}})),this._chatEditsDisposables.add(ut(s.getHTMLElement(),"click",d=>{this.hasFocus()||this._onDidFocus.fire()},!0)),n.append(i,s.getHTMLElement())}const S=Math.min(h.length,6)*22,f=this._chatEditList.object;f.layout(S),f.getHTMLElement().style.height=`${S}px`,f.splice(0,f.length,h);const v=i.querySelector(".chat-editing-session-toolbar-actions")??n.append(i,x(".chat-editing-session-toolbar-actions")),c=this._chatEditsActionsDisposables.add(new O(v,{supportIcons:!0,secondary:!0}));c.label=b("chatAddFiles","{0} Add Files...","$(add)"),this._chatEditsActionsDisposables.add(c.onDidClick(()=>{this.commandService.executeCommand("workbench.action.chat.attachContext",{widget:o,showFilesOnly:!0,placeholder:b("chatAttachFiles","Search for files to add to your working set")})})),n.append(v,c.element)}async renderFollowups(t,o){this.options.renderFollowups&&(this.followupsDisposables.clear(),n.clearNode(this.followupsContainer),t&&t.length>0&&this.followupsDisposables.add(this.instantiationService.createInstance(pe,this.followupsContainer,t,this.location,void 0,e=>this._onDidAcceptFollowup.fire({followup:e,response:o}))),this._onDidChangeHeight.fire())}get contentHeight(){const t=this.getLayoutData();return t.followupsHeight+t.inputPartEditorHeight+t.inputPartVerticalPadding+t.inputEditorBorder+t.attachmentsHeight+t.toolbarsHeight+t.chatEditingStateHeight}layout(t,o){return this.cachedDimensions=new n.Dimension(o,t),this._layout(t,o)}previousInputEditorDimension;_layout(t,o,e=!0){this.renderAttachedContext(!0);const i=this.getLayoutData(),a=Math.min(i.inputPartEditorHeight,t-i.followupsHeight-i.attachmentsHeight-i.inputPartVerticalPadding-i.toolbarsHeight),h=o-i.inputPartHorizontalPadding;this.followupsContainer.style.width=`${h}px`,this._inputPartHeight=i.inputPartVerticalPadding+i.followupsHeight+a+i.inputEditorBorder+i.attachmentsHeight+i.toolbarsHeight+i.chatEditingStateHeight,this._followupsHeight=i.followupsHeight;const g=this._inputEditor.getScrollWidth(),l={width:o-i.inputPartHorizontalPadding-i.editorBorder-i.inputPartHorizontalPaddingInside-i.toolbarsWidth-i.sideToolbarWidth,height:a};if((!this.previousInputEditorDimension||this.previousInputEditorDimension.width!==l.width||this.previousInputEditorDimension.height!==l.height)&&(this._inputEditor.layout(l),this.previousInputEditorDimension=l),e&&g<10)return this._layout(t,o,!1)}getLayoutData(){const t=this.cachedExecuteToolbarWidth=this.executeToolbar.getItemsWidth(),o=this.cachedInputToolbarWidth=this.inputActionsToolbar.getItemsWidth(),e=(this.executeToolbar.getItemsLength()-1)*4,i=this.inputActionsToolbar.getItemsLength()?(this.inputActionsToolbar.getItemsLength()-1)*4:0;return{inputEditorBorder:2,followupsHeight:this.followupsContainer.offsetHeight,inputPartEditorHeight:Math.min(this._inputEditor.getContentHeight(),this.inputEditorMaxHeight),inputPartHorizontalPadding:this.options.renderStyle==="compact"?16:32,inputPartVerticalPadding:this.options.renderStyle==="compact"?12:28,attachmentsHeight:this.attachedContextContainer.offsetHeight,editorBorder:2,inputPartHorizontalPaddingInside:12,toolbarsWidth:this.options.renderStyle==="compact"?t+e+o+i:0,toolbarsHeight:this.options.renderStyle==="compact"?0:22,chatEditingStateHeight:this.chatEditingSessionWidgetContainer.offsetHeight,sideToolbarWidth:this.inputSideToolbarContainer?n.getTotalWidth(this.inputSideToolbarContainer)+4:0}}getViewState(){return this.getInputState()}saveState(){this.saveCurrentValue(this.getInputState());const t=[...this.history];this.historyService.saveHistory(this.location,t)}};D=H([p(3,se),p(4,Dt),p(5,Kt),p(6,F),p(7,Vt),p(8,R),p(9,V),p(10,tt),p(11,$t),p(12,Rt),p(13,Bt),p(14,Nt),p(15,Xt),p(16,zt)],D);const rt=I=>JSON.stringify(I);function at(I){return{lineNumber:I.getLineCount(),column:I.getLineLength(I.getLineCount())+1}}let w=class extends Pt{constructor(E,t,o,e,i,a,h,g,r,l,S){super(E,t,[],"",{...o,getKeyBinding:c=>g.lookupKeybinding(c.id,h)},i,g,r,h,l,S);const f=e.createMenu(B.ChatExecuteSecondary,h),v=()=>{const c=[];Ft(f,{shouldForwardArgs:!0},c);const s=a.getSecondaryAgent();s&&c.forEach(d=>(d.id===de.ID&&(d.label=b("chat.submitToSecondaryAgent","Send to @{0}",s.name)),d)),this.update(t,c)};v(),this._register(f.onDidChange(()=>v()))}};w=H([p(3,Ot),p(4,G),p(5,Zt),p(6,F),p(7,R),p(8,Y),p(9,J),p(10,V)],w);let T=class extends Wt{constructor(t,o,e,i,a,h,g,r,l,S,f){super(t,i,a,h,g,r,l,f);this.currentLanguageModel=o;this.delegate=e;this._languageModelsService=S;this._register(e.onDidChangeModel(v=>{this.currentLanguageModel=v,this.updateLabel()}))}async onClick(t){this._openContextMenu()}render(t){super.render(t),t.classList.add("chat-modelPicker-item"),this._register(n.addDisposableListener(t,n.EventType.KEY_UP,o=>{const e=new W(o);(e.equals(A.Enter)||e.equals(A.Space))&&this._openContextMenu()}))}updateLabel(){if(this.label){const t=this._languageModelsService.lookupLanguageModel(this.currentLanguageModel);t&&(this.label.textContent=t.name,n.reset(this.label,...mt(`${t.name}$(chevron-down)`)))}}_openContextMenu(){const t=(e,i)=>({id:e,label:i.name,tooltip:"",class:void 0,enabled:!0,checked:e===this.currentLanguageModel,run:()=>{this.currentLanguageModel=e,this.updateLabel(),this.delegate.setModel(e)}}),o=this._languageModelsService.getLanguageModelIds().map(e=>({id:e,model:this._languageModelsService.lookupLanguageModel(e)})).filter(e=>e.model?.isUserSelectable);this._contextMenuService.showContextMenu({getAnchor:()=>this.element,getActions:()=>o.map(e=>t(e.id,e.model))})}};T=H([p(4,R),p(5,Y),p(6,F),p(7,J),p(8,G),p(9,tt),p(10,V)],T);const dt=".interactive-input-editor";Qt(dt);export{D as ChatInputPart};
