var le=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var E=(S,p,e,r)=>{for(var t=r>1?void 0:r?he(p,e):p,n=S.length-1,o;n>=0;n--)(o=S[n])&&(t=(r?o(p,e,t):o(t))||t);return r&&t&&le(p,e,t),t},m=(S,p)=>(e,r)=>p(e,r,S);import*as c from"../../../../base/browser/dom.js";import{renderFormattedText as Ce}from"../../../../base/browser/formattedTextRenderer.js";import{StandardKeyboardEvent as ue}from"../../../../base/browser/keyboardEvent.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{DropdownMenuActionViewItem as Ie}from"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{getDefaultHoverDelegate as pe}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/tree.js";import"../../../../base/common/actions.js";import{coalesce as fe,distinct as me}from"../../../../base/common/arrays.js";import{Codicon as _}from"../../../../base/common/codicons.js";import{Emitter as L}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{MarkdownString as H}from"../../../../base/common/htmlContent.js";import{KeyCode as O}from"../../../../base/common/keyCodes.js";import{Disposable as ge,DisposableStore as U,dispose as K,toDisposable as x}from"../../../../base/common/lifecycle.js";import{ResourceMap as ve}from"../../../../base/common/map.js";import{FileAccess as Re}from"../../../../base/common/network.js";import{clamp as Te}from"../../../../base/common/numbers.js";import{autorun as ye}from"../../../../base/common/observable.js";import{ThemeIcon as q}from"../../../../base/common/themables.js";import{URI as we}from"../../../../base/common/uri.js";import"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as v}from"../../../../nls.js";import{createActionViewItem as Pe}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as z}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as X,MenuItemAction as Se}from"../../../../platform/actions/common/actions.js";import{ICommandService as G}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as be}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as J}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ke}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as Ee}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as Le}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as De}from"../../../../platform/instantiation/common/serviceCollection.js";import{ILogService as V}from"../../../../platform/log/common/log.js";import{ColorScheme as Me}from"../../../../platform/theme/common/theme.js";import{IThemeService as Ae}from"../../../../platform/theme/common/themeService.js";import{IWorkbenchIssueService as _e}from"../../issue/common/issue.js";import{annotateSpecialMarkdownContent as Q}from"../common/annotations.js";import"../common/chatAgents.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as He,CONTEXT_ITEM_ID as Oe,CONTEXT_REQUEST as xe,CONTEXT_RESPONSE as Ve,CONTEXT_RESPONSE_DETECTED_AGENT_COMMAND as Ne,CONTEXT_RESPONSE_ERROR as Be,CONTEXT_RESPONSE_FILTERED as Fe,CONTEXT_RESPONSE_VOTE as Y}from"../common/chatContextKeys.js";import{isChatRequestCheckpointed as We}from"../common/chatEditingService.js";import"../common/chatModel.js";import{chatSubcommandLeader as $e}from"../common/chatParserTypes.js";import{ChatAgentVoteDirection as j,ChatAgentVoteDownReason as I}from"../common/chatService.js";import{isRequestVM as y,isResponseVM as h}from"../common/chatViewModel.js";import{getNWords as Ue}from"../common/chatWordCounter.js";import"../common/codeBlockModelCollection.js";import{MarkUnhelpfulActionId as D}from"./actions/chatTitleActions.js";import{GeneratingPhrase as Ke}from"./chat.js";import{ChatAgentHover as qe,getChatAgentHoverOptions as ze}from"./chatAgentHover.js";import{ChatAttachmentsContentPart as Xe}from"./chatContentParts/chatAttachmentsContentPart.js";import{ChatCodeCitationContentPart as Ge}from"./chatContentParts/chatCodeCitationContentPart.js";import{ChatCommandButtonContentPart as Je}from"./chatContentParts/chatCommandContentPart.js";import{ChatConfirmationContentPart as Qe}from"./chatContentParts/chatConfirmationContentPart.js";import"./chatContentParts/chatContentParts.js";import{ChatMarkdownContentPart as Z,EditorPool as Ye}from"./chatContentParts/chatMarkdownContentPart.js";import{ChatProgressContentPart as je}from"./chatContentParts/chatProgressContentPart.js";import{ChatCollapsibleListContentPart as Ze,CollapsibleListPool as et}from"./chatContentParts/chatReferencesContentPart.js";import{ChatTaskContentPart as tt}from"./chatContentParts/chatTaskContentPart.js";import{ChatTextEditContentPart as rt,DiffEditorPool as nt}from"./chatContentParts/chatTextEditContentPart.js";import{ChatToolInvocationPart as ot}from"./chatContentParts/chatToolInvocationPart.js";import{ChatTreeContentPart as ee,TreePool as it}from"./chatContentParts/chatTreeContentPart.js";import{ChatWarningContentPart as te}from"./chatContentParts/chatWarningContentPart.js";import{ChatMarkdownDecorationsRenderer as st}from"./chatMarkdownDecorationsRenderer.js";import{ChatMarkdownRenderer as at}from"./chatMarkdownRenderer.js";import"./chatOptions.js";import{ChatCodeBlockContentProvider as dt}from"./codeBlockPart.js";const f=c.$,re=!1,ne="chat-most-recent-response";let P=class extends ge{constructor(e,r,t,n,o,i,s,l,a,d,C,u){super();this.rendererOptions=r;this.delegate=t;this.codeBlockModelCollection=n;this.instantiationService=i;this.logService=l;this.contextKeyService=a;this.themeService=d;this.commandService=C;this.hoverService=u;this.renderer=this._register(this.instantiationService.createInstance(at,void 0)),this.markdownDecorationsRenderer=this.instantiationService.createInstance(st),this._editorPool=this._register(this.instantiationService.createInstance(Ye,e,t,o)),this._diffEditorPool=this._register(this.instantiationService.createInstance(nt,e,t,o)),this._treePool=this._register(this.instantiationService.createInstance(it,this._onDidChangeVisibility.event)),this._contentReferencesListPool=this._register(this.instantiationService.createInstance(et,this._onDidChangeVisibility.event,void 0)),this._register(this.instantiationService.createInstance(dt))}static ID="item";codeBlocksByResponseId=new Map;codeBlocksByEditorUri=new ve;fileTreesByResponseId=new Map;focusedFileTreesByResponseId=new Map;renderer;markdownDecorationsRenderer;_onDidClickFollowup=this._register(new L);onDidClickFollowup=this._onDidClickFollowup.event;_onDidClickRerunWithAgentOrCommandDetection=new L;onDidClickRerunWithAgentOrCommandDetection=this._onDidClickRerunWithAgentOrCommandDetection.event;_onDidChangeItemHeight=this._register(new L);onDidChangeItemHeight=this._onDidChangeItemHeight.event;_editorPool;_diffEditorPool;_treePool;_contentReferencesListPool;_currentLayoutWidth=0;_isVisible=!0;_onDidChangeVisibility=this._register(new L);get templateId(){return P.ID}editorsInUse(){return this._editorPool.inUse()}traceLayout(e,r){re?this.logService.info(`ChatListItemRenderer#${e}: ${r}`):this.logService.trace(`ChatListItemRenderer#${e}: ${r}`)}getProgressiveRenderRate(e){if(e.isComplete)return 80;if(e.contentUpdateTimings&&e.contentUpdateTimings.impliedWordLoadRate){const n=e.contentUpdateTimings.impliedWordLoadRate;return Te(n,5,80)}return 8}getCodeBlockInfosForResponse(e){return this.codeBlocksByResponseId.get(e.id)??[]}getCodeBlockInfoForEditor(e){return this.codeBlocksByEditorUri.get(e)}getFileTreeInfosForResponse(e){return this.fileTreesByResponseId.get(e.id)??[]}getLastFocusedFileTreeForResponse(e){const r=this.fileTreesByResponseId.get(e.id),t=this.focusedFileTreesByResponseId.get(e.id);if(r?.length&&t!==void 0&&t<r.length)return r[t]}setVisible(e){this._isVisible=e,this._onDidChangeVisibility.fire(e)}layout(e){this._currentLayoutWidth=e-(this.rendererOptions.noPadding?0:40);for(const r of this._editorPool.inUse())r.layout(this._currentLayoutWidth);for(const r of this._diffEditorPool.inUse())r.layout(this._currentLayoutWidth)}renderTemplate(e){const r=new U,t=c.append(e,f(".disabled-overlay")),n=c.append(e,f(".interactive-item-container"));this.rendererOptions.renderStyle==="compact"&&n.classList.add("interactive-item-compact"),this.rendererOptions.noPadding&&n.classList.add("no-padding");let o=n,i=n,s,l;if(this.rendererOptions.renderStyle==="minimal"){n.classList.add("interactive-item-compact"),n.classList.add("minimal");const g=c.append(n,f(".column.left")),T=c.append(n,f(".column.right"));o=g,s=T,i=T,l=c.append(n,f(".header"))}const a=c.append(o,f(".header")),d=c.append(a,f(".user"));d.tabIndex=0,d.role="toolbar";const C=c.append(d,f(".avatar-container")),u=c.append(d,f("h3.username")),R=c.append(s??d,f("span.detail-container")),ie=c.append(R,f("span.detail"));c.append(R,f("span.chat-animated-ellipsis"));const se=c.append(i,f(".value")),ae=new U,N=r.add(this.contextKeyService.createScoped(n)),b=r.add(this.instantiationService.createChild(new De([J,N])));let B;this.rendererOptions.noHeader?a.classList.add("hidden"):B=r.add(b.createInstance(z,l??a,X.ChatMessageTitle,{menuOptions:{shouldForwardArgs:!0},toolbarOptions:{shouldInlineSubmenu:g=>g.actions.length<=1}}));const de=c.append(n,f(".chat-footer-toolbar")),ce=r.add(b.createInstance(z,de,X.ChatMessageFooter,{eventDebounceDelay:0,menuOptions:{shouldForwardArgs:!0,renderShortTitle:!0},toolbarOptions:{shouldInlineSubmenu:g=>g.actions.length<=1},actionViewItemProvider:(g,T)=>g instanceof Se&&g.item.id===D?b.createInstance(k,g,T):Pe(b,g,T)})),A=r.add(this.instantiationService.createInstance(qe)),F=()=>{if(h(w.currentElement)&&w.currentElement.agent&&!w.currentElement.agent.isDefault)return A.setAgent(w.currentElement.agent.id),A.domNode},W=ze(()=>h(w.currentElement)?w.currentElement.agent:void 0,this.commandService);r.add(this.hoverService.setupManagedHover(pe("element"),d,F,W)),r.add(c.addDisposableListener(d,c.EventType.KEY_DOWN,g=>{const T=new ue(g);if(T.equals(O.Space)||T.equals(O.Enter)){const $=F();$&&this.hoverService.showHover({content:$,target:d,trapFocus:!0,actions:W.actions},!0)}else T.equals(O.Escape)&&this.hoverService.hideHover()}));const w={avatarContainer:C,username:u,detail:ie,value:se,rowContainer:n,elementDisposables:ae,templateDisposables:r,contextKeyService:N,instantiationService:b,agentHover:A,titleToolbar:B,footerToolbar:ce,disabledOverlay:t};return w}renderElement(e,r,t){this.renderChatTreeItem(e.element,r,t)}clearRenderedParts(e){e.renderedParts&&(K(fe(e.renderedParts)),e.renderedParts=void 0,c.clearNode(e.value))}renderChatTreeItem(e,r,t){t.currentElement&&t.currentElement.id!==e.id&&(this.traceLayout("renderChatTreeItem",`Rendering a different element into the template, index=${r}`),this.clearRenderedParts(t)),t.currentElement=e;const n=y(e)?"request":h(e)?"response":"welcome";this.traceLayout("renderElement",`${n}, index=${r}`),Ve.bindTo(t.contextKeyService).set(h(e)),Oe.bindTo(t.contextKeyService).set(e.id),xe.bindTo(t.contextKeyService).set(y(e)),Ne.bindTo(t.contextKeyService).set(h(e)&&e.agentOrSlashCommandDetected),h(e)?(He.bindTo(t.contextKeyService).set(!!e.agent?.metadata.supportIssueReporting),Y.bindTo(t.contextKeyService).set(e.vote===j.Up?"up":e.vote===j.Down?"down":""),We.bindTo(t.contextKeyService).set(e.model.session.checkpoint?.id===e.requestId)):Y.bindTo(t.contextKeyService).set(""),t.titleToolbar&&(t.titleToolbar.context=e),t.footerToolbar.context=e,Be.bindTo(t.contextKeyService).set(h(e)&&!!e.errorDetails);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered);if(Fe.bindTo(t.contextKeyService).set(o),t.rowContainer.classList.toggle("interactive-request",y(e)),t.rowContainer.classList.toggle("interactive-response",h(e)),t.rowContainer.classList.toggle("show-detail-progress",h(e)&&!e.isComplete&&!e.progressMessages.length),t.username.textContent=e.username,this.rendererOptions.noHeader||this.renderAvatar(e,t),c.clearNode(t.detail),h(e)&&this.renderDetail(e,t),t.disabledOverlay.classList.toggle("disabled",e.isDisabled),y(e)&&e.confirmation&&this.renderConfirmationAction(e,t),h(e)&&r===this.delegate.getListLength()-1&&(!e.isComplete||e.renderData)){this.traceLayout("renderElement",`start progressive render, index=${r}`),t.rowContainer.classList.toggle(ne,!0);const i=t.elementDisposables.add(new c.WindowIntervalTimer),s=l=>{try{this.doNextProgressiveRender(e,r,t,!!l)&&i.cancel()}catch(a){i.cancel(),this.logService.error(a)}};i.cancelAndSet(s,50,c.getWindow(t.rowContainer)),s(!0)}else t.rowContainer.classList.toggle(ne,!1),h(e)?this.basicRenderElement(e,r,t):y(e)&&this.basicRenderElement(e,r,t)}renderDetail(e,r){r.elementDisposables.add(ye(t=>{this._renderDetail(e,r)}))}_renderDetail(e,r){if(c.clearNode(r.detail),e.agentOrSlashCommandDetected){const t=e.slashCommand?v("usedAgentSlashCommand","used {0} [[(rerun without)]]",`${$e}${e.slashCommand.name}`):v("usedAgent","[[(rerun without)]]");c.reset(r.detail,Ce(t,{className:"agentOrSlashCommandDetected",inline:!0,actionHandler:{disposables:r.elementDisposables,callback:n=>{this._onDidClickRerunWithAgentOrCommandDetection.fire(e)}}}))}else e.isComplete||(r.detail.textContent=Ke)}renderConfirmationAction(e,r){c.clearNode(r.detail),e.confirmation&&(r.detail.textContent=v("chatConfirmationAction",'selected "{0}"',e.confirmation))}renderAvatar(e,r){const t=h(e)?this.getAgentIcon(e.agent?.metadata):e.avatarIcon??_.account;if(t instanceof we){const n=c.$("img.icon");n.src=Re.uriToBrowserUri(t).toString(!0),r.avatarContainer.replaceChildren(c.$(".avatar",void 0,n))}else{const n=c.$(q.asCSSSelector(t));r.avatarContainer.replaceChildren(c.$(".avatar.codicon-avatar",void 0,n))}}getAgentIcon(e){return e?.themeIcon?e.themeIcon:e?.iconDark&&this.themeService.getColorTheme().type===Me.DARK?e.iconDark:e?.icon?e.icon:_.copilot}basicRenderElement(e,r,t){t.rowContainer.classList.toggle("chat-response-loading",h(e)&&!e.isComplete);let n=[];if(y(e)&&!e.confirmation){const a="message"in e.message?e.message.message:this.markdownDecorationsRenderer.convertParsedRequestToMarkdown(e.message);n=[{content:new H(a),kind:"markdownContent"}]}else h(e)&&(e.contentReferences.length&&n.push({kind:"references",references:e.contentReferences}),n.push(...Q(e.response.value)),e.codeCitations.length&&n.push({kind:"codeCitations",citations:e.codeCitations}));c.clearNode(t.value),h(e)&&this.renderDetail(e,t);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered),i=[];if(o||n.forEach((a,d)=>{const C={element:e,contentIndex:d,content:n,preceedingContentParts:i},u=this.renderChatContentPart(a,t,C);u&&(t.value.appendChild(u.domNode),i.push(u))}),t.renderedParts&&K(t.renderedParts),t.renderedParts=i,!o&&y(e)&&e.variables.length){const a=this.renderAttachments(e.variables,e.contentReferences,t);a&&(t.value.appendChild(a.domNode),t.elementDisposables.add(a))}if(h(e)&&e.errorDetails?.message){const a=this.instantiationService.createInstance(te,e.errorDetails.responseIsFiltered?"info":"error",new H(e.errorDetails.message),this.renderer);t.elementDisposables.add(a),t.value.appendChild(a.domNode)}const s=t.rowContainer.offsetHeight,l=!e.currentRenderedHeight||e.currentRenderedHeight!==s;if(e.currentRenderedHeight=s,l){const a=t.elementDisposables.add(c.scheduleAtNextAnimationFrame(c.getWindow(t.value),()=>{e.currentRenderedHeight=t.rowContainer.offsetHeight,a.dispose(),this._onDidChangeItemHeight.fire({element:e,height:e.currentRenderedHeight})}))}}updateItemHeight(e){if(!e.currentElement)return;const r=e.rowContainer.offsetHeight;e.currentElement.currentRenderedHeight=r,this._onDidChangeItemHeight.fire({element:e.currentElement,height:r})}doNextProgressiveRender(e,r,t,n){if(!this._isVisible)return!0;if(e.isCanceled)return this.traceLayout("doNextProgressiveRender",`canceled, index=${r}`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0;t.rowContainer.classList.toggle("chat-response-loading",!0),this.traceLayout("doNextProgressiveRender",`START progressive render, index=${r}, renderData=${JSON.stringify(e.renderData)}`);const o=this.getNextProgressiveRenderContent(e),i=this.diff(t.renderedParts??[],o.content,e);if(i.every(a=>a===null))return o.moreContentAvailable?(this.traceLayout("doNextProgressiveRender","not rendering any new content this tick, but more available"),!1):e.isComplete?(this.traceLayout("doNextProgressiveRender",`END progressive render, index=${r} and clearing renderData, response is complete`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0):(this.traceLayout("doNextProgressiveRender","caught up with the stream- no new content to render"),!0);this.traceLayout("doNextProgressiveRender",`doing progressive render, ${i.length} parts to render`),this.renderChatContentDiff(i,o.content,e,t);const l=t.rowContainer.offsetHeight;return e.currentRenderedHeight=l,n||this._onDidChangeItemHeight.fire({element:e,height:t.rowContainer.offsetHeight}),!1}renderChatContentDiff(e,r,t,n){const o=n.renderedParts??[];n.renderedParts=o,e.forEach((i,s)=>{if(!i)return;const l=n.renderedParts?.[s];l&&l.dispose();const a=o.slice(0,s),d={element:t,content:r,preceedingContentParts:a,contentIndex:s},C=this.renderChatContentPart(i,n,d);if(C){if(l)try{l.domNode.replaceWith(C.domNode)}catch(u){this.logService.error("ChatListItemRenderer#renderChatContentDiff: error replacing part",u)}else n.value.appendChild(C.domNode);o[s]=C}else l&&l.domNode.remove()})}getNextProgressiveRenderContent(e){const r=this.getDataForProgressiveRender(e),t=Q(e.response.value);this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} at ${r.rate} words/s, counting...`);let n=r.numWordsToRender;const o=[];e.contentReferences.length&&o.push({kind:"references",references:e.contentReferences});let i=!1;for(let d=0;d<t.length;d++){const C=t[d];if(C.kind==="markdownContent"){const u=Ue(C.content.value,n);if(this.traceLayout("getNextProgressiveRenderContent",`  Chunk ${d}: Want to render ${n} words and found ${u.returnedWordCount} words. Total words in chunk: ${u.totalWordCount}`),n-=u.returnedWordCount,u.isFullString){o.push(C);for(const R of t.slice(d+1))if(R.kind!=="markdownContent")d++,o.push(R);else{i=!0;break}}else i=!0,o.push({...C,content:new H(u.value,C.content)});if(n<=0){t.slice(d+1).some(R=>R.kind==="markdownContent")&&(i=!0);break}}else o.push(C)}const s=e.contentUpdateTimings?.lastWordCount??0,l=r.numWordsToRender-n,a=s-l;return this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} words. Rendering ${l} words. Buffer: ${a} words`),l>0&&l!==e.renderData?.renderedWordCount&&(e.renderData={lastRenderTime:Date.now(),renderedWordCount:l,renderedParts:o}),{content:o,moreContentAvailable:i}}getDataForProgressiveRender(e){const r=e.renderData??{lastRenderTime:0,renderedWordCount:0},t=this.getProgressiveRenderRate(e);return{numWordsToRender:r.lastRenderTime===0?1:r.renderedWordCount+Math.floor((Date.now()-r.lastRenderTime)/1e3*t),rate:t}}diff(e,r,t){const n=[];for(let o=0;o<r.length;o++){const i=r[o],s=e[o];!s||!s.hasSameContent(i,r.slice(o+1),t)?n.push(i):n.push(null)}return n}renderChatContentPart(e,r,t){if(e.kind==="treeData")return this.renderTreeData(e,r,t);if(e.kind==="progressMessage")return this.instantiationService.createInstance(je,e,this.renderer,t);if(e.kind==="progressTask")return this.renderProgressTask(e,r,t);if(e.kind==="command")return this.instantiationService.createInstance(Je,e,t);if(e.kind==="textEditGroup")return this.renderTextEdit(t,e,r);if(e.kind==="confirmation")return this.renderConfirmation(t,e,r);if(e.kind==="warning")return this.instantiationService.createInstance(te,"warning",e.content,this.renderer);if(e.kind==="markdownContent")return this.renderMarkdown(e,r,t);if(e.kind==="references")return this.renderContentReferencesListData(e,void 0,t,r);if(e.kind==="codeCitations")return this.renderCodeCitationsListData(e,t,r);if(e.kind==="toolInvocation"||e.kind==="toolInvocationSerialized")return this.renderToolInvocation(e,t,r)}renderTreeData(e,r,t){const n=e.treeData,o=t.preceedingContentParts.filter(s=>s instanceof ee).length,i=this.instantiationService.createInstance(ee,n,t.element,this._treePool,o);if(i.addDisposable(i.onDidChangeHeight(()=>{this.updateItemHeight(r)})),h(t.element)){const s={treeDataId:n.uri.toString(),treeIndex:o,focus(){i.domFocus()}};i.addDisposable(i.onDidFocus(()=>{this.focusedFileTreesByResponseId.set(t.element.id,s.treeIndex)}));const l=this.fileTreesByResponseId.get(t.element.id)??[];l.push(s),this.fileTreesByResponseId.set(t.element.id,me(l,a=>a.treeDataId)),i.addDisposable(x(()=>this.fileTreesByResponseId.set(t.element.id,l.filter(a=>a.treeDataId!==n.uri.toString()))))}return i}renderContentReferencesListData(e,r,t,n){const o=this.instantiationService.createInstance(Ze,e.references,r,t.element,this._contentReferencesListPool);return o.addDisposable(o.onDidChangeHeight(()=>{this.updateItemHeight(n)})),o}renderCodeCitationsListData(e,r,t){return this.instantiationService.createInstance(Ge,e,r)}renderToolInvocation(e,r,t){const n=this.instantiationService.createInstance(ot,e,r,this.renderer);return n.addDisposable(n.onDidChangeHeight(()=>{this.updateItemHeight(t)})),n}renderProgressTask(e,r,t){if(!h(t.element))return;const n=this.instantiationService.createInstance(tt,e,this._contentReferencesListPool,this.renderer,t);return n.addDisposable(n.onDidChangeHeight(()=>{this.updateItemHeight(r)})),n}renderConfirmation(e,r,t){const n=this.instantiationService.createInstance(Qe,r,e);return n.addDisposable(n.onDidChangeHeight(()=>this.updateItemHeight(t))),n}renderAttachments(e,r,t){return this.instantiationService.createInstance(Xe,e,r,void 0)}renderTextEdit(e,r,t){const n=this.instantiationService.createInstance(rt,r,e,this.rendererOptions,this._diffEditorPool,this._currentLayoutWidth);return n.addDisposable(n.onDidChangeHeight(()=>{n.layout(this._currentLayoutWidth),this.updateItemHeight(t)})),n}renderMarkdown(e,r,t){const n=t.element,o=h(n)&&(!n.isComplete||n.isCanceled||n.errorDetails?.responseIsFiltered||n.errorDetails?.responseIsIncomplete||!!n.renderData),i=t.preceedingContentParts.reduce((d,C)=>d+(C instanceof Z?C.codeblocks.length:0),0),s=this.instantiationService.createInstance(Z,e,t,this._editorPool,o,i,this.renderer,this._currentLayoutWidth,this.codeBlockModelCollection,this.rendererOptions),l=s.id;s.addDisposable(s.onDidChangeHeight(()=>{s.layout(this._currentLayoutWidth),this.updateItemHeight(r)}));const a=this.codeBlocksByResponseId.get(n.id)??[];return this.codeBlocksByResponseId.set(n.id,a),s.addDisposable(x(()=>{const d=this.codeBlocksByResponseId.get(n.id);d&&s.codeblocks.forEach((C,u)=>{d[i+u]?.ownerMarkdownPartId===l&&delete d[i+u]})})),s.codeblocks.forEach((d,C)=>{if(a[i+C]=d,d.uri){const u=d.uri;this.codeBlocksByEditorUri.set(u,d),s.addDisposable(x(()=>{this.codeBlocksByEditorUri.get(u)?.ownerMarkdownPartId===l&&this.codeBlocksByEditorUri.delete(u)}))}}),s}disposeElement(e,r,t){this.traceLayout("disposeElement",`Disposing element, index=${r}`),t.elementDisposables.clear()}disposeTemplate(e){e.templateDisposables.dispose()}};P=E([m(5,Le),m(6,be),m(7,V),m(8,J),m(9,Ae),m(10,G),m(11,Ee)],P);let M=class{constructor(p,e){this.defaultElementHeight=p;this.logService=e}_traceLayout(p,e){re?this.logService.info(`ChatListDelegate#${p}: ${e}`):this.logService.trace(`ChatListDelegate#${p}: ${e}`)}getHeight(p){const e=y(p)?"request":"response",r=("currentRenderedHeight"in p?p.currentRenderedHeight:void 0)??this.defaultElementHeight;return this._traceLayout("getHeight",`${e}, height=${r}`),r}getTemplateId(p){return P.ID}hasDynamicHeight(p){return!0}};M=E([m(1,V)],M);const oe={[I.IncorrectCode]:v("incorrectCode","Suggested incorrect code"),[I.DidNotFollowInstructions]:v("didNotFollowInstructions","Didn't follow instructions"),[I.MissingContext]:v("missingContext","Missing context"),[I.OffensiveOrUnsafe]:v("offensiveOrUnsafe","Offensive or unsafe"),[I.PoorlyWrittenOrFormatted]:v("poorlyWrittenOrFormatted","Poorly written or formatted"),[I.RefusedAValidRequest]:v("refusedAValidRequest","Refused a valid request"),[I.IncompleteCode]:v("incompleteCode","Incomplete code"),[I.WillReportIssue]:v("reportIssue","Report an issue"),[I.Other]:v("other","Other")};let k=class extends Ie{constructor(e,r,t,n,o,i){super(e,{getActions:()=>this.getActions()},i,{...r,classNames:q.asClassNameArray(_.thumbsdown)});this.commandService=t;this.issueService=n;this.logService=o}getActions(){return[this.getVoteDownDetailAction(I.IncorrectCode),this.getVoteDownDetailAction(I.DidNotFollowInstructions),this.getVoteDownDetailAction(I.IncompleteCode),this.getVoteDownDetailAction(I.MissingContext),this.getVoteDownDetailAction(I.PoorlyWrittenOrFormatted),this.getVoteDownDetailAction(I.RefusedAValidRequest),this.getVoteDownDetailAction(I.OffensiveOrUnsafe),this.getVoteDownDetailAction(I.Other),{id:"reportIssue",label:oe[I.WillReportIssue],tooltip:"",enabled:!0,class:void 0,run:async e=>{if(!h(e)){this.logService.error("ChatVoteDownButton#run: invalid context");return}await this.commandService.executeCommand(D,e,I.WillReportIssue),await this.issueService.openReporter({extensionId:e.agent?.extensionId.value})}}]}render(e){super.render(e),this.element?.classList.toggle("checked",this.action.checked)}getVoteDownDetailAction(e){const r=oe[e];return{id:D,label:r,tooltip:"",enabled:!0,checked:this._context.voteDownReason===e,class:void 0,run:async t=>{if(!h(t)){this.logService.error("ChatVoteDownButton#getVoteDownDetailAction: invalid context");return}await this.commandService.executeCommand(D,t,e)}}}};k=E([m(2,G),m(3,_e),m(4,V),m(5,ke)],k);export{M as ChatListDelegate,P as ChatListItemRenderer,k as ChatVoteDownButton};
