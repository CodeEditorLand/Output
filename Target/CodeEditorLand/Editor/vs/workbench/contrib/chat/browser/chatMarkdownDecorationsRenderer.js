var D=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var I=(o,c,e,t)=>{for(var i=t>1?void 0:t?k(c,e):c,n=o.length-1,r;n>=0;n--)(r=o[n])&&(i=(t?r(c,e,i):r(i))||i);return t&&i&&D(c,e,i),i},s=(o,c)=>(e,t)=>c(e,t,o);import*as m from"../../../../base/browser/dom.js";import{Button as C}from"../../../../base/browser/ui/button/button.js";import{getDefaultHoverDelegate as A}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{toErrorMessage as u}from"../../../../base/common/errorMessage.js";import{Lazy as w}from"../../../../base/common/lazy.js";import{Disposable as $,DisposableStore as L}from"../../../../base/common/lifecycle.js";import{revive as H}from"../../../../base/common/marshalling.js";import{URI as f}from"../../../../base/common/uri.js";import{ICommandService as M}from"../../../../platform/commands/common/commands.js";import{IHoverService as T}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as q}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as N}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as x}from"../../../../platform/label/common/label.js";import{ILogService as P}from"../../../../platform/log/common/log.js";import{asCssVariable as h}from"../../../../platform/theme/common/colorUtils.js";import{contentRefUrl as U}from"../common/annotations.js";import{getFullyQualifiedId as E,IChatAgentNameService as O,IChatAgentService as b}from"../common/chatAgents.js";import{chatSlashCommandBackground as y,chatSlashCommandForeground as W}from"../common/chatColors.js";import{chatAgentLeader as J,ChatRequestAgentPart as F,ChatRequestAgentSubcommandPart as V,ChatRequestDynamicVariablePart as B,ChatRequestSlashCommandPart as K,ChatRequestTextPart as _,ChatRequestToolPart as j,ChatRequestVariablePart as z,chatSubcommandLeader as Q}from"../common/chatParserTypes.js";import{IChatService as G}from"../common/chatService.js";import{IChatVariablesService as X}from"../common/chatVariables.js";import{ILanguageModelToolsService as Y}from"../common/languageModelToolsService.js";import{IChatWidgetService as Z}from"./chat.js";import{ChatAgentHover as ee,getChatAgentHoverOptions as te}from"./chatAgentHover.js";import{IChatMarkdownAnchorService as ne}from"./chatContentParts/chatMarkdownAnchorService.js";import{InlineAnchorWidget as ie}from"./chatInlineAnchorWidget.js";import"./media/chatInlineAnchorWidget.css";const p="http://_vscodedecoration_",v="http://_chatagent_",R="http://_chatslash_";function re(o,c,e){const t=e.get(O),i=e.get(b),n=t.getAgentNameRestriction(o);let r=`${n?o.name:E(o)}`;n&&i.agentHasDupeName(o.id)&&(r+=` (${o.publisherDisplayName})`);const d={agentId:o.id,name:r,isClickable:c};return`[${o.name}](${v}?${encodeURIComponent(JSON.stringify(d))})`}function Fe(o,c){const e=`${Q}${c.name}`,t={agentId:o.id,command:c.name};return`[${e}](${R}?${encodeURIComponent(JSON.stringify(t))})`}let S=class extends ${constructor(e,t,i,n,r,a,d,l,g,ae,oe,se){super();this.keybindingService=e;this.logService=t;this.chatAgentService=i;this.instantiationService=n;this.hoverService=r;this.chatService=a;this.chatWidgetService=d;this.commandService=l;this.chatVariablesService=g;this.labelService=ae;this.toolsService=oe;this.chatMarkdownAnchorService=se}convertParsedRequestToMarkdown(e){let t="";for(const i of e.parts)i instanceof _?t+=i.text:i instanceof F?t+=this.instantiationService.invokeFunction(n=>re(i.agent,!1,n)):t+=this.genericDecorationToMarkdown(i);return t}genericDecorationToMarkdown(e){const t=e instanceof B&&e.data instanceof f?e.data:void 0,n={title:t?this.labelService.getUriLabel(t,{relative:!0}):e instanceof K?e.slashCommand.detail:e instanceof V?e.command.description:e instanceof z?this.chatVariablesService.getVariable(e.variableName)?.description:e instanceof j?this.toolsService.getTool(e.toolId)?.userDescription:""};return`[${e.text}](${p}?${encodeURIComponent(JSON.stringify(n))})`}walkTreeAndAnnotateReferenceLinks(e){const t=new L;return e.querySelectorAll("a").forEach(i=>{const n=i.getAttribute("data-href");if(n)if(n.startsWith(v)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(v.length+1)))}catch(a){this.logService.error("Invalid chat widget render data JSON",u(a))}r&&i.parentElement.replaceChild(this.renderAgentWidget(r,t),i)}else if(n.startsWith(R)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(v.length+1)))}catch(a){this.logService.error("Invalid chat slash command render data JSON",u(a))}r&&i.parentElement.replaceChild(this.renderSlashCommandWidget(i.textContent,r,t),i)}else if(n.startsWith(p)){let r;try{r=JSON.parse(decodeURIComponent(n.slice(p.length+1)))}catch{}i.parentElement.replaceChild(this.renderResourceWidget(i.textContent,r,t),i)}else n.startsWith(U)?this.renderFileWidget(n,i,t):n.startsWith("command:")&&this.injectKeybindingHint(i,n,this.keybindingService)}),t}renderAgentWidget(e,t){const i=`${J}${e.name}`;let n;if(e.isClickable){n=m.$("span.chat-agent-widget");const d=t.add(new C(n,{buttonBackground:h(y),buttonForeground:h(W),buttonHoverBackground:void 0}));d.label=i,t.add(d.onDidClick(()=>{const l=this.chatAgentService.getAgent(e.agentId),g=this.chatWidgetService.lastFocusedWidget;!g||!l||this.chatService.sendRequest(g.viewModel.sessionId,l.metadata.sampleRequest??"",{location:g.location,agentId:l.id})}))}else n=this.renderResourceWidget(i,void 0,t);const r=this.chatAgentService.getAgent(e.agentId),a=new w(()=>t.add(this.instantiationService.createInstance(ee)));return t.add(this.hoverService.setupManagedHover(A("element"),n,()=>(a.value.setAgent(e.agentId),a.value.domNode),r&&te(()=>r,this.commandService))),n}renderSlashCommandWidget(e,t,i){const n=m.$("span.chat-agent-widget.chat-command-widget"),r=this.chatAgentService.getAgent(t.agentId),a=i.add(new C(n,{buttonBackground:h(y),buttonForeground:h(W),buttonHoverBackground:void 0}));return a.label=e,i.add(a.onDidClick(()=>{const d=this.chatWidgetService.lastFocusedWidget;if(!d||!r)return;const l=r.slashCommands.find(g=>g.name===t.command);this.chatService.sendRequest(d.viewModel.sessionId,l?.sampleRequest??"",{location:d.location,agentId:r.id,slashCommand:t.command})})),n}renderFileWidget(e,t,i){const n=f.parse(e);let r;try{r=H(JSON.parse(n.fragment))}catch(d){this.logService.error("Invalid chat widget render data JSON",u(d));return}if(r.kind!=="symbol"&&!f.isUri(r.uri)){this.logService.error(`Invalid chat widget render data: ${n.fragment}`);return}const a=i.add(this.instantiationService.createInstance(ie,t,r));this.chatMarkdownAnchorService.register(a)}renderResourceWidget(e,t,i){const n=m.$("span.chat-resource-widget"),r=m.$("span",void 0,e);return t?.title&&i.add(this.hoverService.setupManagedHover(A("element"),n,t.title)),n.appendChild(r),n}injectKeybindingHint(e,t,i){const n=t.match(/command:([^\)]+)/)?.[1];if(n){const r=i.lookupKeybinding(n);if(r){const a=r.getLabel();a&&(e.textContent=`${e.textContent} (${a})`)}}}};S=I([s(0,N),s(1,P),s(2,b),s(3,q),s(4,T),s(5,G),s(6,Z),s(7,M),s(8,X),s(9,x),s(10,Y),s(11,ne)],S);export{S as ChatMarkdownDecorationsRenderer,Fe as agentSlashCommandToMarkdown,re as agentToMarkdown};
