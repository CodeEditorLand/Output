var R=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var S=(s,e,n,i)=>{for(var t=i>1?void 0:i?M(e,n):e,r=s.length-1,a;r>=0;r--)(a=s[r])&&(t=(i?a(e,n,t):a(t))||t);return i&&t&&R(e,n,t),t},c=(s,e)=>(n,i)=>e(n,i,s);import*as g from"../../../../base/browser/dom.js";import{Button as p}from"../../../../base/browser/ui/button/button.js";import{getDefaultHoverDelegate as f}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{toErrorMessage as I}from"../../../../base/common/errorMessage.js";import{Lazy as k}from"../../../../base/common/lazy.js";import{DisposableStore as w}from"../../../../base/common/lifecycle.js";import{URI as C}from"../../../../base/common/uri.js";import{ICommandService as D}from"../../../../platform/commands/common/commands.js";import{IHoverService as L}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as $}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as H}from"../../../../platform/keybinding/common/keybinding.js";import{ILabelService as T}from"../../../../platform/label/common/label.js";import{ILogService as q}from"../../../../platform/log/common/log.js";import{asCssVariable as m}from"../../../../platform/theme/common/colorUtils.js";import{contentRefUrl as N}from"../common/annotations.js";import{getFullyQualifiedId as x,IChatAgentNameService as P,IChatAgentService as A}from"../common/chatAgents.js";import{chatSlashCommandBackground as b,chatSlashCommandForeground as W}from"../common/chatColors.js";import{chatAgentLeader as U,ChatRequestAgentPart as E,ChatRequestAgentSubcommandPart as O,ChatRequestDynamicVariablePart as F,ChatRequestSlashCommandPart as J,ChatRequestTextPart as V,ChatRequestToolPart as B,ChatRequestVariablePart as K,chatSubcommandLeader as _}from"../common/chatParserTypes.js";import{IChatService as j}from"../common/chatService.js";import{IChatVariablesService as z}from"../common/chatVariables.js";import{ILanguageModelToolsService as Q}from"../common/languageModelToolsService.js";import{IChatWidgetService as G}from"./chat.js";import{ChatAgentHover as X,getChatAgentHoverOptions as Y}from"./chatAgentHover.js";import{IChatMarkdownAnchorService as Z}from"./chatContentParts/chatMarkdownAnchorService.js";import{InlineAnchorWidget as ee}from"./chatInlineAnchorWidget.js";import"./media/chatInlineAnchorWidget.css";const u="http://_vscodedecoration_",h="http://_chatagent_",y="http://_chatslash_";function te(s,e,n){const i=n.get(P),t=n.get(A),r=i.getAgentNameRestriction(s);let a=`${r?s.name:x(s)}`;r&&t.agentHasDupeName(s.id)&&(a+=` (${s.publisherDisplayName})`);const d={agentId:s.id,name:a,isClickable:e};return`[${s.name}](${h}?${encodeURIComponent(JSON.stringify(d))})`}function Ue(s,e){const n=`${_}${e.name}`,i={agentId:s.id,command:e.name};return`[${n}](${y}?${encodeURIComponent(JSON.stringify(i))})`}let v=class{constructor(e,n,i,t,r,a,o,d,l,ne,ie,re){this.keybindingService=e;this.logService=n;this.chatAgentService=i;this.instantiationService=t;this.hoverService=r;this.chatService=a;this.chatWidgetService=o;this.commandService=d;this.chatVariablesService=l;this.labelService=ne;this.toolsService=ie;this.chatMarkdownAnchorService=re}convertParsedRequestToMarkdown(e){let n="";for(const i of e.parts)i instanceof V?n+=i.text:i instanceof E?n+=this.instantiationService.invokeFunction(t=>te(i.agent,!1,t)):n+=this.genericDecorationToMarkdown(i);return n}genericDecorationToMarkdown(e){const n=e instanceof F&&e.data instanceof C?e.data:void 0,t={title:n?this.labelService.getUriLabel(n,{relative:!0}):e instanceof J?e.slashCommand.detail:e instanceof O?e.command.description:e instanceof K?this.chatVariablesService.getVariable(e.variableName)?.description:e instanceof B?this.toolsService.getTool(e.toolId)?.userDescription:""};return`[${e.text}](${u}?${encodeURIComponent(JSON.stringify(t))})`}walkTreeAndAnnotateReferenceLinks(e,n){const i=new w;return n.querySelectorAll("a").forEach(t=>{const r=t.getAttribute("data-href");if(r)if(r.startsWith(h)){let a;try{a=JSON.parse(decodeURIComponent(r.slice(h.length+1)))}catch(o){this.logService.error("Invalid chat widget render data JSON",I(o))}a&&t.parentElement.replaceChild(this.renderAgentWidget(a,i),t)}else if(r.startsWith(y)){let a;try{a=JSON.parse(decodeURIComponent(r.slice(h.length+1)))}catch(o){this.logService.error("Invalid chat slash command render data JSON",I(o))}a&&t.parentElement.replaceChild(this.renderSlashCommandWidget(t.textContent,a,i),t)}else if(r.startsWith(u)){let a;try{a=JSON.parse(decodeURIComponent(r.slice(u.length+1)))}catch{}t.parentElement.replaceChild(this.renderResourceWidget(t.textContent,a,i),t)}else r.startsWith(N)?this.renderFileWidget(e,r,t,i):r.startsWith("command:")&&this.injectKeybindingHint(t,r,this.keybindingService)}),i}renderAgentWidget(e,n){const i=`${U}${e.name}`;let t;if(e.isClickable){t=g.$("span.chat-agent-widget");const o=n.add(new p(t,{buttonBackground:m(b),buttonForeground:m(W),buttonHoverBackground:void 0}));o.label=i,n.add(o.onDidClick(()=>{const d=this.chatAgentService.getAgent(e.agentId),l=this.chatWidgetService.lastFocusedWidget;!l||!d||this.chatService.sendRequest(l.viewModel.sessionId,d.metadata.sampleRequest??"",{location:l.location,agentId:d.id,userSelectedModelId:l.input.currentLanguageModel})}))}else t=this.renderResourceWidget(i,void 0,n);const r=this.chatAgentService.getAgent(e.agentId),a=new k(()=>n.add(this.instantiationService.createInstance(X)));return n.add(this.hoverService.setupManagedHover(f("element"),t,()=>(a.value.setAgent(e.agentId),a.value.domNode),r&&Y(()=>r,this.commandService))),t}renderSlashCommandWidget(e,n,i){const t=g.$("span.chat-agent-widget.chat-command-widget"),r=this.chatAgentService.getAgent(n.agentId),a=i.add(new p(t,{buttonBackground:m(b),buttonForeground:m(W),buttonHoverBackground:void 0}));return a.label=e,i.add(a.onDidClick(()=>{const o=this.chatWidgetService.lastFocusedWidget;if(!o||!r)return;const d=r.slashCommands.find(l=>l.name===n.command);this.chatService.sendRequest(o.viewModel.sessionId,d?.sampleRequest??"",{location:o.location,agentId:r.id,slashCommand:n.command,userSelectedModelId:o.input.currentLanguageModel})})),t}renderFileWidget(e,n,i,t){const r=C.parse(n),a=e.inlineReferences?.[r.path.slice(1)];if(!a){this.logService.error("Invalid chat widget render data JSON");return}const o=t.add(this.instantiationService.createInstance(ee,i,a));this.chatMarkdownAnchorService.register(o)}renderResourceWidget(e,n,i){const t=g.$("span.chat-resource-widget"),r=g.$("span",void 0,e);return n?.title&&i.add(this.hoverService.setupManagedHover(f("element"),t,n.title)),t.appendChild(r),t}injectKeybindingHint(e,n,i){const t=n.match(/command:([^\)]+)/)?.[1];if(t){const r=i.lookupKeybinding(t);if(r){const a=r.getLabel();a&&(e.textContent=`${e.textContent} (${a})`)}}}};v=S([c(0,H),c(1,q),c(2,A),c(3,$),c(4,L),c(5,j),c(6,G),c(7,D),c(8,z),c(9,T),c(10,Q),c(11,Z)],v);export{v as ChatMarkdownDecorationsRenderer,Ue as agentSlashCommandToMarkdown,te as agentToMarkdown};
