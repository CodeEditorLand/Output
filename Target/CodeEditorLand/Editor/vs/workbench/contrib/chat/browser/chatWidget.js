var K=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var O=(u,d,e,i)=>{for(var t=i>1?void 0:i?Q(d,e):d,n=u.length-1,o;n>=0;n--)(o=u[n])&&(t=(i?o(d,e,t):o(t))||t);return i&&t&&K(d,e,t),t},c=(u,d)=>(e,i)=>d(e,i,u);import*as h from"../../../../base/browser/dom.js";import{renderIcon as X}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/browser/ui/tree/tree.js";import{disposableTimeout as j,timeout as z}from"../../../../base/common/async.js";import{toErrorMessage as G}from"../../../../base/common/errorMessage.js";import{Emitter as p,Event as J}from"../../../../base/common/event.js";import{MarkdownString as R}from"../../../../base/common/htmlContent.js";import{Disposable as Y,DisposableStore as W,MutableDisposable as Z,combinedDisposable as ee,toDisposable as te}from"../../../../base/common/lifecycle.js";import{Schemas as ie}from"../../../../base/common/network.js";import{extUri as ne,isEqual as se}from"../../../../base/common/resources.js";import{isDefined as oe}from"../../../../base/common/types.js";import"../../../../base/common/uri.js";import"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as re}from"../../../../editor/browser/services/codeEditorService.js";import{MarkdownRenderer as ae}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as k}from"../../../../nls.js";import{MenuId as B}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as N}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as de}from"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/editor/common/editor.js";import{IInstantiationService as he}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as le}from"../../../../platform/instantiation/common/serviceCollection.js";import{WorkbenchObjectTree as ce}from"../../../../platform/list/browser/listService.js";import{ILogService as ue}from"../../../../platform/log/common/log.js";import{IStorageService as ge,StorageScope as V,StorageTarget as pe}from"../../../../platform/storage/common/storage.js";import{IThemeService as me}from"../../../../platform/theme/common/themeService.js";import{TerminalChatController as Ce}from"../../terminal/terminalContribChatExports.js";import{ChatAgentLocation as Ie,IChatAgentService as ve,isChatWelcomeMessageContent as fe}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_HAS_AGENT as Se,CONTEXT_CHAT_LOCATION as ye,CONTEXT_CHAT_REQUEST_IN_PROGRESS as we,CONTEXT_IN_CHAT_SESSION as De,CONTEXT_IN_QUICK_CHAT as Me,CONTEXT_LAST_ITEM_ID as _e,CONTEXT_PARTICIPANT_SUPPORTS_MODEL_PICKER as be,CONTEXT_RESPONSE_FILTERED as Te}from"../common/chatContextKeys.js";import{ChatEditingSessionState as Ee,IChatEditingService as Pe}from"../common/chatEditingService.js";import"../common/chatModel.js";import{ChatRequestAgentPart as Ae,chatAgentLeader as Fe,chatSubcommandLeader as q,formatChatQuestion as xe}from"../common/chatParserTypes.js";import{ChatRequestParser as Le}from"../common/chatRequestParser.js";import{IChatService as He}from"../common/chatService.js";import{IChatSlashCommandService as Oe}from"../common/chatSlashCommands.js";import{ChatViewModel as Re,isRequestVM as A,isResponseVM as m}from"../common/chatViewModel.js";import"../common/chatWidgetHistoryService.js";import{CodeBlockModelCollection as We}from"../common/codeBlockModelCollection.js";import{IChatAccessibilityService as ke,IChatWidgetService as Be}from"./chat.js";import{ChatAccessibilityProvider as Ne}from"./chatAccessibilityProvider.js";import"./chatAttachmentModel.js";import{ChatDragAndDrop as Ve}from"./chatDragAndDrop.js";import{ChatInputPart as qe}from"./chatInputPart.js";import{ChatListDelegate as $e,ChatListItemRenderer as Ue}from"./chatListRenderer.js";import{ChatEditorOptions as Ke}from"./chatOptions.js";import"./media/chat.css";import"./media/chatAgentHover.css";const C=h.$;function I(u){u.scrollTop=u.scrollHeight-u.renderHeight}function Qe(u){return"viewContext"in u&&"isQuickChat"in u.viewContext&&!!u.viewContext.isQuickChat}const $="chat.welcomeMessageContent";let v=class extends Y{constructor(e,i,t,n,o,r,s,l,g,f,F,x,_,Xe,je,ze,U){super();this.viewOptions=t;this.styles=n;this.contextKeyService=r;this.instantiationService=s;this.chatService=l;this.chatAgentService=g;this.contextMenuService=F;this.chatAccessibilityService=x;this.logService=_;this.themeService=Xe;this.chatSlashCommandService=je;this.chatEditingService=ze;this.storageService=U;this.viewContext=i??{},typeof e=="object"?this._location=e:this._location={location:e},De.bindTo(r).set(!0),ye.bindTo(r).set(this._location.location),Me.bindTo(r).set(Qe(this)),this.agentInInput=Se.bindTo(r),this.agentSupportsModelPicker=be.bindTo(r),this.requestInProgress=we.bindTo(r),this._register(f.register(this)),this._codeBlockModelCollection=this._register(s.createInstance(We));const y=this._register(new W);if(this._register(this.chatEditingService.onDidCreateEditingSession(a=>{a.chatSessionId===this.viewModel?.sessionId&&(y.clear(),this.renderChatEditingSessionState(null),y.add(a.onDidChange(()=>{this.renderChatEditingSessionState(a)})),y.add(a.onDidDispose(()=>{y.clear(),this.renderChatEditingSessionState(null)})),this.renderChatEditingSessionState(a))})),this._location.location===Ie.EditingSession){let a;this._register(this.onDidChangeViewModel(async()=>{const w=this._viewModel?.sessionId;w!==a?.chatSessionId&&(a&&a.state.get()!==Ee.Disposed&&await a.stop(),w?a=await this.chatEditingService.startOrContinueEditingSession(w,{silent:!0}):a=void 0)}))}this._register(o.registerCodeEditorOpenHandler(async(a,w,Ge)=>{const b=a.resource;if(b.scheme!==ie.vscodeChatCodeBlock)return null;const H=b.path.split("/").at(1);if(!H)return null;const T=this.viewModel?.getItems().find(D=>D.id===H);if(!T)return null;this.reveal(T),await z(0);for(const D of this.renderer.editorsInUse())if(ne.isEqual(D.uri,b,!0)){const S=D.editor;let E=0;const P=S.getDomNode();if(P){const M=h.findParentWithClass(P,"monaco-list-row");M&&(E=h.getTopLeftOffset(P).top-h.getTopLeftOffset(M).top)}if(a.options?.selection){const M=S.getTopForPosition(a.options.selection.startLineNumber,a.options.selection.startColumn);E+=M,S.focus(),S.setSelection({startLineNumber:a.options.selection.startLineNumber,startColumn:a.options.selection.startColumn,endLineNumber:a.options.selection.endLineNumber??a.options.selection.startLineNumber,endColumn:a.options.selection.endColumn??a.options.selection.startColumn})}return this.reveal(T,E),S}return null}));const L=U.getObject(`${$}.${this.location}`,V.APPLICATION);fe(L)&&(this.persistedWelcomeMessage=L),this._register(this.onDidChangeParsedInput(()=>this.updateChatInputContext()))}static CONTRIBS=[];_onDidSubmitAgent=this._register(new p);onDidSubmitAgent=this._onDidSubmitAgent.event;_onDidChangeAgent=this._register(new p);onDidChangeAgent=this._onDidChangeAgent.event;_onDidFocus=this._register(new p);onDidFocus=this._onDidFocus.event;_onDidChangeViewModel=this._register(new p);onDidChangeViewModel=this._onDidChangeViewModel.event;_onDidScroll=this._register(new p);onDidScroll=this._onDidScroll.event;_onDidClear=this._register(new p);onDidClear=this._onDidClear.event;_onDidAcceptInput=this._register(new p);onDidAcceptInput=this._onDidAcceptInput.event;_onDidHide=this._register(new p);onDidHide=this._onDidHide.event;_onDidChangeParsedInput=this._register(new p);onDidChangeParsedInput=this._onDidChangeParsedInput.event;_onWillMaybeChangeHeight=new p;onWillMaybeChangeHeight=this._onWillMaybeChangeHeight.event;_onDidChangeHeight=this._register(new p);onDidChangeHeight=this._onDidChangeHeight.event;_onDidChangeContentHeight=new p;onDidChangeContentHeight=this._onDidChangeContentHeight.event;contribs=[];tree;renderer;_codeBlockModelCollection;inputPart;editorOptions;listContainer;container;welcomeMessageContainer;persistedWelcomeMessage;bodyDimension;visibleChangeCount=0;requestInProgress;agentInInput;agentSupportsModelPicker;_visible=!1;get visible(){return this._visible}previousTreeScrollHeight=0;viewModelDisposables=this._register(new W);_viewModel;set viewModel(e){this._viewModel!==e&&(this.viewModelDisposables.clear(),this._viewModel=e,e&&this.viewModelDisposables.add(e),this._onDidChangeViewModel.fire())}get viewModel(){return this._viewModel}parsedChatRequest;get parsedInput(){if(this.parsedChatRequest===void 0){if(!this.viewModel)return{text:"",parts:[]};this.parsedChatRequest=this.instantiationService.createInstance(Le).parseChatRequest(this.viewModel.sessionId,this.getInput(),this.location,{selectedAgent:this._lastSelectedAgent})}return this.parsedChatRequest}get scopedContextKeyService(){return this.contextKeyService}_location;get location(){return this._location.location}viewContext;_lastSelectedAgent;set lastSelectedAgent(e){this.parsedChatRequest=void 0,this._lastSelectedAgent=e,this._onDidChangeParsedInput.fire()}get lastSelectedAgent(){return this._lastSelectedAgent}get supportsFileReferences(){return!!this.viewOptions.supportsFileReferences}get input(){return this.inputPart}get inputEditor(){return this.inputPart.inputEditor}get inputUri(){return this.inputPart.inputUri}get contentHeight(){return this.inputPart.contentHeight+this.tree.contentHeight}get attachmentModel(){return this.inputPart.attachmentModel}render(e){const i="viewId"in this.viewContext?this.viewContext.viewId:void 0;this.editorOptions=this._register(this.instantiationService.createInstance(Ke,i,this.styles.listForeground,this.styles.inputEditorBackground,this.styles.resultEditorBackground));const t=this.viewOptions.renderInputOnTop??!1,n=this.viewOptions.renderFollowups??!t,o=this.viewOptions.renderStyle;this.container=h.append(e,C(".interactive-session")),this.welcomeMessageContainer=h.append(this.container,C(".chat-welcome-view",{style:"display: none"})),this.renderWelcomeViewContentIfNeeded(),t?(this.createInput(this.container,{renderFollowups:n,renderStyle:o}),this.listContainer=h.append(this.container,C(".interactive-list"))):(this.listContainer=h.append(this.container,C(".interactive-list")),this.createInput(this.container,{renderFollowups:n,renderStyle:o})),this.createList(this.listContainer,{...this.viewOptions.rendererOptions,renderStyle:o}),this._register(this.editorOptions.onDidChange(()=>this.onDidStyleChange())),this.onDidStyleChange(),this.viewModel&&(this.onDidChangeItems(),I(this.tree)),this.contribs=v.CONTRIBS.map(r=>{try{return this._register(this.instantiationService.createInstance(r,this))}catch(s){this.logService.error("Failed to instantiate chat widget contrib",G(s));return}}).filter(oe),this._register(this.instantiationService.createInstance(Ve,this.container,this.inputPart,this.styles))}getContrib(e){return this.contribs.find(i=>i.id===e)}focusInput(){this.inputPart.focus()}hasInputFocus(){return this.inputPart.hasFocus()}getSibling(e,i){if(!m(e))return;const t=this.viewModel?.getItems();if(!t)return;const n=t.filter(s=>m(s)),o=n.indexOf(e);if(o===void 0)return;const r=i==="next"?o+1:o-1;if(!(r<0||r>n.length-1))return n[r]}clear(){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=!0),this._onDidClear.fire()}onDidChangeItems(e){if(this.tree&&this._visible){const i=(this.viewModel?.getItems()??[]).map(n=>({element:n,collapsed:!1,collapsible:!1}));this.renderWelcomeViewContentIfNeeded(),this._onWillMaybeChangeHeight.fire(),this.tree.setChildren(null,i,{diffIdentityProvider:{getId:n=>n.dataId+`${A(n)}${m(n)&&n.renderData?`_${this.visibleChangeCount}`:""}`+(m(n)?`_${n.contentReferences.length}`:"")+(A(n)&&n.contentReferences?`_${n.contentReferences?.length}`:"")}}),!e&&this._dynamicMessageLayoutData&&this.layoutDynamicChatTreeItemMode();const t=i[i.length-1]?.element;t&&_e.bindTo(this.contextKeyService).set([t.id]),t&&m(t)&&t.isComplete?this.renderFollowups(t.replyFollowups,t):!i.length&&this.viewModel?this.renderFollowups(this.viewModel.model.sampleQuestions):this.renderFollowups(void 0)}}renderWelcomeViewContentIfNeeded(){const e=this.viewModel?.model.welcomeMessage??this.persistedWelcomeMessage;if(e&&this.welcomeMessageContainer.children.length===0&&!this.viewOptions.renderStyle){const i=h.append(this.welcomeMessageContainer,C(".chat-welcome-view-icon")),t=h.append(this.welcomeMessageContainer,C(".chat-welcome-view-title")),n=h.append(this.welcomeMessageContainer,C(".chat-welcome-view-message")),o=h.append(this.welcomeMessageContainer,C(".chat-welcome-view-tips"));i.appendChild(X(e.icon)),t.textContent=e.title;const r=this.instantiationService.createInstance(ae,{}),s=this._register(r.render(e.message));h.append(n,s.element);const l=this.viewOptions.supportsAdditionalParticipants?new R(k("chatWidget.tips",`{0} to attach context

{1} to chat with extensions`,"$(attach)","$(mention)"),{supportThemeIcons:!0}):new R(k("chatWidget.tips.withoutParticipants","{0} to attach context","$(attach)"),{supportThemeIcons:!0}),g=this._register(r.render(l));o.appendChild(g.element)}if(!this.viewOptions.renderStyle&&this.viewModel){const i=this.viewModel.getItems();h.setVisibility(i.length===0,this.welcomeMessageContainer),h.setVisibility(i.length!==0,this.listContainer)}}async renderChatEditingSessionState(e){this.inputPart.renderChatEditingSessionState(e,this),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}async renderFollowups(e,i){this.inputPart.renderFollowups(e,i),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}setVisible(e){const i=this._visible;this._visible=e,this.visibleChangeCount++,this.renderer.setVisible(e),this.input.setVisible(e),e?this._register(j(()=>{this._visible&&this.onDidChangeItems(!0)},0)):i&&this._onDidHide.fire()}createList(e,i){const t=this._register(this._register(this.instantiationService.createChild(new le([N,this.contextKeyService])))),n=t.createInstance($e,this.viewOptions.defaultElementHeight??200),o={getListLength:()=>this.tree.getNode(null).visibleChildrenCount,onDidScroll:this.onDidScroll},r=document.createElement("div");r.classList.add("chat-overflow-widget-container","monaco-editor"),e.append(r),this.renderer=this._register(t.createInstance(Ue,this.editorOptions,i,o,this._codeBlockModelCollection,r)),this._register(this.renderer.onDidClickFollowup(s=>{this.acceptInput(s.message)})),this._register(this.renderer.onDidClickRerunWithAgentOrCommandDetection(s=>{const l=this.chatService.getSession(s.sessionId)?.getRequests().find(g=>g.id===s.requestId);l&&this.chatService.resendRequest(l,{noCommandDetection:!0,attempt:l.attempt+1,location:this.location}).catch(g=>this.logService.error("FAILED to rerun request",g))})),this.tree=this._register(t.createInstance(ce,"Chat",e,n,[this.renderer],{identityProvider:{getId:s=>s.id},horizontalScrolling:!1,alwaysConsumeMouseWheel:!1,supportDynamicHeights:!0,hideTwistiesOfChildlessElements:!0,accessibilityProvider:this.instantiationService.createInstance(Ne),keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:s=>A(s)?s.message:m(s)?s.response.value:""},setRowLineHeight:!1,filter:this.viewOptions.filter?{filter:this.viewOptions.filter.bind(this.viewOptions)}:void 0,overrideStyles:{listFocusBackground:this.styles.listBackground,listInactiveFocusBackground:this.styles.listBackground,listActiveSelectionBackground:this.styles.listBackground,listFocusAndSelectionBackground:this.styles.listBackground,listInactiveSelectionBackground:this.styles.listBackground,listHoverBackground:this.styles.listBackground,listBackground:this.styles.listBackground,listFocusForeground:this.styles.listForeground,listHoverForeground:this.styles.listForeground,listInactiveFocusForeground:this.styles.listForeground,listInactiveSelectionForeground:this.styles.listForeground,listActiveSelectionForeground:this.styles.listForeground,listFocusAndSelectionForeground:this.styles.listForeground,listActiveSelectionIconForeground:void 0,listInactiveSelectionIconForeground:void 0}})),this._register(this.tree.onContextMenu(s=>this.onContextMenu(s))),this._register(this.tree.onDidChangeContentHeight(()=>{this.onDidChangeTreeContentHeight()})),this._register(this.renderer.onDidChangeItemHeight(s=>{this.tree.updateElementHeight(s.element,s.height)})),this._register(this.tree.onDidFocus(()=>{this._onDidFocus.fire()})),this._register(this.tree.onDidScroll(()=>{this._onDidScroll.fire()}))}onContextMenu(e){e.browserEvent.preventDefault(),e.browserEvent.stopPropagation();const i=e.element,t=this.contextKeyService.createOverlay([[Te.key,m(i)&&!!i.errorDetails?.responseIsFiltered]]);this.contextMenuService.showContextMenu({menuId:B.ChatContext,menuActionOptions:{shouldForwardArgs:!0},contextKeyService:t,getAnchor:()=>e.anchor,getActionsContext:()=>i})}onDidChangeTreeContentHeight(){this.tree.scrollHeight!==this.previousTreeScrollHeight&&this.tree.scrollTop+this.tree.renderHeight>=this.previousTreeScrollHeight-2&&h.scheduleAtNextAnimationFrame(h.getWindow(this.listContainer),()=>{I(this.tree)},0),this.previousTreeScrollHeight=this.tree.scrollHeight,this._onDidChangeContentHeight.fire()}createInput(e,i){this.inputPart=this._register(this.instantiationService.createInstance(qe,this.location,{renderFollowups:i?.renderFollowups??!0,renderStyle:i?.renderStyle==="minimal"?"compact":i?.renderStyle,menus:{executeToolbar:B.ChatExecute,...this.viewOptions.menus},editorOverflowWidgetsDomNode:this.viewOptions.editorOverflowWidgetsDomNode},()=>this.collectInputState())),this.inputPart.render(e,"",this),this._register(this.inputPart.onDidLoadInputState(t=>{this.contribs.forEach(n=>{if(n.setInputState){const o=(typeof t=="object"&&t?.[n.id])??{};n.setInputState(o)}})})),this._register(this.inputPart.onDidFocus(()=>this._onDidFocus.fire())),this._register(this.inputPart.onDidAcceptFollowup(t=>{if(!this.viewModel)return;let n="";if(t.followup.agentId&&t.followup.agentId!==this.chatAgentService.getDefaultAgent(this.location)?.id){const o=this.chatAgentService.getAgent(t.followup.agentId);if(!o)return;this.lastSelectedAgent=o,n=`${Fe}${o.name} `,t.followup.subCommand&&(n+=`${q}${t.followup.subCommand} `)}else!t.followup.agentId&&t.followup.subCommand&&this.chatSlashCommandService.hasCommand(t.followup.subCommand)&&(n=`${q}${t.followup.subCommand} `);n+=t.followup.message,this.acceptInput(n),t.response&&this.chatService.notifyUserAction({sessionId:this.viewModel.sessionId,requestId:t.response.requestId,agentId:t.response.agent?.id,command:t.response.slashCommand?.name,result:t.response.result,action:{kind:"followUp",followup:t.followup}})})),this._register(this.inputPart.onDidChangeHeight(()=>{this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width),this._onDidChangeContentHeight.fire()})),this._register(this.inputPart.attachmentModel.onDidChangeContext(()=>{this.chatEditingService.currentEditingSession&&this.chatEditingService.currentEditingSession?.chatSessionId===this.viewModel?.sessionId&&this.renderChatEditingSessionState(this.chatEditingService.currentEditingSession)})),this._register(this.inputEditor.onDidChangeModelContent(()=>{this.parsedChatRequest=void 0,this.updateChatInputContext()})),this._register(this.chatAgentService.onDidChangeAgents(()=>this.parsedChatRequest=void 0))}onDidStyleChange(){this.container.style.setProperty("--vscode-interactive-result-editor-background-color",this.editorOptions.configuration.resultEditor.backgroundColor?.toString()??""),this.container.style.setProperty("--vscode-interactive-session-foreground",this.editorOptions.configuration.foreground?.toString()??""),this.container.style.setProperty("--vscode-chat-list-background",this.themeService.getColorTheme().getColor(this.styles.listBackground)?.toString()??"")}setModel(e,i){if(!this.container)throw new Error("Call render() before setModel()");e.sessionId!==this.viewModel?.sessionId&&(this._codeBlockModelCollection.clear(),this.container.setAttribute("data-session-id",e.sessionId),this.viewModel=this.instantiationService.createInstance(Re,e,this._codeBlockModelCollection),this.viewModelDisposables.add(J.accumulate(this.viewModel.onDidChange,0)(t=>{this.viewModel&&(this.requestInProgress.set(this.viewModel.requestInProgress),this.onDidChangeItems(),t.some(n=>n?.kind==="addRequest")&&this.visible&&(I(this.tree),this.focusInput()),this.chatEditingService.currentEditingSession&&this.chatEditingService.currentEditingSession?.chatSessionId===this.viewModel?.sessionId&&this.renderChatEditingSessionState(this.chatEditingService.currentEditingSession))})),this.viewModelDisposables.add(this.viewModel.onDidDisposeModel(()=>{this.inputPart.saveState(),this.viewModel=void 0,this.onDidChangeItems()})),this.inputPart.initForNewChatModel(i),this.contribs.forEach(t=>{t.setInputState&&i.inputState?.[t.id]&&t.setInputState(i.inputState?.[t.id])}),this.viewModelDisposables.add(e.onDidChange(t=>{t.kind==="setAgent"&&this._onDidChangeAgent.fire({agent:t.agent,slashCommand:t.command})})),this.tree&&(this.onDidChangeItems(),I(this.tree)),this.updateChatInputContext())}getFocus(){return this.tree.getFocus()[0]??void 0}reveal(e,i){this.tree.reveal(e,i)}focus(e){const t=this.tree.getNode(null).children.find(n=>n.element?.id===e.id);t&&(this.tree.setFocus([t.element]),this.tree.domFocus())}refilter(){this.tree.refilter()}setInputPlaceholder(e){this.viewModel?.setInputPlaceholder(e)}resetInputPlaceholder(){this.viewModel?.resetInputPlaceholder()}setInput(e=""){this.inputPart.setValue(e,!1)}getInput(){return this.inputPart.inputEditor.getValue()}logInputHistory(){this.inputPart.logInputHistory()}async acceptInput(e,i){return this._acceptInput(e?{query:e}:void 0,i)}async acceptInputWithPrefix(e){this._acceptInput({prefix:e})}collectInputState(){const e={};return this.contribs.forEach(i=>{i.getInputState&&(e[i.id]=i.getInputState())}),e}async _acceptInput(e,i){if(this.viewModel){this._onDidAcceptInput.fire();const t=this.getInput(),n=this.chatAccessibilityService.acceptRequest(),o=e?"query"in e?e.query:`${e.prefix} ${t}`:t,r=!e||"prefix"in e,s=await this.chatService.sendRequest(this.viewModel.sessionId,o,{userSelectedModelId:this.inputPart.currentLanguageModel,location:this.location,locationData:this._location.resolveData?.(),parserContext:{selectedAgent:this._lastSelectedAgent},attachedContext:[...this.attachmentModel.attachments]});if(s)return this.inputPart.acceptInput(r),this._onDidSubmitAgent.fire({agent:s.agent,slashCommand:s.slashCommand}),s.responseCompletePromise.then(()=>{const l=this.viewModel?.getItems().filter(m),g=l?.[l.length-1];if(this.chatAccessibilityService.acceptResponse(g,n,i),g?.result?.nextQuestion){const{prompt:f,participant:F,command:x}=g.result.nextQuestion,_=xe(this.chatAgentService,this.location,f,F,x);_&&this.input.setValue(_,!1)}}),s.responseCreatedPromise}}getCodeBlockInfosForResponse(e){return this.renderer.getCodeBlockInfosForResponse(e)}getCodeBlockInfoForEditor(e){return this.renderer.getCodeBlockInfoForEditor(e)}getFileTreeInfosForResponse(e){return this.renderer.getFileTreeInfosForResponse(e)}getLastFocusedFileTreeForResponse(e){return this.renderer.getLastFocusedFileTreeForResponse(e)}focusLastMessage(){if(!this.viewModel)return;const e=this.tree.getNode(null).children,i=e[e.length-1];i&&(this.tree.setFocus([i.element]),this.tree.domFocus())}layout(e,i){i=Math.min(i,850),this.bodyDimension=new h.Dimension(i,e);const t=this._dynamicMessageLayoutData?.enabled?this._dynamicMessageLayoutData.maxHeight:e;this.inputPart.layout(t,i);const n=this.inputPart.inputPartHeight,o=this.tree.scrollTop+this.tree.renderHeight>=this.tree.scrollHeight,r=Math.max(0,e-n);this.tree.layout(r,i),this.tree.getHTMLElement().style.height=`${r}px`;const s=Math.max(100-this.inputPart.followupsHeight,0);this.welcomeMessageContainer.style.height=`${r-s}px`,this.welcomeMessageContainer.style.paddingBottom=`${s}px`,this.renderer.layout(i),o&&I(this.tree),this.listContainer.style.height=`${r}px`,this._onDidChangeHeight.fire(e)}_dynamicMessageLayoutData;setDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0},this._register(this.renderer.onDidChangeItemHeight(()=>this.layoutDynamicChatTreeItemMode()));const t=this._register(new Z);this._register(this.tree.onDidScroll(n=>{this._dynamicMessageLayoutData?.enabled&&(t.value=h.scheduleAtNextAnimationFrame(h.getWindow(this.listContainer),()=>{if(!n.scrollTopChanged||n.heightChanged||n.scrollHeightChanged)return;const o=n.height,r=n.scrollHeight-o-n.scrollTop;if(r===0)return;const s=this._dynamicMessageLayoutData?.maxHeight??i,l=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(s,l);const g=this.inputPart.inputPartHeight,f=Math.min(o+r,s-g);this.layout(f+g,l)}))}))}updateDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0};let t=!1,n=this.bodyDimension.height,o=this.bodyDimension.width;i<this.bodyDimension.height&&(n=i,t=!0);const r=this.container.offsetWidth;this.bodyDimension?.width!==r&&(o=r,t=!0),t&&this.layout(n,o)}get isDynamicChatTreeItemLayoutEnabled(){return this._dynamicMessageLayoutData?.enabled??!1}set isDynamicChatTreeItemLayoutEnabled(e){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=e)}layoutDynamicChatTreeItemMode(){if(!this.viewModel||!this._dynamicMessageLayoutData?.enabled)return;const e=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(this._dynamicMessageLayoutData.maxHeight,e);const i=this.inputPart.inputPartHeight,t=this.viewModel.getItems(),n=t.slice(-this._dynamicMessageLayoutData.numOfMessages),o=n.some(s=>s.currentRenderedHeight===void 0),r=o?this._dynamicMessageLayoutData.maxHeight:n.reduce((s,l)=>s+l.currentRenderedHeight,0);this.layout(Math.min(i+r+(t.length>2?18:0),this._dynamicMessageLayoutData.maxHeight),e),(o||!r)&&I(this.tree)}saveState(){this.inputPart.saveState(),this.viewModel?.model.welcomeMessage&&this.storageService.store($,this.viewModel?.model.welcomeMessage,V.APPLICATION,pe.MACHINE)}getViewState(){return{inputValue:this.getInput(),inputState:this.inputPart.getViewState(),selectedLanguageModelId:this.inputPart.currentLanguageModel}}updateChatInputContext(){const e=this.parsedInput.parts.find(i=>i instanceof Ae);this.agentInInput.set(!!e),this.agentSupportsModelPicker.set(!e||!!e.agent.supportsModelPicker)}};v=O([c(4,re),c(5,N),c(6,he),c(7,He),c(8,ve),c(9,Be),c(10,de),c(11,ke),c(12,ue),c(13,me),c(14,Oe),c(15,Pe),c(16,ge)],v);class Ii{_widgets=[];_lastFocusedWidget=void 0;get lastFocusedWidget(){return Ce.activeChatController?.chatWidget??this._lastFocusedWidget}constructor(){}getWidgetByInputUri(d){return this._widgets.find(e=>se(e.inputUri,d))}getWidgetByLocation(d){return this._widgets.filter(e=>e.location===d)}getWidgetBySessionId(d){return this._widgets.find(e=>e.viewModel?.sessionId===d)}setLastFocusedWidget(d){d!==this._lastFocusedWidget&&(this._lastFocusedWidget=d)}register(d){if(this._widgets.some(e=>e===d))throw new Error("Cannot register the same widget multiple times");return this._widgets.push(d),ee(d.onDidFocus(()=>this.setLastFocusedWidget(d)),te(()=>this._widgets.splice(this._widgets.indexOf(d),1)))}}export{v as ChatWidget,Ii as ChatWidgetService,Qe as isQuickChat};
