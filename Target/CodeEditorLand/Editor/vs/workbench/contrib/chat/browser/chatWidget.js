var z=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var k=(p,a,e,i)=>{for(var t=i>1?void 0:i?G(a,e):a,n=p.length-1,r;n>=0;n--)(r=p[n])&&(t=(i?r(a,e,t):r(t))||t);return i&&t&&z(a,e,t),t},g=(p,a)=>(e,i)=>a(e,i,p);import*as c from"../../../../base/browser/dom.js";import{Button as J}from"../../../../base/browser/ui/button/button.js";import"../../../../base/browser/ui/tree/tree.js";import{disposableTimeout as Y,timeout as Z}from"../../../../base/common/async.js";import{Codicon as ee}from"../../../../base/common/codicons.js";import{toErrorMessage as te}from"../../../../base/common/errorMessage.js";import{Emitter as m,Event as ie}from"../../../../base/common/event.js";import{MarkdownString as B}from"../../../../base/common/htmlContent.js";import{Disposable as V,DisposableStore as q,MutableDisposable as ne,combinedDisposable as se,toDisposable as oe}from"../../../../base/common/lifecycle.js";import{Schemas as re}from"../../../../base/common/network.js";import{extUri as ae,isEqual as de}from"../../../../base/common/resources.js";import{isDefined as he}from"../../../../base/common/types.js";import"../../../../base/common/uri.js";import"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as le}from"../../../../editor/browser/services/codeEditorService.js";import{localize as F}from"../../../../nls.js";import{MenuId as N}from"../../../../platform/actions/common/actions.js";import{IContextKeyService as $}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as ce}from"../../../../platform/contextview/browser/contextView.js";import"../../../../platform/editor/common/editor.js";import{IInstantiationService as ue}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ge}from"../../../../platform/instantiation/common/serviceCollection.js";import{WorkbenchObjectTree as pe}from"../../../../platform/list/browser/listService.js";import{ILogService as me}from"../../../../platform/log/common/log.js";import{IStorageService as Ce,StorageScope as U,StorageTarget as Ie}from"../../../../platform/storage/common/storage.js";import{buttonSecondaryBackground as ve,buttonSecondaryHoverBackground as fe}from"../../../../platform/theme/common/colorRegistry.js";import{asCssVariable as K}from"../../../../platform/theme/common/colorUtils.js";import{IThemeService as Se}from"../../../../platform/theme/common/themeService.js";import{TerminalChatController as ye}from"../../terminal/terminalContribChatExports.js";import{ChatAgentLocation as x,IChatAgentService as we,isChatWelcomeMessageContent as De}from"../common/chatAgents.js";import{CONTEXT_CHAT_INPUT_HAS_AGENT as _e,CONTEXT_CHAT_LOCATION as be,CONTEXT_CHAT_REQUEST_IN_PROGRESS as Me,CONTEXT_IN_CHAT_SESSION as Ee,CONTEXT_IN_QUICK_CHAT as Te,CONTEXT_LAST_ITEM_ID as Ae,CONTEXT_RESPONSE_FILTERED as Pe}from"../common/chatContextKeys.js";import{ChatEditingSessionState as Le,IChatEditingService as Fe}from"../common/chatEditingService.js";import"../common/chatModel.js";import{ChatRequestAgentPart as xe,chatAgentLeader as He,chatSubcommandLeader as Q,formatChatQuestion as Re}from"../common/chatParserTypes.js";import{ChatRequestParser as We}from"../common/chatRequestParser.js";import{IChatService as Oe}from"../common/chatService.js";import{IChatSlashCommandService as ke}from"../common/chatSlashCommands.js";import{ChatViewModel as Be,isRequestVM as b,isResponseVM as C}from"../common/chatViewModel.js";import"../common/chatWidgetHistoryService.js";import{CodeBlockModelCollection as Ve}from"../common/codeBlockModelCollection.js";import{IChatAccessibilityService as qe,IChatWidgetService as Ne}from"./chat.js";import{ChatAccessibilityProvider as $e}from"./chatAccessibilityProvider.js";import"./chatAttachmentModel.js";import{ChatDragAndDrop as Ue}from"./chatDragAndDrop.js";import{ChatInputPart as Ke}from"./chatInputPart.js";import{ChatListDelegate as Qe,ChatListItemRenderer as je}from"./chatListRenderer.js";import{ChatEditorOptions as Xe}from"./chatOptions.js";import"./media/chat.css";import"./media/chatAgentHover.css";import"./media/chatViewWelcome.css";import{ChatViewWelcomePart as ze}from"./viewsWelcome/chatViewWelcomeController.js";const M=c.$;function I(p){const a=p.scrollHeight-p.renderHeight;p.scrollTop=a}function Ge(p){return"viewContext"in p&&"isQuickChat"in p.viewContext&&!!p.viewContext.isQuickChat}const j="chat.welcomeMessageContent";let f=class extends V{constructor(e,i,t,n,r,s,o,h,l,u,v,H,R,E,Je,Ye,X){super();this.viewOptions=t;this.styles=n;this.contextKeyService=s;this.instantiationService=o;this.chatService=h;this.chatAgentService=l;this.contextMenuService=v;this.chatAccessibilityService=H;this.logService=R;this.themeService=E;this.chatSlashCommandService=Je;this.chatEditingService=Ye;this.storageService=X;this.viewContext=i??{},typeof e=="object"?this._location=e:this._location={location:e},Ee.bindTo(s).set(!0),be.bindTo(s).set(this._location.location),Te.bindTo(s).set(Ge(this)),this.agentInInput=_e.bindTo(s),this.requestInProgress=Me.bindTo(s),this._register(u.register(this)),this._codeBlockModelCollection=this._register(o.createInstance(Ve));const y=this._register(new q);if(this._register(this.chatEditingService.onDidCreateEditingSession(d=>{d.chatSessionId===this.viewModel?.sessionId&&(y.clear(),this.renderChatEditingSessionState(null),y.add(d.onDidChange(()=>{this.renderChatEditingSessionState(d)})),y.add(d.onDidDispose(()=>{y.clear(),this.renderChatEditingSessionState(null)})),this.renderChatEditingSessionState(d))})),this._location.location===x.EditingSession){let d;this._register(this.onDidChangeViewModel(async()=>{const w=this._viewModel?.sessionId;w!==d?.chatSessionId&&(d&&d.state.get()!==Le.Disposed&&await d.stop(),w?d=await this.chatEditingService.startOrContinueEditingSession(w,{silent:!0}):d=void 0)}))}this._register(r.registerCodeEditorOpenHandler(async(d,w,Ze)=>{const T=d.resource;if(T.scheme!==re.vscodeChatCodeBlock)return null;const O=T.path.split("/").at(1);if(!O)return null;const A=this.viewModel?.getItems().find(D=>D.id===O);if(!A)return null;this.reveal(A),await Z(0);for(const D of this.renderer.editorsInUse())if(ae.isEqual(D.uri,T,!0)){const S=D.editor;let P=0;const L=S.getDomNode();if(L){const _=c.findParentWithClass(L,"monaco-list-row");_&&(P=c.getTopLeftOffset(L).top-c.getTopLeftOffset(_).top)}if(d.options?.selection){const _=S.getTopForPosition(d.options.selection.startLineNumber,d.options.selection.startColumn);P+=_,S.focus(),S.setSelection({startLineNumber:d.options.selection.startLineNumber,startColumn:d.options.selection.startColumn,endLineNumber:d.options.selection.endLineNumber??d.options.selection.startLineNumber,endColumn:d.options.selection.endColumn??d.options.selection.startColumn})}return this.reveal(A,P),S}return null}));const W=X.getObject(`${j}.${this.location}`,U.APPLICATION);De(W)&&(this.persistedWelcomeMessage=W),this._register(this.onDidChangeParsedInput(()=>this.updateChatInputContext()))}static CONTRIBS=[];_onDidSubmitAgent=this._register(new m);onDidSubmitAgent=this._onDidSubmitAgent.event;_onDidChangeAgent=this._register(new m);onDidChangeAgent=this._onDidChangeAgent.event;_onDidFocus=this._register(new m);onDidFocus=this._onDidFocus.event;_onDidChangeViewModel=this._register(new m);onDidChangeViewModel=this._onDidChangeViewModel.event;_onDidScroll=this._register(new m);onDidScroll=this._onDidScroll.event;_onDidClear=this._register(new m);onDidClear=this._onDidClear.event;_onDidAcceptInput=this._register(new m);onDidAcceptInput=this._onDidAcceptInput.event;_onDidHide=this._register(new m);onDidHide=this._onDidHide.event;_onDidChangeParsedInput=this._register(new m);onDidChangeParsedInput=this._onDidChangeParsedInput.event;_onWillMaybeChangeHeight=new m;onWillMaybeChangeHeight=this._onWillMaybeChangeHeight.event;_onDidChangeHeight=this._register(new m);onDidChangeHeight=this._onDidChangeHeight.event;_onDidChangeContentHeight=new m;onDidChangeContentHeight=this._onDidChangeContentHeight.event;contribs=[];tree;renderer;_codeBlockModelCollection;inputPart;editorOptions;listContainer;container;welcomeMessageContainer;persistedWelcomeMessage;bodyDimension;visibleChangeCount=0;requestInProgress;agentInInput;_visible=!1;get visible(){return this._visible}previousTreeScrollHeight=0;scrollLock=!0;viewModelDisposables=this._register(new q);_viewModel;set viewModel(e){this._viewModel!==e&&(this.viewModelDisposables.clear(),this._viewModel=e,e&&this.viewModelDisposables.add(e),this._onDidChangeViewModel.fire())}get viewModel(){return this._viewModel}parsedChatRequest;get parsedInput(){if(this.parsedChatRequest===void 0){if(!this.viewModel)return{text:"",parts:[]};this.parsedChatRequest=this.instantiationService.createInstance(We).parseChatRequest(this.viewModel.sessionId,this.getInput(),this.location,{selectedAgent:this._lastSelectedAgent})}return this.parsedChatRequest}get scopedContextKeyService(){return this.contextKeyService}_location;get location(){return this._location.location}viewContext;_lastSelectedAgent;set lastSelectedAgent(e){this.parsedChatRequest=void 0,this._lastSelectedAgent=e,this._onDidChangeParsedInput.fire()}get lastSelectedAgent(){return this._lastSelectedAgent}get supportsFileReferences(){return!!this.viewOptions.supportsFileReferences}get input(){return this.inputPart}get inputEditor(){return this.inputPart.inputEditor}get inputUri(){return this.inputPart.inputUri}get contentHeight(){return this.inputPart.contentHeight+this.tree.contentHeight}get attachmentModel(){return this.inputPart.attachmentModel}render(e){const i="viewId"in this.viewContext?this.viewContext.viewId:void 0;this.editorOptions=this._register(this.instantiationService.createInstance(Xe,i,this.styles.listForeground,this.styles.inputEditorBackground,this.styles.resultEditorBackground));const t=this.viewOptions.renderInputOnTop??!1,n=this.viewOptions.renderFollowups??!t,r=this.viewOptions.renderStyle;this.container=c.append(e,M(".interactive-session")),this.welcomeMessageContainer=c.append(this.container,M(".chat-welcome-view-container",{style:"display: none"})),this.renderWelcomeViewContentIfNeeded(),t?(this.createInput(this.container,{renderFollowups:n,renderStyle:r}),this.listContainer=c.append(this.container,M(".interactive-list"))):(this.listContainer=c.append(this.container,M(".interactive-list")),this.createInput(this.container,{renderFollowups:n,renderStyle:r})),this.createList(this.listContainer,{...this.viewOptions.rendererOptions,renderStyle:r});const s=this._register(new J(this.listContainer,{supportIcons:!0,buttonBackground:K(ve),buttonHoverBackground:K(fe)}));s.element.classList.add("chat-scroll-down"),s.label=`$(${ee.chevronDown.id})`,s.setTitle(F("scrollDownButtonLabel","Scroll down")),this._register(s.onDidClick(()=>{this.scrollLock=!0,I(this.tree)})),this._register(this.editorOptions.onDidChange(()=>this.onDidStyleChange())),this.onDidStyleChange(),this.viewModel&&(this.onDidChangeItems(),I(this.tree)),this.contribs=f.CONTRIBS.map(o=>{try{return this._register(this.instantiationService.createInstance(o,this))}catch(h){this.logService.error("Failed to instantiate chat widget contrib",te(h));return}}).filter(he),this._register(this.instantiationService.createInstance(Ue,this.container,this.inputPart,this.styles))}getContrib(e){return this.contribs.find(i=>i.id===e)}focusInput(){this.inputPart.focus()}hasInputFocus(){return this.inputPart.hasFocus()}getSibling(e,i){if(!C(e))return;const t=this.viewModel?.getItems();if(!t)return;const n=t.filter(o=>C(o)),r=n.indexOf(e);if(r===void 0)return;const s=i==="next"?r+1:r-1;if(!(s<0||s>n.length-1))return n[s]}clear(){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=!0),this._onDidClear.fire()}onDidChangeItems(e){if(this.tree&&this._visible){const i=(this.viewModel?.getItems()??[]).map(n=>({element:n,collapsed:!1,collapsible:!1}));this.renderWelcomeViewContentIfNeeded(),this._onWillMaybeChangeHeight.fire(),this.tree.setChildren(null,i,{diffIdentityProvider:{getId:n=>{const r=b(n)?n.id:n.requestId,s=this._viewModel?.model.checkpoint?.id;return n.dataId+`${b(n)}${C(n)&&n.renderData?`_${this.visibleChangeCount}`:""}`+(C(n)?`_${n.contentReferences.length}`:"")+`_${n.isDisabled?"1":"0"}_${r===s?"1":"0"}`+(b(n)&&n.contentReferences?`_${n.contentReferences?.length}`:"")}}}),!e&&this._dynamicMessageLayoutData&&this.layoutDynamicChatTreeItemMode();const t=i[i.length-1]?.element;t&&Ae.bindTo(this.contextKeyService).set([t.id]),t&&C(t)&&t.isComplete?this.renderFollowups(t.replyFollowups,t):!i.length&&this.viewModel?this.renderFollowups(this.viewModel.model.sampleQuestions):this.renderFollowups(void 0)}}renderWelcomeViewContentIfNeeded(){const e=this.viewModel?.model.welcomeMessage??this.persistedWelcomeMessage;if(e&&this.welcomeMessageContainer.children.length===0&&!this.viewOptions.renderStyle){const i=this.viewOptions.supportsAdditionalParticipants?new B(F("chatWidget.tips",`{0} or type {1} to attach context

{2} to chat with extensions

Type {3} to use commands`,"$(attach)","#","$(mention)","/"),{supportThemeIcons:!0}):new B(F("chatWidget.tips.withoutParticipants","{0} or type {1} to attach context","$(attach)","#"),{supportThemeIcons:!0}),t=this._register(this.instantiationService.createInstance(ze,{...e,tips:i},{}));c.append(this.welcomeMessageContainer,t.element)}if(!this.viewOptions.renderStyle&&this.viewModel){const i=this.viewModel.getItems();c.setVisibility(i.length===0,this.welcomeMessageContainer),c.setVisibility(i.length!==0,this.listContainer)}}async renderChatEditingSessionState(e){this.inputPart.renderChatEditingSessionState(e,this),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}async renderFollowups(e,i){this.inputPart.renderFollowups(e,i),this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width)}setVisible(e){const i=this._visible;this._visible=e,this.visibleChangeCount++,this.renderer.setVisible(e),this.input.setVisible(e),e?this._register(Y(()=>{this._visible&&this.onDidChangeItems(!0)},0)):i&&this._onDidHide.fire()}createList(e,i){const t=this._register(this._register(this.instantiationService.createChild(new ge([$,this.contextKeyService])))),n=t.createInstance(Qe,this.viewOptions.defaultElementHeight??200),r={getListLength:()=>this.tree.getNode(null).visibleChildrenCount,onDidScroll:this.onDidScroll,container:e},s=document.createElement("div");s.classList.add("chat-overflow-widget-container","monaco-editor"),e.append(s),this.renderer=this._register(t.createInstance(je,this.editorOptions,i,r,this._codeBlockModelCollection,s)),this._register(this.renderer.onDidClickFollowup(o=>{this.acceptInput(o.message)})),this._register(this.renderer.onDidClickRerunWithAgentOrCommandDetection(o=>{const h=this.chatService.getSession(o.sessionId)?.getRequests().find(l=>l.id===o.requestId);if(h){const l={noCommandDetection:!0,attempt:h.attempt+1,location:this.location,userSelectedModelId:this.input.currentLanguageModel};this.chatService.resendRequest(h,l).catch(u=>this.logService.error("FAILED to rerun request",u))}})),this.tree=this._register(t.createInstance(pe,"Chat",e,n,[this.renderer],{identityProvider:{getId:o=>o.id},horizontalScrolling:!1,alwaysConsumeMouseWheel:!1,supportDynamicHeights:!0,hideTwistiesOfChildlessElements:!0,accessibilityProvider:this.instantiationService.createInstance($e),keyboardNavigationLabelProvider:{getKeyboardNavigationLabel:o=>b(o)?o.message:C(o)?o.response.value:""},setRowLineHeight:!1,filter:this.viewOptions.filter?{filter:this.viewOptions.filter.bind(this.viewOptions)}:void 0,overrideStyles:{listFocusBackground:this.styles.listBackground,listInactiveFocusBackground:this.styles.listBackground,listActiveSelectionBackground:this.styles.listBackground,listFocusAndSelectionBackground:this.styles.listBackground,listInactiveSelectionBackground:this.styles.listBackground,listHoverBackground:this.styles.listBackground,listBackground:this.styles.listBackground,listFocusForeground:this.styles.listForeground,listHoverForeground:this.styles.listForeground,listInactiveFocusForeground:this.styles.listForeground,listInactiveSelectionForeground:this.styles.listForeground,listActiveSelectionForeground:this.styles.listForeground,listFocusAndSelectionForeground:this.styles.listForeground,listActiveSelectionIconForeground:void 0,listInactiveSelectionIconForeground:void 0}})),this._register(this.tree.onContextMenu(o=>this.onContextMenu(o))),this._register(this.tree.onDidChangeContentHeight(()=>{this.onDidChangeTreeContentHeight()})),this._register(this.renderer.onDidChangeItemHeight(o=>{this.tree.updateElementHeight(o.element,o.height)})),this._register(this.tree.onDidFocus(()=>{this._onDidFocus.fire()})),this._register(this.tree.onDidScroll(()=>{this._onDidScroll.fire();const o=this.tree.scrollTop>=this.tree.scrollHeight-this.tree.renderHeight-2;this.container.classList.toggle("show-scroll-down",!o&&!this.scrollLock)}))}onContextMenu(e){e.browserEvent.preventDefault(),e.browserEvent.stopPropagation();const i=e.element,t=this.contextKeyService.createOverlay([[Pe.key,C(i)&&!!i.errorDetails?.responseIsFiltered]]);this.contextMenuService.showContextMenu({menuId:N.ChatContext,menuActionOptions:{shouldForwardArgs:!0},contextKeyService:t,getAnchor:()=>e.anchor,getActionsContext:()=>i})}onDidChangeTreeContentHeight(){if(this.tree.scrollHeight!==this.previousTreeScrollHeight){const e=this.viewModel?.getItems().at(-1);(!(C(e)&&e.renderData)||this.scrollLock)&&this.tree.scrollTop+this.tree.renderHeight>=this.previousTreeScrollHeight-2&&c.scheduleAtNextAnimationFrame(c.getWindow(this.listContainer),()=>{I(this.tree),I(this.tree)},0)}this.previousTreeScrollHeight=this.tree.scrollHeight,this._onDidChangeContentHeight.fire()}createInput(e,i){this.inputPart=this._register(this.instantiationService.createInstance(Ke,this.location,{renderFollowups:i?.renderFollowups??!0,renderStyle:i?.renderStyle==="minimal"?"compact":i?.renderStyle,menus:{executeToolbar:N.ChatExecute,...this.viewOptions.menus},editorOverflowWidgetsDomNode:this.viewOptions.editorOverflowWidgetsDomNode},()=>this.collectInputState())),this.inputPart.render(e,"",this),this._register(this.inputPart.onDidLoadInputState(t=>{this.contribs.forEach(n=>{if(n.setInputState){const r=(typeof t=="object"&&t?.[n.id])??{};n.setInputState(r)}})})),this._register(this.inputPart.onDidFocus(()=>this._onDidFocus.fire())),this._register(this.inputPart.onDidAcceptFollowup(t=>{if(!this.viewModel)return;let n="";if(t.followup.agentId&&t.followup.agentId!==this.chatAgentService.getDefaultAgent(this.location)?.id){const r=this.chatAgentService.getAgent(t.followup.agentId);if(!r)return;this.lastSelectedAgent=r,n=`${He}${r.name} `,t.followup.subCommand&&(n+=`${Q}${t.followup.subCommand} `)}else!t.followup.agentId&&t.followup.subCommand&&this.chatSlashCommandService.hasCommand(t.followup.subCommand)&&(n=`${Q}${t.followup.subCommand} `);n+=t.followup.message,this.acceptInput(n),t.response&&this.chatService.notifyUserAction({sessionId:this.viewModel.sessionId,requestId:t.response.requestId,agentId:t.response.agent?.id,command:t.response.slashCommand?.name,result:t.response.result,action:{kind:"followUp",followup:t.followup}})})),this._register(this.inputPart.onDidChangeHeight(()=>{this.bodyDimension&&this.layout(this.bodyDimension.height,this.bodyDimension.width),this._onDidChangeContentHeight.fire()})),this._register(this.inputPart.attachmentModel.onDidChangeContext(()=>{this.chatEditingService.currentEditingSession&&this.chatEditingService.currentEditingSession?.chatSessionId===this.viewModel?.sessionId&&this.renderChatEditingSessionState(this.chatEditingService.currentEditingSession)})),this._register(this.inputEditor.onDidChangeModelContent(()=>{this.parsedChatRequest=void 0,this.updateChatInputContext()})),this._register(this.chatAgentService.onDidChangeAgents(()=>this.parsedChatRequest=void 0))}onDidStyleChange(){this.container.style.setProperty("--vscode-interactive-result-editor-background-color",this.editorOptions.configuration.resultEditor.backgroundColor?.toString()??""),this.container.style.setProperty("--vscode-interactive-session-foreground",this.editorOptions.configuration.foreground?.toString()??""),this.container.style.setProperty("--vscode-chat-list-background",this.themeService.getColorTheme().getColor(this.styles.listBackground)?.toString()??"")}setModel(e,i){if(!this.container)throw new Error("Call render() before setModel()");e.sessionId!==this.viewModel?.sessionId&&(this._codeBlockModelCollection.clear(),this.container.setAttribute("data-session-id",e.sessionId),this.viewModel=this.instantiationService.createInstance(Be,e,this._codeBlockModelCollection),this.viewModelDisposables.add(ie.accumulate(this.viewModel.onDidChange,0)(t=>{this.viewModel&&(this.requestInProgress.set(this.viewModel.requestInProgress),this.onDidChangeItems(),t.some(n=>n?.kind==="addRequest")&&this.visible&&I(this.tree),this.chatEditingService.currentEditingSession&&this.chatEditingService.currentEditingSession?.chatSessionId===this.viewModel?.sessionId&&this.renderChatEditingSessionState(this.chatEditingService.currentEditingSession))})),this.viewModelDisposables.add(this.viewModel.onDidDisposeModel(()=>{this.inputPart.saveState(),this.viewModel=void 0,this.onDidChangeItems()})),this.inputPart.initForNewChatModel(i),this.contribs.forEach(t=>{t.setInputState&&i.inputState?.[t.id]&&t.setInputState(i.inputState?.[t.id])}),this.viewModelDisposables.add(e.onDidChange(t=>{t.kind==="setAgent"&&this._onDidChangeAgent.fire({agent:t.agent,slashCommand:t.command}),t.kind==="addRequest"&&this._location.location===x.EditingSession&&this.chatEditingService.createSnapshot(t.request.id)})),this.tree&&this.visible&&(this.onDidChangeItems(),I(this.tree)),this.updateChatInputContext())}getFocus(){return this.tree.getFocus()[0]??void 0}reveal(e,i){this.tree.reveal(e,i)}focus(e){const t=this.tree.getNode(null).children.find(n=>n.element?.id===e.id);t&&(this.tree.setFocus([t.element]),this.tree.domFocus())}refilter(){this.tree.refilter()}setInputPlaceholder(e){this.viewModel?.setInputPlaceholder(e)}resetInputPlaceholder(){this.viewModel?.resetInputPlaceholder()}setInput(e=""){this.inputPart.setValue(e,!1)}getInput(){return this.inputPart.inputEditor.getValue()}logInputHistory(){this.inputPart.logInputHistory()}async acceptInput(e,i){return this._acceptInput(e?{query:e}:void 0,i)}async acceptInputWithPrefix(e){this._acceptInput({prefix:e})}collectInputState(){const e={};return this.contribs.forEach(i=>{i.getInputState&&(e[i.id]=i.getInputState())}),e}async _acceptInput(e,i){if(this.viewModel){this._onDidAcceptInput.fire(),this.viewOptions.autoScroll||(this.scrollLock=!1);const t=this.getInput(),n=this.chatAccessibilityService.acceptRequest(),r=e?"query"in e?e.query:`${e.prefix} ${t}`:t,s=!e||"prefix"in e;if(this.viewModel.model.checkpoint){const l=this.viewModel.model.getRequests();for(let u=l.length-1;u>=0;u-=1){const v=l[u];v.isDisabled&&this.chatService.removeRequest(this.viewModel.sessionId,v.id)}}const o=this.inputPart.getAttachedAndImplicitContext();if(this.location===x.EditingSession){const l=this.chatEditingService.currentEditingSessionObs.get();if(l?.workingSet)for(const[u,v]of l?.workingSet)o.push(this.attachmentModel.asVariableEntry(u))}const h=await this.chatService.sendRequest(this.viewModel.sessionId,r,{userSelectedModelId:this.inputPart.currentLanguageModel,location:this.location,locationData:this._location.resolveData?.(),parserContext:{selectedAgent:this._lastSelectedAgent},attachedContext:o});if(h)return this.inputPart.acceptInput(s),this._onDidSubmitAgent.fire({agent:h.agent,slashCommand:h.slashCommand}),h.responseCompletePromise.then(()=>{const l=this.viewModel?.getItems().filter(C),u=l?.[l.length-1];if(this.chatAccessibilityService.acceptResponse(u,n,i),this.viewModel?.model.setCheckpoint(void 0),u?.result?.nextQuestion){const{prompt:v,participant:H,command:R}=u.result.nextQuestion,E=Re(this.chatAgentService,this.location,v,H,R);E&&this.input.setValue(E,!1)}}),h.responseCreatedPromise}}getCodeBlockInfosForResponse(e){return this.renderer.getCodeBlockInfosForResponse(e)}getCodeBlockInfoForEditor(e){return this.renderer.getCodeBlockInfoForEditor(e)}getFileTreeInfosForResponse(e){return this.renderer.getFileTreeInfosForResponse(e)}getLastFocusedFileTreeForResponse(e){return this.renderer.getLastFocusedFileTreeForResponse(e)}focusLastMessage(){if(!this.viewModel)return;const e=this.tree.getNode(null).children,i=e[e.length-1];i&&(this.tree.setFocus([i.element]),this.tree.domFocus())}layout(e,i){i=Math.min(i,850),this.bodyDimension=new c.Dimension(i,e);const t=this._dynamicMessageLayoutData?.enabled?this._dynamicMessageLayoutData.maxHeight:e;this.inputPart.layout(t,i);const n=this.inputPart.inputPartHeight,r=this.tree.scrollTop+this.tree.renderHeight>=this.tree.scrollHeight-2,s=Math.max(0,e-n);this.viewOptions.autoScroll||this.listContainer.style.setProperty("--chat-current-response-min-height",s*.75+"px"),this.tree.layout(s,i),this.tree.getHTMLElement().style.height=`${s}px`;const o=Math.max(100-this.inputPart.followupsHeight,0);this.welcomeMessageContainer.style.height=`${s-o}px`,this.welcomeMessageContainer.style.paddingBottom=`${o}px`,this.renderer.layout(i);const h=this.viewModel?.getItems().at(-1),l=C(h)&&h.renderData;r&&!l&&I(this.tree),this.listContainer.style.height=`${s}px`,this._onDidChangeHeight.fire(e)}_dynamicMessageLayoutData;setDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0},this._register(this.renderer.onDidChangeItemHeight(()=>this.layoutDynamicChatTreeItemMode()));const t=this._register(new ne);this._register(this.tree.onDidScroll(n=>{this._dynamicMessageLayoutData?.enabled&&(t.value=c.scheduleAtNextAnimationFrame(c.getWindow(this.listContainer),()=>{if(!n.scrollTopChanged||n.heightChanged||n.scrollHeightChanged)return;const r=n.height,s=n.scrollHeight-r-n.scrollTop;if(s===0)return;const o=this._dynamicMessageLayoutData?.maxHeight??i,h=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(o,h);const l=this.inputPart.inputPartHeight,u=Math.min(r+s,o-l);this.layout(u+l,h)}))}))}updateDynamicChatTreeItemLayout(e,i){this._dynamicMessageLayoutData={numOfMessages:e,maxHeight:i,enabled:!0};let t=!1,n=this.bodyDimension.height,r=this.bodyDimension.width;i<this.bodyDimension.height&&(n=i,t=!0);const s=this.container.offsetWidth;this.bodyDimension?.width!==s&&(r=s,t=!0),t&&this.layout(n,r)}get isDynamicChatTreeItemLayoutEnabled(){return this._dynamicMessageLayoutData?.enabled??!1}set isDynamicChatTreeItemLayoutEnabled(e){this._dynamicMessageLayoutData&&(this._dynamicMessageLayoutData.enabled=e)}layoutDynamicChatTreeItemMode(){if(!this.viewModel||!this._dynamicMessageLayoutData?.enabled)return;const e=this.bodyDimension?.width??this.container.offsetWidth;this.inputPart.layout(this._dynamicMessageLayoutData.maxHeight,e);const i=this.inputPart.inputPartHeight,t=this.viewModel.getItems(),n=t.slice(-this._dynamicMessageLayoutData.numOfMessages),r=n.some(o=>o.currentRenderedHeight===void 0),s=r?this._dynamicMessageLayoutData.maxHeight:n.reduce((o,h)=>o+h.currentRenderedHeight,0);this.layout(Math.min(i+s+(t.length>2?18:0),this._dynamicMessageLayoutData.maxHeight),e),(r||!s)&&I(this.tree)}saveState(){this.inputPart.saveState(),this.viewModel?.model.welcomeMessage&&this.storageService.store(`${j}.${this.location}`,this.viewModel?.model.welcomeMessage,U.APPLICATION,Ie.MACHINE)}getViewState(){return{inputValue:this.getInput(),inputState:this.inputPart.getViewState(),selectedLanguageModelId:this.inputPart.currentLanguageModel}}updateChatInputContext(){const e=this.parsedInput.parts.find(i=>i instanceof xe);this.agentInInput.set(!!e)}};f=k([g(4,le),g(5,$),g(6,ue),g(7,Oe),g(8,we),g(9,Ne),g(10,ce),g(11,qe),g(12,me),g(13,Se),g(14,ke),g(15,Fe),g(16,Ce)],f);class bi extends V{_widgets=[];_lastFocusedWidget=void 0;_onDidAddWidget=this._register(new m);onDidAddWidget=this._onDidAddWidget.event;get lastFocusedWidget(){return ye.activeChatController?.chatWidget??this._lastFocusedWidget}getAllWidgets(a){return this._widgets.filter(e=>e.location===a)}getWidgetByInputUri(a){return this._widgets.find(e=>de(e.inputUri,a))}getWidgetByLocation(a){return this._widgets.filter(e=>e.location===a)}getWidgetBySessionId(a){return this._widgets.find(e=>e.viewModel?.sessionId===a)}setLastFocusedWidget(a){a!==this._lastFocusedWidget&&(this._lastFocusedWidget=a)}register(a){if(this._widgets.some(e=>e===a))throw new Error("Cannot register the same widget multiple times");return this._widgets.push(a),this._onDidAddWidget.fire(a),se(a.onDidFocus(()=>this.setLastFocusedWidget(a)),oe(()=>this._widgets.splice(this._widgets.indexOf(a),1)))}}export{f as ChatWidget,bi as ChatWidgetService,Ge as isQuickChat};
