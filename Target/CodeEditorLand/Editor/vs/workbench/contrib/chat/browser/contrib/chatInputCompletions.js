var J=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var M=(b,a,d,o)=>{for(var r=o>1?void 0:o?X(a,d):a,u=b.length-1,v;u>=0;u--)(v=b[u])&&(r=(o?v(a,d,r):v(r))||r);return o&&r&&J(a,d,r),r},f=(b,a)=>(d,o)=>a(d,o,b);import"../../../../../base/common/cancellation.js";import{isPatternInWord as Y}from"../../../../../base/common/filters.js";import{Disposable as F}from"../../../../../base/common/lifecycle.js";import{ResourceSet as Z}from"../../../../../base/common/map.js";import"../../../../../base/common/uri.js";import{generateUuid as ee}from"../../../../../base/common/uuid.js";import"../../../../../editor/common/core/position.js";import{Range as y}from"../../../../../editor/common/core/range.js";import{getWordAtText as te}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as A}from"../../../../../editor/common/languages.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as U}from"../../../../../editor/common/services/languageFeatures.js";import{localize as Q}from"../../../../../nls.js";import{Action2 as re,registerAction2 as ie}from"../../../../../platform/actions/common/actions.js";import{CommandsRegistry as ne}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as ae}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as se}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as oe}from"../../../../../platform/label/common/label.js";import{Registry as V}from"../../../../../platform/registry/common/platform.js";import{IWorkspaceContextService as le}from"../../../../../platform/workspace/common/workspace.js";import{Extensions as q}from"../../../../common/contributions.js";import{IHistoryService as ce}from"../../../../services/history/common/history.js";import{LifecyclePhase as B}from"../../../../services/lifecycle/common/lifecycle.js";import{QueryBuilder as de}from"../../../../services/search/common/queryBuilder.js";import{ISearchService as me}from"../../../../services/search/common/search.js";import{ChatAgentLocation as H,IChatAgentNameService as ue,IChatAgentService as ge,getFullyQualifiedId as he}from"../../common/chatAgents.js";import{ChatRequestAgentPart as z,ChatRequestAgentSubcommandPart as pe,ChatRequestTextPart as fe,ChatRequestToolPart as ve,ChatRequestVariablePart as Ce,chatAgentLeader as W,chatSubcommandLeader as D,chatVariableLeader as S}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as Ie}from"../../common/chatSlashCommands.js";import{IChatVariablesService as be}from"../../common/chatVariables.js";import{ILanguageModelToolsService as Se}from"../../common/languageModelToolsService.js";import{SubmitAction as O}from"../actions/chatExecuteActions.js";import{IChatWidgetService as K}from"../chat.js";import{ChatInputPart as R}from"../chatInputPart.js";import{ChatDynamicVariableModel as xe,SelectAndInsertFileAction as G}from"./chatDynamicVariables.js";let _=class extends F{constructor(d,o,r){super();this.languageFeaturesService=d;this.chatWidgetService=o;this.chatSlashCommandService=r;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(u,v,l,I)=>{const m=this.chatWidgetService.getWidgetByInputUri(u.uri);if(!m||!m.viewModel||!N(u,v,/\/\w*/g))return null;if(m.parsedInput.parts.find(s=>s instanceof z))return;const g=this.chatSlashCommandService.getCommands(m.location);return g?{suggestions:g.map((s,h)=>{const C=`/${s.command}`;return{label:C,insertText:s.executeImmediately?"":`${C} `,detail:s.detail,range:new y(1,1,1,1),sortText:s.sortText??"a".repeat(h+1),kind:A.Text,command:s.executeImmediately?{id:O.ID,title:C,arguments:[{widget:m,inputValue:`${C} `}]}:void 0}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommandsAt",triggerCharacters:["@"],provideCompletionItems:async(u,v,l,I)=>{const m=this.chatWidgetService.getWidgetByInputUri(u.uri);if(!m||!m.viewModel||!N(u,v,/@\w*/g))return null;const n=this.chatSlashCommandService.getCommands(m.location);return n?{suggestions:n.map((t,g)=>{const s=`${D}${t.command}`;return{label:s,insertText:t.executeImmediately?"":`${s} `,detail:t.detail,range:new y(1,1,1,1),filterText:`${W}${t.command}`,sortText:t.sortText??"z".repeat(g+1),kind:A.Text,command:t.executeImmediately?{id:O.ID,title:s,arguments:[{widget:m,inputValue:`${s} `}]}:void 0}})}:null}}))}};_=M([f(0,U),f(1,K),f(2,Ie)],_),V.as(q.Workbench).registerWorkbenchContribution(_,B.Eventually);let E=class extends F{constructor(d,o,r,u){super();this.languageFeaturesService=d;this.chatWidgetService=o;this.chatAgentService=r;this.chatAgentNameService=u;const v={_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(l,I,m,c)=>{const n=this.chatWidgetService.getWidgetByInputUri(l.uri);if(!n||!n.viewModel)return;const t=N(l,I,/\/\w*/g);if(!t)return null;const g=n.parsedInput.parts,s=g.findIndex(e=>e instanceof z);if(s<0||g.find(e=>e instanceof pe))return;for(const e of g.slice(s+1))if(!(e instanceof fe)||!e.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:g[s].agent.slashCommands.map((e,p)=>{const x=`/${e.name}`;return{label:x,insertText:`${x} `,detail:e.description,range:t,kind:A.Text}})}}};this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},v)),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:[W],provideCompletionItems:async(l,I,m,c)=>{const n=this.chatWidgetService.getWidgetByInputUri(l.uri),t=n?.viewModel;if(!n||!t)return;if(!N(l,I,/(@|\/)\w*/g))return null;const s=this.chatAgentService.getAgents().filter(e=>e.locations.includes(n.location)),h=(e,p)=>{const x=e.id==="github.copilot.terminalPanel"?"0000":"";return`${W}${x}${e.name}.${p}`};return{suggestions:s.filter(e=>!e.isDefault).map(e=>{const{label:p,isDupe:x}=this.getAgentCompletionDetails(e),P=e.description;return{label:x?{label:p,description:e.description,detail:` (${e.publisherDisplayName})`}:p,detail:P,filterText:`${W}${e.name}`,insertText:`${p} `,range:new y(1,1,1,1),kind:A.Text,sortText:`${W}${e.name}`,command:{id:$.ID,title:$.ID,arguments:[{agent:e,widget:n}]}}}).concat(s.flatMap(e=>e.slashCommands.map((p,x)=>{const{label:P,isDupe:T}=this.getAgentCompletionDetails(e),i=`${P} ${D}${p.name}`,w={label:T?{label:i,description:p.description,detail:T?` (${e.publisherDisplayName})`:void 0}:i,detail:p.description,filterText:h(e,p.name),commitCharacters:[" "],insertText:i+" ",range:new y(1,1,1,1),kind:A.Text,sortText:`x${W}${e.name}${p.name}`,command:{id:$.ID,title:$.ID,arguments:[{agent:e,widget:n}]}};if(e.isDefault){const j=`${D}${p.name}`;w.label=j,w.insertText=`${j} `,w.detail=p.description}return w})))}}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:[D],provideCompletionItems:async(l,I,m,c)=>{const n=this.chatWidgetService.getWidgetByInputUri(l.uri),t=n?.viewModel;return!n||!t?void 0:N(l,I,/(@|\/)\w*/g)?{suggestions:this.chatAgentService.getAgents().filter(h=>h.locations.includes(n.location)).flatMap(h=>h.slashCommands.map((C,e)=>{const{label:p,isDupe:x}=this.getAgentCompletionDetails(h),P=`${D}${C.name}`,T={label:{label:P,description:p,detail:x?` (${h.publisherDisplayName})`:void 0},commitCharacters:[" "],insertText:`${p} ${P} `,detail:`(${p}) ${C.description??""}`,range:new y(1,1,1,1),kind:A.Text,sortText:`${D}${h.name}${C.name}`,command:{id:$.ID,title:$.ID,arguments:[{agent:h,widget:n}]}};if(h.isDefault){const i=`${D}${C.name}`;T.label=i,T.insertText=`${i} `,T.detail=C.description}return T}))}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"installChatExtensions",triggerCharacters:[W],provideCompletionItems:async(l,I,m,c)=>{if(!l.getLineContent(1).startsWith(W)||this.chatWidgetService.getWidgetByInputUri(l.uri)?.location!==H.Panel)return;const t=Q("installLabel","Install Chat Extensions...");return{suggestions:[{label:t,insertText:"",range:new y(1,1,1,1),kind:A.Text,command:{id:"workbench.extensions.search",title:"",arguments:["@tag:chat-participant"]},filterText:W+t,sortText:"zzz"}]}}}))}getAgentCompletionDetails(d){const o=this.chatAgentNameService.getAgentNameRestriction(d),r=`${W}${o?d.name:he(d)}`,u=o&&this.chatAgentService.agentHasDupeName(d.id);return{label:r,isDupe:u}}};E=M([f(0,U),f(1,K),f(2,ge),f(3,ue)],E),V.as(q.Workbench).registerWorkbenchContribution(E,B.Eventually);class $ extends re{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:$.ID,title:""})}async run(a,...d){const o=d[0];!o||!o.widget||!o.agent||(o.widget.lastSelectedAgent=o.agent)}}ie($);class ye{constructor(a,d){this.widget=a;this.variable=d}}let k=class extends F{constructor(d,o,r,u,v,l,I){super();this.historyService=d;this.workspaceContextService=o;this.searchService=r;this.labelService=u;this.languageFeaturesService=v;this.chatWidgetService=l;this.instantiationService=I;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[S],provideCompletionItems:async(m,c,n,t)=>{const g=this.chatWidgetService.getWidgetByInputUri(m.uri);if(!g||!g.supportsFileReferences)return null;const s={suggestions:[]},h=N(m,c,k.VariableNameDef,!0);if(h){const e=new y(c.lineNumber,h.replace.startColumn,c.lineNumber,h.replace.startColumn+6);s.suggestions.push({label:`${S}file`,insertText:`${S}file:`,detail:Q("pickFileLabel","Pick a file"),range:h,kind:A.Text,command:{id:G.ID,title:G.ID,arguments:[{widget:g,range:e}]},sortText:"z"})}const C=N(m,c,new RegExp(`${S}[^\\s]*`,"g"),!0);return C&&await this.addFileEntries(g,s,C,t),s}})),this._register(ne.registerCommand(k.addReferenceCommand,(m,c)=>this.cmdAddReference(c))),this.queryBuilder=this.instantiationService.createInstance(de)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${S}\\w*`,"g");queryBuilder;cacheKey;async addFileEntries(d,o,r,u){const v=c=>{const n=this.labelService.getUriBasenameLabel(c),t=`${S}file:${n}`;return{label:{label:n,description:this.labelService.getUriLabel(c,{relative:!0})},filterText:`${S}${n}`,insertText:r.varWord?.endColumn===r.replace.endColumn?`${t} `:t,range:r,kind:A.File,sortText:"{",command:{id:k.addReferenceCommand,title:"",arguments:[new ye(d,{id:"vscode.file",range:{startLineNumber:r.replace.startLineNumber,startColumn:r.replace.startColumn,endLineNumber:r.replace.endLineNumber,endColumn:r.replace.startColumn+t.length},data:c})]}}};let l;r.varWord?.word&&r.varWord.word.startsWith(S)&&(l=r.varWord.word.toLowerCase().slice(1));const I=new Z,m=o.suggestions.length;for(const c of this.historyService.getHistory()){if(!c.resource||!this.workspaceContextService.getWorkspaceFolder(c.resource))continue;if(l){const t=this.labelService.getUriBasenameLabel(c.resource).toLowerCase();if(!Y(l,0,l.length,t,0,t.length))continue}if(I.add(c.resource),o.suggestions.push(v(c.resource))-m>=5)break}if(l){this.cacheKey&&Date.now()-this.cacheKey.time>6e4&&(this.searchService.clearCache(this.cacheKey.key),this.cacheKey=void 0),this.cacheKey||(this.cacheKey={key:ee(),time:Date.now()}),this.cacheKey.time=Date.now();const c=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:l,sortByScore:!0,maxResults:250,cacheKey:this.cacheKey.key}),n=await this.searchService.fileSearch(c,u);for(const t of n.results)I.has(t.resource)||o.suggestions.push(v(t.resource))}o.incomplete=!0}cmdAddReference(d){d.widget.getContrib(xe.ID)?.addReference(d.variable)}};k=M([f(0,ce),f(1,le),f(2,me),f(3,oe),f(4,U),f(5,K),f(6,se)],k),V.as(q.Workbench).registerWorkbenchContribution(k,B.Eventually);function N(b,a,d,o=!1){const r=te(a.column,d,b.getLineContent(a.lineNumber),0);if(!r&&b.getWordUntilPosition(a).word||!r&&a.column>1&&b.getValueInRange(new y(a.lineNumber,a.column-1,a.lineNumber,a.column))!==" "||r&&o&&b.getWordUntilPosition({lineNumber:a.lineNumber,column:r.startColumn}).word)return;let u,v;return r?(u=new y(a.lineNumber,r.startColumn,a.lineNumber,a.column),v=new y(a.lineNumber,r.startColumn,a.lineNumber,r.endColumn)):u=v=y.fromPositions(a),{insert:u,replace:v,varWord:r}}let L=class extends F{constructor(d,o,r,u,v){super();this.languageFeaturesService=d;this.chatWidgetService=o;this.chatVariablesService=r;this._register(this.languageFeaturesService.completionProvider.register({scheme:R.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[S],provideCompletionItems:async(l,I,m,c)=>{const n=new Set;n.add(H.Panel),n.add(H.EditingSession);for(const i of Object.values(H))typeof i=="string"&&u.getValue(`chat.experimental.variables.${i}`)&&n.add(i);const t=this.chatWidgetService.getWidgetByInputUri(l.uri);if(!t||!n.has(t.location))return null;const g=N(l,I,L.VariableNameDef,!0);if(!g)return null;const s=t.parsedInput.parts.find(i=>i instanceof z),h=s?s.agent.metadata.supportsSlowVariables:!0,C=t.parsedInput.parts.filter(i=>i instanceof Ce),e=new Set(C.map(i=>i.variableName)),p=Array.from(this.chatVariablesService.getVariables(t.location)).filter(i=>!e.has(i.name)).filter(i=>!i.isSlow||h).map(i=>{const w=`${S}${i.name}`;return{label:w,range:g,insertText:w+" ",detail:i.description,kind:A.Text,sortText:"z"}}),x=t.parsedInput.parts.filter(i=>i instanceof ve),P=new Set(x.map(i=>i.toolName)),T=[];return T.push(...Array.from(v.getTools()).filter(i=>i.canBeReferencedInPrompt).filter(i=>!P.has(i.toolReferenceName??"")).map(i=>{const w=`${S}${i.toolReferenceName}`;return{label:w,range:g,insertText:w+" ",detail:i.userDescription,kind:A.Text,sortText:"z"}})),{suggestions:[...p,...T]}}}))}static VariableNameDef=new RegExp(`(?<=^|\\s)${S}\\w*`,"g")};L=M([f(0,U),f(1,K),f(2,be),f(3,ae),f(4,Se)],L),V.as(q.Workbench).registerWorkbenchContribution(L,B.Eventually);export{N as computeCompletionRanges};
