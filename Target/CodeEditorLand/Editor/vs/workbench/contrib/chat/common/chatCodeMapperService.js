import"../../../../base/common/cancellation.js";import{CharCode as u}from"../../../../base/common/charCode.js";import"../../../../base/common/lifecycle.js";import{ResourceMap as C}from"../../../../base/common/map.js";import{splitLinesIncludeSeparators as m}from"../../../../base/common/strings.js";import{isString as I}from"../../../../base/common/types.js";import{URI as R}from"../../../../base/common/uri.js";import{isLocation as g}from"../../../../editor/common/languages.js";import{createDecorator as M}from"../../../../platform/instantiation/common/instantiation.js";import"./chatAgents.js";import"./chatModel.js";import"./chatService.js";const z=M("codeMapperService");class G{_serviceBrand;providers=[];registerCodeMapperProvider(o,r){return this.providers.push(r),{dispose:()=>{const e=this.providers.indexOf(r);e>=0&&this.providers.splice(e,1)}}}async mapCode(o,r,e){for(const n of this.providers){const s=await n.mapCode(o,r,e);if(s)return s}}async mapCodeFromResponse(o,r,e){const n=/^`{3,}/,s=[],c=[],l=[];let d,p;for(const i of v(o))if(I(i)){const t=i.match(n);t?p!==void 0&&t[0]===p?(p=void 0,d&&(s.push({code:c.join(""),resource:d,markdownBeforeBlock:l.join("")}),c.length=0,l.length=0,d=void 0)):p=t[0]:p!==void 0?c.push(i):l.push(i)}else d=i;const f=[];for(const i of o.session.getRequests()){const t=i.response;if(!t||t===o)break;f.push({type:"request",message:i.message.text}),f.push({type:"response",message:t.response.getMarkdown(),result:t.result,references:k(t.contentReferences)})}return this.mapCode({codeBlocks:s,conversation:f},r,e)}}function v(a){return{*[Symbol.iterator](){let o;for(const r of a.response.value)if(r.kind==="markdownContent"||r.kind==="markdownVuln"){const e=m(r.content.value);if(e.length>0){o!==void 0&&(e[0]=o+e[0]),o=h(e[e.length-1])?e.pop():void 0;for(const n of e)yield n}}else r.kind==="codeblockUri"&&(yield r.uri);o!==void 0&&(yield o)}}}function h(a){const o=a.charCodeAt(a.length-1);return o!==u.LineFeed&&o!==u.CarriageReturn}function k(a){const o=new C;for(const r of a){let e,n;if(R.isUri(r.reference)?e=r.reference:g(r.reference)&&(e=r.reference.uri,n=r.reference.range),e){const s=o.get(e);s?n&&s.ranges.push(n):o.set(e,{uri:e,version:-1,ranges:n?[n]:[]})}}return[...o.values()]}export{G as CodeMapperService,z as ICodeMapperService,k as getReferencesAsDocumentContext};
