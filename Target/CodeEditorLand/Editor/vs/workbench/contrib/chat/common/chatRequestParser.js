var V=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var q=(R,u,t,n)=>{for(var r=n>1?void 0:n?E(u,t):u,e=R.length-1,o;e>=0;e--)(o=R[e])&&(r=(n?o(u,t,r):o(r))||r);return n&&r&&V(u,t,r),r},A=(R,u)=>(t,n)=>u(t,n,R);import{OffsetRange as v}from"../../../../editor/common/core/offsetRange.js";import{Position as y}from"../../../../editor/common/core/position.js";import{Range as S}from"../../../../editor/common/core/range.js";import{ChatAgentLocation as N,IChatAgentService as T}from"./chatAgents.js";import{ChatRequestAgentPart as b,ChatRequestAgentSubcommandPart as p,ChatRequestDynamicVariablePart as L,ChatRequestSlashCommandPart as x,ChatRequestTextPart as w,ChatRequestToolPart as D,ChatRequestVariablePart as M,chatAgentLeader as B,chatSubcommandLeader as _,chatVariableLeader as $}from"./chatParserTypes.js";import{IChatSlashCommandService as F}from"./chatSlashCommands.js";import{IChatVariablesService as O}from"./chatVariables.js";import{ILanguageModelToolsService as Q}from"./languageModelToolsService.js";const j=/^@([\w_\-\.]+)(?=(\s|$|\b))/i,k=/^#([\w_\-]+)(:\d+)?(?=(\s|$|\b))/i,z=/\/([\w_\-]+)(?=(\s|$|\b))/i;let I=class{constructor(u,t,n,r){this.agentService=u;this.variableService=t;this.slashCommandService=n;this.toolsService=r}parseChatRequest(u,t,n=N.Panel,r){const e=[],o=this.variableService.getDynamicVariables(u);let s=1,c=1;for(let a=0;a<t.length;a++){const f=t.charAt(a-1),l=t.charAt(a);let i;if((f.match(/\s/)||a===0)&&(l===$?i=this.tryToParseVariable(t.slice(a),a,new y(s,c),e):l===B?i=this.tryToParseAgent(t.slice(a),t,a,new y(s,c),e,n,r):l===_&&(i=this.tryToParseSlashCommand(t.slice(a),t,a,new y(s,c),e,n)),i||(i=this.tryToParseDynamicVariable(t.slice(a),a,new y(s,c),o))),i){if(a!==0){const P=e.at(-1),C=P?.range.endExclusive??0,g=P?.editorRange.endLineNumber??1,h=P?.editorRange.endColumn??1;e.push(new w(new v(C,a),new S(g,h,s,c),t.slice(C,a)))}e.push(i)}l===`
`?(s++,c=1):c++}const d=e.at(-1),m=d?.range.endExclusive??0;return m<t.length&&e.push(new w(new v(m,t.length),new S(d?.editorRange.endLineNumber??1,d?.editorRange.endColumn??1,s,c),t.slice(m,t.length))),{parts:e,text:t}}tryToParseAgent(u,t,n,r,e,o,s){const c=u.match(j);if(!c)return;const[d,m]=c,a=new v(n,n+d.length),f=new S(r.lineNumber,r.column,r.lineNumber,r.column+d.length);let l=this.agentService.getAgentsByName(m);if(!l.length){const h=this.agentService.getAgentByFullyQualifiedId(m);h&&(l=[h])}const i=l.length>1&&s?.selectedAgent?s.selectedAgent:l.find(h=>h.locations.includes(o));if(!i||e.some(h=>h instanceof b)||e.some(h=>h instanceof w&&h.text.trim()!==""||!(h instanceof b)))return;const C=e.at(-1)?.range.endExclusive??0;if(t.slice(C,n).trim()==="")return new b(a,f,i)}tryToParseVariable(u,t,n,r){const e=u.match(k);if(!e)return;const[o,s]=e,c=e[2]??"",d=new v(t,t+o.length),m=new S(n.lineNumber,n.column,n.lineNumber,n.column+o.length),a=r.find(P=>P instanceof b),f=!a||a.agent.metadata.supportsSlowVariables,l=this.variableService.getVariable(s);if(l&&(!l.isSlow||f))return new M(d,m,s,c,l.id);const i=this.toolsService.getToolByName(s);if(i&&i.canBeReferencedInPrompt)return new D(d,m,s,i.id,i.displayName,i.icon)}tryToParseSlashCommand(u,t,n,r,e,o){const s=u.match(z);if(!s||e.some(l=>l instanceof x))return;const[c,d]=s,m=new v(n,n+c.length),a=new S(r.lineNumber,r.column,r.lineNumber,r.column+c.length),f=e.find(l=>l instanceof b);if(f){if(e.some(g=>g instanceof w&&g.text.trim()!==""||!(g instanceof b)&&!(g instanceof w)))return;const i=e.at(-1)?.range.endExclusive??0;if(t.slice(i,n).trim()!=="")return;const C=f.agent.slashCommands.find(g=>g.name===d);if(C)return new p(m,a,C)}else{const i=this.slashCommandService.getCommands(o).find(P=>P.command===d);if(i)return new x(m,a,i);{const C=this.agentService.getDefaultAgent(o)?.slashCommands.find(g=>g.name===d);if(C)return new p(m,a,C)}}}tryToParseDynamicVariable(u,t,n,r){const e=r.find(o=>o.range.startLineNumber===n.lineNumber&&o.range.startColumn===n.column);if(e){const o=e.range.endColumn-e.range.startColumn,s=u.substring(0,o),c=new v(t,t+o);return new L(c,e.range,s,e.id,e.modelDescription,e.data,e.fullName,e.icon)}}};I=q([A(0,T),A(1,O),A(2,F),A(3,Q)],I);export{I as ChatRequestParser};
