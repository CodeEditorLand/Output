var re=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var U=(c,a,e,i)=>{for(var t=i>1?void 0:i?se(a,e):a,r=c.length-1,g;r>=0;r--)(g=c[r])&&(t=(i?g(a,e,t):g(t))||t);return i&&t&&re(a,e,t),t},u=(c,a)=>(e,i)=>a(e,i,c);import*as o from"../../../../base/browser/dom.js";import{StandardMouseEvent as B}from"../../../../base/browser/mouseEvent.js";import{PixelRatio as ae}from"../../../../base/browser/pixelRatio.js";import{ActionBar as ce,ActionsOrientation as de}from"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{mainWindow as $}from"../../../../base/browser/window.js";import{Action as ue}from"../../../../base/common/actions.js";import*as le from"../../../../base/common/arrays.js";import{RunOnceScheduler as ge}from"../../../../base/common/async.js";import{Codicon as k}from"../../../../base/common/codicons.js";import*as pe from"../../../../base/common/errors.js";import{DisposableStore as he,dispose as me,markAsSingleton as Se,MutableDisposable as ve}from"../../../../base/common/lifecycle.js";import{Platform as M,platform as N}from"../../../../base/common/platform.js";import{ThemeIcon as Ie}from"../../../../base/common/themables.js";import"../../../../base/common/uri.js";import"../../../../editor/browser/editorExtensions.js";import{localize as L}from"../../../../nls.js";import"../../../../platform/action/common/action.js";import{DropdownWithPrimaryActionViewItem as Ee}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{createActionViewItem as Ce,createAndFillInActionBarActions as q}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as G,MenuId as d,MenuRegistry as m}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as be}from"../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as n,IContextKeyService as X}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as F}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as fe}from"../../../../platform/notification/common/notification.js";import{IStorageService as Te,StorageScope as A,StorageTarget as Y}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as _e}from"../../../../platform/telemetry/common/telemetry.js";import{widgetBorder as Ae,widgetShadow as De}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService as ye,Themable as we}from"../../../../platform/theme/common/themeService.js";import{TitleBarSetting as Oe}from"../../../../platform/window/common/window.js";import"../../../common/contributions.js";import{EditorTabsMode as Be,IWorkbenchLayoutService as Me,LayoutSettings as D,Parts as Ne}from"../../../services/layout/browser/layoutService.js";import{CONTEXT_DEBUG_STATE as p,CONTEXT_FOCUSED_SESSION_IS_ATTACH as S,CONTEXT_FOCUSED_SESSION_IS_NO_DEBUG as Le,CONTEXT_IN_DEBUG_MODE as Pe,CONTEXT_MULTI_SESSION_DEBUG as Re,CONTEXT_STEP_BACK_SUPPORTED as K,CONTEXT_SUSPEND_DEBUGGEE_SUPPORTED as H,CONTEXT_TERMINATE_DEBUGGEE_SUPPORTED as f,IDebugService as xe,State as z,VIEWLET_ID as Z}from"../common/debug.js";import{FocusSessionActionViewItem as We}from"./debugActionViewItems.js";import{debugToolBarBackground as Ve,debugToolBarBorder as Ue}from"./debugColors.js";import{CONTINUE_ID as $e,CONTINUE_LABEL as ke,DISCONNECT_AND_SUSPEND_ID as qe,DISCONNECT_AND_SUSPEND_LABEL as Ge,DISCONNECT_ID as y,DISCONNECT_LABEL as P,FOCUS_SESSION_ID as j,FOCUS_SESSION_LABEL as Xe,PAUSE_ID as Fe,PAUSE_LABEL as Ye,RESTART_LABEL as Ke,RESTART_SESSION_ID as He,REVERSE_CONTINUE_ID as ze,STEP_BACK_ID as Ze,STEP_INTO_ID as je,STEP_INTO_LABEL as Je,STEP_OUT_ID as Qe,STEP_OUT_LABEL as et,STEP_OVER_ID as tt,STEP_OVER_LABEL as it,STOP_ID as w,STOP_LABEL as R}from"./debugCommands.js";import*as s from"./debugIcons.js";import"./media/debugToolBar.css";const J="debug.actionswidgetposition",Q="debug.actionswidgety";let O=class extends we{constructor(e,i,t,r,g,T,v,b,E,te){super(v);this.notificationService=e;this.telemetryService=i;this.debugService=t;this.layoutService=r;this.storageService=g;this.configurationService=T;this.instantiationService=b;this.$el=o.$("div.debug-toolbar");const W=this.configurationService.getValue(Oe.TITLE_BAR_STYLE)==="custom",ie=W&&N===M.Mac,oe=W&&(N===M.Windows||N===M.Linux);this.$el.style.transform=`translate(
			min(
				max(${ie?"60px":"0px"}, calc(-50% + (100vw * var(--x-position)))),
				calc(100vw - 100% - ${oe?"100px":"0px"})
			),
			var(--y-position)
		)`,this.dragArea=o.append(this.$el,o.$("div.drag-area"+Ie.asCSSSelector(s.debugGripper)));const ne=o.append(this.$el,o.$("div.action-bar-container"));this.debugToolBarMenu=E.createMenu(d.DebugToolBar,te),this._register(this.debugToolBarMenu),this.activeActions=[],this.actionBar=this._register(new ce(ne,{orientation:de.HORIZONTAL,actionViewItemProvider:(h,_)=>{if(h.id===j)return this.instantiationService.createInstance(We,h,void 0);if(h.id===w||h.id===y){this.stopActionViewItemDisposables.clear();const I=this.instantiationService.invokeFunction(C=>ot(h,this.stopActionViewItemDisposables,C,{hoverDelegate:_.hoverDelegate}));if(I)return I}return Ce(this.instantiationService,h,_)}})),this.updateScheduler=this._register(new ge(()=>{const h=this.debugService.state,_=this.configurationService.getValue("debug").toolBarLocation;if(h===z.Inactive||_!=="floating"||this.debugService.getModel().getSessions().every(C=>C.suppressDebugToolbar)||h===z.Initializing&&this.debugService.initializingOptions?.suppressDebugToolbar)return this.hide();const I=[];q(this.debugToolBarMenu,{shouldForwardArgs:!0},I),le.equals(I,this.activeActions,(C,V)=>C.id===V.id&&C.enabled===V.enabled)||(this.actionBar.clear(),this.actionBar.push(I,{icon:!0,label:!1}),this.activeActions=I),this.show()},20)),this.updateStyles(),this.registerListeners(),this.hide()}$el;dragArea;actionBar;activeActions;updateScheduler;debugToolBarMenu;isVisible=!1;isBuilt=!1;stopActionViewItemDisposables=this._register(new he);auxWindowCoordinates=new WeakMap;trackPixelRatioListener=this._register(new ve);registerListeners(){this._register(this.debugService.onDidChangeState(()=>this.updateScheduler.schedule())),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("debug.toolBarLocation")&&this.updateScheduler.schedule(),(e.affectsConfiguration(D.EDITOR_TABS_MODE)||e.affectsConfiguration(D.COMMAND_CENTER))&&(this._yRange=void 0,this.setCoordinates())})),this._register(this.debugToolBarMenu.onDidChange(()=>this.updateScheduler.schedule())),this._register(this.actionBar.actionRunner.onDidRun(e=>{e.error&&!pe.isCancellationError(e.error)&&this.notificationService.warn(e.error),this.telemetryService.publicLog2("workbenchActionExecuted",{id:e.action.id,from:"debugActionsWidget"})})),this._register(o.addDisposableGenericMouseUpListener(this.dragArea,e=>{new B(o.getWindow(this.dragArea),e).detail===2&&(this.setCoordinates(.5,this.yDefault),this.storePosition())})),this._register(o.addDisposableGenericMouseDownListener(this.dragArea,e=>{this.dragArea.classList.add("dragged");const i=o.getWindow(this.layoutService.activeContainer),t=new B(i,e),r=this.getCurrentXPercent(),g=this.getCurrentYPosition(),T=o.addDisposableGenericMouseMoveListener(i,b=>{const E=new B(i,b);E.preventDefault(),this.setCoordinates(r+(E.posx-t.posx)/i.innerWidth,g+E.posy-t.posy)}),v=o.addDisposableGenericMouseUpListener(i,b=>{this.storePosition(),this.dragArea.classList.remove("dragged"),T.dispose(),v.dispose()})})),this._register(this.layoutService.onDidChangePartVisibility(()=>this.setCoordinates())),this._register(this.layoutService.onDidChangeActiveContainer(async()=>{this._yRange=void 0,await this.layoutService.whenContainerStylesLoaded(o.getWindow(this.layoutService.activeContainer)),this.isBuilt&&(this.doShowInActiveContainer(),this.setCoordinates())}))}getCurrentXPercent(){return Number(this.$el.style.getPropertyValue("--x-position"))}getCurrentYPosition(){return parseInt(this.$el.style.getPropertyValue("--y-position"))}storePosition(){const e=o.getWindow(this.layoutService.activeContainer),i=this.layoutService.activeContainer===this.layoutService.mainContainer,t=this.getCurrentXPercent(),r=this.getCurrentYPosition();i?(this.storageService.store(J,t,A.PROFILE,Y.MACHINE),this.storageService.store(Q,r,A.PROFILE,Y.MACHINE)):this.auxWindowCoordinates.set(e,{x:t,y:r})}updateStyles(){if(super.updateStyles(),this.$el){this.$el.style.backgroundColor=this.getColor(Ve)||"";const e=this.getColor(De);this.$el.style.boxShadow=e?`0 0 8px 2px ${e}`:"";const i=this.getColor(Ae),t=this.getColor(Ue);i?this.$el.style.border=`1px solid ${i}`:(this.$el.style.border=t?`solid ${t}`:"none",this.$el.style.border="1px 0")}}getStoredXPosition(){const e=o.getWindow(this.layoutService.activeContainer),t=e===$?Number(this.storageService.get(J,A.PROFILE)):this.auxWindowCoordinates.get(e)?.x;return t!==void 0&&!isNaN(t)?t:.5}getStoredYPosition(){const e=o.getWindow(this.layoutService.activeContainer);return(e===$?this.storageService.getNumber(Q,A.PROFILE):this.auxWindowCoordinates.get(e)?.y)??this.yDefault}setCoordinates(e,i){if(!this.isVisible)return;e??=this.getStoredXPosition(),i??=this.getStoredYPosition();const[t,r]=this.yRange;i=Math.max(t,Math.min(i,r)),this.$el.style.setProperty("--x-position",`${e}`),this.$el.style.setProperty("--y-position",`${i}px`)}get yDefault(){return this.layoutService.mainContainerOffset.top}_yRange;get yRange(){if(!this._yRange){const e=this.layoutService.isVisible(Ne.TITLEBAR_PART,o.getWindow(this.layoutService.activeContainer)),i=e?0:this.layoutService.mainContainerOffset.top;let t=0;e&&(this.configurationService.getValue(D.COMMAND_CENTER)===!0?t+=35:t+=28),this.configurationService.getValue(D.EDITOR_TABS_MODE)!==Be.NONE&&(t+=35),this._yRange=[i,t]}return this._yRange}show(){if(this.isVisible){this.setCoordinates();return}this.isBuilt||(this.isBuilt=!0,this.doShowInActiveContainer()),this.isVisible=!0,o.show(this.$el),this.setCoordinates()}doShowInActiveContainer(){this.layoutService.activeContainer.appendChild(this.$el),this.trackPixelRatioListener.value=ae.getInstance(o.getWindow(this.$el)).onDidChange(()=>this.setCoordinates())}hide(){this.isVisible=!1,o.hide(this.$el)}dispose(){super.dispose(),this.$el?.remove()}};O=U([u(0,fe),u(1,_e),u(2,xe),u(3,Me),u(4,Te),u(5,be),u(6,ye),u(7,F),u(8,G),u(9,X)],O);function ot(c,a,e,i){const t=e.get(G),r=e.get(X),g=e.get(F),T=t.getMenuActions(d.DebugToolBarStop,r,{shouldForwardArgs:!0}),v=[];if(q(T,v),!v.length)return;const b=a.add(new ue("notebook.moreRunActions",L("notebook.moreRunActionsLabel","More..."),"codicon-chevron-down",!0));return g.createInstance(Ee,c,b,v,"debug-stop-actions",i)}const x=[],l=(c,a,e,i,t,r,g)=>{m.appendMenuItem(d.DebugToolBar,{group:"navigation",when:t,order:e,command:{id:c,title:a,icon:i,precondition:r},alt:g}),x.push(m.appendMenuItem(d.ViewContainerTitle,{group:"navigation",when:n.and(t,n.equals("viewContainer",Z),p.notEqualsTo("inactive"),n.equals("config.debug.toolBarLocation","docked")),order:e,command:{id:c,title:a,icon:i,precondition:r}}))};Se(m.onDidChangeMenu(c=>{if(c.has(d.DebugToolBar)){me(x);const a=m.getMenuItems(d.DebugToolBar);for(const e of a)x.push(m.appendMenuItem(d.ViewContainerTitle,{...e,when:n.and(e.when,n.equals("viewContainer",Z),p.notEqualsTo("inactive"),n.equals("config.debug.toolBarLocation","docked"))}))}}));const ee=n.equals("config.debug.toolBarLocation","commandCenter");m.appendMenuItem(d.CommandCenterCenter,{submenu:d.DebugToolBar,title:"Debug",icon:k.debug,order:1,when:n.and(Pe,ee)}),l($e,ke,10,s.debugContinue,p.isEqualTo("stopped")),l(Fe,Ye,10,s.debugPause,p.notEqualsTo("stopped"),n.and(p.isEqualTo("running"),Le.toNegated())),l(w,R,70,s.debugStop,S.toNegated(),void 0,{id:y,title:P,icon:s.debugDisconnect,precondition:n.and(S.toNegated(),f)}),l(y,P,70,s.debugDisconnect,S,void 0,{id:w,title:R,icon:s.debugStop,precondition:n.and(S,f)}),l(tt,it,20,s.debugStepOver,void 0,p.isEqualTo("stopped")),l(je,Je,30,s.debugStepInto,void 0,p.isEqualTo("stopped")),l(Qe,et,40,s.debugStepOut,void 0,p.isEqualTo("stopped")),l(He,Ke,60,s.debugRestart),l(Ze,L("stepBackDebug","Step Back"),50,s.debugStepBack,K,p.isEqualTo("stopped")),l(ze,L("reverseContinue","Reverse"),55,s.debugReverseContinue,K,p.isEqualTo("stopped")),l(j,Xe,100,k.listTree,n.and(Re,ee.negate())),m.appendMenuItem(d.DebugToolBarStop,{group:"navigation",when:n.and(S.toNegated(),f),order:0,command:{id:y,title:P,icon:s.debugDisconnect}}),m.appendMenuItem(d.DebugToolBarStop,{group:"navigation",when:n.and(S,f),order:0,command:{id:w,title:R,icon:s.debugStop}}),m.appendMenuItem(d.DebugToolBarStop,{group:"navigation",when:n.or(n.and(S.toNegated(),H,f),n.and(S,H)),order:0,command:{id:qe,title:Ge,icon:s.debugDisconnect}});export{O as DebugToolBar,ot as createDisconnectMenuItemAction};
