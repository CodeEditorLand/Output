var te=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var y=(u,e,t,i)=>{for(var s=i>1?void 0:i?ie(e,t):e,a=u.length-1,d;a>=0;a--)(d=u[a])&&(s=(i?d(e,t,s):d(s))||s);return i&&s&&te(e,t,s),s},o=(u,e)=>(t,i)=>e(t,i,u);import{$ as se,getActiveElement as oe,getTotalHeight as N,h as c,reset as L,trackFocus as ne}from"../../../../base/browser/dom.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{getDefaultHoverDelegate as re}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as F}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/common/actions.js";import{isNonEmptyArray as ae,tail as de}from"../../../../base/common/arrays.js";import{Emitter as K,Event as le}from"../../../../base/common/event.js";import"../../../../base/common/htmlContent.js";import{DisposableStore as B,MutableDisposable as ce,toDisposable as he}from"../../../../base/common/lifecycle.js";import{constObservable as E,derived as ge,observableValue as P}from"../../../../base/common/observable.js";import"./media/inlineChat.css";import"../../../../editor/browser/editorBrowser.js";import{AccessibleDiffViewer as ue}from"../../../../editor/browser/widget/diffEditor/components/accessibleDiffViewer.js";import{EditorOption as pe}from"../../../../editor/common/config/editorOptions.js";import{LineRange as U}from"../../../../editor/common/core/lineRange.js";import"../../../../editor/common/core/position.js";import"../../../../editor/common/core/range.js";import{Selection as me}from"../../../../editor/common/core/selection.js";import{DetailedLineRangeMapping as _e,RangeMapping as fe}from"../../../../editor/common/diff/rangeMapping.js";import{ScrollType as Ie}from"../../../../editor/common/editorCommon.js";import"../../../../editor/common/model.js";import{ITextModelService as X}from"../../../../editor/common/services/resolverService.js";import{localize as x}from"../../../../nls.js";import{IAccessibleViewService as G}from"../../../../platform/accessibility/browser/accessibleView.js";import{IAccessibilityService as $}from"../../../../platform/accessibility/common/accessibility.js";import{MenuWorkbenchButtonBar as ve}from"../../../../platform/actions/browser/buttonbar.js";import{createActionViewItem as be}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as Ce}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as O,MenuItemAction as Se}from"../../../../platform/actions/common/actions.js";import{IConfigurationService as q}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as W}from"../../../../platform/contextkey/common/contextkey.js";import{IHoverService as z}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as H}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as ye}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as Z}from"../../../../platform/keybinding/common/keybinding.js";import{asCssVariable as Me,asCssVariableName as we,editorBackground as Le,inputBackground as Ee}from"../../../../platform/theme/common/colorRegistry.js";import{AccessibilityVerbositySettingId as R}from"../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityCommandId as xe}from"../../accessibility/common/accessibilityCommands.js";import{MarkUnhelpfulActionId as Oe}from"../../chat/browser/actions/chatTitleActions.js";import"../../chat/browser/chat.js";import{ChatVoteDownButton as We}from"../../chat/browser/chatListRenderer.js";import{ChatWidget as He}from"../../chat/browser/chatWidget.js";import{chatRequestBackground as Re}from"../../chat/common/chatColors.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as De,CONTEXT_RESPONSE as Ve,CONTEXT_RESPONSE_ERROR as Te,CONTEXT_RESPONSE_FILTERED as Ae,CONTEXT_RESPONSE_VOTE as ke}from"../../chat/common/chatContextKeys.js";import"../../chat/common/chatModel.js";import{ChatAgentVoteDirection as j,IChatService as J}from"../../chat/common/chatService.js";import{isResponseVM as h}from"../../chat/common/chatViewModel.js";import"./inlineChatSession.js";import{CTX_INLINE_CHAT_FOCUSED as Ne,CTX_INLINE_CHAT_RESPONSE_FOCUSED as Fe,inlineChatBackground as Q,inlineChatForeground as Ke}from"../common/inlineChat.js";import{EDITOR_DRAG_AND_DROP_BACKGROUND as Be}from"../../../common/theme.js";import{ILayoutService as Pe}from"../../../../platform/layout/browser/layoutService.js";let _=class{constructor(e,t,i,s,a,d,l,f,I,m,v){this._options=t;this._instantiationService=i;this._contextKeyService=s;this._keybindingService=a;this._accessibilityService=d;this._configurationService=l;this._accessibleViewService=f;this._textModelResolverService=I;this._chatService=m;this._hoverService=v;this.scopedContextKeyService=this._store.add(s.createScoped(this._elements.chatWidget));const p=i.createChild(new ye([W,this.scopedContextKeyService]),this._store);this._chatWidget=p.createInstance(He,e,void 0,{defaultElementHeight:32,renderStyle:"minimal",renderInputOnTop:!1,renderFollowups:!0,supportsFileReferences:l.getValue(`chat.experimental.variables.${e.location}`)===!0,filter:n=>h(n)&&n.isComplete&&!n.errorDetails?!(n.response.value.length>0&&n.response.value.every(r=>r.kind==="textEditGroup"&&t.chatWidgetViewOptions?.rendererOptions?.renderTextEditsAsSummary?.(r.uri))||n.response.value.length===0):!0,...t.chatWidgetViewOptions},{listForeground:Ke,listBackground:Q,overlayBackground:Be,inputEditorBackground:Ee,resultEditorBackground:Le}),this._elements.root.classList.toggle("in-zone-widget",!!t.inZoneWidget),this._chatWidget.render(this._elements.chatWidget),this._elements.chatWidget.style.setProperty(we(Re),Me(Q)),this._chatWidget.setVisible(!0),this._store.add(this._chatWidget);const b=Ve.bindTo(this.scopedContextKeyService),C=ke.bindTo(this.scopedContextKeyService),D=De.bindTo(this.scopedContextKeyService),V=Te.bindTo(this.scopedContextKeyService),T=Ae.bindTo(this.scopedContextKeyService),w=this._store.add(new B);this._store.add(this._chatWidget.onDidChangeViewModel(()=>{w.clear();const n=this._chatWidget.viewModel;n&&(w.add(he(()=>{S.context=void 0,b.reset(),C.reset(),V.reset(),T.reset(),D.reset()})),w.add(n.onDidChange(()=>{const r=n.getItems().at(-1);S.context=r,b.set(h(r)),C.set(h(r)?r.vote===j.Down?"down":r.vote===j.Up?"up":"":""),V.set(h(r)&&r.errorDetails!==void 0),T.set(!!(h(r)&&r.errorDetails?.responseIsFiltered)),D.set(h(r)&&(r.agent?.metadata.supportIssueReporting??!1)),this._onDidChangeHeight.fire()})),this._onDidChangeHeight.fire())})),this._store.add(this.chatWidget.onDidChangeContentHeight(()=>{this._onDidChangeHeight.fire()})),this._ctxResponseFocused=Fe.bindTo(this._contextKeyService);const A=this._store.add(ne(this.domNode));this._store.add(A.onDidBlur(()=>this._ctxResponseFocused.set(!1))),this._store.add(A.onDidFocus(()=>this._ctxResponseFocused.set(!0))),this._ctxInputEditorFocused=Ne.bindTo(s),this._store.add(this._chatWidget.inputEditor.onDidFocusEditorWidget(()=>this._ctxInputEditorFocused.set(!0))),this._store.add(this._chatWidget.inputEditor.onDidBlurEditorWidget(()=>this._ctxInputEditorFocused.set(!1)));const Y=t.statusMenuId instanceof O?t.statusMenuId:t.statusMenuId.menu,ee=t.statusMenuId instanceof O?void 0:t.statusMenuId.options,k=p.createInstance(ve,this._elements.toolbar1,Y,{toolbarOptions:{primaryGroup:"0_main"},telemetrySource:t.chatWidgetViewOptions?.menus?.telemetrySource,menuOptions:{renderShortTitle:!0},...ee});this._store.add(k.onDidChange(()=>this._onDidChangeHeight.fire())),this._store.add(k);const S=p.createInstance(Ce,this._elements.toolbar2,t.secondaryMenuId??O.for(""),{telemetrySource:t.chatWidgetViewOptions?.menus?.telemetrySource,menuOptions:{renderShortTitle:!0,shouldForwardArgs:!0},actionViewItemProvider:(n,r)=>n instanceof Se&&n.item.id===Oe?p.createInstance(We,n,r):be(p,n,r)});this._store.add(S.onDidChangeMenuItems(()=>this._onDidChangeHeight.fire())),this._store.add(S),this._store.add(this._configurationService.onDidChangeConfiguration(n=>{n.affectsConfiguration(R.InlineChat)&&this._updateAriaLabel()})),this._elements.root.tabIndex=0,this._elements.statusLabel.tabIndex=0,this._updateAriaLabel(),this._store.add(this._hoverService.setupManagedHover(re("element"),this._elements.statusLabel,()=>this._elements.statusLabel.dataset.title)),this._store.add(this._chatService.onDidPerformUserAction(n=>{n.sessionId===this._chatWidget.viewModel?.model.sessionId&&n.action.kind==="vote"&&this.updateStatus("Thank you for your feedback!",{resetAfter:1250})}))}_elements=c("div.inline-chat@root",[c("div.chat-widget@chatWidget"),c("div.accessibleViewer@accessibleViewer"),c("div.status@status",[c("div.label.info.hidden@infoLabel"),c("div.actions.hidden@toolbar1"),c("div.label.status.hidden@statusLabel"),c("div.actions.secondary.hidden@toolbar2")])]);_store=new B;_ctxInputEditorFocused;_ctxResponseFocused;_chatWidget;_onDidChangeHeight=this._store.add(new K);onDidChangeHeight=le.filter(this._onDidChangeHeight.event,e=>!this._isLayouting);_onDidChangeInput=this._store.add(new K);onDidChangeInput=this._onDidChangeInput.event;_isLayouting=!1;scopedContextKeyService;_updateAriaLabel(){if(this._elements.root.ariaLabel=this._accessibleViewService.getOpenAriaHint(R.InlineChat),this._accessibilityService.isScreenReaderOptimized()){let e=Ue;if(this._configurationService.getValue(R.InlineChat)){const t=this._keybindingService.lookupKeybinding(xe.OpenAccessibilityHelp)?.getLabel();e=t?x("inlineChat.accessibilityHelp","Inline Chat Input, Use {0} for Inline Chat Accessibility Help.",t):x("inlineChat.accessibilityHelpNoKb","Inline Chat Input, Run the Inline Chat Accessibility Help command for more information.")}this._chatWidget.inputEditor.updateOptions({ariaLabel:e})}}dispose(){this._store.dispose()}get domNode(){return this._elements.root}get chatWidget(){return this._chatWidget}saveState(){this._chatWidget.saveState()}layout(e){this._isLayouting=!0;try{this._doLayout(e)}finally{this._isLayouting=!1}}_doLayout(e){const t=this._getExtraHeight(),i=N(this._elements.status);this._elements.root.style.height=`${e.height-t}px`,this._elements.root.style.width=`${e.width}px`,this._chatWidget.layout(e.height-i-t,e.width)}get contentHeight(){const e={chatWidgetContentHeight:this._chatWidget.contentHeight,statusHeight:N(this._elements.status),extraHeight:this._getExtraHeight()};return e.chatWidgetContentHeight+e.statusHeight+e.extraHeight}get minHeight(){let e=100;for(const i of this._chatWidget.viewModel?.getItems()??[])if(h(i)&&i.response.value.some(s=>s.kind==="textEditGroup"&&!s.state?.applied)){e=270;break}let t=this.contentHeight;return t-=this._chatWidget.contentHeight,t+=Math.min(this._chatWidget.input.contentHeight+e,this._chatWidget.contentHeight),t}_getExtraHeight(){return this._options.inZoneWidget?1:6}get value(){return this._chatWidget.getInput()}set value(e){this._chatWidget.setInput(e)}selectAll(e=!0){let t=1;if(!e){const i=/^(\/\w+)\s*/.exec(this._chatWidget.inputEditor.getModel().getLineContent(1));i&&(t=i[1].length+1)}this._chatWidget.inputEditor.setSelection(new me(1,t,Number.MAX_SAFE_INTEGER,1))}set placeholder(e){this._chatWidget.setInputPlaceholder(e)}toggleStatus(e){this._elements.toolbar1.classList.toggle("hidden",!e),this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("hidden",!e),this._elements.infoLabel.classList.toggle("hidden",!e),this._onDidChangeHeight.fire()}updateToolbar(e){this._elements.root.classList.toggle("toolbar",e),this._elements.toolbar1.classList.toggle("hidden",!e),this._elements.toolbar2.classList.toggle("hidden",!e),this._elements.status.classList.toggle("actions",e),this._elements.infoLabel.classList.toggle("hidden",e),this._onDidChangeHeight.fire()}async getCodeBlockInfo(e){const{viewModel:t}=this._chatWidget;if(!t)return;const i=t.getItems().filter(a=>h(a));if(!i.length)return;const s=i[i.length-1];return t.codeBlockModelCollection.get(t.sessionId,s,e)?.model}get responseContent(){const e=this._chatWidget.viewModel?.model.getRequests();if(ae(e))return de(e)?.response?.response.toString()}getChatModel(){return this._chatWidget.viewModel?.model}setChatModel(e){this._chatWidget.setModel(e,{inputValue:void 0})}updateInfo(e){this._elements.infoLabel.classList.toggle("hidden",!e);const t=F(e);L(this._elements.infoLabel,...t),this._onDidChangeHeight.fire()}updateStatus(e,t={}){const i=typeof t.resetAfter=="number";if(i&&!this._elements.statusLabel.dataset.state){const a=this._elements.statusLabel.innerText,d=this._elements.statusLabel.dataset.title,l=Array.from(this._elements.statusLabel.classList.values());setTimeout(()=>{this.updateStatus(a,{classes:l,keepMessage:!0,title:d})},t.resetAfter)}const s=F(e);L(this._elements.statusLabel,...s),this._elements.statusLabel.className=`label status ${(t.classes??[]).join(" ")}`,this._elements.statusLabel.classList.toggle("hidden",!e),i?this._elements.statusLabel.dataset.state="temp":delete this._elements.statusLabel.dataset.state,t.title?this._elements.statusLabel.dataset.title=t.title:delete this._elements.statusLabel.dataset.title,this._onDidChangeHeight.fire()}reset(){this._chatWidget.attachmentModel.clear(),this._chatWidget.saveState(),L(this._elements.statusLabel),this._elements.statusLabel.classList.toggle("hidden",!0),this._elements.toolbar1.classList.add("hidden"),this._elements.toolbar2.classList.add("hidden"),this.updateInfo(""),this._elements.accessibleViewer.classList.toggle("hidden",!0),this._onDidChangeHeight.fire()}focus(){this._chatWidget.focusInput()}hasFocus(){return this.domNode.contains(oe())}};_=y([o(2,H),o(3,W),o(4,Z),o(5,$),o(6,q),o(7,G),o(8,X),o(9,J),o(10,z)],_);const Ue=x("aria-label","Inline Chat Input");let M=class extends _{constructor(t,i,s,a,d,l,f,I,m,v,p,b,C){super(t,{...s,chatWidgetViewOptions:{...s.chatWidgetViewOptions,editorOverflowWidgetsDomNode:C.mainContainer.appendChild(se(".inline-chat-overflow.monaco-editor"))}},l,a,d,f,I,m,v,p,b);this._parentEditor=i}_accessibleViewer=this._store.add(new ce);get contentHeight(){let t=super.contentHeight;return this._accessibleViewer.value&&(t+=this._accessibleViewer.value.height+8),t}_doLayout(t){let i=t.height;this._accessibleViewer.value&&(this._accessibleViewer.value.width=t.width-12,i-=this._accessibleViewer.value.height+8),super._doLayout(t.with(void 0,i)),this._elements.root.style.height=`${t.height-this._getExtraHeight()}px`}reset(){this._accessibleViewer.clear(),super.reset()}showAccessibleHunk(t,i){this._elements.accessibleViewer.classList.remove("hidden"),this._accessibleViewer.clear(),this._accessibleViewer.value=this._instantiationService.createInstance(g,this._elements.accessibleViewer,t,i,new Xe(this._parentEditor,t,i)),this._onDidChangeHeight.fire()}};M=y([o(3,W),o(4,Z),o(5,H),o(6,$),o(7,q),o(8,G),o(9,X),o(10,J),o(11,z),o(12,Pe)],M);let g=class extends ue{height;set width(e){this._width2.set(e,void 0)}_width2;constructor(e,t,i,s,a){const d=P("width",0),l=P("diff",g._asMapping(i)),f=ge(v=>[l.read(v)]),I=Math.min(10,8+l.get().changedLineCount),m=s.getModifiedOptions().get(pe.lineHeight)*I;super(e,E(!0),()=>{},E(!1),d,E(m),f,s,a),this.height=m,this._width2=d,this._store.add(t.textModelN.onDidChangeContent(()=>{l.set(g._asMapping(i),void 0)}))}static _asMapping(e){const t=e.getRanges0(),i=e.getRangesN(),s=U.fromRangeInclusive(t[0]),a=U.fromRangeInclusive(i[0]),d=[];for(let l=1;l<t.length;l++)d.push(new fe(t[l],i[l]));return new _e(s,a,d)}};g=y([o(4,H)],g);class Xe{constructor(e,t,i){this._editor=e;this._session=t;this._hunk=i}getOriginalModel(){return this._session.textModel0}getModifiedModel(){return this._session.textModelN}getOriginalOptions(){return this._editor.getOptions()}getModifiedOptions(){return this._editor.getOptions()}originalReveal(e){}modifiedReveal(e){this._editor.revealRangeInCenterIfOutsideViewport(e||this._hunk.getRangesN()[0],Ie.Smooth)}modifiedSetSelection(e){}modifiedFocus(){this._editor.focus()}getModifiedPosition(){return this._hunk.getRangesN()[0].getStartPosition()}}export{M as EditorBasedInlineChatWidget,_ as InlineChatWidget};
