var F=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var C=(c,e,t,r)=>{for(var i=r>1?void 0:r?$(e,t):e,s=c.length-1,a;s>=0;s--)(a=c[s])&&(i=(r?a(e,t,i):a(i))||i);return r&&i&&F(e,t,i),i},m=(c,e)=>(t,r)=>e(t,r,c);import"./media/languageStatus.css";import*as g from"../../../../base/browser/dom.js";import{renderLabelWithIcons as k}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import{Disposable as q,DisposableStore as A,dispose as M,toDisposable as G}from"../../../../base/common/lifecycle.js";import S from"../../../../base/common/severity.js";import{getCodeEditor as z}from"../../../../editor/browser/editorBrowser.js";import{localize as y,localize2 as J}from"../../../../nls.js";import{Registry as j}from"../../../../platform/registry/common/platform.js";import{ThemeIcon as x}from"../../../../base/common/themables.js";import{Extensions as K}from"../../../common/contributions.js";import{IEditorService as U}from"../../../services/editor/common/editorService.js";import{ILanguageStatusService as Q}from"../../../services/languageStatus/common/languageStatusService.js";import{LifecyclePhase as X}from"../../../services/lifecycle/common/lifecycle.js";import{IStatusbarService as Y,ShowTooltipCommand as Z,StatusbarAlignment as D}from"../../../services/statusbar/browser/statusbar.js";import{parseLinkedText as ee}from"../../../../base/common/linkedText.js";import{Link as V}from"../../../../platform/opener/browser/link.js";import{IOpenerService as te}from"../../../../platform/opener/common/opener.js";import{MarkdownString as ie}from"../../../../base/common/htmlContent.js";import{ActionBar as re}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Action as W}from"../../../../base/common/actions.js";import{Codicon as O}from"../../../../base/common/codicons.js";import{IStorageService as T,StorageScope as _,StorageTarget as P}from"../../../../platform/storage/common/storage.js";import{equals as H}from"../../../../base/common/arrays.js";import{URI as se}from"../../../../base/common/uri.js";import{Action2 as ae,registerAction2 as oe}from"../../../../platform/actions/common/actions.js";import"../../../../platform/instantiation/common/instantiation.js";import{Categories as ne}from"../../../../platform/action/common/actionCommonCategories.js";import"../../../../platform/accessibility/common/accessibility.js";import{IEditorGroupsService as de}from"../../../services/editor/common/editorGroupsService.js";import{IHoverService as ce,nativeHoverDelegate as B}from"../../../../platform/hover/browser/hover.js";import{Event as le}from"../../../../base/common/event.js";import{joinStrings as pe}from"../../../../base/common/strings.js";class N{constructor(e,t){this.combined=e;this.dedicated=t}isEqual(e){return H(this.combined,e.combined)&&H(this.dedicated,e.dedicated)}}let E=class{constructor(e,t){this._storageService=e;this._key=t}get value(){return this._storageService.getNumber(this._key,_.PROFILE,0)}increment(){const e=this.value+1;return this._storageService.store(this._key,e,_.PROFILE,P.MACHINE),e}};E=C([m(0,T)],E);let L=class extends q{constructor(t){super();this.editorGroupService=t;for(const r of t.parts)this.createLanguageStatus(r);this._register(t.onDidCreateAuxiliaryEditorPart(r=>this.createLanguageStatus(r)))}createLanguageStatus(t){const r=new A;le.once(t.onWillDispose)(()=>r.dispose());const i=this.editorGroupService.getScopedInstantiationService(t);r.add(i.createInstance(o))}};L=C([m(0,de)],L);let o=class{constructor(e,t,r,i,s,a){this._languageStatusService=e;this._statusBarService=t;this._editorService=r;this._hoverService=i;this._openerService=s;this._storageService=a;a.onDidChangeValue(_.PROFILE,o._keyDedicatedItems,this._disposables)(this._handleStorageChange,this,this._disposables),this._restoreState(),this._interactionCounter=new E(a,"languageStatus.interactCount"),e.onDidChange(this._update,this,this._disposables),r.onDidActiveEditorChange(this._update,this,this._disposables),this._update(),t.onDidChangeEntryVisibility(p=>{!p.visible&&this._dedicated.has(p.id)&&(this._dedicated.delete(p.id),this._update(),this._storeState())},void 0,this._disposables)}static _id="status.languageStatus";static _keyDedicatedItems="languageStatus.dedicated";_disposables=new A;_interactionCounter;_dedicated=new Set;_model;_combinedEntry;_dedicatedEntries=new Map;_renderDisposables=new A;dispose(){this._disposables.dispose(),this._combinedEntry?.dispose(),M(this._dedicatedEntries.values()),this._renderDisposables.dispose()}_handleStorageChange(){this._restoreState(),this._update()}_restoreState(){const e=this._storageService.get(o._keyDedicatedItems,_.PROFILE,"[]");try{const t=JSON.parse(e);this._dedicated=new Set(t)}catch{this._dedicated.clear()}}_storeState(){if(this._dedicated.size===0)this._storageService.remove(o._keyDedicatedItems,_.PROFILE);else{const e=JSON.stringify(Array.from(this._dedicated.keys()));this._storageService.store(o._keyDedicatedItems,e,_.PROFILE,P.USER)}}_createViewModel(e){if(!e?.hasModel())return new N([],[]);const t=this._languageStatusService.getLanguageStatus(e.getModel()),r=[],i=[];for(const s of t)this._dedicated.has(s.id)&&i.push(s),r.push(s);return new N(r,i)}_update(){const e=z(this._editorService.activeTextEditorControl),t=this._createViewModel(e);if(this._model?.isEqual(t))return;if(this._renderDisposables.clear(),this._model=t,e?.onDidChangeModelLanguage(this._update,this,this._renderDisposables),t.combined.length===0)this._combinedEntry?.dispose(),this._combinedEntry=void 0;else{const[i]=t.combined,s=i.severity>=S.Warning,a=o._severityToComboCodicon(i.severity);let p=!1;const b=[],h=document.createElement("div");for(const n of t.combined){const d=t.dedicated.includes(n);h.appendChild(this._renderStatus(n,s,d,this._renderDisposables)),b.push(o._accessibilityInformation(n).label),p=p||!d&&n.busy}const f={name:y("langStatus.name","Editor Language Status"),ariaLabel:y("langStatus.aria","Editor Language Status: {0}",b.join(", next: ")),tooltip:h,command:Z,text:R(a,p)};this._combinedEntry?this._combinedEntry.update(f):this._combinedEntry=this._statusBarService.addEntry(f,o._id,D.RIGHT,{id:"status.editor.mode",alignment:D.LEFT,compact:!0});const w=this._interactionCounter.value>=3,v=g.getWindow(e?.getContainerDomNode()),u=v.document.querySelector(".monaco-workbench .statusbar DIV#status\\.languageStatus A>SPAN.codicon"),l=v.document.querySelector(".monaco-workbench .statusbar DIV#status\\.languageStatus");if(g.isHTMLElement(u)&&l){const n="wiggle",d="flash";p?(u.classList.remove(n),l.classList.remove(d)):(u.classList.toggle(n,s||!w),this._renderDisposables.add(g.addDisposableListener(u,"animationend",I=>u.classList.remove(n))),l.classList.toggle(d,s),this._renderDisposables.add(g.addDisposableListener(l,"animationend",I=>l.classList.remove(d))))}if(!w){const n=v.document.querySelector(".monaco-workbench .context-view");if(g.isHTMLElement(n)){const d=new MutationObserver(()=>{v.document.contains(h)&&(this._interactionCounter.increment(),d.disconnect())});d.observe(n,{childList:!0,subtree:!0}),this._renderDisposables.add(G(()=>d.disconnect()))}}}const r=new Map;for(const i of t.dedicated){const s=o._asStatusbarEntry(i);let a=this._dedicatedEntries.get(i.id);a?(a.update(s),this._dedicatedEntries.delete(i.id)):a=this._statusBarService.addEntry(s,i.id,D.RIGHT,{id:"status.editor.mode",alignment:D.RIGHT}),r.set(i.id,a)}M(this._dedicatedEntries.values()),this._dedicatedEntries=r}_renderStatus(e,t,r,i){const s=document.createElement("div");s.classList.add("hover-language-status");const a=document.createElement("div");a.classList.add("severity",`sev${e.severity}`),a.classList.toggle("show",t);const p=o._severityToSingleCodicon(e.severity);g.append(a,...k(p)),s.appendChild(a);const b=document.createElement("div");b.classList.add("element"),s.appendChild(b);const h=document.createElement("div");h.classList.add("left"),b.appendChild(h);const f=document.createElement("span");f.classList.add("label");const w=typeof e.label=="string"?e.label:e.label.value;g.append(f,...k(R(w,e.busy))),h.appendChild(f);const v=document.createElement("span");v.classList.add("detail"),this._renderTextPlus(v,e.detail,i),h.appendChild(v);const u=document.createElement("div");u.classList.add("right"),b.appendChild(u);const{command:l}=e;l&&i.add(new V(u,{label:l.title,title:l.tooltip,href:se.from({scheme:"command",path:l.id,query:l.arguments&&JSON.stringify(l.arguments)}).toString()},{hoverDelegate:B},this._hoverService,this._openerService));const n=new re(u,{hoverDelegate:B}),d=r?y("unpin","Remove from Status Bar"):y("pin","Add to Status Bar");n.setAriaLabel(d),i.add(n);let I;return r?I=new W("unpin",d,x.asClassName(O.pinned),!0,()=>{this._dedicated.delete(e.id),this._statusBarService.updateEntryVisibility(e.id,!1),this._update(),this._storeState()}):I=new W("pin",d,x.asClassName(O.pin),!0,()=>{this._dedicated.add(e.id),this._statusBarService.updateEntryVisibility(e.id,!0),this._update(),this._storeState()}),n.push(I,{icon:!0,label:!1}),i.add(I),s}static _severityToComboCodicon(e){switch(e){case S.Error:return"$(bracket-error)";case S.Warning:return"$(bracket-dot)";default:return"$(bracket)"}}static _severityToSingleCodicon(e){switch(e){case S.Error:return"$(error)";case S.Warning:return"$(info)";default:return"$(check)"}}_renderTextPlus(e,t,r){for(const i of ee(t).nodes)if(typeof i=="string"){const s=k(i);g.append(e,...s)}else r.add(new V(e,i,void 0,this._hoverService,this._openerService))}static _accessibilityInformation(e){if(e.accessibilityInfo)return e.accessibilityInfo;const t=typeof e.label=="string"?e.label:e.label.value;return e.detail?{label:y("aria.1","{0}, {1}",t,e.detail)}:{label:y("aria.2","{0}",t)}}static _asStatusbarEntry(e){let t;e.severity===S.Warning?t="warning":e.severity===S.Error&&(t="error");const r=typeof e.label=="string"?e.label:e.label.shortValue;return{name:y("name.pattern","{0} (Language Status)",e.name),text:R(r,e.busy),ariaLabel:o._accessibilityInformation(e).label,role:e.accessibilityInfo?.role,tooltip:e.command?.tooltip||new ie(e.detail,{isTrusted:!0,supportThemeIcons:!0}),kind:t,command:e.command}}};o=C([m(0,Q),m(1,Y),m(2,U),m(3,ce),m(4,te),m(5,T)],o),j.as(K.Workbench).registerWorkbenchContribution(L,X.Restored),oe(class extends ae{constructor(){super({id:"editor.inlayHints.Reset",title:J("reset","Reset Language Status Interaction Counter"),category:ne.View,f1:!0})}run(c){c.get(T).remove("languageStatus.interactCount",_.PROFILE)}});function R(c,e){return pe([c!==""&&c,e&&"$(loading~spin)"],"\xA0\xA0")}
