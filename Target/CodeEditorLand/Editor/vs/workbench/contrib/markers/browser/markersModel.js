import{isNonEmptyArray as M}from"../../../../base/common/arrays.js";import{Emitter as R}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{hash as v}from"../../../../base/common/hash.js";import{ResourceMap as _}from"../../../../base/common/map.js";import{basename as S,extUri as c}from"../../../../base/common/resources.js";import{splitLines as U}from"../../../../base/common/strings.js";import"../../../../base/common/uri.js";import{Range as C}from"../../../../editor/common/core/range.js";import{IMarkerData as w,MarkerSeverity as f}from"../../../../platform/markers/common/markers.js";import{unsupportedSchemas as B}from"../../../../platform/markers/common/markerService.js";function Q(a,e){return c.compare(a.resource,e.resource)}function x(a,e){const[r]=a.markers,[s]=e.markers;let o=0;return r&&s&&(o=f.compare(r.marker.severity,s.marker.severity)),o===0&&(o=a.path.localeCompare(e.path)||a.name.localeCompare(e.name)),o}class m{constructor(e,r){this.id=e;this.resource=r;this.path=this.resource.fsPath,this.name=S(this.resource)}path;name;_markersMap=new _;_cachedMarkers;_total=0;get markers(){return this._cachedMarkers||(this._cachedMarkers=[...this._markersMap.values()].flat().sort(m._compareMarkers)),this._cachedMarkers}has(e){return this._markersMap.has(e)}set(e,r){this.delete(e),M(r)&&(this._markersMap.set(e,r),this._total+=r.length,this._cachedMarkers=void 0)}delete(e){const r=this._markersMap.get(e);r&&(this._total-=r.length,this._cachedMarkers=void 0,this._markersMap.delete(e))}get total(){return this._total}static _compareMarkers(e,r){return f.compare(e.marker.severity,r.marker.severity)||c.compare(e.resource,r.resource)||C.compareRangesUsingStarts(e.marker,r.marker)}}class g{constructor(e,r,s=[]){this.id=e;this.marker=r;this.relatedInformation=s}get resource(){return this.marker.resource}get range(){return this.marker}_lines;get lines(){return this._lines||(this._lines=U(this.marker.message)),this._lines}toString(){return JSON.stringify({...this.marker,resource:this.marker.resource.path,relatedInformation:this.relatedInformation.length?this.relatedInformation.map(e=>({...e.raw,resource:e.raw.resource.path})):void 0},null,"	")}}class V extends g{constructor(r,s,o,d,t,u){super(r.id,r.marker,r.relatedInformation);this.sourceMatches=s;this.codeMatches=o;this.messageMatches=d;this.fileMatches=t;this.ownerMatches=u}}class E{constructor(e,r,s){this.id=e;this.marker=r;this.raw=s}}class W{cachedSortedResources=void 0;_onDidChange=new R;onDidChange=this._onDidChange.event;get resourceMarkers(){return this.cachedSortedResources||(this.cachedSortedResources=[...this.resourcesByUri.values()].sort(x)),this.cachedSortedResources}resourcesByUri;constructor(){this.resourcesByUri=new Map}reset(){const e=new Set;for(const r of this.resourcesByUri.values())e.add(r);this.resourcesByUri.clear(),this._total=0,this._onDidChange.fire({removed:e,added:new Set,updated:new Set})}_total=0;get total(){return this._total}getResourceMarkers(e){return this.resourcesByUri.get(c.getComparisonKey(e,!0))??null}setResourceMarkers(e){const r={added:new Set,removed:new Set,updated:new Set};for(const[s,o]of e){if(B.has(s.scheme))continue;const d=c.getComparisonKey(s,!0);let t=this.resourcesByUri.get(d);if(M(o)){if(t)r.updated.add(t);else{const n=this.id(s.toString());t=new m(n,s.with({fragment:null})),this.resourcesByUri.set(d,t),r.added.add(t)}const u=new Map,y=o.map(n=>{const h=w.makeKey(n),l=u.get(h)||0;u.set(h,l+1);const k=this.id(t.id,h,l,n.resource.toString());let p;return n.relatedInformation&&(p=n.relatedInformation.map((i,I)=>new E(this.id(k,i.resource.toString(),i.startLineNumber,i.startColumn,i.endLineNumber,i.endColumn,I),n,i))),new g(k,n,p)});this._total-=t.total,t.set(s,y),this._total+=t.total}else t&&(this._total-=t.total,t.delete(s),this._total+=t.total,t.total===0?(this.resourcesByUri.delete(d),r.removed.add(t)):r.updated.add(t))}this.cachedSortedResources=void 0,(r.added.size||r.removed.size||r.updated.size)&&this._onDidChange.fire(r)}id(...e){return`${v(e)}`}dispose(){this._onDidChange.dispose(),this.resourcesByUri.clear()}}export{g as Marker,V as MarkerTableItem,W as MarkersModel,E as RelatedInformation,m as ResourceMarkers,Q as compareMarkersByUri};
