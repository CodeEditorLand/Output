{
  "version": 3,
  "sources": ["../../../../../../../../../../../../Dependency/Land/Dependency/Editor/Source/vs/workbench/contrib/notebook/browser/controller/chat/notebook.chat.contribution.ts"],
  "sourcesContent": ["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { codiconsLibrary } from '../../../../../../base/common/codiconsLibrary.js';\nimport { Disposable } from '../../../../../../base/common/lifecycle.js';\nimport { Position } from '../../../../../../editor/common/core/position.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\nimport { IWordAtPosition } from '../../../../../../editor/common/core/wordHelper.js';\nimport { CompletionContext, CompletionItemKind, CompletionList } from '../../../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { ILanguageFeaturesService } from '../../../../../../editor/common/services/languageFeatures.js';\nimport { localize } from '../../../../../../nls.js';\nimport { Action2, registerAction2 } from '../../../../../../platform/actions/common/actions.js';\nimport { IContextKey, IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { ServicesAccessor } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IQuickInputService, IQuickPickItem } from '../../../../../../platform/quickinput/common/quickInput.js';\nimport { IWorkbenchContribution, registerWorkbenchContribution2, WorkbenchPhase } from '../../../../../common/contributions.js';\nimport { IEditorService } from '../../../../../services/editor/common/editorService.js';\nimport { IChatWidget, IChatWidgetService } from '../../../../chat/browser/chat.js';\nimport { ChatInputPart } from '../../../../chat/browser/chatInputPart.js';\nimport { ChatDynamicVariableModel } from '../../../../chat/browser/contrib/chatDynamicVariables.js';\nimport { computeCompletionRanges } from '../../../../chat/browser/contrib/chatInputCompletions.js';\nimport { ChatAgentLocation, IChatAgentService } from '../../../../chat/common/chatAgents.js';\nimport { chatVariableLeader } from '../../../../chat/common/chatParserTypes.js';\nimport { INotebookKernelService } from '../../../common/notebookKernelService.js';\nimport { getNotebookEditorFromEditorPane } from '../../notebookBrowser.js';\nimport './cellChatActions.js';\nimport { CTX_NOTEBOOK_CHAT_HAS_AGENT } from './notebookChatContext.js';\n\nconst NotebookKernelVariableKey = 'kernelVariable';\n\nclass NotebookChatContribution extends Disposable implements IWorkbenchContribution {\n\tstatic readonly ID = 'workbench.contrib.notebookChatContribution';\n\n\tprivate readonly _ctxHasProvider: IContextKey<boolean>;\n\n\tconstructor(\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IChatAgentService chatAgentService: IChatAgentService,\n\t\t@IEditorService private readonly editorService: IEditorService,\n\t\t@IChatWidgetService private readonly chatWidgetService: IChatWidgetService,\n\t\t@INotebookKernelService private readonly notebookKernelService: INotebookKernelService,\n\t\t@ILanguageFeaturesService private readonly languageFeaturesService: ILanguageFeaturesService,\n\t) {\n\t\tsuper();\n\n\t\tthis._ctxHasProvider = CTX_NOTEBOOK_CHAT_HAS_AGENT.bindTo(contextKeyService);\n\n\t\tconst updateNotebookAgentStatus = () => {\n\t\t\tconst hasNotebookAgent = Boolean(chatAgentService.getDefaultAgent(ChatAgentLocation.Notebook));\n\t\t\tthis._ctxHasProvider.set(hasNotebookAgent);\n\t\t};\n\n\t\tupdateNotebookAgentStatus();\n\t\tthis._register(chatAgentService.onDidChangeAgents(updateNotebookAgentStatus));\n\n\t\tthis._register(this.languageFeaturesService.completionProvider.register({ scheme: ChatInputPart.INPUT_SCHEME, hasAccessToAllModels: true }, {\n\t\t\t_debugDisplayName: 'chatKernelDynamicCompletions',\n\t\t\ttriggerCharacters: [chatVariableLeader],\n\t\t\tprovideCompletionItems: async (model: ITextModel, position: Position, _context: CompletionContext, token: CancellationToken) => {\n\t\t\t\tconst widget = this.chatWidgetService.getWidgetByInputUri(model.uri);\n\t\t\t\tif (!widget || !widget.supportsFileReferences) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tif (widget.location !== ChatAgentLocation.Notebook) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst variableNameDef = new RegExp(`${chatVariableLeader}\\\\w*`, 'g');\n\t\t\t\tconst range = computeCompletionRanges(model, position, variableNameDef, true);\n\t\t\t\tif (!range) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst result: CompletionList = { suggestions: [] };\n\n\t\t\t\tconst afterRange = new Range(position.lineNumber, range.replace.startColumn, position.lineNumber, range.replace.startColumn + `${chatVariableLeader}${NotebookKernelVariableKey}:`.length);\n\t\t\t\tresult.suggestions.push({\n\t\t\t\t\tlabel: `${chatVariableLeader}${NotebookKernelVariableKey}`,\n\t\t\t\t\tinsertText: `${chatVariableLeader}${NotebookKernelVariableKey}:`,\n\t\t\t\t\tdetail: localize('pickKernelVariableLabel', \"Pick a variable from the kernel\"),\n\t\t\t\t\trange,\n\t\t\t\t\tkind: CompletionItemKind.Text,\n\t\t\t\t\tcommand: { id: SelectAndInsertKernelVariableAction.ID, title: SelectAndInsertKernelVariableAction.ID, arguments: [{ widget, range: afterRange }] },\n\t\t\t\t\tsortText: 'z'\n\t\t\t\t});\n\n\t\t\t\tawait this.addKernelVariableCompletion(widget, result, range, token);\n\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate async addKernelVariableCompletion(widget: IChatWidget, result: CompletionList, info: { insert: Range; replace: Range; varWord: IWordAtPosition | null }, token: CancellationToken) {\n\t\tlet pattern: string | undefined;\n\t\tif (info.varWord?.word && info.varWord.word.startsWith(chatVariableLeader)) {\n\t\t\tpattern = info.varWord.word.toLowerCase().slice(1);\n\t\t}\n\n\t\tconst notebook = getNotebookEditorFromEditorPane(this.editorService.activeEditorPane)?.getViewModel()?.notebookDocument;\n\n\t\tif (!notebook) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst selectedKernel = this.notebookKernelService.getMatchingKernel(notebook).selected;\n\t\tconst hasVariableProvider = selectedKernel?.hasVariableProvider;\n\n\t\tif (!hasVariableProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst variables = await selectedKernel.provideVariables(notebook.uri, undefined, 'named', 0, CancellationToken.None);\n\n\t\tfor await (const variable of variables) {\n\t\t\tif (pattern && !variable.name.toLowerCase().includes(pattern)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tresult.suggestions.push({\n\t\t\t\tlabel: { label: variable.name, description: variable.type },\n\t\t\t\tinsertText: `${chatVariableLeader}${NotebookKernelVariableKey}:${variable.name} `,\n\t\t\t\tfilterText: `${chatVariableLeader}${variable.name}`,\n\t\t\t\trange: info,\n\t\t\t\tkind: CompletionItemKind.Variable,\n\t\t\t\tsortText: 'z',\n\t\t\t\tcommand: { id: SelectAndInsertKernelVariableAction.ID, title: SelectAndInsertKernelVariableAction.ID, arguments: [{ widget, range: info.insert, variable: variable.name }] },\n\t\t\t\tdetail: variable.type,\n\t\t\t\tdocumentation: variable.value,\n\t\t\t});\n\t\t}\n\t}\n}\n\nexport class SelectAndInsertKernelVariableAction extends Action2 {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: SelectAndInsertKernelVariableAction.ID,\n\t\t\ttitle: '' // not displayed\n\t\t});\n\t}\n\n\tstatic readonly ID = 'notebook.chat.selectAndInsertKernelVariable';\n\n\toverride async run(accessor: ServicesAccessor, ...args: any[]): Promise<void> {\n\t\tconst editorService = accessor.get(IEditorService);\n\t\tconst notebookKernelService = accessor.get(INotebookKernelService);\n\t\tconst quickInputService = accessor.get(IQuickInputService);\n\n\t\tconst notebook = getNotebookEditorFromEditorPane(editorService.activeEditorPane)?.getViewModel()?.notebookDocument;\n\n\t\tif (!notebook) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst context = args[0];\n\t\tif (!context || !('widget' in context) || !('range' in context)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst widget = <IChatWidget>context.widget;\n\t\tconst range = <Range | undefined>context.range;\n\t\tconst variable = <string | undefined>context.variable;\n\n\t\tif (variable !== undefined) {\n\t\t\tthis.addVariableReference(widget, variable, range, false);\n\t\t\treturn;\n\t\t}\n\n\t\tconst selectedKernel = notebookKernelService.getMatchingKernel(notebook).selected;\n\t\tconst hasVariableProvider = selectedKernel?.hasVariableProvider;\n\n\t\tif (!hasVariableProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst variables = await selectedKernel.provideVariables(notebook.uri, undefined, 'named', 0, CancellationToken.None);\n\n\t\tconst quickPickItems: IQuickPickItem[] = [];\n\t\tfor await (const variable of variables) {\n\t\t\tquickPickItems.push({\n\t\t\t\tlabel: variable.name,\n\t\t\t\tdescription: variable.value,\n\t\t\t\tdetail: variable.type,\n\t\t\t});\n\t\t}\n\n\t\tconst pickedVariable = await quickInputService.pick(quickPickItems, { placeHolder: 'Select a kernel variable' });\n\t\tif (!pickedVariable) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.addVariableReference(widget, pickedVariable.label, range, true);\n\t}\n\n\tprivate addVariableReference(widget: IChatWidget, variableName: string, range?: Range, updateText?: boolean) {\n\t\tif (range) {\n\t\t\tconst text = `#kernelVariable:${variableName}`;\n\n\t\t\tif (updateText) {\n\t\t\t\tconst editor = widget.inputEditor;\n\t\t\t\tconst success = editor.executeEdits('chatInsertFile', [{ range, text: text + ' ' }]);\n\t\t\t\tif (!success) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\twidget.getContrib<ChatDynamicVariableModel>(ChatDynamicVariableModel.ID)?.addReference({\n\t\t\t\tid: 'vscode.notebook.variable',\n\t\t\t\trange: { startLineNumber: range.startLineNumber, startColumn: range.startColumn, endLineNumber: range.endLineNumber, endColumn: range.startColumn + text.length },\n\t\t\t\tdata: variableName,\n\t\t\t\tfullName: variableName,\n\t\t\t\ticon: codiconsLibrary.variable,\n\t\t\t});\n\t\t} else {\n\t\t\twidget.attachmentModel.addContext({\n\t\t\t\tid: 'vscode.notebook.variable',\n\t\t\t\tname: variableName,\n\t\t\t\tvalue: variableName,\n\t\t\t\ticon: codiconsLibrary.variable,\n\t\t\t\tisDynamic: true\n\t\t\t});\n\t\t}\n\t}\n}\n\nregisterAction2(SelectAndInsertKernelVariableAction);\nregisterWorkbenchContribution2(NotebookChatContribution.ID, NotebookChatContribution, WorkbenchPhase.BlockRestore);\n"],
  "mappings": "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",
  "names": ["variable"]
}
