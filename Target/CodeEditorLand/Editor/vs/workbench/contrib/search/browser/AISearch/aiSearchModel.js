var _=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var u=(h,n,e,t)=>{for(var r=t>1?void 0:t?F(n,e):n,i=h.length-1,a;i>=0;i--)(a=h[i])&&(r=(t?a(n,e,r):a(r))||r);return t&&r&&_(n,e,r),r},o=(h,n)=>(e,t)=>n(e,t,h);import{Emitter as m}from"../../../../../base/common/event.js";import{Lazy as T}from"../../../../../base/common/lazy.js";import{Disposable as R}from"../../../../../base/common/lifecycle.js";import"../../../../../base/common/uri.js";import"../../../../../editor/common/core/position.js";import"../../../../../editor/common/model.js";import{IModelService as b}from"../../../../../editor/common/services/model.js";import{IInstantiationService as p}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as M}from"../../../../../platform/label/common/label.js";import{IUriIdentityService as E}from"../../../../../platform/uriIdentity/common/uriIdentity.js";import{resultIsMatch as y}from"../../../../services/search/common/search.js";import"../../../notebook/browser/notebookEditorWidget.js";import{IReplaceService as C}from"../replace.js";import{FileMatchImpl as w}from"../searchTreeModel/fileMatch.js";import{TEXT_SEARCH_HEADING_PREFIX as x,AI_TEXT_SEARCH_RESULT_ID as D,FOLDER_MATCH_PREFIX as P,getFileMatches as A,FILE_MATCH_PREFIX as W}from"../searchTreeModel/searchTreeCommon.js";import{TextSearchHeadingImpl as U}from"../searchTreeModel/textSearchHeading.js";import{Range as L}from"../../../../../editor/common/core/range.js";import{textSearchResultToMatches as k}from"../searchTreeModel/match.js";import"./aiSearchModelBase.js";let I=class extends U{constructor(n,e,t){super(!1,n,e,t)}name(){return"AI"}id(){return x+D}get isAIContributed(){return!0}createWorkspaceRootWithResourceImpl(n,e,t,r){return this.instantiationService.createInstance(c,n,e,t,r,this)}};I=u([o(1,p),o(2,E)],I);let c=class extends R{constructor(e,t,r,i,a,s,d){super();this._resource=e;this._index=r;this._query=i;this._parent=a;this.instantiationService=s;this._fileMatches=new Map,this._id=P+t,this._name=new T(()=>this.resource?d.getUriBasenameLabel(this.resource):""),this._unDisposedFileMatches=new Map}_onChange=this._register(new m);onChange=this._onChange.event;_onDispose=this._register(new m);onDispose=this._onDispose.event;_id;_name;_unDisposedFileMatches;_fileMatches;get resource(){return this._resource}id(){return this._id}index(){return this._index}name(){return this._name.value}count(){return this._fileMatches.size}doAddFile(e){this._fileMatches.set(e.id(),e)}latestRank=0;createAndConfigureFileMatch(e,t){const r=this.instantiationService.createInstance(l,this._query.contentPattern,this._query.previewOptions,this._query.maxResults,this,e,this,e.resource.toString()+"_"+Date.now().toString(),this.latestRank++);r.createMatches(),this.doAddFile(r);const i=r.onChange(({didRemove:a})=>this.onFileChange(r,a));return this._register(r.onDispose(()=>i.dispose())),r}isAIContributed(){return!0}onFileChange(e,t=!1){let r=!1;this._fileMatches.has(e.id())||(this.doAddFile(e),r=!0),e.count()===0&&(this.doRemoveFile([e],!1,!1),r=!1,t=!0),this._onChange.fire({elements:[e],added:r,removed:t})}get hasChildren(){return this._fileMatches.size>0}parent(){return this._parent}matches(){return[...this._fileMatches.values()]}allDownstreamFileMatches(){return[...this._fileMatches.values()]}remove(e){Array.isArray(e)||(e=[e]);const t=A(e);this.doRemoveFile(t)}addFileMatch(e,t,r){const i=[],a=[];e.forEach(d=>{const f=this.createAndConfigureFileMatch(d,r);i.push(f)});const s=[...i,...a];!t&&s.length&&this._onChange.fire({elements:s,added:!!i.length})}isEmpty(){return this.recursiveFileCount()===0}clear(e){const t=this.allDownstreamFileMatches();this.disposeMatches(),this._onChange.fire({elements:t,removed:!0,added:!1,clearingAll:e})}get showHighlights(){return this._parent.showHighlights}get searchModel(){return this._searchResult.searchModel}get _searchResult(){return this._parent.parent()}get query(){return this._query}getDownstreamFileMatch(e){for(const t of this._fileMatches.values())if(t.resource.toString()===e.toString())return t;return null}replaceAll(){throw new Error("Cannot replace in AI search")}recursiveFileCount(){return this._fileMatches.size}doRemoveFile(e,t=!0,r=!0,i=!1){const a=[];for(const s of e)if(this._fileMatches.get(s.id())){if(i&&s.hasReadonlyMatches())continue;this._fileMatches.delete(s.id()),t?s.dispose():this._unDisposedFileMatches.set(s.id(),s),a.push(s)}r&&this._onChange.fire({elements:a,removed:!0})}replace(e){throw new Error("Cannot replace in AI search")}replacingAll=!1;bindModel(e){}unbindNotebookEditorWidget(e,t){}bindNotebookEditorWidget(e,t){return Promise.resolve()}hasOnlyReadOnlyMatches(){return Array.from(this._fileMatches.values()).every(e=>e.hasOnlyReadOnlyMatches())}fileMatchesIterator(){return this._fileMatches.values()}folderMatchesIterator(){return[].values()}recursiveMatchCount(){return this._fileMatches.size}disposeMatches(){[...this._fileMatches.values()].forEach(e=>e.dispose()),[...this._unDisposedFileMatches.values()].forEach(e=>e.dispose())}dispose(){this.disposeMatches(),this._onDispose.fire(),super.dispose()}};c=u([o(5,p),o(6,M)],c);let l=class extends w{constructor(e,t,r,i,a,s,d,f,g,v,S){super(e,t,r,i,a,s,g,v,S);this._id=d;this.rank=f}id(){return W+this._id}getFullRange(){let e,t;for(const r of this.matches()){const i=r.range().getStartPosition(),a=r.range().getEndPosition();(e===void 0||i.isBefore(e))&&(e=i),t===void 0?t=a:a.isBefore(t)||(t=a)}if(!(e===void 0||t===void 0))return new L(e.lineNumber,e.column,t.lineNumber,t.column)}rangeAsString(){const e=this.getFullRange();if(e)return e.startLineNumber+":"+e.startColumn+"-"+e.endLineNumber+":"+e.endColumn}name(){const e=this.rangeAsString();return super.name()+e?" "+e:""}createMatches(){this.rawMatch.results&&this.rawMatch.results.filter(y).forEach(e=>{k(e,this,!0).forEach(t=>this.add(t))})}};l=u([o(8,b),o(9,C),o(10,M)],l);export{c as AIFolderMatchWorkspaceRootImpl,I as AITextSearchHeadingImpl};
