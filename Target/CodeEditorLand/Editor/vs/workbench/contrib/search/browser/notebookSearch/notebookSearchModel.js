var k=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var u=(a,n,e,t)=>{for(var i=t>1?void 0:t?C(n,e):n,o=a.length-1,r;o>=0;o--)(r=a[o])&&(i=(t?r(n,e,i):r(i))||i);return t&&i&&k(n,e,i),i},h=(a,n)=>(e,t)=>n(e,t,a);import{coalesce as b}from"../../../../../base/common/arrays.js";import{RunOnceScheduler as x}from"../../../../../base/common/async.js";import{CancellationToken as W}from"../../../../../base/common/cancellation.js";import"../../../../../base/common/lifecycle.js";import{FindMatch as N}from"../../../../../editor/common/model.js";import{IModelService as S}from"../../../../../editor/common/services/model.js";import{ILabelService as E}from"../../../../../platform/label/common/label.js";import{resultIsMatch as g}from"../../../../services/search/common/search.js";import{getTextSearchMatchWithModelContext as m}from"../../../../services/search/common/searchHelpers.js";import{FindMatchDecorationModel as F}from"../../../notebook/browser/contrib/find/findMatchDecorationModel.js";import{CellFindMatchModel as T}from"../../../notebook/browser/contrib/find/findModel.js";import"../../../notebook/browser/notebookBrowser.js";import"../../../notebook/browser/notebookEditorWidget.js";import{INotebookEditorService as y}from"../../../notebook/browser/services/notebookEditorService.js";import{NotebookCellsChangeType as p}from"../../../notebook/common/notebookCommon.js";import{CellSearchModel as D}from"../../common/cellSearchModel.js";import{isINotebookFileMatchNoModel as R,rawCellPrefix as I}from"../../common/searchNotebookHelpers.js";import{contentMatchesToTextSearchMatches as P,isINotebookCellMatchWithModel as A,isINotebookFileMatchWithModel as U,webviewMatchesToTextSearchMatches as q}from"./searchNotebookHelpers.js";import{MATCH_PREFIX as H}from"../searchTreeModel/searchTreeCommon.js";import{IReplaceService as O}from"../replace.js";import{FileMatchImpl as V}from"../searchTreeModel/fileMatch.js";import{isIMatchInNotebook as L}from"./notebookSearchModelBase.js";import{MatchImpl as $,textSearchResultToMatches as z}from"../searchTreeModel/match.js";class c extends ${constructor(e,t,i,o,r){super(e.parent,t,i,o,!1);this._cellParent=e;this._id=H+this._parent.resource.toString()+">"+this._cellParent.cellIndex+(r?"_"+r:"")+"_"+this.notebookMatchTypeString()+this._range+this.getMatchString(),this._webviewIndex=r}_webviewIndex;parent(){return this._cellParent.parent}get cellParent(){return this._cellParent}notebookMatchTypeString(){return this.isWebviewMatch()?"webview":"content"}isWebviewMatch(){return this._webviewIndex!==void 0}get isReadonly(){return super.isReadonly||!this._cellParent.hasCellViewModel()||this.isWebviewMatch()}get cellIndex(){return this._cellParent.cellIndex}get webviewIndex(){return this._webviewIndex}get cell(){return this._cellParent.cell}}class f{constructor(n,e,t){this._parent=n;this._cell=e;this._cellIndex=t;this._contentMatches=new Map,this._webviewMatches=new Map,this._context=new Map}_contentMatches;_webviewMatches;_context;hasCellViewModel(){return!(this._cell instanceof D)}get context(){return new Map(this._context)}matches(){return[...this._contentMatches.values(),...this._webviewMatches.values()]}get contentMatches(){return Array.from(this._contentMatches.values())}get webviewMatches(){return Array.from(this._webviewMatches.values())}remove(n){Array.isArray(n)||(n=[n]);for(const e of n)this._contentMatches.delete(e.id()),this._webviewMatches.delete(e.id())}clearAllMatches(){this._contentMatches.clear(),this._webviewMatches.clear()}addContentMatches(n){_(n,this).forEach(t=>{this._contentMatches.set(t.id(),t)}),this.addContext(n)}addContext(n){this.cell&&this.cell.resolveTextModel().then(e=>{m(n,e,this.parent.parent().query).filter(o=>!g(o)).map(o=>({...o,lineNumber:o.lineNumber+1})).forEach(o=>{this._context.set(o.lineNumber,o.text)})})}addWebviewMatches(n){_(n,this).forEach(t=>{this._webviewMatches.set(t.id(),t)})}setCellModel(n){this._cell=n}get parent(){return this._parent}get id(){return this._cell?.id??`${I}${this.cellIndex}`}get cellIndex(){return this._cellIndex}get cell(){return this._cell}}let d=class extends V{constructor(e,t,i,o,r,s,M,l,v,w,B){super(e,t,i,o,r,s,l,v,w);this.searchInstanceID=M;this.notebookEditorService=B;this._cellMatches=new Map,this._notebookUpdateScheduler=new x(this.updateMatchesForEditorWidget.bind(this),250)}_notebookEditorWidget=null;_editorWidgetListener=null;_notebookUpdateScheduler;_lastEditorWidgetIdForUpdate;_cellMatches;get cellContext(){const e=new Map;return this._cellMatches.forEach(t=>{e.set(t.id,t.context)}),e}getCellMatch(e){return this._cellMatches.get(e)}addCellMatch(e){const t=new f(this,A(e)?e.cell:void 0,e.index);this._cellMatches.set(t.id,t),this.addWebviewMatchesToCell(t.id,e.webviewResults),this.addContentMatchesToCell(t.id,e.contentResults)}addWebviewMatchesToCell(e,t){const i=this.getCellMatch(e);i!==void 0&&i.addWebviewMatches(t)}addContentMatchesToCell(e,t){const i=this.getCellMatch(e);i!==void 0&&i.addContentMatches(t)}revealCellRange(e,t){!this._notebookEditorWidget||!e.cell||(e.webviewIndex!==void 0?this._notebookEditorWidget.getCellIndex(e.cell)!==void 0&&this._notebookEditorWidget.revealCellOffsetInCenter(e.cell,t??0):(e.cell.updateEditState(e.cell.getEditState(),"focusNotebookCell"),this._notebookEditorWidget.setCellEditorSelection(e.cell,e.range()),this._notebookEditorWidget.revealRangeInCenterIfOutsideViewportAsync(e.cell,e.range())))}bindNotebookEditorWidget(e){this._notebookEditorWidget!==e&&(this._notebookEditorWidget=e,this._editorWidgetListener=this._notebookEditorWidget.textModel?.onDidChangeContent(t=>{t.rawEvents.some(i=>i.kind===p.ChangeCellContent||i.kind===p.ModelChange)&&this._notebookUpdateScheduler.schedule()})??null,this._addNotebookHighlights())}unbindNotebookEditorWidget(e){e&&this._notebookEditorWidget!==e||(this._notebookEditorWidget&&(this._notebookUpdateScheduler.cancel(),this._editorWidgetListener?.dispose()),this._removeNotebookHighlights(),this._notebookEditorWidget=null)}updateNotebookHighlights(){this.parent().showHighlights?(this._addNotebookHighlights(),this.setNotebookFindMatchDecorationsUsingCellMatches(Array.from(this._cellMatches.values()))):this._removeNotebookHighlights()}_addNotebookHighlights(){this._notebookEditorWidget&&(this._findMatchDecorationModel?.stopWebviewFind(),this._findMatchDecorationModel?.dispose(),this._findMatchDecorationModel=new F(this._notebookEditorWidget,this.searchInstanceID),this._selectedMatch instanceof c&&this.highlightCurrentFindMatchDecoration(this._selectedMatch))}_removeNotebookHighlights(){this._findMatchDecorationModel&&(this._findMatchDecorationModel?.stopWebviewFind(),this._findMatchDecorationModel?.dispose(),this._findMatchDecorationModel=void 0)}updateNotebookMatches(e,t){if(!this._notebookEditorWidget)return;const i=new Map(this._cellMatches);this._notebookEditorWidget.getId()!==this._lastEditorWidgetIdForUpdate&&(this._cellMatches.clear(),this._lastEditorWidgetIdForUpdate=this._notebookEditorWidget.getId()),e.forEach(o=>{let r=this._cellMatches.get(o.cell.id);if(this._notebookEditorWidget&&!r){const M=this._notebookEditorWidget.getCellIndex(o.cell),l=i.get(`${I}${M}`);l&&(l.setCellModel(o.cell),l.clearAllMatches(),r=l)}r?.clearAllMatches();const s=r??new f(this,o.cell,o.index);s.addContentMatches(P(o.contentMatches,o.cell)),s.addWebviewMatches(q(o.webviewMatches)),this._cellMatches.set(s.id,s)}),this._findMatchDecorationModel?.setAllFindMatchesDecorations(e),this._selectedMatch instanceof c&&this.highlightCurrentFindMatchDecoration(this._selectedMatch),this._onChange.fire({forceUpdateModel:t})}setNotebookFindMatchDecorationsUsingCellMatches(e){if(!this._findMatchDecorationModel)return;const t=b(e.map(i=>{const o=b(i.webviewMatches.map(s=>{if(s.webviewIndex)return{index:s.webviewIndex}}));if(!i.cell)return;const r=i.contentMatches.map(s=>new N(s.range(),[s.text()]));return new T(i.cell,i.cellIndex,r,o)}));try{this._findMatchDecorationModel.setAllFindMatchesDecorations(t)}catch{}}async updateMatchesForEditorWidget(){if(!this._notebookEditorWidget)return;this._textMatches=new Map;const e=this._query.isWordMatch&&this._query.wordSeparators?this._query.wordSeparators:null,t=await this._notebookEditorWidget.find(this._query.pattern,{regex:this._query.isRegExp,wholeWord:this._query.isWordMatch,caseSensitive:this._query.isCaseSensitive,wordSeparators:e??void 0,includeMarkupInput:this._query.notebookInfo?.isInNotebookMarkdownInput,includeMarkupPreview:this._query.notebookInfo?.isInNotebookMarkdownPreview,includeCodeInput:this._query.notebookInfo?.isInNotebookCellInput,includeOutput:this._query.notebookInfo?.isInNotebookCellOutput},W.None,!1,!0,this.searchInstanceID);this.updateNotebookMatches(t,!0)}async showMatch(e){const t=await this.highlightCurrentFindMatchDecoration(e);this.setSelectedMatch(e),this.revealCellRange(e,t)}async highlightCurrentFindMatchDecoration(e){return!this._findMatchDecorationModel||!e.cell?null:e.webviewIndex===void 0?this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInCell(e.cell,e.range()):this._findMatchDecorationModel.highlightCurrentFindMatchDecorationInWebview(e.cell,e.webviewIndex)}matches(){const e=Array.from(this._cellMatches.values()).flatMap(t=>t.matches());return[...super.matches(),...e]}removeMatch(e){e instanceof c?(e.cellParent.remove(e),e.cellParent.matches().length===0&&this._cellMatches.delete(e.cellParent.id),this.isMatchSelected(e)?(this.setSelectedMatch(null),this._findMatchDecorationModel?.clearCurrentFindMatchDecoration()):this.updateHighlights(),this.setNotebookFindMatchDecorationsUsingCellMatches(this.cellMatches())):super.removeMatch(e)}cellMatches(){return Array.from(this._cellMatches.values())}createMatches(){const e=this.modelService.getModel(this._resource);if(e)this.bindModel(e),this.updateMatchesForModel();else{const t=this.notebookEditorService.retrieveExistingWidgetFromURI(this.resource);t?.value&&this.bindNotebookEditorWidget(t.value),this.rawMatch.results&&this.rawMatch.results.filter(g).forEach(i=>{z(i,this,!1).forEach(o=>this.add(o))}),(U(this.rawMatch)||R(this.rawMatch))&&(this.rawMatch.cellResults?.forEach(i=>this.addCellMatch(i)),this.setNotebookFindMatchDecorationsUsingCellMatches(this.cellMatches()),this._onChange.fire({forceUpdateModel:!0})),this.addContext(this.rawMatch.results)}}get hasChildren(){return super.hasChildren||this._cellMatches.size>0}setSelectedMatch(e){if(e){if(!this.isMatchSelected(e)&&L(e)){this._selectedMatch=e;return}if(!this._textMatches.has(e.id())||this.isMatchSelected(e))return}this._selectedMatch=e,this.updateHighlights()}dispose(){this.unbindNotebookEditorWidget(),super.dispose()}};d=u([h(7,S),h(8,O),h(9,E),h(10,y)],d);function _(a,n){const e=[];return a.forEach(t=>{const i=t.previewText.split(`
`);t.rangeLocations.map(o=>{const r=o.preview,s=new c(n,i,r,o.source,t.webviewIndex);e.push(s)})}),e}export{f as CellMatch,c as MatchInNotebook,d as NotebookCompatibleFileMatch,_ as textSearchMatchesToNotebookMatches};
