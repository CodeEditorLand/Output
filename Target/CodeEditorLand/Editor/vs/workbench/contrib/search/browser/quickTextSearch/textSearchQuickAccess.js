var F=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var T=(S,l,e,t)=>{for(var r=t>1?void 0:t?O(l,e):l,i=S.length-1,c;i>=0;i--)(c=S[i])&&(r=(t?c(l,e,r):c(r))||r);return t&&r&&F(l,e,r),r},u=(S,l)=>(e,t)=>l(e,t,S);import{CancellationTokenSource as x}from"../../../../../base/common/cancellation.js";import{DisposableStore as V}from"../../../../../base/common/lifecycle.js";import{ResourceSet as B}from"../../../../../base/common/map.js";import{basenameOrAuthority as D,dirname as L}from"../../../../../base/common/resources.js";import{ThemeIcon as I}from"../../../../../base/common/themables.js";import"../../../../../editor/common/core/range.js";import{localize as d}from"../../../../../nls.js";import{IConfigurationService as W}from"../../../../../platform/configuration/common/configuration.js";import"../../../../../platform/editor/common/editor.js";import{IInstantiationService as U}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as q}from"../../../../../platform/label/common/label.js";import{getSelectionKeyboardEvent as A}from"../../../../../platform/list/browser/listService.js";import{PickerQuickAccessProvider as H,TriggerAction as _}from"../../../../../platform/quickinput/browser/pickerQuickAccess.js";import{DefaultQuickAccessFilterValue as N}from"../../../../../platform/quickinput/common/quickAccess.js";import{QuickInputButtonLocation as K,QuickInputHideReason as X}from"../../../../../platform/quickinput/common/quickInput.js";import{IWorkspaceContextService as G}from"../../../../../platform/workspace/common/workspace.js";import"../../../../common/editor.js";import{searchDetailsIcon as w,searchOpenInFileIcon as $,searchActivityBarIcon as Y}from"../searchIcons.js";import{getEditorSelectionFromMatch as z}from"../searchView.js";import{getOutOfWorkspaceEditorResources as j}from"../../common/search.js";import{ACTIVE_GROUP as J,IEditorService as Z,SIDE_GROUP as ee}from"../../../../services/editor/common/editorService.js";import{QueryBuilder as te}from"../../../../services/search/common/queryBuilder.js";import{VIEW_ID as v}from"../../../../services/search/common/search.js";import{Event as k}from"../../../../../base/common/event.js";import{PickerEditorState as re}from"../../../../browser/quickaccess.js";import{IViewsService as ie}from"../../../../services/views/common/viewsService.js";import{Sequencer as se}from"../../../../../base/common/async.js";import"../../../../../base/common/uri.js";import{Codicon as oe}from"../../../../../base/common/codicons.js";import{SearchModelImpl as b}from"../searchTreeModel/searchModel.js";import{SearchModelLocation as y}from"../searchTreeModel/searchTreeCommon.js";import{searchComparer as ce}from"../searchCompare.js";import"../../../../../base/common/filters.js";const C="%",ae={_reason:"quickAccessSearch",disregardIgnoreFiles:!1,disregardExcludeSettings:!1,onlyOpenEditors:!1,expandPatterns:!0},M=30,ne=10,le=75;let f=class extends H{constructor(e,t,r,i,c,s){super(C,{canAcceptInBackground:!0,shouldSkipTrimPickFilter:!0});this._instantiationService=e;this._contextService=t;this._editorService=r;this._labelService=i;this._viewsService=c;this._configurationService=s;this.queryBuilder=this._instantiationService.createInstance(te),this.searchModel=this._register(this._instantiationService.createInstance(b)),this.editorViewState=this._register(this._instantiationService.createInstance(re)),this.searchModel.location=y.QUICK_ACCESS,this.editorSequencer=new se}editorSequencer;queryBuilder;searchModel;currentAsyncSearch=Promise.resolve({results:[],messages:[]});editorViewState;_getTextQueryBuilderOptions(e){return{...ae,extraFileResources:this._instantiationService.invokeFunction(j),maxResults:this.configuration.maxResults??void 0,isSmartCase:this.configuration.smartCase,previewOptions:{matchLines:1,charsPerLine:e}}}dispose(){this.searchModel.dispose(),super.dispose()}provide(e,t,r){const i=new V;C.length<e.value.length&&(e.valueSelection=[C.length,e.value.length]),e.buttons=[{location:K.Inline,iconClass:I.asClassName(oe.goToSearch),tooltip:d("goToSearch","See in Search Panel")}],this.editorViewState.reset(),i.add(e.onDidTriggerButton(async()=>{this.searchModel.searchResult.count()>0?await this.moveToSearchViewlet(void 0):this._viewsService.openView(v,!0),e.hide()}));const c=()=>{const[s]=e.activeItems;if(s?.match){this.editorViewState.set();const o=s.match;this.editorSequencer.queue(async()=>{await this.editorViewState.openTransientEditor({resource:o.parent().resource,options:{preserveFocus:!0,revealIfOpened:!0,ignoreError:!0,selection:o.range()}})})}};return i.add(k.debounce(e.onDidChangeActive,(s,o)=>o,le,!0)(c)),i.add(k.once(e.onWillHide)(({reason:s})=>{s===X.Gesture&&this.editorViewState.restore()})),i.add(k.once(e.onDidHide)(({reason:s})=>{this.searchModel.searchResult.toggleHighlights(!1)})),i.add(super.provide(e,t,r)),i.add(e.onDidAccept(()=>this.searchModel.searchResult.toggleHighlights(!1))),i}get configuration(){const e=this._configurationService.getValue().workbench?.editor,t=this._configurationService.getValue().search;return{openEditorPinned:!e?.enablePreviewFromQuickOpen||!e?.enablePreview,preserveInput:t.quickAccess.preserveInput,maxResults:t.maxResults,smartCase:t.smartCase,sortOrder:t.sortOrder}}get defaultFilterValue(){if(this.configuration.preserveInput)return N.LAST}doSearch(e,t){if(e==="")return;const r=this._contextService.getWorkspace().folders,i={pattern:e};this.searchModel.searchResult.toggleHighlights(!1);const c=i.isRegExp?1e4:1e3,s=this.queryBuilder.text(i,r.map(a=>a.uri),this._getTextQueryBuilderOptions(c)),o=this.searchModel.search(s,void 0,t),n=async()=>{this.currentAsyncSearch=o.asyncResults,await o.asyncResults;const a=new B(o.syncResults.map(p=>p.resource));return this.searchModel.searchResult.matches(!1).filter(p=>!a.has(p.resource))};return{syncResults:this.searchModel.searchResult.matches(!1),asyncResults:n()}}async moveToSearchViewlet(e){this._viewsService.openView(v,!1);const t=this._viewsService.getActiveViewWithId(v);await t.replaceSearchModel(this.searchModel,this.currentAsyncSearch),this.searchModel=this._instantiationService.createInstance(b),this.searchModel.location=y.QUICK_ACCESS;const r=t?.getControl();e?(r.setFocus([e],A()),r.setSelection([e],A()),r.reveal(e)):t.searchAndReplaceWidget.focus()}_getPicksFromMatches(e,t,r){e=e.sort((s,o)=>{if(r){if(r===s.resource)return-1;if(r===o.resource)return 1}return ce(s,o,this.configuration.sortOrder)});const i=e.length>t?e.slice(0,t):e,c=[];for(let s=0;s<e.length;s++){if(s===t){c.push({type:"separator"}),c.push({label:d("QuickSearchSeeMoreFiles","See More Files"),iconClass:I.asClassName(w),accept:async()=>{await this.moveToSearchViewlet(e[t])}});break}const o=i[s],n=D(o.resource),a=this._labelService.getUriLabel(L(o.resource),{relative:!0});c.push({label:n,type:"separator",description:a,buttons:[{iconClass:I.asClassName($),tooltip:d("QuickSearchOpenInFile","Open File")}],trigger:async()=>(await this.handleAccept(o,{}),_.CLOSE_PICKER)});const p=o.matches()??[];for(let g=0;g<p.length;g++){const h=p[g];if(g===ne){c.push({label:d("QuickSearchMore","More"),iconClass:I.asClassName(w),accept:async()=>{await this.moveToSearchViewlet(h)}});break}const m=h.preview(),P=(m.before+m.inside+m.after).trim().substring(0,999),E=[{start:m.before.length,end:m.before.length+m.inside.length}];c.push({label:`${P}`,highlights:{label:E},buttons:[{iconClass:I.asClassName(Y),tooltip:d("showMore","See in Search Panel")}],ariaLabel:`Match at location ${h.range().startLineNumber}:${h.range().startColumn} - ${P}`,accept:async(Q,R)=>{await this.handleAccept(o,{keyMods:Q,selection:z(h,this.searchModel),preserveFocus:R.inBackground,forcePinned:R.inBackground})},trigger:async()=>(await this.moveToSearchViewlet(h),_.CLOSE_PICKER),match:h})}}return c}async handleAccept(e,t){const r={preserveFocus:t.preserveFocus,pinned:t.keyMods?.ctrlCmd||t.forcePinned||this.configuration.openEditorPinned,selection:t.selection},i=t.keyMods?.alt||this.configuration.openEditorPinned&&t.keyMods?.ctrlCmd||t.forceOpenSideBySide?ee:J;await this._editorService.openEditor({resource:e.resource,options:r},i)}_getPicks(e,t,r){const i=this.searchModel;if(e==="")return this.searchModel.searchResult.clear(),[{label:d("enterSearchTerm","Enter a term to search for across your files.")}];const c=t.add(new x);t.add(r.onCancellationRequested(()=>{i.location===y.QUICK_ACCESS&&c.cancel()}));const s=this.doSearch(e,c.token);if(!s)return null;const o=s.syncResults,n=this._getPicksFromMatches(o,M,this._editorService.activeEditor?.resource);return n.length>0&&this.searchModel.searchResult.toggleHighlights(!0),o.length>=M?n:{picks:n,additionalPicks:s.asyncResults.then(a=>a.length+n.length===0?[{label:d("noAnythingResults","No matching results")}]:this._getPicksFromMatches(a,M-o.length)).then(a=>(a.length>0&&this.searchModel.searchResult.toggleHighlights(!0),a))}}};f=T([u(0,U),u(1,G),u(2,Z),u(3,q),u(4,ie),u(5,W)],f);export{C as TEXT_SEARCH_QUICK_ACCESS_PREFIX,f as TextSearchQuickAccess};
