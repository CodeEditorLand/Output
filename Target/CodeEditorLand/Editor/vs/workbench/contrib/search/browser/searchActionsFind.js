import{dirname as U}from"../../../../base/common/resources.js";import*as h from"../../../../nls.js";import{ICommandService as R}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as A}from"../../../../platform/configuration/common/configuration.js";import"../../../../platform/instantiation/common/instantiation.js";import{IListService as z}from"../../../../platform/list/browser/listService.js";import{ViewContainerLocation as _}from"../../../common/views.js";import{IViewsService as v}from"../../../services/views/common/viewsService.js";import*as s from"../common/constants.js";import*as w from"../../searchEditor/browser/constants.js";import"../../searchEditor/browser/searchEditor.contribution.js";import"../../../services/search/common/search.js";import"../../../../base/common/uri.js";import{ContextKeyExpr as S}from"../../../../platform/contextkey/common/contextkey.js";import{Action2 as g,MenuId as I,registerAction2 as F}from"../../../../platform/actions/common/actions.js";import{KeybindingWeight as b}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{KeyCode as W,KeyMod as y}from"../../../../base/common/keyCodes.js";import{resolveResourcesForSearchIncludes as D}from"../../../services/search/common/queryBuilder.js";import{getMultiSelectedResources as L,IExplorerService as K}from"../../files/browser/files.js";import{IFileService as j}from"../../../../platform/files/common/files.js";import{IWorkspaceContextService as T}from"../../../../platform/workspace/common/workspace.js";import{ExplorerFolderContext as k,ExplorerRootContext as q,FilesExplorerFocusCondition as B,VIEWLET_ID as H}from"../../files/common/files.js";import{IPaneCompositePartService as G}from"../../../services/panecomposite/browser/panecomposite.js";import"../../files/browser/explorerViewlet.js";import{onUnexpectedError as N}from"../../../../base/common/errors.js";import{category as x,getElementsToOperateOn as Q,getSearchView as V,openSearchView as M}from"./searchActionsBase.js";import{IConfigurationResolverService as J}from"../../../services/configurationResolver/common/configurationResolver.js";import{IHistoryService as X}from"../../../services/history/common/history.js";import{Schemas as P}from"../../../../base/common/network.js";import{IEditorGroupsService as Y}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as Z}from"../../../services/editor/common/editorService.js";import{forcedExpandRecursively as $}from"./searchActionsTopBar.js";import{isSearchTreeFileMatch as ee,isSearchTreeMatch as re}from"./searchTreeModel/searchTreeCommon.js";F(class extends g{constructor(){super({id:s.SearchCommandIds.RestrictSearchToFolderId,title:h.localize2("restrictResultsToFolder","Restrict Search to Folder"),category:x,keybinding:{weight:b.WorkbenchContrib,when:S.and(s.SearchContext.SearchViewVisibleKey,s.SearchContext.ResourceFolderFocusKey),primary:y.Shift|y.Alt|W.KeyF},menu:[{id:I.SearchContext,group:"search",order:3,when:S.and(s.SearchContext.ResourceFolderFocusKey)}]})}async run(r,o){await O(r,!1,!0,void 0,o)}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.ExpandRecursivelyCommandId,title:h.localize("search.expandRecursively","Expand Recursively"),category:x,menu:[{id:I.SearchContext,when:S.and(s.SearchContext.FolderFocusKey,s.SearchContext.HasSearchResults),group:"search",order:4}]})}async run(r){return oe(r)}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.ExcludeFolderFromSearchId,title:h.localize2("excludeFolderFromSearch","Exclude Folder from Search"),category:x,menu:[{id:I.SearchContext,group:"search",order:4,when:S.and(s.SearchContext.ResourceFolderFocusKey)}]})}async run(r,o){await O(r,!1,!1,void 0,o)}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.RevealInSideBarForSearchResults,title:h.localize2("revealInSideBar","Reveal in Explorer View"),category:x,menu:[{id:I.SearchContext,when:S.and(s.SearchContext.FileFocusKey,s.SearchContext.HasSearchResults),group:"search_3",order:1}]})}async run(r,o){const n=r.get(G),p=r.get(K),a=r.get(T),f=V(r.get(v));if(!f)return;let i;if(ee(o))i=o;else{o=f.getControl().getFocus()[0];return}n.openPaneComposite(H,_.Sidebar,!1).then(t=>{if(!t)return;const u=t.getViewPaneContainer(),l=i.resource;if(l&&a.isInsideWorkspace(l)){const d=u.getExplorerView();d.setExpanded(!0),p.select(l,!0).then(()=>d.focus(),N)}})}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.FindInFilesActionId,title:{...h.localize2("findInFiles","Find in Files"),mnemonicTitle:h.localize({key:"miFindInFiles",comment:["&& denotes a mnemonic"]},"Find &&in Files")},metadata:{description:h.localize("findInFiles.description","Open a workspace search"),args:[{name:h.localize("findInFiles.args","A set of options for the search"),schema:{type:"object",properties:{query:{type:"string"},replace:{type:"string"},preserveCase:{type:"boolean"},triggerSearch:{type:"boolean"},filesToInclude:{type:"string"},filesToExclude:{type:"string"},isRegex:{type:"boolean"},isCaseSensitive:{type:"boolean"},matchWholeWord:{type:"boolean"},useExcludeSettingsAndIgnoreFiles:{type:"boolean"},onlyOpenEditors:{type:"boolean"},showIncludesExcludes:{type:"boolean"}}}}]},category:x,keybinding:{weight:b.WorkbenchContrib,primary:y.CtrlCmd|y.Shift|W.KeyF},menu:[{id:I.MenubarEditMenu,group:"4_find_global",order:1}],f1:!0})}async run(r,o={}){ne(r,o)}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.FindInFolderId,title:h.localize2("findInFolder","Find in Folder..."),category:x,keybinding:{weight:b.WorkbenchContrib,when:S.and(B,k),primary:y.Shift|y.Alt|W.KeyF},menu:[{id:I.ExplorerContext,group:"4_search",order:10,when:S.and(k)}]})}async run(r,o){await O(r,!0,!0,o)}}),F(class extends g{constructor(){super({id:s.SearchCommandIds.FindInWorkspaceId,title:h.localize2("findInWorkspace","Find in Workspace..."),category:x,menu:[{id:I.ExplorerContext,group:"4_search",order:10,when:S.and(q,k.toNegated())}]})}async run(r){const n=r.get(A).getValue().search.mode;if(n==="view")(await M(r.get(v),!0))?.searchInFolders();else return r.get(R).executeCommand(w.OpenEditorCommandId,{location:n==="newEditor"?"new":"reuse",filesToInclude:""})}});async function oe(e){const r=e.get(v),o=V(r);if(o){const n=o.getControl(),p=n.getFocus()[0];await $(n,p)}}async function O(e,r,o,n,p){const a=e.get(j),f=e.get(v),i=e.get(T),t=e.get(R),u=e.get(A).getValue().search,l=u.mode;let d;if(r)d=L(n,e.get(z),e.get(Z),e.get(Y),e.get(K));else{const c=V(f);if(!c)return;d=te(c.getControl(),p,u)}const C=a.resolveAll(d.map(c=>({resource:c}))).then(c=>{const E=[];return c.forEach(m=>{m.success&&m.stat&&E.push(m.stat.isDirectory?m.stat.resource:U(m.stat.resource))}),D(E,i)});if(l==="view"){const c=await M(f,!0);d&&d.length&&c&&(o?c.searchInFolders(await C):c.searchOutsideOfFolders(await C));return}else return o?t.executeCommand(w.OpenEditorCommandId,{filesToInclude:(await C).join(", "),showIncludesExcludes:!0,location:l==="newEditor"?"new":"reuse"}):t.executeCommand(w.OpenEditorCommandId,{filesToExclude:(await C).join(", "),showIncludesExcludes:!0,location:l==="newEditor"?"new":"reuse"})}function te(e,r,o){return Q(e,r,o).map(n=>re(n)?null:n.resource).filter(n=>n!==null)}async function ne(e,r={}){const o=e.get(A).getValue().search,n=e.get(v),p=e.get(R),a={};if(Object.keys(r).length!==0){const i=e.get(J),t=e.get(X),u=e.get(T),l=t.getLastActiveWorkspaceRoot(),d=l?.scheme===P.file||l?.scheme===P.vscodeRemote?l:void 0,C=d?u.getWorkspaceFolder(d)??void 0:void 0;for(const c of Object.entries(r)){const E=c[0],m=c[1];m!==void 0&&(a[E]=typeof m=="string"?await i.resolveAsync(C,m):m)}}const f=o.mode;if(f==="view")M(n,!1).then(i=>{if(i){i.searchAndReplaceWidget.toggleReplace(typeof a.replace=="string");let u=!1;typeof a.query!="string"&&(u=i.updateTextFromFindWidgetOrSelection({allowUnselectedWord:typeof a.replace!="string"})),i.setSearchParameters(a),typeof a.showIncludesExcludes=="boolean"&&i.toggleQueryDetails(!1,a.showIncludesExcludes),i.searchAndReplaceWidget.focus(void 0,u,u)}});else{const i=t=>({location:f==="newEditor"?"new":"reuse",query:t.query,filesToInclude:t.filesToInclude,filesToExclude:t.filesToExclude,matchWholeWord:t.matchWholeWord,isCaseSensitive:t.isCaseSensitive,isRegexp:t.isRegex,useExcludeSettingsAndIgnoreFiles:t.useExcludeSettingsAndIgnoreFiles,onlyOpenEditors:t.onlyOpenEditors,showIncludesExcludes:!!(t.filesToExclude||t.filesToExclude||!t.useExcludeSettingsAndIgnoreFiles)});p.executeCommand(w.OpenEditorCommandId,i(a))}}export{ne as findInFilesCommand};
