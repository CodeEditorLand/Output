import*as l from"../../../../nls.js";import"../../../../platform/commands/common/commands.js";import"../../../../platform/instantiation/common/instantiation.js";import{WorkbenchListFocusContextKey as F}from"../../../../platform/list/browser/listService.js";import{IViewsService as m}from"../../../services/views/common/viewsService.js";import{searchClearIcon as L,searchCollapseAllIcon as N,searchExpandAllIcon as M,searchRefreshIcon as q,searchShowAsList as P,searchShowAsTree as k,searchStopIcon as z}from"./searchIcons.js";import*as s from"../common/constants.js";import{ISearchHistoryService as W}from"../common/searchHistoryService.js";import{VIEW_ID as p}from"../../../services/search/common/search.js";import{ContextKeyExpr as i}from"../../../../platform/contextkey/common/contextkey.js";import{Action2 as d,MenuId as f,registerAction2 as h}from"../../../../platform/actions/common/actions.js";import{KeybindingWeight as D}from"../../../../platform/keybinding/common/keybindingsRegistry.js";import{KeyCode as Q}from"../../../../base/common/keyCodes.js";import{SearchStateKey as V,SearchUIState as I}from"../common/search.js";import{category as u,getSearchView as w}from"./searchActionsBase.js";import{isSearchTreeMatch as T,isSearchTreeFolderMatch as R,isSearchTreeFolderMatchNoRoot as K,isSearchTreeFolderMatchWorkspaceRoot as b,isSearchResult as v,isTextSearchHeading as C,isSearchTreeFileMatch as E}from"./searchTreeModel/searchTreeCommon.js";h(class extends d{constructor(){super({id:s.SearchCommandIds.ClearSearchHistoryCommandId,title:l.localize2("clearSearchHistoryLabel","Clear Search History"),category:u,f1:!0})}async run(e){U(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.CancelSearchActionId,title:l.localize2("CancelSearchAction.label","Cancel Search"),icon:z,category:u,f1:!0,precondition:V.isEqualTo(I.Idle).negate(),keybinding:{weight:D.WorkbenchContrib,when:i.and(s.SearchContext.SearchViewVisibleKey,F),primary:Q.Escape},menu:[{id:f.ViewTitle,group:"navigation",order:0,when:i.and(i.equals("view",p),V.isEqualTo(I.SlowSearch))}]})}run(e){return B(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.RefreshSearchResultsActionId,title:l.localize2("RefreshAction.label","Refresh"),icon:q,precondition:s.SearchContext.ViewHasSearchPatternKey,category:u,f1:!0,menu:[{id:f.ViewTitle,group:"navigation",order:0,when:i.and(i.equals("view",p),V.isEqualTo(I.SlowSearch).negate())}]})}run(e,...o){return G(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.CollapseSearchResultsActionId,title:l.localize2("CollapseDeepestExpandedLevelAction.label","Collapse All"),category:u,icon:N,f1:!0,precondition:i.and(s.SearchContext.HasSearchResults,s.SearchContext.ViewHasSomeCollapsibleKey),menu:[{id:f.ViewTitle,group:"navigation",order:4,when:i.and(i.equals("view",p),i.or(s.SearchContext.HasSearchResults.negate(),s.SearchContext.ViewHasSomeCollapsibleKey))}]})}run(e,...o){return J(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.ExpandSearchResultsActionId,title:l.localize2("ExpandAllAction.label","Expand All"),category:u,icon:M,f1:!0,precondition:i.and(s.SearchContext.HasSearchResults,s.SearchContext.ViewHasSomeCollapsibleKey.toNegated()),menu:[{id:f.ViewTitle,group:"navigation",order:4,when:i.and(i.equals("view",p),s.SearchContext.HasSearchResults,s.SearchContext.ViewHasSomeCollapsibleKey.toNegated())}]})}async run(e,...o){return _(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.ClearSearchResultsActionId,title:l.localize2("ClearSearchResultsAction.label","Clear Search Results"),category:u,icon:L,f1:!0,precondition:i.or(s.SearchContext.HasSearchResults,s.SearchContext.ViewHasSearchPatternKey,s.SearchContext.ViewHasReplacePatternKey,s.SearchContext.ViewHasFilePatternKey),menu:[{id:f.ViewTitle,group:"navigation",order:1,when:i.equals("view",p)}]})}run(e,...o){return j(e)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.ViewAsTreeActionId,title:l.localize2("ViewAsTreeAction.label","View as Tree"),category:u,icon:P,f1:!0,precondition:i.and(s.SearchContext.HasSearchResults,s.SearchContext.InTreeViewKey.toNegated()),menu:[{id:f.ViewTitle,group:"navigation",order:2,when:i.and(i.equals("view",p),s.SearchContext.InTreeViewKey.toNegated())}]})}async run(e,...o){const r=w(e.get(m));r&&await r.setTreeView(!0)}}),h(class extends d{constructor(){super({id:s.SearchCommandIds.ViewAsListActionId,title:l.localize2("ViewAsListAction.label","View as List"),category:u,icon:k,f1:!0,precondition:i.and(s.SearchContext.HasSearchResults,s.SearchContext.InTreeViewKey),menu:[{id:f.ViewTitle,group:"navigation",order:2,when:i.and(i.equals("view",p),s.SearchContext.InTreeViewKey)}]})}async run(e,...o){const r=w(e.get(m));r&&await r.setTreeView(!1)}});const U=a=>{a.get(W).clearHistory()};async function _(a){const e=a.get(m),o=w(e);if(o){const r=o.getControl();o.shouldShowAIResults()?o.model.hasAIResults?await x(r,void 0):await x(r,o.model.searchResult.plainTextSearchResult):await x(r,void 0)}}async function x(a,e){if(e){if(!a.hasNode(e))return;await a.expand(e,!0)}const o=a.getNode(e)?.children;if(o)for(const r of o){if(v(r.element))throw Error("SearchResult should not be a child of a RenderableMatch");x(a,r.element)}}function j(a){const e=a.get(m);w(e)?.clearSearchResults()}function B(a){const e=a.get(m);w(e)?.cancelSearch()}function G(a){const e=a.get(m);w(e)?.triggerQueryChange({preserveFocus:!1})}function J(a){const e=a.get(m),o=w(e);if(o){const r=o.getControl(),c=r.navigate();let t=c.first(),H=!1,y=!1;do t=c.next();while(C(t));if(b(t)||o.isTreeLayoutViewVisible){for(;t=c.next();)if(!C(t)){if(T(t)){H=!0;break}if(o.isTreeLayoutViewVisible&&!y){let g=t;if(R(t)){const n=r.getCompressedTreeNode(t)?.elements[0].element;g=n&&!T(n)&&!C(n)&&!v(n)?n:t}const S=g.parent();C(S)||b(S)||K(S)||v(S)||(y=!0)}}}if(H){t=c.first();do E(t)&&r.collapse(t);while(t=c.next())}else if(y){if(t=c.first(),t)do{let g=t;if(R(t)){const n=r.getCompressedTreeNode(t)?.elements[0].element;g=n&&!T(n)&&!v(n)?n:t}const S=g.parent();(b(S)||K(S))&&(r.hasNode(t)?r.collapse(t,!0):r.collapseAll())}while(t=c.next())}else if(C(c.first())){t=c.first();do{if(!t)break;C(r.getParentElement(t))&&r.collapse(t)}while(t=c.next())}else r.collapseAll();const A=r.getFocus()[0]?.parent();A&&(R(A)||E(A))&&r.hasNode(A)&&r.isCollapsed(A)&&(r.domFocus(),r.focusFirst(),r.setSelection(r.getFocus()))}}export{x as forcedExpandRecursively};
