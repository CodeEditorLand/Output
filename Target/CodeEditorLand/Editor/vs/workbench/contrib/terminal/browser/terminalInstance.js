var Se=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var x=(p,d,e,t)=>{for(var i=t>1?void 0:t?xe(d,e):d,s=p.length-1,r;s>=0;s--)(r=p[s])&&(i=(t?r(d,e,i):r(i))||i);return t&&i&&Se(d,e,i),i},o=(p,d)=>(e,t)=>d(e,t,p);import{isFirefox as Ie}from"../../../../base/browser/browser.js";import{BrowserFeatures as Te}from"../../../../base/browser/canIUse.js";import{DataTransfers as q}from"../../../../base/browser/dnd.js";import*as h from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as se}from"../../../../base/browser/keyboardEvent.js";import{Orientation as U}from"../../../../base/browser/ui/sash/sash.js";import{DomScrollableElement as De}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{AutoOpenBarrier as re,Promises as Pe,disposableTimeout as Le,timeout as ne}from"../../../../base/common/async.js";import{Codicon as B}from"../../../../base/common/codicons.js";import{debounce as X}from"../../../../base/common/decorators.js";import{onUnexpectedError as oe}from"../../../../base/common/errors.js";import{Emitter as l}from"../../../../base/common/event.js";import{KeyCode as Ee}from"../../../../base/common/keyCodes.js";import{template as Re}from"../../../../base/common/labels.js";import{Disposable as j,DisposableStore as ae,ImmortalReference as ke,MutableDisposable as $,dispose as le,toDisposable as G}from"../../../../base/common/lifecycle.js";import{Schemas as Q}from"../../../../base/common/network.js";import*as R from"../../../../base/common/path.js";import{OS as Me,OperatingSystem as Y,isMacintosh as Ae,isWindows as ce}from"../../../../base/common/platform.js";import{ScrollbarVisibility as he}from"../../../../base/common/scrollable.js";import{URI as k}from"../../../../base/common/uri.js";import{TabFocus as Fe}from"../../../../editor/browser/config/tabFocus.js";import*as c from"../../../../nls.js";import{IAccessibilityService as Ke}from"../../../../platform/accessibility/common/accessibility.js";import{AccessibilitySignal as Oe,IAccessibilitySignalService as We}from"../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{ICommandService as Be}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as ze}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as de}from"../../../../platform/contextkey/common/contextkey.js";import{CodeDataTransfers as ue,containsDragType as Z,getPathForFile as me}from"../../../../platform/dnd/browser/dnd.js";import{FileSystemProviderCapabilities as Ve,IFileService as Ne}from"../../../../platform/files/common/files.js";import{IInstantiationService as He}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as qe}from"../../../../platform/instantiation/common/serviceCollection.js";import{IKeybindingService as Ue}from"../../../../platform/keybinding/common/keybinding.js";import{ResultKind as pe}from"../../../../platform/keybinding/common/keybindingResolver.js";import{INotificationService as Xe,Severity as D}from"../../../../platform/notification/common/notification.js";import{IOpenerService as je}from"../../../../platform/opener/common/opener.js";import{IProductService as $e}from"../../../../platform/product/common/productService.js";import{IQuickInputService as Ge}from"../../../../platform/quickinput/common/quickInput.js";import{IStorageService as Qe,StorageScope as J,StorageTarget as Ye}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as Ze}from"../../../../platform/telemetry/common/telemetry.js";import{TerminalCapability as v}from"../../../../platform/terminal/common/capabilities/capabilities.js";import{TerminalCapabilityStoreMultiplexer as Je}from"../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js";import"../../../../platform/terminal/common/environmentVariable.js";import{deserializeEnvironmentVariableCollections as ei}from"../../../../platform/terminal/common/environmentVariableShared.js";import{GeneralShellType as fe,ITerminalLogService as ii,PosixShellType as ge,ProcessPropertyType as C,ShellIntegrationStatus as ti,TerminalExitReason as M,TerminalLocation as si,TerminalSettingId as f,TitleEventSource as y}from"../../../../platform/terminal/common/terminal.js";import{formatMessageForTerminal as ee}from"../../../../platform/terminal/common/terminalStrings.js";import{editorBackground as ri}from"../../../../platform/theme/common/colorRegistry.js";import{getIconRegistry as ni}from"../../../../platform/theme/common/iconRegistry.js";import{IThemeService as oi}from"../../../../platform/theme/common/themeService.js";import{IWorkspaceContextService as _e}from"../../../../platform/workspace/common/workspace.js";import{IWorkspaceTrustRequestService as ai}from"../../../../platform/workspace/common/workspaceTrust.js";import{PANEL_BACKGROUND as li,SIDE_BAR_BACKGROUND as ci}from"../../../common/theme.js";import{IViewDescriptorService as ie,ViewContainerLocation as ve}from"../../../common/views.js";import{IViewsService as hi}from"../../../services/views/common/viewsService.js";import{AccessibilityVerbositySettingId as we}from"../../accessibility/browser/accessibilityConfiguration.js";import{ITerminalConfigurationService as ye,TerminalDataTransfers as te}from"./terminal.js";import{TerminalLaunchHelpAction as di}from"./terminalActions.js";import{TerminalEditorInput as ui}from"./terminalEditorInput.js";import{TerminalExtensionsRegistry as mi}from"./terminalExtensions.js";import{getColorClass as pi,createColorStyleElement as fi,getStandardColors as gi}from"./terminalIcon.js";import{TerminalProcessManager as _i}from"./terminalProcessManager.js";import{TerminalStatus as P,TerminalStatusList as vi}from"./terminalStatusList.js";import{getTerminalResourcesFromDragEvent as wi,getTerminalUri as yi}from"./terminalUri.js";import{TerminalWidgetManager as Ci}from"./widgets/widgetManager.js";import{LineDataEventAddon as bi}from"./xterm/lineDataEventAddon.js";import{XtermTerminal as Si,getXtermScaledDimensions as xi}from"./xterm/xtermTerminal.js";import"../common/environmentVariable.js";import{DEFAULT_COMMANDS_TO_SKIP_SHELL as Ii,ITerminalProfileResolverService as Ti,ProcessState as I,TERMINAL_CREATION_COMMANDS as Di,TERMINAL_VIEW_ID as z,TerminalCommandId as Pi}from"../common/terminal.js";import{TERMINAL_BACKGROUND_COLOR as Li}from"../common/terminalColorRegistry.js";import{TerminalContextKeys as A}from"../common/terminalContextKey.js";import{getWorkspaceForTerminal as Ei,preparePathForShell as Ri}from"../common/terminalEnvironment.js";import{IEditorService as ki}from"../../../services/editor/common/editorService.js";import{IWorkbenchEnvironmentService as Mi}from"../../../services/environment/common/environmentService.js";import{IHistoryService as Ai}from"../../../services/history/common/history.js";import{isHorizontal as Fi,IWorkbenchLayoutService as Ki}from"../../../services/layout/browser/layoutService.js";import{IPathService as Oi}from"../../../services/path/common/pathService.js";import{IPreferencesService as Wi}from"../../../services/preferences/common/preferences.js";import{importAMDNodeModule as Bi}from"../../../../amdX.js";import{AccessibilityCommandId as zi}from"../../accessibility/common/accessibilityCommands.js";import{terminalStrings as V}from"../common/terminalStrings.js";import{TerminalIconPicker as Vi}from"./terminalIconPicker.js";import{TerminalResizeDebouncer as Ni}from"./terminalResizeDebouncer.js";import{openContextMenu as Hi}from"./terminalContextMenu.js";import{IContextMenuService as qi}from"../../../../platform/contextview/browser/contextView.js";import{TerminalContribCommandId as Ui}from"../terminalContribExports.js";var Xi=(i=>(i[i.WaitForContainerThreshold=100]="WaitForContainerThreshold",i[i.DefaultCols=80]="DefaultCols",i[i.DefaultRows=30]="DefaultRows",i[i.MaxCanvasWidth=4096]="MaxCanvasWidth",i))(Xi||{});let N;const ji=[ge.Bash,ge.Zsh,fe.PowerShell,fe.Python];let g=class extends j{constructor(e,t,i,s,r,n,u,S,b,_,L,w,W,Qi,Yi,Zi,Ji,et,it,Ce,tt,st,rt,nt,ot,at,lt,ct,ht){super();this._terminalShellTypeContextKey=e;this._shellLaunchConfig=t;this._contextKeyService=i;this._contextMenuService=s;this._terminalConfigurationService=n;this._terminalProfileResolverService=u;this._pathService=S;this._keybindingService=b;this._notificationService=_;this._preferencesService=L;this._viewsService=w;this._themeService=W;this._configurationService=Qi;this._logService=Yi;this._storageService=Zi;this._accessibilityService=Ji;this._productService=et;this._quickInputService=it;this._workspaceContextService=tt;this._editorService=st;this._workspaceTrustRequestService=rt;this._historyService=nt;this._telemetryService=ot;this._openerService=at;this._commandService=lt;this._accessibilitySignalService=ct;this._viewDescriptorService=ht;if(this._wrapperElement=document.createElement("div"),this._wrapperElement.classList.add("terminal-wrapper"),this._widgetManager=this._register(r.createInstance(Ci)),this._skipTerminalCommands=[],this._isExiting=!1,this._hadFocusOnExit=!1,this._isVisible=!1,this._instanceId=g._instanceIdCounter++,this._hasHadInput=!1,this._fixedRows=t.attachPersistentProcess?.fixedDimensions?.rows,this._fixedCols=t.attachPersistentProcess?.fixedDimensions?.cols,this._resource=yi(this._workspaceContextService.getWorkspace().id,this.instanceId,this.title),this._shellLaunchConfig.attachPersistentProcess?.hideFromUser&&(this._shellLaunchConfig.hideFromUser=this._shellLaunchConfig.attachPersistentProcess.hideFromUser),this._shellLaunchConfig.attachPersistentProcess?.isFeatureTerminal&&(this._shellLaunchConfig.isFeatureTerminal=this._shellLaunchConfig.attachPersistentProcess.isFeatureTerminal),this._shellLaunchConfig.attachPersistentProcess?.type&&(this._shellLaunchConfig.type=this._shellLaunchConfig.attachPersistentProcess.type),this.shellLaunchConfig.cwd){const a=typeof this._shellLaunchConfig.cwd=="string"?k.from({scheme:Q.file,path:this._shellLaunchConfig.cwd}):this._shellLaunchConfig.cwd;a&&(this._workspaceFolder=this._workspaceContextService.getWorkspaceFolder(a)??void 0)}if(!this._workspaceFolder){const a=this._historyService.getLastActiveWorkspaceRoot();this._workspaceFolder=a?this._workspaceContextService.getWorkspaceFolder(a)??void 0:void 0}const T=this._register(i.createScoped(this._wrapperElement));this._scopedContextKeyService=T,this._scopedInstantiationService=this._register(r.createChild(new qe([de,T]))),this._terminalFocusContextKey=A.focus.bindTo(T),this._terminalHasFixedWidth=A.terminalHasFixedWidth.bindTo(T),this._terminalHasTextContextKey=A.textSelected.bindTo(T),this._terminalAltBufferActiveContextKey=A.altBufferActive.bindTo(T),this._terminalShellIntegrationEnabledContextKey=A.terminalShellIntegrationEnabled.bindTo(T),this._logService.trace(`terminalInstance#ctor (instanceId: ${this.instanceId})`,this._shellLaunchConfig),this._register(this.capabilities.onDidAddCapabilityType(a=>this._logService.debug("terminalInstance added capability",a))),this._register(this.capabilities.onDidRemoveCapabilityType(a=>this._logService.debug("terminalInstance removed capability",a))),this._register(this.capabilities.onDidAddCapabilityType(a=>{a===v.CwdDetection&&this.capabilities.get(v.CwdDetection)?.onDidChangeCwd(m=>{this._cwd=m,this._setTitle(this.title,y.Config)})})),!this.shellLaunchConfig.executable&&!Ce.remoteAuthority&&this._terminalProfileResolverService.resolveIcon(this._shellLaunchConfig,Me),this._icon=t.attachPersistentProcess?.icon||t.icon,this.shellLaunchConfig.customPtyImplementation&&this._setTitle(this._shellLaunchConfig.name,y.Api),this.statusList=this._register(this._scopedInstantiationService.createInstance(vi)),this._initDimensions(),this._processManager=this._createProcessManager(),this._containerReadyBarrier=new re(100),this._attachBarrier=new re(1e3),this._xtermReadyPromise=this._createXterm(),this._xtermReadyPromise.then(async()=>{if(await this._containerReadyBarrier.wait(),!this.shellLaunchConfig.customPtyImplementation&&this._terminalConfigurationService.config.shellIntegration?.enabled&&!this.shellLaunchConfig.executable){const a=await this._processManager.getBackendOS(),m=await this._terminalProfileResolverService.getDefaultProfile({remoteAuthority:this.remoteAuthority,os:a});this.shellLaunchConfig.executable=m.path,this.shellLaunchConfig.args=m.args,this.shellLaunchConfig.isExtensionOwnedTerminal?(this.shellLaunchConfig.icon??=m.icon,this.shellLaunchConfig.color??=m.color,this.shellLaunchConfig.env??=m.env):(this.shellLaunchConfig.icon=m.icon,this.shellLaunchConfig.color=m.color,this.shellLaunchConfig.env=m.env)}await this._createProcess(),this.shellLaunchConfig.attachPersistentProcess&&(this._cwd=this.shellLaunchConfig.attachPersistentProcess.cwd,this._setTitle(this.shellLaunchConfig.attachPersistentProcess.title,this.shellLaunchConfig.attachPersistentProcess.titleSource),this.setShellType(this.shellType)),this._fixedCols&&await this._addScrollbar()}).catch(a=>{if(!this.isDisposed)throw a}),this._register(this._configurationService.onDidChangeConfiguration(async a=>{a.affectsConfiguration(we.Terminal)&&this._setAriaLabel(this.xterm?.raw,this._instanceId,this.title),a.affectsConfiguration("terminal.integrated")&&(this.updateConfig(),this.setVisible(this._isVisible)),[f.FontSize,f.FontFamily,f.FontWeight,f.FontWeightBold,f.LetterSpacing,f.LineHeight,"editor.fontFamily"].some(E=>a.affectsConfiguration(E))&&(this._layoutSettingsChanged=!0,await this._resize()),a.affectsConfiguration(f.UnicodeVersion)&&this._updateUnicodeVersion(),a.affectsConfiguration("editor.accessibilitySupport")&&this.updateAccessibilitySupport(),(a.affectsConfiguration(f.TerminalTitle)||a.affectsConfiguration(f.TerminalTitleSeparator)||a.affectsConfiguration(f.TerminalDescription))&&this._labelComputer?.refreshLabel(this)})),this._register(this._workspaceContextService.onDidChangeWorkspaceFolders(()=>this._labelComputer?.refreshLabel(this)));let H=h.getWindow(this._container).setTimeout(()=>{H=void 0,this._initialDataEvents=void 0,this._initialDataEventsListener.clear()},1e4);this._register(G(()=>{H&&h.getWindow(this._container).clearTimeout(H)}));const be=mi.getTerminalContributions();for(const a of be){if(this._contributions.has(a.id)){oe(new Error(`Cannot have two terminal contributions with the same id ${a.id}`));continue}let m;try{m=this._register(this._scopedInstantiationService.createInstance(a.ctor,{instance:this,processManager:this._processManager,widgetManager:this._widgetManager})),this._contributions.set(a.id,m)}catch(E){oe(E)}this._xtermReadyPromise.then(E=>{E&&m.xtermReady?.(E)}),this._register(this.onDisposed(()=>{m.dispose(),this._contributions.delete(a.id),"instance"in m&&delete m.instance,"_instance"in m&&delete m._instance}))}}static _lastKnownCanvasDimensions;static _lastKnownGridDimensions;static _instanceIdCounter=1;_scopedInstantiationService;_processManager;_contributions=new Map;_resource;_xtermReadyPromise;_pressAnyKeyToCloseListener;_instanceId;_latestXtermWriteData=0;_latestXtermParseData=0;_isExiting;_hadFocusOnExit;_isVisible;_exitCode;_exitReason;_skipTerminalCommands;_shellType;_title="";_titleSource=y.Process;_container;_wrapperElement;get domElement(){return this._wrapperElement}_horizontalScrollbar;_terminalFocusContextKey;_terminalHasFixedWidth;_terminalHasTextContextKey;_terminalAltBufferActiveContextKey;_terminalShellIntegrationEnabledContextKey;_cols=0;_rows=0;_fixedCols;_fixedRows;_cwd=void 0;_initialCwd=void 0;_injectedArgs=void 0;_layoutSettingsChanged=!0;_dimensionsOverride;_areLinksReady=!1;_initialDataEventsListener=this._register(new $);_initialDataEvents=[];_containerReadyBarrier;_attachBarrier;_icon;_messageTitleDisposable=this._register(new $);_widgetManager;_dndObserver=this._register(new $);_lastLayoutDimensions;_hasHadInput;_description;_processName="";_sequence;_staticTitle;_workspaceFolder;_labelComputer;_userHome;_hasScrollBar;_usedShellIntegrationInjection=!1;get usedShellIntegrationInjection(){return this._usedShellIntegrationInjection}_lineDataEventAddon;_scopedContextKeyService;_resizeDebouncer;_pauseInputEventBarrier;pauseInputEvents(e){this._pauseInputEventBarrier=e}capabilities=this._register(new Je);statusList;get store(){return this._store}get extEnvironmentVariableCollection(){return this._processManager.extEnvironmentVariableCollection}xterm;disableLayout=!1;get waitOnExit(){return this._shellLaunchConfig.attachPersistentProcess?.waitOnExit||this._shellLaunchConfig.waitOnExit}set waitOnExit(e){this._shellLaunchConfig.waitOnExit=e}_targetRef=new ke(void 0);get targetRef(){return this._targetRef}get target(){return this._targetRef.object}set target(e){this._targetRef.object=e,this._onDidChangeTarget.fire(e)}get instanceId(){return this._instanceId}get resource(){return this._resource}get cols(){return this._fixedCols!==void 0?this._fixedCols:this._dimensionsOverride&&this._dimensionsOverride.cols?this._dimensionsOverride.forceExactSize?this._dimensionsOverride.cols:Math.min(Math.max(this._dimensionsOverride.cols,2),this._cols):this._cols}get rows(){return this._fixedRows!==void 0?this._fixedRows:this._dimensionsOverride&&this._dimensionsOverride.rows?this._dimensionsOverride.forceExactSize?this._dimensionsOverride.rows:Math.min(Math.max(this._dimensionsOverride.rows,2),this._rows):this._rows}get isDisposed(){return this._store.isDisposed}get fixedCols(){return this._fixedCols}get fixedRows(){return this._fixedRows}get maxCols(){return this._cols}get maxRows(){return this._rows}get processId(){return this._processManager.shellProcessId}get processReady(){return this._processManager.ptyProcessReady}get hasChildProcesses(){return this.shellLaunchConfig.attachPersistentProcess?.hasChildProcesses||this._processManager.hasChildProcesses}get reconnectionProperties(){return this.shellLaunchConfig.attachPersistentProcess?.reconnectionProperties||this.shellLaunchConfig.reconnectionProperties}get areLinksReady(){return this._areLinksReady}get initialDataEvents(){return this._initialDataEvents}get exitCode(){return this._exitCode}get exitReason(){return this._exitReason}get hadFocusOnExit(){return this._hadFocusOnExit}get isTitleSetByProcess(){return!!this._messageTitleDisposable.value}get shellLaunchConfig(){return this._shellLaunchConfig}get shellType(){return this._shellType}get os(){return this._processManager.os}get isRemote(){return this._processManager.remoteAuthority!==void 0}get remoteAuthority(){return this._processManager.remoteAuthority}get hasFocus(){return h.isAncestorOfActiveElement(this._wrapperElement)}get title(){return this._title}get titleSource(){return this._titleSource}get icon(){return this._getIcon()}get color(){return this._getColor()}get processName(){return this._processName}get sequence(){return this._sequence}get staticTitle(){return this._staticTitle}get workspaceFolder(){return this._workspaceFolder}get cwd(){return this._cwd}get initialCwd(){return this._initialCwd}get description(){if(this._description)return this._description;switch(this.shellLaunchConfig.attachPersistentProcess?.type||this.shellLaunchConfig.type){case"Task":return V.typeTask;case"Local":return V.typeLocal;default:return}}get userHome(){return this._userHome}get shellIntegrationNonce(){return this._processManager.shellIntegrationNonce}get injectedArgs(){return this._injectedArgs}_onExit=new l;onExit=this._onExit.event;_onDisposed=this._register(new l);onDisposed=this._onDisposed.event;_onProcessIdReady=this._register(new l);onProcessIdReady=this._onProcessIdReady.event;_onProcessReplayComplete=this._register(new l);onProcessReplayComplete=this._onProcessReplayComplete.event;_onTitleChanged=this._register(new l);onTitleChanged=this._onTitleChanged.event;_onIconChanged=this._register(new l);onIconChanged=this._onIconChanged.event;_onWillData=this._register(new l);onWillData=this._onWillData.event;_onData=this._register(new l);onData=this._onData.event;_onBinary=this._register(new l);onBinary=this._onBinary.event;_onRequestExtHostProcess=this._register(new l);onRequestExtHostProcess=this._onRequestExtHostProcess.event;_onDimensionsChanged=this._register(new l);onDimensionsChanged=this._onDimensionsChanged.event;_onMaximumDimensionsChanged=this._register(new l);onMaximumDimensionsChanged=this._onMaximumDimensionsChanged.event;_onDidFocus=this._register(new l);onDidFocus=this._onDidFocus.event;_onDidRequestFocus=this._register(new l);onDidRequestFocus=this._onDidRequestFocus.event;_onDidBlur=this._register(new l);onDidBlur=this._onDidBlur.event;_onDidInputData=this._register(new l);onDidInputData=this._onDidInputData.event;_onDidChangeSelection=this._register(new l);onDidChangeSelection=this._onDidChangeSelection.event;_onRequestAddInstanceToGroup=this._register(new l);onRequestAddInstanceToGroup=this._onRequestAddInstanceToGroup.event;_onDidChangeHasChildProcesses=this._register(new l);onDidChangeHasChildProcesses=this._onDidChangeHasChildProcesses.event;_onDidExecuteText=this._register(new l);onDidExecuteText=this._onDidExecuteText.event;_onDidChangeTarget=this._register(new l);onDidChangeTarget=this._onDidChangeTarget.event;_onDidSendText=this._register(new l);onDidSendText=this._onDidSendText.event;_onDidChangeShellType=this._register(new l);onDidChangeShellType=this._onDidChangeShellType.event;_onDidChangeVisibility=this._register(new l);onDidChangeVisibility=this._onDidChangeVisibility.event;_onLineData=this._register(new l({onDidAddFirstListener:async()=>(this.xterm??await this._xtermReadyPromise)?.raw.loadAddon(this._lineDataEventAddon)}));onLineData=this._onLineData.event;getContribution(e){return this._contributions.get(e)}_getIcon(){return this._icon||(this._icon=this._processManager.processState>=I.Launching?ni().getIcon(this._configurationService.getValue(f.TabsDefaultIcon)):void 0),this._icon}_getColor(){if(this.shellLaunchConfig.color)return this.shellLaunchConfig.color;if(this.shellLaunchConfig?.attachPersistentProcess?.color)return this.shellLaunchConfig.attachPersistentProcess.color;this._processManager.processState>=I.Launching}_initDimensions(){if(!this._container){this._cols=80,this._rows=30;return}const e=h.getWindow(this._container).getComputedStyle(this._container),t=parseInt(e.width),i=parseInt(e.height);this._evaluateColsAndRows(t,i)}_evaluateColsAndRows(e,t){if(!e||!t)return this._setLastKnownColsAndRows(),null;const i=this._getDimension(e,t);if(!i)return this._setLastKnownColsAndRows(),null;const s=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement)),r=xi(h.getWindow(this.domElement),s,i.width,i.height);return r?((this._cols!==r.cols||this._rows!==r.rows)&&(this._cols=r.cols,this._rows=r.rows,this._fireMaximumDimensionsChanged()),i.width):(this._setLastKnownColsAndRows(),null)}_setLastKnownColsAndRows(){g._lastKnownGridDimensions&&(this._cols=g._lastKnownGridDimensions.cols,this._rows=g._lastKnownGridDimensions.rows)}_fireMaximumDimensionsChanged(){this._onMaximumDimensionsChanged.fire()}_getDimension(e,t){const i=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement));if(!i||!i.charWidth||!i.charHeight||!this.xterm?.raw.element)return;const s=h.getWindow(this.xterm.raw.element).getComputedStyle(this.xterm.raw.element),r=parseInt(s.paddingLeft)+parseInt(s.paddingRight)+14,n=parseInt(s.paddingTop)+parseInt(s.paddingBottom);return g._lastKnownCanvasDimensions=new h.Dimension(Math.min(4096,e-r),t-n+(this._hasScrollBar&&this._horizontalScrollbar?-5:0)),g._lastKnownCanvasDimensions}get persistentProcessId(){return this._processManager.persistentProcessId}get shouldPersist(){return this._processManager.shouldPersist&&!this.shellLaunchConfig.isTransient&&(!this.reconnectionProperties||this._configurationService.getValue("task.reconnection")===!0)}static getXtermConstructor(e,t){const i=e.lookupKeybinding(Ui.A11yFocusAccessibleBuffer,t);return N||(N=Pe.withAsyncBody(async s=>{const r=(await Bi("@xterm/xterm","lib/xterm.js")).Terminal;r.strings.promptLabel=c.localize("terminal.integrated.a11yPromptLabel","Terminal input"),r.strings.tooMuchOutput=i?c.localize("terminal.integrated.useAccessibleBuffer","Use the accessible buffer {0} to manually review output",i.getLabel()):c.localize("terminal.integrated.useAccessibleBufferNoKb","Use the Terminal: Focus Accessible Buffer command to manually review output"),s(r)}),N)}async _createXterm(){const e=await g.getXtermConstructor(this._keybindingService,this._contextKeyService);if(this.isDisposed)return;const t=this.shellLaunchConfig.executable===void 0||this.shellType===void 0||!ji.includes(this.shellType),i=this._scopedInstantiationService.createInstance(Si,e,{cols:this._cols,rows:this._rows,xtermColorProvider:this._scopedInstantiationService.createInstance(O,this._targetRef),capabilities:this.capabilities,shellIntegrationNonce:this._processManager.shellIntegrationNonce,disableShellIntegrationReporting:t});this.xterm=i,this._resizeDebouncer=this._register(new Ni(()=>this._isVisible,()=>i,async(n,u)=>{i.raw.resize(n,u),await this._updatePtyDimensions(i.raw)},async n=>{i.raw.resize(n,i.raw.rows),await this._updatePtyDimensions(i.raw)},async n=>{i.raw.resize(i.raw.cols,n),await this._updatePtyDimensions(i.raw)})),this._register(G(()=>this._resizeDebouncer=void 0)),this.updateAccessibilitySupport(),this._register(this.xterm.onDidRequestRunCommand(n=>{this.sendText(n.command.command,!n.noNewLine)})),this._register(this.xterm.onDidRequestRefreshDimensions(()=>{this._lastLayoutDimensions&&this.layout(this._lastLayoutDimensions)}));const s=this._shellLaunchConfig.initialText?new Promise(n=>this._writeInitialText(i,n)):void 0,r=this._register(new bi(s));if(this._register(r.onLineData(n=>this._onLineData.fire(n))),this._lineDataEventAddon=r,Le(()=>{this._register(i.raw.onBell(()=>{(this._configurationService.getValue(f.EnableBell)||this._configurationService.getValue(f.EnableVisualBell))&&this.statusList.add({id:P.Bell,severity:D.Warning,icon:B.bell,tooltip:c.localize("bellStatus","Bell")},this._terminalConfigurationService.config.bellDuration),this._accessibilitySignalService.playSignal(Oe.terminalBell)}))},1e3,this._store),this._register(i.raw.onSelectionChange(()=>this._onDidChangeSelection.fire(this))),this._register(i.raw.buffer.onBufferChange(()=>this._refreshAltBufferContextKey())),this._register(this._processManager.onProcessData(n=>this._onProcessData(n))),this._register(i.raw.onData(async n=>{await this._pauseInputEventBarrier?.wait(),await this._processManager.write(n),this._onDidInputData.fire(n)})),this._register(i.raw.onBinary(n=>this._processManager.processBinary(n))),this._register(this._processManager.onProcessReady(async n=>{this._processManager.os&&r.setOperatingSystem(this._processManager.os),i.raw.options.windowsPty=n.windowsPty})),this._register(this._processManager.onRestoreCommands(n=>this.xterm?.shellIntegration.deserialize(n))),this._register(this._viewDescriptorService.onDidChangeLocation(({views:n})=>{n.some(u=>u.id===z)&&i.refresh()})),!this.capabilities.has(v.CwdDetection)){let n=i.raw.onKey(u=>{new se(u.domEvent).equals(Ee.Enter)&&this._updateProcessCwd()});this._register(this.capabilities.onDidAddCapabilityType(u=>{u===v.CwdDetection&&(n?.dispose(),n=void 0)}))}return this._pathService.userHome().then(n=>{this._userHome=n.fsPath}),this._isVisible&&this._open(),i}async runCommand(e,t){let i=this.capabilities.get(v.CommandDetection);if(!i&&(this._processManager.processState===I.Uninitialized||this._processManager.processState===I.Launching)){const s=new ae;await Promise.race([new Promise(r=>{s.add(this.capabilities.onDidAddCapabilityType(n=>{n===v.CommandDetection&&(i=this.capabilities.get(v.CommandDetection),r())}))}),ne(2e3)]),s.dispose()}(!i||i.promptInputModel.value.length>0)&&(await this.sendText("",!1),await ne(100)),await this.sendText(e,t,!t)}detachFromElement(){this._wrapperElement.remove(),this._container=void 0}attachToElement(e){this._container!==e&&(this._attachBarrier.isOpen()||this._attachBarrier.open(),this._container=e,this._container.appendChild(this._wrapperElement),this.xterm?.raw.element&&this.xterm.raw.open(this.xterm.raw.element),this.xterm?.refresh(),setTimeout(()=>{this._store.isDisposed||this._initDragAndDrop(e)},0))}_open(){if(!this.xterm||this.xterm.raw.element)return;if(!this._container||!this._container.isConnected)throw new Error("A container element needs to be set with `attachToElement` and be part of the DOM before calling `_open`");const e=document.createElement("div");this._wrapperElement.appendChild(e),this._container.appendChild(this._wrapperElement);const t=this.xterm;this._wrapperElement.xterm=t.raw;const i=t.attachToElement(e);for(const s of this._contributions.values())this.xterm?s.xtermOpen?.(this.xterm):this._xtermReadyPromise.then(r=>{r&&s.xtermOpen?.(r)});if(this._register(t.shellIntegration.onDidChangeStatus(()=>{this.hasFocus?this._setShellIntegrationContextKey():this._terminalShellIntegrationEnabledContextKey.reset()})),!t.raw.element||!t.raw.textarea)throw new Error("xterm elements not set after open");this._setAriaLabel(t.raw,this._instanceId,this._title),t.raw.attachCustomKeyEventHandler(s=>{if(this._isExiting)return!1;const r=new se(s),n=this._keybindingService.softDispatch(r,r.target),u=n.kind===pe.MoreChordsNeeded&&this._terminalConfigurationService.config.allowChords&&s.key!=="Escape";if(this._keybindingService.inChordMode||u)return s.preventDefault(),!1;const S="terminal.integrated.showTerminalConfigPrompt",b=["RightArrow","LeftArrow","UpArrow","DownArrow","Space","Meta","Control","Shift","Alt","","Delete","Backspace","Tab"];return this._storageService.getBoolean(S,J.APPLICATION,!0)&&!b.includes(s.key)&&!s.ctrlKey&&!s.shiftKey&&!s.altKey&&(this._hasHadInput=!0),n.kind===pe.KbFound&&n.commandId&&this._skipTerminalCommands.some(_=>_===n.commandId)&&!this._terminalConfigurationService.config.sendKeybindingsToShell?(this._storageService.getBoolean(S,J.APPLICATION,!0)&&this._hasHadInput&&!Di.includes(n.commandId)&&(this._notificationService.prompt(D.Info,c.localize("keybindingHandling","Some keybindings don't go to the terminal by default and are handled by {0} instead.",this._productService.nameLong),[{label:c.localize("configureTerminalSettings","Configure Terminal Settings"),run:()=>{this._preferencesService.openSettings({jsonEditor:!1,query:`@id:${f.CommandsToSkipShell},${f.SendKeybindingsToShell},${f.AllowChords}`})}}]),this._storageService.store(S,!1,J.APPLICATION,Ye.USER)),s.preventDefault(),!1):this._terminalConfigurationService.config.allowMnemonics&&!Ae&&s.altKey||Fe.getTabFocusMode()&&s.key==="Tab"?!1:s.key==="Tab"&&s.shiftKey?(s.preventDefault(),!0):!(ce&&s.altKey&&s.key==="F4"&&!s.ctrlKey||!Te.clipboard.readText&&s.key==="v"&&s.ctrlKey)}),this._register(h.addDisposableListener(t.raw.element,"mousedown",()=>{const s=h.addDisposableListener(t.raw.element.ownerDocument,"mouseup",()=>{setTimeout(()=>this._refreshSelectionContextKey(),0),s.dispose()})})),this._register(h.addDisposableListener(t.raw.element,"touchstart",()=>{t.raw.focus()})),this._register(h.addDisposableListener(t.raw.element,"keyup",()=>{setTimeout(()=>this._refreshSelectionContextKey(),0)})),this._register(h.addDisposableListener(t.raw.textarea,"focus",()=>this._setFocus(!0))),this._register(h.addDisposableListener(t.raw.textarea,"blur",()=>this._setFocus(!1))),this._register(h.addDisposableListener(t.raw.textarea,"focusout",()=>this._setFocus(!1))),this._initDragAndDrop(this._container),this._widgetManager.attachToElement(i),this._lastLayoutDimensions&&this.layout(this._lastLayoutDimensions),this.updateConfig(),t.raw.options.disableStdin&&this._attachPressAnyKeyToCloseListener(t.raw)}_setFocus(e){e?(this._terminalFocusContextKey.set(!0),this._setShellIntegrationContextKey(),this._onDidFocus.fire(this)):(this.resetFocusContextKey(),this._onDidBlur.fire(this),this._refreshSelectionContextKey())}_setShellIntegrationContextKey(){this.xterm&&this._terminalShellIntegrationEnabledContextKey.set(this.xterm.shellIntegration.status===ti.VSCode)}resetFocusContextKey(){this._terminalFocusContextKey.reset(),this._terminalShellIntegrationEnabledContextKey.reset()}_initDragAndDrop(e){const t=new ae,i=t.add(this._scopedInstantiationService.createInstance(F,e));t.add(i.onDropTerminal(s=>this._onRequestAddInstanceToGroup.fire(s))),t.add(i.onDropFile(async s=>{this.focus(),await this.sendPath(s,!1)})),t.add(new h.DragAndDropObserver(e,i)),this._dndObserver.value=t}hasSelection(){return this.xterm?this.xterm.raw.hasSelection():!1}get selection(){return this.xterm&&this.hasSelection()?this.xterm.raw.getSelection():void 0}clearSelection(){this.xterm?.raw.clearSelection()}_refreshAltBufferContextKey(){this._terminalAltBufferActiveContextKey.set(!!(this.xterm&&this.xterm.raw.buffer.active===this.xterm.raw.buffer.alternate))}dispose(e){if(!(this.shellLaunchConfig.type==="Task"&&e===M.Process&&this._exitCode!==0&&!this.shellLaunchConfig.waitOnExit)&&!this.isDisposed){this._logService.trace(`terminalInstance#dispose (instanceId: ${this.instanceId})`),le(this._widgetManager),this.xterm?.raw.element&&(this._hadFocusOnExit=this.hasFocus),this._wrapperElement.xterm&&(this._wrapperElement.xterm=void 0),this._horizontalScrollbar&&(this._horizontalScrollbar.dispose(),this._horizontalScrollbar=void 0);try{this.xterm?.dispose()}catch(t){this._logService.error("Exception occurred during xterm disposal",t)}Ie&&(this.resetFocusContextKey(),this._terminalHasTextContextKey.reset(),this._onDidBlur.fire(this)),this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener.dispose(),this._pressAnyKeyToCloseListener=void 0),this._exitReason===void 0&&(this._exitReason=e??M.Unknown),this._processManager.dispose(),this._onProcessExit(void 0),this._onDisposed.fire(this),super.dispose()}}async detachProcessAndDispose(e){await this._processManager.detachFromProcess(e===M.User),this.dispose(e)}focus(e){this._refreshAltBufferContextKey(),this.xterm&&(e||!h.getActiveWindow().getSelection()?.toString())&&(this.xterm.raw.focus(),this._onDidRequestFocus.fire())}async focusWhenReady(e){await this._xtermReadyPromise,await this._attachBarrier.wait(),this.focus(e)}async sendText(e,t,i){i&&this.xterm?.raw.modes.bracketedPasteMode&&(e=`\x1B[200~${e}\x1B[201~`),e=e.replace(/\r?\n/g,"\r"),t&&!e.endsWith("\r")&&(e+="\r"),this._logService.debug("sending data (vscode)",e),await this._processManager.write(e),this._onDidInputData.fire(e),this._onDidSendText.fire(e),this.xterm?.scrollToBottom(),t&&this._onDidExecuteText.fire()}async sendPath(e,t){return this.sendText(await this.preparePathForShell(e),t)}async preparePathForShell(e){return await this.processReady,Ri(e,this.shellLaunchConfig.executable,this.title,this.shellType,this._processManager.backend,this._processManager.os)}setVisible(e){const t=this._isVisible!==e;this._isVisible=e,this._wrapperElement.classList.toggle("active",e),e&&this.xterm&&(this._open(),this._resizeDebouncer?.flush(),this._resize()),t&&this._onDidChangeVisibility.fire(e)}scrollDownLine(){this.xterm?.scrollDownLine()}scrollDownPage(){this.xterm?.scrollDownPage()}scrollToBottom(){this.xterm?.scrollToBottom()}scrollUpLine(){this.xterm?.scrollUpLine()}scrollUpPage(){this.xterm?.scrollUpPage()}scrollToTop(){this.xterm?.scrollToTop()}clearBuffer(){this._processManager.clearBuffer(),this.xterm?.clearBuffer()}_refreshSelectionContextKey(){const e=!!this._viewsService.getActiveViewWithId(z);let t=!1;const i=this._editorService.activeEditor;i&&(t=i instanceof ui),this._terminalHasTextContextKey.set((e||t)&&this.hasSelection())}_createProcessManager(){let e;this.shellLaunchConfig.attachPersistentProcess?.environmentVariableCollections&&(e=ei(this.shellLaunchConfig.attachPersistentProcess.environmentVariableCollections));const t=this._scopedInstantiationService.createInstance(_i,this._instanceId,this.shellLaunchConfig?.cwd,e,this.shellLaunchConfig.attachPersistentProcess?.shellIntegrationNonce);return this.capabilities.add(t.capabilities),this._register(t.onProcessReady(async i=>{this._onProcessIdReady.fire(this),this._initialCwd=await this.getInitialCwd(),this._labelComputer||(this._labelComputer=this._register(this._scopedInstantiationService.createInstance(K)),this._register(this._labelComputer.onDidChangeLabel(s=>{(this._title!==s.title||this._description!==s.description)&&(this._title=s.title,this._description=s.description,this._onTitleChanged.fire(this))}))),this._shellLaunchConfig.name?this._setTitle(this._shellLaunchConfig.name,y.Api):(setTimeout(()=>{this._xtermReadyPromise.then(s=>{s&&(this._messageTitleDisposable.value=s.raw.onTitleChange(r=>this._onTitleChange(r)))})}),this._setTitle(this._shellLaunchConfig.executable,y.Process))})),this._register(t.onProcessExit(i=>this._onProcessExit(i))),this._register(t.onDidChangeProperty(({type:i,value:s})=>{switch(i){case C.Cwd:this._cwd=s,this._labelComputer?.refreshLabel(this);break;case C.InitialCwd:this._initialCwd=s,this._cwd=this._initialCwd,this._setTitle(this.title,y.Config),this._icon=this._shellLaunchConfig.attachPersistentProcess?.icon||this._shellLaunchConfig.icon,this._onIconChanged.fire({instance:this,userInitiated:!1});break;case C.Title:this._setTitle(s??"",y.Process);break;case C.OverrideDimensions:this.setOverrideDimensions(s,!0);break;case C.ResolvedShellLaunchConfig:this._setResolvedShellLaunchConfig(s);break;case C.ShellType:this.setShellType(s);break;case C.HasChildProcesses:this._onDidChangeHasChildProcesses.fire(s);break;case C.UsedShellIntegrationInjection:this._usedShellIntegrationInjection=!0;break}})),this._initialDataEventsListener.value=t.onProcessData(i=>this._initialDataEvents?.push(i.data)),this._register(t.onProcessReplayComplete(()=>this._onProcessReplayComplete.fire())),this._register(t.onEnvironmentVariableInfoChanged(i=>this._onEnvironmentVariableInfoChanged(i))),this._register(t.onPtyDisconnect(()=>{this.xterm&&(this.xterm.raw.options.disableStdin=!0),this.statusList.add({id:P.Disconnected,severity:D.Error,icon:B.debugDisconnect,tooltip:c.localize("disconnectStatus","Lost connection to process")})})),this._register(t.onPtyReconnect(()=>{this.xterm&&(this.xterm.raw.options.disableStdin=!1),this.statusList.remove(P.Disconnected)})),t}async _createProcess(){if(this.isDisposed)return;this._historyService.getLastActiveWorkspaceRoot(Q.file)?await this._trust()||this._onProcessExit({message:c.localize("workspaceNotTrustedCreateTerminal","Cannot launch a terminal process in an untrusted workspace")}):this._cwd&&this._userHome&&this._cwd!==this._userHome&&this._onProcessExit({message:c.localize("workspaceNotTrustedCreateTerminalCwd","Cannot launch a terminal process in an untrusted workspace with cwd {0} and userHome {1}",this._cwd,this._userHome)}),this._container&&this._cols===0&&this._rows===0&&(this._initDimensions(),this.xterm?.raw.resize(this._cols||80,this._rows||30));const t=this.shellLaunchConfig.icon;await this._processManager.createProcess(this._shellLaunchConfig,this._cols||80,this._rows||30).then(i=>{i&&("message"in i?this._onProcessExit(i):"injectedArgs"in i&&(this._injectedArgs=i.injectedArgs))}),!this.isDisposed&&(this.xterm?.shellIntegration&&this.capabilities.add(this.xterm.shellIntegration.capabilities),(t!==this.shellLaunchConfig.icon||this.shellLaunchConfig.color)&&(this._icon=this._shellLaunchConfig.attachPersistentProcess?.icon||this._shellLaunchConfig.icon,this._onIconChanged.fire({instance:this,userInitiated:!1})))}registerMarker(e){return this.xterm?.raw.registerMarker(e)}addBufferMarker(e){this.capabilities.get(v.BufferMarkDetection)?.addMark(e)}scrollToMark(e,t,i){this.xterm?.markTracker.scrollToClosestMarker(e,t,i)}async freePortKillProcess(e,t){await this._processManager?.freePortKillProcess(e),this.runCommand(t,!1)}_onProcessData(e){const t=e.data.indexOf("\x1B]633;C\x07");t!==-1?e.trackCommit?(this._writeProcessData(e.data.substring(0,t+8)),e.writePromise=new Promise(i=>this._writeProcessData(e.data.substring(t+8),i))):(this._writeProcessData(e.data.substring(0,t+8)),this._writeProcessData(e.data.substring(t+8))):e.trackCommit?e.writePromise=new Promise(i=>this._writeProcessData(e.data,i)):this._writeProcessData(e.data)}_writeProcessData(e,t){this._onWillData.fire(e);const i=++this._latestXtermWriteData;this.xterm?.raw.write(e,()=>{this._latestXtermParseData=i,this._processManager.acknowledgeDataEvent(e.length),t?.(),this._onData.fire(e)})}async _onProcessExit(e){if(this._isExiting)return;const t=Gi(e,this.shellLaunchConfig,this._processManager.processState,this._initialCwd);if(this._usedShellIntegrationInjection&&this._processManager.processState===I.KilledDuringLaunch&&t?.code!==0){this._relaunchWithShellIntegrationDisabled(t?.message),this._onExit.fire(e);return}this._isExiting=!0,await this._flushXtermData(),this._exitCode=t?.code;const i=t?.message;this._logService.debug("Terminal process exit","instanceId",this.instanceId,"code",this._exitCode,"processState",this._processManager.processState);const s=this.waitOnExit;s&&this._processManager.processState!==I.KilledByUser?this._xtermReadyPromise.then(r=>{if(r){switch(i&&r.raw.write(ee(i)),typeof s){case"string":r.raw.write(ee(s,{excludeLeadingNewLine:!0}));break;case"function":this.exitCode!==void 0&&r.raw.write(ee(s(this.exitCode),{excludeLeadingNewLine:!0}));break}r.raw.options.disableStdin=!0,r.raw.textarea&&this._attachPressAnyKeyToCloseListener(r.raw)}}):(i&&(this._processManager.processState===I.KilledDuringLaunch||this._terminalConfigurationService.config.showExitAlert?this._notificationService.notify({message:i,severity:D.Error,actions:{primary:[this._scopedInstantiationService.createInstance(di)]}}):this._logService.warn(i)),this.dispose(M.Process)),this._onExit.fire(e),this.isDisposed&&this._onExit.dispose()}_relaunchWithShellIntegrationDisabled(e){this._shellLaunchConfig.ignoreShellIntegration=!0,this.relaunch(),this.statusList.add({id:P.ShellIntegrationAttentionNeeded,severity:D.Warning,icon:B.warning,tooltip:`${e} `+c.localize("launchFailed.exitCodeOnlyShellIntegration","Disabling shell integration in user settings might help."),hoverActions:[{commandId:Pi.ShellIntegrationLearnMore,label:c.localize("shellIntegration.learnMore","Learn more about shell integration"),run:()=>{this._openerService.open("https://code.visualstudio.com/docs/editor/integrated-terminal#_shell-integration")}},{commandId:"workbench.action.openSettings",label:c.localize("shellIntegration.openSettings","Open user settings"),run:()=>{this._commandService.executeCommand("workbench.action.openSettings","terminal.integrated.shellIntegration.enabled")}}]}),this._telemetryService.publicLog2("terminal/shellIntegrationFailureProcessExit")}_flushXtermData(){if(this._latestXtermWriteData===this._latestXtermParseData)return Promise.resolve();let e=0;return new Promise(t=>{const i=h.disposableWindowInterval(h.getActiveWindow().window,()=>{(this._latestXtermWriteData===this._latestXtermParseData||++e===5)&&(i.dispose(),t())},20)})}_attachPressAnyKeyToCloseListener(e){e.textarea&&!this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener=h.addDisposableListener(e.textarea,"keypress",t=>{this._pressAnyKeyToCloseListener&&(this._pressAnyKeyToCloseListener.dispose(),this._pressAnyKeyToCloseListener=void 0,this.dispose(M.Process),t.preventDefault())}))}_writeInitialText(e,t){if(!this._shellLaunchConfig.initialText){t?.();return}const i=typeof this._shellLaunchConfig.initialText=="string"?this._shellLaunchConfig.initialText:this._shellLaunchConfig.initialText?.text;typeof this._shellLaunchConfig.initialText=="string"||this._shellLaunchConfig.initialText.trailingNewLine?e.raw.writeln(i,t):e.raw.write(i,t)}async reuseTerminal(e,t=!1){this._pressAnyKeyToCloseListener?.dispose(),this._pressAnyKeyToCloseListener=void 0;const i=this.xterm;i&&(t||await new Promise(s=>i.raw.write(`
\x1B[G`,s)),e.initialText&&(this._shellLaunchConfig.initialText=e.initialText,await new Promise(s=>this._writeInitialText(i,s))),this._isExiting&&this._shellLaunchConfig.waitOnExit&&(i.raw.options.disableStdin=!1,this._isExiting=!1),t&&i.clearDecorations()),this.statusList.remove(P.RelaunchNeeded),t||(e.initialText=" "),this._shellLaunchConfig=e,await this._processManager.relaunch(this._shellLaunchConfig,this._cols||80,this._rows||30,t).then(s=>{s&&("message"in s?this._onProcessExit(s):"injectedArgs"in s&&(this._injectedArgs=s.injectedArgs))})}relaunch(){this.reuseTerminal(this._shellLaunchConfig,!0)}_onTitleChange(e){this.isTitleSetByProcess&&this._setTitle(e,y.Sequence)}async _trust(){return await this._workspaceTrustRequestService.requestWorkspaceTrust({message:c.localize("terminal.requestTrust","Creating a terminal process requires executing code")})===!0}async _updateProcessCwd(){if(!(this.isDisposed||this.shellLaunchConfig.customPtyImplementation))try{const e=await this._refreshProperty(C.Cwd);if(typeof e!="string")throw new Error(`cwd is not a string ${e}`)}catch(e){if(e instanceof Error&&e.message==="Cannot refresh property when process is not set")return;throw e}}updateConfig(){this._setCommandsToSkipShell(this._terminalConfigurationService.config.commandsToSkipShell),this._refreshEnvironmentVariableInfoWidgetState(this._processManager.environmentVariableInfo)}async _updateUnicodeVersion(){this._processManager.setUnicodeVersion(this._terminalConfigurationService.config.unicodeVersion)}updateAccessibilitySupport(){this.xterm.raw.options.screenReaderMode=this._accessibilityService.isScreenReaderOptimized()}_setCommandsToSkipShell(e){const t=e.filter(i=>i[0]==="-").map(i=>i.slice(1));this._skipTerminalCommands=Ii.filter(i=>!t.includes(i)).concat(e)}layout(e){if(this._lastLayoutDimensions=e,!(this.disableLayout||e.width<=0||e.height<=0||!this._evaluateColsAndRows(e.width,e.height))){this._resize(),this._containerReadyBarrier.isOpen()||this._containerReadyBarrier.open();for(const i of this._contributions.values())this.xterm?i.layout?.(this.xterm,e):this._xtermReadyPromise.then(s=>{s&&i.layout?.(s,e)})}}async _resize(e){if(!this.xterm)return;let t=this.cols,i=this.rows;if(this._isVisible&&this._layoutSettingsChanged){const s=this.xterm.getFont(),r=this._terminalConfigurationService.config;this.xterm.raw.options.letterSpacing=s.letterSpacing,this.xterm.raw.options.lineHeight=s.lineHeight,this.xterm.raw.options.fontSize=s.fontSize,this.xterm.raw.options.fontFamily=s.fontFamily,this.xterm.raw.options.fontWeight=r.fontWeight,this.xterm.raw.options.fontWeightBold=r.fontWeightBold,this._initDimensions(),t=this.cols,i=this.rows,this._layoutSettingsChanged=!1}isNaN(t)||isNaN(i)||((t!==this.xterm.raw.cols||i!==this.xterm.raw.rows)&&((this._fixedRows||this._fixedCols)&&await this._updateProperty(C.FixedDimensions,{cols:this._fixedCols,rows:this._fixedRows}),this._onDimensionsChanged.fire()),g._lastKnownGridDimensions={cols:t,rows:i},this._resizeDebouncer.resize(t,i,e??!1))}async _updatePtyDimensions(e){await this._processManager.setDimensions(e.cols,e.rows)}setShellType(e){this._shellType!==e&&e&&(this._shellType=e,this._terminalShellTypeContextKey.set(e?.toString()),this._onDidChangeShellType.fire(e))}_setAriaLabel(e,t,i){const s=[];if(e&&e.textarea){i&&i.length>0?s.push(c.localize("terminalTextBoxAriaLabelNumberAndTitle","Terminal {0}, {1}",t,i)):s.push(c.localize("terminalTextBoxAriaLabel","Terminal {0}",t)),this._accessibilityService.isScreenReaderOptimized()||s.push(c.localize("terminalScreenReaderMode","Run the command: Toggle Screen Reader Accessibility Mode for an optimized screen reader experience"));const n=this._keybindingService.lookupKeybinding(zi.OpenAccessibilityHelp)?.getLabel();this._configurationService.getValue(we.Terminal)&&n&&s.push(c.localize("terminalHelpAriaLabel","Use {0} for terminal accessibility help",n)),e.textarea.setAttribute("aria-label",s.join(`
`))}}_updateTitleProperties(e,t){if(!e)return this._processName;switch(t){case y.Process:if(this._processManager.os===Y.Windows)e=R.win32.parse(e).name;else{const i=e.indexOf(" ");e.startsWith("/")?e=R.basename(e):i>-1&&(e=e.substring(0,i))}this._processName=e;break;case y.Api:this._staticTitle=e,this._messageTitleDisposable.value=void 0;break;case y.Sequence:this._sequence=e,this._processManager.os===Y.Windows&&e.match(/^[a-zA-Z]:\\.+\.[a-zA-Z]{1,3}/)&&(this._sequence=R.win32.parse(e).name);break}return this._titleSource=t,e}setOverrideDimensions(e,t=!1){this._dimensionsOverride&&this._dimensionsOverride.forceExactSize&&!e&&this._rows===0&&this._cols===0&&(this._cols=this._dimensionsOverride.cols,this._rows=this._dimensionsOverride.rows),this._dimensionsOverride=e,t?this._resize(!0):this._resize()}async setFixedDimensions(){const e=await this._quickInputService.input({title:c.localize("setTerminalDimensionsColumn","Set Fixed Dimensions: Column"),placeHolder:"Enter a number of columns or leave empty for automatic width",validateInput:async i=>i.length>0&&!i.match(/^\d+$/)?{content:"Enter a number or leave empty size automatically",severity:D.Error}:void 0});if(e===void 0)return;this._fixedCols=this._parseFixedDimension(e),this._labelComputer?.refreshLabel(this),this._terminalHasFixedWidth.set(!!this._fixedCols);const t=await this._quickInputService.input({title:c.localize("setTerminalDimensionsRow","Set Fixed Dimensions: Row"),placeHolder:"Enter a number of rows or leave empty for automatic height",validateInput:async i=>i.length>0&&!i.match(/^\d+$/)?{content:"Enter a number or leave empty size automatically",severity:D.Error}:void 0});t!==void 0&&(this._fixedRows=this._parseFixedDimension(t),this._labelComputer?.refreshLabel(this),await this._refreshScrollbar(),this._resize(),this.focus())}_parseFixedDimension(e){if(e==="")return;const t=parseInt(e);if(t<=0)throw new Error(`Could not parse dimension "${e}"`);return t}async toggleSizeToContentWidth(){if(this.xterm?.raw.buffer.active){if(this._hasScrollBar)this._terminalHasFixedWidth.set(!1),this._fixedCols=void 0,this._fixedRows=void 0,this._hasScrollBar=!1,this._initDimensions(),await this._resize();else{const e=this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement)),t=Math.floor(4096/(e.charWidth??20)),i=Math.max(this.maxCols,Math.min(this.xterm.getLongestViewportWrappedLineLength(),t));i>this.xterm.raw.cols&&(this._fixedCols=i)}await this._refreshScrollbar(),this._labelComputer?.refreshLabel(this),this.focus()}}_refreshScrollbar(){return this._fixedCols||this._fixedRows?this._addScrollbar():this._removeScrollbar()}async _addScrollbar(){const e=(this.xterm?this.xterm.getFont():this._terminalConfigurationService.getFont(h.getWindow(this.domElement))).charWidth;if(!(!this.xterm?.raw.element||!this._container||!e||!this._fixedCols)&&(this._wrapperElement.classList.add("fixed-dims"),this._hasScrollBar=!0,this._initDimensions(),await this._resize(),this._terminalHasFixedWidth.set(!0),this._horizontalScrollbar||(this._horizontalScrollbar=this._register(new De(this._wrapperElement,{vertical:he.Hidden,horizontal:he.Auto,useShadows:!1,scrollYToX:!1,consumeMouseWheelIfScrollbarIsNeeded:!1})),this._container.appendChild(this._horizontalScrollbar.getDomNode())),this._horizontalScrollbar.setScrollDimensions({width:this.xterm.raw.element.clientWidth,scrollWidth:this._fixedCols*e+40}),this._horizontalScrollbar.getDomNode().style.paddingBottom="16px",ce))for(let t=this.xterm.raw.buffer.active.viewportY;t<this.xterm.raw.buffer.active.length;t++){const i=this.xterm.raw.buffer.active.getLine(t);i._line.isWrapped=!1}}async _removeScrollbar(){!this._container||!this._horizontalScrollbar||(this._horizontalScrollbar.getDomNode().remove(),this._horizontalScrollbar.dispose(),this._horizontalScrollbar=void 0,this._wrapperElement.remove(),this._wrapperElement.classList.remove("fixed-dims"),this._container.appendChild(this._wrapperElement))}_setResolvedShellLaunchConfig(e){this._shellLaunchConfig.args=e.args,this._shellLaunchConfig.cwd=e.cwd,this._shellLaunchConfig.executable=e.executable,this._shellLaunchConfig.env=e.env}_onEnvironmentVariableInfoChanged(e){e.requiresAction&&this.xterm?.raw.textarea?.setAttribute("aria-label",c.localize("terminalStaleTextBoxAriaLabel","Terminal {0} environment is stale, run the 'Show Environment Information' command for more information",this._instanceId)),this._refreshEnvironmentVariableInfoWidgetState(e)}async _refreshEnvironmentVariableInfoWidgetState(e){if(!e){this.statusList.remove(P.RelaunchNeeded),this.statusList.remove(P.EnvironmentVariableInfoChangesActive);return}if(e.requiresAction&&this._terminalConfigurationService.config.environmentChangesRelaunch&&!this._processManager.hasWrittenData&&(!this._shellLaunchConfig.isFeatureTerminal||this.reconnectionProperties&&this._configurationService.getValue("task.reconnection")===!0)&&!this._shellLaunchConfig.customPtyImplementation&&!this._shellLaunchConfig.isExtensionOwnedTerminal&&!this._shellLaunchConfig.attachPersistentProcess&&!(this._processManager.remoteAuthority&&this._terminalConfigurationService.config.windowsEnableConpty&&await this._processManager.getBackendOS()===Y.Windows)){this.relaunch();return}const t=Ei(this.shellLaunchConfig.cwd,this._workspaceContextService,this._historyService);this.statusList.add(e.getStatus({workspaceFolder:t}))}async getInitialCwd(){return this._initialCwd||(this._initialCwd=this._processManager.initialCwd),this._initialCwd}async getCwd(){return this.capabilities.has(v.CwdDetection)?this.capabilities.get(v.CwdDetection).getCwd():this.capabilities.has(v.NaiveCwdDetection)?this.capabilities.get(v.NaiveCwdDetection).getCwd():this._processManager.initialCwd}async _refreshProperty(e){return await this.processReady,this._processManager.refreshProperty(e)}async _updateProperty(e,t){return this._processManager.updateProperty(e,t)}async rename(e){this._setTitle(e,y.Api)}_setTitle(e,t){const i=!e;e=this._updateTitleProperties(e,t);const s=e!==this._title;this._title=e,this._labelComputer?.refreshLabel(this,i),this._setAriaLabel(this.xterm?.raw,this._instanceId,this._title),s&&this._onTitleChanged.fire(this)}async changeIcon(e){if(e)return this._icon=e,this._onIconChanged.fire({instance:this,userInitiated:!0}),e;const t=this._scopedInstantiationService.createInstance(Vi),i=await t.pickIcons();if(t.dispose(),!!i)return this._icon=i,this._onIconChanged.fire({instance:this,userInitiated:!0}),i}async changeColor(e,t){if(e)return this.shellLaunchConfig.color=e,this._onIconChanged.fire({instance:this,userInitiated:!0}),e;if(t){this.shellLaunchConfig.color="",this._onIconChanged.fire({instance:this,userInitiated:!0});return}if(!this._getIcon())return;const s=this._themeService.getColorTheme(),r=gi(s),n=fi(s),u=[];for(const w of r){const W=pi(w);u.push({label:`$(${B.circleFilled.id}) ${w.replace("terminal.ansi","")}`,id:w,description:w,iconClasses:[W]})}u.push({type:"separator"});const S={label:"Reset to default"};u.push(S);const b=[],_=this._quickInputService.createQuickPick({useSeparators:!0});b.push(_),_.items=u,_.matchOnDescription=!0,_.placeholder=c.localize("changeColor","Select a color for the terminal"),_.show();const L=await new Promise(w=>{b.push(_.onDidHide(()=>w(void 0))),b.push(_.onDidAccept(()=>w(_.selectedItems[0])))});return le(b),L&&(this.shellLaunchConfig.color=L.id,this._onIconChanged.fire({instance:this,userInitiated:!0})),_.hide(),n.dispose(),L?.id}forceScrollbarVisibility(){this._wrapperElement.classList.add("force-scrollbar")}resetScrollbarVisibility(){this._wrapperElement.classList.remove("force-scrollbar")}setParentContextKeyService(e){this._scopedContextKeyService.updateParent(e)}async handleMouseEvent(e,t){if(h.isHTMLElement(e.target)&&(e.target.classList.contains("scrollbar")||e.target.classList.contains("slider")))return{cancelContextMenu:!0};for(const i of this._contributions.values())if((await i.handleMouseEvent?.(e))?.handled)return{cancelContextMenu:!0};if(e.which===2){switch(this._terminalConfigurationService.config.middleClickBehavior){case"default":default:this.focus();break}return}if(e.which===3){if(e.shiftKey){Hi(h.getActiveWindow(),e,this,t,this._contextMenuService);return}if(this._terminalConfigurationService.config.rightClickBehavior==="nothing")return e.shiftKey?void 0:{cancelContextMenu:!0}}}};x([X(50)],g.prototype,"_fireMaximumDimensionsChanged",1),x([X(1e3)],g.prototype,"relaunch",1),x([X(2e3)],g.prototype,"_updateProcessCwd",1),g=x([o(2,de),o(3,qi),o(4,He),o(5,ye),o(6,Ti),o(7,Oi),o(8,Ue),o(9,Xe),o(10,Wi),o(11,hi),o(12,oi),o(13,ze),o(14,ii),o(15,Qe),o(16,Ke),o(17,$e),o(18,Ge),o(19,Mi),o(20,_e),o(21,ki),o(22,ai),o(23,Ai),o(24,Ze),o(25,je),o(26,Be),o(27,We),o(28,ie)],g);let F=class extends j{constructor(e,t,i){super();this._container=e;this._layoutService=t;this._viewDescriptorService=i;this._register(G(()=>this._clearDropOverlay()))}_dropOverlay;_onDropFile=this._register(new l);get onDropFile(){return this._onDropFile.event}_onDropTerminal=this._register(new l);get onDropTerminal(){return this._onDropTerminal.event}_clearDropOverlay(){this._dropOverlay?.remove(),this._dropOverlay=void 0}onDragEnter(e){if(Z(e,q.FILES,q.RESOURCES,te.Terminals,ue.FILES)){if(this._dropOverlay||(this._dropOverlay=document.createElement("div"),this._dropOverlay.classList.add("terminal-drop-overlay")),Z(e,te.Terminals)){const t=this._getDropSide(e);this._dropOverlay.classList.toggle("drop-before",t==="before"),this._dropOverlay.classList.toggle("drop-after",t==="after")}this._dropOverlay.parentElement||this._container.appendChild(this._dropOverlay)}}onDragLeave(e){this._clearDropOverlay()}onDragEnd(e){this._clearDropOverlay()}onDragOver(e){if(!(!e.dataTransfer||!this._dropOverlay)){if(Z(e,te.Terminals)){const t=this._getDropSide(e);this._dropOverlay.classList.toggle("drop-before",t==="before"),this._dropOverlay.classList.toggle("drop-after",t==="after")}this._dropOverlay.style.opacity="1"}}async onDrop(e){if(this._clearDropOverlay(),!e.dataTransfer)return;const t=wi(e);if(t){for(const n of t){const u=this._getDropSide(e);this._onDropTerminal.fire({uri:n,side:u})}return}let i;const s=e.dataTransfer.getData(q.RESOURCES);s&&(i=k.parse(JSON.parse(s)[0]));const r=e.dataTransfer.getData(ue.FILES);!i&&r&&(i=k.file(JSON.parse(r)[0])),!i&&e.dataTransfer.files.length>0&&me(e.dataTransfer.files[0])&&(i=k.file(me(e.dataTransfer.files[0]))),i&&this._onDropFile.fire(i)}_getDropSide(e){const t=this._container;if(!t)return"after";const i=t.getBoundingClientRect();return this._getViewOrientation()===U.HORIZONTAL?e.clientX-i.left<i.width/2?"before":"after":e.clientY-i.top<i.height/2?"before":"after"}_getViewOrientation(){const e=this._layoutService.getPanelPosition();return this._viewDescriptorService.getViewLocationById(z)===ve.Panel&&Fi(e)?U.HORIZONTAL:U.VERTICAL}};F=x([o(1,Ki),o(2,ie)],F);var $i=(e=>(e.Title="title",e.Description="description",e))($i||{});let K=class extends j{constructor(e,t,i){super();this._fileService=e;this._terminalConfigurationService=t;this._workspaceContextService=i}_title="";_description="";get title(){return this._title}get description(){return this._description}_onDidChangeLabel=this._register(new l);onDidChangeLabel=this._onDidChangeLabel.event;refreshLabel(e,t){this._title=this.computeLabel(e,this._terminalConfigurationService.config.tabs.title,"title",t),this._description=this.computeLabel(e,this._terminalConfigurationService.config.tabs.description,"description"),(this._title!==e.title||this._description!==e.description||t)&&this._onDidChangeLabel.fire({title:this._title,description:this._description})}computeLabel(e,t,i,s){const r=e.shellLaunchConfig.attachPersistentProcess?.type||e.shellLaunchConfig.type,n={cwd:e.cwd||e.initialCwd||"",cwdFolder:"",workspaceFolderName:e.workspaceFolder?.name,workspaceFolder:e.workspaceFolder?R.basename(e.workspaceFolder.uri.fsPath):void 0,local:r==="Local"?V.typeLocal:void 0,process:e.processName,sequence:e.sequence,task:r==="Task"?V.typeTask:void 0,fixedDimensions:e.fixedCols?e.fixedRows?`\u2194${e.fixedCols} \u2195${e.fixedRows}`:`\u2194${e.fixedCols}`:e.fixedRows?`\u2195${e.fixedRows}`:"",separator:{label:this._terminalConfigurationService.config.tabs.separator}};if(n.workspaceFolderName=e.workspaceFolder?.name??n.workspaceFolder,t=t.trim(),!t)return i==="title"&&e.processName||"";if(!s&&e.staticTitle&&i==="title")return e.staticTitle.replace(/[\n\r\t]/g,"")||n.process?.replace(/[\n\r\t]/g,"")||"";const u=e.capabilities.has(v.CwdDetection)||e.capabilities.has(v.NaiveCwdDetection),b=this._workspaceContextService.getWorkspace().folders.length>1;if(n.cwd&&u&&(!e.shellLaunchConfig.isFeatureTerminal||i==="title")){const L=k.from({scheme:e.workspaceFolder?.uri.scheme||Q.file,path:e.cwd?R.resolve(e.cwd):void 0});let w=!1;if(b)w=!0;else if(e.workspaceFolder?.uri){const W=this._fileService.hasCapability(e.workspaceFolder.uri,Ve.PathCaseSensitive);w=L.fsPath.localeCompare(e.workspaceFolder.uri.fsPath,void 0,{sensitivity:W?"case":"base"})!==0}w&&(n.cwdFolder=R.basename(n.cwd))}const _=Re(t,n).replace(/[\n\r\t]/g,"").trim();return _===""&&i==="title"?e.processName||"":_}};K=x([o(0,Ne),o(1,ye),o(2,_e)],K);function Gi(p,d,e,t){if(p===void 0||p===0)return{code:p,message:void 0};const i=typeof p=="number"?p:p.code;let s;switch(typeof p){case"number":{let r;d.executable&&(r=d.executable,typeof d.args=="string"?r+=` ${d.args}`:d.args&&d.args.length&&(r+=d.args.map(n=>` '${n}'`).join())),e===I.KilledDuringLaunch?r?s=c.localize("launchFailed.exitCodeAndCommandLine",'The terminal process "{0}" failed to launch (exit code: {1}).',r,i):s=c.localize("launchFailed.exitCodeOnly","The terminal process failed to launch (exit code: {0}).",i):r?s=c.localize("terminated.exitCodeAndCommandLine",'The terminal process "{0}" terminated with exit code: {1}.',r,i):s=c.localize("terminated.exitCodeOnly","The terminal process terminated with exit code: {0}.",i);break}case"object":{if(p.message.toString().includes("Could not find pty with id"))break;let r=p.message;const n=p.message.match(/.*error code:\s*(\d+).*$/);if(n)switch(n.length>1?parseInt(n[1]):void 0){case 5:r=`Access was denied to the path containing your executable "${d.executable}". Manage and change your permissions to get this to work`;break;case 267:r=`Invalid starting directory "${t}", review your terminal.integrated.cwd setting`;break;case 1260:r="Windows cannot open this program because it has been prevented by a software restriction policy. For more information, open Event Viewer or contact your system Administrator";break}s=c.localize("launchFailed.errorMessage","The terminal process failed to launch: {0}.",r);break}}return{code:i,message:s}}let O=class{constructor(d,e){this._target=d;this._viewDescriptorService=e}getBackgroundColor(d){const e=d.getColor(Li);return e||(this._target.object===si.Editor?d.getColor(ri):this._viewDescriptorService.getViewLocationById(z)===ve.Panel?d.getColor(li):d.getColor(ci))}};O=x([o(1,ie)],O);export{g as TerminalInstance,O as TerminalInstanceColorProvider,K as TerminalLabelComputer,Gi as parseExitResult};
