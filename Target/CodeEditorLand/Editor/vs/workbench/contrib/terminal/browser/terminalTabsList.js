var ie=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var S=(I,n,t,e)=>{for(var i=e>1?void 0:e?ne(n,t):n,o=I.length-1,s;o>=0;o--)(s=I[o])&&(i=(e?s(n,t,i):s(i))||i);return e&&i&&ie(n,t,i),i},l=(I,n)=>(t,e)=>n(t,e,I);import{IListService as G,WorkbenchList as re}from"../../../../platform/list/browser/listService.js";import"../../../../base/browser/ui/list/listWidget.js";import{IConfigurationService as M}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as oe}from"../../../../platform/contextkey/common/contextkey.js";import{IKeybindingService as se}from"../../../../platform/keybinding/common/keybinding.js";import{IThemeService as R}from"../../../../platform/theme/common/themeService.js";import{ThemeIcon as P}from"../../../../base/common/themables.js";import{ITerminalConfigurationService as ae,ITerminalGroupService as E,ITerminalService as x,TerminalDataTransfers as k}from"./terminal.js";import{localize as _}from"../../../../nls.js";import*as f from"../../../../base/browser/dom.js";import{IInstantiationService as K}from"../../../../platform/instantiation/common/instantiation.js";import{ActionBar as le}from"../../../../base/browser/ui/actionbar/actionbar.js";import{MenuItemAction as ce}from"../../../../platform/actions/common/actions.js";import{MenuEntryActionViewItem as me}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{TerminalCommandId as V}from"../common/terminal.js";import{TerminalLocation as de,TerminalSettingId as ue}from"../../../../platform/terminal/common/terminal.js";import{Codicon as W}from"../../../../base/common/codicons.js";import{Action as N}from"../../../../base/common/actions.js";import{DEFAULT_LABELS_CONTAINER as pe,ResourceLabels as he}from"../../../browser/labels.js";import{IDecorationsService as fe}from"../../../services/decorations/common/decorations.js";import{IHoverService as U}from"../../../../platform/hover/browser/hover.js";import A from"../../../../base/common/severity.js";import{Disposable as w,DisposableStore as ve,dispose as H,toDisposable as $}from"../../../../base/common/lifecycle.js";import{ListDragOverEffectPosition as Ie,ListDragOverEffectType as ge}from"../../../../base/browser/ui/list/list.js";import{DataTransfers as B}from"../../../../base/browser/dnd.js";import{disposableTimeout as Se}from"../../../../base/common/async.js";import{ElementsDragAndDropData as q,NativeDragAndDropData as _e}from"../../../../base/browser/ui/list/listView.js";import{URI as O}from"../../../../base/common/uri.js";import{getColorClass as ye,getIconId as be,getUriClasses as Te}from"./terminalIcon.js";import"../../../common/views.js";import{IContextViewService as De}from"../../../../platform/contextview/browser/contextView.js";import{InputBox as Ce,MessageType as F}from"../../../../base/browser/ui/inputbox/inputBox.js";import{createSingleCallFunction as Ee}from"../../../../base/common/functional.js";import"../../../../base/browser/keyboardEvent.js";import{KeyCode as J}from"../../../../base/common/keyCodes.js";import{CodeDataTransfers as Y,containsDragType as j,getPathForFile as X}from"../../../../platform/dnd/browser/dnd.js";import{terminalStrings as Q}from"../common/terminalStrings.js";import{ILifecycleService as xe}from"../../../services/lifecycle/common/lifecycle.js";import"../../../../platform/terminal/common/terminalProcess.js";import{TerminalContextKeys as Z}from"../common/terminalContextKey.js";import{getTerminalResourcesFromDragEvent as Ae,parseTerminalUri as we}from"./terminalUri.js";import{getInstanceHoverInfo as z}from"./terminalTooltip.js";import{defaultInputBoxStyles as Fe}from"../../../../platform/theme/browser/defaultStyles.js";import{Emitter as Le}from"../../../../base/common/event.js";import{Schemas as Ge}from"../../../../base/common/network.js";import{getColorForSeverity as Re}from"./terminalStatusList.js";import{TerminalContextActionRunner as ke}from"./terminalContextMenu.js";import{HoverPosition as ee}from"../../../../base/browser/ui/hover/hoverWidget.js";const te=f.$;var He=(r=>(r[r.TabHeight=22]="TabHeight",r[r.NarrowViewWidth=46]="NarrowViewWidth",r[r.WideViewMinimumWidth=80]="WideViewMinimumWidth",r[r.DefaultWidth=120]="DefaultWidth",r[r.MidpointViewWidth=63]="MidpointViewWidth",r[r.ActionbarMinimumWidth=105]="ActionbarMinimumWidth",r[r.MaximumWidth=500]="MaximumWidth",r))(He||{});let L=class extends re{constructor(t,e,i,o,s,r,p,c,u,m,d,h){super("TerminalTabsList",t,{getHeight:()=>22,getTemplateId:()=>"terminal.tabs"},[c.createInstance(y,t,c.createInstance(he,pe),()=>this.getSelectedElements())],{horizontalScrolling:!1,supportDynamicHeights:!1,selectionNavigation:!0,identityProvider:{getId:a=>a?.instanceId},accessibilityProvider:c.createInstance(b),smoothScrolling:s.getValue("workbench.list.smoothScrolling"),multipleSelectionSupport:!0,paddingBottom:22,dnd:c.createInstance(T),openOnSingleClick:!0},e,i,s,c);this._configurationService=s;this._terminalService=r;this._terminalGroupService=p;this._themeService=m;this._hoverService=h;const g=[this._terminalGroupService.onDidChangeInstances(()=>this.refresh()),this._terminalGroupService.onDidChangeGroups(()=>this.refresh()),this._terminalGroupService.onDidShow(()=>this.refresh()),this._terminalGroupService.onDidChangeInstanceCapability(()=>this.refresh()),this._terminalService.onAnyInstanceTitleChange(()=>this.refresh()),this._terminalService.onAnyInstanceIconChange(()=>this.refresh()),this._terminalService.onAnyInstancePrimaryStatusChange(()=>this.refresh()),this._terminalService.onDidChangeConnectionState(()=>this.refresh()),this._themeService.onDidColorThemeChange(()=>this.refresh()),this._terminalGroupService.onDidChangeActiveInstance(a=>{if(a){const v=this._terminalGroupService.instances.indexOf(a);this.setSelection([v]),this.reveal(v)}this.refresh()})];this.disposables.add(d.onWillShutdown(a=>{H(g),g.length=0})),this.disposables.add($(()=>{H(g),g.length=0})),this.disposables.add(this.onMouseDblClick(async a=>{if(this.getFocus().length===0){const C=await this._terminalService.createTerminal({location:de.Panel});this._terminalGroupService.setActiveInstance(C),await C.focusWhenReady()}this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&this._getFocusMode()==="doubleClick"&&this.getFocus().length===1&&a.element?.focus(!0)})),this.disposables.add(this.onMouseClick(async a=>{this._terminalService.getEditingTerminal()?.instanceId!==a.element?.instanceId&&(a.browserEvent.altKey&&a.element?await this._terminalService.createTerminal({location:{parentTerminal:a.element}}):this._getFocusMode()==="singleClick"&&this.getSelection().length<=1&&a.element?.focus(!0))})),this.disposables.add(this.onContextMenu(a=>{if(!a.element){this.setSelection([]);return}const v=this.getSelectedElements();(!v||!v.find(C=>a.element===C))&&this.setFocus(a.index!==void 0?[a.index]:[])})),this._terminalTabsSingleSelectedContextKey=Z.tabsSingularSelection.bindTo(e),this._isSplitContextKey=Z.splitTerminal.bindTo(e),this.disposables.add(this.onDidChangeSelection(a=>this._updateContextKey())),this.disposables.add(this.onDidChangeFocus(()=>this._updateContextKey())),this.disposables.add(this.onDidOpen(async a=>{const v=a.element;v&&(this._terminalGroupService.setActiveInstance(v),a.editorOptions.preserveFocus||await v.focusWhenReady())})),this._decorationsProvider||(this._decorationsProvider=this.disposables.add(c.createInstance(D)),this.disposables.add(u.registerDecorationsProvider(this._decorationsProvider))),this.refresh()}_decorationsProvider;_terminalTabsSingleSelectedContextKey;_isSplitContextKey;_getFocusMode(){return this._configurationService.getValue(ue.TabsFocusMode)}refresh(t=!0){t&&this._terminalService.isEditable(void 0)&&this.domFocus(),this.splice(0,this.length,this._terminalGroupService.instances.slice())}focusHover(){const t=this.getSelectedElements()[0];t&&this._hoverService.showHover({...z(t),target:this.getHTMLElement(),trapFocus:!0},!0)}_updateContextKey(){this._terminalTabsSingleSelectedContextKey.set(this.getSelectedElements().length===1);const t=this.getFocusedElements();this._isSplitContextKey.set(t.length>0&&this._terminalGroupService.instanceIsSplit(t[0]))}};L=S([l(1,oe),l(2,G),l(3,R),l(4,M),l(5,x),l(6,E),l(7,K),l(8,fe),l(9,R),l(10,xe),l(11,U)],L);let y=class{constructor(n,t,e,i,o,s,r,p,c,u,m,d,h){this._container=n;this._labels=t;this._getSelection=e;this._instantiationService=i;this._terminalConfigurationService=o;this._terminalService=s;this._terminalGroupService=r;this._hoverService=p;this._configurationService=c;this._keybindingService=u;this._listService=m;this._themeService=d;this._contextViewService=h}templateId="terminal.tabs";renderTemplate(n){const t=f.append(n,te(".terminal-tabs-entry")),e={},i=this._labels.create(t,{supportHighlights:!0,supportDescriptionHighlights:!0,supportIcons:!0,hoverDelegate:{delay:this._configurationService.getValue("workbench.hover.delay"),showHover:r=>this._hoverService.showHover({...r,actions:e.hoverActions,target:t,persistence:{hideOnHover:!0},appearance:{showPointer:!0},position:{hoverPosition:this._terminalConfigurationService.config.tabs.location==="left"?ee.RIGHT:ee.LEFT}})}}),o=f.append(i.element,te(".actions")),s=new le(o,{actionRunner:new ke,actionViewItemProvider:(r,p)=>r instanceof ce?this._instantiationService.createInstance(me,r,{hoverDelegate:p.hoverDelegate}):void 0});return{element:t,label:i,actionBar:s,context:e,elementDisposables:new ve}}shouldHideText(){return this._container?this._container.clientWidth<63:!1}shouldHideActionBar(){return this._container?this._container.clientWidth<=105:!1}renderElement(n,t,e){const i=!this.shouldHideText(),o=this._terminalGroupService.getGroupForInstance(n);if(!o)throw new Error(`Could not find group for instance "${n.instanceId}"`);e.element.classList.toggle("has-text",i),e.element.classList.toggle("is-active",this._terminalGroupService.activeInstance===n);let s="";if(o.terminalInstances.length>1){const a=o.terminalInstances.indexOf(n);a===0?s="\u250C ":a===o.terminalInstances.length-1?s="\u2514 ":s="\u251C "}const r=z(n);e.context.hoverActions=r.actions;const p=this._instantiationService.invokeFunction(be,n),c=!this.shouldHideActionBar();let u="";if(i)this.fillActionBar(n,e),u=s,n.icon&&(u+=`$(${p}) ${n.title}`);else{const a=n.statusList.primary;a&&a.severity>A.Ignore?u=`${s}$(${a.icon?.id||p})`:u=`${s}$(${p})`}c||e.actionBar.clear(),e.elementDisposables.add(f.addDisposableListener(e.element,f.EventType.AUXCLICK,a=>{a.stopImmediatePropagation(),a.button===1&&this._terminalService.safeDisposeTerminal(n)}));const m=[],d=ye(n);d&&m.push(d);const h=Te(n,this._themeService.getColorTheme().type);h&&m.push(...h),e.label.setResource({resource:n.resource,name:u,description:i?n.description:void 0},{fileDecorations:{colors:!0,badges:i},title:{markdown:r.content,markdownNotSupportedFallback:void 0},extraClasses:m});const g=this._terminalService.getEditableData(n);e.label.element.classList.toggle("editable-tab",!!g),g&&(e.elementDisposables.add(this._renderInputBox(e.label.element.querySelector(".monaco-icon-label-container"),n,g)),e.actionBar.clear())}_renderInputBox(n,t,e){const i=t.title||"",o=new Ce(n,this._contextViewService,{validationOptions:{validation:c=>{const u=e.validationMessage(c);return!u||u.severity!==A.Error?null:{content:u.content,formatContent:!0,type:F.ERROR}}},ariaLabel:_("terminalInputAriaLabel","Type terminal name. Press Enter to confirm or Escape to cancel."),inputBoxStyles:Fe});o.element.style.height="22px",o.value=i,o.focus(),o.select({start:0,end:i.length});const s=Ee((c,u)=>{o.element.style.display="none";const m=o.value;H(p),o.element.remove(),u&&e.onFinish(m,c)}),r=()=>{if(o.isInputValid()){const c=e.validationMessage(o.value);c?o.showMessage({content:c.content,formatContent:!0,type:c.severity===A.Info?F.INFO:c.severity===A.Warning?F.WARNING:F.ERROR}):o.hideMessage()}};r();const p=[o,f.addStandardDisposableListener(o.inputElement,f.EventType.KEY_DOWN,c=>{c.stopPropagation(),c.equals(J.Enter)?s(o.isInputValid(),!0):c.equals(J.Escape)&&s(!1,!0)}),f.addStandardDisposableListener(o.inputElement,f.EventType.KEY_UP,c=>{r()}),f.addDisposableListener(o.inputElement,f.EventType.BLUR,()=>{s(o.isInputValid(),!0)})];return $(()=>{s(!1,!1)})}disposeElement(n,t,e){e.elementDisposables.clear(),e.actionBar.clear()}disposeTemplate(n){n.elementDisposables.dispose(),n.label.dispose(),n.actionBar.dispose()}fillActionBar(n,t){const e=[new N(V.SplitActiveTab,Q.split.short,P.asClassName(W.splitHorizontal),!0,async()=>{this._runForSelectionOrInstance(n,async i=>{this._terminalService.createTerminal({location:{parentTerminal:i}})})}),new N(V.KillActiveTab,Q.kill.short,P.asClassName(W.trashcan),!0,async()=>{this._runForSelectionOrInstance(n,i=>this._terminalService.safeDisposeTerminal(i))})];t.actionBar.clear();for(const i of e)t.actionBar.push(i,{icon:!0,label:!1,keybinding:this._keybindingService.lookupKeybinding(i.id)?.getLabel()})}_runForSelectionOrInstance(n,t){const e=this._getSelection();if(e.includes(n))for(const i of e)i&&t(i);else t(n);this._terminalGroupService.focusTabs(),this._listService.lastFocusedList?.focusNext()}};y=S([l(3,K),l(4,ae),l(5,x),l(6,E),l(7,U),l(8,M),l(9,se),l(10,G),l(11,R),l(12,De)],y);let b=class{constructor(n){this._terminalGroupService=n}getWidgetAriaLabel(){return _("terminal.tabs","Terminal tabs")}getAriaLabel(n){let t="";const e=this._terminalGroupService.getGroupForInstance(n);if(e&&e.terminalInstances?.length>1){const i=e.terminalInstances.indexOf(n);t=_({key:"splitTerminalAriaLabel",comment:["The terminal's ID","The terminal's title","The terminal's split number","The terminal group's total split number"]},"Terminal {0} {1}, split {2} of {3}",n.instanceId,n.title,i+1,e.terminalInstances.length)}else t=_({key:"terminalAriaLabel",comment:["The terminal's ID","The terminal's title"]},"Terminal {0} {1}",n.instanceId,n.title);return t}};b=S([l(0,E)],b);let T=class extends w{constructor(t,e,i){super();this._terminalService=t;this._terminalGroupService=e;this._listService=i;this._primaryBackend=this._terminalService.getPrimaryBackend()}_autoFocusInstance;_autoFocusDisposable=w.None;_primaryBackend;getDragURI(t){return this._terminalService.getEditingTerminal()?.instanceId===t.instanceId?null:t.resource.toString()}getDragLabel(t,e){return t.length===1?t[0].title:void 0}onDragLeave(){this._autoFocusInstance=void 0,this._autoFocusDisposable.dispose(),this._autoFocusDisposable=w.None}onDragStart(t,e){if(!e.dataTransfer)return;const i=t.getData();if(!Array.isArray(i))return;const o=i.filter(s=>"instanceId"in s);o.length>0&&e.dataTransfer.setData(k.Terminals,JSON.stringify(o.map(s=>s.resource.toString())))}onDragOver(t,e,i,o,s){if(t instanceof _e&&!j(s,B.FILES,B.RESOURCES,k.Terminals,Y.FILES))return!1;const r=this._autoFocusInstance!==e;return r&&(this._autoFocusDisposable.dispose(),this._autoFocusInstance=e),!e&&!j(s,k.Terminals)?t instanceof q:(r&&e&&(this._autoFocusDisposable=Se(()=>{this._terminalService.setActiveInstance(e),this._autoFocusInstance=void 0},500,this._store)),{feedback:i?[i]:void 0,accept:!0,effect:{type:ge.Move,position:Ie.Over}})}async drop(t,e,i,o,s){this._autoFocusDisposable.dispose(),this._autoFocusInstance=void 0;let r;const p=[],c=Ae(s);if(c)for(const m of c){const d=this._terminalService.getInstanceFromResource(m);if(d)Array.isArray(r)?r.push(d):r=[d],this._terminalService.moveToTerminalView(d);else if(this._primaryBackend){const h=we(m);h.instanceId&&p.push(this._primaryBackend.requestDetachInstance(h.workspaceId,h.instanceId))}}if(p.length){let m=await Promise.all(p);m=m.filter(h=>h!==void 0);let d;for(const h of m)d=await this._terminalService.createTerminal({config:{attachPersistentProcess:h}});d&&this._terminalService.setActiveInstance(d);return}if(r===void 0){if(!(t instanceof q)){this._handleExternalDrop(e,s);return}const m=t.getData();if(!m||!Array.isArray(m))return;r=[];for(const d of m)"instanceId"in d&&r.push(d)}if(!e){this._terminalGroupService.moveGroupToEnd(r),this._terminalService.setActiveInstance(r[0]);const m=this._terminalGroupService.getGroupForInstance(r[0]);if(m){const d=this._terminalGroupService.groups.indexOf(m);this._listService.lastFocusedList?.setSelection([d])}return}this._terminalGroupService.moveGroup(r,e),this._terminalService.setActiveInstance(r[0]);const u=this._terminalGroupService.getGroupForInstance(r[0]);if(u){const m=this._terminalGroupService.groups.indexOf(u);this._listService.lastFocusedList?.setSelection([m])}}async _handleExternalDrop(t,e){if(!t||!e.dataTransfer)return;let i;const o=e.dataTransfer.getData(B.RESOURCES);o&&(i=O.parse(JSON.parse(o)[0]));const s=e.dataTransfer.getData(Y.FILES);!i&&s&&(i=O.file(JSON.parse(s)[0])),!i&&e.dataTransfer.files.length>0&&X(e.dataTransfer.files[0])&&(i=O.file(X(e.dataTransfer.files[0]))),i&&(this._terminalService.setActiveInstance(t),t.focus(),await t.sendPath(i,!1))}};T=S([l(0,x),l(1,E),l(2,G)],T);let D=class extends w{constructor(t){super();this._terminalService=t;this._register(this._terminalService.onAnyInstancePrimaryStatusChange(e=>this._onDidChange.fire([e.resource])))}label=_("label","Terminal");_onDidChange=this._register(new Le);onDidChange=this._onDidChange.event;provideDecorations(t){if(t.scheme!==Ge.vscodeTerminal)return;const e=this._terminalService.getInstanceFromResource(t);if(!e)return;const i=e?.statusList?.primary;if(i?.icon)return{color:Re(i.severity),letter:i.icon,tooltip:i.tooltip}}};D=S([l(0,x)],D);export{L as TerminalTabList,He as TerminalTabsListSizes};
