var H=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var A=(c,r,e,i)=>{for(var n=i>1?void 0:i?q(r,e):r,a=c.length-1,o;a>=0;a--)(o=c[a])&&(n=(i?o(r,e,n):o(n))||n);return i&&n&&H(r,e,n),n},b=(c,r)=>(e,i)=>r(e,i,c);import{Event as K}from"../../../../../base/common/event.js";import{KeyCode as f,KeyMod as l}from"../../../../../base/common/keyCodes.js";import{Disposable as B,DisposableStore as O,MutableDisposable as R}from"../../../../../base/common/lifecycle.js";import{isWindows as M}from"../../../../../base/common/platform.js";import{Position as x}from"../../../../../editor/common/core/position.js";import{localize2 as g}from"../../../../../nls.js";import{AccessibleViewProviderId as m,IAccessibleViewService as y,NavigationType as k}from"../../../../../platform/accessibility/browser/accessibleView.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as G}from"../../../../../platform/accessibility/common/accessibility.js";import{AccessibilitySignal as N,IAccessibilitySignalService as X}from"../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js";import{Action2 as U,registerAction2 as Y}from"../../../../../platform/actions/common/actions.js";import{IConfigurationService as z}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as t,IContextKeyService as j}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as P}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as T}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{TerminalCapability as I}from"../../../../../platform/terminal/common/capabilities/capabilities.js";import"../../../../../platform/terminal/common/capabilities/commandDetection/terminalCommand.js";import{TerminalSettingId as J}from"../../../../../platform/terminal/common/terminal.js";import{accessibleViewCurrentProviderId as p,accessibleViewIsShown as C}from"../../../accessibility/browser/accessibilityConfiguration.js";import{AccessibilityHelpAction as Q,AccessibleViewAction as Z}from"../../../accessibility/browser/accessibleViewActions.js";import{ITerminalService as V}from"../../../terminal/browser/terminal.js";import{registerTerminalAction as w}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as D}from"../../../terminal/browser/terminalExtensions.js";import{TerminalContextKeys as s}from"../../../terminal/common/terminalContextKey.js";import{TerminalAccessibilityCommandId as S}from"../common/terminal.accessibility.js";import{TerminalAccessibilitySettingId as E}from"../common/terminalAccessibilityConfiguration.js";import{BufferContentTracker as $}from"./bufferContentTracker.js";import{TerminalAccessibilityHelpProvider as L}from"./terminalAccessibilityHelp.js";import{TerminalAccessibleBufferProvider as ee}from"./terminalAccessibleBufferProvider.js";import{TextAreaSyncAddon as F}from"./textAreaSyncAddon.js";let v=class extends O{constructor(e,i){super();this._ctx=e;this._instantiationService=i}static ID="terminal.textAreaSync";static get(e){return e.getContribution(v.ID)}_addon;layout(e){this._addon||(this._addon=this.add(this._instantiationService.createInstance(F,this._ctx.instance.capabilities)),e.raw.loadAddon(this._addon),this._addon.activate(e.raw))}};v=A([b(1,P)],v),D(v.ID,v);let d=class extends B{constructor(e,i,n,a,o,_,h){super();this._ctx=e;this._accessibilitySignalService=i;this._accessibleViewService=n;this._configurationService=a;this._contextKeyService=o;this._instantiationService=_;this._terminalService=h;this._register(Z.addImplementation(90,"terminal",()=>this._terminalService.activeInstance!==this._ctx.instance?!1:(this.show(),!0),s.focus)),this._register(this._ctx.instance.onDidExecuteText(()=>{const u=a.getValue(J.FocusAfterRun);u==="terminal"?this._ctx.instance.focus(!0):u==="accessible-buffer"&&this.show()})),this._register(this._configurationService.onDidChangeConfiguration(u=>{u.affectsConfiguration(E.AccessibleViewFocusOnCommandExecution)&&this._updateCommandExecutedListener()})),this._register(this._ctx.instance.capabilities.onDidAddCapability(u=>{u.capability.type===I.CommandDetection&&this._updateCommandExecutedListener()}))}static ID="terminal.accessibleBufferProvider";static get(e){return e.getContribution(d.ID)}_bufferTracker;_bufferProvider;_xterm;_onDidRunCommand=new R;xtermReady(e){const i=this._instantiationService.createInstance(F,this._ctx.instance.capabilities);e.raw.loadAddon(i),i.activate(e.raw),this._xterm=e,this._register(this._xterm.raw.onWriteParsed(async()=>{this._terminalService.activeInstance===this._ctx.instance&&this._isTerminalAccessibleViewOpen()&&this._xterm.raw.buffer.active.baseY===0&&this.show()}));const n=K.latch(this._xterm.raw.onScroll);this._register(n(()=>{this._terminalService.activeInstance===this._ctx.instance&&this._isTerminalAccessibleViewOpen()&&this.show()}))}_updateCommandExecutedListener(){if(!this._ctx.instance.capabilities.has(I.CommandDetection))return;if(this._configurationService.getValue(E.AccessibleViewFocusOnCommandExecution)){if(this._onDidRunCommand.value)return}else{this._onDidRunCommand.clear();return}const e=this._ctx.instance.capabilities.get(I.CommandDetection);this._onDidRunCommand.value=this._register(e.onCommandExecuted(()=>{this._ctx.instance.hasFocus&&this.show()}))}_isTerminalAccessibleViewOpen(){return p.getValue(this._contextKeyService)===m.Terminal}show(){if(!this._xterm)return;this._bufferTracker||(this._bufferTracker=this._register(this._instantiationService.createInstance($,this._xterm))),this._bufferProvider||(this._bufferProvider=this._register(this._instantiationService.createInstance(ee,this._ctx.instance,this._bufferTracker,()=>this._register(this._instantiationService.createInstance(L,this._ctx.instance,this._xterm)).provideContent())));const e=this._configurationService.getValue(E.AccessibleViewPreserveCursorPosition)?this._accessibleViewService.getPosition(m.Terminal):void 0;this._accessibleViewService.show(this._bufferProvider,e)}navigateToCommand(e){const i=this._accessibleViewService.getPosition(m.Terminal)?.lineNumber,n=this._getCommandsWithEditorLine();if(!n?.length||!i)return;const a=e===k.Previous?n.filter(h=>h.lineNumber<i).sort((h,u)=>u.lineNumber-h.lineNumber):n.filter(h=>h.lineNumber>i).sort((h,u)=>h.lineNumber-u.lineNumber);if(!a.length)return;const o=a[0],_=o.command.command;!M&&_?(this._accessibleViewService.setPosition(new x(o.lineNumber,1),!0),alert(_)):this._accessibleViewService.setPosition(new x(o.lineNumber,1),!0,!0),o.exitCode?this._accessibilitySignalService.playSignal(N.terminalCommandFailed):this._accessibilitySignalService.playSignal(N.terminalCommandSucceeded)}_getCommandsWithEditorLine(){const e=this._ctx.instance.capabilities.get(I.CommandDetection),i=e?.commands,n=e?.currentCommand;if(!i?.length)return;const a=[];for(const o of i){const _=this._getEditorLineForCommand(o);_&&a.push({command:o,lineNumber:_,exitCode:o.exitCode})}if(n){const o=this._getEditorLineForCommand(n);o&&a.push({command:n,lineNumber:o})}return a}_getEditorLineForCommand(e){if(!this._bufferTracker)return;let i;if("marker"in e?i=e.marker?.line:"commandStartMarker"in e&&(i=e.commandStartMarker?.line),!(i===void 0||i<0)&&(i=this._bufferTracker.bufferToEditorLineMapping.get(i),i!==void 0))return i+1}};d=A([b(1,X),b(2,y),b(3,z),b(4,j),b(5,P),b(6,V)],d),D(d.ID,d);class W extends B{static ID;constructor(){super(),this._register(Q.addImplementation(105,"terminal",async r=>{const e=r.get(P),i=r.get(V),n=r.get(y),a=await i.getActiveOrCreateInstance();await i.revealActiveTerminal();const o=a?.xterm;o&&n.show(e.createInstance(L,a,o))},t.or(s.focus,t.and(C,t.equals(p.key,m.Terminal)))))}}D(W.ID,W);class ie extends U{constructor(){super({id:S.FocusAccessibleBuffer,title:g("workbench.action.terminal.focusAccessibleBuffer","Focus Accessible Terminal View"),precondition:t.or(s.processSupported,s.terminalHasBeenCreated),keybinding:[{primary:l.Alt|f.F2,secondary:[l.CtrlCmd|f.UpArrow],linux:{primary:l.Alt|f.F2|l.Shift,secondary:[l.CtrlCmd|f.UpArrow]},weight:T.WorkbenchContrib,when:t.and(G,s.focus)}]})}async run(r,...e){const n=await r.get(V).getActiveOrCreateInstance();n?.xterm&&d.get(n)?.show()}}Y(ie),w({id:S.AccessibleBufferGoToNextCommand,title:g("workbench.action.terminal.accessibleBufferGoToNextCommand","Accessible Buffer Go to Next Command"),precondition:t.or(s.processSupported,s.terminalHasBeenCreated,t.and(C,t.equals(p.key,m.Terminal))),keybinding:[{primary:l.Alt|f.DownArrow,when:t.and(t.and(C,t.equals(p.key,m.Terminal))),weight:T.WorkbenchContrib+2}],run:async c=>{const r=c.service.activeInstance;r&&d.get(r)?.navigateToCommand(k.Next)}}),w({id:S.AccessibleBufferGoToPreviousCommand,title:g("workbench.action.terminal.accessibleBufferGoToPreviousCommand","Accessible Buffer Go to Previous Command"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(C,t.equals(p.key,m.Terminal))),keybinding:[{primary:l.Alt|f.UpArrow,when:t.and(t.and(C,t.equals(p.key,m.Terminal))),weight:T.WorkbenchContrib+2}],run:async c=>{const r=c.service.activeInstance;r&&d.get(r)?.navigateToCommand(k.Previous)}}),w({id:S.ScrollToBottomAccessibleView,title:g("workbench.action.terminal.scrollToBottomAccessibleView","Scroll to Accessible View Bottom"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(C,t.equals(p.key,m.Terminal))),keybinding:{primary:l.CtrlCmd|f.End,linux:{primary:l.Shift|f.End},when:p.isEqualTo(m.Terminal),weight:T.WorkbenchContrib},run:(c,r)=>{const e=r.get(y),i=e.getLastPosition();i&&e.setPosition(i,!0)}}),w({id:S.ScrollToTopAccessibleView,title:g("workbench.action.terminal.scrollToTopAccessibleView","Scroll to Accessible View Top"),precondition:t.and(t.or(s.processSupported,s.terminalHasBeenCreated),t.and(C,t.equals(p.key,m.Terminal))),keybinding:{primary:l.CtrlCmd|f.Home,linux:{primary:l.Shift|f.Home},when:p.isEqualTo(m.Terminal),weight:T.WorkbenchContrib},run:(c,r)=>r.get(y)?.setPosition(new x(1,1),!0)});export{W as TerminalAccessibilityHelpContribution,d as TerminalAccessibleViewContribution};
