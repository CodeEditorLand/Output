var W=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var b=(p,d,e,t)=>{for(var n=t>1?void 0:t?q(d,e):d,i=p.length-1,r;i>=0;i--)(r=p[i])&&(n=(t?r(d,e,n):r(n))||n);return t&&n&&W(d,e,n),n},a=(p,d)=>(e,t)=>d(e,t,p);import*as l from"../../../../../base/browser/dom.js";import{renderFormattedText as F}from"../../../../../base/browser/formattedTextRenderer.js";import{StandardMouseEvent as O}from"../../../../../base/browser/mouseEvent.js";import{status as V}from"../../../../../base/browser/ui/aria/aria.js";import{KeybindingLabel as G}from"../../../../../base/browser/ui/keybindingLabel/keybindingLabel.js";import"../../../../../base/common/actions.js";import{Emitter as z,Event as E}from"../../../../../base/common/event.js";import{Disposable as y,DisposableStore as L,MutableDisposable as U}from"../../../../../base/common/lifecycle.js";import{OS as $}from"../../../../../base/common/platform.js";import{localize as g}from"../../../../../nls.js";import{ICommandService as B}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as w}from"../../../../../platform/configuration/common/configuration.js";import{IContextMenuService as j}from"../../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as J}from"../../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as Q}from"../../../../../platform/keybinding/common/keybinding.js";import{IProductService as Y}from"../../../../../platform/product/common/productService.js";import{IStorageService as k,StorageScope as S,StorageTarget as N}from"../../../../../platform/storage/common/storage.js";import{ITelemetryService as Z}from"../../../../../platform/telemetry/common/telemetry.js";import{TerminalCapability as D}from"../../../../../platform/terminal/common/capabilities/capabilities.js";import{AccessibilityVerbositySettingId as M}from"../../../accessibility/browser/accessibilityConfiguration.js";import{ChatAgentLocation as x,IChatAgentService as P}from"../../../chat/common/chatAgents.js";import{ITerminalEditorService as ee,ITerminalGroupService as te,ITerminalService as ie}from"../../../terminal/browser/terminal.js";import{registerTerminalContribution as ne}from"../../../terminal/browser/terminalExtensions.js";import{TerminalInstance as re}from"../../../terminal/browser/terminalInstance.js";import{TerminalInitialHintSettingId as h}from"../common/terminalInitialHintConfiguration.js";import"./media/terminalInitialHint.css";import{TerminalChatCommandId as T}from"./terminalChat.js";const C=l.$;var ae=(d=>(d.InitialHintHideStorageKey="terminal.initialHint.hide",d))(ae||{});class oe extends y{constructor(e,t){super();this._capabilities=e;this._onDidChangeAgents=t}_onDidRequestCreateHint=this._register(new z);get onDidRequestCreateHint(){return this._onDidRequestCreateHint.event}_disposables=this._register(new U);activate(e){const t=this._register(new L);this._disposables.value=t;const n=this._capabilities.get(D.CommandDetection);n?t.add(E.once(n.promptInputModel.onDidStartInput)(()=>this._onDidRequestCreateHint.fire())):this._register(this._capabilities.onDidAddCapability(r=>{if(r.id===D.CommandDetection){const s=r.capability;t.add(E.once(s.promptInputModel.onDidStartInput)(()=>this._onDidRequestCreateHint.fire())),s.promptInputModel.value||this._onDidRequestCreateHint.fire()}}));const i=this._onDidChangeAgents(r=>{r?.locations.includes(x.Terminal)&&(this._onDidRequestCreateHint.fire(),i.dispose())});this._disposables.value?.add(i)}}let m=class extends y{constructor(e,t,n,i,r,s,o){super();this._ctx=e;this._chatAgentService=t;this._configurationService=n;this._instantiationService=i;this._storageService=r;this._terminalEditorService=s;this._terminalGroupService=o;this._register(this._configurationService.onDidChangeConfiguration(_=>{_.affectsConfiguration(h.Enabled)&&this._storageService.remove("terminal.initialHint.hide",S.APPLICATION)}))}static ID="terminal.initialHint";_addon;_hintWidget;static get(e){return e.getContribution(m.ID)}_decoration;_xterm;xtermOpen(e){"shellLaunchConfig"in this._ctx.instance&&(this._ctx.instance.shellLaunchConfig.isExtensionOwnedTerminal||this._ctx.instance.shellLaunchConfig.isFeatureTerminal)||this._storageService.getBoolean("terminal.initialHint.hide",S.APPLICATION,!1)||this._terminalGroupService.instances.length+this._terminalEditorService.instances.length===1&&(this._xterm=e,this._addon=this._register(this._instantiationService.createInstance(oe,this._ctx.instance.capabilities,this._chatAgentService.onDidChangeAgents)),this._xterm.raw.loadAddon(this._addon),this._register(this._addon.onDidRequestCreateHint(()=>this._createHint())))}_createHint(){const e=this._ctx.instance instanceof re?this._ctx.instance:void 0,t=e?.capabilities.get(D.CommandDetection);if(!e||!this._xterm||this._hintWidget||!t||t.promptInputModel.value||e.shellLaunchConfig.attachPersistentProcess||!this._configurationService.getValue(h.Enabled))return;if(!this._decoration){const i=this._xterm.raw.registerMarker();if(!i||this._xterm.raw.buffer.active.cursorX===0)return;this._register(i),this._decoration=this._xterm.raw.registerDecoration({marker:i,x:this._xterm.raw.buffer.active.cursorX+1}),this._decoration&&this._register(this._decoration)}this._register(this._xterm.raw.onKey(()=>this.dispose())),this._register(this._configurationService.onDidChangeConfiguration(i=>{i.affectsConfiguration(h.Enabled)&&!this._configurationService.getValue(h.Enabled)&&this.dispose()}));const n=t.promptInputModel;n&&this._register(n.onDidChangeInput(()=>{n.value&&this.dispose()})),this._decoration&&(this._register(this._decoration),this._register(this._decoration.onRender(i=>{if(!this._hintWidget&&this._xterm?.isFocused&&this._terminalGroupService.instances.length+this._terminalEditorService.instances.length===1){const r=this._chatAgentService.getActivatedAgents().filter(s=>s.locations.includes(x.Terminal));if(r?.length){const s=this._register(this._instantiationService.createInstance(f,e));if(this._addon?.dispose(),this._hintWidget=s.getDomNode(r),!this._hintWidget)return;i.appendChild(this._hintWidget),i.classList.add("terminal-initial-hint");const o=this._xterm.getFont();o&&(i.style.fontFamily=o.fontFamily,i.style.fontSize=o.fontSize+"px")}}if(this._hintWidget&&this._xterm){const r=this._hintWidget.parentElement;r&&(r.style.width=(this._xterm.raw.cols-this._xterm.raw.buffer.active.cursorX)/this._xterm.raw.cols*100+"%")}})))}};m=b([a(1,P),a(2,w),a(3,J),a(4,k),a(5,ee),a(6,te)],m),ne(m.ID,m,!1);let f=class extends y{constructor(e,t,n,i,r,s,o,_,I,c){super();this._instance=e;this._chatAgentService=t;this._commandService=n;this._configurationService=i;this._contextMenuService=r;this._keybindingService=s;this._productService=o;this._storageService=_;this._telemetryService=I;this._terminalService=c;this._toDispose.add(e.onDidFocus(()=>{this._instance.hasFocus&&this._isVisible&&this._ariaLabel&&this._configurationService.getValue(M.TerminalChat)&&V(this._ariaLabel)})),this._toDispose.add(c.onDidChangeInstances(()=>{this._terminalService.instances.length!==1&&this.dispose()})),this._toDispose.add(this._configurationService.onDidChangeConfiguration(u=>{u.affectsConfiguration(h.Enabled)&&!this._configurationService.getValue(h.Enabled)&&this.dispose()}))}_domNode;_toDispose=this._register(new L);_isVisible=!1;_ariaLabel="";_getHintInlineChat(e){let t=(e.length===1?e[0].fullName:void 0)??this._productService.nameShort;const n=this._chatAgentService.getDefaultAgent(x.Panel);n?.extensionId.value===e[0].extensionId.value&&(t=n.fullName??t);let i=`Ask ${t} something or start typing to dismiss.`;const r=()=>{this._storageService.store("terminal.initialHint.hide",!0,S.APPLICATION,N.USER),this._telemetryService.publicLog2("workbenchActionExecuted",{id:"terminalInlineChat.hintAction",from:"hint"}),this._commandService.executeCommand(T.Start,{from:"hint"})};this._toDispose.add(this._commandService.onDidExecuteCommand(c=>{c.commandId===T.Start&&(this._storageService.store("terminal.initialHint.hide",!0,S.APPLICATION,N.USER),this.dispose())}));const s={disposables:this._toDispose,callback:(c,u)=>{switch(c){case"0":r();break}}},o=C("div.terminal-initial-hint");o.style.display="block";const _=this._keybindingService.lookupKeybinding(T.Start),I=_?.getLabel();if(_&&I){const c=g("emptyHintText","Press {0} to ask {1} to do something. ",I,t),[u,R]=c.split(I).map(X=>{const H=C("a",void 0,X);return this._toDispose.add(l.addDisposableListener(H,l.EventType.CLICK,r)),H});o.appendChild(u);const v=s.disposables.add(new G(o,$));v.set(_),v.element.style.width="min-content",v.element.style.display="inline",v.element.style.cursor="pointer",this._toDispose.add(l.addDisposableListener(v.element,l.EventType.CLICK,r)),o.appendChild(R);const A=g("hintTextDismiss","Start typing to dismiss."),K=C("span.detail",void 0,A);o.appendChild(K),i=c.concat(A)}else{const c=g({key:"inlineChatHint",comment:["Preserve double-square brackets and their order"]},"[[Ask {0} to do something]] or start typing to dismiss.",t),u=F(c,{actionHandler:s});o.appendChild(u)}return{ariaLabel:i,hintHandler:s,hintElement:o}}getDomNode(e){if(!this._domNode){this._domNode=C(".terminal-initial-hint"),this._domNode.style.paddingLeft="4px";const{hintElement:t,ariaLabel:n}=this._getHintInlineChat(e);this._domNode.append(t),this._ariaLabel=n.concat(g("disableHint"," Toggle {0} in settings to disable this hint.",M.TerminalChat)),this._toDispose.add(l.addDisposableListener(this._domNode,"click",()=>{this._domNode?.remove(),this._domNode=void 0})),this._toDispose.add(l.addDisposableListener(this._domNode,l.EventType.CONTEXT_MENU,i=>{this._contextMenuService.showContextMenu({getAnchor:()=>new O(l.getActiveWindow(),i),getActions:()=>[{id:"workench.action.disableTerminalInitialHint",label:g("disableInitialHint","Disable Initial Hint"),tooltip:g("disableInitialHint","Disable Initial Hint"),enabled:!0,class:void 0,run:()=>this._configurationService.updateValue(h.Enabled,!1)}]})}))}return this._domNode}dispose(){this._domNode?.remove(),super.dispose()}};f=b([a(1,P),a(2,B),a(3,w),a(4,j),a(5,Q),a(6,Y),a(7,k),a(8,Z),a(9,ie)],f);export{oe as InitialHintAddon,m as TerminalInitialHintContribution};
