var f=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var C=(h,c,e,t)=>{for(var i=t>1?void 0:t?y(c,e):c,n=h.length-1,l;n>=0;n--)(l=h[n])&&(i=(t?l(c,e,i):l(i))||i);return t&&i&&f(c,e,i),i},d=(h,c)=>(e,t)=>c(e,t,h);import{CancellationTokenSource as I}from"../../../../../base/common/cancellation.js";import{Emitter as W,Event as v}from"../../../../../base/common/event.js";import{Lazy as x}from"../../../../../base/common/lazy.js";import{Disposable as S,DisposableStore as w,MutableDisposable as K,toDisposable as b}from"../../../../../base/common/lifecycle.js";import{IContextKeyService as P}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as R}from"../../../../../platform/instantiation/common/instantiation.js";import{IChatCodeBlockContextProviderService as k,showChatView as q}from"../../../chat/browser/chat.js";import{IChatService as A}from"../../../chat/common/chatService.js";import{isDetachedTerminalInstance as B,ITerminalService as T}from"../../../terminal/browser/terminal.js";import{TerminalChatWidget as D}from"./terminalChatWidget.js";import{createCancelablePromise as E,DeferredPromise as O}from"../../../../../base/common/async.js";import{assertType as _}from"../../../../../base/common/types.js";import{IStorageService as H,StorageScope as g,StorageTarget as V}from"../../../../../platform/storage/common/storage.js";import{IViewsService as F}from"../../../../services/views/common/viewsService.js";import{ChatAgentLocation as L}from"../../../chat/common/chatAgents.js";import"../../../chat/common/chatModel.js";import{TerminalChatContextKeys as u}from"./terminalChat.js";var M=(s=>(s[s.None=0]="None",s[s.AcceptSession=1]="AcceptSession",s[s.CancelSession=2]="CancelSession",s[s.PauseSession=4]="PauseSession",s[s.CancelRequest=8]="CancelRequest",s[s.CancelInput=16]="CancelInput",s[s.AcceptInput=32]="AcceptInput",s[s.ReturnInput=64]="ReturnInput",s))(M||{});let r=class extends S{constructor(e,t,i,n,l,o,s,p){super();this._ctx=e;this._chatService=i;this._contextKeyService=n;this._instantiationService=l;this._storageService=o;this._terminalService=s;this._viewsService=p;this._requestActiveContextKey=u.requestActive.bindTo(this._contextKeyService),this._responseContainsCodeBlockContextKey=u.responseContainsCodeBlock.bindTo(this._contextKeyService),this._responseContainsMulitpleCodeBlocksContextKey=u.responseContainsMultipleCodeBlocks.bindTo(this._contextKeyService),this._register(t.registerProvider({getCodeBlockContext:a=>{if(!(!a||!this._terminalChatWidget?.hasValue||!this.hasFocus()))return{element:a,code:a.getValue(),codeBlockIndex:0,languageId:a.getModel().getLanguageId()}}},"terminal")),r._promptHistory=JSON.parse(this._storageService.get(r._storageKey,g.PROFILE,"[]")),this._historyUpdate=a=>{const m=r._promptHistory.indexOf(a);m>=0&&r._promptHistory.splice(m,1),r._promptHistory.unshift(a),this._historyOffset=-1,this._historyCandidate="",this._storageService.store(r._storageKey,JSON.stringify(r._promptHistory),g.PROFILE,V.USER)}}static ID="terminal.chat";static get(e){return e.getContribution(r.ID)}static activeChatController;static _storageKey="terminal-inline-chat-history";static _promptHistory=[];_terminalChatWidget;get terminalChatWidget(){return this._terminalChatWidget?.value}get chatWidget(){return this._terminalChatWidget?.value.inlineChatWidget?.chatWidget}_requestActiveContextKey;_responseContainsCodeBlockContextKey;_responseContainsMulitpleCodeBlocksContextKey;_messages=this._store.add(new W);_lastResponseContent;get lastResponseContent(){return this._lastResponseContent}onDidAcceptInput=v.filter(this._messages.event,e=>e===32,this._store);get onDidHide(){return this.terminalChatWidget?.onDidHide??v.None}_terminalAgentName="terminal";_model=this._register(new K);get scopedContextKeyService(){return this._terminalChatWidget?.value.inlineChatWidget.scopedContextKeyService??this._contextKeyService}_sessionCtor;_historyOffset=-1;_historyCandidate="";_historyUpdate;_currentRequestId;_activeRequestCts;xtermReady(e){this._terminalChatWidget=new x(()=>{const t=this._register(this._instantiationService.createInstance(D,this._ctx.instance.domElement,this._ctx.instance,e));if(this._register(t.focusTracker.onDidFocus(()=>{r.activeChatController=this,B(this._ctx.instance)||this._terminalService.setActiveInstance(this._ctx.instance)})),this._register(t.focusTracker.onDidBlur(()=>{r.activeChatController=void 0,this._ctx.instance.resetScrollbarVisibility()})),!this._ctx.instance.domElement)throw new Error("FindWidget expected terminal DOM to be initialized");return t})}async _createSession(){this._sessionCtor=E(async e=>{if(!this._model.value&&(this._model.value=this._chatService.startSession(L.Terminal,e),!this._model.value))throw new Error("Failed to start chat session")}),this._register(b(()=>this._sessionCtor?.cancel()))}_forcedPlaceholder=void 0;_updatePlaceholder(){const e=this._terminalChatWidget?.value.inlineChatWidget;e&&(e.placeholder=this._getPlaceholderText())}_getPlaceholderText(){return this._forcedPlaceholder??""}setPlaceholder(e){this._forcedPlaceholder=e,this._updatePlaceholder()}resetPlaceholder(){this._forcedPlaceholder=void 0,this._updatePlaceholder()}clear(){this.cancel(),this._model.clear(),this._responseContainsCodeBlockContextKey.reset(),this._requestActiveContextKey.reset(),this._terminalChatWidget?.value.hide(),this._terminalChatWidget?.value.setValue(void 0)}async acceptInput(e){_(this._terminalChatWidget),this._model.value||await this.reveal(),_(this._model.value),this._messages.fire(32);const t=this._terminalChatWidget.value.inlineChatWidget.value;if(!t)return;const i=this._model.value;this._terminalChatWidget.value.inlineChatWidget.setChatModel(i),this._historyUpdate(t),this._activeRequestCts?.cancel(),this._activeRequestCts=new I;const n=new w;this._requestActiveContextKey.set(!0);let l="";const o=await this._terminalChatWidget.value.inlineChatWidget.chatWidget.acceptInput(t,e);this._currentRequestId=o?.requestId;const s=new O;try{return this._requestActiveContextKey.set(!0),o&&n.add(o.onDidChange(async()=>{if(l+=o.response.value,o.isCanceled){this._requestActiveContextKey.set(!1),s.complete(void 0);return}if(o.isComplete){this._requestActiveContextKey.set(!1),this._requestActiveContextKey.set(!1);const p=await this.terminalChatWidget?.inlineChatWidget.getCodeBlockInfo(0),a=await this.terminalChatWidget?.inlineChatWidget.getCodeBlockInfo(1);this._responseContainsCodeBlockContextKey.set(!!p),this._responseContainsMulitpleCodeBlocksContextKey.set(!!a),this._terminalChatWidget?.value.inlineChatWidget.updateToolbar(!0),s.complete(o)}})),await s.p,this._lastResponseContent=o?.response.toMarkdown(),o}catch{this._lastResponseContent=void 0;return}finally{n.dispose()}}updateInput(e,t=!0){const i=this._terminalChatWidget?.value.inlineChatWidget;i&&(i.value=e,t&&i.selectAll())}getInput(){return this._terminalChatWidget?.value.input()??""}focus(){this._terminalChatWidget?.value.focus()}hasFocus(){return this._terminalChatWidget?.rawValue?.hasFocus()??!1}populateHistory(e){if(!this._terminalChatWidget?.value)return;const t=r._promptHistory.length;if(t===0)return;this._historyOffset===-1&&(this._historyCandidate=this._terminalChatWidget.value.inlineChatWidget.value);const i=this._historyOffset+(e?1:-1);if(i>=t)return;let n;i<0?(n=this._historyCandidate,this._historyOffset=-1):(n=r._promptHistory[i],this._historyOffset=i),this._terminalChatWidget.value.inlineChatWidget.value=n,this._terminalChatWidget.value.inlineChatWidget.selectAll()}cancel(){this._sessionCtor?.cancel(),this._sessionCtor=void 0,this._activeRequestCts?.cancel(),this._requestActiveContextKey.set(!1);const e=this._terminalChatWidget?.value.inlineChatWidget.getChatModel();e?.sessionId&&this._chatService.cancelCurrentRequestForSession(e?.sessionId)}async acceptCommand(e){const t=await this.terminalChatWidget?.inlineChatWidget.getCodeBlockInfo(0);t&&this._terminalChatWidget?.value.acceptCommand(t.textEditorModel.getValue(),e)}async reveal(){await this._createSession(),this._terminalChatWidget?.value.reveal(),this._terminalChatWidget?.value.focus()}async viewInChat(){const e=await q(this._viewsService),t=this.terminalChatWidget?.inlineChatWidget.chatWidget.viewModel?.model.getRequests().find(n=>n.id===this._currentRequestId);if(!e||!t?.response)return;const i=[];for(const n of t.response.response.value)if(n.kind==="textEditGroup")for(const l of n.edits)i.push({kind:"textEdit",edits:l,uri:n.uri});else i.push(n);this._chatService.addCompleteRequest(e.viewModel.sessionId,`@${this._terminalAgentName} ${t.message.text}`,t.variableData,t.attempt,{message:i,result:t.response.result,followups:t.response.followups}),e.focusLastMessage(),this._terminalChatWidget?.rawValue?.hide()}};r=C([d(1,k),d(2,A),d(3,P),d(4,R),d(5,H),d(6,T),d(7,F)],r);export{r as TerminalChatController};
