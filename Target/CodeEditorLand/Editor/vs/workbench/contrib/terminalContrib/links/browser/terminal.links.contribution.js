var I=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var L=(r,a,n,e)=>{for(var i=e>1?void 0:e?_(a,n):a,l=r.length-1,m;l>=0;l--)(m=r[l])&&(i=(e?m(a,n,i):m(i))||i);return e&&i&&I(a,n,i),i},k=(r,a)=>(n,e)=>a(n,e,r);import{Event as b}from"../../../../../base/common/event.js";import{KeyCode as v,KeyMod as o}from"../../../../../base/common/keyCodes.js";import{DisposableStore as C}from"../../../../../base/common/lifecycle.js";import{localize2 as s}from"../../../../../nls.js";import{AccessibleViewProviderId as w}from"../../../../../platform/accessibility/browser/accessibleView.js";import{ContextKeyExpr as g}from"../../../../../platform/contextkey/common/contextkey.js";import{InstantiationType as y,registerSingleton as T}from"../../../../../platform/instantiation/common/extensions.js";import{IInstantiationService as x}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as u}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{accessibleViewCurrentProviderId as P,accessibleViewIsShown as M}from"../../../accessibility/browser/accessibilityConfiguration.js";import{isDetachedTerminalInstance as S}from"../../../terminal/browser/terminal.js";import{registerActiveInstanceAction as d}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as R}from"../../../terminal/browser/terminalExtensions.js";import{isTerminalProcessManager as D}from"../../../terminal/common/terminal.js";import{TerminalContextKeys as c}from"../../../terminal/common/terminalContextKey.js";import{terminalStrings as Q}from"../../../terminal/common/terminalStrings.js";import{TerminalLinksCommandId as p}from"../common/terminal.links.js";import{ITerminalLinkProviderService as f}from"./links.js";import{TerminalLinkManager as O}from"./terminalLinkManager.js";import{TerminalLinkProviderService as K}from"./terminalLinkProviderService.js";import{TerminalLinkQuickpick as W}from"./terminalLinkQuickpick.js";import{TerminalLinkResolver as F}from"./terminalLinkResolver.js";T(f,K,y.Delayed);let t=class extends C{constructor(n,e,i){super();this._ctx=n;this._instantiationService=e;this._terminalLinkProviderService=i;this._linkResolver=this._instantiationService.createInstance(F)}static ID="terminal.link";static get(n){return n.getContribution(t.ID)}_linkManager;_terminalLinkQuickpick;_linkResolver;xtermReady(n){const e=this._linkManager=this.add(this._instantiationService.createInstance(O,n.raw,this._ctx.processManager,this._ctx.instance.capabilities,this._linkResolver));if(D(this._ctx.processManager)){const i=e.add(b.once(this._ctx.processManager.onProcessReady)(()=>{e.setWidgetManager(this._ctx.widgetManager),this.delete(i)}))}else e.setWidgetManager(this._ctx.widgetManager);if(!S(this._ctx.instance)){for(const i of this._terminalLinkProviderService.linkProviders)e.externalProvideLinksCb=i.provideLinks.bind(i,this._ctx.instance);e.add(this._terminalLinkProviderService.onDidAddLinkProvider(i=>{e.externalProvideLinksCb=i.provideLinks.bind(i,this._ctx.instance)}))}e.add(this._terminalLinkProviderService.onDidRemoveLinkProvider(()=>e.externalProvideLinksCb=void 0))}async showLinkQuickpick(n){this._terminalLinkQuickpick||(this._terminalLinkQuickpick=this.add(this._instantiationService.createInstance(W)),this._terminalLinkQuickpick.onDidRequestMoreLinks(()=>{this.showLinkQuickpick(!0)}));const e=await this._getLinks();return await this._terminalLinkQuickpick.show(this._ctx.instance,e)}async _getLinks(){if(!this._linkManager)throw new Error("terminal links are not ready, cannot generate link quick pick");return this._linkManager.getLinks()}async openRecentLink(n){if(!this._linkManager)throw new Error("terminal links are not ready, cannot open a link");this._linkManager.openRecentLink(n)}};t=L([k(1,x),k(2,f)],t),R(t.ID,t,!0);const h=Q.actionCategory;d({id:p.OpenDetectedLink,title:s("workbench.action.terminal.openDetectedLink","Open Detected Link..."),f1:!0,category:h,precondition:c.terminalHasBeenCreated,keybinding:[{primary:o.CtrlCmd|o.Shift|v.KeyO,weight:u.WorkbenchContrib+1,when:c.focus},{primary:o.CtrlCmd|o.Shift|v.KeyG,weight:u.WorkbenchContrib+1,when:g.and(M,g.equals(P.key,w.Terminal))}],run:r=>t.get(r)?.showLinkQuickpick()}),d({id:p.OpenWebLink,title:s("workbench.action.terminal.openLastUrlLink","Open Last URL Link"),metadata:{description:s("workbench.action.terminal.openLastUrlLink.description","Opens the last detected URL/URI link in the terminal")},f1:!0,category:h,precondition:c.terminalHasBeenCreated,run:r=>t.get(r)?.openRecentLink("url")}),d({id:p.OpenFileLink,title:s("workbench.action.terminal.openLastLocalFileLink","Open Last Local File Link"),f1:!0,category:h,precondition:c.terminalHasBeenCreated,run:r=>t.get(r)?.openRecentLink("localFile")});
