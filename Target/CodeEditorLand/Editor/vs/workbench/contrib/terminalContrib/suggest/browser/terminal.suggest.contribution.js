var _=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var w=(o,g,i,s)=>{for(var t=s>1?void 0:s?x(g,i):g,a=o.length-1,d;a>=0;a--)(d=o[a])&&(t=(s?d(g,i,t):d(t))||t);return s&&t&&_(g,i,t),t},C=(o,g)=>(i,s)=>g(i,s,o);import*as T from"../../../../../base/browser/dom.js";import{AutoOpenBarrier as W}from"../../../../../base/common/async.js";import{Event as A}from"../../../../../base/common/event.js";import{KeyCode as c,KeyMod as v}from"../../../../../base/common/keyCodes.js";import{DisposableStore as K,MutableDisposable as O,toDisposable as k}from"../../../../../base/common/lifecycle.js";import{isWindows as E}from"../../../../../base/common/platform.js";import{localize2 as l}from"../../../../../nls.js";import{CONTEXT_ACCESSIBILITY_MODE_ENABLED as N}from"../../../../../platform/accessibility/common/accessibility.js";import{IConfigurationService as V}from"../../../../../platform/configuration/common/configuration.js";import{ContextKeyExpr as r,IContextKeyService as D}from"../../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService as R}from"../../../../../platform/instantiation/common/instantiation.js";import{KeybindingWeight as u}from"../../../../../platform/keybinding/common/keybindingsRegistry.js";import{IStorageService as B,StorageScope as b,StorageTarget as H}from"../../../../../platform/storage/common/storage.js";import{GeneralShellType as q,TerminalLocation as X,TerminalSettingId as L}from"../../../../../platform/terminal/common/terminal.js";import{ShellIntegrationOscPs as M}from"../../../../../platform/terminal/common/xterm/shellIntegrationAddon.js";import"../../../../services/suggest/browser/simpleCompletionItem.js";import"../../../terminal/browser/terminal.js";import{registerActiveInstanceAction as m}from"../../../terminal/browser/terminalActions.js";import{registerTerminalContribution as J}from"../../../terminal/browser/terminalExtensions.js";import{registerSendSequenceKeybinding as z}from"../../../terminal/browser/terminalKeybindings.js";import{TERMINAL_CONFIG_SECTION as F}from"../../../terminal/common/terminal.js";import{TerminalContextKeys as e,TerminalContextKeyStrings as G}from"../../../terminal/common/terminalContextKey.js";import{TerminalSuggestCommandId as p}from"../common/terminal.suggest.js";import{terminalSuggestConfigSection as I,TerminalSuggestSettingId as y}from"../common/terminalSuggestConfiguration.js";import{parseCompletionsFromShell as U,SuggestAddon as $,VSCodeSuggestOscPt as Y}from"./terminalSuggestAddon.js";import{TerminalClipboardContribution as j}from"../../clipboard/browser/terminal.clipboard.contribution.js";var Q=(g=>(g.CachedPwshCommandsStorageKey="terminal.suggest.pwshCommands",g))(Q||{});let n=class extends K{constructor(i,s,t,a,d){super();this._ctx=i;this._contextKeyService=s;this._configurationService=t;this._instantiationService=a;this._storageService=d;if(this.add(k(()=>this._addon?.dispose())),this._terminalSuggestWidgetVisibleContextKey=e.suggestWidgetVisible.bindTo(this._contextKeyService),n._cachedPwshCommands.size===0){const S=this._storageService.get("terminal.suggest.pwshCommands",b.APPLICATION,void 0);if(S!==void 0){const f=JSON.parse(S);for(const h of f)n._cachedPwshCommands.add(h)}}this.add(this._configurationService.onDidChangeConfiguration(S=>{S.affectsConfiguration(y.Enabled)&&this.clearSuggestCache()}))}static ID="terminal.suggest";static get(i){return i.getContribution(n.ID)}_xterm;_addon=new O;_terminalSuggestWidgetContextKeys=new Set(e.suggestWidgetVisible.key);_terminalSuggestWidgetVisibleContextKey;get addon(){return this._addon.value}static _cachedPwshCommands=new Set;xtermReady(i){this._xterm=i.raw,this._configurationService.getValue(I).enabled&&this.add(i.raw.parser.registerOscHandler(M.VSCode,a=>this._handleVSCodeSequence(a)))}_handleVSCodeSequence(i){if(!this._xterm)return!1;const[s,...t]=i.split(";");switch(s){case Y.CompletionsPwshCommands:return this._handleCompletionsPwshCommandsSequence(this._xterm,i,s,t)}return!1}async _handleCompletionsPwshCommandsSequence(i,s,t,a){const d=a[0],S=JSON.parse(s.slice(t.length+d.length+2)),f=U(S),h=n._cachedPwshCommands;h.clear();for(const P of f)h.add(P);return this._storageService.store("terminal.suggest.pwshCommands",JSON.stringify(Array.from(h.values())),b.APPLICATION,H.MACHINE),!0}clearSuggestCache(){n._cachedPwshCommands.clear(),this._storageService.remove("terminal.suggest.pwshCommands",b.APPLICATION)}xtermOpen(i){this._configurationService.getValue(I).enabled&&(this.add(A.runAndSubscribe(this._ctx.instance.onDidChangeShellType,async()=>{this._loadSuggestAddon(i.raw)})),this.add(this._contextKeyService.onDidChangeContext(a=>{a.affectsSome(this._terminalSuggestWidgetContextKeys)&&this._loadSuggestAddon(i.raw)})),this.add(this._configurationService.onDidChangeConfiguration(a=>{a.affectsConfiguration(L.SendKeybindingsToShell)&&this._loadSuggestAddon(i.raw)})))}_loadSuggestAddon(i){if(this._configurationService.getValue(F).sendKeybindingsToShell||this._ctx.instance.shellType!=="pwsh"){this._addon.clear();return}if(this._terminalSuggestWidgetVisibleContextKey){const t=this._addon.value=this._instantiationService.createInstance($,n._cachedPwshCommands,this._ctx.instance.capabilities,this._terminalSuggestWidgetVisibleContextKey);i.loadAddon(t),this._ctx.instance.target===X.Editor?t.setContainerWithOverflow(i.element):t.setContainerWithOverflow(T.findParentWithClass(i.element,"panel")),t.setScreen(i.element.querySelector(".xterm-screen")),this.add(this._ctx.instance.onDidBlur(()=>t.hideSuggestWidget())),this.add(t.onAcceptedCompletion(async d=>{this._ctx.instance.focus(),this._ctx.instance.sendText(d,!1)}));const a=j.get(this._ctx.instance);if(this.add(a.onWillPaste(()=>t.isPasting=!0)),this.add(a.onDidPaste(()=>{setTimeout(()=>t.isPasting=!1,100)})),!E){let d;this.add(t.onDidRequestCompletions(()=>{d=new W(2e3),this._ctx.instance.pauseInputEvents(d)})),this.add(t.onDidReceiveCompletions(()=>{d?.open(),d=void 0}))}}}};n=w([C(1,D),C(2,V),C(3,R),C(4,B)],n),J(n.ID,n),z("\x1B[24~e",{when:r.and(e.focus,r.equals(G.ShellType,q.PowerShell),e.terminalShellIntegrationEnabled,N.negate(),r.equals(`config.${y.Enabled}`,!0)),primary:v.CtrlCmd|c.Space,mac:{primary:v.WinCtrl|c.Space}}),m({id:p.SelectPrevSuggestion,title:l("workbench.action.terminal.selectPrevSuggestion","Select the Previous Suggestion"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.UpArrow,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectPreviousSuggestion()}),m({id:p.SelectPrevPageSuggestion,title:l("workbench.action.terminal.selectPrevPageSuggestion","Select the Previous Page Suggestion"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.PageUp,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectPreviousPageSuggestion()}),m({id:p.SelectNextSuggestion,title:l("workbench.action.terminal.selectNextSuggestion","Select the Next Suggestion"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.DownArrow,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectNextSuggestion()}),m({id:p.SelectNextPageSuggestion,title:l("workbench.action.terminal.selectNextPageSuggestion","Select the Next Page Suggestion"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.PageDown,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.selectNextPageSuggestion()}),m({id:p.AcceptSelectedSuggestion,title:l("workbench.action.terminal.acceptSelectedSuggestion","Accept Selected Suggestion"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.Tab,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.acceptSelectedSuggestion()}),m({id:p.AcceptSelectedSuggestionEnter,title:l("workbench.action.terminal.acceptSelectedSuggestionEnter","Accept Selected Suggestion (Enter)"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.Enter,weight:u.WorkbenchContrib+1,when:r.notEquals(`config.${y.RunOnEnter}`,"ignore")},run:o=>n.get(o)?.addon?.acceptSelectedSuggestion(void 0,!0)}),m({id:p.HideSuggestWidget,title:l("workbench.action.terminal.hideSuggestWidget","Hide Suggest Widget"),f1:!1,precondition:r.and(r.or(e.processSupported,e.terminalHasBeenCreated),e.focus,e.isOpen,e.suggestWidgetVisible),keybinding:{primary:c.Escape,weight:u.WorkbenchContrib+1},run:o=>n.get(o)?.addon?.hideSuggestWidget()}),m({id:p.ClearSuggestCache,title:l("workbench.action.terminal.clearSuggestCache","Clear Suggest Cache"),f1:!0,run:o=>n.get(o)?.clearSuggestCache()});
