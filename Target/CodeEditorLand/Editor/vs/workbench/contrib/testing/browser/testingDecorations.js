var me=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var x=(f,t,e,o)=>{for(var r=o>1?void 0:o?fe(t,e):t,s=f.length-1,a;s>=0;s--)(a=f[s])&&(r=(o?a(t,e,r):a(r))||r);return o&&r&&me(t,e,r),r},u=(f,t)=>(e,o)=>t(e,o,f);import*as R from"../../../../base/browser/dom.js";import{StandardKeyboardEvent as X}from"../../../../base/browser/keyboardEvent.js";import{Action as E,Separator as Y,SubmenuAction as he}from"../../../../base/common/actions.js";import{equals as Ie}from"../../../../base/common/arrays.js";import{RunOnceScheduler as ve}from"../../../../base/common/async.js";import{Emitter as be,Event as W}from"../../../../base/common/event.js";import{MarkdownString as _}from"../../../../base/common/htmlContent.js";import{stripIcons as ye}from"../../../../base/common/iconLabels.js";import{Iterable as Ce}from"../../../../base/common/iterator.js";import{KeyCode as G}from"../../../../base/common/keyCodes.js";import{Disposable as J,DisposableStore as ee,MutableDisposable as te}from"../../../../base/common/lifecycle.js";import{ResourceMap as Se}from"../../../../base/common/map.js";import{clamp as Te}from"../../../../base/common/numbers.js";import{isMacintosh as Me}from"../../../../base/common/platform.js";import{ThemeIcon as ie}from"../../../../base/common/themables.js";import{Constants as De}from"../../../../base/common/uint.js";import"../../../../base/common/uri.js";import{generateUuid as ne}from"../../../../base/common/uuid.js";import{ContentWidgetPositionPreference as xe,MouseTargetType as we}from"../../../../editor/browser/editorBrowser.js";import{ICodeEditorService as k}from"../../../../editor/browser/services/codeEditorService.js";import{EditorOption as S}from"../../../../editor/common/config/editorOptions.js";import{overviewRulerError as Ee,overviewRulerInfo as ke}from"../../../../editor/common/core/editorColorRegistry.js";import"../../../../editor/common/core/range.js";import"../../../../editor/common/editorCommon.js";import{GlyphMarginLane as Ae,OverviewRulerLane as Re,TrackedRangeStickiness as oe}from"../../../../editor/common/model.js";import{IModelService as Le}from"../../../../editor/common/services/model.js";import{localize as h}from"../../../../nls.js";import{createAndFillInContextMenuActions as Ue}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as B,MenuId as Ne}from"../../../../platform/actions/common/actions.js";import{ICommandService as $}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as O}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as K}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as z}from"../../../../platform/contextview/browser/contextView.js";import{IInstantiationService as Fe}from"../../../../platform/instantiation/common/instantiation.js";import{IQuickInputService as _e}from"../../../../platform/quickinput/common/quickInput.js";import{themeColorFromId as Oe}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as Pe}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{EditorLineNumberContextMenu as We,GutterActionsRegistry as Ge}from"../../codeEditor/browser/editorLineNumberMenu.js";import{DefaultGutterClickAction as T,TestingConfigKeys as w,getTestingConfiguration as A}from"../common/configuration.js";import{Testing as Be,labelForTestInState as $e}from"../common/constants.js";import{TestId as Ke}from"../common/testId.js";import{ITestProfileService as V}from"../common/testProfileService.js";import{LiveTestResult as ze}from"../common/testResult.js";import{ITestResultService as Ve}from"../common/testResultService.js";import{ITestService as L,getContextForTestItem as je,simplifyTestsToExecute as Ze,testsInFile as He}from"../common/testService.js";import{TestDiffOpType as Qe,TestMessageType as j,TestResultState as Z,TestRunProfileBitset as y}from"../common/testTypes.js";import{ITestingDecorationsService as qe,TestDecorations as Xe}from"../common/testingDecorations.js";import{ITestingPeekOpener as Ye}from"../common/testingPeekOpener.js";import{isFailedState as Je,maxPriority as et}from"../common/testingStates.js";import{TestUriType as H,buildTestUri as tt,parseTestUri as it}from"../common/testingUri.js";import{getTestItemContextOverlay as nt}from"./explorerProjections/testItemContextOverlay.js";import{testingDebugAllIcon as ot,testingDebugIcon as rt,testingRunAllIcon as re,testingRunIcon as se,testingStatesToIcons as st}from"./icons.js";import{renderTestMessageAsText as at}from"./testMessageColorizer.js";const ae=128,ce=30,le=Ae.Center;function ct(f,t){const e=f.listDiffEditors();for(const o of e)if(o.getOriginalEditor()===t)return!0;return!1}class Q{runByIdKey=new Map;messages=new Map;get size(){return this.runByIdKey.size+this.messages.size}getForExactTests(t){const e=t.sort().join("\0\0");return this.runByIdKey.get(e)}getMessage(t){return this.messages.get(t)}removeMessage(t){this.messages.delete(t)}addMessage(t){this.messages.set(t.testMessage,t)}addTest(t){const e=t.testIds.sort().join("\0\0");this.runByIdKey.set(e,t)}getById(t){for(const e of this.runByIdKey.values())if(e.id===t)return e;for(const e of this.messages.values())if(e.id===t)return e}*[Symbol.iterator](){for(const t of this.runByIdKey.values())yield t;for(const t of this.messages.values())yield t}}let P=class extends J{constructor(e,o,r,s,a,c){super();this.configurationService=o;this.testService=r;this.results=s;this.instantiationService=a;this.modelService=c;e.registerDecorationType("test-message-decoration",C.decorationId,{},void 0),this._register(c.onModelRemoved(i=>this.decorationCache.delete(i.uri)));const g=this._register(new ve(()=>this.invalidate(),100));this._register(this.testService.onWillProcessDiff(i=>{for(const n of i){if(n.op!==Qe.DocumentSynced)continue;const d=this.decorationCache.get(n.uri);d&&(d.rangeUpdateVersionId=n.docv)}g.isScheduled()||g.schedule()})),this._register(W.any(this.results.onResultsChanged,this.results.onTestChanged,this.testService.excluded.onTestExclusionsChanged,this.testService.showInlineOutput.onDidChange,W.filter(o.onDidChangeConfiguration,i=>i.affectsConfiguration(w.GutterEnabled)))(()=>{g.isScheduled()||g.schedule()})),this._register(Ge.registerGutterActionsGenerator((i,n)=>{const d=i.editor.getModel(),l=U.get(i.editor);if(!d||!l?.currentUri)return;const p=this.syncDecorations(l.currentUri);if(!p.size)return;const m=d.getLinesDecorations(i.lineNumber,i.lineNumber);for(const{id:I}of m){const v=p.getById(I);if(v){const{object:b}=v.getContextMenuActions();for(const D of b)n.push(D,"1_testing")}}}))}generation=0;changeEmitter=new be;decorationCache=new Se;invalidatedMessages=new WeakSet;onDidChange=this.changeEmitter.event;invalidateResultMessage(e){this.invalidatedMessages.add(e),this.invalidate()}syncDecorations(e){const o=this.modelService.getModel(e);if(!o)return new Q;const r=this.decorationCache.get(e);return r&&r.generation===this.generation&&(r.rangeUpdateVersionId===void 0||r.rangeUpdateVersionId!==o.getVersionId())?r.value:this.applyDecorations(o)}getDecoratedTestPosition(e,o){const r=this.modelService.getModel(e);if(!r)return;const s=Ce.find(this.syncDecorations(e),a=>a instanceof M&&a.isForTest(o));if(s)return r.getDecorationRange(s.id)?.getStartPosition()}invalidate(){this.generation++,this.changeEmitter.fire()}updateDecorationsAlternateAction(e,o){const r=this.modelService.getModel(e),s=this.decorationCache.get(e);!r||!s||s.isAlt===o||(s.isAlt=o,r.changeDecorations(a=>{for(const c of s.value)c instanceof M&&c.editorDecoration.alternate&&a.changeDecorationOptions(c.id,o?c.editorDecoration.alternate:c.editorDecoration.options)}))}applyDecorations(e){const o=A(this.configurationService,w.GutterEnabled),r=e.uri.toString(),s=this.decorationCache.get(e.uri),a=s?.rangeUpdateVersionId===e.getVersionId(),c=s?.value??new Q;return e.changeDecorations(i=>{const n=new Q,d=new Xe;for(const m of this.testService.collection.getNodeByUrl(e.uri)){if(!m.item.range)continue;const I=this.results.getStateById(m.item.extId),v=m.item.range.startLineNumber;d.push({line:v,id:"",test:m,resultItem:I?.[1]})}for(const[m,I]of d.lines()){const v=I.length>1;let b=c.getForExactTests(I.map(D=>D.test.item.extId));b&&a&&e.getDecorationRange(b.id)?.startLineNumber!==m&&(b=void 0),b?(b.replaceOptions(I,o)&&i.changeDecorationOptions(b.id,b.editorDecoration.options),n.addTest(b)):n.addTest(v?this.instantiationService.createInstance(N,I,o,e):this.instantiationService.createInstance(F,I[0].test,I[0].resultItem,e,o))}const l=new Set;A(this.configurationService,w.ShowAllMessages)?this.results.results.forEach(m=>this.applyDecorationsFromResult(m,l,r,c,e,n)):this.applyDecorationsFromResult(this.results.results[0],l,r,c,e,n);const p=new Set;for(const m of n)m.id===""?m.id=i.addDecoration(m.editorDecoration.range,m.editorDecoration.options):p.add(m.id);for(const m of c)p.has(m.id)||i.removeDecoration(m.id);return this.decorationCache.set(e.uri,{generation:this.generation,rangeUpdateVersionId:s?.rangeUpdateVersionId,value:n}),n})||c}applyDecorationsFromResult(e,o,r,s,a,c){if(this.testService.showInlineOutput.value&&e instanceof ze){for(const g of e.tasks)for(const i of g.otherMessages)if(!this.invalidatedMessages.has(i)&&i.location?.uri.toString()===r){const n=s.getMessage(i)||this.instantiationService.createInstance(C,i,void 0,a);c.addMessage(n)}for(const g of e.tests)for(let i=0;i<g.tasks.length;i++){const n=g.tasks[i];for(const d of[j.Error,j.Output])for(let l=0;l<n.messages.length;l++){const p=n.messages[l];if(p.type!==d||this.invalidatedMessages.has(p)||p.location?.uri.toString()!==r)continue;const m=p.location.range.startLineNumber;if(!o.has(m)){const I=s.getMessage(p)||this.instantiationService.createInstance(C,p,tt({type:H.ResultActualOutput,messageIndex:l,taskIndex:i,resultId:e.id,testExtId:g.item.extId}),a);c.addMessage(I),o.add(m)}}}}}};P=x([u(0,k),u(1,O),u(2,L),u(3,Ve),u(4,Fe),u(5,Le)],P);let U=class extends J{constructor(e,o,r,s,a){super();this.editor=e;this.codeEditorService=o;this.testService=r;this.decorations=s;this.uriIdentityService=a;o.registerDecorationType("test-message-decoration",C.decorationId,{},void 0,e),this.attachModel(e.getModel()?.uri),this._register(s.onDidChange(()=>{this._currentUri&&s.syncDecorations(this._currentUri)}));const c=R.getWindow(e.getDomNode());this._register(R.addDisposableListener(c,"keydown",i=>{new X(i).keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!0)})),this._register(R.addDisposableListener(c,"keyup",i=>{new X(i).keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(R.addDisposableListener(c,"blur",()=>{this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(this.editor.onKeyUp(i=>{i.keyCode===G.Alt&&this._currentUri&&s.updateDecorationsAlternateAction(this._currentUri,!1)})),this._register(this.editor.onDidChangeModel(i=>this.attachModel(i.newModelUrl||void 0))),this._register(this.editor.onMouseDown(i=>{if(i.target.position&&this.currentUri){const n=e.getModel()?.getLineDecorations(i.target.position.lineNumber)??[];if(!n.length)return;const d=s.syncDecorations(this.currentUri);for(const{id:l}of n)if(d.getById(l)?.click(i)){i.event.stopPropagation();return}}})),this._register(W.accumulate(this.editor.onDidChangeModelContent,0,this._store)(i=>{const n=e.getModel();if(!this._currentUri||!n)return;const d=s.syncDecorations(this._currentUri);if(d.size)for(const l of i)for(const p of l.changes){const m=n.getLinesDecorations(p.range.startLineNumber,p.range.endLineNumber);for(const{id:I}of m){const v=d.getById(I);v instanceof C&&s.invalidateResultMessage(v.testMessage)}}}));const g=()=>{this.editor.getContainerDomNode().style.setProperty("--testMessageDecorationFontFamily",e.getOption(S.fontFamily)),this.editor.getContainerDomNode().style.setProperty("--testMessageDecorationFontSize",`${e.getOption(S.fontSize)}px`)};this._register(this.editor.onDidChangeConfiguration(i=>{i.hasChanged(S.fontFamily)&&g()})),g()}static get(e){return e.getContribution(Be.DecorationsContributionId)}get currentUri(){return this._currentUri}_currentUri;expectedWidget=new te;actualWidget=new te;attachModel(e){switch(e&&it(e)?.type){case H.ResultExpectedOutput:this.expectedWidget.value=new dt(this.editor),this.actualWidget.clear();break;case H.ResultActualOutput:this.expectedWidget.clear(),this.actualWidget.value=new ut(this.editor);break;default:this.expectedWidget.clear(),this.actualWidget.clear()}ct(this.codeEditorService,this.editor)&&(e=void 0),this._currentUri=e,e&&(this.decorations.syncDecorations(e),(async()=>{for await(const o of He(this.testService,this.uriIdentityService,e,!1))if(this._currentUri!==e)break})())}};U=x([u(1,k),u(2,L),u(3,qe),u(4,Pe)],U);const de=f=>({startLineNumber:f.startLineNumber,endLineNumber:f.startLineNumber,startColumn:f.startColumn,endColumn:f.startColumn}),ue=(f,t,e,o)=>{const r=f[0]?.item.range;if(!r)throw new Error("Test decorations can only be created for tests with a range");if(!e)return{range:de(r),options:{isWholeLine:!0,description:"run-test-decoration"}};let s=Z.Unset;const a=[];let c,g=!1;for(let v=0;v<f.length;v++){const b=f[v],D=t[v],q=D?.computedState??Z.Unset;a.length<10&&a.push($e(b.item.label,q)),s=et(s,q),g=g||!!D?.retired,!c&&D?.tasks.some(pe=>pe.messages.length)&&(c=b.item.extId)}const i=f.length>1||f[0].children.size>0,n=s===Z.Unset?i?re:se:st.get(s),d=o===T.Debug?i?re:se:i?ot:rt;let l,p="testing-run-glyph";g&&(p+=" retired");const m={description:"run-test-decoration",showIfCollapsed:!0,get hoverMessage(){if(!l){const v=l=new _("",!0).appendText(a.join(", ")+".");if(c){const b=encodeURIComponent(JSON.stringify([c]));v.appendMarkdown(` [${h("peekTestOutout","Peek Test Output")}](command:vscode.peekTestError?${b})`)}}return l},glyphMargin:{position:le},glyphMarginClassName:`${ie.asClassName(n)} ${p}`,stickiness:oe.NeverGrowsWhenTypingAtEdges,zIndex:1e4},I={...m,glyphMarginClassName:`${ie.asClassName(d)} ${p}`};return{range:de(r),options:m,alternate:I}};var lt=(e=>(e.FontFamily="testingDiffLensFontFamily",e.FontFeatures="testingDiffLensFontFeatures",e))(lt||{});class ge{constructor(t){this.editor=t;queueMicrotask(()=>{this.applyStyling(),this.editor.addContentWidget(this)})}allowEditorOverflow=!1;suppressMouseDown=!0;_domNode=R.$("span");viewZoneId;applyStyling(){let t=this.editor.getOption(S.codeLensFontSize),e;!t||t<5?(t=this.editor.getOption(S.fontSize)*.9|0,e=this.editor.getOption(S.lineHeight)):e=t*Math.max(1.3,this.editor.getOption(S.lineHeight)/this.editor.getOption(S.fontSize))|0;const o=this.editor.getOption(S.fontInfo),r=this._domNode;r.classList.add("testing-diff-lens-widget"),r.textContent=this.getText(),r.style.lineHeight=`${e}px`,r.style.fontSize=`${t}px`,r.style.fontFamily="var(--testingDiffLensFontFamily)",r.style.fontFeatureSettings="var(--testingDiffLensFontFeatures)";const s=this.editor.getContainerDomNode().style;s.setProperty("testingDiffLensFontFamily",this.editor.getOption(S.codeLensFontFamily)??"inherit"),s.setProperty("testingDiffLensFontFeatures",o.fontFeatureSettings),this.editor.changeViewZones(a=>{this.viewZoneId&&a.removeZone(this.viewZoneId),this.viewZoneId=a.addZone({afterLineNumber:0,afterColumn:De.MAX_SAFE_SMALL_INTEGER,domNode:document.createElement("div"),heightInPx:20})})}getDomNode(){return this._domNode}dispose(){this.editor.changeViewZones(t=>{this.viewZoneId&&t.removeZone(this.viewZoneId)}),this.editor.removeContentWidget(this)}getPosition(){return{position:{column:0,lineNumber:0},preference:[xe.ABOVE]}}}class dt extends ge{getId(){return"expectedTestingLens"}getText(){return h("expected.title","Expected")}}class ut extends ge{getId(){return"actualTestingLens"}getText(){return h("actual.title","Actual")}}let M=class{constructor(t,e,o,r,s,a,c,g,i,n,d){this.tests=t;this.visible=e;this.model=o;this.codeEditorService=r;this.testService=s;this.contextMenuService=a;this.commandService=c;this.configurationService=g;this.testProfileService=i;this.contextKeyService=n;this.menuService=d;this.displayedStates=t.map(l=>l.resultItem?.computedState),this.editorDecoration=ue(t.map(l=>l.test),t.map(l=>l.resultItem),e,A(this.configurationService,w.DefaultGutterClickAction)),this.editorDecoration.options.glyphMarginHoverMessage=new _().appendText(this.getGutterLabel())}id="";get line(){return this.editorDecoration.range.startLineNumber}get testIds(){return this.tests.map(t=>t.test.item.extId)}editorDecoration;displayedStates;click(t){if(t.target.type!==we.GUTTER_GLYPH_MARGIN||t.target.detail.glyphMarginLane!==le||t.event.rightButton||Me&&t.event.leftButton&&t.event.ctrlKey)return!1;const e=t.event.altKey;switch(A(this.configurationService,w.DefaultGutterClickAction)){case T.ContextMenu:this.showContextMenu(t);break;case T.Debug:this.runWith(e?y.Run:y.Debug);break;case T.Coverage:this.runWith(e?y.Debug:y.Coverage);break;case T.Run:default:this.runWith(e?y.Debug:y.Run);break}return!0}replaceOptions(t,e){const o=t.map(a=>a.resultItem?.computedState);if(e===this.visible&&Ie(this.displayedStates,o))return!1;this.tests=t,this.displayedStates=o,this.visible=e;const{options:r,alternate:s}=ue(t.map(a=>a.test),t.map(a=>a.resultItem),e,A(this.configurationService,w.DefaultGutterClickAction));return this.editorDecoration.options=r,this.editorDecoration.alternate=s,this.editorDecoration.options.glyphMarginHoverMessage=new _().appendText(this.getGutterLabel()),!0}isForTest(t){return this.tests.some(e=>e.test.item.extId===t)}runWith(t){return this.testService.runTests({tests:Ze(this.testService.collection,this.tests.map(({test:e})=>e)),group:t})}showContextMenu(t){this.codeEditorService.listCodeEditors().find(o=>o.getModel()===this.model)?.getContribution(We.ID)?.show(t)}getGutterLabel(){switch(A(this.configurationService,w.DefaultGutterClickAction)){case T.ContextMenu:return h("testing.gutterMsg.contextMenu","Click for test options");case T.Debug:return h("testing.gutterMsg.debug","Click to debug tests, right click for more options");case T.Coverage:return h("testing.gutterMsg.coverage","Click to run tests with coverage, right click for more options");case T.Run:default:return h("testing.gutterMsg.run","Click to run tests, right click for more options")}}getTestContextMenuActions(t,e){const o=[],r=this.testProfileService.capabilitiesForTest(t.item);[{bitset:y.Run,label:h("run test","Run Test")},{bitset:y.Debug,label:h("debug test","Debug Test")},{bitset:y.Coverage,label:h("coverage test","Run with Coverage")}].forEach(({bitset:a,label:c})=>{r&a&&o.push(new E(`testing.gutter.${a}`,c,void 0,void 0,()=>this.testService.runTests({group:a,tests:[t]})))}),r&y.HasNonDefaultProfile&&o.push(new E("testing.runUsing",h("testing.runUsing","Execute Using Profile..."),void 0,void 0,async()=>{const a=await this.commandService.executeCommand("vscode.pickTestProfile",{onlyForTest:t});a&&this.testService.runResolvedTests({group:a.group,targets:[{profileId:a.profileId,controllerId:a.controllerId,testIds:[t.item.extId]}]})})),e&&Je(e.computedState)&&o.push(new E("testing.gutter.peekFailure",h("peek failure","Peek Error"),void 0,void 0,()=>this.commandService.executeCommand("vscode.peekTestError",t.item.extId))),o.push(new E("testing.gutter.reveal",h("reveal test","Reveal in Test Explorer"),void 0,void 0,()=>this.commandService.executeCommand("_revealTestInExplorer",t.item.extId)));const s=this.getContributedTestActions(t,r);return{object:Y.join(o,s),dispose(){}}}getContributedTestActions(t,e){const o=this.contextKeyService.createOverlay(nt(t,e)),r=[],s=je(this.testService.collection,t.item.extId),a=this.menuService.getMenuActions(Ne.TestItemGutter,o,{shouldForwardArgs:!0,arg:s});return Ue(a,r),r}};M=x([u(3,k),u(4,L),u(5,z),u(6,$),u(7,O),u(8,V),u(9,K),u(10,B)],M);let N=class extends M{constructor(e,o,r,s,a,c,g,i,n,d,l,p){super(e,o,r,s,a,c,g,i,n,d,l);this.quickInputService=p}getContextMenuActions(){const e=[];[{bitset:y.Run,label:h("run all test","Run All Tests")},{bitset:y.Coverage,label:h("run all test with coverage","Run All Tests with Coverage")},{bitset:y.Debug,label:h("debug all test","Debug All Tests")}].forEach(({bitset:n,label:d},l)=>{this.tests.some(({test:m})=>this.testProfileService.capabilitiesForTest(m.item)&n)&&e.push(new E(`testing.gutter.run${l}`,d,void 0,void 0,()=>this.runWith(n)))});const o=this.tests.map(n=>({currentLabel:n.test.item.label,testItem:n,parent:Ke.fromString(n.test.item.extId).parentId})),r=n=>{const d=new Map;for(const l of n)d.set(l.currentLabel,(d.get(l.currentLabel)||0)+1);return n.filter(l=>d.get(l.currentLabel)>1)};let s,a=!0;for(;(s=r(o)).length&&a;)for(const n of s)if(n.parent){const d=this.testService.collection.getNodeById(n.parent.toString());n.currentLabel=d?.item.label+" > "+n.currentLabel,n.parent=n.parent.parentId}else a=!1;o.sort((n,d)=>{const l=n.testItem.test.item,p=d.testItem.test.item;return(l.sortText||l.label).localeCompare(p.sortText||p.label)});const c=new ee;let g=o.map(({currentLabel:n,testItem:d})=>{const l=this.getTestContextMenuActions(d.test,d.resultItem);c.add(l);let p=ye(n);const m=p.indexOf(`
`);return m!==-1&&(p=p.slice(0,m)),new he(d.test.item.extId,p,l.object)});const i=g.length-ce;return i>0&&(g=g.slice(0,ce),g.push(new E("testing.gutter.overflow",h("testOverflowItems","{0} more tests...",i),void 0,void 0,()=>this.pickAndRun(o)))),{object:Y.join(e,g),dispose:()=>c.dispose()}}async pickAndRun(e){const o=(a,c)=>new Promise(g=>{const i=new ee,n=i.add(this.quickInputService.createQuickPick());n.placeholder=c,n.items=a,i.add(n.onDidHide(()=>{g(void 0),i.dispose()})),i.add(n.onDidAccept(()=>{g(n.selectedItems[0]),i.dispose()})),n.show()}),r=await o(e.map(({currentLabel:a,testItem:c})=>({label:a,test:c.test,result:c.resultItem})),h("selectTestToRun","Select a test to run"));if(!r)return;const s=this.getTestContextMenuActions(r.test,r.result);try{(await o(s.object,r.label))?.run()}finally{s.dispose()}}};N=x([u(3,k),u(4,L),u(5,z),u(6,$),u(7,O),u(8,V),u(9,K),u(10,B),u(11,_e)],N);let F=class extends M{constructor(t,e,o,r,s,a,c,g,i,n,d,l){super([{test:t,resultItem:e}],r,o,s,a,g,c,i,n,d,l)}getContextMenuActions(){return this.getTestContextMenuActions(this.tests[0].test,this.tests[0].resultItem)}};F=x([u(4,k),u(5,L),u(6,$),u(7,z),u(8,O),u(9,V),u(10,K),u(11,B)],F);const gt=/\r?\n\s*/g;let C=class{constructor(t,e,o,r,s){this.testMessage=t;this.messageUri=e;this.peekOpener=r;const a=t.location;this.line=Te(a.range.startLineNumber,0,o.getLineCount());const c=t.type,g=t.message,i=s.resolveDecorationOptions(C.decorationId,!0);i.hoverMessage=typeof g=="string"?new _().appendText(g):g,i.zIndex=10,i.className=`testing-inline-message-severity-${c}`,i.isWholeLine=!0,i.stickiness=oe.NeverGrowsWhenTypingAtEdges,i.collapseOnReplaceEdit=!0;let n=at(g).replace(gt," ");n.length>ae&&(n=n.slice(0,ae-1)+"\u2026"),i.after={content:" ".repeat(4)+n,inlineClassName:`test-message-inline-content test-message-inline-content-s${c} ${this.contentIdClass} ${e?"test-message-inline-content-clickable":""}`},i.showIfCollapsed=!0;const d=c===j.Error?Ee:ke;d&&(i.overviewRuler={color:Oe(d),position:Re.Right});const l=o.getLineLength(this.line),p=l?l+1:a.range.endColumn;this.editorDecoration={options:i,range:{startLineNumber:this.line,startColumn:p,endColumn:p,endLineNumber:this.line}}}static inlineClassName="test-message-inline-content";static decorationId=`testmessage-${ne()}`;id="";editorDecoration;line;contentIdClass=`test-message-inline-content-id${ne()}`;click(t){return t.event.rightButton||!this.messageUri||t.target.element?.className.includes(this.contentIdClass)&&this.peekOpener.peekUri(this.messageUri),!1}getContextMenuActions(){return{object:[],dispose:()=>{}}}};C=x([u(3,Ye),u(4,k)],C);export{P as TestingDecorationService,U as TestingDecorations};
