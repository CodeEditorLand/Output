var le=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var x=(I,m,i,e)=>{for(var t=e>1?void 0:e?ue(m,i):m,o=I.length-1,r;o>=0;o--)(r=I[o])&&(t=(e?r(m,i,t):r(t))||t);return e&&t&&le(m,i,t),t},a=(I,m)=>(i,e)=>m(i,e,I);import"./media/window.css";import{localize as s}from"../../nls.js";import{URI as h}from"../../base/common/uri.js";import{onUnexpectedError as ve}from"../../base/common/errors.js";import{equals as he}from"../../base/common/objects.js";import{EventType as W,EventHelper as G,addDisposableListener as F,ModifierKeyEmitter as pe,getActiveElement as me,hasWindow as V,getWindow as fe,getWindowById as M,getWindows as Se}from"../../base/browser/dom.js";import{Action as b,Separator as ge}from"../../base/common/actions.js";import{IFileService as we}from"../../platform/files/common/files.js";import{EditorResourceAccessor as K,SideBySideEditor as q,pathsToEditors as ye,isResourceEditorInput as f}from"../common/editor.js";import{IEditorService as Q}from"../services/editor/common/editorService.js";import{ITelemetryService as Ie}from"../../platform/telemetry/common/telemetry.js";import{WindowMinimumSize as $,hasNativeTitlebar as j}from"../../platform/window/common/window.js";import{ITitleService as be}from"../services/title/browser/titleService.js";import{IWorkbenchThemeService as Ee}from"../services/themes/common/workbenchThemeService.js";import{ApplyZoomTarget as Ce,applyZoom as Re}from"../../platform/window/electron-sandbox/window.js";import{setFullscreen as Y,getZoomLevel as L,onDidChangeZoomLevel as Ae,getZoomFactor as We}from"../../base/browser/browser.js";import{ICommandService as J,CommandsRegistry as Le}from"../../platform/commands/common/commands.js";import"../../platform/editor/common/editor.js";import{ipcRenderer as c,process as ke}from"../../base/parts/sandbox/electron-sandbox/globals.js";import{IWorkspaceEditingService as Te}from"../services/workspaces/common/workspaceEditing.js";import{IMenuService as Pe,MenuId as X,MenuItemAction as De,MenuRegistry as xe}from"../../platform/actions/common/actions.js";import"../../platform/action/common/action.js";import{createAndFillInActionBarActions as Fe}from"../../platform/actions/browser/menuEntryActionViewItem.js";import{RunOnceScheduler as O}from"../../base/common/async.js";import{Disposable as Me,DisposableStore as E,MutableDisposable as Oe,toDisposable as ee}from"../../base/common/lifecycle.js";import{LifecyclePhase as U,ILifecycleService as Ue,ShutdownReason as u}from"../services/lifecycle/common/lifecycle.js";import"../../platform/workspaces/common/workspaces.js";import{IIntegrityService as Be}from"../services/integrity/common/integrity.js";import{isWindows as ie,isMacintosh as S}from"../../base/common/platform.js";import{IProductService as Ze}from"../../platform/product/common/productService.js";import{INotificationService as He,NeverShowAgainScope as ze,NotificationPriority as k,Severity as g}from"../../platform/notification/common/notification.js";import{IKeybindingService as te}from"../../platform/keybinding/common/keybinding.js";import{INativeWorkbenchEnvironmentService as Ne}from"../services/environment/electron-sandbox/environmentService.js";import{IAccessibilityService as _e,AccessibilitySupport as oe}from"../../platform/accessibility/common/accessibility.js";import{WorkbenchState as Ge,IWorkspaceContextService as Ve}from"../../platform/workspace/common/workspace.js";import{coalesce as B}from"../../base/common/arrays.js";import{ConfigurationTarget as Ke,IConfigurationService as qe}from"../../platform/configuration/common/configuration.js";import{IStorageService as Qe,StorageScope as Z,StorageTarget as $e}from"../../platform/storage/common/storage.js";import{assertIsDefined as je}from"../../base/common/types.js";import{IOpenerService as Ye}from"../../platform/opener/common/opener.js";import{Schemas as re}from"../../base/common/network.js";import{INativeHostService as Je}from"../../platform/native/common/native.js";import{posix as H}from"../../base/common/path.js";import{ITunnelService as Xe,extractLocalHostUriMetaDataForPortMapping as ei,extractQueryLocalHostUriMetaDataForPortMapping as ii}from"../../platform/tunnel/common/tunnel.js";import{IWorkbenchLayoutService as ti,Parts as oi,positionFromString as ri,Position as ne}from"../services/layout/browser/layoutService.js";import{IWorkingCopyService as ni}from"../services/workingCopy/common/workingCopyService.js";import{WorkingCopyCapabilities as si}from"../services/workingCopy/common/workingCopy.js";import{IFilesConfigurationService as ai}from"../services/filesConfiguration/common/filesConfigurationService.js";import{Event as v}from"../../base/common/event.js";import{IRemoteAuthorityResolverService as di}from"../../platform/remote/common/remoteAuthorityResolver.js";import"../../platform/remote/common/remoteAgentConnection.js";import{IEditorGroupsService as ci}from"../services/editor/common/editorGroupsService.js";import{IDialogService as li}from"../../platform/dialogs/common/dialogs.js";import"../../base/parts/sandbox/electron-sandbox/electronTypes.js";import{ILogService as ui}from"../../platform/log/common/log.js";import{IInstantiationService as vi}from"../../platform/instantiation/common/instantiation.js";import{whenEditorClosed as hi}from"../browser/editor.js";import{ISharedProcessService as pi}from"../../platform/ipc/electron-sandbox/services.js";import{IProgressService as mi,ProgressLocation as z}from"../../platform/progress/common/progress.js";import{toErrorMessage as fi}from"../../base/common/errorMessage.js";import{ILabelService as Si}from"../../platform/label/common/label.js";import{dirname as w}from"../../base/common/resources.js";import{IBannerService as gi}from"../services/banner/browser/bannerService.js";import{Codicon as T}from"../../base/common/codicons.js";import{IUriIdentityService as wi}from"../../platform/uriIdentity/common/uriIdentity.js";import{IPreferencesService as yi}from"../services/preferences/common/preferences.js";import{IUtilityProcessWorkerWorkbenchService as Ii}from"../services/utilityProcess/electron-sandbox/utilityProcessWorkerWorkbenchService.js";import{registerWindowDriver as bi}from"../services/driver/electron-sandbox/driver.js";import{mainWindow as p}from"../../base/browser/window.js";import{BaseWindow as Ei}from"../browser/window.js";import{IHostService as Ci}from"../services/host/browser/host.js";import{IStatusbarService as Ri,ShowTooltipCommand as Ai,StatusbarAlignment as Wi}from"../services/statusbar/browser/statusbar.js";import{ActionBar as se}from"../../base/browser/ui/actionbar/actionbar.js";import{ThemeIcon as N}from"../../base/common/themables.js";import{getWorkbenchContribution as Li}from"../common/contributions.js";import{DynamicWorkbenchSecurityConfiguration as ki}from"../common/configuration.js";import{nativeHoverDelegate as ae}from"../../platform/hover/browser/hover.js";let y=class extends Ei{constructor(i,e,t,o,r,n,d,l,_,R,A,P,D,Ti,de,Pi,Di,xi,Fi,Mi,Oi,Ui,Bi,Zi,Hi,zi,Ni,_i,Gi,Vi,Ki,qi,Qi,$i,ji,Yi,ce){super(p,void 0,ce,de);this.editorService=i;this.editorGroupService=e;this.configurationService=t;this.titleService=o;this.themeService=r;this.notificationService=n;this.commandService=d;this.keybindingService=l;this.telemetryService=_;this.workspaceEditingService=R;this.fileService=A;this.menuService=P;this.lifecycleService=D;this.integrityService=Ti;this.nativeEnvironmentService=de;this.accessibilityService=Pi;this.contextService=Di;this.openerService=xi;this.nativeHostService=Fi;this.tunnelService=Mi;this.layoutService=Oi;this.workingCopyService=Ui;this.filesConfigurationService=Bi;this.productService=Zi;this.remoteAuthorityResolverService=Hi;this.dialogService=zi;this.storageService=Ni;this.logService=_i;this.instantiationService=Gi;this.sharedProcessService=Vi;this.progressService=Ki;this.labelService=qi;this.bannerService=Qi;this.uriIdentityService=$i;this.preferencesService=ji;this.utilityProcessWorkerWorkbenchService=Yi;this.registerListeners(),this.create()}customTitleContextMenuDisposable=this._register(new E);addFoldersScheduler=this._register(new O(()=>this.doAddFolders(),100));pendingFoldersToAdd=[];isDocumentedEdited=!1;registerListeners(){this._register(F(p,W.RESIZE,()=>this.layoutService.layout())),this._register(this.editorService.onDidActiveEditorChange(()=>this.updateTouchbarMenu()));for(const e of[W.DRAG_OVER,W.DROP])this._register(F(p.document.body,e,t=>{G.stop(t)}));c.on("vscode:runAction",async(e,t)=>{const o=t.args||[];if(t.from==="touchbar"){const r=this.editorService.activeEditor;if(r){const n=K.getOriginalUri(r,{supportSideBySide:q.PRIMARY});n&&o.push(n)}}else o.push({from:t.from});try{await this.commandService.executeCommand(t.id,...o),this.telemetryService.publicLog2("workbenchActionExecuted",{id:t.id,from:t.from})}catch(r){this.notificationService.error(r)}}),c.on("vscode:runKeybinding",(e,t)=>{const o=me();o&&this.keybindingService.dispatchByUserSettingsLabel(t.userSettingsLabel,o)}),c.on("vscode:reportError",(e,t)=>{t&&ve(JSON.parse(t))}),c.on("vscode:reportSharedProcessCrash",(e,t)=>{this.notificationService.prompt(g.Error,s("sharedProcessCrash","A shared background process terminated unexpectedly. Please restart the application to recover."),[{label:s("restart","Restart"),run:()=>this.nativeHostService.relaunch()}],{priority:k.URGENT})}),c.on("vscode:openFiles",(e,t)=>{this.onOpenFiles(t)}),c.on("vscode:addFolders",(e,t)=>{this.onAddFoldersRequest(t)}),c.on("vscode:showInfoMessage",(e,t)=>{this.notificationService.info(t)}),c.on("vscode:showResolveShellEnvError",(e,t)=>{this.notificationService.prompt(g.Error,t,[{label:s("restart","Restart"),run:()=>this.nativeHostService.relaunch()},{label:s("configure","Configure"),run:()=>this.preferencesService.openUserSettings({query:"application.shellEnvironmentResolutionTimeout"})},{label:s("learnMore","Learn More"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667")}])}),c.on("vscode:showCredentialsError",(e,t)=>{this.notificationService.prompt(g.Error,s("keychainWriteError","Writing login information to the keychain failed with error '{0}'.",t),[{label:s("troubleshooting","Troubleshooting Guide"),run:()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2190713")}])}),c.on("vscode:showTranslatedBuildWarning",()=>{this.notificationService.prompt(g.Warning,s("runningTranslated","You are running an emulated version of {0}. For better performance download the native arm64 version of {0} build for your machine.",this.productService.nameLong),[{label:s("downloadArmBuild","Download"),run:()=>{const e=this.productService.quality;this.openerService.open(e==="stable"?"https://code.visualstudio.com/docs/?dv=osx":"https://code.visualstudio.com/docs/?dv=osx&build=insiders")}}],{priority:k.URGENT})}),c.on("vscode:showArgvParseWarning",(e,t)=>{this.notificationService.prompt(g.Warning,s("showArgvParseWarning","The runtime arguments file 'argv.json' contains errors. Please correct them and restart."),[{label:s("showArgvParseWarningAction","Open File"),run:()=>this.editorService.openEditor({resource:this.nativeEnvironmentService.argvResource})}],{priority:k.URGENT})}),c.on("vscode:enterFullScreen",()=>Y(!0,p)),c.on("vscode:leaveFullScreen",()=>Y(!1,p)),c.on("vscode:openProxyAuthenticationDialog",async(e,t)=>{const o="window.rememberProxyCredentials",r=this.storageService.getBoolean(o,Z.APPLICATION),n=await this.dialogService.input({type:"warning",message:s("proxyAuthRequired","Proxy Authentication Required"),primaryButton:s({key:"loginButton",comment:["&& denotes a mnemonic"]},"&&Log In"),inputs:[{placeholder:s("username","Username"),value:t.username},{placeholder:s("password","Password"),type:"password",value:t.password}],detail:s("proxyDetail","The proxy {0} requires a username and password.",`${t.authInfo.host}:${t.authInfo.port}`),checkbox:{label:s("rememberCredentials","Remember my credentials"),checked:r}});if(!n.confirmed||!n.values)c.send(t.replyChannel);else{n.checkboxChecked?this.storageService.store(o,!0,Z.APPLICATION,$e.MACHINE):this.storageService.remove(o,Z.APPLICATION);const[d,l]=n.values;c.send(t.replyChannel,{username:d,password:l,remember:!!n.checkboxChecked})}}),c.on("vscode:accessibilitySupportChanged",(e,t)=>{this.accessibilityService.setAccessibilitySupport(t?oe.Enabled:oe.Disabled)}),c.on("vscode:configureAllowedUNCHost",async(e,t)=>{if(!ie)return;const o=new Set,r=this.configurationService.getValue("security.allowedUNCHosts")??[];if(Array.isArray(r))for(const n of r)typeof n=="string"&&o.add(n);o.has(t)||(o.add(t),await Li(ki.ID).ready,this.configurationService.updateValue("security.allowedUNCHosts",[...o.values()],Ke.USER))}),c.on("vscode:disablePromptForProtocolHandling",(e,t)=>{const o=t==="local"?"security.promptForLocalFileProtocolHandling":"security.promptForRemoteFileProtocolHandling";this.configurationService.updateValue(o,!1)}),this._register(this.configurationService.onDidChangeConfiguration(e=>{e.affectsConfiguration("window.zoomLevel")||e.affectsConfiguration("window.zoomPerWindow")&&this.configurationService.getValue("window.zoomPerWindow")===!1?this.onDidChangeConfiguredWindowZoomLevel():(e.affectsConfiguration("keyboard.touchbar.enabled")||e.affectsConfiguration("keyboard.touchbar.ignored"))&&this.updateTouchbarMenu()})),this._register(Ae(e=>this.handleOnDidChangeZoomLevel(e)));for(const e of this.editorGroupService.parts)this.createWindowZoomStatusEntry(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.createWindowZoomStatusEntry(e))),this._register(v.debounce(this.editorService.onDidVisibleEditorsChange,()=>{},0,void 0,void 0,void 0,this._store)(()=>this.maybeCloseWindow()));const i=this.nativeEnvironmentService.filesToWait;if(i&&this.trackClosedWaitFiles(i.waitMarkerFileUri,B(i.paths.map(e=>e.fileUri))),S){for(const e of this.editorGroupService.parts)this.handleRepresentedFilename(e);this._register(this.editorGroupService.onDidCreateAuxiliaryEditorPart(e=>this.handleRepresentedFilename(e)))}S&&!j(this.configurationService)&&this._register(v.runAndSubscribe(this.layoutService.onDidAddContainer,({container:e,disposables:t})=>{const o=fe(e),r=o.vscodeWindowId,n=je(this.layoutService.getContainer(o,oi.TITLEBAR_PART));t.add(F(n,W.DBLCLICK,d=>{G.stop(d),this.nativeHostService.handleTitleDoubleClick({targetWindowId:r})}))},{container:this.layoutService.mainContainer,disposables:this._store})),this._register(this.workingCopyService.onDidChangeDirty(e=>{const t=e.isDirty();t&&!(e.capabilities&si.Untitled)&&this.filesConfigurationService.hasShortAutoSaveDelay(e.resource)||this.updateDocumentEdited(t?!0:void 0)})),this.updateDocumentEdited(void 0),this._register(v.any(v.map(v.filter(this.nativeHostService.onDidMaximizeWindow,e=>!!V(e)),e=>({maximized:!0,windowId:e})),v.map(v.filter(this.nativeHostService.onDidUnmaximizeWindow,e=>!!V(e)),e=>({maximized:!1,windowId:e})))(e=>this.layoutService.updateWindowMaximizedState(M(e.windowId).window,e.maximized))),this.layoutService.updateWindowMaximizedState(p,this.nativeEnvironmentService.window.maximized??!1),this._register(this.layoutService.onDidChangePanelPosition(e=>this.onDidChangePanelPosition(ri(e)))),this.onDidChangePanelPosition(this.layoutService.getPanelPosition()),this._register(this.lifecycleService.onBeforeShutdown(e=>this.onBeforeShutdown(e))),this._register(this.lifecycleService.onBeforeShutdownError(e=>this.onBeforeShutdownError(e))),this._register(this.lifecycleService.onWillShutdown(e=>this.onWillShutdown(e)))}handleRepresentedFilename(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i).invokeFunction(o=>o.get(Q));e.add(t.onDidActiveEditorChange(()=>this.updateRepresentedFilename(t,i.windowId)))}updateRepresentedFilename(i,e){const t=K.getOriginalUri(i.activeEditor,{supportSideBySide:q.PRIMARY,filterByScheme:re.file});this.nativeHostService.setRepresentedFilename(t?.fsPath??"",{targetWindowId:e}),e===p.vscodeWindowId&&this.provideCustomTitleContextMenu(t?.fsPath)}onBeforeShutdown({veto:i,reason:e}){if(e===u.CLOSE){const t=this.configurationService.getValue("window.confirmBeforeClose"),o=t==="always"||t==="keyboardOnly"&&pe.getInstance().isModifierPressed;if(o)return i((async()=>{let r=e;e===u.CLOSE&&!S&&await this.nativeHostService.getWindowCount()===1&&(r=u.QUIT);let n=!0;return o&&(n=await this.instantiationService.invokeFunction(d=>y.confirmOnShutdown(d,r))),n&&this.progressOnBeforeShutdown(e),!n})(),"veto.confirmBeforeClose")}this.progressOnBeforeShutdown(e)}progressOnBeforeShutdown(i){this.progressService.withProgress({location:z.Window,delay:800,title:this.toShutdownLabel(i,!1)},()=>v.toPromise(v.any(this.lifecycleService.onWillShutdown,this.lifecycleService.onShutdownVeto,this.dialogService.onWillShowDialog)))}onBeforeShutdownError({error:i,reason:e}){this.dialogService.error(this.toShutdownLabel(e,!0),s("shutdownErrorDetail","Error: {0}",fi(i)))}onWillShutdown({reason:i,force:e,joiners:t}){const o=new O(()=>{const r=t();this.progressService.withProgress({location:z.Dialog,buttons:[this.toForceShutdownLabel(i)],cancellable:!1,sticky:!0,title:this.toShutdownLabel(i,!1),detail:r.length>0?s("willShutdownDetail",`The following operations are still running: 
{0}`,r.map(n=>`- ${n.label}`).join(`
`)):void 0},()=>v.toPromise(this.lifecycleService.onDidShutdown),()=>{e()})},1200);o.schedule(),v.once(this.lifecycleService.onDidShutdown)(()=>o.dispose())}toShutdownLabel(i,e){if(e)switch(i){case u.CLOSE:return s("shutdownErrorClose","An unexpected error prevented the window to close");case u.QUIT:return s("shutdownErrorQuit","An unexpected error prevented the application to quit");case u.RELOAD:return s("shutdownErrorReload","An unexpected error prevented the window to reload");case u.LOAD:return s("shutdownErrorLoad","An unexpected error prevented to change the workspace")}switch(i){case u.CLOSE:return s("shutdownTitleClose","Closing the window is taking a bit longer...");case u.QUIT:return s("shutdownTitleQuit","Quitting the application is taking a bit longer...");case u.RELOAD:return s("shutdownTitleReload","Reloading the window is taking a bit longer...");case u.LOAD:return s("shutdownTitleLoad","Changing the workspace is taking a bit longer...")}}toForceShutdownLabel(i){switch(i){case u.CLOSE:return s("shutdownForceClose","Close Anyway");case u.QUIT:return s("shutdownForceQuit","Quit Anyway");case u.RELOAD:return s("shutdownForceReload","Reload Anyway");case u.LOAD:return s("shutdownForceLoad","Change Anyway")}}updateDocumentEdited(i){let e;typeof i=="boolean"?e=i:e=this.workingCopyService.hasDirty,(!this.isDocumentedEdited&&e||this.isDocumentedEdited&&!e)&&(this.isDocumentedEdited=e,this.nativeHostService.setDocumentEdited(e))}getWindowMinimumWidth(i=this.layoutService.getPanelPosition()){return i===ne.LEFT||i===ne.RIGHT?$.WIDTH_WITH_VERTICAL_PANEL:$.WIDTH}onDidChangePanelPosition(i){const e=this.getWindowMinimumWidth(i);this.nativeHostService.setMinimumSize(e,void 0)}maybeCloseWindow(){if(this.configurationService.getValue("window.closeWhenEmpty")||this.nativeEnvironmentService.args.wait)for(const e of this.editorGroupService.parts)e.groups.some(t=>!t.isEmpty)||e===this.editorGroupService.mainPart&&(this.contextService.getWorkbenchState()!==Ge.EMPTY||this.environmentService.isExtensionDevelopment||this.editorService.visibleEditors.length>0)||(e===this.editorGroupService.mainPart?this.nativeHostService.closeWindow():e.removeGroup(e.activeGroup))}provideCustomTitleContextMenu(i){if(this.customTitleContextMenuDisposable.clear(),!i||j(this.configurationService))return;const e=i.split(H.sep);for(let t=e.length;t>0;t--){const o=t===e.length;let r=t;o||r++;const n=h.file(e.slice(0,r).join(H.sep));let d;o?d=this.labelService.getUriBasenameLabel(n):d=this.labelService.getUriBasenameLabel(w(n));const l=`workbench.action.revealPathInFinder${t}`;this.customTitleContextMenuDisposable.add(Le.registerCommand(l,()=>this.nativeHostService.showItemInFolder(n.fsPath))),this.customTitleContextMenuDisposable.add(xe.appendMenuItem(X.TitleBarTitleContext,{command:{id:l,title:d||H.sep},order:-t,group:"1_file"}))}}create(){this.setupOpenHandlers(),this.lifecycleService.when(U.Ready).then(()=>this.nativeHostService.notifyReady()),this.lifecycleService.when(U.Restored).then(()=>{this.sharedProcessService.notifyRestored(),this.utilityProcessWorkerWorkbenchService.notifyRestored()}),this.handleWarnings(),this.updateTouchbarMenu(),this.environmentService.enableSmokeTestDriver&&this.setupDriver()}async handleWarnings(){if(await this.lifecycleService.when(U.Restored),(async()=>{const e=await this.nativeHostService.isAdmin(),{isPure:t}=await this.integrityService.isPure();this.titleService.updateProperties({isPure:t,isAdmin:e}),e&&!ie&&this.notificationService.warn(s("runningAsRoot","It is not recommended to run {0} as root user.",this.productService.nameShort))})(),this.environmentService.isBuilt){let e;S?e=w(w(w(h.file(this.nativeEnvironmentService.appRoot)))):e=w(w(h.file(this.nativeEnvironmentService.appRoot)));for(const t of this.contextService.getWorkspace().folders)if(this.uriIdentityService.extUri.isEqualOrParent(t.uri,e)){this.bannerService.show({id:"appRootWarning.banner",message:s("appRootWarning.banner","Files you store within the installation folder ('{0}') may be OVERWRITTEN or DELETED IRREVERSIBLY without warning at update time.",this.labelService.getUriLabel(e)),icon:T.warning});break}}if(S){const e=this.nativeEnvironmentService.os.release.split(".")[0],t=new Map([["17","macOS High Sierra"],["18","macOS Mojave"]]);if(t.has(e)){const o=s("macoseolmessage","{0} on {1} will soon stop receiving updates. Consider upgrading your macOS version.",this.productService.nameLong,t.get(e));this.notificationService.prompt(g.Warning,o,[{label:s("learnMore","Learn More"),run:()=>this.openerService.open(h.parse("https://aka.ms/vscode-faq-old-macOS"))}],{neverShowAgain:{id:"macoseol",isSecondary:!0,scope:ze.APPLICATION},priority:k.URGENT,sticky:!0})}}const i=ke.shellEnv();this.progressService.withProgress({title:s("resolveShellEnvironment","Resolving shell environment..."),location:z.Window,delay:1600,buttons:[s("learnMore","Learn More")]},()=>i,()=>this.openerService.open("https://go.microsoft.com/fwlink/?linkid=2149667"))}setupDriver(){const i=this;let e=!1;bi(this.instantiationService,{async exitApplication(){if(e){i.logService.info("[driver] not handling exitApplication() due to pending quit() call");return}return i.logService.info("[driver] handling exitApplication()"),e=!0,i.nativeHostService.quit()}})}async openTunnel(i,e){const t=this.environmentService.remoteAuthority,o=t?{getAddress:async()=>(await this.remoteAuthorityResolverService.resolveAuthority(t)).authority}:void 0,r=await this.tunnelService.getExistingTunnel(i,e);return!r||typeof r=="string"?this.tunnelService.openTunnel(o,i,e):r}async resolveExternalUri(i,e){let t;if(e?.allowTunneling){const o=ei(i),r=ii(i);if(r&&(t=await this.openTunnel(r.address,r.port),t&&typeof t!="string")){if(t.tunnelRemotePort!==r.port)t.dispose(),t=void 0;else if(!o){const n=t;return{resolved:i,dispose:()=>n.dispose()}}}if(o){const n=await this.openTunnel(o.address,o.port);if(n&&typeof n!="string"){const d=h.parse(n.localAddress).with({path:i.path});return{resolved:d.scheme.startsWith(i.scheme)?d:i.with({authority:n.localAddress}),dispose(){n.dispose(),t&&typeof t!="string"&&t.dispose()}}}}}if(!e?.openExternal&&await this.fileService.canHandleResource(i))return{resolved:h.from({scheme:this.productService.urlProtocol,path:"workspace",query:i.toString()}),dispose(){}}}setupOpenHandlers(){this.openerService.setDefaultExternalOpener({openExternal:async i=>{if(!await this.nativeHostService.openExternal(i,this.configurationService.getValue("workbench.externalBrowser"))){const t=h.parse(i);t.scheme===re.file&&await this.nativeHostService.showItemInFolder(t.fsPath)}return!0}}),this.openerService.registerExternalUriResolver({resolveExternalUri:async(i,e)=>this.resolveExternalUri(i,e)})}touchBarMenu;touchBarDisposables=this._register(new E);lastInstalledTouchedBar;updateTouchbarMenu(){if(!S)return;this.touchBarDisposables.clear(),this.touchBarMenu=void 0;const i=this.touchBarDisposables.add(new O(()=>this.doUpdateTouchbarMenu(i),300));i.schedule()}doUpdateTouchbarMenu(i){if(!this.touchBarMenu){const l=this.editorService.activeEditorPane?.scopedContextKeyService||this.editorGroupService.activeGroup.scopedContextKeyService;this.touchBarMenu=this.menuService.createMenu(X.TouchBarContext,l),this.touchBarDisposables.add(this.touchBarMenu),this.touchBarDisposables.add(this.touchBarMenu.onDidChange(()=>i.schedule()))}const e=[],t=this.configurationService.getValue("keyboard.touchbar.enabled")===!1,o=this.configurationService.getValue("keyboard.touchbar.ignored"),r=Array.isArray(o)?o:[];Fe(this.touchBarMenu,void 0,e);const n=[];let d=[];if(!t){for(const l of e)if(l instanceof De){if(r.indexOf(l.item.id)>=0)continue;d.push(l.item)}else l instanceof ge&&(d.length&&n.push(d),d=[]);d.length&&n.push(d)}he(this.lastInstalledTouchedBar,n)||(this.lastInstalledTouchedBar=n,this.nativeHostService.updateTouchBar(n))}onAddFoldersRequest(i){this.pendingFoldersToAdd.push(...i.foldersToAdd.map(e=>h.revive(e))),this.addFoldersScheduler.isScheduled()||this.addFoldersScheduler.schedule()}doAddFolders(){const i=[];for(const e of this.pendingFoldersToAdd)i.push({uri:e});this.pendingFoldersToAdd=[],this.workspaceEditingService.addFolders(i)}async onOpenFiles(i){const e=!!(i.filesToDiff&&i.filesToDiff.length===2),t=!!(i.filesToMerge&&i.filesToMerge.length===4),o=B(await ye(t?i.filesToMerge:e?i.filesToDiff:i.filesToOpenOrCreate,this.fileService,this.logService));if(o.length){const r=await this.openResources(o,e,t);if(i.filesToWait)return r.length?this.trackClosedWaitFiles(h.revive(i.filesToWait.waitMarkerFileUri),B(i.filesToWait.paths.map(n=>h.revive(n.fileUri)))):this.fileService.del(h.revive(i.filesToWait.waitMarkerFileUri))}}async trackClosedWaitFiles(i,e){await this.instantiationService.invokeFunction(t=>hi(t,e)),await this.fileService.del(i)}async openResources(i,e,t){const o=[];if(t&&f(i[0])&&f(i[1])&&f(i[2])&&f(i[3])){const r={input1:{resource:i[0].resource},input2:{resource:i[1].resource},base:{resource:i[2].resource},result:{resource:i[3].resource},options:{pinned:!0}};o.push(r)}else if(e&&f(i[0])&&f(i[1])){const r={original:{resource:i[0].resource},modified:{resource:i[1].resource},options:{pinned:!0}};o.push(r)}else o.push(...i);return this.editorService.openEditors(o,void 0,{validateTrust:!0})}mapWindowIdToZoomStatusEntry=new Map;configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();resolveConfiguredWindowZoomLevel(){const i=this.configurationService.getValue("window.zoomLevel");return typeof i=="number"?i:0}handleOnDidChangeZoomLevel(i){if(this.updateWindowZoomStatusEntry(i),i===p.vscodeWindowId){const e=L(p);let t;this.configuredWindowZoomLevel!==e&&(t=e),c.invoke("vscode:notifyZoomLevel",t)}}createWindowZoomStatusEntry(i){const e=new E;v.once(i.onWillDispose)(()=>e.dispose());const t=this.editorGroupService.getScopedInstantiationService(i);this.mapWindowIdToZoomStatusEntry.set(i.windowId,e.add(t.createInstance(C))),e.add(ee(()=>this.mapWindowIdToZoomStatusEntry.delete(i.windowId))),this.updateWindowZoomStatusEntry(i.windowId)}updateWindowZoomStatusEntry(i){const e=M(i),t=this.mapWindowIdToZoomStatusEntry.get(i);if(t&&e){const o=L(e.window);let r;o<this.configuredWindowZoomLevel?r="$(zoom-out)":o>this.configuredWindowZoomLevel&&(r="$(zoom-in)"),t.updateZoomEntry(r??!1,i)}}onDidChangeConfiguredWindowZoomLevel(){this.configuredWindowZoomLevel=this.resolveConfiguredWindowZoomLevel();let i=!1;for(const{window:e}of Se())if(L(e)!==this.configuredWindowZoomLevel){i=!0;break}i&&Re(this.configuredWindowZoomLevel,Ce.ALL_WINDOWS);for(const[e]of this.mapWindowIdToZoomStatusEntry)this.updateWindowZoomStatusEntry(e)}dispose(){super.dispose();for(const[,i]of this.mapWindowIdToZoomStatusEntry)i.dispose()}};y=x([a(0,Q),a(1,ci),a(2,qe),a(3,be),a(4,Ee),a(5,He),a(6,J),a(7,te),a(8,Ie),a(9,Te),a(10,we),a(11,Pe),a(12,Ue),a(13,Be),a(14,Ne),a(15,_e),a(16,Ve),a(17,Ye),a(18,Je),a(19,Xe),a(20,ti),a(21,ni),a(22,ai),a(23,Ze),a(24,di),a(25,li),a(26,Qe),a(27,ui),a(28,vi),a(29,pi),a(30,mi),a(31,Si),a(32,gi),a(33,wi),a(34,yi),a(35,Ii),a(36,Ci)],y);let C=class extends Me{constructor(i,e,t){super();this.statusbarService=i;this.commandService=e;this.keybindingService=t}disposable=this._register(new Oe);zoomLevelLabel=void 0;updateZoomEntry(i,e){typeof i=="string"?(this.disposable.value||this.createZoomEntry(i),this.updateZoomLevelLabel(e)):this.disposable.clear()}createZoomEntry(i){const e=new E;this.disposable.value=e;const t=document.createElement("div");t.classList.add("zoom-status");const o=document.createElement("div");o.classList.add("zoom-status-left"),t.appendChild(o);const r=e.add(new b("workbench.action.zoomOut",s("zoomOut","Zoom Out"),N.asClassName(T.remove),!0,()=>this.commandService.executeCommand(r.id))),n=e.add(new b("workbench.action.zoomIn",s("zoomIn","Zoom In"),N.asClassName(T.plus),!0,()=>this.commandService.executeCommand(n.id))),d=e.add(new b("workbench.action.zoomReset",s("zoomReset","Reset"),void 0,!0,()=>this.commandService.executeCommand(d.id)));d.tooltip=s("zoomResetLabel","{0} ({1})",d.label,this.keybindingService.lookupKeybinding(d.id)?.getLabel());const l=e.add(new b("workbench.action.openSettings",s("zoomSettings","Settings"),N.asClassName(T.settingsGear),!0,()=>this.commandService.executeCommand(l.id,"window.zoom"))),_=e.add(new b("zoomLabel",void 0,void 0,!1));this.zoomLevelLabel=_,e.add(ee(()=>this.zoomLevelLabel=void 0));const R=e.add(new se(o,{hoverDelegate:ae}));R.push(r,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(r.id)?.getLabel()}),R.push(this.zoomLevelLabel,{icon:!1,label:!0}),R.push(n,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(n.id)?.getLabel()});const A=document.createElement("div");A.classList.add("zoom-status-right"),t.appendChild(A);const P=e.add(new se(A,{hoverDelegate:ae}));P.push(d,{icon:!1,label:!0}),P.push(l,{icon:!0,label:!1,keybinding:this.keybindingService.lookupKeybinding(l.id)?.getLabel()});const D=s("status.windowZoom","Window Zoom");e.add(this.statusbarService.addEntry({name:D,text:i,tooltip:t,ariaLabel:D,command:Ai,kind:"prominent"},"status.windowZoom",Wi.RIGHT,102))}updateZoomLevelLabel(i){if(this.zoomLevelLabel){const e=M(i,!0).window,t=Math.round(We(e)*100),o=L(e);this.zoomLevelLabel.label=`${o}`,this.zoomLevelLabel.tooltip=s("zoomNumber","Zoom Level: {0} ({1}%)",o,t)}}};C=x([a(0,Ri),a(1,J),a(2,te)],C);export{y as NativeWindow};
