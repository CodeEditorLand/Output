var N=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var L=(v,m,r,t)=>{for(var e=t>1?void 0:t?B(m,r):m,s=v.length-1,i;s>=0;s--)(i=v[s])&&(e=(t?i(m,r,e):i(e))||e);return t&&e&&N(m,r,e),e},a=(v,m)=>(r,t)=>m(r,t,v);import*as C from"../../../../base/browser/dom.js";import{parentOriginHash as $}from"../../../../base/browser/iframe.js";import{mainWindow as x}from"../../../../base/browser/window.js";import{Barrier as q}from"../../../../base/common/async.js";import{VSBuffer as W}from"../../../../base/common/buffer.js";import{canceled as y,onUnexpectedError as K}from"../../../../base/common/errors.js";import{Emitter as k,Event as _}from"../../../../base/common/event.js";import{Disposable as j,toDisposable as F}from"../../../../base/common/lifecycle.js";import{COI as V,FileAccess as D}from"../../../../base/common/network.js";import*as u from"../../../../base/common/platform.js";import{joinPath as X}from"../../../../base/common/resources.js";import{URI as H}from"../../../../base/common/uri.js";import{generateUuid as U}from"../../../../base/common/uuid.js";import"../../../../base/parts/ipc/common/ipc.js";import{getNLSLanguage as z,getNLSMessages as G}from"../../../../nls.js";import{ILabelService as J}from"../../../../platform/label/common/label.js";import{ILayoutService as Y}from"../../../../platform/layout/browser/layoutService.js";import{ILogService as Q,ILoggerService as Z}from"../../../../platform/log/common/log.js";import{IProductService as ee}from"../../../../platform/product/common/productService.js";import{IStorageService as te,StorageScope as T,StorageTarget as re}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as oe}from"../../../../platform/telemetry/common/telemetry.js";import{isLoggingOnly as ie}from"../../../../platform/telemetry/common/telemetryUtils.js";import{IUserDataProfilesService as se}from"../../../../platform/userDataProfile/common/userDataProfile.js";import{IWorkspaceContextService as ne,WorkbenchState as ae}from"../../../../platform/workspace/common/workspace.js";import{IBrowserWorkbenchEnvironmentService as ce}from"../../environment/browser/environmentService.js";import{ExtensionHostExitCode as P,MessageType as E,UIKind as M,createMessageOfType as le,isMessageOfType as R}from"../common/extensionHostProtocol.js";import"../common/extensionRunningLocation.js";import{ExtensionHostStartup as me}from"../common/extensions.js";let I=class extends j{constructor(r,t,e,s,i,p,l,g,c,f,h,d,w){super();this.runningLocation=r;this.startup=t;this._initDataProvider=e;this._telemetryService=s;this._contextService=i;this._labelService=p;this._logService=l;this._loggerService=g;this._environmentService=c;this._userDataProfilesService=f;this._productService=h;this._layoutService=d;this._storageService=w;this._isTerminating=!1,this._protocolPromise=null,this._protocol=null,this._extensionHostLogsLocation=X(this._environmentService.extHostLogsPath,"webWorker")}pid=null;remoteAuthority=null;extensions=null;_onDidExit=this._register(new k);onExit=this._onDidExit.event;_isTerminating;_protocolPromise;_protocol;_extensionHostLogsLocation;async _getWebWorkerExtensionHostIframeSrc(){const r=new URLSearchParams;this._environmentService.debugExtensionHost&&this._environmentService.debugRenderer&&r.set("debugged","1"),V.addSearchParam(r,!0,!0);const t=`?${r.toString()}`,e="vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html";if(u.isWeb){const i=this._productService.webEndpointUrlTemplate,p=this._productService.commit,l=this._productService.quality;if(i&&p&&l){const g="webWorkerExtensionHostIframeStableOriginUUID";let c=this._storageService.get(g,T.WORKSPACE);typeof c>"u"&&(c=U(),this._storageService.store(g,c,T.WORKSPACE,re.MACHINE));const f=await $(x.origin,c),h=i.replace("{{uuid}}",`v--${f}`).replace("{{commit}}",p).replace("{{quality}}",l),d=new URL(`${h}/out/${e}${t}`);return d.searchParams.set("parentOrigin",x.origin),d.searchParams.set("salt",c),d.toString()}}return`${D.asBrowserUri(e).toString(!0)}${t}`}async start(){return this._protocolPromise||(this._protocolPromise=this._startInsideIframe(),this._protocolPromise.then(r=>this._protocol=r)),this._protocolPromise}async _startInsideIframe(){const r=await this._getWebWorkerExtensionHostIframeSrc(),t=this._register(new k),e=document.createElement("iframe");e.setAttribute("class","web-worker-ext-host-iframe"),e.setAttribute("sandbox","allow-scripts allow-same-origin"),e.setAttribute("allow","usb; serial; hid; cross-origin-isolated;"),e.setAttribute("aria-hidden","true"),e.style.display="none";const s=U();e.setAttribute("src",`${r}&vscodeWebWorkerExtHostId=${s}`);const i=new q;let p,l=null,g=!1,c=null;const f=(o,n)=>{l=n,g=!0,K(l),clearTimeout(c),this._onDidExit.fire([P.UnexpectedError,l.message]),i.open()},h=o=>{p=o,clearTimeout(c),i.open()};if(c=setTimeout(()=>{},6e4),this._register(C.addDisposableListener(x,"message",o=>{if(o.source!==e.contentWindow||o.data.vscodeWebWorkerExtHostId!==s)return;if(o.data.error){const{name:b,message:O,stack:A}=o.data.error,S=new Error;return S.message=O,S.name=b,S.stack=A,f(P.UnexpectedError,S)}if(o.data.type==="vscode.bootstrap.nls"){e.contentWindow.postMessage({type:o.data.type,data:{workerUrl:D.asBrowserUri("vs/workbench/api/worker/extensionHostWorkerMain.js").toString(!0),fileRoot:globalThis._VSCODE_FILE_ROOT,nls:{messages:G(),language:z()}}},"*");return}const{data:n}=o.data;if(i.isOpen()||!(n instanceof MessagePort)){const b=new Error("UNEXPECTED message");return f(P.UnexpectedError,b)}h(n)})),this._layoutService.mainContainer.appendChild(e),this._register(F(()=>e.remove())),await i.wait(),g)throw l;const d=this._environmentService.options?.messagePorts??new Map;e.contentWindow.postMessage({type:"vscode.init",data:d},"*",[...d.values()]),p.onmessage=o=>{const{data:n}=o;if(!(n instanceof ArrayBuffer)){this._onDidExit.fire([77,"UNKNOWN data received"]);return}t.fire(W.wrap(new Uint8Array(n,0,n.byteLength)))};const w={onMessage:t.event,send:o=>{const n=o.buffer.buffer.slice(o.buffer.byteOffset,o.buffer.byteOffset+o.buffer.byteLength);p.postMessage(n,[n])}};return this._performHandshake(w)}async _performHandshake(r){if(await _.toPromise(_.filter(r.onMessage,t=>R(t,E.Ready))),this._isTerminating)throw y();if(r.send(W.fromString(JSON.stringify(await this._createExtHostInitData()))),this._isTerminating)throw y();if(await _.toPromise(_.filter(r.onMessage,t=>R(t,E.Initialized))),this._isTerminating)throw y();return r}dispose(){this._isTerminating||(this._isTerminating=!0,this._protocol?.send(le(E.Terminate)),super.dispose())}getInspectPort(){}enableInspectPort(){return Promise.resolve(!1)}async _createExtHostInitData(){const r=await this._initDataProvider.getInitData();this.extensions=r.extensions;const t=this._contextService.getWorkspace(),e=this._productService.extensionsGallery?.nlsBaseUrl;let s;return e&&this._productService.commit&&!u.Language.isDefaultVariant()&&(s=H.joinPath(H.parse(e),this._productService.commit,this._productService.version,u.Language.value())),{commit:this._productService.commit,version:this._productService.version,quality:this._productService.quality,parentPid:0,environment:{isExtensionDevelopmentDebug:this._environmentService.debugRenderer,appName:this._productService.nameLong,appHost:this._productService.embedderIdentifier??(u.isWeb?"web":"desktop"),appUriScheme:this._productService.urlProtocol,appLanguage:u.language,extensionTelemetryLogResource:this._environmentService.extHostTelemetryLogFile,isExtensionTelemetryLoggingOnly:ie(this._productService,this._environmentService),extensionDevelopmentLocationURI:this._environmentService.extensionDevelopmentLocationURI,extensionTestsLocationURI:this._environmentService.extensionTestsLocationURI,globalStorageHome:this._userDataProfilesService.defaultProfile.globalStorageHome,workspaceStorageHome:this._environmentService.workspaceStorageHome,extensionLogLevel:this._environmentService.extensionLogLevel},workspace:this._contextService.getWorkbenchState()===ae.EMPTY?void 0:{configuration:t.configuration||void 0,id:t.id,name:this._labelService.getWorkspaceLabel(t),transient:t.transient},consoleForward:{includeStack:!1,logNative:this._environmentService.debugRenderer},extensions:this.extensions.toSnapshot(),nlsBaseUrl:s,telemetryInfo:{sessionId:this._telemetryService.sessionId,machineId:this._telemetryService.machineId,sqmId:this._telemetryService.sqmId,devDeviceId:this._telemetryService.devDeviceId,firstSessionDate:this._telemetryService.firstSessionDate,msftInternal:this._telemetryService.msftInternal},logLevel:this._logService.getLevel(),loggers:[...this._loggerService.getRegisteredLoggers()],logsLocation:this._extensionHostLogsLocation,autoStart:this.startup===me.EagerAutoStart,remote:{authority:this._environmentService.remoteAuthority,connectionData:null,isRemote:!1},uiKind:u.isWeb?M.Web:M.Desktop}}};I=L([a(3,oe),a(4,ne),a(5,J),a(6,Q),a(7,Z),a(8,ce),a(9,se),a(10,ee),a(11,Y),a(12,te)],I);export{I as WebWorkerExtensionHost};
