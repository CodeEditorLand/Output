import{basename as $}from"../../../../base/common/path.js";import*as _ from"../../../../base/common/json.js";import{Color as k}from"../../../../base/common/color.js";import{ExtensionData as H,VS_LIGHT_THEME as Y,VS_HC_THEME as q,THEME_SCOPE_CLOSE_PAREN as X,THEME_SCOPE_OPEN_PAREN as Z,themeScopeRegex as Q,THEME_SCOPE_WILDCARD as x,VS_HC_LIGHT_THEME as ee}from"./workbenchThemeService.js";import{convertSettings as O}from"./themeCompatibility.js";import*as S from"../../../../nls.js";import*as T from"../../../../base/common/types.js";import*as R from"../../../../base/common/resources.js";import{Extensions as te,editorBackground as w,editorForeground as z,DEFAULT_COLOR_CONFIG_VALUE as A}from"../../../../platform/theme/common/colorRegistry.js";import{getThemeTypeSelector as oe}from"../../../../platform/theme/common/themeService.js";import{Registry as ne}from"../../../../platform/registry/common/platform.js";import{getParseErrorMessage as ie}from"../../../../base/common/jsonErrorMessages.js";import"../../../../base/common/uri.js";import{parse as re}from"./plistParser.js";import{TokenStyle as E,SemanticTokenRule as j,getTokenClassificationRegistry as se,parseClassifierString as L}from"../../../../platform/theme/common/tokenClassificationRegistry.js";import{createMatchers as F}from"./textMateScopeMatcher.js";import"../../../../platform/extensionResourceLoader/common/extensionResourceLoader.js";import{CharCode as g}from"../../../../base/common/charCode.js";import{StorageScope as U,StorageTarget as ae}from"../../../../platform/storage/common/storage.js";import"./themeConfiguration.js";import{ColorScheme as P}from"../../../../platform/theme/common/theme.js";import{ColorId as le,FontStyle as v,MetadataConsts as b}from"../../../../editor/common/encodedTokenAttributes.js";import{toStandardTokenType as ce}from"../../../../editor/common/languages/supports/tokenization.js";const ue=ne.as(te.ColorContribution),D=se(),G={comments:["comment","punctuation.definition.comment"],strings:["string","meta.embedded.assembly"],keywords:["keyword - keyword.operator","keyword.control","storage","storage.type"],numbers:["constant.numeric"],types:["entity.name.type","entity.name.class","support.type","support.class"],functions:["entity.name.function","support.function"],variables:["variable","entity.name.variable"]};class C{static STORAGE_KEY="colorThemeData";id;label;settingsId;description;isLoaded;location;watch;extensionData;themeSemanticHighlighting;customSemanticHighlighting;customSemanticHighlightingDeprecated;themeTokenColors=[];customTokenColors=[];colorMap={};customColorMap={};semanticTokenRules=[];customSemanticTokenRules=[];themeTokenScopeMatchers;customTokenScopeMatchers;textMateThemingRules=void 0;tokenColorIndex=void 0;constructor(e,t,o){this.id=e,this.label=t,this.settingsId=o,this.isLoaded=!1}get semanticHighlighting(){return this.customSemanticHighlighting!==void 0?this.customSemanticHighlighting:this.customSemanticHighlightingDeprecated!==void 0?this.customSemanticHighlightingDeprecated:!!this.themeSemanticHighlighting}get tokenColors(){if(!this.textMateThemingRules){let a=function(s){s.scope&&s.settings&&(s.scope==="token.info-token"&&(r=!0),t.push({scope:s.scope,settings:{foreground:y(s.settings.foreground),background:y(s.settings.background),fontStyle:s.settings.fontStyle}}))};var e=a;const t=[],o=this.getColor(z)||this.getDefault(z),n=this.getColor(w)||this.getDefault(w);t.push({settings:{foreground:y(o),background:y(n)}});let r=!1;this.themeTokenColors.forEach(a),this.customTokenColors.forEach(a),r||fe[this.type].forEach(a),this.textMateThemingRules=t}return this.textMateThemingRules}getColor(e,t){const o=this.customColorMap[e];if(o instanceof k)return o;if(o===void 0){const n=this.colorMap[e];if(n!==void 0)return n}if(t!==!1)return this.getDefault(e)}getTokenStyle(e,t,o,n=!0,r={}){const a={foreground:void 0,bold:void 0,underline:void 0,strikethrough:void 0,italic:void 0},s={foreground:-1,bold:-1,underline:-1,strikethrough:-1,italic:-1};function l(u,d,h){d.foreground&&s.foreground<=u&&(s.foreground=u,a.foreground=d.foreground,r.foreground=h);for(const p of["bold","underline","strikethrough","italic"]){const m=p,I=d[m];I!==void 0&&s[m]<=u&&(s[m]=u,a[m]=I,r[m]=h)}}function c(u){const d=u.selector.match(e,t,o);d>=0&&l(d,u.style,u)}this.semanticTokenRules.forEach(c),this.customSemanticTokenRules.forEach(c);let f=!1;for(const u in s){const d=u;s[d]===-1?f=!0:s[d]=Number.MAX_VALUE}if(f)for(const u of D.getTokenStylingDefaultRules()){const d=u.selector.match(e,t,o);if(d>=0){let h;if(u.defaults.scopesToProbe&&(h=this.resolveScopes(u.defaults.scopesToProbe),h&&l(d,h,u.defaults.scopesToProbe)),!h&&n!==!1){const p=u.defaults[this.type];h=this.resolveTokenStyleValue(p),h&&l(d,h,p)}}}return E.fromData(a)}resolveTokenStyleValue(e){if(e!==void 0){if(typeof e=="string"){const{type:t,modifiers:o,language:n}=L(e,"");return this.getTokenStyle(t,o,n)}else if(typeof e=="object")return e}}getTokenColorIndex(){if(!this.tokenColorIndex){const e=new me;this.tokenColors.forEach(t=>{e.add(t.settings.foreground),e.add(t.settings.background)}),this.semanticTokenRules.forEach(t=>e.add(t.style.foreground)),D.getTokenStylingDefaultRules().forEach(t=>{const o=t.defaults[this.type];o&&typeof o=="object"&&e.add(o.foreground)}),this.customSemanticTokenRules.forEach(t=>e.add(t.style.foreground)),this.tokenColorIndex=e}return this.tokenColorIndex}get tokenColorMap(){return this.getTokenColorIndex().asArray()}getTokenStyleMetadata(e,t,o,n=!0,r={}){const{type:a,language:s}=L(e,o),l=this.getTokenStyle(a,t,s,n,r);if(l)return{foreground:this.getTokenColorIndex().get(l.foreground),bold:l.bold,underline:l.underline,strikethrough:l.strikethrough,italic:l.italic}}getTokenStylingRuleScope(e){if(this.customSemanticTokenRules.indexOf(e)!==-1)return"setting";if(this.semanticTokenRules.indexOf(e)!==-1)return"theme"}getDefault(e){return ue.resolveDefaultColor(e,this)}resolveScopes(e,t){this.themeTokenScopeMatchers||(this.themeTokenScopeMatchers=this.themeTokenColors.map(W)),this.customTokenScopeMatchers||(this.customTokenScopeMatchers=this.customTokenColors.map(W));for(const n of e){let u=function(d,h){for(let p=0;p<d.length;p++){const m=d[p](n);if(m>=0){const I=h[p],M=h[p].settings;m>=s&&M.foreground&&(r=M.foreground,s=m,f=I),m>=l&&T.isString(M.fontStyle)&&(a=M.fontStyle,l=m,c=I)}}};var o=u;let r,a,s=-1,l=-1,c,f;if(u(this.themeTokenScopeMatchers,this.themeTokenColors),u(this.customTokenScopeMatchers,this.customTokenColors),r!==void 0||a!==void 0)return t&&(t.foreground=f,t.bold=t.italic=t.underline=t.strikethrough=c,t.scope=n),E.fromSettings(r,a)}}defines(e){const t=this.customColorMap[e];return t instanceof k?!0:t===void 0&&this.colorMap.hasOwnProperty(e)}setCustomizations(e){this.setCustomColors(e.colorCustomizations),this.setCustomTokenColors(e.tokenColorCustomizations),this.setCustomSemanticTokenColors(e.semanticTokenColorCustomizations)}setCustomColors(e){this.customColorMap={},this.overwriteCustomColors(e);const t=this.getThemeSpecificColors(e);T.isObject(t)&&this.overwriteCustomColors(t),this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.customTokenScopeMatchers=void 0}overwriteCustomColors(e){for(const t in e){const o=e[t];o===A?this.customColorMap[t]=A:typeof o=="string"&&(this.customColorMap[t]=k.fromHex(o))}}setCustomTokenColors(e){this.customTokenColors=[],this.customSemanticHighlightingDeprecated=void 0,this.addCustomTokenColors(e);const t=this.getThemeSpecificColors(e);T.isObject(t)&&this.addCustomTokenColors(t),this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.customTokenScopeMatchers=void 0}setCustomSemanticTokenColors(e){if(this.customSemanticTokenRules=[],this.customSemanticHighlighting=void 0,e){this.customSemanticHighlighting=e.enabled,e.rules&&this.readSemanticTokenRules(e.rules);const t=this.getThemeSpecificColors(e);T.isObject(t)&&(t.enabled!==void 0&&(this.customSemanticHighlighting=t.enabled),t.rules&&this.readSemanticTokenRules(t.rules))}this.tokenColorIndex=void 0,this.textMateThemingRules=void 0}isThemeScope(e){return e.charAt(0)===Z&&e.charAt(e.length-1)===X}isThemeScopeMatch(e){const t=e.charAt(0),o=e.charAt(e.length-1),n=e.slice(0,-1),r=e.slice(1,-1),a=e.slice(1);return e===this.settingsId||this.settingsId.includes(r)&&t===x&&o===x||this.settingsId.startsWith(n)&&o===x||this.settingsId.endsWith(a)&&t===x}getThemeSpecificColors(e){let t;for(const o in e){const n=e[o];if(this.isThemeScope(o)&&n instanceof Object&&!Array.isArray(n)){const r=o.match(Q)||[];for(const a of r){const s=a.substring(1,a.length-1);if(this.isThemeScopeMatch(s)){t||(t={});const l=n;for(const c in l){const f=t[c],u=l[c];Array.isArray(f)&&Array.isArray(u)?t[c]=f.concat(u):u&&(t[c]=u)}}}}}return t}readSemanticTokenRules(e){for(const t in e)if(!this.isThemeScope(t))try{const o=B(t,e[t]);o&&this.customSemanticTokenRules.push(o)}catch{}}addCustomTokenColors(e){for(const t in G){const o=t,n=e[o];if(n){const r=typeof n=="string"?{foreground:n}:n,a=G[o];for(const s of a)this.customTokenColors.push({scope:s,settings:r})}}if(Array.isArray(e.textMateRules))for(const t of e.textMateRules)t.scope&&t.settings&&this.customTokenColors.push(t);e.semanticHighlighting!==void 0&&(this.customSemanticHighlightingDeprecated=e.semanticHighlighting)}ensureLoaded(e){return this.isLoaded?Promise.resolve(void 0):this.load(e)}reload(e){return this.load(e)}load(e){if(!this.location)return Promise.resolve(void 0);this.themeTokenColors=[],this.clearCaches();const t={colors:{},textMateRules:[],semanticTokenRules:[],semanticHighlighting:!1};return V(e,this.location,t).then(o=>{this.isLoaded=!0,this.semanticTokenRules=t.semanticTokenRules,this.colorMap=t.colors,this.themeTokenColors=t.textMateRules,this.themeSemanticHighlighting=t.semanticHighlighting})}clearCaches(){this.tokenColorIndex=void 0,this.textMateThemingRules=void 0,this.themeTokenScopeMatchers=void 0,this.customTokenScopeMatchers=void 0}toStorage(e){const t={};for(const n in this.colorMap)t[n]=k.Format.CSS.formatHexA(this.colorMap[n],!0);const o=JSON.stringify({id:this.id,label:this.label,settingsId:this.settingsId,themeTokenColors:this.themeTokenColors.map(n=>({settings:n.settings,scope:n.scope})),semanticTokenRules:this.semanticTokenRules.map(j.toJSONObject),extensionData:H.toJSONObject(this.extensionData),themeSemanticHighlighting:this.themeSemanticHighlighting,colorMap:t,watch:this.watch});e.store(C.STORAGE_KEY,o,U.PROFILE,ae.USER)}get baseTheme(){return this.classNames[0]}get classNames(){return this.id.split(" ")}get type(){switch(this.baseTheme){case Y:return P.LIGHT;case q:return P.HIGH_CONTRAST_DARK;case ee:return P.HIGH_CONTRAST_LIGHT;default:return P.DARK}}static createUnloadedThemeForThemeType(e,t){return C.createUnloadedTheme(oe(e),t)}static createUnloadedTheme(e,t){const o=new C(e,"","__"+e);if(o.isLoaded=!1,o.themeTokenColors=[],o.watch=!1,t)for(const n in t)o.colorMap[n]=k.fromHex(t[n]);return o}static createLoadedEmptyTheme(e,t){const o=new C(e,"",t);return o.isLoaded=!0,o.themeTokenColors=[],o.watch=!1,o}static fromStorageData(e){const t=e.get(C.STORAGE_KEY,U.PROFILE);if(t)try{const o=JSON.parse(t),n=new C("","","");for(const r in o)switch(r){case"colorMap":{const a=o[r];for(const s in a)n.colorMap[s]=k.fromHex(a[s]);break}case"themeTokenColors":case"id":case"label":case"settingsId":case"watch":case"themeSemanticHighlighting":n[r]=o[r];break;case"semanticTokenRules":{const a=o[r];if(Array.isArray(a))for(const s of a){const l=j.fromJSONObject(D,s);l&&n.semanticTokenRules.push(l)}break}case"location":break;case"extensionData":n.extensionData=H.fromJSONObject(o.extensionData);break}return!n.id||!n.settingsId?void 0:n}catch{return}}static fromExtensionTheme(e,t,o){const n=e.uiTheme||"vs-dark",r=de(o.extensionId,e.path),a=`${n} ${r}`,s=e.label||$(e.path),l=e.id||s,c=new C(a,s,l);return c.description=e.description,c.watch=e._watch===!0,c.location=t,c.extensionData=o,c.isLoaded=!1,c}}function de(i,e){e.startsWith("./")&&(e=e.substr(2));let t=`${i}-${e}`;return t=t.replace(/[^_a-zA-Z0-9-]/g,"-"),t.charAt(0).match(/[0-9-]/)&&(t="_"+t),t}async function V(i,e,t){if(R.extname(e)===".json"){const o=await i.readExtensionResource(e),n=[],r=_.parse(o,n);if(n.length>0)return Promise.reject(new Error(S.localize("error.cannotparsejson","Problems parsing JSON theme file: {0}",n.map(c=>ie(c.error)).join(", "))));if(_.getNodeType(r)!=="object")return Promise.reject(new Error(S.localize("error.invalidformat","Invalid format for JSON theme file: Object expected.")));if(r.include&&await V(i,R.joinPath(R.dirname(e),r.include),t),Array.isArray(r.settings))return O(r.settings,t),null;t.semanticHighlighting=t.semanticHighlighting||r.semanticHighlighting;const a=r.colors;if(a){if(typeof a!="object")return Promise.reject(new Error(S.localize({key:"error.invalidformat.colors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'colors' is not of type 'object'.",e.toString())));for(const c in a){const f=a[c];f===A?delete t.colors[c]:typeof f=="string"&&(t.colors[c]=k.fromHex(a[c]))}}const s=r.tokenColors;if(s)if(Array.isArray(s))t.textMateRules.push(...s);else if(typeof s=="string")await N(i,R.joinPath(R.dirname(e),s),t);else return Promise.reject(new Error(S.localize({key:"error.invalidformat.tokenColors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'tokenColors' should be either an array specifying colors or a path to a TextMate theme file",e.toString())));const l=r.semanticTokenColors;if(l&&typeof l=="object")for(const c in l)try{const f=B(c,l[c]);f&&t.semanticTokenRules.push(f)}catch{return Promise.reject(new Error(S.localize({key:"error.invalidformat.semanticTokenColors",comment:["{0} will be replaced by a path. Values in quotes should not be translated."]},"Problem parsing color theme file: {0}. Property 'semanticTokenColors' contains a invalid selector",e.toString())))}}else return N(i,e,t)}function N(i,e,t){return i.readExtensionResource(e).then(o=>{try{const r=re(o).settings;return Array.isArray(r)?(O(r,t),Promise.resolve(null)):Promise.reject(new Error(S.localize("error.plist.invalidformat","Problem parsing tmTheme file: {0}. 'settings' is not array.")))}catch(n){return Promise.reject(new Error(S.localize("error.cannotparse","Problems parsing tmTheme file: {0}",n.message)))}},o=>Promise.reject(new Error(S.localize("error.cannotload","Problems loading tmTheme file {0}: {1}",e.toString(),o.message))))}const fe={light:[{scope:"token.info-token",settings:{foreground:"#316bcd"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#cd3131"}},{scope:"token.debug-token",settings:{foreground:"#800080"}}],dark:[{scope:"token.info-token",settings:{foreground:"#6796e6"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#f44747"}},{scope:"token.debug-token",settings:{foreground:"#b267e6"}}],hcLight:[{scope:"token.info-token",settings:{foreground:"#316bcd"}},{scope:"token.warn-token",settings:{foreground:"#cd9731"}},{scope:"token.error-token",settings:{foreground:"#cd3131"}},{scope:"token.debug-token",settings:{foreground:"#800080"}}],hcDark:[{scope:"token.info-token",settings:{foreground:"#6796e6"}},{scope:"token.warn-token",settings:{foreground:"#008000"}},{scope:"token.error-token",settings:{foreground:"#FF0000"}},{scope:"token.debug-token",settings:{foreground:"#b267e6"}}]},K=i=>-1;function J(i,e){if(e.length<i.length)return-1;let t=0,o;return i.every((r,a)=>{for(let s=t;s<e.length;s++)if(he(e[s],r))return o=(a+1)*65536+r.length,t=s+1,!0;return!1})&&o!==void 0?o:-1}function he(i,e){if(!i)return!1;if(i===e)return!0;const t=e.length;return i.length>t&&i.substr(0,t)===e&&i[t]==="."}function W(i){const e=i.scope;if(!e||!i.settings)return K;const t=[];if(Array.isArray(e))for(const o of e)F(o,J,t);else F(e,J,t);return t.length===0?K:o=>{let n=t[0].matcher(o);for(let r=1;r<t.length;r++)n=Math.max(n,t[r].matcher(o));return n}}function B(i,e){const t=D.parseTokenSelector(i);let o;if(typeof e=="string"?o=E.fromSettings(e,void 0):ge(e)&&(o=E.fromSettings(e.foreground,e.fontStyle,e.bold,e.underline,e.strikethrough,e.italic)),o)return{selector:t,style:o}}function ge(i){return i&&(T.isString(i.foreground)||T.isString(i.fontStyle)||T.isBoolean(i.italic)||T.isBoolean(i.underline)||T.isBoolean(i.strikethrough)||T.isBoolean(i.bold))}function rt(i,e,t){let o=0;o|=t<<b.LANGUAGEID_OFFSET;const n={},r=i.resolveScopes([e],n);if(e.length>0){const l=ce(e[e.length-1]);o|=l<<b.TOKEN_TYPE_OFFSET}switch(n.foreground?.settings.fontStyle){case"italic":o|=v.Italic|b.ITALIC_MASK;break;case"bold":o|=v.Bold|b.BOLD_MASK;break;case"underline":o|=v.Underline|b.UNDERLINE_MASK;break;case"strikethrough":o|=v.Strikethrough|b.STRIKETHROUGH_MASK;break}const a=r?.foreground,s=a!==void 0?i.getTokenColorIndex().get(a):le.DefaultForeground;return o|=s<<b.FOREGROUND_OFFSET,o}class me{_lastColorId;_id2color;_color2id;constructor(){this._lastColorId=0,this._id2color=[],this._color2id=Object.create(null)}add(e){if(e=y(e),e===void 0)return 0;let t=this._color2id[e];return t||(t=++this._lastColorId,this._color2id[e]=t,this._id2color[t]=e,t)}get(e){if(e=y(e),e===void 0)return 0;const t=this._color2id[e];return t||0}asArray(){return this._id2color.slice(0)}}function y(i){if(!i)return;typeof i!="string"&&(i=k.Format.CSS.formatHexA(i,!0));const e=i.length;if(i.charCodeAt(0)!==g.Hash||e!==4&&e!==5&&e!==7&&e!==9)return;const t=[g.Hash];for(let o=1;o<e;o++){const n=pe(i.charCodeAt(o));if(!n)return;t.push(n),(e===4||e===5)&&t.push(n)}return t.length===9&&t[7]===g.F&&t[8]===g.F&&(t.length=7),String.fromCharCode(...t)}function pe(i){return i>=g.Digit0&&i<=g.Digit9||i>=g.A&&i<=g.F?i:i>=g.a&&i<=g.f?i-g.a+g.A:0}export{C as ColorThemeData,rt as findMetadata};
