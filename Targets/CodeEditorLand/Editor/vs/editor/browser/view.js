var L=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var W=(a,o,e,t)=>{for(var i=t>1?void 0:t?E(o,e):o,r=a.length-1,n;r>=0;r--)(n=a[r])&&(i=(t?n(o,e,i):n(i))||i);return t&&i&&L(o,e,i),i},N=(a,o)=>(e,t)=>o(e,t,a);import*as w from"../../base/browser/dom.js";import{createFastDomNode as C}from"../../base/browser/fastDomNode.js";import"../../base/browser/mouseEvent.js";import{inputLatency as M}from"../../base/browser/performance.js";import"../../base/browser/window.js";import{BugIndicatingError as c,onUnexpectedError as I}from"../../base/common/errors.js";import"../../base/common/lifecycle.js";import"./controller/mouseHandler.js";import{PointerHandlerLastRenderData as G}from"./controller/mouseTarget.js";import{PointerHandler as V}from"./controller/pointerHandler.js";import"./editorBrowser.js";import{RenderingContext as O}from"./view/renderingContext.js";import{ViewController as T}from"./view/viewController.js";import{ContentViewOverlays as A,MarginViewOverlays as F}from"./view/viewOverlays.js";import{PartFingerprint as S,PartFingerprints as H}from"./view/viewPart.js";import{ViewUserInputEvents as Z}from"./view/viewUserInputEvents.js";import{BlockDecorations as B}from"./viewParts/blockDecorations/blockDecorations.js";import{ViewContentWidgets as k}from"./viewParts/contentWidgets/contentWidgets.js";import{CurrentLineHighlightOverlay as U,CurrentLineMarginHighlightOverlay as q}from"./viewParts/currentLineHighlight/currentLineHighlight.js";import{DecorationsOverlay as z}from"./viewParts/decorations/decorations.js";import{EditorScrollbar as j}from"./viewParts/editorScrollbar/editorScrollbar.js";import{GlyphMarginWidgets as J}from"./viewParts/glyphMargin/glyphMargin.js";import{IndentGuidesOverlay as K}from"./viewParts/indentGuides/indentGuides.js";import{LineNumbersOverlay as Q}from"./viewParts/lineNumbers/lineNumbers.js";import{ViewLines as X}from"./viewParts/viewLines/viewLines.js";import{LinesDecorationsOverlay as Y}from"./viewParts/linesDecorations/linesDecorations.js";import{Margin as $}from"./viewParts/margin/margin.js";import{MarginViewLineDecorationsOverlay as ee}from"./viewParts/marginDecorations/marginDecorations.js";import{Minimap as te}from"./viewParts/minimap/minimap.js";import{ViewOverlayWidgets as ie}from"./viewParts/overlayWidgets/overlayWidgets.js";import{DecorationsOverviewRuler as ne}from"./viewParts/overviewRuler/decorationsOverviewRuler.js";import{OverviewRuler as oe}from"./viewParts/overviewRuler/overviewRuler.js";import{Rulers as re}from"./viewParts/rulers/rulers.js";import{ScrollDecorationViewPart as se}from"./viewParts/scrollDecoration/scrollDecoration.js";import{SelectionsOverlay as de}from"./viewParts/selections/selections.js";import{ViewCursors as ae}from"./viewParts/viewCursors/viewCursors.js";import{ViewZones as le}from"./viewParts/viewZones/viewZones.js";import{WhitespaceOverlay as he}from"./viewParts/whitespace/whitespace.js";import"../common/config/editorConfiguration.js";import{EditorOption as u}from"../common/config/editorOptions.js";import{Position as P}from"../common/core/position.js";import{Range as pe}from"../common/core/range.js";import{Selection as ce}from"../common/core/selection.js";import{ScrollType as ue}from"../common/editorCommon.js";import{GlyphMarginLane as me}from"../common/model.js";import{ViewEventHandler as ve}from"../common/viewEventHandler.js";import"../common/viewEvents.js";import{ViewportData as ge}from"../common/viewLayout/viewLinesViewportData.js";import"../common/viewModel.js";import{ViewContext as _e}from"../common/viewModel/viewContext.js";import{IInstantiationService as we}from"../../platform/instantiation/common/instantiation.js";import{getThemeTypeSelector as Ce}from"../../platform/theme/common/themeService.js";import{ViewGpuContext as fe}from"./gpu/viewGpuContext.js";import{ViewLinesGpu as xe}from"./viewParts/viewLinesGpu/viewLinesGpu.js";import"./controller/editContext/editContext.js";import{TextAreaEditContext as ye}from"./controller/editContext/textArea/textAreaEditContext.js";import{NativeEditContext as D}from"./controller/editContext/native/nativeEditContext.js";import{RulersGpu as Re}from"./viewParts/rulersGpu/rulersGpu.js";import{EditContext as be}from"./controller/editContext/native/editContextFactory.js";let v=class extends ve{constructor(e,t,i,r,n,s,m){super();this._instantiationService=m;this._selections=[new ce(1,1,1,1)],this._renderAnimationFrame=null,this._overflowGuardContainer=C(document.createElement("div")),H.write(this._overflowGuardContainer,S.OverflowGuard),this._overflowGuardContainer.setClassName("overflow-guard"),this._viewController=new T(t,r,n,e),this._context=new _e(t,i,r),this._context.addEventHandler(this),this._viewParts=[],this._experimentalEditContextEnabled=this._context.configuration.options.get(u.experimentalEditContextEnabled),this._editContext=this._instantiateEditContext(this._experimentalEditContextEnabled),this._viewParts.push(this._editContext),this._linesContent=C(document.createElement("div")),this._linesContent.setClassName("lines-content monaco-editor-background"),this._linesContent.setPosition("absolute"),this.domNode=C(document.createElement("div")),this.domNode.setClassName(this._getEditorClassName()),this.domNode.setAttribute("role","code"),this._context.configuration.options.get(u.experimentalGpuAcceleration)==="on"&&(this._viewGpuContext=this._instantiationService.createInstance(fe,this._context)),this._scrollbar=new j(this._context,this._linesContent,this.domNode,this._overflowGuardContainer),this._viewParts.push(this._scrollbar),this._viewLines=new X(this._context,this._linesContent),this._viewGpuContext&&(this._viewLinesGpu=this._instantiationService.createInstance(xe,this._context,this._viewGpuContext)),this._viewZones=new le(this._context),this._viewParts.push(this._viewZones);const g=new ne(this._context);this._viewParts.push(g);const x=new se(this._context);this._viewParts.push(x);const l=new A(this._context);this._viewParts.push(l),l.addDynamicOverlay(new U(this._context)),l.addDynamicOverlay(new de(this._context)),l.addDynamicOverlay(new K(this._context)),l.addDynamicOverlay(new z(this._context)),l.addDynamicOverlay(new he(this._context));const h=new F(this._context);this._viewParts.push(h),h.addDynamicOverlay(new q(this._context)),h.addDynamicOverlay(new ee(this._context)),h.addDynamicOverlay(new Y(this._context)),h.addDynamicOverlay(new Q(this._context)),this._glyphMarginWidgets=new J(this._context),this._viewParts.push(this._glyphMarginWidgets);const p=new $(this._context);p.getDomNode().appendChild(this._viewZones.marginDomNode),p.getDomNode().appendChild(h.getDomNode()),p.getDomNode().appendChild(this._glyphMarginWidgets.domNode),this._viewParts.push(p),this._contentWidgets=new k(this._context,this.domNode),this._viewParts.push(this._contentWidgets),this._viewCursors=new ae(this._context),this._viewParts.push(this._viewCursors),this._overlayWidgets=new ie(this._context,this.domNode),this._viewParts.push(this._overlayWidgets);const _=this._viewGpuContext?new Re(this._context,this._viewGpuContext):new re(this._context);this._viewParts.push(_);const y=new B(this._context);this._viewParts.push(y);const R=new te(this._context);if(this._viewParts.push(R),g){const b=this._scrollbar.getOverviewRulerLayoutInfo();b.parent.insertBefore(g.getDomNode(),b.insertBefore)}this._linesContent.appendChild(l.getDomNode()),"domNode"in _&&this._linesContent.appendChild(_.domNode),this._linesContent.appendChild(this._viewZones.domNode),this._linesContent.appendChild(this._viewLines.getDomNode()),this._linesContent.appendChild(this._contentWidgets.domNode),this._linesContent.appendChild(this._viewCursors.getDomNode()),this._overflowGuardContainer.appendChild(p.getDomNode()),this._overflowGuardContainer.appendChild(this._scrollbar.getDomNode()),this._viewGpuContext&&this._overflowGuardContainer.appendChild(this._viewGpuContext.canvas),this._overflowGuardContainer.appendChild(x.getDomNode()),this._overflowGuardContainer.appendChild(this._overlayWidgets.getDomNode()),this._overflowGuardContainer.appendChild(R.getDomNode()),this._overflowGuardContainer.appendChild(y.domNode),this.domNode.appendChild(this._overflowGuardContainer),s?(s.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode.domNode),s.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode.domNode)):(this.domNode.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode),this.domNode.appendChild(this._overlayWidgets.overflowingOverlayWidgetsDomNode)),this._applyLayout(),this._pointerHandler=this._register(new V(this._context,this._viewController,this._createPointerHandlerHelper()))}_scrollbar;_context;_viewGpuContext;_selections;_viewLines;_viewLinesGpu;_viewZones;_contentWidgets;_overlayWidgets;_glyphMarginWidgets;_viewCursors;_viewParts;_viewController;_experimentalEditContextEnabled;_editContext;_pointerHandler;_linesContent;domNode;_overflowGuardContainer;_shouldRecomputeGlyphMarginLanes=!1;_renderAnimationFrame;_instantiateEditContext(e){const t=w.getWindow(this._overflowGuardContainer.domNode),i=be.supported(t),r=e&&i?D:ye;return this._instantiationService.createInstance(r,this._context,this._overflowGuardContainer,this._viewController,this._createTextAreaHandlerHelper())}_updateEditContext(){const e=this._context.configuration.options.get(u.experimentalEditContextEnabled);if(this._experimentalEditContextEnabled===e)return;this._experimentalEditContextEnabled=e,this._editContext.dispose(),this._editContext=this._instantiateEditContext(e);const t=this._viewParts.indexOf(this._editContext);t!==-1&&this._viewParts.splice(t,1,this._editContext)}_computeGlyphMarginLanes(){const e=this._context.viewModel.model,t=this._context.viewModel.glyphLanes;let i=[],r=0;i=i.concat(e.getAllMarginDecorations().map(n=>{const s=n.options.glyphMargin?.position??me.Center;return r=Math.max(r,n.range.endLineNumber),{range:n.range,lane:s,persist:n.options.glyphMargin?.persistLane}})),i=i.concat(this._glyphMarginWidgets.getWidgets().map(n=>{const s=e.validateRange(n.preference.range);return r=Math.max(r,s.endLineNumber),{range:s,lane:n.preference.lane}})),i.sort((n,s)=>pe.compareRangesUsingStarts(n.range,s.range)),t.reset(r);for(const n of i)t.push(n.lane,n.range,n.persist);return t}_createPointerHandlerHelper(){return{viewDomNode:this.domNode.domNode,linesContentDomNode:this._linesContent.domNode,viewLinesDomNode:this._viewLines.getDomNode().domNode,focusTextArea:()=>{this.focus()},dispatchTextAreaEvent:e=>{this._editContext.domNode.domNode.dispatchEvent(e)},getLastRenderData:()=>{const e=this._viewCursors.getLastRenderData()||[],t=this._editContext.getLastRenderData();return new G(e,t)},renderNow:()=>{this.render(!0,!1)},shouldSuppressMouseDownOnViewZone:e=>this._viewZones.shouldSuppressMouseDownOnViewZone(e),shouldSuppressMouseDownOnWidget:e=>this._contentWidgets.shouldSuppressMouseDownOnWidget(e),getPositionFromDOMInfo:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getPositionFromDOMInfo(e,t)),visibleRangeForPosition:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(new P(e,t))),getLineWidth:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getLineWidth(e))}}_createTextAreaHandlerHelper(){return{visibleRangeForPosition:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(e)),linesVisibleRangesForRange:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.linesVisibleRangesForRange(e,t))}}_applyLayout(){const t=this._context.configuration.options.get(u.layoutInfo);this.domNode.setWidth(t.width),this.domNode.setHeight(t.height),this._overflowGuardContainer.setWidth(t.width),this._overflowGuardContainer.setHeight(t.height),this._linesContent.setWidth(16777216),this._linesContent.setHeight(16777216)}_getEditorClassName(){const e=this._editContext.isFocused()?" focused":"";return this._context.configuration.options.get(u.editorClassName)+" "+Ce(this._context.theme.type)+e}handleEvents(e){super.handleEvents(e),this._scheduleRender()}onConfigurationChanged(e){return this.domNode.setClassName(this._getEditorClassName()),this._updateEditContext(),this._applyLayout(),!1}onCursorStateChanged(e){return this._selections=e.selections,!1}onDecorationsChanged(e){return e.affectsGlyphMargin&&(this._shouldRecomputeGlyphMarginLanes=!0),!1}onFocusChanged(e){return this.domNode.setClassName(this._getEditorClassName()),!1}onThemeChanged(e){return this._context.theme.update(e.theme),this.domNode.setClassName(this._getEditorClassName()),!1}dispose(){this._renderAnimationFrame!==null&&(this._renderAnimationFrame.dispose(),this._renderAnimationFrame=null),this._contentWidgets.overflowingContentWidgetsDomNode.domNode.remove(),this._overlayWidgets.overflowingOverlayWidgetsDomNode.domNode.remove(),this._context.removeEventHandler(this),this._viewGpuContext?.dispose(),this._viewLines.dispose(),this._viewLinesGpu?.dispose();for(const e of this._viewParts)e.dispose();super.dispose()}_scheduleRender(){if(this._store.isDisposed)throw new c;if(this._renderAnimationFrame===null){this._editContext instanceof D&&this._editContext.setEditContextOnDomNode();const e=this._createCoordinatedRendering();this._renderAnimationFrame=f.INSTANCE.scheduleCoordinatedRendering({window:w.getWindow(this.domNode?.domNode),prepareRenderText:()=>{if(this._store.isDisposed)throw new c;try{return e.prepareRenderText()}finally{this._renderAnimationFrame=null}},renderText:()=>{if(this._store.isDisposed)throw new c;return e.renderText()},prepareRender:(t,i)=>{if(this._store.isDisposed)throw new c;return e.prepareRender(t,i)},render:(t,i)=>{if(this._store.isDisposed)throw new c;return e.render(t,i)}})}}_flushAccumulatedAndRenderNow(){const e=this._createCoordinatedRendering();d(()=>e.prepareRenderText());const t=d(()=>e.renderText());if(t){const[i,r]=t;d(()=>e.prepareRender(i,r)),d(()=>e.render(i,r))}}_getViewPartsToRender(){const e=[];let t=0;for(const i of this._viewParts)i.shouldRender()&&(e[t++]=i);return e}_createCoordinatedRendering(){return{prepareRenderText:()=>{if(this._shouldRecomputeGlyphMarginLanes){this._shouldRecomputeGlyphMarginLanes=!1;const e=this._computeGlyphMarginLanes();this._context.configuration.setGlyphMarginDecorationLaneCount(e.requiredLanes)}M.onRenderStart()},renderText:()=>{if(!this.domNode.domNode.isConnected)return null;let e=this._getViewPartsToRender();if(!this._viewLines.shouldRender()&&e.length===0)return null;const t=this._context.viewLayout.getLinesViewportData();this._context.viewModel.setViewport(t.startLineNumber,t.endLineNumber,t.centeredLineNumber);const i=new ge(this._selections,t,this._context.viewLayout.getWhitespaceViewportData(),this._context.viewModel);return this._contentWidgets.shouldRender()&&this._contentWidgets.onBeforeRender(i),this._viewLines.shouldRender()&&(this._viewLines.renderText(i),this._viewLines.onDidRender(),e=this._getViewPartsToRender()),this._viewLinesGpu?.shouldRender()&&(this._viewLinesGpu.renderText(i),this._viewLinesGpu.onDidRender()),[e,new O(this._context.viewLayout,i,this._viewLines,this._viewLinesGpu)]},prepareRender:(e,t)=>{for(const i of e)i.prepareRender(t)},render:(e,t)=>{for(const i of e)i.render(t),i.onDidRender()}}}delegateVerticalScrollbarPointerDown(e){this._scrollbar.delegateVerticalScrollbarPointerDown(e)}delegateScrollFromMouseWheelEvent(e){this._scrollbar.delegateScrollFromMouseWheelEvent(e)}restoreState(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e.scrollTop,scrollLeft:e.scrollLeft},ue.Immediate),this._context.viewModel.visibleLinesStabilized()}getOffsetForColumn(e,t){const i=this._context.viewModel.model.validatePosition({lineNumber:e,column:t}),r=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i);this._flushAccumulatedAndRenderNow();const n=this._viewLines.visibleRangeForPosition(new P(r.lineNumber,r.column));return n?n.left:-1}getTargetAtClientPoint(e,t){const i=this._pointerHandler.getTargetAtClientPoint(e,t);return i?Z.convertViewToModelMouseTarget(i,this._context.viewModel.coordinatesConverter):null}createOverviewRuler(e){return new oe(this._context,e)}change(e){this._viewZones.changeViewZones(e),this._scheduleRender()}render(e,t){if(t){this._viewLines.forceShouldRender();for(const i of this._viewParts)i.forceShouldRender()}e?this._flushAccumulatedAndRenderNow():this._scheduleRender()}writeScreenReaderContent(e){this._editContext.writeScreenReaderContent(e)}focus(){this._editContext.focus()}isFocused(){return this._editContext.isFocused()}refreshFocusState(){this._editContext.refreshFocusState()}setAriaOptions(e){this._editContext.setAriaOptions(e)}addContentWidget(e){this._contentWidgets.addWidget(e.widget),this.layoutContentWidget(e),this._scheduleRender()}layoutContentWidget(e){this._contentWidgets.setWidgetPosition(e.widget,e.position?.position??null,e.position?.secondaryPosition??null,e.position?.preference??null,e.position?.positionAffinity??null),this._scheduleRender()}removeContentWidget(e){this._contentWidgets.removeWidget(e.widget),this._scheduleRender()}addOverlayWidget(e){this._overlayWidgets.addWidget(e.widget),this.layoutOverlayWidget(e),this._scheduleRender()}layoutOverlayWidget(e){this._overlayWidgets.setWidgetPosition(e.widget,e.position)&&this._scheduleRender()}removeOverlayWidget(e){this._overlayWidgets.removeWidget(e.widget),this._scheduleRender()}addGlyphMarginWidget(e){this._glyphMarginWidgets.addWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}layoutGlyphMarginWidget(e){const t=e.position;this._glyphMarginWidgets.setWidgetPosition(e.widget,t)&&(this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender())}removeGlyphMarginWidget(e){this._glyphMarginWidgets.removeWidget(e.widget),this._shouldRecomputeGlyphMarginLanes=!0,this._scheduleRender()}};v=W([N(6,we)],v);function d(a){try{return a()}catch(o){return I(o),null}}class f{static INSTANCE=new f;_coordinatedRenderings=[];_animationFrameRunners=new Map;constructor(){}scheduleCoordinatedRendering(o){return this._coordinatedRenderings.push(o),this._scheduleRender(o.window),{dispose:()=>{const e=this._coordinatedRenderings.indexOf(o);if(e!==-1&&(this._coordinatedRenderings.splice(e,1),this._coordinatedRenderings.length===0)){for(const[t,i]of this._animationFrameRunners)i.dispose();this._animationFrameRunners.clear()}}}}_scheduleRender(o){if(!this._animationFrameRunners.has(o)){const e=()=>{this._animationFrameRunners.delete(o),this._onRenderScheduled()};this._animationFrameRunners.set(o,w.runAtThisOrScheduleAtNextAnimationFrame(o,e,100))}}_onRenderScheduled(){const o=this._coordinatedRenderings.slice(0);this._coordinatedRenderings=[];for(const t of o)d(()=>t.prepareRenderText());const e=[];for(let t=0,i=o.length;t<i;t++){const r=o[t];e[t]=d(()=>r.renderText())}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,m]=n;d(()=>r.prepareRender(s,m))}for(let t=0,i=o.length;t<i;t++){const r=o[t],n=e[t];if(!n)continue;const[s,m]=n;d(()=>r.render(s,m))}}}export{v as View};
