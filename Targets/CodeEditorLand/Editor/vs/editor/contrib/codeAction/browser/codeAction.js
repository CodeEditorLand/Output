import{coalesce as E,equals as M,isNonEmptyArray as I}from"../../../../base/common/arrays.js";import{CancellationToken as h}from"../../../../base/common/cancellation.js";import{illegalArgument as P,isCancellationError as R,onUnexpectedExternalError as D}from"../../../../base/common/errors.js";import{Disposable as K,DisposableStore as L}from"../../../../base/common/lifecycle.js";import{URI as N}from"../../../../base/common/uri.js";import"../../../browser/editorBrowser.js";import{IBulkEditService as q}from"../../../browser/services/bulkEditService.js";import{Range as H}from"../../../common/core/range.js";import{Selection as x}from"../../../common/core/selection.js";import"../../../common/languageFeatureRegistry.js";import*as w from"../../../common/languages.js";import"../../../common/model.js";import{ILanguageFeaturesService as z}from"../../../common/services/languageFeatures.js";import{IModelService as U}from"../../../common/services/model.js";import{TextModelCancellationTokenSource as B}from"../../editorState/browser/editorState.js";import*as V from"../../../../nls.js";import{CommandsRegistry as j,ICommandService as O}from"../../../../platform/commands/common/commands.js";import"../../../../platform/instantiation/common/instantiation.js";import{INotificationService as Q}from"../../../../platform/notification/common/notification.js";import{Progress as W}from"../../../../platform/progress/common/progress.js";import{ITelemetryService as _}from"../../../../platform/telemetry/common/telemetry.js";import{CodeActionItem as G,CodeActionKind as b,CodeActionTriggerSource as J,filtersAction as X,mayIncludeActionsOfKind as Y}from"../common/types.js";import{HierarchicalKind as A}from"../../../../base/common/hierarchicalKind.js";import{raceTimeout as Z}from"../../../../base/common/async.js";const Le="editor.action.codeAction",Ne="editor.action.quickFix",qe="editor.action.autoFix",He="editor.action.refactor",ze="editor.action.refactor.preview",Ue="editor.action.sourceAction",Be="editor.action.organizeImports",Ve="editor.action.fixAll";class C extends K{constructor(e,o,i){super();this.documentation=o;this._register(i),this.allActions=[...e].sort(C.codeActionsComparator),this.validActions=this.allActions.filter(({action:r})=>!r.disabled)}static codeActionsPreferredComparator(e,o){return e.isPreferred&&!o.isPreferred?-1:!e.isPreferred&&o.isPreferred?1:0}static codeActionsComparator({action:e},{action:o}){return e.isAI&&!o.isAI?1:!e.isAI&&o.isAI?-1:I(e.diagnostics)?I(o.diagnostics)?C.codeActionsPreferredComparator(e,o):-1:I(o.diagnostics)?1:C.codeActionsPreferredComparator(e,o)}validActions;allActions;get hasAutoFix(){return this.validActions.some(({action:e})=>!!e.kind&&b.QuickFix.contains(new A(e.kind))&&!!e.isPreferred)}get hasAIFix(){return this.validActions.some(({action:e})=>!!e.isAI)}get allAIFixes(){return this.validActions.every(({action:e})=>!!e.isAI)}}const k={actions:[],documentation:void 0};async function $(n,t,e,o,i,r){const c=o.filter||{},u={...c,excludes:[...c.excludes||[],b.Notebook]},p={only:c.include?.value,trigger:o.type},a=new B(t,r),m=o.type===w.CodeActionTriggerType.Auto,y=ee(n,t,m?u:c),d=new L,S=y.map(async s=>{try{const l=Promise.resolve(s.provideCodeActions(t,e,p,a.token)),g=await Z(l,1250,()=>i.report(s));if(g&&d.add(g),a.token.isCancellationRequested)return k;const f=(g?.actions||[]).filter(v=>v&&X(c,v)),T=te(s,f,c.include);return{actions:f.map(v=>new G(v,s)),documentation:T}}catch(l){if(R(l))throw l;return D(l),k}}),F=n.onDidChange(()=>{const s=n.all(t);M(s,y)||a.cancel()});try{const s=await Promise.all(S),l=s.map(f=>f.actions).flat(),g=[...E(s.map(f=>f.documentation)),...oe(n,t,o,l)];return new C(l,g,d)}finally{F.dispose(),a.dispose()}}function ee(n,t,e){return n.all(t).filter(o=>o.providedCodeActionKinds?o.providedCodeActionKinds.some(i=>Y(e,new A(i))):!0)}function*oe(n,t,e,o){if(t&&o.length)for(const i of n.all(t))i._getAdditionalMenuItems&&(yield*i._getAdditionalMenuItems?.({trigger:e.type,only:e.filter?.include?.value},o.map(r=>r.action)))}function te(n,t,e){if(!n.documentation)return;const o=n.documentation.map(i=>({kind:new A(i.kind),command:i.command}));if(e){let i;for(const r of o)r.kind.contains(e)&&(i?i.kind.contains(r.kind)&&(i=r):i=r);if(i)return i?.command}for(const i of t)if(i.kind){for(const r of o)if(r.kind.contains(new A(i.kind)))return r.command}}var ie=(r=>(r.OnSave="onSave",r.FromProblemsView="fromProblemsView",r.FromCodeActions="fromCodeActions",r.FromAILightbulb="fromAILightbulb",r.FromProblemsHover="fromProblemsHover",r))(ie||{});async function je(n,t,e,o,i=h.None){const r=n.get(q),c=n.get(O),u=n.get(_),p=n.get(Q);if(u.publicLog2("codeAction.applyCodeAction",{codeActionTitle:t.action.title,codeActionKind:t.action.kind,codeActionIsPreferred:!!t.action.isPreferred,reason:e}),await t.resolve(i),!i.isCancellationRequested&&!(t.action.edit?.edits.length&&!(await r.apply(t.action.edit,{editor:o?.editor,label:t.action.title,quotableLabel:t.action.title,code:"undoredo.codeAction",respectAutoSaveConfig:e!=="onSave",showPreview:o?.preview})).isApplied)&&t.action.command)try{await c.executeCommand(t.action.command.id,...t.action.command.arguments||[])}catch(a){const m=ne(a);p.error(typeof m=="string"?m:V.localize("applyCodeActionFailed","An unknown error occurred while applying the code action"))}}function ne(n){return typeof n=="string"?n:n instanceof Error&&typeof n.message=="string"?n.message:void 0}j.registerCommand("_executeCodeActionProvider",async function(n,t,e,o,i){if(!(t instanceof N))throw P();const{codeActionProvider:r}=n.get(z),c=n.get(U).getModel(t);if(!c)throw P();const u=x.isISelection(e)?x.liftSelection(e):H.isIRange(e)?c.validateRange(e):void 0;if(!u)throw P();const p=typeof o=="string"?new A(o):void 0,a=await $(r,c,u,{type:w.CodeActionTriggerType.Invoke,triggerAction:J.Default,filter:{includeSourceActions:!0,include:p}},W.None,h.None),m=[],y=Math.min(a.validActions.length,typeof i=="number"?i:0);for(let d=0;d<y;d++)m.push(a.validActions[d].resolve(h.None));try{return await Promise.all(m),a.validActions.map(d=>d.action)}finally{setTimeout(()=>a.dispose(),100)}});export{ie as ApplyCodeActionReason,je as applyCodeAction,qe as autoFixCommandId,Le as codeActionCommandId,Ve as fixAllCommandId,$ as getCodeActions,Be as organizeImportsCommandId,Ne as quickFixCommandId,He as refactorCommandId,ze as refactorPreviewCommandId,Ue as sourceActionCommandId};
