var A=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var R=(f,m,o,n)=>{for(var e=n>1?void 0:n?D(m,o):m,t=f.length-1,s;t>=0;t--)(s=f[t])&&(e=(n?s(m,o,e):s(e))||e);return n&&e&&A(m,o,e),e},b=(f,m)=>(o,n)=>m(o,n,f);import*as a from"../../../../../base/browser/dom.js";import{Disposable as $,DisposableStore as E}from"../../../../../base/common/lifecycle.js";import"../../common/chatModel.js";import{Emitter as F}from"../../../../../base/common/event.js";import{IInstantiationService as N}from"../../../../../platform/instantiation/common/instantiation.js";import{ResourceLabels as O}from"../../../../browser/labels.js";import{URI as I}from"../../../../../base/common/uri.js";import{FileKind as w,IFileService as H}from"../../../../../platform/files/common/files.js";import{Range as U}from"../../../../../editor/common/core/range.js";import{basename as M,dirname as T}from"../../../../../base/common/path.js";import{localize as h}from"../../../../../nls.js";import{ChatResponseReferencePartStatusKind as S}from"../../common/chatService.js";import{IOpenerService as V}from"../../../../../platform/opener/common/opener.js";import{IHoverService as _}from"../../../../../platform/hover/browser/hover.js";import{createInstantHoverDelegate as j}from"../../../../../base/browser/ui/hover/hoverDelegateFactory.js";let g=class extends ${constructor(o,n=[],e=a.$(".chat-attached-context"),t,s,l,r){super();this.variables=o;this.contentReferences=n;this.domNode=e;this.instantiationService=t;this.openerService=s;this.hoverService=l;this.fileService=r;this.initAttachedContext(e)}attachedContextDisposables=this._register(new E);_onDidChangeVisibility=this._register(new F);_contextResourceLabels=this.instantiationService.createInstance(O,{onDidChangeVisibility:this._onDidChangeVisibility.event});initAttachedContext(o){a.clearNode(o),this.attachedContextDisposables.clear(),a.setVisibility(!!this.variables.length,this.domNode);const n=this.attachedContextDisposables.add(j());this.variables.forEach(async e=>{const t=a.append(o,a.$(".chat-attached-context-attachment.show-file-icons")),s=this._contextResourceLabels.create(t,{supportIcons:!0,hoverDelegate:n,hoverTargetOverrride:t}),l=I.isUri(e.value)?e.value:e.value&&typeof e.value=="object"&&"uri"in e.value&&I.isUri(e.value.uri)?e.value.uri:void 0,r=e.value&&typeof e.value=="object"&&"range"in e.value&&U.isIRange(e.value.range)?e.value.range:void 0,v=this.contentReferences.find(i=>typeof i.reference=="object"&&"variableName"in i.reference&&i.reference.variableName===e.name),u=v?.options?.status?.kind===S.Omitted,y=u||v?.options?.status?.kind===S.Partial;let c;if(l&&e.isFile){const i=M(l.path),d=T(l.path),p=`${i} ${d}`;u?c=r?h("chat.omittedFileAttachmentWithRange","Omitted: {0}, line {1} to line {2}.",p,r.startLineNumber,r.endLineNumber):h("chat.omittedFileAttachment","Omitted: {0}.",p):y?c=r?h("chat.partialFileAttachmentWithRange","Partially attached: {0}, line {1} to line {2}.",p,r.startLineNumber,r.endLineNumber):h("chat.partialFileAttachment","Partially attached: {0}.",p):c=r?h("chat.fileAttachmentWithRange3","Attached: {0}, line {1} to line {2}.",p,r.startLineNumber,r.endLineNumber):h("chat.fileAttachment3","Attached: {0}.",p),s.setFile(l,{fileKind:w.FILE,hidePath:!0,range:r,title:v?.options?.status?.description})}else if(e.isImage){c=h("chat.imageAttachment","Attached image, {0}",e.name);const i=a.$("div.chat-attached-context-hover");i.setAttribute("aria-label",c);const d=a.$("div.chat-attached-context-pill",{},a.$("span.codicon.codicon-file-media")),p=a.$("span.chat-attached-context-custom-text",{},e.name);t.appendChild(d),t.appendChild(p);let x;try{e.value instanceof I?x=(await this.fileService.readFile(e.value)).value.buffer:x=e.value,await this.createImageElements(x,t,i)}catch{}t.style.position="relative",this.attachedContextDisposables.isDisposed||this.attachedContextDisposables.add(this.hoverService.setupManagedHover(n,t,i))}else{const i=e.fullName??e.name,d=e.icon?.id?`$(${e.icon.id}) ${i}`:i;s.setLabel(d,v?.options?.status?.description),c=h("chat.attachment3","Attached context: {0}.",e.name)}y&&t.classList.add("warning");const L=v?.options?.status?.description;if(y){c=`${c}${L?` ${L}`:""}`;for(const i of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const d=s.element.querySelector(i);d&&d.classList.add("warning")}}l&&(t.style.cursor="pointer",this.attachedContextDisposables.isDisposed||this.attachedContextDisposables.add(a.addDisposableListener(t,a.EventType.CLICK,async i=>{a.EventHelper.stop(i,!0),this.openerService.open(l,{fromUserGesture:!0,editorOptions:{selection:r}})}))),t.ariaLabel=c,t.tabIndex=0})}async createImageElements(o,n,e){const t=new Blob([o],{type:"image/png"}),s=URL.createObjectURL(t),l=a.$("img.chat-attached-context-image",{src:s,alt:""}),r=a.$("img.chat-attached-context-pill-image",{src:s,alt:""}),v=a.$("div.chat-attached-context-pill",{},r),u=n.querySelector(".chat-attached-context-pill");u&&u.replaceWith(v),e.appendChild(l)}};g=R([b(3,N),b(4,V),b(5,_),b(6,H)],g);export{g as ChatAttachmentsContentPart};
