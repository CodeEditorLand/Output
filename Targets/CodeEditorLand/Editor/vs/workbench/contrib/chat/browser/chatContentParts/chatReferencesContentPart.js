var G=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var x=(m,e,n,t)=>{for(var o=t>1?void 0:t?z(e,n):e,i=m.length-1,s;i>=0;i--)(s=m[i])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&G(e,n,o),o},d=(m,e)=>(n,t)=>e(n,t,m);import*as F from"../../../../../base/browser/dom.js";import{Button as Y}from"../../../../../base/browser/ui/button/button.js";import"../../../../../base/browser/ui/list/list.js";import"../../../../../base/common/actions.js";import{coalesce as K}from"../../../../../base/common/arrays.js";import{Codicon as I}from"../../../../../base/common/codicons.js";import{Emitter as J}from"../../../../../base/common/event.js";import{Disposable as W,DisposableStore as Q}from"../../../../../base/common/lifecycle.js";import{matchesSomeScheme as X,Schemas as M}from"../../../../../base/common/network.js";import{basename as D}from"../../../../../base/common/path.js";import{basenameOrAuthority as Z,isEqualAuthority as H}from"../../../../../base/common/resources.js";import{ThemeIcon as R}from"../../../../../base/common/themables.js";import{URI as S}from"../../../../../base/common/uri.js";import{localize as v,localize2 as ee}from"../../../../../nls.js";import{createAndFillInContextMenuActions as te}from"../../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as ie}from"../../../../../platform/actions/browser/toolbar.js";import{Action2 as ne,IMenuService as re,MenuId as P,registerAction2 as oe}from"../../../../../platform/actions/common/actions.js";import{IContextKeyService as V}from"../../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as se}from"../../../../../platform/contextview/browser/contextView.js";import{FileKind as ae}from"../../../../../platform/files/common/files.js";import{IInstantiationService as w}from"../../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as le}from"../../../../../platform/instantiation/common/serviceCollection.js";import{ILabelService as ce}from"../../../../../platform/label/common/label.js";import{WorkbenchList as de}from"../../../../../platform/list/browser/listService.js";import{IOpenerService as ue}from"../../../../../platform/opener/common/opener.js";import{IProductService as me}from"../../../../../platform/product/common/productService.js";import{IThemeService as B}from"../../../../../platform/theme/common/themeService.js";import{fillEditorsDragData as he}from"../../../../browser/dnd.js";import{ResourceLabels as pe}from"../../../../browser/labels.js";import{ColorScheme as fe}from"../../../../browser/web.api.js";import{ResourceContextKey as ge}from"../../../../common/contextkeys.js";import{SETTINGS_AUTHORITY as be}from"../../../../services/preferences/common/preferences.js";import{createFileIconThemableTreeContainerScope as Ie}from"../../../files/browser/views/explorerView.js";import{ExplorerFolderContext as ve}from"../../../files/common/files.js";import{chatEditingWidgetFileStateContextKey as Ce,WorkingSetEntryState as O}from"../../common/chatEditingService.js";import{ChatResponseReferencePartStatusKind as $}from"../../common/chatService.js";import{IChatVariablesService as j}from"../../common/chatVariables.js";import"../../common/chatViewModel.js";import{IChatWidgetService as Se}from"../chat.js";import{ResourcePool as ye}from"./chatCollections.js";import"./chatContentParts.js";const y=F.$;let T=class extends W{constructor(n,t,o,i,s,c,r,l){super();this.data=n;this.instantiationService=r;this.contextMenuService=l;const h=t??(n.length>1?v("usedReferencesPlural","Used {0} references",n.length):v("usedReferencesSingular","Used {0} reference",1)),g=y(".chat-used-context-icon"),A=a=>a.usedReferencesExpanded?I.chevronDown:I.chevronRight;g.classList.add(...R.asClassNameArray(A(o)));const k=y(".chat-used-context-label",void 0),C=this._register(new Y(k,{buttonBackground:void 0,buttonBorder:void 0,buttonForeground:void 0,buttonHoverBackground:void 0,buttonSecondaryBackground:void 0,buttonSecondaryForeground:void 0,buttonSecondaryHoverBackground:void 0,buttonSeparator:void 0}));this.domNode=y(".chat-used-context",void 0,k),C.label=h,C.element.prepend(g),this.updateAriaLabel(C.element,h,o.usedReferencesExpanded),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._register(C.onDidClick(()=>{g.classList.remove(...R.asClassNameArray(A(o))),o.usedReferencesExpanded=!o.usedReferencesExpanded,g.classList.add(...R.asClassNameArray(A(o))),this.domNode.classList.toggle("chat-used-context-collapsed",!o.usedReferencesExpanded),this._onDidChangeHeight.fire(),this.updateAriaLabel(C.element,h,o.usedReferencesExpanded)}));const p=this._register(i.get()).object;this.domNode.appendChild(p.getHTMLElement().parentElement),this._register(p.onDidOpen(a=>{if(a.element&&"reference"in a.element&&typeof a.element.reference=="object"){const u="variableName"in a.element.reference?a.element.reference.value:a.element.reference,b=S.isUri(u)?u:u?.uri;b&&s.open(b,{fromUserGesture:!0,editorOptions:{...a.editorOptions,selection:u&&"range"in u?u.range:void 0}})}})),this._register(p.onContextMenu(a=>{F.EventHelper.stop(a.browserEvent,!0);const u=a.element&&L(a.element);u&&this.contextMenuService.showContextMenu({getAnchor:()=>a.anchor,getActions:()=>{const b=c.getMenuActions(P.ChatAttachmentsContext,p.contextKeyService,{shouldForwardArgs:!0,arg:u}),U=[];return te(b,U),U}})}));const _=this._register(this.instantiationService.createInstance(ge));this._register(p.onDidChangeFocus(a=>{_.reset();const u=a.elements.length?a.elements[0]:void 0,b=u&&L(u);_.set(b??null)}));const N=Math.min(n.length,6)*22;p.layout(N),p.getHTMLElement().style.height=`${N}px`,p.splice(0,p.length,n)}domNode;_onDidChangeHeight=this._register(new J);onDidChangeHeight=this._onDidChangeHeight.event;hasSameContent(n,t,o){return n.kind==="references"&&n.references.length===this.data.length||n.kind==="codeCitations"&&n.citations.length===this.data.length}updateAriaLabel(n,t,o){n.ariaLabel=o?v("usedReferencesExpanded","{0}, expanded",t):v("usedReferencesCollapsed","{0}, collapsed",t)}addDisposable(n){this._register(n)}};T=x([d(4,ue),d(5,re),d(6,w),d(7,se)],T);let E=class extends W{constructor(n,t,o,i,s){super();this._onDidChangeVisibility=n;this.menuId=t;this.instantiationService=o;this.themeService=i;this.labelService=s;this._pool=this._register(new ye(()=>this.listFactory()))}_pool;get inUse(){return this._pool.inUse}listFactory(){const n=this._register(this.instantiationService.createInstance(pe,{onDidChangeVisibility:this._onDidChangeVisibility})),t=y(".chat-used-context-list");return this._register(Ie(t,this.themeService)),this.instantiationService.createInstance(de,"ChatListRenderer",t,new Le,[this.instantiationService.createInstance(f,n,this.menuId)],{alwaysConsumeMouseWheel:!1,accessibilityProvider:{getAriaLabel:i=>{if(i.kind==="warning")return i.content.value;const s=i.reference;return typeof s=="string"?s:"variableName"in s?s.variableName:S.isUri(s)?D(s.path):D(s.uri.path)},getWidgetAriaLabel:()=>v("chatCollapsibleList","Collapsible Chat List")},dnd:{getDragURI:i=>L(i)?.toString()??null,getDragLabel:(i,s)=>{const c=K(i.map(L));if(c.length)return c.length===1?this.labelService.getUriLabel(c[0],{relative:!0}):`${c.length}`},dispose:()=>{},onDragOver:()=>!1,drop:()=>{},onDragStart:(i,s)=>{try{const c=i.getData(),r=K(c.map(L));this.instantiationService.invokeFunction(l=>he(l,r,s))}catch{}}}})}get(){const n=this._pool.get();let t=!1;return{object:n,isStale:()=>t,dispose:()=>{t=!0,this._pool.release(n)}}}};E=x([d(2,w),d(3,B),d(4,ce)],E);class Le{getHeight(e){return 22}getTemplateId(e){return f.TEMPLATE_ID}}let f=class{constructor(e,n,t,o,i,s,c){this.labels=e;this.menuId=n;this.themeService=t;this.chatVariablesService=o;this.productService=i;this.instantiationService=s;this.contextKeyService=c}static TEMPLATE_ID="chatCollapsibleListRenderer";templateId=f.TEMPLATE_ID;renderTemplate(e){const n=new Q,t=n.add(this.labels.create(e,{supportHighlights:!0,supportIcons:!0}));let o,i,s;if(this.menuId){i=y(".chat-collapsible-list-action-bar"),s=n.add(this.contextKeyService.createScoped(i));const c=n.add(this.instantiationService.createChild(new le([V,s])));o=n.add(c.createInstance(ie,i,this.menuId,{menuOptions:{shouldForwardArgs:!0,arg:void 0}})),t.element.appendChild(i)}return{templateDisposables:n,label:t,toolbar:o,actionBarContainer:i,contextKeyService:s}}getReferenceIcon(e){return R.isThemeIcon(e.iconPath)?e.iconPath:this.themeService.getColorTheme().type===fe.DARK&&e.iconPath?.dark?e.iconPath?.dark:e.iconPath?.light}renderElement(e,n,t,o){if(e.kind==="warning"){t.label.setResource({name:e.content.value},{icon:I.warning});return}const i=e.reference,s=this.getReferenceIcon(e);t.label.element.style.display="flex";let c;if(typeof i=="object"&&"variableName"in i)if(i.value){const r=S.isUri(i.value)?i.value:i.value.uri;t.label.setResource({resource:r,name:Z(r),description:`#${i.variableName}`,range:"range"in i.value?i.value.range:void 0},{icon:s,title:e.options?.status?.description??e.title})}else if(i.variableName.startsWith("kernelVariable")){const l=`${i.variableName.split(":")[1]}`;t.label.setLabel("Kernel variable",l,{title:e.options?.status?.description})}else{const r=this.chatVariablesService.getVariable(i.variableName),l=r?.icon?`$(${r.icon.id}) `:"",h=`#${i.variableName}`,g=`${l}${r?.fullName??h}`;t.label.setLabel(g,h,{title:e.options?.status?.description??r?.description})}else if(typeof i=="string")t.label.setLabel(i,void 0,{iconPath:S.isUri(s)?s:void 0,title:e.options?.status?.description??e.title});else{const r="uri"in i?i.uri:i;if(c=r,r.scheme==="https"&&H(r.authority,"github.com")&&r.path.includes("/tree/")){const l=r.path.split("/").slice(1,3).join("/"),h=r.path.split("/").slice(5).join("/");t.label.setResource({resource:r,name:l,description:h},{icon:I.github,title:e.title})}else if(r.scheme===this.productService.urlProtocol&&H(r.authority,be)){const l=r.path.substring(1);t.label.setResource({resource:r,name:l},{icon:I.settingsGear,title:v("setting.hover","Open setting '{0}'",l)})}else X(r,M.mailto,M.http,M.https)?t.label.setResource({resource:r,name:r.toString()},{icon:s??I.globe,title:e.options?.status?.description??e.title??r.toString()}):t.label.setFile(r,{fileKind:ae.FILE,fileDecorations:void 0,range:"range"in i?i.range:void 0,title:e.options?.status?.description??e.title})}for(const r of[".monaco-icon-suffix-container",".monaco-icon-name-container"]){const l=t.label.element.querySelector(r);l&&(e.options?.status?.kind===$.Omitted||e.options?.status?.kind===$.Partial?l.classList.add("warning"):l.classList.remove("warning"))}e.state!==void 0&&(t.actionBarContainer&&(e.state===O.Modified&&!t.actionBarContainer.classList.contains("modified")?(t.actionBarContainer.classList.add("modified"),t.label.element.querySelector(".monaco-icon-name-container")?.classList.add("modified")):e.state!==O.Modified&&(t.actionBarContainer.classList.remove("modified"),t.label.element.querySelector(".monaco-icon-name-container")?.classList.remove("modified"))),t.toolbar&&(t.toolbar.context=c),t.contextKeyService&&e.state!==void 0&&Ce.bindTo(t.contextKeyService).set(e.state))}disposeTemplate(e){e.templateDisposables.dispose()}};f=x([d(2,B),d(3,j),d(4,me),d(5,w),d(6,V)],f);function L(m){if(m.kind==="warning")return null;const{reference:e}=m;return typeof e=="string"||"variableName"in e?null:S.isUri(e)?e:e.uri}oe(class q extends ne{static id="workbench.action.chat.addToChatAction";constructor(){super({id:q.id,title:{...ee("addToChat","Add File to Chat")},f1:!1,menu:[{id:P.ChatAttachmentsContext,group:"chat",order:1,when:ve.negate()}]})}async run(e,n){const t=e.get(Se),o=e.get(j);if(!n)return;const i=t.lastFocusedWidget;i&&o.attachContext("file",n,i.location)}});export{T as ChatCollapsibleListContentPart,E as CollapsibleListPool};
