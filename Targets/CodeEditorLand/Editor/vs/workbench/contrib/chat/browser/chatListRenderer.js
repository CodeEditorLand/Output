var de=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var k=(P,p,e,r)=>{for(var t=r>1?void 0:r?ce(p,e):p,n=P.length-1,o;n>=0;n--)(o=P[n])&&(t=(r?o(p,e,t):o(t))||t);return r&&t&&de(p,e,t),t},f=(P,p)=>(e,r)=>p(e,r,P);import*as d from"../../../../base/browser/dom.js";import{renderFormattedText as he}from"../../../../base/browser/formattedTextRenderer.js";import{StandardKeyboardEvent as le}from"../../../../base/browser/keyboardEvent.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{DropdownMenuActionViewItem as Ce}from"../../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{getDefaultHoverDelegate as ue}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import"../../../../base/browser/ui/list/list.js";import"../../../../base/browser/ui/tree/tree.js";import"../../../../base/common/actions.js";import{coalesce as Ie,distinct as pe}from"../../../../base/common/arrays.js";import{Codicon as _}from"../../../../base/common/codicons.js";import{Emitter as E}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{MarkdownString as H}from"../../../../base/common/htmlContent.js";import{KeyCode as O}from"../../../../base/common/keyCodes.js";import{Disposable as fe,DisposableStore as U,dispose as K,toDisposable as x}from"../../../../base/common/lifecycle.js";import{ResourceMap as me}from"../../../../base/common/map.js";import{FileAccess as ge}from"../../../../base/common/network.js";import{clamp as ve}from"../../../../base/common/numbers.js";import{autorun as Re}from"../../../../base/common/observable.js";import{ThemeIcon as q}from"../../../../base/common/themables.js";import{URI as Te}from"../../../../base/common/uri.js";import"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as v}from"../../../../nls.js";import{createActionViewItem as ye}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{MenuWorkbenchToolBar as z}from"../../../../platform/actions/browser/toolbar.js";import{MenuId as X,MenuItemAction as we}from"../../../../platform/actions/common/actions.js";import{ICommandService as G}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as Pe}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as J}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Se}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as be}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as ke}from"../../../../platform/instantiation/common/instantiation.js";import{ServiceCollection as Ee}from"../../../../platform/instantiation/common/serviceCollection.js";import{ILogService as V}from"../../../../platform/log/common/log.js";import{ColorScheme as Le}from"../../../../platform/theme/common/theme.js";import{IThemeService as De}from"../../../../platform/theme/common/themeService.js";import{IWorkbenchIssueService as Me}from"../../issue/common/issue.js";import{annotateSpecialMarkdownContent as Q}from"../common/annotations.js";import"../common/chatAgents.js";import{CONTEXT_CHAT_RESPONSE_SUPPORT_ISSUE_REPORTING as Ae,CONTEXT_ITEM_ID as _e,CONTEXT_REQUEST as He,CONTEXT_RESPONSE as Oe,CONTEXT_RESPONSE_DETECTED_AGENT_COMMAND as xe,CONTEXT_RESPONSE_ERROR as Ve,CONTEXT_RESPONSE_FILTERED as Ne,CONTEXT_RESPONSE_VOTE as Y}from"../common/chatContextKeys.js";import"../common/chatModel.js";import{chatSubcommandLeader as Be}from"../common/chatParserTypes.js";import{ChatAgentVoteDirection as j,ChatAgentVoteDownReason as I}from"../common/chatService.js";import{isRequestVM as T,isResponseVM as h}from"../common/chatViewModel.js";import{getNWords as Fe}from"../common/chatWordCounter.js";import"../common/codeBlockModelCollection.js";import{MarkUnhelpfulActionId as L}from"./actions/chatTitleActions.js";import{GeneratingPhrase as We}from"./chat.js";import{ChatAgentHover as $e,getChatAgentHoverOptions as Ue}from"./chatAgentHover.js";import{ChatAttachmentsContentPart as Ke}from"./chatContentParts/chatAttachmentsContentPart.js";import{ChatCodeCitationContentPart as qe}from"./chatContentParts/chatCodeCitationContentPart.js";import{ChatCommandButtonContentPart as ze}from"./chatContentParts/chatCommandContentPart.js";import{ChatConfirmationContentPart as Xe}from"./chatContentParts/chatConfirmationContentPart.js";import"./chatContentParts/chatContentParts.js";import{ChatMarkdownContentPart as Z,EditorPool as Ge}from"./chatContentParts/chatMarkdownContentPart.js";import{ChatProgressContentPart as Je}from"./chatContentParts/chatProgressContentPart.js";import{ChatCollapsibleListContentPart as Qe,CollapsibleListPool as Ye}from"./chatContentParts/chatReferencesContentPart.js";import{ChatTaskContentPart as je}from"./chatContentParts/chatTaskContentPart.js";import{ChatTextEditContentPart as Ze,DiffEditorPool as et}from"./chatContentParts/chatTextEditContentPart.js";import{ChatToolInvocationPart as tt}from"./chatContentParts/chatToolInvocationPart.js";import{ChatTreeContentPart as ee,TreePool as rt}from"./chatContentParts/chatTreeContentPart.js";import{ChatWarningContentPart as te}from"./chatContentParts/chatWarningContentPart.js";import{ChatMarkdownDecorationsRenderer as nt}from"./chatMarkdownDecorationsRenderer.js";import{ChatMarkdownRenderer as ot}from"./chatMarkdownRenderer.js";import"./chatOptions.js";import{ChatCodeBlockContentProvider as it}from"./codeBlockPart.js";const m=d.$,re=!1;let w=class extends fe{constructor(e,r,t,n,o,a,s,c,i,l,C,u){super();this.rendererOptions=r;this.delegate=t;this.codeBlockModelCollection=n;this.instantiationService=a;this.logService=c;this.contextKeyService=i;this.themeService=l;this.commandService=C;this.hoverService=u;this.renderer=this._register(this.instantiationService.createInstance(ot,void 0)),this.markdownDecorationsRenderer=this.instantiationService.createInstance(nt),this._editorPool=this._register(this.instantiationService.createInstance(Ge,e,t,o)),this._diffEditorPool=this._register(this.instantiationService.createInstance(et,e,t,o)),this._treePool=this._register(this.instantiationService.createInstance(rt,this._onDidChangeVisibility.event)),this._contentReferencesListPool=this._register(this.instantiationService.createInstance(Ye,this._onDidChangeVisibility.event,void 0)),this._register(this.instantiationService.createInstance(it))}static ID="item";codeBlocksByResponseId=new Map;codeBlocksByEditorUri=new me;fileTreesByResponseId=new Map;focusedFileTreesByResponseId=new Map;renderer;markdownDecorationsRenderer;_onDidClickFollowup=this._register(new E);onDidClickFollowup=this._onDidClickFollowup.event;_onDidClickRerunWithAgentOrCommandDetection=new E;onDidClickRerunWithAgentOrCommandDetection=this._onDidClickRerunWithAgentOrCommandDetection.event;_onDidChangeItemHeight=this._register(new E);onDidChangeItemHeight=this._onDidChangeItemHeight.event;_editorPool;_diffEditorPool;_treePool;_contentReferencesListPool;_currentLayoutWidth=0;_isVisible=!0;_onDidChangeVisibility=this._register(new E);get templateId(){return w.ID}editorsInUse(){return this._editorPool.inUse()}traceLayout(e,r){re?this.logService.info(`ChatListItemRenderer#${e}: ${r}`):this.logService.trace(`ChatListItemRenderer#${e}: ${r}`)}getProgressiveRenderRate(e){if(e.isComplete)return 80;if(e.contentUpdateTimings&&e.contentUpdateTimings.impliedWordLoadRate){const n=e.contentUpdateTimings.impliedWordLoadRate;return ve(n,5,80)}return 8}getCodeBlockInfosForResponse(e){return this.codeBlocksByResponseId.get(e.id)??[]}getCodeBlockInfoForEditor(e){return this.codeBlocksByEditorUri.get(e)}getFileTreeInfosForResponse(e){return this.fileTreesByResponseId.get(e.id)??[]}getLastFocusedFileTreeForResponse(e){const r=this.fileTreesByResponseId.get(e.id),t=this.focusedFileTreesByResponseId.get(e.id);if(r?.length&&t!==void 0&&t<r.length)return r[t]}setVisible(e){this._isVisible=e,this._onDidChangeVisibility.fire(e)}layout(e){this._currentLayoutWidth=e-(this.rendererOptions.noPadding?0:40);for(const r of this._editorPool.inUse())r.layout(this._currentLayoutWidth);for(const r of this._diffEditorPool.inUse())r.layout(this._currentLayoutWidth)}renderTemplate(e){const r=new U,t=d.append(e,m(".interactive-item-container"));this.rendererOptions.renderStyle==="compact"&&t.classList.add("interactive-item-compact"),this.rendererOptions.noPadding&&t.classList.add("no-padding");let n=t,o=t,a,s;if(this.rendererOptions.renderStyle==="minimal"){t.classList.add("interactive-item-compact"),t.classList.add("minimal");const g=d.append(t,m(".column.left")),R=d.append(t,m(".column.right"));n=g,a=R,o=R,s=d.append(t,m(".header"))}const c=d.append(n,m(".header")),i=d.append(c,m(".user"));i.tabIndex=0,i.role="toolbar";const l=d.append(i,m(".avatar-container")),C=d.append(i,m("h3.username")),u=d.append(a??i,m("span.detail-container")),M=d.append(u,m("span.detail"));d.append(u,m("span.chat-animated-ellipsis"));const oe=d.append(o,m(".value")),ie=new U,N=r.add(this.contextKeyService.createScoped(t)),S=r.add(this.instantiationService.createChild(new Ee([J,N])));let B;this.rendererOptions.noHeader?c.classList.add("hidden"):B=r.add(S.createInstance(z,s??c,X.ChatMessageTitle,{menuOptions:{shouldForwardArgs:!0},toolbarOptions:{shouldInlineSubmenu:g=>g.actions.length<=1}}));const se=d.append(t,m(".chat-footer-toolbar")),ae=r.add(S.createInstance(z,se,X.ChatMessageFooter,{eventDebounceDelay:0,menuOptions:{shouldForwardArgs:!0},toolbarOptions:{shouldInlineSubmenu:g=>g.actions.length<=1},actionViewItemProvider:(g,R)=>g instanceof we&&g.item.id===L?S.createInstance(b,g,R):ye(S,g,R)})),A=r.add(this.instantiationService.createInstance($e)),F=()=>{if(h(y.currentElement)&&y.currentElement.agent&&!y.currentElement.agent.isDefault)return A.setAgent(y.currentElement.agent.id),A.domNode},W=Ue(()=>h(y.currentElement)?y.currentElement.agent:void 0,this.commandService);r.add(this.hoverService.setupManagedHover(ue("element"),i,F,W)),r.add(d.addDisposableListener(i,d.EventType.KEY_DOWN,g=>{const R=new le(g);if(R.equals(O.Space)||R.equals(O.Enter)){const $=F();$&&this.hoverService.showHover({content:$,target:i,trapFocus:!0,actions:W.actions},!0)}else R.equals(O.Escape)&&this.hoverService.hideHover()}));const y={avatarContainer:l,username:C,detail:M,value:oe,rowContainer:t,elementDisposables:ie,templateDisposables:r,contextKeyService:N,instantiationService:S,agentHover:A,titleToolbar:B,footerToolbar:ae};return y}renderElement(e,r,t){this.renderChatTreeItem(e.element,r,t)}clearRenderedParts(e){e.renderedParts&&(K(Ie(e.renderedParts)),e.renderedParts=void 0,d.clearNode(e.value))}renderChatTreeItem(e,r,t){t.currentElement&&t.currentElement.id!==e.id&&(this.traceLayout("renderChatTreeItem",`Rendering a different element into the template, index=${r}`),this.clearRenderedParts(t)),t.currentElement=e;const n=T(e)?"request":h(e)?"response":"welcome";this.traceLayout("renderElement",`${n}, index=${r}`),Oe.bindTo(t.contextKeyService).set(h(e)),_e.bindTo(t.contextKeyService).set(e.id),He.bindTo(t.contextKeyService).set(T(e)),xe.bindTo(t.contextKeyService).set(h(e)&&e.agentOrSlashCommandDetected),h(e)?(Ae.bindTo(t.contextKeyService).set(!!e.agent?.metadata.supportIssueReporting),Y.bindTo(t.contextKeyService).set(e.vote===j.Up?"up":e.vote===j.Down?"down":"")):Y.bindTo(t.contextKeyService).set(""),t.titleToolbar&&(t.titleToolbar.context=e),t.footerToolbar.context=e,Ve.bindTo(t.contextKeyService).set(h(e)&&!!e.errorDetails);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered);if(Ne.bindTo(t.contextKeyService).set(o),t.rowContainer.classList.toggle("interactive-request",T(e)),t.rowContainer.classList.toggle("interactive-response",h(e)),t.rowContainer.classList.toggle("show-detail-progress",h(e)&&!e.isComplete&&!e.progressMessages.length),t.username.textContent=e.username,this.rendererOptions.noHeader||this.renderAvatar(e,t),d.clearNode(t.detail),h(e)&&this.renderDetail(e,t),T(e)&&e.confirmation&&this.renderConfirmationAction(e,t),h(e)&&r===this.delegate.getListLength()-1&&(!e.isComplete||e.renderData)&&e.response.value.length){this.traceLayout("renderElement",`start progressive render, index=${r}`);const a=t.elementDisposables.add(new d.WindowIntervalTimer),s=c=>{try{this.doNextProgressiveRender(e,r,t,!!c)&&a.cancel()}catch(i){a.cancel(),this.logService.error(i)}};a.cancelAndSet(s,50,d.getWindow(t.rowContainer)),s(!0)}else h(e)?this.basicRenderElement(e,r,t):T(e)&&this.basicRenderElement(e,r,t)}renderDetail(e,r){r.elementDisposables.add(Re(t=>{this._renderDetail(e,r)}))}_renderDetail(e,r){if(d.clearNode(r.detail),e.agentOrSlashCommandDetected){const t=e.slashCommand?v("usedAgentSlashCommand","used {0} [[(rerun without)]]",`${Be}${e.slashCommand.name}`):v("usedAgent","[[(rerun without)]]");d.reset(r.detail,he(t,{className:"agentOrSlashCommandDetected",inline:!0,actionHandler:{disposables:r.elementDisposables,callback:n=>{this._onDidClickRerunWithAgentOrCommandDetection.fire(e)}}}))}else e.isComplete||(r.detail.textContent=We)}renderConfirmationAction(e,r){d.clearNode(r.detail),e.confirmation&&(r.detail.textContent=v("chatConfirmationAction",'selected "{0}"',e.confirmation))}renderAvatar(e,r){const t=h(e)?this.getAgentIcon(e.agent?.metadata):e.avatarIcon??_.account;if(t instanceof Te){const n=d.$("img.icon");n.src=ge.uriToBrowserUri(t).toString(!0),r.avatarContainer.replaceChildren(d.$(".avatar",void 0,n))}else{const n=d.$(q.asCSSSelector(t));r.avatarContainer.replaceChildren(d.$(".avatar.codicon-avatar",void 0,n))}}getAgentIcon(e){return e?.themeIcon?e.themeIcon:e?.iconDark&&this.themeService.getColorTheme().type===Le.DARK?e.iconDark:e?.icon?e.icon:_.copilot}basicRenderElement(e,r,t){t.rowContainer.classList.toggle("chat-response-loading",h(e)&&!e.isComplete);let n=[];if(T(e)&&!e.confirmation){const i="message"in e.message?e.message.message:this.markdownDecorationsRenderer.convertParsedRequestToMarkdown(e.message);n=[{content:new H(i),kind:"markdownContent"}]}else h(e)&&(e.contentReferences.length&&n.push({kind:"references",references:e.contentReferences}),n.push(...Q(e.response.value)),e.codeCitations.length&&n.push({kind:"codeCitations",citations:e.codeCitations}));d.clearNode(t.value),h(e)&&this.renderDetail(e,t);const o=!!(h(e)&&e.errorDetails?.responseIsFiltered),a=[];if(o||n.forEach((i,l)=>{const C={element:e,contentIndex:l,content:n,preceedingContentParts:a},u=this.renderChatContentPart(i,t,C);u&&(t.value.appendChild(u.domNode),a.push(u))}),t.renderedParts&&K(t.renderedParts),t.renderedParts=a,!o&&T(e)&&e.variables.length){const i=this.renderAttachments(e.variables,e.contentReferences,t);i&&(t.value.appendChild(i.domNode),t.elementDisposables.add(i))}if(h(e)&&e.errorDetails?.message){const i=this.instantiationService.createInstance(te,e.errorDetails.responseIsFiltered?"info":"error",new H(e.errorDetails.message),this.renderer);t.elementDisposables.add(i),t.value.appendChild(i.domNode)}const s=t.rowContainer.offsetHeight,c=!e.currentRenderedHeight||e.currentRenderedHeight!==s;if(e.currentRenderedHeight=s,c){const i=t.elementDisposables.add(d.scheduleAtNextAnimationFrame(d.getWindow(t.value),()=>{e.currentRenderedHeight=t.rowContainer.offsetHeight,i.dispose(),this._onDidChangeItemHeight.fire({element:e,height:e.currentRenderedHeight})}))}}updateItemHeight(e){if(!e.currentElement)return;const r=e.rowContainer.offsetHeight;e.currentElement.currentRenderedHeight=r,this._onDidChangeItemHeight.fire({element:e.currentElement,height:r})}doNextProgressiveRender(e,r,t,n){if(!this._isVisible)return!0;if(e.isCanceled)return this.traceLayout("doNextProgressiveRender",`canceled, index=${r}`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0;t.rowContainer.classList.toggle("chat-response-loading",!0),this.traceLayout("doNextProgressiveRender",`START progressive render, index=${r}, renderData=${JSON.stringify(e.renderData)}`);const o=this.getNextProgressiveRenderContent(e),a=this.diff(t.renderedParts??[],o.content,e);if(a.every(i=>i===null))return o.moreContentAvailable?(this.traceLayout("doNextProgressiveRender","not rendering any new content this tick, but more available"),!1):e.isComplete?(this.traceLayout("doNextProgressiveRender",`END progressive render, index=${r} and clearing renderData, response is complete`),e.renderData=void 0,this.basicRenderElement(e,r,t),!0):(this.traceLayout("doNextProgressiveRender","caught up with the stream- no new content to render"),!0);this.traceLayout("doNextProgressiveRender",`doing progressive render, ${a.length} parts to render`),this.renderChatContentDiff(a,o.content,e,t);const c=t.rowContainer.offsetHeight;return e.currentRenderedHeight=c,n||this._onDidChangeItemHeight.fire({element:e,height:t.rowContainer.offsetHeight}),!1}renderChatContentDiff(e,r,t,n){const o=n.renderedParts??[];n.renderedParts=o,e.forEach((a,s)=>{if(!a)return;const c=n.renderedParts?.[s];c&&c.dispose();const i=o.slice(0,s),l={element:t,content:r,preceedingContentParts:i,contentIndex:s},C=this.renderChatContentPart(a,n,l);if(C){if(c)try{c.domNode.replaceWith(C.domNode)}catch(u){this.logService.error("ChatListItemRenderer#renderChatContentDiff: error replacing part",u)}else n.value.appendChild(C.domNode);o[s]=C}else c&&c.domNode.remove()})}getNextProgressiveRenderContent(e){const r=this.getDataForProgressiveRender(e),t=Q(e.response.value);this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} at ${r.rate} words/s, counting...`);let n=r.numWordsToRender;const o=[];e.contentReferences.length&&o.push({kind:"references",references:e.contentReferences});for(let i=0;i<t.length;i++){const l=t[i];if(l.kind==="markdownContent"){const C=Fe(l.content.value,n);if(this.traceLayout("getNextProgressiveRenderContent",`  Chunk ${i}: Want to render ${n} words and found ${C.returnedWordCount} words. Total words in chunk: ${C.totalWordCount}`),n-=C.returnedWordCount,C.isFullString){o.push(l);for(const u of t.slice(i+1))if(u.kind!=="markdownContent")i++,o.push(u);else break}else o.push({kind:"markdownContent",content:new H(C.value,l.content)});if(n<=0)break}else o.push(l)}const a=e.contentUpdateTimings?.lastWordCount??0,s=r.numWordsToRender-n,c=a-s;return this.traceLayout("getNextProgressiveRenderContent",`Want to render ${r.numWordsToRender} words. Rendering ${s} words. Buffer: ${c} words`),s>0&&s!==e.renderData?.renderedWordCount&&(e.renderData={lastRenderTime:Date.now(),renderedWordCount:s,renderedParts:o}),{content:o,moreContentAvailable:c>0}}getDataForProgressiveRender(e){const r=e.renderData??{lastRenderTime:0,renderedWordCount:0},t=this.getProgressiveRenderRate(e);return{numWordsToRender:r.lastRenderTime===0?1:r.renderedWordCount+Math.floor((Date.now()-r.lastRenderTime)/1e3*t),rate:t}}diff(e,r,t){const n=[];for(let o=0;o<r.length;o++){const a=r[o],s=e[o];!s||!s.hasSameContent(a,r.slice(o+1),t)?n.push(a):n.push(null)}return n}renderChatContentPart(e,r,t){if(e.kind==="treeData")return this.renderTreeData(e,r,t);if(e.kind==="progressMessage")return this.instantiationService.createInstance(Je,e,this.renderer,t);if(e.kind==="progressTask")return this.renderProgressTask(e,r,t);if(e.kind==="command")return this.instantiationService.createInstance(ze,e,t);if(e.kind==="textEditGroup")return this.renderTextEdit(t,e,r);if(e.kind==="confirmation")return this.renderConfirmation(t,e,r);if(e.kind==="warning")return this.instantiationService.createInstance(te,"warning",e.content,this.renderer);if(e.kind==="markdownContent")return this.renderMarkdown(e.content,r,t);if(e.kind==="references")return this.renderContentReferencesListData(e,void 0,t,r);if(e.kind==="codeCitations")return this.renderCodeCitationsListData(e,t,r);if(e.kind==="toolInvocation"||e.kind==="toolInvocationSerialized")return this.renderToolInvocation(e,t,r)}renderTreeData(e,r,t){const n=e.treeData,o=t.preceedingContentParts.filter(s=>s instanceof ee).length,a=this.instantiationService.createInstance(ee,n,t.element,this._treePool,o);if(a.addDisposable(a.onDidChangeHeight(()=>{this.updateItemHeight(r)})),h(t.element)){const s={treeDataId:n.uri.toString(),treeIndex:o,focus(){a.domFocus()}};a.addDisposable(a.onDidFocus(()=>{this.focusedFileTreesByResponseId.set(t.element.id,s.treeIndex)}));const c=this.fileTreesByResponseId.get(t.element.id)??[];c.push(s),this.fileTreesByResponseId.set(t.element.id,pe(c,i=>i.treeDataId)),a.addDisposable(x(()=>this.fileTreesByResponseId.set(t.element.id,c.filter(i=>i.treeDataId!==n.uri.toString()))))}return a}renderContentReferencesListData(e,r,t,n){const o=this.instantiationService.createInstance(Qe,e.references,r,t.element,this._contentReferencesListPool);return o.addDisposable(o.onDidChangeHeight(()=>{this.updateItemHeight(n)})),o}renderCodeCitationsListData(e,r,t){return this.instantiationService.createInstance(qe,e,r)}renderToolInvocation(e,r,t){const n=this.instantiationService.createInstance(tt,e,r,this.renderer);return n.addDisposable(n.onDidChangeHeight(()=>{this.updateItemHeight(t)})),n}renderProgressTask(e,r,t){if(!h(t.element))return;const n=this.instantiationService.createInstance(je,e,this._contentReferencesListPool,this.renderer,t);return n.addDisposable(n.onDidChangeHeight(()=>{this.updateItemHeight(r)})),n}renderConfirmation(e,r,t){const n=this.instantiationService.createInstance(Xe,r,e);return n.addDisposable(n.onDidChangeHeight(()=>this.updateItemHeight(t))),n}renderAttachments(e,r,t){return this.instantiationService.createInstance(Ke,e,r,void 0)}renderTextEdit(e,r,t){const n=this.instantiationService.createInstance(Ze,r,e,this.rendererOptions,this._diffEditorPool,this._currentLayoutWidth);return n.addDisposable(n.onDidChangeHeight(()=>{n.layout(this._currentLayoutWidth),this.updateItemHeight(t)})),n}renderMarkdown(e,r,t){const n=t.element,o=h(n)&&(!n.isComplete||n.isCanceled||n.errorDetails?.responseIsFiltered||n.errorDetails?.responseIsIncomplete||!!n.renderData),a=t.preceedingContentParts.reduce((l,C)=>l+(C instanceof Z?C.codeblocks.length:0),0),s=this.instantiationService.createInstance(Z,e,t,this._editorPool,o,a,this.renderer,this._currentLayoutWidth,this.codeBlockModelCollection,this.rendererOptions),c=s.id;s.addDisposable(s.onDidChangeHeight(()=>{s.layout(this._currentLayoutWidth),this.updateItemHeight(r)}));const i=this.codeBlocksByResponseId.get(n.id)??[];return this.codeBlocksByResponseId.set(n.id,i),s.addDisposable(x(()=>{const l=this.codeBlocksByResponseId.get(n.id);l&&s.codeblocks.forEach((C,u)=>{l[a+u]?.ownerMarkdownPartId===c&&delete l[a+u]})})),s.codeblocks.forEach((l,C)=>{if(i[a+C]=l,l.uri){const u=l.uri;this.codeBlocksByEditorUri.set(u,l),s.addDisposable(x(()=>{this.codeBlocksByEditorUri.get(u)?.ownerMarkdownPartId===c&&this.codeBlocksByEditorUri.delete(u)}))}}),s}disposeElement(e,r,t){this.traceLayout("disposeElement",`Disposing element, index=${r}`),t.elementDisposables.clear()}disposeTemplate(e){e.templateDisposables.dispose()}};w=k([f(5,ke),f(6,Pe),f(7,V),f(8,J),f(9,De),f(10,G),f(11,be)],w);let D=class{constructor(p,e){this.defaultElementHeight=p;this.logService=e}_traceLayout(p,e){re?this.logService.info(`ChatListDelegate#${p}: ${e}`):this.logService.trace(`ChatListDelegate#${p}: ${e}`)}getHeight(p){const e=T(p)?"request":"response",r=("currentRenderedHeight"in p?p.currentRenderedHeight:void 0)??this.defaultElementHeight;return this._traceLayout("getHeight",`${e}, height=${r}`),r}getTemplateId(p){return w.ID}hasDynamicHeight(p){return!0}};D=k([f(1,V)],D);const ne={[I.IncorrectCode]:v("incorrectCode","Suggested incorrect code"),[I.DidNotFollowInstructions]:v("didNotFollowInstructions","Didn't follow instructions"),[I.MissingContext]:v("missingContext","Missing context"),[I.OffensiveOrUnsafe]:v("offensiveOrUnsafe","Offensive or unsafe"),[I.PoorlyWrittenOrFormatted]:v("poorlyWrittenOrFormatted","Poorly written or formatted"),[I.RefusedAValidRequest]:v("refusedAValidRequest","Refused a valid request"),[I.IncompleteCode]:v("incompleteCode","Incomplete code"),[I.WillReportIssue]:v("reportIssue","Report an issue"),[I.Other]:v("other","Other")};let b=class extends Ce{constructor(e,r,t,n,o,a){super(e,{getActions:()=>this.getActions()},a,{...r,classNames:q.asClassNameArray(_.thumbsdown)});this.commandService=t;this.issueService=n;this.logService=o}getActions(){return[this.getVoteDownDetailAction(I.IncorrectCode),this.getVoteDownDetailAction(I.DidNotFollowInstructions),this.getVoteDownDetailAction(I.IncompleteCode),this.getVoteDownDetailAction(I.MissingContext),this.getVoteDownDetailAction(I.PoorlyWrittenOrFormatted),this.getVoteDownDetailAction(I.RefusedAValidRequest),this.getVoteDownDetailAction(I.OffensiveOrUnsafe),this.getVoteDownDetailAction(I.Other),{id:"reportIssue",label:ne[I.WillReportIssue],tooltip:"",enabled:!0,class:void 0,run:async e=>{if(!h(e)){this.logService.error("ChatVoteDownButton#run: invalid context");return}await this.commandService.executeCommand(L,e,I.WillReportIssue),await this.issueService.openReporter({extensionId:e.agent?.extensionId.value})}}]}render(e){super.render(e),this.element?.classList.toggle("checked",this.action.checked)}getVoteDownDetailAction(e){const r=ne[e];return{id:L,label:r,tooltip:"",enabled:!0,checked:this._context.voteDownReason===e,class:void 0,run:async t=>{if(!h(t)){this.logService.error("ChatVoteDownButton#getVoteDownDetailAction: invalid context");return}await this.commandService.executeCommand(L,t,e)}}}};b=k([f(2,G),f(3,Me),f(4,V),f(5,Se)],b);export{D as ChatListDelegate,w as ChatListItemRenderer,b as ChatVoteDownButton};
