var J=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var D=(I,i,c,a)=>{for(var e=a>1?void 0:a?X(i,c):i,d=I.length-1,h;d>=0;d--)(h=I[d])&&(e=(a?h(i,c,e):h(e))||e);return a&&e&&J(i,c,e),e},g=(I,i)=>(c,a)=>i(c,a,I);import"../../../../../base/common/cancellation.js";import{isPatternInWord as Y}from"../../../../../base/common/filters.js";import{Disposable as F}from"../../../../../base/common/lifecycle.js";import{ResourceSet as Z}from"../../../../../base/common/map.js";import"../../../../../base/common/uri.js";import{generateUuid as ee}from"../../../../../base/common/uuid.js";import"../../../../../editor/common/core/position.js";import{Range as x}from"../../../../../editor/common/core/range.js";import{getWordAtText as te}from"../../../../../editor/common/core/wordHelper.js";import{CompletionItemKind as T}from"../../../../../editor/common/languages.js";import"../../../../../editor/common/model.js";import{ILanguageFeaturesService as _}from"../../../../../editor/common/services/languageFeatures.js";import{localize as re}from"../../../../../nls.js";import{Action2 as ie,registerAction2 as ne}from"../../../../../platform/actions/common/actions.js";import{CommandsRegistry as ae}from"../../../../../platform/commands/common/commands.js";import{IConfigurationService as oe}from"../../../../../platform/configuration/common/configuration.js";import{IInstantiationService as se}from"../../../../../platform/instantiation/common/instantiation.js";import{ILabelService as ce}from"../../../../../platform/label/common/label.js";import{Registry as V}from"../../../../../platform/registry/common/platform.js";import{IWorkspaceContextService as le}from"../../../../../platform/workspace/common/workspace.js";import{Extensions as U}from"../../../../common/contributions.js";import{IHistoryService as de}from"../../../../services/history/common/history.js";import{LifecyclePhase as q}from"../../../../services/lifecycle/common/lifecycle.js";import{QueryBuilder as me}from"../../../../services/search/common/queryBuilder.js";import{ISearchService as ue}from"../../../../services/search/common/search.js";import{ChatAgentLocation as H,IChatAgentNameService as ge,IChatAgentService as he,getFullyQualifiedId as pe}from"../../common/chatAgents.js";import{ChatRequestAgentPart as z,ChatRequestAgentSubcommandPart as fe,ChatRequestTextPart as ve,ChatRequestToolPart as Ce,ChatRequestVariablePart as Ie,chatAgentLeader as B,chatSubcommandLeader as j,chatVariableLeader as y}from"../../common/chatParserTypes.js";import{IChatSlashCommandService as be}from"../../common/chatSlashCommands.js";import{IChatVariablesService as Se}from"../../common/chatVariables.js";import{ILanguageModelToolsService as ye}from"../../common/languageModelToolsService.js";import{SubmitAction as O}from"../actions/chatExecuteActions.js";import{IChatWidgetService as K}from"../chat.js";import{ChatInputPart as N}from"../chatInputPart.js";import{ChatDynamicVariableModel as xe,SelectAndInsertFileAction as G}from"./chatDynamicVariables.js";let L=class extends F{constructor(c,a,e){super();this.languageFeaturesService=c;this.chatWidgetService=a;this.chatSlashCommandService=e;this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommands",triggerCharacters:["/"],provideCompletionItems:async(d,h,m,v)=>{const u=this.chatWidgetService.getWidgetByInputUri(d.uri);if(!u||!u.viewModel||!W(d,h,/\/\w*/g))return null;if(u.parsedInput.parts.find(n=>n instanceof z))return;const p=this.chatSlashCommandService.getCommands(u.location);return p?{suggestions:p.map((n,b)=>{const S=`/${n.command}`;return{label:S,insertText:n.executeImmediately?"":`${S} `,detail:n.detail,range:new x(1,1,1,1),sortText:n.sortText??"a".repeat(b+1),kind:T.Text,command:n.executeImmediately?{id:O.ID,title:S,arguments:[{widget:u,inputValue:`${S} `}]}:void 0}})}:null}})),this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"globalSlashCommandsAt",triggerCharacters:["@"],provideCompletionItems:async(d,h,m,v)=>{const u=this.chatWidgetService.getWidgetByInputUri(d.uri);if(!u||!u.viewModel||!W(d,h,/@\w*/g))return null;const o=this.chatSlashCommandService.getCommands(u.location);return o?{suggestions:o.map((t,p)=>{const n=`${j}${t.command}`;return{label:n,insertText:t.executeImmediately?"":`${n} `,detail:t.detail,range:new x(1,1,1,1),filterText:`${B}${t.command}`,sortText:t.sortText??"z".repeat(p+1),kind:T.Text,command:t.executeImmediately?{id:O.ID,title:n,arguments:[{widget:u,inputValue:`${n} `}]}:void 0}})}:null}}))}};L=D([g(0,_),g(1,K),g(2,be)],L),V.as(U.Workbench).registerWorkbenchContribution(L,q.Eventually);let M=class extends F{constructor(c,a,e,d){super();this.languageFeaturesService=c;this.chatWidgetService=a;this.chatAgentService=e;this.chatAgentNameService=d;const h={_debugDisplayName:"chatAgentSubcommand",triggerCharacters:["/"],provideCompletionItems:async(m,v,u,l)=>{const o=this.chatWidgetService.getWidgetByInputUri(m.uri);if(!o||!o.viewModel)return;const t=W(m,v,/\/\w*/g);if(!t)return null;const p=o.parsedInput.parts,n=p.findIndex(C=>C instanceof z);if(n<0||p.find(C=>C instanceof fe))return;for(const C of p.slice(n+1))if(!(C instanceof ve)||!C.text.trim().match(/^(\/\w*)?$/))return;return{suggestions:p[n].agent.slashCommands.map((C,s)=>{const f=`/${C.name}`;return{label:f,insertText:`${f} `,detail:C.description,range:t,kind:T.Text}})}}};this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},h)),this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatAgentAndSubcommand",triggerCharacters:["@","/"],provideCompletionItems:async(m,v,u,l)=>{const o=this.chatWidgetService.getWidgetByInputUri(m.uri),t=o?.viewModel;if(!o||!t)return;if(!W(m,v,/(@|\/)\w*/g))return null;const n=v.column>1?m.getValueInRange(new x(v.lineNumber,v.column-1,v.lineNumber,v.column)):"@",b=this.chatAgentService.getAgents().filter(s=>s.locations.includes(o.location)),S=(s,f)=>{const $=s.id==="github.copilot.terminalPanel"?"0000":"";return`${n}${$}${s.name}.${f}`};return{suggestions:b.filter(s=>!s.isDefault).map(s=>{const{label:f,isDupe:$}=this.getAgentCompletionDetails(s),P=s.description;return{label:$?{label:f,description:s.description,detail:` (${s.publisherDisplayName})`}:f,detail:P,filterText:`${n}${s.name}`,insertText:`${f} `,range:new x(1,1,1,1),kind:T.Text,sortText:`${B}${s.name}`,command:{id:k.ID,title:k.ID,arguments:[{agent:s,widget:o}]}}}).concat(b.flatMap(s=>s.slashCommands.map((f,$)=>{const{label:P,isDupe:r}=this.getAgentCompletionDetails(s),A=`${P} ${j}${f.name}`,E={label:r?{label:A,description:f.description,detail:r?` (${s.publisherDisplayName})`:void 0}:A,detail:f.description,filterText:S(s,f.name),commitCharacters:[" "],insertText:A+" ",range:new x(1,1,1,1),kind:T.Text,sortText:`x${B}${s.name}${f.name}`,command:{id:k.ID,title:k.ID,arguments:[{agent:s,widget:o}]}};if(s.isDefault){const Q=`${j}${f.name}`;E.label=Q,E.insertText=`${Q} `,E.detail=f.description}return E})))}}}))}getAgentCompletionDetails(c){const a=this.chatAgentNameService.getAgentNameRestriction(c),e=`${B}${a?c.name:pe(c)}`,d=a&&this.chatAgentService.agentHasDupeName(c.id);return{label:e,isDupe:d}}};M=D([g(0,_),g(1,K),g(2,he),g(3,ge)],M),V.as(U.Workbench).registerWorkbenchContribution(M,q.Eventually);class k extends ie{static ID="workbench.action.chat.assignSelectedAgent";constructor(){super({id:k.ID,title:""})}async run(i,...c){const a=c[0];!a||!a.widget||!a.agent||(a.widget.lastSelectedAgent=a.agent)}}ne(k);class Ae{constructor(i,c){this.widget=i;this.variable=c}}let w=class extends F{constructor(c,a,e,d,h,m,v){super();this.historyService=c;this.workspaceContextService=a;this.searchService=e;this.labelService=d;this.languageFeaturesService=h;this.chatWidgetService=m;this.instantiationService=v;this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatDynamicCompletions",triggerCharacters:[y],provideCompletionItems:async(u,l,o,t)=>{const p=this.chatWidgetService.getWidgetByInputUri(u.uri);if(!p||!p.supportsFileReferences)return null;const n={suggestions:[]},b=W(u,l,w.VariableNameDef,!0);if(b){const C=new x(l.lineNumber,b.replace.startColumn,l.lineNumber,b.replace.startColumn+6);n.suggestions.push({label:`${y}file`,insertText:`${y}file:`,detail:re("pickFileLabel","Pick a file"),range:b,kind:T.Text,command:{id:G.ID,title:G.ID,arguments:[{widget:p,range:C}]},sortText:"z"})}const S=W(u,l,new RegExp(`${y}[^\\s]*`,"g"),!0);return S&&await this.addFileEntries(p,n,S,t),n}})),this._register(ae.registerCommand(w.addReferenceCommand,(u,l)=>this.cmdAddReference(l))),this.queryBuilder=this.instantiationService.createInstance(me)}static addReferenceCommand="_addReferenceCmd";static VariableNameDef=new RegExp(`${y}\\w*`,"g");queryBuilder;cacheKey;async addFileEntries(c,a,e,d){const h=l=>{const o=this.labelService.getUriBasenameLabel(l),t=`${y}file:${o}`;return{label:{label:o,description:this.labelService.getUriLabel(l,{relative:!0})},filterText:`${y}${o}`,insertText:e.varWord?.endColumn===e.replace.endColumn?`${t} `:t,range:e,kind:T.File,sortText:"{",command:{id:w.addReferenceCommand,title:"",arguments:[new Ae(c,{id:"vscode.file",range:{startLineNumber:e.replace.startLineNumber,startColumn:e.replace.startColumn,endLineNumber:e.replace.endLineNumber,endColumn:e.replace.startColumn+t.length},data:l})]}}};let m;e.varWord?.word&&e.varWord.word.startsWith(y)&&(m=e.varWord.word.toLowerCase().slice(1));const v=new Z,u=a.suggestions.length;for(const l of this.historyService.getHistory()){if(!l.resource||!this.workspaceContextService.getWorkspaceFolder(l.resource))continue;if(m){const t=this.labelService.getUriBasenameLabel(l.resource).toLowerCase();if(!Y(m,0,m.length,t,0,t.length))continue}if(v.add(l.resource),a.suggestions.push(h(l.resource))-u>=5)break}if(m){this.cacheKey&&Date.now()-this.cacheKey.time>6e4&&(this.searchService.clearCache(this.cacheKey.key),this.cacheKey=void 0),this.cacheKey||(this.cacheKey={key:ee(),time:Date.now()}),this.cacheKey.time=Date.now();const l=this.queryBuilder.file(this.workspaceContextService.getWorkspace().folders,{filePattern:m,sortByScore:!0,maxResults:250,cacheKey:this.cacheKey.key}),o=await this.searchService.fileSearch(l,d);for(const t of o.results)v.has(t.resource)||a.suggestions.push(h(t.resource))}a.incomplete=!0}cmdAddReference(c){c.widget.getContrib(xe.ID)?.addReference(c.variable)}};w=D([g(0,de),g(1,le),g(2,ue),g(3,ce),g(4,_),g(5,K),g(6,se)],w),V.as(U.Workbench).registerWorkbenchContribution(w,q.Eventually);function W(I,i,c,a=!1){const e=te(i.column,c,I.getLineContent(i.lineNumber),0);if(!e&&I.getWordUntilPosition(i).word||!e&&i.column>1&&I.getValueInRange(new x(i.lineNumber,i.column-1,i.lineNumber,i.column))!==" "||e&&a&&I.getWordUntilPosition({lineNumber:i.lineNumber,column:e.startColumn}).word)return;let d,h;return e?(d=new x(i.lineNumber,e.startColumn,i.lineNumber,i.column),h=new x(i.lineNumber,e.startColumn,i.lineNumber,e.endColumn)):d=h=x.fromPositions(i),{insert:d,replace:h,varWord:e}}let R=class extends F{constructor(c,a,e,d,h){super();this.languageFeaturesService=c;this.chatWidgetService=a;this.chatVariablesService=e;this._register(this.languageFeaturesService.completionProvider.register({scheme:N.INPUT_SCHEME,hasAccessToAllModels:!0},{_debugDisplayName:"chatVariables",triggerCharacters:[y],provideCompletionItems:async(m,v,u,l)=>{const o=new Set;o.add(H.Panel),o.add(H.EditingSession);for(const r of Object.values(H))typeof r=="string"&&d.getValue(`chat.experimental.variables.${r}`)&&o.add(r);const t=this.chatWidgetService.getWidgetByInputUri(m.uri);if(!t||!o.has(t.location))return null;const p=W(m,v,R.VariableNameDef,!0);if(!p)return null;const n=t.parsedInput.parts.find(r=>r instanceof z),b=n?n.agent.metadata.supportsSlowVariables:!0,S=t.parsedInput.parts.filter(r=>r instanceof Ie),C=new Set(S.map(r=>r.variableName)),s=Array.from(this.chatVariablesService.getVariables(t.location)).filter(r=>!C.has(r.name)).filter(r=>!r.isSlow||b).map(r=>{const A=`${y}${r.name}`;return{label:A,range:p,insertText:A+" ",detail:r.description,kind:T.Text,sortText:"z"}}),f=t.parsedInput.parts.filter(r=>r instanceof Ce),$=new Set(f.map(r=>r.toolName)),P=[];return(!n||n.agent.supportsToolReferences)&&P.push(...Array.from(h.getTools()).filter(r=>r.canBeInvokedManually).filter(r=>!$.has(r.name??"")).map(r=>{const A=`${y}${r.name}`;return{label:A,range:p,insertText:A+" ",detail:r.userDescription,kind:T.Text,sortText:"z"}})),{suggestions:[...s,...P]}}}))}static VariableNameDef=new RegExp(`(?<=^|\\s)${y}\\w*`,"g")};R=D([g(0,_),g(1,K),g(2,Se),g(3,oe),g(4,ye)],R),V.as(U.Workbench).registerWorkbenchContribution(R,q.Eventually);export{W as computeCompletionRanges};
