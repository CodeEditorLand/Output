var Oe=Object.defineProperty;var Ve=Object.getOwnPropertyDescriptor;var x=(p,i,e,t)=>{for(var r=t>1?void 0:t?Ve(i,e):i,o=p.length-1,s;o>=0;o--)(s=p[o])&&(r=(t?s(i,e,r):s(r))||r);return t&&r&&Oe(i,e,r),r},l=(p,i)=>(e,t)=>i(e,t,p);import*as m from"../../../../base/browser/dom.js";import"../../../../base/browser/keyboardEvent.js";import"../../../../base/browser/ui/actionbar/actionViewItems.js";import{ActionBar as ie}from"../../../../base/browser/ui/actionbar/actionbar.js";import{Button as He}from"../../../../base/browser/ui/button/button.js";import{getDefaultHoverDelegate as re}from"../../../../base/browser/ui/hover/hoverDelegateFactory.js";import{renderLabelWithIcons as We}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"../../../../base/browser/ui/list/list.js";import{DefaultKeyboardNavigationDelegate as Ne}from"../../../../base/browser/ui/list/listWidget.js";import{TreeVisibility as _}from"../../../../base/browser/ui/tree/tree.js";import{Action as B,ActionRunner as ze,Separator as Se}from"../../../../base/common/actions.js";import{mapFindFirst as ke}from"../../../../base/common/arraysFind.js";import{RunOnceScheduler as U,disposableTimeout as Ke}from"../../../../base/common/async.js";import{Color as je,RGBA as $e}from"../../../../base/common/color.js";import{Emitter as Ue,Event as Ge}from"../../../../base/common/event.js";import"../../../../base/common/filters.js";import{KeyCode as qe}from"../../../../base/common/keyCodes.js";import{Disposable as G,DisposableStore as se,MutableDisposable as A}from"../../../../base/common/lifecycle.js";import{autorun as Qe,observableFromEvent as ne}from"../../../../base/common/observable.js";import{fuzzyContains as Ye}from"../../../../base/common/strings.js";import{ThemeIcon as q}from"../../../../base/common/themables.js";import{isDefined as O}from"../../../../base/common/types.js";import"../../../../base/common/uri.js";import{MarkdownRenderer as Je}from"../../../../editor/browser/widget/markdownRenderer/browser/markdownRenderer.js";import{localize as S}from"../../../../nls.js";import{DropdownWithPrimaryActionViewItem as Xe}from"../../../../platform/actions/browser/dropdownWithPrimaryActionViewItem.js";import{MenuEntryActionViewItem as Ze,createActionViewItem as et,createAndFillInActionBarActions as tt,createAndFillInContextMenuActions as it}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService as oe,MenuId as ye,MenuItemAction as Q}from"../../../../platform/actions/common/actions.js";import{ICommandService as be}from"../../../../platform/commands/common/commands.js";import{IConfigurationService as le}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService as ae}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService as Ee}from"../../../../platform/contextview/browser/contextView.js";import{IHoverService as Y}from"../../../../platform/hover/browser/hover.js";import{IInstantiationService as V}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService as rt}from"../../../../platform/keybinding/common/keybinding.js";import{IOpenerService as st}from"../../../../platform/opener/common/opener.js";import{UnmanagedProgress as nt}from"../../../../platform/progress/common/progress.js";import{IStorageService as ot,StorageScope as H,StorageTarget as ce,WillSaveStateReason as lt}from"../../../../platform/storage/common/storage.js";import{ITelemetryService as at}from"../../../../platform/telemetry/common/telemetry.js";import{defaultButtonStyles as ct}from"../../../../platform/theme/browser/defaultStyles.js";import{foreground as ut}from"../../../../platform/theme/common/colorRegistry.js";import{spinningLoading as dt}from"../../../../platform/theme/common/iconRegistry.js";import{IThemeService as pt,registerThemingParticipant as mt}from"../../../../platform/theme/common/themeService.js";import{IUriIdentityService as ht}from"../../../../platform/uriIdentity/common/uriIdentity.js";import{registerNavigableContainer as ft}from"../../../browser/actions/widgetNavigationCommands.js";import{ViewPane as gt}from"../../../browser/parts/views/viewPane.js";import"../../../browser/parts/views/viewsViewlet.js";import{DiffEditorInput as vt}from"../../../common/editor/diffEditorInput.js";import{IViewDescriptorService as It}from"../../../common/views.js";import{IActivityService as Tt,IconBadge as we,NumberBadge as Ce}from"../../../services/activity/common/activity.js";import{IEditorGroupsService as St}from"../../../services/editor/common/editorGroupsService.js";import{IEditorService as yt}from"../../../services/editor/common/editorService.js";import{TestingConfigKeys as E,TestingCountBadge as ue,getTestingConfiguration as J}from"../common/configuration.js";import{TestCommandId as L,TestExplorerViewMode as de,TestExplorerViewSorting as X,Testing as xe,labelForTestInState as bt}from"../common/constants.js";import{StoredValue as Et}from"../common/storedValue.js";import{ITestExplorerFilterState as pe,TestFilterTerm as b}from"../common/testExplorerFilterState.js";import{TestId as me}from"../common/testId.js";import{ITestProfileService as he,canUseProfileWithTest as fe}from"../common/testProfileService.js";import{LiveTestResult as wt,TestResultItemChangeReason as Ct}from"../common/testResult.js";import{ITestResultService as De}from"../common/testResultService.js";import{ITestService as Z,testCollectionIsEmpty as xt}from"../common/testService.js";import{TestControllerCapability as Dt,TestItemExpandState as ge,TestResultState as W,TestRunProfileBitset as M}from"../common/testTypes.js";import{TestingContextKeys as D}from"../common/testingContextKeys.js";import{ITestingContinuousRunService as ve}from"../common/testingContinuousRunService.js";import{ITestingPeekOpener as Ft}from"../common/testingPeekOpener.js";import{cmpPriority as Rt,isFailedState as Fe,isStateWithResult as Pt,statesInOrder as At}from"../common/testingStates.js";import{TestItemTreeElement as T,TestTreeErrorMessage as w}from"./explorerProjections/index.js";import{ListProjection as Mt}from"./explorerProjections/listProjection.js";import{getTestItemContextOverlay as Bt}from"./explorerProjections/testItemContextOverlay.js";import{TestingObjectTree as Lt}from"./explorerProjections/testingObjectTree.js";import"./explorerProjections/testingViewState.js";import{TreeProjection as _t}from"./explorerProjections/treeProjection.js";import*as C from"./icons.js";import"./media/testing.css";import{DebugLastRun as Ot,ReRunLastRun as Vt}from"./testExplorerActions.js";import{TestingExplorerFilter as Ht}from"./testingExplorerFilter.js";import{collectTestStateCounts as Re,getTestProgressText as Wt}from"./testingProgressUiService.js";var Nt=(e=>(e[e.Input=0]="Input",e[e.Tree=1]="Tree",e))(Nt||{});let ee=class extends gt{constructor(e,t,r,o,s,c,d,f,u,a,h,g,I,v,te){super(e,r,t,o,d,c,s,f,u,h,g);this.testService=a;this.testProfileService=I;this.commandService=v;this.menuService=te;const $=this._register(new U(()=>this.layoutBody(),1));this._register(this.onDidChangeViewWelcomeState(()=>{this.shouldShowWelcome()||$.schedule()})),this._register(a.collection.onBusyProvidersChange(P=>{this.updateDiscoveryProgress(P)})),this._register(I.onDidChange(()=>this.updateActions()))}viewModel;filterActionBar=this._register(new A);container;treeHeader;discoveryProgress=this._register(new A);filter=this._register(new A);filterFocusListener=this._register(new A);dimensions={width:0,height:0};lastFocusState=0;get focusedTreeElements(){return this.viewModel.tree.getFocus().filter(O)}shouldShowWelcome(){return this.viewModel?.welcomeExperience===1}focus(){super.focus(),this.lastFocusState===1?this.viewModel.tree.domFocus():this.filter.value?.focus()}getTreeIncludeExclude(e,t,r="visible"){const o=this.viewModel.projection.value;if(!o)return{include:[],exclude:[]};const s=new Set,c=[],d=new Map,f=a=>{let h=d.get(a);return h===void 0&&(h=typeof e=="number"?!!this.testProfileService.getDefaultProfileForTest(e,a):fe(e,a),d.set(a,h)),h},u=(a,h)=>{if(!(a instanceof T)||!this.viewModel.tree.hasElement(a))return;const g=this.viewModel.tree.getNode(a);if(!g.visible){h&&c.push(a.test);return}const I=g.children.filter(v=>v.visible&&v.element instanceof T&&f(v.element.test)).length;!h&&f(a.test)&&(I===0||I*2>=g.children.length)&&I!==1&&(s.add(a.test),h=!0);for(const v of a.children)u(v,h)};if(r==="selected"){const a=this.viewModel.tree.getSelection().filter(O);if(a.length){e:for(const h of a)if(h instanceof T){for(let g=h;g;g=g.parent)if(s.has(g.test))continue e;s.add(h.test),h.children.forEach(g=>u(g,!0))}return{include:[...s],exclude:c}}}for(const a of t||this.testService.collection.rootItems){const h=o.getElementByTestId(a.item.extId);if(h&&!(typeof e=="object"&&!fe(e,a)))if(this.viewModel.tree.hasElement(h))u(h,!1);else{const g=[...h.children].reduce((I,v)=>this.viewModel.tree.hasElement(v)&&this.viewModel.tree.getNode(v).visible?I+1:I,0);h.children.size>0&&g*2>=h.children.size?(s.add(h.test),h.children.forEach(I=>u(I,!0))):h.children.forEach(I=>u(I,!1))}}return{include:[...s],exclude:c}}render(){super.render(),this._register(ft({name:"testingExplorerView",focusNotifiers:[this],focusNextWidget:()=>{this.viewModel.tree.isDOMFocused()||this.viewModel.tree.domFocus()},focusPreviousWidget:()=>{this.viewModel.tree.isDOMFocused()&&this.filter.value?.focus()}}))}renderBody(e){super.renderBody(e),this.container=m.append(e,m.$(".test-explorer")),this.treeHeader=m.append(this.container,m.$(".test-explorer-header")),this.filterActionBar.value=this.createFilterActionBar();const t=m.append(this.treeHeader,m.$(".result-summary-container"));this._register(this.instantiationService.createInstance(N,t));const r=m.append(this.container,m.$(".test-explorer-tree"));this.viewModel=this.instantiationService.createInstance(z,r,this.onDidChangeBodyVisibility),this._register(this.viewModel.tree.onDidFocus(()=>this.lastFocusState=1)),this._register(this.viewModel.onChangeWelcomeVisibility(()=>this._onDidChangeViewWelcomeState.fire())),this._register(this.viewModel),this._onDidChangeViewWelcomeState.fire()}getActionViewItem(e,t){switch(e.id){case L.FilterAction:return this.filter.value=this.instantiationService.createInstance(Ht,e,t),this.filterFocusListener.value=this.filter.value.onDidFocus(()=>this.lastFocusState=0),this.filter.value;case L.RunSelectedAction:return this.getRunGroupDropdown(M.Run,e,t);case L.DebugSelectedAction:return this.getRunGroupDropdown(M.Debug,e,t);default:return super.getActionViewItem(e,t)}}getTestConfigGroupActions(e){const t=[];let r=0,o=!1;const s=this.testProfileService.getGroupDefaultProfiles(e);for(const{profiles:h,controller:g}of this.testProfileService.all()){let I=!1;for(const v of h)v.group===e&&(I||(I=!0,r++,t.push(new B(`${g.id}.$root`,g.label.get(),void 0,!1))),o=o||v.hasConfigurationHandler,t.push(new B(`${g.id}.${v.profileId}`,s.includes(v)?S("defaultTestProfile","{0} (Default)",v.label):v.label,void 0,void 0,()=>{const{include:te,exclude:$}=this.getTreeIncludeExclude(v);this.testService.runResolvedTests({exclude:$.map(P=>P.item.extId),group:v.group,targets:[{profileId:v.profileId,controllerId:v.controllerId,testIds:te.map(P=>P.item.extId)}]})})))}const c=[],d=[];e===M.Run&&d.push(["testing.profile.context.group","run"]),e===M.Debug&&d.push(["testing.profile.context.group","debug"]),e===M.Coverage&&d.push(["testing.profile.context.group","coverage"]);const f=this.contextKeyService.createOverlay(d),u=this.menuService.getMenuActions(ye.TestProfilesContext,f);it(u,c);const a=[];return t.length>1&&a.push(new B("selectDefaultTestConfigurations",S("selectDefaultConfigs","Select Default Profile"),void 0,void 0,()=>this.commandService.executeCommand(L.SelectDefaultTestProfiles,e))),o&&a.push(new B("configureTestProfiles",S("configureTestProfiles","Configure Test Profiles"),void 0,void 0,()=>this.commandService.executeCommand(L.ConfigureTestProfilesAction,e))),c.length>0?Se.join(t,c,a):Se.join(t,a)}saveState(){this.filter.value?.saveState(),super.saveState()}getRunGroupDropdown(e,t,r){const o=this.getTestConfigGroupActions(e);if(o.length<2)return super.getActionViewItem(t,r);const s=this.instantiationService.createInstance(Q,{id:t.id,title:t.label,icon:e===M.Run?C.testingRunAllIcon:C.testingDebugAllIcon},void 0,void 0,void 0,void 0),c=new B("selectRunConfig","Select Configuration...","codicon-chevron-down",!0);return this.instantiationService.createInstance(Xe,s,c,o,"",r)}createFilterActionBar(){const e=new ie(this.treeHeader,{actionViewItemProvider:(t,r)=>this.getActionViewItem(t,r),triggerKeys:{keyDown:!1,keys:[]}});return e.push(new B(L.FilterAction)),e.getContainer().classList.add("testing-filter-action-bar"),e}updateDiscoveryProgress(e){!e&&this.discoveryProgress?this.discoveryProgress.clear():e&&!this.discoveryProgress.value&&(this.discoveryProgress.value=this.instantiationService.createInstance(nt,{location:this.getProgressLocation()}))}layoutBody(e=this.dimensions.height,t=this.dimensions.width){super.layoutBody(e,t),this.dimensions.height=e,this.dimensions.width=t,this.container.style.height=`${e}px`,this.viewModel?.layout(e-this.treeHeader.clientHeight,t),this.filter.value?.layout(t)}};ee=x([l(1,Ee),l(2,rt),l(3,le),l(4,V),l(5,It),l(6,ae),l(7,st),l(8,pt),l(9,Z),l(10,at),l(11,Y),l(12,he),l(13,be),l(14,oe)],ee);const zt=200;let N=class extends G{constructor(e,t,r,o,s,c,d){super();this.container=e;this.resultService=t;this.activityService=r;this.crService=o;this.badgeType=s.getValue(E.CountBadge),this._register(t.onResultsChanged(this.render,this)),this._register(s.onDidChangeConfiguration(u=>{u.affectsConfiguration(E.CountBadge)&&(this.badgeType=s.getValue(E.CountBadge),this.render())})),this.countHover=this._register(d.setupManagedHover(re("mouse"),this.elements.count,"")),this._register(new ie(this.elements.rerun,{actionViewItemProvider:(u,a)=>et(c,u,a)})).push(c.createInstance(Q,{...new Vt().desc,icon:C.testingRerunIcon},{...new Ot().desc,icon:C.testingDebugIcon},{},void 0,void 0),{icon:!0,label:!1}),this.render()}elementsWereAttached=!1;badgeType;lastBadge;countHover;badgeDisposable=this._register(new A);renderLoop=this._register(new U(()=>this.render(),zt));elements=m.h("div.result-summary",[m.h("div@status"),m.h("div@count"),m.h("div@count"),m.h("span"),m.h("duration@duration"),m.h("a@rerun")]);render(){const{results:e}=this.resultService,{count:t,root:r,status:o,duration:s,rerun:c}=this.elements;if(!e.length){this.elementsWereAttached&&(r.remove(),this.elementsWereAttached=!1),this.container.innerText=S("noResults","No test results yet."),this.badgeDisposable.clear();return}const d=e.filter(u=>!u.completedAt);let f;if(d.length){o.className=q.asClassName(dt),f=Re(!0,d),this.renderLoop.schedule();const u=d[d.length-1];s.textContent=j(Date.now()-u.startedAt),c.style.display="none"}else{const u=e[0],a=ke(At,h=>u.counts[h]>0?h:void 0);o.className=q.asClassName(C.testingStatesToIcons.get(a??W.Unset)),f=Re(!1,[u]),s.textContent=u instanceof wt?j(u.completedAt-u.startedAt):"",c.style.display="block"}t.textContent=`${f.passed}/${f.totalWillBeRun}`,this.countHover.update(Wt(f)),this.renderActivityBadge(f),this.elementsWereAttached||(m.clearNode(this.container),this.container.appendChild(r),this.elementsWereAttached=!0)}renderActivityBadge(e){if(e&&this.badgeType!==ue.Off&&e[this.badgeType]!==0){if(this.lastBadge instanceof Ce&&this.lastBadge.number===e[this.badgeType])return;this.lastBadge=new Ce(e[this.badgeType],t=>this.getLocalizedBadgeString(this.badgeType,t))}else if(this.crService.isEnabled()){if(this.lastBadge instanceof we&&this.lastBadge.icon===C.testingContinuousIsOn)return;this.lastBadge=new we(C.testingContinuousIsOn,()=>S("testingContinuousBadge","Tests are being watched for changes"))}else{if(!this.lastBadge)return;this.lastBadge=void 0}this.badgeDisposable.value=this.lastBadge&&this.activityService.showViewActivity(xe.ExplorerViewId,{badge:this.lastBadge})}getLocalizedBadgeString(e,t){switch(e){case ue.Passed:return S("testingCountBadgePassed","{0} passed tests",t);case ue.Skipped:return S("testingCountBadgeSkipped","{0} skipped tests",t);default:return S("testingCountBadgeFailed","{0} failed tests",t)}}};N=x([l(1,De),l(2,Tt),l(3,ve),l(4,le),l(5,V),l(6,Y)],N);var kt=(t=>(t[t.None=0]="None",t[t.ForWorkspace=1]="ForWorkspace",t[t.ForDocument=2]="ForDocument",t))(kt||{});let z=class extends G{constructor(e,t,r,o,s,c,d,f,u,a,h,g,I,v,te,$,P){super();this.menuService=c;this.contextMenuService=d;this.testService=f;this.filterState=u;this.instantiationService=a;this.storageService=h;this.contextKeyService=g;this.testResults=I;this.peekOpener=v;this.testProfileService=te;this.crService=$;this.hasPendingReveal=!!u.reveal.value,this.noTestForDocumentWidget=this._register(a.createInstance(K,e)),this._viewMode.set(this.storageService.get("testing.viewMode",H.WORKSPACE,de.Tree)),this._viewSorting.set(this.storageService.get("testing.viewSorting",H.WORKSPACE,X.ByLocation)),this.reevaluateWelcomeState(),this.filter=this.instantiationService.createInstance(k,f.collection),this.tree=a.createInstance(Lt,"Test Explorer List",e,new Qt,[a.createInstance(R,this.actionRunner),a.createInstance(F)],{identityProvider:a.createInstance(Yt),hideTwistiesOfChildlessElements:!1,sorter:a.createInstance($t,this),keyboardNavigationLabelProvider:a.createInstance(qt),accessibilityProvider:a.createInstance(Gt),filter:this.filter,findWidgetEnabled:!1,openOnSingleClick:!1});const Me=this._register(new U(()=>{const n=this.tree.getOptimizedViewState(this.lastViewState.get({})),y=this.projection.value;y&&(y.lastState=n)},3e3));this._register(this.tree.onDidChangeCollapseState(n=>{n.node.element instanceof T&&(n.node.collapsed||this.projection.value?.expandElement(n.node.element,n.deep?1/0:0),Me.schedule())})),this._register(this.crService.onDidChange(n=>{if(n){const y=this.projection.value?.getElementByTestId(n);this.tree.resort(y?.parent&&this.tree.hasElement(y.parent)?y.parent:null,!1)}})),this._register(t(n=>{n&&this.ensureProjection()})),this._register(this.tree.onContextMenu(n=>this.onContextMenu(n))),this._register(Ge.any(u.text.onDidChange,u.fuzzy.onDidChange,f.excluded.onTestExclusionsChanged)(this.tree.refilter,this.tree)),this._register(this.tree.onDidOpen(n=>{n.element instanceof T&&!n.element.children.size&&n.element.test.item.uri&&P.executeCommand("vscode.revealTest",n.element.test.item.extId)})),this._register(this.tree),this._register(this.onChangeWelcomeVisibility(n=>{this.noTestForDocumentWidget.setVisible(n===2)})),this._register(m.addStandardDisposableListener(this.tree.getHTMLElement(),"keydown",n=>{n.equals(qe.Enter)?this.handleExecuteKeypress(n):Ne.mightProducePrintableCharacter(n)&&(u.text.value=n.browserEvent.key,u.focusInput())})),this._register(u.reveal.onDidChange(n=>this.revealById(n,void 0,!1))),this._register(t(n=>{n&&u.focusInput()})),this._register(this.tree.onDidChangeSelection(n=>{if(m.isMouseEvent(n.browserEvent)&&(n.browserEvent.altKey||n.browserEvent.shiftKey))return;const y=n.elements[0];y&&n.browserEvent&&y instanceof T&&y.children.size===0&&y.test.expand===ge.NotExpandable&&this.tryPeekError(y)}));let Ie=J(r,E.FollowRunningTest);this._register(r.onDidChangeConfiguration(n=>{n.affectsConfiguration(E.FollowRunningTest)&&(Ie=J(r,E.FollowRunningTest))}));let Te=J(r,E.AlwaysRevealTestOnStateChange);this._register(r.onDidChangeConfiguration(n=>{n.affectsConfiguration(E.AlwaysRevealTestOnStateChange)&&(Te=J(r,E.AlwaysRevealTestOnStateChange))})),this._register(I.onTestChanged(n=>{Ie&&n.reason===Ct.OwnStateChange&&(this.tree.selectionSize>1||n.item.ownComputedState!==W.Running&&!(n.previousState===W.Queued&&Pt(n.item.ownComputedState))||this.revealById(n.item.item.extId,Te,!1))})),this._register(I.onResultsChanged(()=>{this.tree.resort(null)})),this._register(this.testProfileService.onDidChange(()=>{this.tree.rerender()}));const Be=ne(this,o.onDidEditorsChange,()=>new Set(s.groups.flatMap(n=>n.editors).map(n=>n.resource).filter(O))),Le=ne(this,o.onDidActiveEditorChange,()=>o.activeEditor instanceof vt?o.activeEditor.primary.resource:o.activeEditor?.resource),_e=ne(this.filterState.text.onDidChange,()=>this.filterState.text);this._register(Qe(n=>{_e.read(n),this.filterState.isFilteringFor(b.OpenedFiles)?this.filter.filterToDocumentUri([...Be.read(n)]):this.filter.filterToDocumentUri([Le.read(n)].filter(O)),(this.filterState.isFilteringFor(b.CurrentDoc)||this.filterState.isFilteringFor(b.OpenedFiles))&&this.tree.refilter()})),this._register(this.storageService.onWillSaveState(({reason:n})=>{n===lt.SHUTDOWN&&this.lastViewState.store(this.tree.getOptimizedViewState())}))}tree;filter;projection=this._register(new A);revealTimeout=new A;_viewMode=D.viewMode.bindTo(this.contextKeyService);_viewSorting=D.viewSorting.bindTo(this.contextKeyService);welcomeVisibilityEmitter=new Ue;actionRunner=new Ut(()=>this.tree.getSelection().filter(O));lastViewState=this._register(new Et({key:"testing.treeState",scope:H.WORKSPACE,target:ce.MACHINE},this.storageService));noTestForDocumentWidget;hasPendingReveal=!1;onChangeWelcomeVisibility=this.welcomeVisibilityEmitter.event;welcomeExperience=0;get viewMode(){return this._viewMode.get()??de.Tree}set viewMode(e){e!==this._viewMode.get()&&(this._viewMode.set(e),this.updatePreferredProjection(),this.storageService.store("testing.viewMode",e,H.WORKSPACE,ce.MACHINE))}get viewSorting(){return this._viewSorting.get()??X.ByStatus}set viewSorting(e){e!==this._viewSorting.get()&&(this._viewSorting.set(e),this.tree.resort(null),this.storageService.store("testing.viewSorting",e,H.WORKSPACE,ce.MACHINE))}layout(e,t){this.tree.layout(e,t)}revealById(e,t=!0,r=!0){if(!e){this.hasPendingReveal=!1;return}const o=this.ensureProjection();let s=0;const c=[...me.fromString(e).idsFromRoot()];for(let d=c.length-1;d>=s;d--){const f=o.getElementByTestId(c[d].toString());if(!f||!this.tree.hasElement(f))continue;if(d<c.length-1&&t){this.tree.expand(f),s=d+1,d=c.length-1;continue}let u=f;for(let a=f;a instanceof T;a=a.parent){if(a.test&&this.testService.excluded.contains(a.test)){this.filterState.toggleFilteringFor(b.Hidden,!0);break}!t&&this.tree.hasElement(a)&&this.tree.isCollapsed(a)&&(u=a)}this.filterState.reveal.value=void 0,this.hasPendingReveal=!1,r&&this.tree.domFocus(),this.tree.getRelativeTop(u)===null&&this.tree.reveal(u,.5),this.revealTimeout.value=Ke(()=>{this.tree.setFocus([u]),this.tree.setSelection([u])},1);return}this.hasPendingReveal=!0}async collapseAll(){this.tree.collapseAll()}tryPeekError(e){const t=e.test&&this.testResults.getStateById(e.test.item.extId);return t&&t[1].tasks.some(r=>Fe(r.state))?this.peekOpener.tryPeekFirstError(t[0],t[1],{preserveFocus:!0}):!1}onContextMenu(e){const t=e.element;if(!(t instanceof T))return;const{actions:r}=Ae(this.contextKeyService,this.menuService,this.testService,this.crService,this.testProfileService,t);this.contextMenuService.showContextMenu({getAnchor:()=>e.anchor,getActions:()=>r.secondary,getActionsContext:()=>t,actionRunner:this.actionRunner})}handleExecuteKeypress(e){const t=this.tree.getFocus(),r=this.tree.getSelection();let o;t.length===1&&r.includes(t[0])?(e.browserEvent?.preventDefault(),o=r):o=t;const s=o.filter(c=>c instanceof T);s.length&&this.testService.runTests({group:M.Run,tests:s.map(c=>c.test)})}reevaluateWelcomeState(){const t=this.testService.collection.busyProviders===0&&xt(this.testService.collection)?this.filterState.isFilteringFor(b.CurrentDoc)?2:1:0;t!==this.welcomeExperience&&(this.welcomeExperience=t,this.welcomeVisibilityEmitter.fire(t))}ensureProjection(){return this.projection.value??this.updatePreferredProjection()}updatePreferredProjection(){this.projection.clear();const e=this.lastViewState.get({});this._viewMode.get()===de.List?this.projection.value=this.instantiationService.createInstance(Mt,e):this.projection.value=this.instantiationService.createInstance(_t,e);const t=this._register(new U(()=>this.applyProjectionChanges(),200));return this.projection.value.onUpdate(()=>{t.isScheduled()||t.schedule()}),this.applyProjectionChanges(),this.projection.value}applyProjectionChanges(){this.reevaluateWelcomeState(),this.projection.value?.applyTo(this.tree),this.tree.refilter(),this.hasPendingReveal&&this.revealById(this.filterState.reveal.value)}getSelectedTests(){return this.tree.getSelection()}};z=x([l(2,le),l(3,yt),l(4,St),l(5,oe),l(6,Ee),l(7,Z),l(8,pe),l(9,V),l(10,ot),l(11,ae),l(12,De),l(13,Ft),l(14,he),l(15,ve),l(16,be)],z);var Kt=(t=>(t[t.Exclude=0]="Exclude",t[t.Inherit=1]="Inherit",t[t.Include=2]="Include",t))(Kt||{});const jt=(p,i,e,t)=>{const r=[t?[t]:p.rootIds];for(;r.length;)for(const o of r.pop()){const s=p.getNodeById(o);if(s&&!(!s.item.uri||!i.extUri.isEqualOrParent(e,s.item.uri))){if(s.item.range||s.expand===ge.Expandable)return!0;r.push(s.children)}}return!1};let k=class{constructor(i,e,t,r){this.collection=i;this.state=e;this.testService=t;this.uriIdentityService=r}documentUris=[];filter(i){if(i instanceof w)return _.Visible;if(i.test&&!this.state.isFilteringFor(b.Hidden)&&this.testService.excluded.contains(i.test))return _.Hidden;switch(Math.min(this.testFilterText(i),this.testLocation(i),this.testState(i),this.testTags(i))){case 0:return _.Hidden;case 2:return _.Visible;default:return _.Recurse}}filterToDocumentUri(i){this.documentUris=[...i]}testTags(i){return!this.state.includeTags.size&&!this.state.excludeTags.size||(!this.state.includeTags.size||i.test.item.tags.some(e=>this.state.includeTags.has(e)))&&i.test.item.tags.every(e=>!this.state.excludeTags.has(e))?2:1}testState(i){return this.state.isFilteringFor(b.Failed)?Fe(i.state)?2:1:this.state.isFilteringFor(b.Executed)?i.state!==W.Unset?2:1:2}testLocation(i){return this.documentUris.length===0||!this.state.isFilteringFor(b.CurrentDoc)&&!this.state.isFilteringFor(b.OpenedFiles)||!(i instanceof T)||this.documentUris.some(e=>jt(this.collection,this.uriIdentityService,e,i.test.item.extId))?2:1}testFilterText(i){if(this.state.globList.length===0)return 2;const e=this.state.fuzzy.value;for(let t=i;t;t=t.parent){let r=this.state.globList[0].include===!1?2:1;const o=t.test.item.label.toLowerCase();for(const{include:s,text:c}of this.state.globList)(e?Ye(o,c):o.includes(c))&&(r=s?2:0);if(r!==1)return r}return 1}};k=x([l(1,pe),l(2,Z),l(3,ht)],k);class $t{constructor(i){this.viewModel=i}compare(i,e){if(i instanceof w||e instanceof w)return(i instanceof w?-1:0)+(e instanceof w?1:0);const t=(e.duration||0)-(i.duration||0);if(this.viewModel.viewSorting===X.ByDuration&&t!==0)return t;const r=Rt(i.state,e.state);if(this.viewModel.viewSorting===X.ByStatus&&r!==0)return r;let o=!1;if(i instanceof T&&e instanceof T&&i.test.item.uri&&e.test.item.uri&&i.test.item.uri.toString()===e.test.item.uri.toString()&&i.test.item.range&&e.test.item.range){o=!0;const d=i.test.item.range.startLineNumber-e.test.item.range.startLineNumber;if(d!==0)return d}const s=i.test.item.sortText,c=e.test.item.sortText;return o&&!s&&!c?0:(s||i.test.item.label).localeCompare(c||e.test.item.label)}}let K=class extends G{el;constructor(i,e){super();const t=this.el=m.append(i,m.$(".testing-no-test-placeholder")),r=m.append(t,m.$("p"));r.innerText=S("testingNoTest","No tests were found in this file.");const o=S("testingFindExtension","Show Workspace Tests"),s=this._register(new He(t,{title:o,...ct}));s.label=o,this._register(s.onDidClick(()=>e.toggleFilteringFor(b.CurrentDoc,!1)))}setVisible(i){this.el.classList.toggle("visible",i)}};K=x([l(1,pe)],K);class Ut extends ze{constructor(e){super();this.getSelectedTests=e}async runAction(e,t){if(!(e instanceof Q))return super.runAction(e,t);const r=this.getSelectedTests(),c=(r.some(d=>d===t)?r:[t]).filter(d=>d instanceof T);await e.run(...c)}}const Pe=p=>{let i=bt(p.description||p.test.item.label,p.state);return p instanceof T&&(p.duration!==void 0&&(i=S({key:"testing.treeElementLabelDuration",comment:["{0} is the original label in testing.treeElementLabel, {1} is a duration"]},"{0}, in {1}",i,j(p.duration))),p.retired&&(i=S({key:"testing.treeElementLabelOutdated",comment:["{0} is the original label in testing.treeElementLabel"]},"{0}, outdated result",i))),i};class Gt{getWidgetAriaLabel(){return S("testExplorer","Test Explorer")}getAriaLabel(i){return i instanceof w?i.description:Pe(i)}}class qt{getKeyboardNavigationLabel(i){return i instanceof w?i.message:i.test.item.label}}class Qt{getHeight(i){return i instanceof w?27:22}getTemplateId(i){return i instanceof w?F.ID:R.ID}}class Yt{getId(i){return i.treeId}}let F=class{constructor(i,e){this.hoverService=i;this.renderer=e.createInstance(Je,{})}static ID="error";renderer;get templateId(){return F.ID}renderTemplate(i){return{label:m.append(i,m.$(".error")),disposable:new se}}renderElement({element:i},e,t){if(m.clearNode(t.label),typeof i.message=="string")t.label.innerText=i.message;else{const r=this.renderer.render(i.message,{inline:!0});t.label.appendChild(r.element)}t.disposable.add(this.hoverService.setupManagedHover(re("mouse"),t.label,i.description))}disposeTemplate(i){i.disposable.dispose()}};F=x([l(0,Y),l(1,V)],F);let R=class extends G{constructor(e,t,r,o,s,c,d,f){super();this.actionRunner=e;this.menuService=t;this.testService=r;this.profiles=o;this.contextKeyService=s;this.instantiationService=c;this.crService=d;this.hoverService=f}static ID="testItem";templateId=R.ID;renderTemplate(e){const t=m.append(e,m.$(".test-item")),r=m.append(t,m.$(".computed-state")),o=m.append(t,m.$(".label")),s=new se;m.append(t,m.$(q.asCSSSelector(C.testingHiddenIcon)));const c=s.add(new ie(t,{actionRunner:this.actionRunner,actionViewItemProvider:(f,u)=>f instanceof Q?this.instantiationService.createInstance(Ze,f,{hoverDelegate:u.hoverDelegate}):void 0}));s.add(this.crService.onDidChange(f=>{const u=d.current?.test.item.extId;u&&(!f||f===u||me.isChild(u,f))&&this.fillActionBar(d.current,d)}));const d={wrapper:t,label:o,actionBar:c,icon:r,elementDisposable:new se,templateDisposable:s};return d}disposeTemplate(e){e.templateDisposable.clear()}disposeElement(e,t,r){r.elementDisposable.clear()}fillActionBar(e,t){const{actions:r,contextOverlay:o}=Ae(this.contextKeyService,this.menuService,this.testService,this.crService,this.profiles,e),s=!!o.getContextKeyValue(D.isContinuousModeOn.key),c=!s&&this.crService.isEnabledForAChildOf(e.test.item.extId);t.actionBar.domNode.classList.toggle("testing-is-continuous-run",s||c),t.actionBar.clear(),t.actionBar.context=e,t.actionBar.push(r.primary,{icon:!0,label:!1})}renderElement(e,t,r){r.elementDisposable.clear(),r.current=e.element,this.fillActionBar(e.element,r),r.elementDisposable.add(e.element.onChange(()=>this._renderElement(e,r))),this._renderElement(e,r)}_renderElement(e,t){const r=this.testService.excluded.contains(e.element.test);t.wrapper.classList.toggle("test-is-hidden",r);const o=C.testingStatesToIcons.get(e.element.test.expand===ge.BusyExpanding||e.element.test.item.busy?W.Running:e.element.state);t.icon.className="computed-state "+(o?q.asClassName(o):""),e.element.retired&&(t.icon.className+=" retired"),t.elementDisposable.add(this.hoverService.setupManagedHover(re("mouse"),t.label,Pe(e.element))),e.element.test.item.label.trim()?m.reset(t.label,...We(e.element.test.item.label)):t.label.textContent="\xA0";let s=e.element.description;e.element.duration!==void 0&&(s=s?`${s}: ${j(e.element.duration)}`:j(e.element.duration)),s&&m.append(t.label,m.$("span.test-label-description",{},s))}};R=x([l(1,oe),l(2,Z),l(3,he),l(4,ae),l(5,V),l(6,ve),l(7,Y)],R);const j=p=>p<10?`${p.toFixed(1)}ms`:p<1e3?`${p.toFixed(0)}ms`:`${(p/1e3).toFixed(1)}s`,Ae=(p,i,e,t,r,o)=>{const s=o instanceof T?o.test:void 0,c=Bt(s,s?r.capabilitiesForTest(s.item):0);if(c.push(["view",xe.ExplorerViewId]),s){const g=e.getTestController(s.controllerId),I=!!g&&r.getControllerProfiles(g.id).some(v=>v.supportsContinuousRun&&fe(v,s));c.push([D.canRefreshTests.key,g&&!!(g.capabilities.get()&Dt.Refresh)&&me.isRoot(s.item.extId)],[D.testItemIsHidden.key,e.excluded.contains(s)],[D.isContinuousModeOn.key,I&&t.isSpecificallyEnabledFor(s.item.extId)],[D.isParentRunningContinuously.key,I&&t.isEnabledForAParentOf(s.item.extId)],[D.supportsContinuousRun.key,I])}const d=p.createOverlay(c),f=i.getMenuActions(ye.TestItem,d,{shouldForwardArgs:!0}),h={primary:[],secondary:[]};return tt(f,h,"inline"),{actions:h,contextOverlay:d}};mt((p,i)=>{if(p.type==="dark"){const e=p.getColor(ut);if(e){const t=new je(new $e(e.rgba.r,e.rgba.g,e.rgba.b,.65));i.addRule(`.test-explorer .test-explorer-messages { color: ${t}; }`)}}});export{ee as TestingExplorerView};
